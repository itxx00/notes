"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5169],{2808:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>c,default:()=>b,frontMatter:()=>l,metadata:()=>a,toc:()=>d});var i=n(5893),r=n(3905);const l={layout:"post",title:"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236",description:"",categories:["virt"],tags:["libvirt","tc","bandwidth"]},c=void 0,a={permalink:"/notes/blog/2013/03/01/libvirt-tc-bandwidth-control",editUrl:"https://github.com/itxx00/notes/tree/main/blog/2013-03-01-libvirt-tc-bandwidth-control.md",source:"@site/blog/2013-03-01-libvirt-tc-bandwidth-control.md",title:"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236",description:"",date:"2013-03-01T00:00:00.000Z",formattedDate:"2013\u5e743\u67081\u65e5",tags:[{label:"libvirt",permalink:"/notes/blog/tags/libvirt"},{label:"tc",permalink:"/notes/blog/tags/tc"},{label:"bandwidth",permalink:"/notes/blog/tags/bandwidth"}],readingTime:3.5,hasTruncateMarker:!1,authors:[],frontMatter:{layout:"post",title:"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236",description:"",categories:["virt"],tags:["libvirt","tc","bandwidth"]},unlisted:!1,prevItem:{title:"Ovirt\u4e2d\u7684stateless\u5b9e\u73b0\u673a\u5236\u5206\u6790",permalink:"/notes/blog/2013/03/14/ovirt-stateless"},nextItem:{title:"\u6d45\u6790qcow2\u955c\u50cf\u6587\u4ef6\u7684\u5feb\u7167\u5408\u5e76",permalink:"/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull"}},s={authorsImageUrls:[]},d=[{value:"cbq\u961f\u5217\u793a\u4f8b",id:"cbq\u961f\u5217\u793a\u4f8b",level:2},{value:"1.\u5efa\u7acbcbq\u961f\u5217",id:"1\u5efa\u7acbcbq\u961f\u5217",level:3},{value:"2.\u5efa\u7acb\u5e26\u5bbd\u9650\u5236\u5206\u7c7b",id:"2\u5efa\u7acb\u5e26\u5bbd\u9650\u5236\u5206\u7c7b",level:3},{value:"3.\u5efa\u7acb\u8fc7\u6ee4\u5668",id:"3\u5efa\u7acb\u8fc7\u6ee4\u5668",level:3},{value:"htb\u961f\u5217\u793a\u4f8b",id:"htb\u961f\u5217\u793a\u4f8b",level:2},{value:"libvirt\u4e2d\u7684\u5e26\u5bbd\u63a7\u5236",id:"libvirt\u4e2d\u7684\u5e26\u5bbd\u63a7\u5236",level:2}];function o(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.ah)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"\u5728kvm\u865a\u62df\u673a\u7ba1\u7406\u7684\u8fc7\u7a0b\u5f53\u4e2d\uff0c\u5bf9\u865a\u62df\u673a\u5e26\u5bbd\u8fdb\u884c\u826f\u597d\u7684\u63a7\u5236\u662f\u5341\u5206\u91cd\u8981\u7684\u3002"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["linux\u7cfb\u7edf\u5f53\u4e2d\u5bf9\u7f51\u7edc\u5e26\u5bbd\u7684\u63a7\u5236\u4e00\u822c\u90fd\u662f\u4f7f\u7528tc\u547d\u4ee4\u5b9e\u73b0\uff0ctc\u5373\u662ftraffic control\u7684\u7f29\u5199\uff0c\u5728",(0,i.jsx)(t.a,{href:"http://linux-ip.net/articles/Traffic-Control-HOWTO/",children:"\u8fd9\u91cc"}),"\u53ef\u4ee5\u627e\u5230\u6709\u5173tc\u547d\u4ee4\u7684\u5185\u5bb9\u3002"]}),"\n",(0,i.jsx)(t.p,{children:"\u5f53\u7136\u4f60\u53ef\u4ee5\u624b\u52a8\u4f7f\u7528tc\u547d\u4ee4\u6765\u5904\u7406\u8fd9\u4e9b\u4e8b\u60c5\uff0c\u6bd4\u5982\u4f7f\u7528cbq\u961f\u5217\uff0chtb\u961f\u5217\u7b49\uff0c\u90fd\u662f\u53ef\u4ee5\u5b9e\u73b0\u7684\uff0c\u7f51\u4e0a\u627e\u627e\u5e94\u8be5\u6709\u5f88\u591a\u5173\u4e8e\u8fd9\u65b9\u9762\u7684\u8d44\u6599\uff0c"}),"\n",(0,i.jsx)(t.h2,{id:"cbq\u961f\u5217\u793a\u4f8b",children:"cbq\u961f\u5217\u793a\u4f8b"}),"\n",(0,i.jsx)(t.p,{children:"\u6bd4\u5982\u4e0b\u9762\u5c31\u662f\u4f7f\u7528cbq\u961f\u5217\u9650\u5236src ip\u4e3a192.168.1.102\u53d1\u9001\u6570\u636e\u5305\u7684\u901f\u7387:"}),"\n",(0,i.jsx)(t.h3,{id:"1\u5efa\u7acbcbq\u961f\u5217",children:"1.\u5efa\u7acbcbq\u961f\u5217"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"tc qdisc add dev eth0 root handle 1: cbq avpkt 1000 bandwidth 100mbit\n"})}),"\n",(0,i.jsx)(t.h3,{id:"2\u5efa\u7acb\u5e26\u5bbd\u9650\u5236\u5206\u7c7b",children:"2.\u5efa\u7acb\u5e26\u5bbd\u9650\u5236\u5206\u7c7b"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"tc class add dev eth0 parent 1: classid 1:1 cbq rate 60mbit allot 1500 prio 5 bounded isolated\ntc class add dev eth0 parent 1: classid 1:2 cbq rate 70mbit allot 1500 prio 5 bounded isolated\ntc class add dev eth0 parent 1: classid 1:3 cbq rate 80mbit allot 1500 prio 5 bounded isolated\n"})}),"\n",(0,i.jsx)(t.h3,{id:"3\u5efa\u7acb\u8fc7\u6ee4\u5668",children:"3.\u5efa\u7acb\u8fc7\u6ee4\u5668"}),"\n",(0,i.jsx)(t.p,{children:"\u7ed1\u5b9a\u6307\u5b9a\u5e26\u5bbd\u9650\u5236\u7c7b\u578b\u81f3\u6307\u5b9a\u865a\u62df\u673aip:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"tc filter add dev eth0 parent 1: protocol ip prio 16 u32 match ip src 192.168.1.102 flowid 1:2\n"})}),"\n",(0,i.jsx)(t.h2,{id:"htb\u961f\u5217\u793a\u4f8b",children:"htb\u961f\u5217\u793a\u4f8b"}),"\n",(0,i.jsx)(t.p,{children:"\u6211\u4eec\u53ef\u4ee5\u5728\u6bcd\u673a\u4e0a\u7ed9vm\u5bf9\u5e94\u7684\u865a\u62df\u7f51\u5361\u589e\u52a0tc\u89c4\u5219\uff0c\u4f7f\u7528htb\u961f\u5217\uff0c\u4e00\u4e2a\u53ef\u7528\u7684\u811a\u672c\u793a\u4f8b\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'# add interface bandwidth limit\n# usage: tc_add iface in_kbps out_kbps\ntc_add() {\n    local iface=$1\n    local in_bw=$2\n    local out_bw=$3\n    local in_average="${in_bw}kbps"\n    local in_peak="${in_bw}kbps"\n    local out_average="${out_bw}kbps"\n    local out_peak="${out_bw}kbps"\n    local burst="2kb"\n    local mtu=1500\n    local r2q=$((in_bw*1000/mtu-1))\n    local tc="/sbin/tc"\n    [ $r2q -lt 1 ] && r2q=1\n    if [ $in_bw != 0 ]; then\n        $tc qdisc add dev $iface root handle 1: htb default 2 r2q $r2q\n        $tc class add dev $iface parent 1: classid 1:1 htb rate $in_average \\\n            ceil $in_peak burst $burst cburst $burst\n        $tc class add dev $iface parent 1:1 classid 1:2 htb rate $in_average \\\n            ceil $in_peak burst $burst cburst $burst\n        $tc qdisc add dev $iface parent 1:2 handle 2: sfq perturb 10\n        $tc filter add dev $iface parent 1:0 protocol ip handle 1 fw flowid 1\n    fi\n    if [ $out_bw != 0 ]; then\n        $tc qdisc add dev $iface ingress\n        $tc filter add dev $iface parent ffff: protocol ip u32 match ip src \\\n            0.0.0.0/0 police rate $out_average burst ${out_bw}kb mtu 64kb drop \\\n            flowid :1\n    fi\n}\n\n# clean up interface bandwidth limit\n# usage: tc_del iface\ntc_del() {\n    local iface=$1\n    local tc="/sbin/tc"\n    $tc qdisc del dev $iface root &>>/dev/null\n    sleep 0.1\n    $tc qdisc del dev $iface ingress &>>/dev/null\n}\n\n'})}),"\n",(0,i.jsx)(t.h2,{id:"libvirt\u4e2d\u7684\u5e26\u5bbd\u63a7\u5236",children:"libvirt\u4e2d\u7684\u5e26\u5bbd\u63a7\u5236"}),"\n",(0,i.jsx)(t.p,{children:"\u6211\u6bd4\u8f83\u63a8\u8350\u7684\u65b9\u6cd5\u8fd8\u662f\u76f4\u63a5\u4f7f\u7528libvirt\uff0clibvirt \u4e2d\u5df2\u7ecf\u96c6\u6210\u4e86\u5e26\u5bbd\u63a7\u5236\u7684\u529f\u80fd\uff0c\u4e0b\u9762\u662f\u5173\u4e8e\u5e26\u5bbd\u63a7\u5236\u90e8\u5206\u7684xml\u63cf\u8ff0:"}),"\n",(0,i.jsx)(t.p,{children:"\u4f7f\u7528\u65b9\u6cd5\uff1a\u5728\u7f51\u5361interface\u4e2d\u52a0\u5165"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-xml",children:"<bandwidth>\n<inbound average='1000' peak='5000' burst='1024'/>\n<outbound average='128' peak='256' burst='256'/>\n</bandwidth>\n"})}),"\n",(0,i.jsxs)(t.p,{children:["\u4ee5\u4e0b\u662f\u5173\u4e8e\u5404\u9879\u53c2\u6570\u7684\u89e3\u91ca\uff0c\u83b7\u53d6\u6700\u65b0\u7684\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003",(0,i.jsx)(t.a,{href:"http://www.libvirt.org/",children:"libvirt\u6587\u6863"}),"."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"mandatory attribute:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"average: It specifies average bit rate on interface being shaped."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:"optional attributes:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"peak: which specifies maximum rate at which interface can send data,"}),"\n",(0,i.jsx)(t.li,{children:"burst: amount of bytes that can be burst at peak speed."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Accepted values: integer numbers."}),"\n",(0,i.jsx)(t.p,{children:"units:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"average: kilobytes per second"}),"\n",(0,i.jsx)(t.li,{children:"peak: kilobytes per second"}),"\n",(0,i.jsx)(t.li,{children:"burst: kilobytes."}),"\n"]})]})}function b(e={}){const{wrapper:t}={...(0,r.ah)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},3905:(e,t,n)=>{n.d(t,{ah:()=>d});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},l=Object.keys(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=i.createContext({}),d=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},o={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},b=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,b=a(e,["components","mdxType","originalType","parentName"]),p=d(n),h=r,u=p["".concat(s,".").concat(h)]||p[h]||o[h]||l;return n?i.createElement(u,c(c({ref:t},b),{},{components:n})):i.createElement(u,c({ref:t},b))}));b.displayName="MDXCreateElement"}}]);