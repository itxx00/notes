"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3319],{13198:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>u,frontMatter:()=>c,metadata:()=>r,toc:()=>a});var r=s(61559),l=s(74848),i=s(28453);const c={layout:"post",title:"k8s\u57fa\u7840\u77e5\u8bc6\u603b\u7ed3",authors:"itxx00",description:"k8s \u57fa\u7840\u77e5\u8bc6\u603b\u7ed3",categories:["k8s"],tags:[]},o=void 0,t={authorsImageUrls:[void 0]},a=[{value:"Kubernetes \u6a21\u5757\u67b6\u6784",id:"kubernetes-\u6a21\u5757\u67b6\u6784",level:2},{value:"Kubernetes \u7ec4\u4ef6",id:"kubernetes-\u7ec4\u4ef6",level:2},{value:"k8s \u5e38\u89c1\u8d44\u6e90\u7c7b\u578b",id:"k8s-\u5e38\u89c1\u8d44\u6e90\u7c7b\u578b",level:2},{value:"pod \u521b\u5efa\u8fc7\u7a0b",id:"pod-\u521b\u5efa\u8fc7\u7a0b",level:2},{value:"Canal",id:"canal",level:2},{value:"pod\u7f51\u7edc\u901a\u4fe1",id:"pod\u7f51\u7edc\u901a\u4fe1",level:2},{value:"kube-proxy",id:"kube-proxy",level:2},{value:"svc\u5b9e\u73b0\u673a\u5236",id:"svc\u5b9e\u73b0\u673a\u5236",level:2},{value:"ingress",id:"ingress",level:2},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b",level:3},{value:"Coredns",id:"coredns",level:2},{value:"\u8bb0\u5f55\u89c4\u5219",id:"\u8bb0\u5f55\u89c4\u5219",level:3},{value:"k8s \u76d1\u63a7",id:"k8s-\u76d1\u63a7",level:2},{value:"prometheus",id:"prometheus",level:3},{value:"grafana",id:"grafana",level:2},{value:"Loki",id:"loki",level:2},{value:"\u6a21\u5757\u4ecb\u7ecd",id:"\u6a21\u5757\u4ecb\u7ecd",level:3},{value:"logQL \u67e5\u8be2",id:"logql-\u67e5\u8be2",level:3},{value:"k8s\u5e38\u7528\u547d\u4ee4",id:"k8s\u5e38\u7528\u547d\u4ee4",level:2},{value:"\u62d3\u5c55\u9605\u8bfb",id:"\u62d3\u5c55\u9605\u8bfb",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"k8s \u57fa\u7840\u77e5\u8bc6\u6574\u7406\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"kubernetes-\u6a21\u5757\u67b6\u6784",children:"Kubernetes \u6a21\u5757\u67b6\u6784"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+-----------------------------------------------------+\n|                     Kubernetes Cluster              |\n|                                                     |\n|  +------------------+      +--------------------+   |\n|  |   Master Node    |      |    Worker Node(s)   |  |\n|  |                  |      |                     |  |\n|  |  +------------+  |      |  +---------------+  |  |\n|  |  | API Server |<---------\x3e| Kubelet         | |  |\n|  |  +------------+  |      |  +---------------+  |  |\n|  |                  |      |                     |  |\n|  |  +------------+  |      |  +---------------+  |  |\n|  |  | Controller |  |      |  |  Container     | |  |\n|  |  | Manager    |  |      |  |  Runtime       | |  |\n|  |  +------------+  |      |  +---------------+  |  |\n|  |                  |      |                     |  |\n|  |  +------------+  |      +--------------------+   |\n|  |  | Scheduler  |  |                               |\n|  |  +------------+  |                               |\n|  |                  |                               |\n|  |  +------------+  |                               |\n|  |  | etcd       |  |                               |\n|  |  +------------+  |                               |\n|  +------------------+                               |\n|                                                     |\n|  +------------------+                               |\n|  | Add-ons          |                               |\n|  |  - DNS           |                               |\n|  |  - Dashboard     |                               |\n|  |  - Network Plugin|                               |\n|  +------------------+                               |\n+-----------------------------------------------------+\n"})}),"\n",(0,l.jsx)(n.p,{children:"Master Node\uff1a\u8d1f\u8d23\u96c6\u7fa4\u7684\u7ba1\u7406\u548c\u63a7\u5236\uff0c\u5305\u542b API Server\u3001Controller Manager\u3001Scheduler \u548c etcd\uff08\u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\uff09\u3002\nWorker Node\uff1a\u8d1f\u8d23\u8fd0\u884c\u5bb9\u5668\u5316\u5e94\u7528\uff0c\u5305\u542b Kubelet\uff08\u8282\u70b9\u4ee3\u7406\uff09\u3001\u5bb9\u5668\u8fd0\u884c\u65f6\uff08\u5982 containerd\u3001Docker\uff09\u7b49\u3002\nAdd-ons\uff1a\u96c6\u7fa4\u9644\u52a0\u7ec4\u4ef6\uff0c\u5982 DNS \u670d\u52a1\u3001Dashboard\u3001\u7f51\u7edc\u63d2\u4ef6\u7b49\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"kubernetes-\u7ec4\u4ef6",children:"Kubernetes \u7ec4\u4ef6"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"API Server\uff1a\u8d1f\u8d23\u63d0\u4f9b Kubernetes API \u670d\u52a1\uff0c\u5305\u62ec\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5220\u9664\u3001\u67e5\u8be2\u7b49\u64cd\u4f5c\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Controller Manager\uff1a\u8d1f\u8d23\u7ba1\u7406\u63a7\u5236\u5668\uff0c\u5305\u62ec\u8282\u70b9\u63a7\u5236\u5668\u3001\u526f\u672c\u63a7\u5236\u5668\u3001\u670d\u52a1\u63a7\u5236\u5668\u7b49\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Scheduler\uff1a\u8d1f\u8d23\u8c03\u5ea6 Pod \u5230\u5408\u9002\u7684\u8282\u70b9\u4e0a\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Kubelet\uff1a\u8d1f\u8d23\u7ba1\u7406\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u5316\u5e94\u7528\uff0c\u5305\u62ec\u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u7b49\u64cd\u4f5c\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Container Runtime\uff1a\u8d1f\u8d23\u7ba1\u7406\u5bb9\u5668\uff0c\u5305\u62ec\u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u7b49\u64cd\u4f5c\u3002"}),"\n",(0,l.jsx)(n.li,{children:"etcd\uff1a\u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\uff0c\u7528\u4e8e\u5b58\u50a8 Kubernetes \u96c6\u7fa4\u7684\u72b6\u6001\u4fe1\u606f\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Add-ons\uff1a\u96c6\u7fa4\u9644\u52a0\u7ec4\u4ef6\uff0c\u5982 DNS \u670d\u52a1\u3001Dashboard\u3001\u7f51\u7edc\u63d2\u4ef6\u7b49\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Kube-proxy\uff1a\u8d1f\u8d23\u5b9e\u73b0 Kubernetes \u670d\u52a1\u53d1\u73b0\u548c\u8d1f\u8f7d\u5747\u8861\uff0c\u5c06\u670d\u52a1\u8bf7\u6c42\u8def\u7531\u5230\u6b63\u786e\u7684 Pod\u3002"}),"\n",(0,l.jsx)(n.li,{children:"CNI\uff08Container Network Interface\uff09\uff1a\u8d1f\u8d23\u4e3a\u5bb9\u5668\u63d0\u4f9b\u7f51\u7edc\u529f\u80fd\uff0c\u5982\u521b\u5efa\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u3001\u914d\u7f6e IP \u5730\u5740\u3001\u8def\u7531\u8868\u7b49\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Kube-dns\uff1a\u8d1f\u8d23\u4e3a Kubernetes \u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b DNS \u89e3\u6790\u670d\u52a1\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Ingress Controller\uff1a\u8d1f\u8d23\u5904\u7406\u5916\u90e8\u6d41\u91cf\u8fdb\u5165\u96c6\u7fa4\u7684\u6d41\u91cf\u8def\u7531\u548c\u8d1f\u8f7d\u5747\u8861\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Dashboard\uff1a\u63d0\u4f9b Web \u754c\u9762\uff0c\u7528\u4e8e\u53ef\u89c6\u5316\u7ba1\u7406\u548c\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Logging and Monitoring\uff1a\u8d1f\u8d23\u6536\u96c6\u548c\u5206\u6790\u5bb9\u5668\u7684\u65e5\u5fd7\uff0c\u63d0\u4f9b\u76d1\u63a7\u548c\u62a5\u8b66\u529f\u80fd\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Helm\uff1a\u7528\u4e8e\u7ba1\u7406 Kubernetes \u5e94\u7528\u7684\u5305\u7ba1\u7406\u5668\uff0c\u7c7b\u4f3c\u4e8e Linux \u7cfb\u7edf\u4e2d\u7684 apt \u6216 yum\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Prometheus\uff1a\u7528\u4e8e\u76d1\u63a7\u548c\u62a5\u8b66\uff0c\u63d0\u4f9b\u6307\u6807\u6536\u96c6\u548c\u67e5\u8be2\u529f\u80fd\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Grafana\uff1a\u7528\u4e8e\u53ef\u89c6\u5316\u76d1\u63a7\u6570\u636e\uff0c\u652f\u6301\u591a\u79cd\u6570\u636e\u6e90\uff0c\u5982 Prometheus\u3001InfluxDB \u7b49\u3002"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"k8s-\u5e38\u89c1\u8d44\u6e90\u7c7b\u578b",children:"k8s \u5e38\u89c1\u8d44\u6e90\u7c7b\u578b"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Pod\nPod\u4e5f\u53eb\u5bb9\u5668\u7ec4\uff0c\u662fKubernetes\u4e2d\u6700\u5c0f\u7684\u53ef\u90e8\u7f72\u5355\u5143\uff0c\u5b83\u662f\u4e00\u4e2a\u6216\u591a\u4e2a\u76f8\u5173\u5bb9\u5668\u7684\u7ec4\u5408\u3002Pod\u4e2d\u7684\u5bb9\u5668\u5171\u4eab\u7f51\u7edc\u548c\u5b58\u50a8\u8d44\u6e90\uff0c\u5e76\u5728\u540c\u4e00\u4e3b\u673a\u4e0a\u8fd0\u884c\u3002Pod\u7531Kubernetes\u8c03\u5ea6\u5668\u5206\u914d\u7ed9\u8282\u70b9\uff0c\u5e76\u4f7f\u7528Linux\u547d\u540d\u7a7a\u95f4\u548ccgroups\u6765\u9694\u79bb\u5bb9\u5668\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Deployment\nDeployment\u7528\u4e8e\u7ba1\u7406\u65e0\u72b6\u6001Pod\u7684\u521b\u5efa\u548c\u66f4\u65b0\u3002\u5b83\u901a\u8fc7\u63a7\u5236\u5668\u6a21\u5f0f\uff08ReplicaSet\uff09\u6765\u786e\u4fdd\u6307\u5b9a\u6570\u91cf\u7684Pod\u526f\u672c\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002\u5f53\u9700\u8981\u8fdb\u884c\u6269\u5c55\u3001\u56de\u6eda\u6216\u66f4\u65b0\u65f6\uff0cDeployment\u4f1a\u521b\u5efa\u65b0\u7684Pod\uff0c\u5e76\u9010\u6b65\u66ff\u6362\u65e7\u7684Pod\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Service\nService\u63d0\u4f9b\u4e86\u4e00\u79cd\u7a33\u5b9a\u7684\u7f51\u7edc\u8bbf\u95ee\u65b9\u5f0f\uff0c\u7528\u4e8e\u66b4\u9732Pod\u6216\u4e00\u7ec4Pod\u7684\u7f51\u7edc\u670d\u52a1\u3002Service\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\uff08Label Selector\uff09\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u540e\u7aefPod\u3002\u5b83\u4f7f\u7528Kubernetes\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u901a\u8fc7\u96c6\u7fa4\u5185\u90e8\u7684DNS\u6216\u8d1f\u8f7d\u5747\u8861\u5668\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u6b63\u786e\u7684Pod\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Ingress\nIngress\u662f\u4e00\u79cd\u89c4\u5219\u96c6\u5408\uff0c\u7528\u4e8e\u5c06\u5916\u90e8\u8bf7\u6c42\u8def\u7531\u5230\u96c6\u7fa4\u5185\u90e8\u7684Service\u3002\u5b83\u5145\u5f53\u4e86\u96c6\u7fa4\u5916\u90e8\u548c\u96c6\u7fa4\u5185\u90e8\u4e4b\u95f4\u7684\u5165\u53e3\u70b9\u3002Ingress\u63a7\u5236\u5668\u6839\u636eIngress\u89c4\u5219\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u76f8\u5e94\u7684Service\uff0c\u5e76\u5904\u7406\u8d1f\u8f7d\u5747\u8861\u3001SSL\u7ec8\u6b62\u548c\u8def\u5f84\u5339\u914d\u7b49\u529f\u80fd\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"ConfigMap\nConfigMap\u7528\u4e8e\u5b58\u50a8\u5e94\u7528\u7a0b\u5e8f\u7684\u914d\u7f6e\u6570\u636e\uff0c\u5982\u73af\u5883\u53d8\u91cf\u3001\u914d\u7f6e\u6587\u4ef6\u7b49\u3002\u5b83\u5c06\u914d\u7f6e\u6570\u636e\u5b58\u50a8\u4e3a\u952e\u503c\u5bf9\uff0c\u5e76\u5c06\u5176\u6ce8\u5165\u5230Pod\u7684\u5bb9\u5668\u4e2d\u3002\u5bb9\u5668\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u6216\u6302\u8f7d\u6587\u4ef6\u7684\u65b9\u5f0f\u8bbf\u95eeConfigMap\u4e2d\u7684\u914d\u7f6e\u6570\u636e\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Secret\nSecret\u7528\u4e8e\u5b58\u50a8\u654f\u611f\u6570\u636e\uff0c\u5982\u5bc6\u7801\u3001\u4ee4\u724c\u7b49\u3002\u8bfb\u53d6Secret\u65f6\u9ed8\u8ba4\u4ee5Base64\u7f16\u7801\u7684\u5f62\u5f0f\u4ece etcd \u4e2d\u53d6\u51fa\uff0c\u5e76\u53ef\u4ee5\u88abPod\u4e2d\u7684\u5bb9\u5668\u4f7f\u7528\u3002Secret\u53ef\u4ee5\u7528\u4e8e\u5b89\u5168\u5730\u4f20\u9012\u654f\u611f\u4fe1\u606f\uff0c\u5982\u6570\u636e\u5e93\u5bc6\u7801\u6216API\u5bc6\u94a5\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f k8s \u5e76\u4e0d\u9ed8\u8ba4\u63d0\u4f9b\u5bf9 secrets \u7684\u52a0\u5bc6\uff0c\u9700\u8981\u81ea\u5df1\u5b9e\u73b0\u5bc6\u94a5\u7ba1\u7406\u670d\u52a1\uff08Key Management Service\uff0cKMS\uff09\u3002"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"pod-\u521b\u5efa\u8fc7\u7a0b",children:"pod \u521b\u5efa\u8fc7\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa pod \u7684\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u5f53\u6267\u884c kubectl create deploy \u65f6\uff0ck8s \u6267\u884c\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.li,{children:"kubectl \u6267\u884c\u5ba2\u6237\u7aef\u6821\u9a8c\uff0c\u8d44\u6e90\u7c7b\u578b\u3001\u955c\u50cf\u540d\u79f0\u7b49"}),"\n",(0,l.jsx)(n.li,{children:"Kubectl \u8bfb\u53d6.kube/config\u83b7\u53d6\u8ba4\u8bc1\u4fe1\u606f\uff0ckube-apiserver \u5730\u5740"}),"\n",(0,l.jsx)(n.li,{children:"kubectl \u751f\u6210\u8bf7\u6c42\u5185\u5bb9\u5e76\u5f80 apiserver \u53d1\u9001\u521b\u5efa\u8bf7\u6c42"}),"\n",(0,l.jsx)(n.li,{children:"kube-apiserver \u901a\u8fc7\u8ba4\u8bc1\u548c\u9274\u6743\u540e\u5c06\u4fe1\u606f\u5b58\u50a8\u81f3 etcd"}),"\n",(0,l.jsx)(n.li,{children:"kube-controller-manager\u76d1\u542c\u5230 deploy create events\uff0c\u68c0\u67e5\u76f8\u5173\u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u5b58\u5728"}),"\n",(0,l.jsx)(n.li,{children:"Deployment controller \u521b\u5efa ReplicaSets\uff0creplicaset controller \u521b\u5efa pods\uff0c\u5b58\u5165 etcd\uff0cpod \u8fdb\u5165 pending \u72b6\u6001"}),"\n",(0,l.jsx)(n.li,{children:"kube-scheduler\u76d1\u542c\u5230 pod \u672a\u5206\u914d\u8282\u70b9\uff0c\u5f00\u59cb\u9009\u62e9\u5408\u9002\u7684\u8282\u70b9\uff0c\u53d1\u9001 POST \u8bf7\u6c42\u7ed9 apiserver"}),"\n",(0,l.jsx)(n.li,{children:"kube-apiserver \u5c06 pod \u72b6\u6001\u6807\u8bb0\u4e3a scheduled"}),"\n",(0,l.jsx)(n.li,{children:"kubelet \u8f6e\u8be2 kube-apiserver \u83b7\u53d6 pod \u4fe1\u606f\uff0c\u5f00\u59cb\u521b\u5efa cgroup\uff0c\u521b\u5efa\u6570\u636e\u76ee\u5f55\uff0c\u8c03\u7528 CRI \uff08container runtime interface\uff09\u521b\u5efa container"}),"\n",(0,l.jsx)(n.li,{children:"\u521b\u5efa pause \u5bb9\u5668\uff0ckubelet \u901a\u8fc7 CNI\uff08container network interface\uff09\u521b\u5efa\u7f51\u7edc"}),"\n",(0,l.jsx)(n.li,{children:"kubelet \u4ece\u955c\u50cf\u4ed3\u5e93\u62c9\u53d6pod \u7684\u955c\u50cf\uff0c\u901a\u8fc7 CRI \u63d2\u4ef6\u521b\u5efa container\n\u4ee5\u4e0a\u4ec5\u662f\u5bf9\u5173\u952e\u6b65\u9aa4\u7684\u7b80\u8981\u63cf\u8ff0\uff0c\u5b9e\u9645\u60c5\u51b5\u8981\u590d\u6742\u5f97\u591a\u3002"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"docker\u3001containerd\u3001runc \u662f\u4ec0\u4e48\u5173\u7cfb\uff1f\ncontainerd\u3001runc \u7531 docker \u62c6\u5206\u51fa\u6765\uff0crunc \u662f\u4e00\u4e2a\u6807\u51c6\u7684OCI runtime\u5b9e\u73b0\uff0ccontainerd \u652f\u6301\u591a\u79cdOCI runtime \u5b9e\u73b0\uff0c\u5bf9\u5e94 runc \u7684\u652f\u6301\u63d0\u4f9b\u4e86 containerd-shim-runc-v2,\u4e00\u4e2a\u5bb9\u5668\u7684\u521b\u5efa\u5177\u4f53\u8fc7\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.mermaid,{value:"flowchart LR\n    A[docker cli] --\x3e B[dockerd]\n    B -- gRPC --\x3e C[containerd]\n    D[kubelet] -- gRPC --\x3e C\n    C -- exec --\x3e E[containerd-shim]\n    E -- exec --\x3e F[containerd-shim-runc-v2]\n    F -- exec --\x3e G[runc]\n    G -- exec --\x3e H[\u5bb9\u5668\u8fdb\u7a0b]\n    style E stroke-dasharray: 4 2\n    style F stroke-dasharray: 4 2\n    style G stroke-dasharray: 4 2"}),"\n",(0,l.jsx)(n.p,{children:"k8s v1.19\u7248\u672c\uff0ckubelet \u4f7f\u7528 docker-shim\u4e0e dockerd \u901a\u4fe1\uff0ck8s\u81ea v1.20\u7248\u672c\u5f00\u59cb\u5efa\u8bae\u4f7f\u7528 containerd-shim\uff0c1.24 \u7248\u672c\u5f7b\u5e95\u5e9f\u5f03 docker-shim\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"canal",children:"Canal"}),"\n",(0,l.jsx)(n.p,{children:"Canal \u662f\u4e00\u4e2a CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u5b83\u5f88\u597d\u5730\u7ed3\u5408\u4e86 Flannel \u548c Calico \u7684\u4f18\u70b9\u3002\u5b83\u8ba9\u4f60\u8f7b\u677e\u5730\u5c06 Calico \u548c Flannel \u7f51\u7edc\u90e8\u7f72\u4e3a\u7edf\u4e00\u7684\u7f51\u7edc\u89e3\u51b3\u65b9\u6848\uff0c\u5c06 Calico \u7684\u7f51\u7edc\u7b56\u7565\u6267\u884c\u4e0e Calico\uff08\u672a\u5c01\u88c5\uff09\u548c Flannel\uff08\u5c01\u88c5\uff09\u4e30\u5bcc\u7684\u7f51\u7edc\u8fde\u63a5\u9009\u9879\u7ed3\u5408\u8d77\u6765\u3002\nCanal \u662f Rancher \u9ed8\u8ba4\u7684 CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u5e76\u91c7\u7528\u4e86 Flannel \u548c VXLAN \u5c01\u88c5\u3002\nCNI\uff08\u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\uff09\u662f\u4e00\u4e2a\u4e91\u539f\u751f\u8ba1\u7b97\u57fa\u91d1\u4f1a\u9879\u76ee\uff0c\u5b83\u5305\u542b\u4e86\u4e00\u4e9b\u89c4\u8303\u548c\u5e93\uff0c\u7528\u4e8e\u7f16\u5199\u5728 Linux \u5bb9\u5668\u4e2d\u914d\u7f6e\u7f51\u7edc\u63a5\u53e3\u7684\u4e00\u7cfb\u5217\u63d2\u4ef6\u3002CNI \u53ea\u5173\u6ce8\u5bb9\u5668\u7684\u7f51\u7edc\u8fde\u63a5\uff0c\u5e76\u5728\u5bb9\u5668\u88ab\u5220\u9664\u65f6\u79fb\u9664\u6240\u5206\u914d\u7684\u8d44\u6e90\u3002\nKubernetes \u4f7f\u7528 CNI \u4f5c\u4e3a\u7f51\u7edc\u63d0\u4f9b\u5546\u548c Kubernetes Pod \u7f51\u7edc\u4e4b\u95f4\u7684\u63a5\u53e3\u3002\nCanal \u67b6\u6784\nFlannel \u662f\u4e3a Kubernetes \u914d\u7f6e L3 \u7f51\u7edc\u7ed3\u6784\u7684\u7b80\u5355\u65b9\u6cd5\u3002Flannel \u5728\u6bcf\u53f0\u4e3b\u673a\u4e0a\u8fd0\u884c\u4e00\u4e2a\u540d\u4e3a flanneld \u7684\u4e8c\u8fdb\u5236 Agent\uff0c\u8be5 Agent \u8d1f\u8d23\u4ece\u66f4\u5927\u7684\u9884\u914d\u7f6e\u5730\u5740\u7a7a\u95f4\u4e2d\u4e3a\u6bcf\u53f0\u4e3b\u673a\u5206\u914d\u5b50\u7f51\u79df\u7ea6\u3002Flannel \u901a\u8fc7 Kubernetes API \u6216\u76f4\u63a5\u4f7f\u7528 etcd \u6765\u5b58\u50a8\u7f51\u7edc\u914d\u7f6e\u3001\u5206\u914d\u7684\u5b50\u7f51\u3001\u4ee5\u53ca\u5176\u4ed6\u8f85\u52a9\u6570\u636e\uff08\u4f8b\u5982\u4e3b\u673a\u7684\u516c\u5171 IP\uff09\u3002\u6570\u636e\u5305\u4f7f\u7528\u67d0\u79cd\u540e\u7aef\u673a\u5236\u6765\u8f6c\u53d1\uff0c\u9ed8\u8ba4\u5c01\u88c5\u4e3a VXLAN\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+-------------------------------------------------------------+\n|                         Master Node                         |\n|                                                             |\n|  +-----------+     +-----------+       +----------------+   |\n|  | Kubelet   | --\x3e | Scheduler |       | Controller     |   |\n|  +-----------+     +-----------+       | Manager        |   |\n|           \\            |               +----------------+   |\n|            \\           |                      |             |\n|             \\          |                      |             |\n|              \\         |                      v             |\n|               \\        +-----------------\x3e API Server <-----+ <-- kubectl\n|                \\                       /     ^       ^      |\n|                 \\                     /      |       |      |\n|                  \\                   /       |       |      |\n|                   \\                 /        |       |      |\n|                    \\               /         |       |      |\n|                     v             v          |       |      |\n|                    etcd <---------+          |       |      |\n|                      ^                       |       |      |\n|                      |                       |       |      |\n|                   Proxy <--------------------+       |      |\n|                      |                               |      |\n+-------------------------------------------------------------+\n+-------------------------------------------------------------+\n|                        Worker Nodes                         |\n|                                                             |\n|  +-----------+     +-----------+       +----------------+   |\n|  | Kubelet   | --\x3e | Proxy     |       | Flannel        |   |\n|  +-----------+     +-----------+       +----------------+   |\n|       |                |                     |              |\n|       v                |                     |              |\n|    Docker             <----------------------+              |\n|       |                          10.0.0.0/8 (Flannel \u7f51\u7edc)  |\n|       v                                                     |\n|    PODs --------------------------------------------\x3e PODs  |\n+-------------------------------------------------------------+\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u8bf4\u660e\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Master Node \u8d1f\u8d23\u96c6\u7fa4\u7ba1\u7406\uff0c\u5305\u62ec Kubelet\u3001Scheduler\u3001Controller Manager\u3001API Server\u3001etcd \u548c Proxy\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Worker Nodes \u8fd0\u884c\u5e94\u7528\u5bb9\u5668\uff0c\u5305\u542b Kubelet\u3001Proxy\u3001Docker \u548c POD\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Flannel \u8d1f\u8d23\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\uff0c\u4f7f\u7528 10.0.0.0/8 \u7f51\u6bb5\u3002"}),"\n",(0,l.jsx)(n.li,{children:"kubectl \u901a\u8fc7 API Server \u4e0e\u96c6\u7fa4\u4ea4\u4e92\u3002"}),"\n",(0,l.jsx)(n.li,{children:"\u6d41\u91cf\uff08traffic\uff09\u5728 Proxy \u4e4b\u95f4\u4f20\u9012\u3002"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"pod\u7f51\u7edc\u901a\u4fe1",children:"pod\u7f51\u7edc\u901a\u4fe1"}),"\n",(0,l.jsx)(n.p,{children:"pod \u662f\u5982\u4f55\u4e0e\u5916\u90e8\u901a\u4fe1\u7684\uff1f"}),"\n",(0,l.jsx)(n.p,{children:"CNI \u63d2\u4ef6\u4e3a\u6bcf\u4e2a\u8282\u70b9\u5206\u914d\u4e00\u4e2a/24\u7f51\u6bb5\uff0c\u4f8b\u598210.42.0.0/24 10.42.1.0/24\uff0c\u6bcf\u4e2a pod \u5206\u914d\u4e00\u4e2a\u8be5\u8282\u70b9\u6301\u6709\u7f51\u6bb5\u7684 ip \u5730\u5740\uff1b\u6bcf\u4e2a pod \u5185\u6709\u4e00\u4e2a eth0 \u865a\u62df\u7f51\u5361\uff0c\u540c\u65f6\u5bbf\u4e3b\u673a\u4e2d\u6709\u4e0e\u5176\u914d\u5bf9\u7684\u53e6\u5916\u4e00\u4e2a\u865a\u62df\u7f51\u5361\uff0c\u4e8c\u8005\u540c\u5c5e\u4e00\u4e2a network namespace\uff0c\u8fd9\u79cd\u6210\u5bf9\u51fa\u73b0\u7684\u7f51\u5361\u53ebveth pair\uff0c\u4e24\u8005\u53ef\u4ee5\u76f8\u4e92\u901a\u4fe1\uff0c\u5c31\u597d\u6bd4\u6709\u4e00\u6839\u7f51\u7ebf\u4e00\u5934\u8fde\u63a5\u4f60\u7684\u7535\u8111\u7f51\u5361\uff0c\u53e6\u4e00\u5934\u8fde\u63a5\u4ea4\u6362\u673a\u3002\u4ee5\u4e0b\u9762 pod \u4e3e\u4f8b\u8bf4\u660e\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s get pod -owide | grep 192.168.4.88\nk8s-xxx-648c86cd45-qbhj9      1/1     Running   0          43d       10.42.4.15     192.168.4.88\n[k8s@k8s-192-168-4-88 ~]$\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u8282\u70b9\u4e0a\u67e5\u770b pod \u5bf9\u5e94\u7684 container \u5982\u4e0b\uff0c\u4e0e\u8fd9\u4e2a pod \u6709\u5173\u7684 container \u6709\u4e24\u4e2a\uff0c\u4e00\u4e2a\u662f\u4e1a\u52a1\u8fdb\u7a0b\u672c\u8eab\uff0c\u4e00\u4e2a\u662f/pause\u8fdb\u7a0b,\u67e5\u770b pod \u5185\u7684\u7f51\u5361\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s exec k8s-xxx-648c86cd45-qbhj9 -- ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n3: eth0@if52: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1450 qdisc noqueue state UP\n    link/ether be:67:6a:d4:65:98 brd ff:ff:ff:ff:ff:ff\n    inet 10.42.4.15/32 brd 10.42.4.15 scope global eth0\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5bbf\u4e3b\u673a\u4e0a\u7684peer veth \u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"[k8s@k8s-192-168-4-88 ~]$ ip l | grep ^52:\n52: cali18e95c70453@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP mode DEFAULT group default\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230 pod \u4e2d\u7684\u7f51\u5361\u540d\uff0c\u4ed6\u6709\u56fa\u5b9a\u7684\u547d\u540d\u89c4\u5219\uff0c\u5e26\u4e86\u5bf9\u7aef\u7f51\u5361\u7684 index \u7f16\u53f7 52\uff0c\u5728\u5bbf\u4e3b\u673a\u4e0a\u67e5\u770b index \u7f16\u53f7\u4e3a 52 \u7684\u7f51\u5361\u540d\u4e3acali18e95c70453\uff0c pod \u7684\u7f51\u7edc\u5305\u6536\u53d1\u90fd\u4f1a\u7ecf\u8fc7\u5bbf\u4e3b\u673a\u4e0a\u7684cali18e95c70453\u7f51\u5361\uff0c\u53ef\u4ee5\u6293\u5305\u9a8c\u8bc1\u4e00\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s exec -it k8s-xxx-648c86cd45-qbhj9 -- curl xxx.com\n<html>\n<head><title>301 Moved Permanently</title></head>\n<body>\n<center><h1>301 Moved Permanently</h1></center>\n<hr><center>TLB</center>\n</body>\n</html>\n[k8s@k8s-192-168-4-88 ~]$\n[k8s@k8s-192-168-4-88 ~]$ sudo tcpdump -nnpA -i cali18e95c70453 tcp dst port 80\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on cali18e95c70453, link-type EN10MB (Ethernet), capture size 262144 bytes\n15:59:43.723438 IP 10.42.4.15.49848 > 122.14.236.25.80: Flags [S], seq 2904204625, win 28200, options [mss 1410,sackOK,TS val 3\nE...<.M@.@..\n*..z.......P...Q.......n(t.........\n..U........\n15:59:43.750376 IP 10.42.4.15.49848 > 122.14.236.25.80: Flags [.], ack 3650196656, win 221, options [nop,nop,TS val 3808777527\nE..4.N@.@...\n*..z.......P...R.......t.......\n..U7{...\n15:59:43.750434 IP 10.42.4.15.49848 > 122.14.236.25.80: Flags [P.], seq 0:77, ack 1, win 221, options [nop,nop,TS val 380877752\nE....O@.@...\n*..z.......P...R.......t.......\n..U7{...GET / HTTP/1.1\nHost: xxx.com\nUser-Agent: curl/8.5.0\nAccept: */*\n"})}),"\n",(0,l.jsx)(n.p,{children:"pod \u4e0e pod \u4e4b\u95f4\u662f\u5982\u4f55\u901a\u4fe1\u7684\u5462\uff1f\u9996\u5148\u5bbf\u4e3b\u673a\u7684\u8def\u7531\u8868\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"default via 192.168.4.1 dev eth0\n10.42.0.0/24 via 10.42.0.0 dev flannel.1 onlink\n10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink\n10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink\n10.42.3.0/24 via 10.42.3.0 dev flannel.1 onlink\n10.42.5.0/24 via 10.42.5.0 dev flannel.1 onlink\n10.42.4.15 dev cali18e95c70453 scope link \n169.254.0.0/16 dev eth0 scope link metric 1002\n172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1\n192.168.4.0/24 dev eth0 proto kernel scope link src 192.168.4.88\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u548c\u5176\u4ed6\u5bbf\u4e3b\u673a\u7684 pod  ip \u6bb5\u662f\u901a\u8fc7flannel.1\u7f51\u5361\u53d1\u9001\uff0c\u518d\u770b\u4e00\u4e0b\u90bb\u5c45\u8868\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"10.42.2.0 dev flannel.1 lladdr 62:6d:e7:6f:f3:e9 PERMANENT\n10.42.1.0 dev flannel.1 lladdr 9a:b6:27:23:b2:21 PERMANENT\n10.42.0.0 dev flannel.1 lladdr a6:eb:6d:4e:48:3a PERMANENT\n10.42.3.0 dev flannel.1 lladdr 16:8e:4f:5c:1e:63 PERMANENT\n10.42.5.0 dev flannel.1 lladdr 0a:14:55:b6:2e:97 PERMANENT\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u7531\u6b64\u53ef\u77e5\u5f53\u53d1\u9001\u5f80\u5176\u4ed6\u8282\u70b9pod\u7684\u6570\u636e\u5305\u5230\u8fbeflannel.1\u7f51\u5361\u65f6\uff0c\u6bcf\u4e2a\u7f51\u6bb5\u90fd\u5bf9\u5e94\u6709\u4e00\u6761\u76ee\u6807 mac \u5730\u5740\uff0c\u800c\u8fd9\u4e9b mac \u5730\u5740\u5c31\u662f\u6bcf\u4e2a\u5bbf\u4e3b\u673a\u8282\u70b9\u4e0a flannel.1\u7f51\u5361\u7684 mac\u3002\n\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0a\u9762 pod \u7684 container \u4e2d\u6709\u4e00\u4e2a\u542f\u52a8\u4e86/pause\u8fdb\u7a0b\u7684 container\uff0c\u53c8\u53eb infra container \u57fa\u7840\u5bb9\u5668\uff0c\u4ed6\u7684\u955c\u50cf\u7531 kubelet \u6307\u5b9a\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"kubelet --infra-container-image=k8s.gcr.io/pause:3.2\n"})}),"\n",(0,l.jsx)(n.p,{children:"Infra container\u7684\u4f5c\u7528\u662f\u5b9e\u73b0 pod \u5185\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u7684\u5b58\u50a8\u3001\u7f51\u7edc\u7b49\u8d44\u6e90\u7684\u5171\u4eab\uff0c\u5355\u72ec\u4e00\u4e2a pause \u5bb9\u5668\u7684\u597d\u5904\u662f\u4ed6\u91cc\u9762\u6ca1\u6709\u4efb\u4f55\u4e1a\u52a1\u903b\u8f91\u4e0d\u5bb9\u6613\u6302\u6389\uff0c\u4f7f\u5f97 namespace \u5171\u4eab\u66f4\u52a0\u7a33\u5b9a\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"kube-proxy",children:"kube-proxy"}),"\n",(0,l.jsxs)(n.p,{children:["\u7b80\u4ecb\n\u6765\u81ea k8s \u5b98\u7f51\u5bf9 kube-proxy \u7684\u5b9a\u4e49\uff1aKubernetes \u7f51\u7edc\u4ee3\u7406\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u3002\u7f51\u7edc\u4ee3\u7406\u53cd\u6620\u4e86\u6bcf\u4e2a\u8282\u70b9\u4e0a Kubernetes API \u4e2d\u5b9a\u4e49\u7684\u670d\u52a1\uff0c\u5e76\u4e14\u53ef\u4ee5\u6267\u884c\u7b80\u5355\u7684 TCP\u3001UDP \u548c SCTP \u6d41\u8f6c\u53d1\uff0c\u6216\u8005\u5728\u4e00\u7ec4\u540e\u7aef\u8fdb\u884c \u5faa\u73af TCP\u3001UDP \u548c SCTP \u8f6c\u53d1\u3002 \u5f53\u524d\u53ef\u901a\u8fc7 Docker-links-compatible \u73af\u5883\u53d8\u91cf\u627e\u5230\u670d\u52a1\u96c6\u7fa4 IP \u548c\u7aef\u53e3\uff0c \u8fd9\u4e9b\u73af\u5883\u53d8\u91cf\u6307\u5b9a\u4e86\u670d\u52a1\u4ee3\u7406\u6253\u5f00\u7684\u7aef\u53e3\u3002 \u6709\u4e00\u4e2a\u53ef\u9009\u7684\u63d2\u4ef6\uff0c\u53ef\u4ee5\u4e3a\u8fd9\u4e9b\u96c6\u7fa4 IP \u63d0\u4f9b\u96c6\u7fa4 DNS\u3002 \u7528\u6237\u5fc5\u987b\u4f7f\u7528 apiserver API \u521b\u5efa\u670d\u52a1\u624d\u80fd\u914d\u7f6e\u4ee3\u7406\u3002\n\u7b80\u8a00\u4e4b\uff0c kube-proxy \u7684\u4f5c\u7528\u662f\u627f\u8f7d k8s svc\u7684\u6d41\u91cf\u8f6c\u53d1\uff0c\u5c06\u8bf7\u6c42\u5f80 svc ip",":port","\u7684\u6d41\u91cf\u8f6c\u53d1\u5230 podip",":port","\u4e0a\uff0c\u540c\u65f6\u8fd8\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u4e0e\u5065\u5eb7\u68c0\u67e5\u673a\u5236\u3002"]}),"\n",(0,l.jsx)(n.p,{children:"\u90e8\u7f72\u67b6\u6784:"}),"\n",(0,l.jsx)(n.mermaid,{value:'flowchart TD\n    subgraph Overlay_Network[Overlay Network]\n    end\n    subgraph Master\n        API_Server[API Server]\n        Scheduler[Scheduler]\n        Controller_Manager[Controller Manager]\n        etcd[etcd]\n    end\n    subgraph Node1["Node 1"]\n        subgraph KubeProxy1[Kubelet kube-proxy]\n        end\n        C1_1[C1]\n        C2_1[C2]\n        C3_1[C3]\n        Container_Runtime1[Container Runtime]\n        Operating_System1[Operating System]\n        Infrastructure1[Infrastructure]\n    end\n    subgraph Node2["Node 2"]\n        subgraph KubeProxy2[Kubelet kube-proxy]\n        end\n        C1_2[C1]\n        C2_2[C2]\n        C3_2[C3]\n        Container_Runtime2[Container Runtime]\n        Operating_System2[Operating System]\n        Infrastructure2[Infrastructure]\n    end\n    Overlay_Network --\x3e Master\n    Overlay_Network --\x3e Node1\n    Overlay_Network --\x3e Node2\n    Node1 --\x3e Infrastructure1\n    Infrastructure1 --\x3e Operating_System1\n    Operating_System1 --\x3e Container_Runtime1\n    Container_Runtime1 --\x3e KubeProxy1\n    Container_Runtime1 --\x3e C1_1\n    Container_Runtime1 --\x3e C2_1\n    Container_Runtime1 --\x3e C3_1\n    Node2 --\x3e Infrastructure2\n    Infrastructure2 --\x3e Operating_System2\n    Operating_System2 --\x3e Container_Runtime2\n    Container_Runtime2 --\x3e KubeProxy2\n    Container_Runtime2 --\x3e C1_2\n    Container_Runtime2 --\x3e C2_2\n    Container_Runtime2 --\x3e C3_2'}),"\n",(0,l.jsx)(n.p,{children:"linux \u7cfb\u7edf\u4e2d\u7684kube-proxy \u652f\u6301\u591a\u79cd\u4ee3\u7406\u6a21\u5f0f\uff0cuserspace\u3001iptables \u548c ipvs\uff0cuserspace \u6a21\u5f0f\u5c5e\u4e8e\u65e9\u671f\u5b9e\u73b0\u7684\u65b9\u6848\uff0c\u56e0\u4e3a\u6027\u80fd\u539f\u56e0\u5df2\u7ecf\u9010\u6e10\u5f03\u7528\uff0ciptables \u6a21\u5f0f\u901a\u8fc7 iptables \u5b9e\u73b0\u6570\u636e\u5305\u8f6c\u53d1\uff0c\u4f46\u4e0d\u5177\u5907\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\u4e14\u89c4\u6a21\u4e0a\u53bb\u4e4b\u540e iptables \u89c4\u5219\u592a\u591a\u4e5f\u4f1a\u5f15\u53d1\u6027\u80fd\u95ee\u9898\uff0c\u76ee\u524d k8s \u4e2d\u4f7f\u7528\u7684\u662f ipvs \u6a21\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u542f\u52a8\u53c2\u6570\u770b\u5230\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"[k8s@k8s-192-168-4-86 ~]$ ps aux|grep kube-proxy\nk8s  80898  0.0  0.0 112816   988 pts/1    S+   23:17   0:00 grep --color=auto kube-proxy\nroot     196678  0.2  0.0 750776 31484 ?        Ssl  Jun18  191:02 kube-proxy --feature-gates=TTLAfterFinished=true --proxy-mode=ipvs --cluster-cidr=10.42.0.0/16 --xy.yaml --healthz-bind-address=127.0.0.1 --v=2\n"})}),"\n",(0,l.jsx)(n.p,{children:"ipvs \u662f linux kernel \u4e2d\u7684\u6a21\u5757\uff0c\u5177\u5907\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\u7684\u540c\u65f6\u8fd8\u80fd\u83b7\u5f97\u4e0d\u9519\u7684\u8f6c\u53d1\u6027\u80fd\u3002ipvs \u6a21\u5757\u6765\u81ea\u4e8e lvs \u9879\u76ee\uff0clvs \u9879\u76ee\u8bde\u751f\u4e8e 1998 \u5e74\uff0cipvs \u6a21\u5757\u6700\u65b0\u7248\u672c\u4e3a v1.2 \u53d1\u5e03\u4e8e 2004 \u5e74\uff0c\u8ddd\u4eca\u5df2\u7ecf\u7a33\u5b9a\u8fd0\u884c20 \u5e74\u3002\u503c\u5f97\u4e00\u63d0\u7684\u662f lvs \u9879\u76ee\u7684\u521b\u7acb\u8005\u7ae0\u6587\u5d69\u535a\u58eb\uff0c\u4ed6\u7684\u8d21\u732e\u4f7f\u5f97  ipvs \u6210\u4e3a\u4e86\u8d1f\u8f7d\u5747\u8861\u9886\u57df\u7684\u91cd\u8981\u6280\u672f\uff0c\u5bf9\u4e92\u8054\u7f51\u57fa\u7840\u8bbe\u65bd\u7684\u53d1\u5c55\u4ea7\u751f\u4e86\u79ef\u6781\u6df1\u8fdc\u7684\u5f71\u54cd\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u6d41\u5411:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+---------------------------------+\n|             Node                |\n|  +----------+  +------------+   |\n|  |  Client  |  | kube-proxy |---+\n|  +----------+  +------------+   |\n|           \\           /         |\n|            \\         /          |\n|        +----------------+       |\n|        |   clusterIP    |       |\n|        | (Virtual Server)|      |\n|        +----------------+       |\n+------------------------------+  |\n                      -           |\n          +-----------------------+-----------------------+\n          |           -           |                       |\n+----------------+  +----------------+  +-----------------+\n| Backend Pod 1  |  | Backend Pod 2  |  | Backend Pod 3   |\n| (Real Server)  |  | (Real Server)  |  | (Real Server)   |\n+----------------+  +----------------+  +-----------------+\n"})}),"\n",(0,l.jsx)(n.h2,{id:"svc\u5b9e\u73b0\u673a\u5236",children:"svc\u5b9e\u73b0\u673a\u5236"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 k8s \u4e2d\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u7c7b\u578b\u7684 Service\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"ClusterIP\uff1aClusterIP \u662f\u9ed8\u8ba4\u7684 Service \u7c7b\u578b\uff0c\u5b83\u4e3a Service \u5206\u914d\u4e00\u4e2a Cluster IP \u5730\u5740\uff0c\u5e76\u5728\u96c6\u7fa4\u5185\u90e8\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u3002\u5f53\u8bf7\u6c42\u53d1\u9001\u5230 ClusterIP \u5730\u5740\u65f6\uff0ck8s \u7684\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u673a\u5236\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u540e\u7aef Pod\u3002"}),"\n",(0,l.jsx)(n.li,{children:"NodePort\uff1aNodePort \u7c7b\u578b\u7684 Service \u5177\u6709 ClusterIP \u7684\u6240\u6709\u529f\u80fd\uff0c\u5e76\u4e14\u8fd8\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6253\u5f00\u4e00\u4e2a\u9759\u6001\u7aef\u53e3\uff0c\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230 Service\u3002\u5f53\u8bf7\u6c42\u53d1\u9001\u5230\u4efb\u4f55\u8282\u70b9\u7684 NodePort \u7aef\u53e3\u65f6\uff0ck8s \u4f1a\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u76f8\u5e94\u7684 Service\u3002"}),"\n",(0,l.jsx)(n.li,{children:"LoadBalancer\uff1aLoadBalancer \u7c7b\u578b\u7684 Service \u901a\u8fc7\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff08\u5982 AWS ELB\u3001GCP GCLB\uff09\u6765\u516c\u5f00 Service\u3002\u8d1f\u8f7d\u5747\u8861\u5668\u4f1a\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u540e\u7aef Pod\u3002"}),"\n",(0,l.jsx)(n.li,{children:"ExternalName\uff1aExternalName \u7c7b\u578b\u7684 Service \u5141\u8bb8\u5c06 Service \u6620\u5c04\u5230\u96c6\u7fa4\u5916\u90e8\u7684\u4efb\u610f DNS \u540d\u79f0\u3002\u5b83\u4e0d\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\uff0c\u53ea\u662f\u901a\u8fc7 CNAME \u8bb0\u5f55\u5c06 Service \u540d\u79f0\u89e3\u6790\u4e3a\u5916\u90e8 DNS \u540d\u79f0\u3002"}),"\n",(0,l.jsx)(n.li,{children:"Headless Service\uff1a\u65e0\u5934\u670d\u52a1\uff0c\u662f k8s \u4e2d\u7684\u4e00\u79cd\u7279\u6b8a\u7c7b\u578b\u7684 Service\uff0c\u5b83\u4e0e\u5176\u4ed6\u7c7b\u578b\u7684 Service\uff08\u5982 ClusterIP\u3001NodePort\u3001LoadBalancer\uff09\u6709\u6240\u4e0d\u540c\u3002Headless Service \u4e0d\u4f1a\u4e3a Service \u5206\u914d Cluster IP\uff0c\u800c\u662f\u901a\u8fc7 DNS \u8bb0\u5f55\u76f4\u63a5\u66b4\u9732\u540e\u7aef Pod \u7684\u7f51\u7edc\u5730\u5740\u3002\nClusterIP svc\u7684\u8bf7\u6c42\u8f6c\u53d1\u8fc7\u7a0b\uff1a\n\u6709 svc \u5982\u4e0b:"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get svc backend-service -owide\nNAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)      AGE    SELECTOR\nbackend-service   ClusterIP  10.43.199.15   <none>        18888/TCP   44d    app=backend-service\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u8be5 svc \u7684 clusterip \u4e3a 10.43.199.15\uff0c\u5916\u90e8\u7aef\u53e3\u548c\u5185\u90e8\u7aef\u53e3\u4e00\u6837\u4e3a 18888\uff0c\u5bf9\u5e94\u7684\u540e\u7aef pod \u7684 app label \u662f backend-service\u300210.43.199.15\u662f\u4e00\u4e2a\u865a\u62df\u673a IP\uff08VIP\uff09\uff0ckube-proxy \u4f1a\u628a\u8fd9\u4e2a ip \u7ed1\u5b9a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\uff0c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"[k8s@k8s-192-168-4-86 ~]$ run 'ip -o a |grep 10.43.199.15'\n192.168.4.87    43: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\       valid_lft forever preferred_lft forever\n192.168.4.91    33: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\       valid_lft forever preferred_lft forever\n192.168.4.90    15: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\       valid_lft forever preferred_lft forever\n192.168.4.88    23: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\       valid_lft forever preferred_lft forever\n192.168.4.89    33: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\       valid_lft forever preferred_lft forever\n192.168.4.86    15: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\\       valid_lft forever preferred_lft forever\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u63a5\u7740 kube-proxy \u4f1a\u901a\u8fc7 apiserver \u627e\u5230 label app=backend-service\u7684\u540e\u7aef\u670d\u52a1 endpoints\uff0c\u662f pod \u7684\u5185\u7f51 ip+\u7aef\u53e3\uff0c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get pod -o wide -l app=backend-service\nNAME                                READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES\nbackend-service-555d6684b5-9kwc7    1/1     Running   0          31d   10.42.3.171  192.168.4.90   <none>           <none>\nbackend-service-555d6684b5-s7n9n    1/1     Running   0          31d   10.42.0.134  192.168.4.91   <none>           <none>\n```text\n[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get ep backend-service\nNAME             ENDPOINTS                        AGE\nbackend-service   10.42.0.134:18888,10.42.3.171:18888   44d\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u63a5\u7740\uff0ckube-proxy \u901a\u8fc7\u521b\u5efa ipvs \u89c4\u5219\uff0c\u5c06\u53d1\u5f80 VIP\u7684\u6d41\u91cf\u8f6c\u53d1\u5230\u540e\u7aef realserver,"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"[k8s@k8s-192-168-4-86 ~]$ sudo ipvsadm -Ln|grep -A2 10.43.199.15\nTCP  10.43.199.15:18888 rr\n  -> 10.42.0.134:18888  Masq    1    0    0\n  -> 10.42.3.171:18888  Masq    1    0    0\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u81ea\u6b64\uff0c\u6574\u4e2a\u94fe\u8def\u5c31\u6253\u901a\u4e86\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"ingress",children:"ingress"}),"\n",(0,l.jsx)(n.p,{children:"ingress \u6b63\u5982\u5176\u5b57\u9762\u610f\u601d\uff0c\u662f k8s \u5bf9\u5916\u7684\u6d41\u91cf\u5165\u53e3\uff0c\u9664\u4e86\u652f\u6301 http \u6d41\u91cf\u5916\u4e5f\u652f\u6301 tcp\u3001udp \u6d41\u91cf\u8f6c\u53d1\u3002\ningress-nginx \u662f\u5176\u4e2d\u4e00\u79cdcontroller\u5b9e\u73b0\uff0c\u9664\u4e86 nginx \u7684\u5b9e\u73b0\u4ee5\u5916\u8fd8\u6709\u5176\u4ed6\u5f88\u591a ingress controller\u5b9e\u73b0\u4f8b\u5982haproxy\u3001apisix\u3001kong\u7b49\uff0ck8s \u4e2d\u4f7f\u7528\u7684\u662fnginx-ingress-controller\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u6d41\u5411:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+------------------------+          +-----------------------+          +-------------------------+\n| Kubernetes Cluster SVC |<---------|  Ingress Controller   |<---------|  Load Balancer          |\n+------------------------+          +-----------------------+          +-------------------------+\n          ^                                ^     |                              ^\n          |                                |     | leader                       |\n          |                                |     |                              |\n          | expose business service        |     |                              | access FQDN\n          |                                |     |                              |\n+-----------------------+          +------------------------+          +-------------------------+\n| business logic POD    |          | Kubernetes NodePort SVC|          | Client                  |\n+-----------------------+          +------------------------+          +-------------------------+\n                                       ^\n                                       |\n                                       | access business svc\n                                       |\n                                       |\n                           +------------------------------------+\n                           | control plane (green dashed lines) |\n                           +------------------------------------+\n                           | data plane (red solid lines)       |\n                           +------------------------------------+\n"})}),"\n",(0,l.jsx)(n.p,{children:"Additional notes:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"The Ingress Controller gets endpoints & generates config file from Kubernetes Cluster SVC."}),"\n",(0,l.jsx)(n.li,{children:"The Ingress Controller exposes ingress service to Kubernetes NodePort SVC."}),"\n",(0,l.jsx)(n.li,{children:"The Load Balancer accesses the Kubernetes NodePort SVC."}),"\n",(0,l.jsx)(n.li,{children:"The Client accesses the Load Balancer via FQDN."}),"\n",(0,l.jsx)(n.li,{children:"The Load Balancer accesses the business service via Kubernetes NodePort SVC."}),"\n",(0,l.jsx)(n.li,{children:"The business logic POD is exposed by the Kubernetes Cluster SVC."}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6570\u636e\u5e73\u9762\uff1a\n\u5ba2\u6237\u7aef\u53d1\u9001 http \u8bf7\u6c42\u81f3 LB\uff0cLB \u8f6c\u53d1\u6d41\u91cf\u81f3ingress-nginx NodePort svc\uff0c\u7531nginx-ingress-controller pod \u4e2d\u7684 nginx \u8fdb\u7a0b\u63a5\u6536\u8fd9\u4e9b\u6d41\u91cf\uff0cnginx \u8fdb\u7a0b\u5145\u5f53\u53cd\u5411\u4ee3\u7406\u7684\u89d2\u8272\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0bnginx \u662f\u76f4\u63a5\u8f6c\u53d1\u81f3\u5404\u4e1a\u52a1 svc \u5bf9\u5e94\u7684 endpoints\uff0c\u800c\u975esvc \u672c\u8eab\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u6d41\u91cf\u7ed5\u8fc7 kube-proxy \u6d41\u7a0b\uff0c\u7f29\u77ed\u94fe\u8def\u3002\u8fd9\u4e00\u884c\u4e3a\u53ef\u901a\u8fc7nginx.ingress.kubernetes.io/service-upstream\u6ce8\u89e3\u63a7\u5236\u3002\n\u63a7\u5236\u5e73\u9762\uff1a\nnginx-ingress-controller pod \u4e2d\u9664\u4e86 nginx\u8fdb\u7a0b\u4ee5\u5916\u8fd8\u6709\u8d1f\u8d23\u63a7\u5236\u9762\u7684 nginx-ingress-controller \u8fdb\u7a0b\uff0c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:" [k8s@k8s-192-168-4-86 ~]$ kubectl -n ingress-nginx exec -it nginx-ingress-controller-68c566495-hj457 -- ps aux\nPID   USER      TIME  COMMAND\n1     www-data  0:00  /usr/bin/dumb-init -- /nginx-ingress-controller --default-\n7     www-data  4h40  /nginx-ingress-controller --default-backend-service=ingres\n50    www-data  0:13  nginx: master process /usr/local/nginx/sbin/nginx -c /etc/ng\n38549 www-data  0:41  nginx: worker process\n38550 www-data  0:39  nginx: worker process\n38583 www-data  0:38  nginx: worker process\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5f53 pod \u62c9\u8d77\u65f6\u901a\u8fc7\u6ce8\u518c\u5e76 lock ingress-controller-leader-nginx configmap \u9009\u4e3b\uff0c\u53ea\u6709\u4e00\u4e2a Pod \u80fd\u591f\u6210\u529f\u521b\u5efa ConfigMap\uff0c\u6210\u4e3a\u4e3b\u8282\u70b9\u3002\u5176\u4ed6 Pod \u4f1a\u68c0\u6d4b\u5230 ConfigMap \u5df2\u7ecf\u5b58\u5728\uff0c\u5e76\u6210\u4e3a\u4ece\u8282\u70b9\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'[k8s@k8s-192-168-4-86 ~]$ kubectl -n ingress-nginx get cm ingress-controller-leader-nginx -o yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  annotations:\n    control-plane.alpha.kubernetes.io/leader: \'{"holderIdentity":"nginx-ingress-controller-7p6wd","leaseDurationSeconds":30,"acquireTime":"2024-07-31T12:31:56Z","renewTime":"2024-07-31T13:44:30Z","leaderTransitions":4}\'\n  creationTimestamp: "2024-06-18T01:23:07Z"\nmanagedFields:\n- apiVersion: v1\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u4e3b\u8282\u70b9\u8d1f\u8d23\u76d1\u542c k8s API Server \u4e2d\u7684 Ingress \u8d44\u6e90\uff0c\u5e76\u6839\u636e\u914d\u7f6e\u89c4\u5219\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\u3002\u4ece\u8282\u70b9\u4f1a\u590d\u5236\u4e3b\u8282\u70b9\u7684\u914d\u7f6e\uff0c\u5e76\u7b49\u5f85\u4e3b\u8282\u70b9\u4e0d\u53ef\u7528\u65f6\u63a5\u7ba1\u6d41\u91cf\u8f6c\u53d1\u4efb\u52a1\u3002\u5982\u679c\u4e3b\u8282\u70b9\u53d1\u751f\u6545\u969c\u91cd\u542f\u7b49\uff0c\u8d85\u8fc7 30 \u79d2\u4ece\u8282\u70b9\u5c31\u4f1a\u68c0\u6d4b\u5230\u4e3b\u8282\u70b9\u4e0d\u53ef\u7528\uff0c\u5e76\u5f00\u59cb\u7ade\u9009\u65b0\u7684\u4e3b\u8282\u70b9\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"\u4f7f\u7528\u793a\u4f8b",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,l.jsx)(n.p,{children:"\u4ee5\u4e0b demo \u6f14\u793a\u5982\u4f55\u521b\u5efa ingress\u4ee5\u53ca\u5bf9\u5e94\u7684 svc\u3001endpoint \u8d44\u6e90\uff0c\u5e76\u5bf9\u5916\u63d0\u4f9b\u8bbf\u95ee\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: v1\nkind: Service\nmetadata:\n  name: laosiji\n  namespace: default\nspec:\n  type: ClusterIP\n  ports:\n  - port: 6666\n\n---\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: laosiji\n  namespace: default\nsubsets:\n  - addresses:\n    - ip: 192.168.4.86\n    ports:\n    - port: 6666\n\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: laosiji-ingress\n  namespace: default\nspec:\n  rules:\n  - host: siji.example.com\n    http:\n      paths:\n      - pathType: Prefix\n        path: /\n        backend:\n          service:\n            name: laosiji\n            port:\n              number: 6666\n"})}),"\n",(0,l.jsx)(n.h2,{id:"coredns",children:"Coredns"}),"\n",(0,l.jsx)(n.p,{children:"coredns \u662fk8s \u751f\u6001\u4e2d\u539f\u751f\u670d\u52a1\u53d1\u73b0\u7684\u5b9e\u73b0\u65b9\u6848\uff0c\u63d2\u4ef6\u5316\u8bbe\u8ba1\uff0c\u4e00\u4e2a\u529f\u80fd\u5bf9\u5e94\u4e00\u4e2a\u63d2\u4ef6\uff0c\u9ad8\u5ea6\u7075\u6d3b\u53ef\u6269\u5c55\uff0c\u652f\u6301\u81ea\u5b9a\u4e49\u63d2\u4ef6\u5f00\u53d1\u3002coredns \u53ef\u4ee5\u4e3a svc\u3001sts\u3001pod \u7b49\u63d0\u4f9b\u57df\u540d\u89e3\u6790\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u89e3\u6790\u6d41\u7a0b:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+-------------------------------------------------------------+     +----------------------------------------+\n|                      Kubernetes node A                      |     |             Kubernetes node B          |\n|                                                             |     |                                        |\n|  +----------------------+                                   |     |  +----------------------+              |\n|  |       Pod foo        |                                   |     |  |      node's          |              |\n|  |                      |                                   |     |  |    resolv.conf       |              |\n|  |  +----------------+  |                                   |     |  +----------------------+              |\n|  |  |  Application   |  |                                   |     |                                        |\n|  |  +----------------+  |                                   |     |                                        |\n|  |          |           |                                   |     |                                        |\n|  | Initiates DNS lookup |                                   |     |                                        |\n|  |          v           |                                   |     |                                        |\n|  |  +----------------+  |                                   |     |                                        |\n|  |  | DNS resolver   |  |                                   |     |                                        |\n|  |  +----------------+  |                                   |     |                                        |\n|  |          |           |                                   |     |                                        |\n|  | Uses the DNS server  |                                   |     |                                        |\n|  | specified in         |                                   |     |                                        |\n|  |          v           |                                   |     |                                        |\n|  |  +----------------+  |            Points to              |     |  +----------------+                    |\n|  |  |  resolv.conf   |  | ---------------------------------\x3e|----\x3e|  |   CoreDNS      |                    |\n|  |  +----------------+  |                                   |     |  +----------------+                    |\n|  |          |           |                                   |     |      |           |                     |\n|  | If not in cache,     |                                   |     |      | Forwards  |                     |\n|  | retrieves DNS servers|                                   |     |      v           v                     |\n|  | from                 |                                   |     |  +----------------+  +----------------+|\n|  |          v           |                                   |     |  | node's resolv.conf|  |K8s API  |    |\n|  |  +----------------+  |                                   |     |  +----------------+  |(Svcs/Endpoints) |\n|  |  | nodelocaldns   |  |                                   |     |                     +----------------+ |\n|  |  +----------------+  |                                   |     |                                        |\n|  +----------------------+                                   |     +----------------------------------------+\n+-------------------------------------------------------------+\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u8bb0\u5f55\u89c4\u5219",children:"\u8bb0\u5f55\u89c4\u5219"}),"\n",(0,l.jsx)(n.p,{children:"svc\u8bb0\u5f55\u89c4\u5219\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"<svc-name>.<namespace-name>.svc.<cluster-domain>\n"})}),"\n",(0,l.jsx)(n.p,{children:"statefulset\u8bb0\u5f55\u89c4\u5219\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"<pod-name>.<svc-name>.<namespace-name>.svc.<cluster-domain>\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u793a\u4f8b:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'.:53 {                            # \u76d1\u542c\u5730\u5740\u548c\u7aef\u53e3\n    errors                        # \u542f\u7528\u9519\u8bef\u65e5\u5fd7\n    health {                      # \u5065\u5eb7\u68c0\u67e5\u914d\u7f6e,\u63d0\u4f9bLiveness\u63a2\u9488\u5730\u5740http://:8080/health\n      lameduck 5s                 # \u5728\u5173\u95ed\u524d\u7684\u7b49\u5f85\u65f6\u95f4\n    }\n    ready                         # \u542f\u7528\u5c31\u7eea\u68c0\u67e5\n    hosts /etc/add_hosts {        # \u4f7f\u7528\u6307\u5b9a\u7684hosts\u6587\u4ef6\u8fdb\u884c\u89e3\u6790\n      #1.2.3.1   kubenode1        # hosts\u6587\u4ef6\u4e2d\u7684\u89e3\u6790\u89c4\u5219\uff0c\u5c06kubenode1\u89e3\u6790\u4e3a1.2.3.1\n      fallthrough                 # \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230hosts\u6587\u4ef6\u4e2d\u7684\u89e3\u6790\u89c4\u5219\uff0c\u7ee7\u7eed\u5411\u4e0b\u89e3\u6790\n    }\n    kubernetes cluster.local in-addr.arpa ip6.arpa {   # Kubernetes\u76f8\u5173\u914d\u7f6e\n      pods insecure               # \u5141\u8bb8\u901a\u8fc7\u57df\u540d\u89e3\u6790Pods\u7684IP\u5730\u5740\n      fallthrough in-addr.arpa ip6.arpa                # \u5982\u679c\u6ca1\u6709\u5339\u914d\u5230Kubernetes\u76f8\u5173\u7684\u89e3\u6790\u89c4\u5219\uff0c\u7ee7\u7eed\u5411\u4e0b\u89e3\u6790\n    }\n    prometheus :9153              # \u542f\u7528Prometheus\u6307\u6807\u6536\u96c6\uff0c\u76d1\u542c\u5730\u5740\u548c\u7aef\u53e3\n    bufsize 4096                  #  limits a requester\u2019s UDP payload size to within a maximum value,must be within 512 - 4096\n    forward . "/etc/resolv.conf"  # \u4f7f\u7528\u6307\u5b9a\u7684resolv.conf\u6587\u4ef6\u8fdb\u884c\u8f6c\u53d1\u89e3\u6790\n    cache 30                      # DNS\u7f13\u5b58\u65f6\u95f4\n    loop                          # \u542f\u7528\u5faa\u73af\u67e5\u8be2\n    reload                        # \u76d1\u542c\u914d\u7f6e\u6587\u4ef6\u7684\u53d8\u5316\u5e76\u81ea\u52a8\u91cd\u65b0\u52a0\u8f7d\n    loadbalance                   # \u542f\u7528\u8d1f\u8f7d\u5747\u8861\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"pod \u4e2d\u7684 dns \u914d\u7f6e\u53d7dnsPolicy\u7b56\u7565\u548c hostNetwork \u7b56\u7565\u63a7\u5236\uff0c\u5f53hostNetwork=true \u65f6\uff0c\u4f7f\u7528\u5bbf\u4e3b\u673a dns\uff0c\u5176\u4e2ddnsPolicy\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"\n| \u7b56\u7565\u540d\u79f0                | \u89e3\u6790\u884c\u4e3a                                                                 |\n|-------------------------|-------------------------------------------------------------------------|\n| Default                 | Pod \u4f7f\u7528\u5bbf\u4e3b\u673a\u7684 DNS \u914d\u7f6e                                                |\n| ClusterFirst            | \u9ed8\u8ba4\u8bbe\u7f6e\uff0cPod \u4f7f\u7528 coredns \u4f5c\u4e3a nameserver\uff0c\u5176 nameserver \u6765\u81ea kubelet \u7684--cluster-dns=10.43.0.10\u53c2\u6570 |\n| ClusterFirstWithHostNet | \u5373\u4f7f\u662fhostNetwork=true\uff0c\u4e5f\u4f1a\u4f7f\u7528 coredns                                |\n| None                    | \u4f7f\u7528 Pod \u7684 dnsConfig \u914d\u7f6e\u9879                                             |\n\n\n\u89e3\u6790\u793a\u4f8b:\n```text\nroot@backend-service-555d6684b5-9kwc7:~# cat /etc/resolv.conf\nnameserver 10.43.0.10\nsearch k8s.svc.cluster.local svc.cluster.local cluster.local\noptions ndots:5\nroot@backend-service-555d6684b5-9kwc7:~# nslookup clickhouse-service.clickhouse\nServer:         10.43.0.10\nAddress:        10.43.0.10#53\nName:   clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.91\nName:   clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.86\nName:   clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.87\nName:   clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.90\nName:   clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.89\nName:   clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.88\nroot@backend-service-555d6684b5-9kwc7:~# nslookup clickhouse-1-1-0.clickhouse-service.clickhouse\nServer:         10.43.0.10\nAddress:        10.43.0.10#53\nName:   clickhouse-1-1-0.clickhouse-service.clickhouse.svc.cluster.local\nAddress: 192.168.4.86\n"})}),"\n",(0,l.jsx)(n.h2,{id:"k8s-\u76d1\u63a7",children:"k8s \u76d1\u63a7"}),"\n",(0,l.jsx)(n.p,{children:"metrics-server\n\u7528\u6765\u91c7\u96c6 k8s \u5404\u79cd\u76d1\u63a7\u6307\u6807\uff0c\u63d0\u4f9b\u7ed9kubectl top\u3001hpa\uff08Horizontal Pod Autoscaler\uff09\u3001vpa\uff08Vertical Pod Autoscaler\uff09\u3001k8s-dashboard \u7b49\u4f7f\u7528\u3002\n\u6570\u636e\u94fe\u8def\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+-----------+      +----------+      +---------------+      +---------+      +--------+\n|  kubectl  |      | apiserver|      | metrics-server|      | kubelet |      | cgroup |\n+-----------+      +----------+      +---------------+      +---------+      +--------+\n      \\                 ^                   ^                   ^                ^\n       \\                |                   |                   |                |\n+-----------+           |                   |                   |                |\n| dashboard |-----------+                   |                   |                |\n+-----------+                               |                   |                |\n      \\                                     |                   |                |\n       \\                                    |                   |                |\n+-----------+                               |                   |                |\n| scheduler |-------------------------------+                   |                |\n+-----------+                                                   |                |\n                                                                |                |\n                                                                |                |\n                                                                +----------------+\n"})}),"\n",(0,l.jsxs)(n.p,{children:["metrics-sever \u901a\u8fc7\u91c7\u96c6 kubelet \u63d0\u4f9b\u7684 metrics \u63a5\u53e3\uff08",(0,l.jsx)(n.a,{href:"https://nodeip:10250",children:"https://nodeip:10250"})," \u7684 /metrics   /metrics/cadvisor,  /metrics/probes, /metrics/resource\uff09\u7684\u6570\u636e\uff0c\u91c7\u96c6\u6307\u6807\u793a\u4f8b:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:'[k8s@k8s-192-168-4-86 ~]$ curl -s -k -H "Authorization: Bearer $(kubectl -n kube-system get secrets namespace-controller-token-qwvll -ojson|jq \'.data.token\' -r|base64 -d)" https://192.168.4.86:10250/metrics/resource|head -10\n## HELP container_cpu_usage_seconds_total [ALPHA] Cumulative cpu time consumed by the container in core-seconds\n## TYPE container_cpu_usage_seconds_total counter\ncontainer_cpu_usage_seconds_total{container="apiserver",namespace="hive2ch",pod="hive2ch-apiserver-6fdf5df7f5-lgvgp"} 2270.429353976 1722443959650\ncontainer_cpu_usage_seconds_total{container="backend",namespace="sub",pod="subscription-backend-7cd788b876-6z74p"} 7573.822327467 1722443959713\ncontainer_cpu_usage_seconds_total{container="calico-node",namespace="kube-system",pod="canal-xrmh4"} 108549.571417276 1722443963395\ncontainer_cpu_usage_seconds_total{container="clickd",namespace="clickhouse",pod="clickd-deployment-549944fcf9-2fzzf"} 65865.995640873 1722443965340\ncontainer_cpu_usage_seconds_total{container="clickhouse-server",namespace="clickhouse",pod="clickhouse-1-1-0"} 473112.908558262 1722443956984\ncontainer_cpu_usage_seconds_total{container="consul-client",namespace="consul",pod="consul-client-3-0"} 103994.031234639 1722443955027\ncontainer_cpu_usage_seconds_total{container="controller",namespace="ingress-nginx",pod="nginx-ingress-controller-z46n4"} 103172.807361637 1722443959662\ncontainer_cpu_usage_seconds_total{container="coredns",namespace="kube-system",pod="coredns-68c65cb45-9hxdn"} 43348.132995208 1722443948530\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u518d\u901a\u8fc7 apiserver \u7684 Metrics API \u5bf9\u5185\u63d0\u4f9b\u670d\u52a1\u3002\u5176\u8bbe\u8ba1\u7684\u4e3b\u8981\u76ee\u7684\u662f\u7528\u4e8e autoscaling\uff0c\u4e0d\u5efa\u8bae\u7528\u4f5c\u6307\u6807\u76d1\u63a7\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"prometheus",children:"prometheus"}),"\n",(0,l.jsx)(n.p,{children:"prometheus \u662f\u7b2c\u4e8c\u4e2a CNCF \u6258\u7ba1\u7684\u9879\u76ee\uff08\u7b2c\u4e00\u4e2a\u662f k8s\uff09\uff0c\u4e3a k8s \u76d1\u63a7\u91cf\u8eab\u6253\u9020\uff0c\u63d0\u4f9b\u4e86\u5305\u542b\u6307\u6807\u91c7\u96c6\u3001\u5b58\u50a8\u3001\u67e5\u8be2\u4ee5\u53ca\u544a\u8b66\u7b49\u4e00\u5957\u5b8c\u6574\u7684\u80fd\u529b\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u6574\u4f53\u67b6\u6784:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+------------------+          +---------------------------+          +--------------+          +----------------+\n| Short-lived jobs |          |      Service discovery    |          | Alertmanager |          |    pagerduty   |\n+------------------+          | +-----------+ +---------+ |          +--------------+          +----------------+\n        |                     | | kubernetes | | file_sd| |                | notify                 | Email   |\n        | push metrics at exit| +-----------+ +---------+ |                |------------------------| etc     |\n        v                    +----------------------------+                |                         +--------+\n+--------------+                      | discover targets                push alerts\n| Pushgateway  |----------------------|------------------------------------\x3e|\n+--------------+                      v                                     |\n        |                     +-------------------------------+             |\n        | pull metrics        |      Prometheus server        |             |\n        v                     | +-----------+ +-----+ +-----+ |             |\n+----------------+            | | Retrieval | | TSDB| | HTTP| |             |\n| Jobs/ exporters|            | +-----------+ +-----+ +-----+ |             |\n+----------------+            |                               |             |\n                              +-------------------------------+             |\n                                       |                                    |\n                                       v                                    v\n                                    +------------+                     +------------------+\n                                    | Node       |                     | Prometheus UI    |\n                                    | +--------+ |                     +------------------+\n                                    | |HDD/SSD | |                          |\n                                    | +-------+| |                          |\n                                    +------------+                     +------------------+\n                                                                       |     Grafana      |\n                                                                       +------------------+\n                                                                            |\n                                                                       +------------------+\n                                                                       |    API clients   |\n                                                                       +------------------+\n"})}),"\n",(0,l.jsx)(n.p,{children:"prometheus server\u81ea\u5e26\u65f6\u5e8f\u6570\u636e\u5e93\uff0c \u901a\u8fc7\u5185\u7f6e\u7684\u91c7\u96c6\u5668\u4ece k8s \u4ee5\u53ca\u5468\u8fb9\u7ec4\u4ef6\u66b4\u9732\u7684 metrics \u63a5\u53e3\u62c9\u53d6\u6307\u6807\u6570\u636e\uff0c\u540c\u65f6\u4e5f\u8bde\u751f\u4e86\u9488\u5bf9\u5404\u79cd\u7ec4\u4ef6\u7684exporter \uff0c\u8fd9\u4e9b exporter \u901a\u8fc7\u5404\u79cd\u534f\u8bae\u91c7\u96c6\u5bf9\u5e94\u7ec4\u4ef6\u7684\u6307\u6807\uff0c\u518d\u901a\u8fc7 metrics \u63a5\u53e3\u63d0\u4f9b\u7ed9 prometheus \u91c7\u96c6\u3002prometheus \u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u80fd\u529b\u662f\u521b\u5efa\u4e86 promQL \u67e5\u8be2\u8bed\u6cd5\uff0c\u7c7b\u4f3c influxQL\uff0c\u53ef\u4ee5\u901a\u8fc7\u5404\u79cd\u5185\u7f6e\u51fd\u6570\u5bf9\u6307\u6807\u8fdb\u884c\u8ba1\u7b97\u3001\u805a\u5408\uff0c\u540c\u65f6\u8fd8\u80fd\u901a\u8fc7 promql \u914d\u7f6e\u544a\u8b66\u89c4\u5219\u3002\nprometheus \u7684 tsdb \u4e0d\u4f9d\u8d56\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u597d\u5904\u662f\u7b80\u5355\u597d\u7ef4\u62a4\u5355\u8282\u70b9\u53ef\u8fd0\u884c\uff0c\u4e0d\u597d\u7684\u662f\u672c\u5730\u5b58\u50a8\u6302\u4e86\u6570\u636e\u5c31\u4e22\u4e86\uff0c\u4e3a\u6b64 prometheus \u63d0\u4f9b\u4e86 remote_write/remote_read \u7684\u6807\u51c6\u63a5\u53e3\uff0c\u53ef\u4ee5\u628a\u6570\u636e\u5bf9\u63a5\u5230\u5916\u90e8\u5206\u5e03\u5f0f\u5b58\u50a8\u4e2d\u3002\npromql \u67e5\u8be2\u793a\u4f8b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:'## \u8ba1\u7b97\u589e\u957f\u7387\nrate(demo_api_request_duration_seconds_count[5m])\n## \u6839\u636e label \u7b5b\u9009\nnode_cpu_seconds_total{cpu!="0",mode=~"user|system"}\n## \u6839\u636e\u6570\u503c\u7b5b\u9009\nnode_filesystem_avail_bytes > 10*1024*1024\n## 90 \u5206\u4f4d\nhistogram_quantile(0.9, rate(demo_api_request_duration_seconds_bucket[5m]))\n## \u5e73\u5747\u503c\navg_over_time(go_goroutines[5m])\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u66f4\u591a\u8be6\u7ec6\u7528\u6cd5\u53ef\u53c2\u8003\u5b98\u65b9\u624b\u518c\uff1a",(0,l.jsx)(n.a,{href:"https://prometheus.io/docs/prometheus/latest/querying/basics/",children:"https://prometheus.io/docs/prometheus/latest/querying/basics/"}),"\n\u81ea\u52a8\u5199 ql \u7684 gpt \u5de5\u5177\uff1a",(0,l.jsx)(n.a,{href:"https://www.yeschat.ai/gpts-9t563RLGy4U-PromQL-Advisor",children:"https://www.yeschat.ai/gpts-9t563RLGy4U-PromQL-Advisor"})]}),"\n",(0,l.jsx)(n.h2,{id:"grafana",children:"grafana"}),"\n",(0,l.jsx)(n.p,{children:"grafana \u662f\u4e00\u4e2a\u7cbe\u4e8e\u5c55\u793a\u65f6\u5e8f\u6570\u636e\u7684\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u5177\u6709\u7075\u6d3b\u7684\u56fe\u8868\u5c55\u793a\uff0c\u4e30\u5bcc\u7684\u6570\u636e\u6e90\u652f\u6301\u7b49\u7279\u6027\u3002\u65e9\u671f\u7684 grafana \u662f\u4e00\u4e2a kibana \u7684\u5206\u652f\uff0c\u5176\u5143\u6570\u636e\u5b58\u50a8\u4f9d\u8d56 es\uff0c\u540e\u6765\u91cd\u6784\u6210\u4e00\u4e2a\u7eaf\u524d\u7aef\u7684\u9879\u76ee\uff0c\u56fe\u6807\u5c55\u793a\u80fd\u529b\u66f4\u5f3a\u6027\u80fd\u66f4\u597d\uff0c\u518d\u540e\u6765\u6709\u4e86 golang \u5199\u7684\u540e\u7aef\uff0c\u53ef\u4ee5\u628a\u5143\u6570\u636e\u5b58\u5230 sqlite\u3001mysql\u3001pgsql \u7b49db \u4e2d\uff0c\u540c\u65f6\u652f\u6301\u63d2\u4ef6\u5316\uff0c\u4f8b\u5982\u65b0\u589e\u4e00\u4e2a\u6570\u636e\u6e90\u7c7b\u578b\u53ea\u9700\u8981\u5199\u4e00\u4e2a\u63d2\u4ef6\u3002\u540c\u65f6\u6784\u5efa\u4e86\u5728\u7ebf\u4eea\u8868\u76d8\u5206\u4eab\u793e\u533a\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u5bfc\u5165\u522b\u4eba\u8bbe\u8ba1\u597d\u7684\u4eea\u8868\u76d8\u3002\u968f\u7740\u4e91\u539f\u751f\u53ca k8s \u7684\u53d1\u5c55\uff0cgrafana \u987a\u52bf\u6210\u4e3a k8s \u76d1\u63a7\u53ef\u89c6\u5316\u7684\u6700\u4f73\u642d\u6863\u3002\u4e0d\u4ec5\u5982\u6b64\uff0cgrafana \u80cc\u540e\u516c\u53f8\u7ee7\u7eed\u671d\u53ef\u89c2\u6d4b\u6027\u9886\u57df\u53d1\u529b\uff0c\u5728 metrics\u3001logs\u3001trace \u65b9\u5411\u90fd\u6709\u5bf9\u5e94\u7684\u4ea7\u54c1\u63a8\u51fa\uff0c\u4f8b\u5982\u6211\u4eec\u7528\u5230\u7684 loki \u4e5f\u662f\u51fa\u81ea GrafanaLabs \u3002"}),"\n",(0,l.jsx)(n.h2,{id:"loki",children:"Loki"}),"\n",(0,l.jsx)(n.p,{children:"Loki \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\uff0c\u5176\u529f\u80fd\u662f\u6536\u96c6\u3001\u5b58\u50a8\u548c\u67e5\u8be2\u65e5\u5fd7\u3002 Loki \u538b\u7f29\u65e5\u5fd7\u5e76\u5c06\u65e5\u5fd7\u5b58\u50a8\u5728\u5757\u4e2d\uff0c\u5e76\u5c06\u5b83\u4eec\u5b58\u50a8\u5728\u6587\u4ef6\u7cfb\u7edf\u6216 AWS S3 \u7b49\u540e\u7aef\u5b58\u50a8\u4e2d\u3002\n\u5757\uff08chunk\uff09\u662f\u4e00\u4e2a\u538b\u7f29\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u57fa\u4e8e\u65e5\u5fd7\u5377\u7684\u65e5\u5fd7\u6761\u76ee\uff0c\u56e0\u6b64\u5f53\u5757\u5927\u5c0f\u8fbe\u5230\u5176\u5927\u5c0f\u9650\u5236\u65f6\uff0c\u5b83\u4f1a\u5c06\u65e5\u5fd7\u5b58\u50a8\u5728\u53e6\u4e00\u4e2a\u5757\u4e2d\u3002\u6bcf\u5f53\u5b58\u50a8\u4e00\u4e2a\u5757\u65f6\uff0c\u5b83\u90fd\u4f1a\u4e3a\u6bcf\u4e2a\u5757\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff08index\uff09\u3002\u7d22\u5f15\u4e0d\u5305\u542b\u65e5\u5fd7\u7684\u5185\u5bb9\uff0c\u5b83\u53ea\u5305\u542b\u65f6\u95f4\u6233\u3001\u5757\u7684\u6807\u7b7e\u548c\u5757\u7684\u4f4d\u7f6e\u3002\nloki \u7279\u6027\uff1a \u6a2a\u5411\u6269\u5bb9\u3001\u591a\u79df\u6237\u3001\u65e5\u5fd7\u91c7\u96c6\u5c55\u793a\u3001\u65e5\u5fd7\u544a\u8b66"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:'+-------------------------+-------------------------------+-------------+\n|      Timestamp          |    Prometheus-style Labels    |   Content   |\n| with nanosecond precision|        key-value pairs        |   logline   |\n|        indexed          |            indexed            |  unindexed  |\n+-------------------------+-------------------------------+-------------+\n| 2019-12-11T10:01:02.123456789Z | {app="nginx", cluster="us-west1"} | GET /about |\n'})}),"\n",(0,l.jsx)(n.p,{children:"loki \u6570\u636e\u6d41\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:"+-----------------+       +-----------------+\n|    NODE 1       |       |    NODE 2       |\n| +-------------+ |       | +-------------+ |\n| | Application | |       | | Application | |\n| +-------------+ |       | +-------------+ |\n|      |          |       |      |          |\n| Write Logs      |       | Write Logs      |\n|      v          |       |      v          |\n| +-------------+ |       | +-------------+ |\n| |   Promtail  | |       | |   Promtail  | |\n| +-------------+ |       | +-------------+ |\n+--------|--------+       +--------|--------+\n         |                         |\n         +-----------+-------------+\n                     |\n        +-------------------------+\n        |          Loki           |\n        | +---------+  +---------+|\n        | |Distributor|          ||\n        | +---------+  +---------+|\n        |      |          |       |\n        |   +---------+  +---------+  +--------------+\n        |   | Ingester|  | Querier |  |Query Frontend|\n        |   +---------+  +---------+  +--------------+\n        |      |          ^              ^\n        |      v          |              |\n        |   +---------+   |              |\n        |   |  Ruler  |< -+              |\n        |   +---------+                  |\n        |                                |\n        | +------------------+ +------------------+\n        | |  Index           | |  Chunks          |\n        | | /var/lib/loki/   | | /var/lib/loki/   |\n        | | /index           | | /chunks          |\n        | +------------------+ +------------------+\n        +-------------------------------------------+\n            |                         |\n            v                         v\n+-------------------+         +------------------+\n| Email Notification|         | Visualize Logs   |\n+-------------------+         +------------------+\n                                      |\n                                 +--------+\n                                 | Grafana|\n                                 +--------+\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u6a21\u5757\u4ecb\u7ecd",children:"\u6a21\u5757\u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.p,{children:"promtail\uff1a\u8d1f\u8d23\u91c7\u96c6pod\u65e5\u5fd7\u7684 agent\uff0c\u4ee5 daemonset \u90e8\u7f72\u5728\u6bcf\u4e2a\u8282\u70b9\uff0ck8s \u4e2d\u5bbf\u4e3b\u673a\u4e0a\u4e5f\u90e8\u7f72\u6709\u72ec\u7acb\u7684 promtail \u7ec4\u4ef6\uff0c\u7528\u6765\u91c7\u96c6\u5bbf\u4e3b\u673a\u90e8\u7f72\u7684\u7ec4\u4ef6\u65e5\u5fd7\uff1b\ndistributor\uff1a\u4ee5deploy\u65b9\u5f0f\u90e8\u7f72\uff0c\u662f\u4e00\u4e2a\u65e0\u72b6\u6001\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u5904\u7406\u3001\u8fc7\u6ee4\u7531 promtail \u53d1\u9001\u8fc7\u6765\u7684\u65e5\u5fd7\u6d41\u6570\u636e\uff0c\u5e76\u5206\u53d1\u5230 ingester\uff1b\ningester\uff1a\u7528statefulset\u90e8\u7f72\uff0c\u63a5\u6536\u5230\u6765\u81eadistributor \u7684\u65e5\u5fd7\u540e\u8d1f\u8d23\u65e5\u5fd7\u6570\u636e\u7684\u5b58\u50a8\u548c\u7d22\u5f15\uff0c\u4e5f\u80fd\u5b9a\u671f\u5c06\u65e5\u5fd7\u53d1\u5f80\u5bf9\u8c61\u5b58\u50a8\u5982 s3 \u517c\u5bb9\u7684\u6301\u4e45\u6027\u5b58\u50a8\u7cfb\u7edf\uff1b\nquerier\uff1a\u7528statefulset\u90e8\u7f72\uff0c\u8d1f\u8d23\u6267\u884c logQL \u67e5\u8be2\uff0c\u4ece ingester \u4e2d\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\uff0c\u5bf9\u67e5\u8be2\u7ed3\u679c\u505a\u805a\u5408\u3001\u8fc7\u6ee4\u7b49\uff1b\nquery-frontend\uff1a\u4ee5deploy\u65b9\u5f0f\u90e8\u7f72\uff0c\u65e0\u72b6\u6001\u670d\u52a1\uff0c\u8d1f\u8d23\u63a5\u6536\u6765\u81ea\u5ba2\u6237\u7aef\uff08\u547d\u4ee4\u884c cli\u3001grafana \u7b49\uff09\u7684\u67e5\u8be2\u8bf7\u6c42\uff0c\u5c06\u5927\u67e5\u8be2\u62c6\u6210\u591a\u4e2a\u5c0f\u67e5\u8be2\uff1b"}),"\n",(0,l.jsx)(n.p,{children:"promtail.yaml\u914d\u7f6e\u793a\u4f8b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'  - job_name: mysql-server-slow-query-job\n    static_configs:\n      - targets:\n          - localhost\n        labels:\n          __path__: /data00/mysql/log3406/slow_query.log\n          component: "MySQL"\n          service: "MysqlServer"\n          type: "SlowQuery"\n          hostName: k8s-192-168-4-86\n          hostIp: 192.168.4.86\n          logLevel: INFO\n    pipeline_stages:\n      - match:\n          selector: \'{service="MysqlServer"}\'\n          stages:\n            - multiline:\n                firstline: \'^# Time:\'\n                max_lines: 128\n'})}),"\n",(0,l.jsx)(n.h3,{id:"logql-\u67e5\u8be2",children:"logQL \u67e5\u8be2"}),"\n",(0,l.jsx)(n.p,{children:"\u67e5\u8be2\u5206\u4e24\u7c7b\uff0cmetrics \u67e5\u8be2\u548c\u65e5\u5fd7\u67e5\u8be2\n\u65e5\u5fd7\u67e5\u8be2\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'logcli labels  #\u67e5\u6240\u6709 label\nlogcli labels service  # \u67e5\u6307\u5b9a label\n## \u67e5\u6307\u5b9alabel \u7684\u65e5\u5fd7\nlogcli query \'{service="k8s/backend-service"}\'\n## limit\u63a7\u5236\u67e5\u8be2\u884c\u6570\nlogcli query \'{service="k8s/backend-service"}\' -q -o raw --limit 10\n## \u652f\u6301\u6b63\u5219\u5339\u914d\u5173\u952e\u5b57\nlogcli query \'{service="k8s/backend-service"} |~ ".*WARNING.*|.*ERROR.*"\' -q -o raw\n## host label \u7b5b\u9009\u8282\u70b9\nlogcli query \'{service="k8s/backend-service",host="172.16.0.126"}\' -q -o raw\n## \u6307\u5b9a\u67e5\u8be2\u65f6\u95f4\u8303\u56f4\nlogcli query \'{service="k8s/backend-service"}\' -q  --from="2022-12-24T00:00:00Z" --to="2022-12-24T02:00:00Z"\n## -f \u7c7b\u4f3c tail -f \u5b9e\u65f6\u6eda\u52a8\u6700\u65b0\u65e5\u5fd7\nlogcli query \'{service="k8s/backend-service"} \' -q -o raw -f\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u65e5\u5fd7 Metrics \u67e5\u8be2\uff1a\nloki \u652f\u6301\u5404\u79cd\u805a\u5408\u51fd\u6570\u548c\u8fd0\u7b97\u5bf9\u65e5\u5fd7\u8fdb\u884c\u805a\u5408\uff0c\u4ece\u65e5\u5fd7\u4e2d\u5f97\u5230\u6307\u6807\u6570\u636e\uff0c\u57fa\u4e8e\u65e5\u5fd7\u7684\u544a\u8b66\u7b49\uff0c\u4f8b\u5982\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-text",children:'## 10\u5206\u949f\u5185ERROR\u65e5\u5fd7\u8fc7\u591a\ncount_over_time({host=~"xxxx"}|~"error"[10m]) > 100\n\n## \u65e5\u5fd7\u9519\u8bef\u7387\u8d85\u8fc7 1%\nsum(rate({service="xxx"} |= "error" [1m])) by (job) / sum(rate({service="xxx"}[1m])) by (service) > 0.01\n'})}),"\n",(0,l.jsxs)(n.p,{children:["metrics \u67e5\u8be2\u51fd\u6570\u53ef\u53c2\u8003\uff1a ",(0,l.jsx)(n.a,{href:"https://grafana.com/docs/loki/latest/query/metric_queries/",children:"https://grafana.com/docs/loki/latest/query/metric_queries/"})]}),"\n",(0,l.jsx)(n.h2,{id:"k8s\u5e38\u7528\u547d\u4ee4",children:"k8s\u5e38\u7528\u547d\u4ee4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"## json\u683c\u5f0f\u8f93\u51fa\uff0cjq \u547d\u4ee4\u89e3\u6790\u5b57\u6bb5\nkubectl get svc prom-prometheus-server -n monitoring -o json | jq -r '.spec.clusterIP') \n## \u901a\u8fc7-o \u6307\u5b9a\u8f93\u51fa\u5b57\u6bb5\nkubectl get nodes --no-headers -o custom-columns=NAME:.metadata.name\n## \u6309\u8282\u70b9\u7edf\u8ba1\u8fd0\u884c\u4e2d pod \u4e2a\u6570\nkubectl get pod -A -o wide --no-headers |awk '{print $4,$8}' |grep -v Completed |awk '{print $2}' |sort |uniq -c\n## \u76f4\u63a5\u8bf7\u6c42 apisever \u63a5\u53e3\nkubectl get --raw /api/v1/nodes/\"$nodename\"/proxy/stats/summary \n## \u6839\u636e pod label \u67e5\u8be2\u65e5\u5fd7\nkubectl -n $ns logs -l $labels\n## \u67e5\u627e\u6240\u6709\u5305\u542b\u67d0\u4e2a\u5173\u952e\u5b57\u7684 deploy\nkubectl get deploy -A --no-headers |awk '{print $1,$2}'|while read -r ns dp;do if kubectl -n $ns describe deploy $dp|grep -Eq 'hadoop-conf|hive-conf|spark-conf'; then echo $ns $dp;fi;done\n## \u67e5\u770b\u4e00\u4e2a pod \u6700\u540e\u4e00\u6b21\u6302\u6389\u7684\u65e5\u5fd7\nkubectl -n monitoring logs k8s-fronted-monitor-f76fc4c88-n29xs -p\n## \u5bb9\u5668\u5185\u65e0\u76f8\u5173\u547d\u4ee4\u65f6\uff0c\u4ece\u5bb9\u5668\u7f51\u7edc\u5185\u5f80\u5916\u53d1\u9001\u7f51\u7edc\u8bf7\u6c42\ndocker inspect 51472f1ec767 | grep Pid  # \u627e\u5230 pid\nsudo nsenter -t 208696 -n curl xxx.com  # \u4f7f\u7528 nsenter \u547d\u4ee4\u8fdb\u5165\u5bb9\u5668\u7f51\u7edc\u5e76\u6267\u884c\u672c\u5730\u547d\u4ee4\n## \u67e5\u770b events \u4e8b\u4ef6\u6d88\u606f\uff0c\u4f8b\u5982 pod \u4e00\u76f4 pending\uff0cpod \u62c9\u8d77\u5931\u8d25\u7b49\u573a\u666f\nkubectl -n k8s get events\n## \u67e5\u770b kubelet \u65e5\u5fd7\ndocker logs kubelet -f --tai 100\n## \u4f7f\u7528\u6307\u5b9a\u955c\u50cf\u8fd0\u884c\u4e34\u65f6\u5bb9\u5668\uff0c\u53ef\u8fdb\u5165\u5bb9\u5668\u67e5\u770b\u6587\u4ef6\u5185\u5bb9\u7b49\nkubectl run -it --rm --attach --image=registry.xxx.com:5000/xxx:vxxx  debugpod -- bash\n## \u67e5\u627epid\u6240\u5c5e\u7684 container\n/tmp/hlkit1000/bin/pid-container.sh 3626508\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u62d3\u5c55\u9605\u8bfb",children:"\u62d3\u5c55\u9605\u8bfb"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://kubernetes.io/zh-cn/docs/reference/kubectl/",children:"https://kubernetes.io/zh-cn/docs/reference/kubectl/"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://grafana.com/docs/loki/latest/query/log_queries/",children:"https://grafana.com/docs/loki/latest/query/log_queries/"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://docs.nginx.com/nginx-ingress-controller/overview/design/",children:"https://docs.nginx.com/nginx-ingress-controller/overview/design/"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>o});var r=s(96540);const l={},i=r.createContext(l);function c(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),r.createElement(i.Provider,{value:n},e.children)}},61559:e=>{e.exports=JSON.parse('{"permalink":"/notes/blog/2025/08/07/k8s-basic","editUrl":"https://github.com/itxx00/notes/tree/main/blog/2025-08-07-k8s-basic.md","source":"@site/blog/2025-08-07-k8s-basic.md","title":"k8s\u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","description":"k8s \u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","date":"2025-08-07T00:00:00.000Z","tags":[],"readingTime":28.59,"hasTruncateMarker":false,"authors":[{"name":"\u8001\u53f8\u673a","title":"Maintainer of this proj","url":"https://github.com/itxx00","imageURL":"https://github.com/itxx00.png","key":"itxx00","page":null}],"frontMatter":{"layout":"post","title":"k8s\u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","authors":"itxx00","description":"k8s \u57fa\u7840\u77e5\u8bc6\u603b\u7ed3","categories":["k8s"],"tags":[]},"unlisted":false,"prevItem":{"title":"minio\u8282\u70b9\u8fc1\u79fb","permalink":"/notes/blog/2025/08/15/minio-node-migration"},"nextItem":{"title":"\u5982\u4f55\u901a\u8fc7loop\u6a21\u62df\u4e00\u4e2alvm\u903b\u8f91\u5377","permalink":"/notes/blog/2023/12/25/create-loop-lvm"}}')}}]);