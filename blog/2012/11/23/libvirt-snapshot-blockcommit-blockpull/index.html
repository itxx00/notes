<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">浅析qcow2镜像文件的快照合并 | 老司机的文档集</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="浅析qcow2镜像文件的快照合并 | 老司机的文档集"><meta data-rh="true" name="description" content="show how to create snapshot with libvirt and qemu-img."><meta data-rh="true" property="og:description" content="show how to create snapshot with libvirt and qemu-img."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2012-11-23T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="libvirt,kvm,snapshot"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","url":"https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","headline":"浅析qcow2镜像文件的快照合并","name":"浅析qcow2镜像文件的快照合并","description":"show how to create snapshot with libvirt and qemu-img.","datePublished":"2012-11-23T00:00:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://itxx00.github.io/notes/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/notes/blog/rss.xml" title="老司机的文档集 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes/blog/atom.xml" title="老司机的文档集 Atom Feed"><link rel="stylesheet" href="/notes/assets/css/styles.885bf891.css">
<script src="/notes/assets/js/runtime~main.e8a3663a.js" defer="defer"></script>
<script src="/notes/assets/js/main.8b1fdf72.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><div class="navbar__logo"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">老司机</b></a><a class="navbar__item navbar__link" href="/notes/docs/intro">教程</a><a class="navbar__item navbar__link" href="/notes/blog/archive/">历史博文</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/itxx00/notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/07/k8s-basic">k8s基础知识总结</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/12/25/create-loop-lvm">如何通过loop模拟一个lvm逻辑卷</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/02/02/non-root-systemd">普通用户执行systemctl启停服务禁用密码认证</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/12/28/influxdb-ql-use-case">influxQL常用语句整理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/11/08/static-build-jq-fio">mac上使用docker交叉静态编译jq和fio</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">浅析qcow2镜像文件的快照合并</h1><div class="container_mt6G margin-vert--md"><time datetime="2012-11-23T00:00:00.000Z">2012年11月23日</time> · <!-- -->阅读需 13 分钟</div></header><div id="__blog-post-container" class="markdown"><blockquote>
<p>这是一篇关于snapshots, blockpull, blockcommit的的介绍.作者和with Eric Blake, Jeff Cody,Kevin Wolf以及很多IRC和mailing lists里面的同学大量讨论以及作者大量的特向测试的基础之上总结出来的</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础知识">基础知识<a href="#基础知识" class="hash-link" aria-label="基础知识的直接链接" title="基础知识的直接链接">​</a></h2>
<p>一个虚拟机快照可被看作是虚拟机的在某个指定时间的视图（包括他的操作系统和所有的程序）.据此，某可以还原到一个之前的完整的状态，或者在guest运行的时候做个备份.所以，在我们继续深入之前我们必须搞懂两个名词：backing files和overlays .</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="qcow2-backing-files-与-overlays">QCOW2 backing files 与 overlays<a href="#qcow2-backing-files-与-overlays" class="hash-link" aria-label="QCOW2 backing files 与 overlays的直接链接" title="QCOW2 backing files 与 overlays的直接链接">​</a></h3>
<p>qcow2（qemu copy-on-write）具有创建一个base-image，以及在base-image（即backing file）的基础上创建多个copy-on-write overlays镜像的能力.backing files和overlays十分有用，可以迅速的创建瘦装备虚拟机的实例，特别是在开发测试的时候可以让你迅速的回滚到之前的某个已知状态，丢弃overlay.</p>
<p>Figure-1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.--------------.    .-------------.    .-------------.    .-------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|              |    |             |    |             |    |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase     |&lt;---| Overlay-1   |&lt;---| Overlay-1A  &lt;--- | Overlay-1B  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| (raw/qcow2)  |    | (qcow2)     |    | (qcow2)     |    | (qcow2)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;--------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;</span><br></span></code></pre></div></div>
<p>上图表明rootbase是overlay-1的backing file，以此类推.</p>
<p>Figure-2</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.-----------.   .-----------.   .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |   |           |   |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase  |&lt;--- Overlay-1 |&lt;--- Overlay-1A &lt;--- Overlay-1B &lt;--- Overlay-1C |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |   |           |   |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;-----------&#x27;   &#x27;-----------&#x27;   &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ^    ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |       .-----------.    .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |       |           |    |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    &#x27;-------| Overlay-2 |&lt;---| Overlay-2A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            |           |    | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            .-----------.    .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            |           |    |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;------------| Overlay-3 |&lt;---| Overlay-3A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |           |    | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>上图表明我们可以只用单个backing file来创建多条链.</p>
<p>注意 : backing file 总是 只读 打开的. 换言之, 一旦新快照被创建，他的后端文件就不能被修改,(快照依赖于后端文件的这种状态).了解更多参见后面的(&#x27;blockcommit&#x27; 节) .</p>
<p>示例 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[FedoraBase.img] ----- &lt;- [Fed-guest-1.qcow2] &lt;- [Fed-w-updates.qcow2] &lt;- [Fedora-guest-with-updates-1A]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  \--- &lt;- [Fed-guest-2.qcow2] &lt;- [Fed-w-updates.qcow2] &lt;- [Fedora-guest-with-updates-2A]</span><br></span></code></pre></div></div>
<p>（注意箭头的方向，Fed-w-updates.qcow2 的backing file是 Fed-guest-1.qcow2）</p>
<p>上面的示例中可以看到 FedoraBase.img 安装了一个fedora17系统，并作为我们的backing file.现在这个backing file将作为模板快速的创建两个瘦装备实例，和 Figure-2 道理是一样的.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="具体操作">具体操作<a href="#具体操作" class="hash-link" aria-label="具体操作的直接链接" title="具体操作的直接链接">​</a></h2>
<p>使用qemu-img为单个backing file来创建两个fedora的瘦装备克隆:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /export/vmimages/Fedora-guest-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /export/vmimages/Fedora-guest-2.qcow2</span><br></span></code></pre></div></div>
<p>现在，上面创建出来的两个镜像 Fedora-guest-1 &amp; Fedora-guest-2 都可以用来启动一个虚拟机，继续我们的示例，现在我们需要创建一个f17的实例，但是这次我们需要创建的是具有完整的更新的实例，这时可以创建另外一个overlay（Fedora-guest-with-updates-1A）而这个overlay的backing file是&#x27;Fed-w-updates.qcow2&#x27;（一个包含了完整更新的镜像）:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/Fed-w-updates.qcow2 -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre></div></div>
<p>我们可以使用qemu-img命令来查看镜像的信息，包括虚拟磁盘大小，使用大小，backing file指向:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre></div></div>
<p>注意: 最新版本的qemu-img可以递归查询到整条完整的链:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info --backing-chain /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre></div></div>
<p>名词解释Snapshot:</p>
<ul>
<li>内置快照（Internal Snapshots） -- 单个qcow2镜像文件存储了包括数据以及快照的状态信息，</li>
</ul>
<p>内置快照又可以细分一下:-</p>
<ul>
<li>
<p>内置磁盘快照（Internal disk snapshot）:</p>
</li>
<li>
<p>快照点的磁盘状态，数据和快照保存在单个qcow2文件中，虚拟机运行状态和关闭状态都可以创建.</p>
</li>
</ul>
<p>Libvirt 使用 &#x27;qemu-img&#x27; 命令创建关机状态的磁盘快照.Libvirt 使用 &#x27;savevm&#x27; 命令创建运行状态的磁盘快照.</p>
<ul>
<li>内置系统还原点（Internal system checkpoint）:</li>
</ul>
<p>内存状态，设备状态和磁盘状态，可以为运行中的虚拟机创建，所有信息都存储在同一个qcow2文件中，只有在运行状态才能创建内置系统还原点.</p>
<p>Libvirt 使用&#x27;savevm&#x27; 命令来创建这种快照</p>
<ul>
<li>外置快照（External Snapshots） -- 当一个快照被创建时，创建时当前的状态保存在当前使用的磁盘文件中，即成为一个backing file.此时一个新的overlay被创建出来保存往后的数据.</li>
</ul>
<p>这个也可以细分一下:-</p>
<ul>
<li>外置磁盘快照（External disk snapshot）: 磁盘的快照被保存在一个文件中，创建时间点以后的数据被记录到一个新的qcow2文件中.同样可以在运行和关闭状态创建.</li>
</ul>
<p>Libvirt 使用 &#x27;transaction&#x27; 命令来为运行状态创建这种快照.
Libvirt 使用&#x27;qemu-img&#x27; 命令为关闭状态创建这种快照(截止目前功能还在开发中).</p>
<ul>
<li>外置系统还原点（External system checkpoint）:</li>
</ul>
<p>虚拟机的磁盘状态将被保存到一个文件中，内存和设备的状态将被保存到另外一个新的文件中，</p>
<p>（这个功能也还在开发中）.</p>
<p>VM状态（VM state）:</p>
<p>保存运行状态虚拟机的内存设备状态信息至文件，可以通过此文件恢复到保存时的状态，有点类似系统的休眠.（注意创建VM状态保存的时候VM磁盘必须是未发生写入改动的）</p>
<p>Libvirt使用 &#x27;migrate&#x27; (to file)命令来完成VM状态转储.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建快照">创建快照<a href="#创建快照" class="hash-link" aria-label="创建快照的直接链接" title="创建快照的直接链接">​</a></h2>
<p>每  次产生一个外置snapshot，一个 /new/ overlay 镜像就会随之生成，而前一个镜像就变成了一个快照.</p>
<p>diskonly内置快照创建</p>
<p>假如需要为名为&#x27;f17vm1&#x27;的虚拟机创建一个运行态或关闭态的内置快照snap1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-create-as f17vm1  snap1 snap1-desc</span><br></span></code></pre></div></div>
<p>列出快照列表，使用<em>qemu-img</em>查看info</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-list f17vm1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info /home/kashyap/vmimages/f17vm1.qcow2</span><br></span></code></pre></div></div>
<p>disk-only外置快照创建 :</p>
<p>查看虚拟机磁盘列表</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh domblklist f17-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target     Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda        /export/vmimages/f17-base.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>创建外置disk-only磁盘快照（VM<em>运行态</em>）:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-create-as --domain f17-base snap1 snap1-desc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--disk-only --diskspec vda,snapshot=external,file=/export/vmimages/sn1-of-f17-base.qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--atomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain snapshot snap1 created</span><br></span></code></pre></div></div>
<ul>
<li>一旦上面的命令被执行，则原来的镜像f17-base将变为backing file，一个新的镜像被创建.</li>
</ul>
<p>现在再列表查看虚拟机磁盘，你会发现新产生的镜像已经投入使用.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh domblklist f17-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target     Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda        /export/vmimages/sn1-of-f17-base.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>快照回滚</p>
<p>截止写此文之时，回滚至&#x27;内置快照&#x27;(system checkpoint或disk-only)是可以使用的.</p>
<p>虚拟机f17vm1回滚至快照&#x27;snap1&#x27;</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-revert --domain f17vm1 snap1</span><br></span></code></pre></div></div>
<p>使用 snapshot-revert 回滚 &#x27;外置磁盘快照&#x27; 稍微复杂些，需要涉及到稍微复杂点的问题，需要考虑的是合并&#x27;base&#x27;至&#x27;top&#x27;还是合并&#x27;top&#x27;至&#x27;base&#x27;.也就是说，有两种方式可以选择，外置磁盘快照链的缩短可以使用 blockpull 或 blockcommit .截止目前上游社区仍然在努力完善这项功能.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="合并快照文件">合并快照文件<a href="#合并快照文件" class="hash-link" aria-label="合并快照文件的直接链接" title="合并快照文件的直接链接">​</a></h2>
<p>外置快照非常有用，但这里有一个问题就是如何合并快照文件来缩短链的长度，如上所述这  里</p>
<p>有两种方式:</p>
<ul>
<li>blockcommit: 从 top 合并数据到 base (即合并overlays至backing files).</li>
<li>blockpull: 将backing file数据合并至overlay中.从 base 到 top .</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockcommit">blockcommit<a href="#blockcommit" class="hash-link" aria-label="blockcommit的直接链接" title="blockcommit的直接链接">​</a></h3>
<p>blockcommit可以让你将&#x27;top&#x27;镜像(在同一条backing file链中)合并至底层的&#x27;base&#x27;镜像.一旦 blockcommit 执行完成，处于最上面的overlay链关系将被指向到底层的overlay或base.这在创建了很长一条链之后用来缩短链长度的时候十分有用.</p>
<p>下面来个图说明下:</p>
<p>我们现在有一个镜像叫&#x27;RootBase&#x27;，拥有4个外置快照，&#x27;Active&#x27;为当前VM写入数据的，</p>
<p>使用&#x27;blockcommit&#x27;可以有以下多种case :</p>
<p>合并Snap-1, Snap-2 and Snap-3 至 &#x27;RootBase&#x27;
只合并Snap-1 and Snap-2 至 RootBase
只合并Snap-1 至 RootBase
合并Snap-2 至 Snap-1
合并Snap-3 至 Snap-2
合并Snap-2 和 Snap-3 至 Snap-1
注: 合并&#x27;Active&#x27;层(最顶部的overlay)至backing_files的功能还在开发中.</p>
<p>(下图解释case (6))</p>
<p>Figure-3</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 /                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                /                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               /  commit data       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              /                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             /                      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v           commit data  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------. &lt;--------------------&#x27;           .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |                                  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    |&lt;---------------------------------|  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |       Backing File               | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;                                  &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>举个例子，有以下场景：</p>
<p>当前: <code>[base] &lt;- sn1 &lt;- sn2 &lt;- sn3 &lt;- sn4(this is active)</code></p>
<p>目标: <code>[base] &lt;- sn1 &lt;- sn4 (如此来丢弃sn2,sn3)</code></p>
<p>下面有两种方式，method-a更快,method-b 慢些，但是sn2有效可用. (VM运行态).</p>
<p>(method-a):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           # virsh blockcommit --domain f17 vda --base /export/vmimages/sn1.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               --top /export/vmimages/sn3.qcow2 --wait --verbose</span><br></span></code></pre></div></div>
<p>[OR]
(method-b):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockcommit --domain f17 vda  --base /export/vmimages/sn2.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --top /export/vmimages/sn3.qcow2 --wait --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockcommit --domain f17 vda  --base /export/vmimages/sn1.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --top /export/vmimages/sn2.qcow2 --wait --verbose</span><br></span></code></pre></div></div>
<p>注: 如果手工执行<em>qemu-img</em>命令完成的话, 现在还只能用method-b.
Figure-4</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  /                  |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 /                   |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /                    |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   commit data /         commit data |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              /                      |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             /                       | commit data |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v                        |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.------------.&lt;----------------------|-------------&#x27;            .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |&lt;----------------------&#x27;                          |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   |                                                  |  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |&lt;-------------------------------------------------| (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;                  Backing File                    &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>上图演示了case1的blockcommit走向，现在sn4的backing file指向rootbase.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockpull">blockpull<a href="#blockpull" class="hash-link" aria-label="blockpull的直接链接" title="blockpull的直接链接">​</a></h3>
<p>blockpull（qemu中也称作&#x27;block stream&#x27;）可以将backing合并至active，与blockcommit正好相反.截止目前只能将backing file合并至当前使用的active中，也就是说还不支持指定top的合并.
设想一个下面的场景:</p>
<p>Figure-5</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |              \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                 \ stream data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 | stream data      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         | stream data     |                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                    v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .------------.      |                 &#x27;---------------&gt;  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |            |      &#x27;---------------------------------&gt;  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | RootBase   |                                           |  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |            | &lt;---------------------------------------- | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &#x27;------------&#x27;                 Backing File              &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>使用blockpull我们可以将snap-1/2/3中的数据合并至active层，最终rootbase将变成active的直接后端.</p>
<p>命令如下:</p>
<p>假设快照已经使用 创建Snapshots 小节中的方式完成:</p>
<p>如<em>Figure-5</em>中描述的-- <code>[RootBase] &lt;- [Active]</code>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockpull --domain RootBase  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --path /var/lib/libvirt/images/active.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --base /var/lib/libvirt/images/RootBase.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --wait --verbose</span><br></span></code></pre></div></div>
<p>后续的工作是我们需要使用virsh来清理掉不用的快照</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-3 --metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-2 --metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-1 --metadata</span><br></span></code></pre></div></div>
<p>Figure-6</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                    \  stream data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              | stream data         \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  | stream data  |                       \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |  stream data     |              &#x27;------------------&gt;     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |                                    .--------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  &#x27;---------------------------------&gt;  |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                                                       |  Snap-4      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;----------------------------------------------------&gt;  | (Active)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                              &#x27;--------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                &#x27;Standalone&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                (w/o backing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                file)</span><br></span></code></pre></div></div>
<p>上图表示的是将所有backing file全部合并至active</p>
<p>如下执行命令:</p>
<p>(1) 在我们执行合并 <em>之前</em> 查看一下快照的大小(注意观察&#x27;Active&#x27;):
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/RootBase.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        608M -rw-r--r--. 1 qemu qemu 1.0G Oct 11 17:54 /var/lib/libvirt/images/RootBase.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/*Snap*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2.9M -rw-------. 1 qemu qemu 3.0M Oct 11 18:10 /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre></div></div>
<p>(2) 单独检查下 &#x27;Active&#x27; 所指向的backing file ::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # qemu-img info /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file format: qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual size: 1.0G (1073741824 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk size: 2.9M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_size: 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backing file: /var/lib/libvirt/images/Snap-3.qcow2</span><br></span></code></pre></div></div>
<p>(3) 开始 <strong>blockpull</strong> 操作.
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # virsh blockpull --domain ptest2-base --path /var/lib/libvirt/images/Active.qcow2 --wait --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Block Pull: [100 %]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pull complete</span><br></span></code></pre></div></div>
<p>(4) 再检查下快照大小， &#x27;Active&#x27;变得很大
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/*Snap*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        1011M -rw-------. 1 qemu qemu 3.0M Oct 11 18:29 /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre></div></div>
<p>(5) 检查&#x27;Active&#x27;信息，现在它已经不需要backing file了，正如<em>Figure-6</em>所示::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # qemu-img info /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file format: qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual size: 1.0G (1073741824 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk size: 1.0G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_size: 65536</span><br></span></code></pre></div></div>
<p>(6) 清理现场
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # virsh snapshot-delete --domain RootBase Snap-3 --metadata</span><br></span></code></pre></div></div>
<p>(7) 现在还可以使用下 guestfish  <strong>READ-ONLY</strong>  模式来检查下磁盘内容( <em>--ro</em> 选项)
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # guestfish --ro -i -a /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre></div></div>
<p>快照删除 (and &#x27;offline commit&#x27;)</p>
<p>删除（live/offline）状态的<em>内置快照</em>很方便 ::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain f17vm --snapshotname snap6</span><br></span></code></pre></div></div>
<p>[OR]</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete f17vm snap6</span><br></span></code></pre></div></div>
<p>libvirt现在还没有删除外置快照的功能，但是可以使用<em>qemu-img</em>命令来完成.</p>
<p>比如我们有这样一条链(VM<em>offline</em>状态): <code>base &lt;- sn1 &lt;- sn2 &lt;- sn3</code></p>
<p>现在删除第二个快照(sn2).有两种方式:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">* Method (1): base &lt;- sn1 &lt;- sn3 (by copying sn2 into sn1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Method (2): base &lt;- sn1 &lt;- sn3 (by copying sn2 into sn3)</span><br></span></code></pre></div></div>
<p>Method (1)</p>
<p>(by copying sn2 into sn1)</p>
<p>注意: 必须保证sn1没有被其他快照作为后端,不然就挂了!!</p>
<p>offline commit</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img commit sn2.qcow2</span><br></span></code></pre></div></div>
<p>将会<em>commit</em>所有在sn2中的改动到sn2的backing file(sn1).
qemu-img commit和virsh blockcommit类似
现在把sn3的后端指向到sn1.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img rebase -u -b sn1.qcow2 sn3.qcow2</span><br></span></code></pre></div></div>
<p>注意: -u代表&#x27;Unsafe mode&#x27; -- 此模式下仅仅修改了指向到的backing file名字，必须谨慎操作.
现在可以直接删除sn2</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rm sn2.qcow2</span><br></span></code></pre></div></div>
<p>Method (2)</p>
<p>(by copying sn2 into sn3)</p>
<p>合并数据，rebase后端:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img rebase -b sn1.qcow2 sn3.qcow2</span><br></span></code></pre></div></div>
<p>未使用-u模式的rebase将把数据也一并合并过去，即sn2的数据写入到sn3.
换言之: 这里使用的&#x27;Safe mode&#x27;,也是默认模式 --对sn3而言任何从
qemu-img rebase(没有-u)和和virsh blockpull类似.
backingfile（sn1）到旧的backingfile（sn2）之间发生的差异改动都将被合并到sn3中.</p>
<p>现在可以删除sn2了</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rm sn2.qcow2</span><br></span></code></pre></div></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/kvm">kvm</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/snapshot">snapshot</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/itxx00/notes/tree/main/blog/2012-11-23-libvirt-snapshot-blockcommit-blockpull.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/blog/2013/03/01/libvirt-tc-bandwidth-control"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">使用libvirt和tc实现vm带宽控制</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/blog/2012/11/12/msf-study-note"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">metasploit学习笔记</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#基础知识" class="table-of-contents__link toc-highlight">基础知识</a><ul><li><a href="#qcow2-backing-files-与-overlays" class="table-of-contents__link toc-highlight">QCOW2 backing files 与 overlays</a></li></ul></li><li><a href="#具体操作" class="table-of-contents__link toc-highlight">具体操作</a></li><li><a href="#创建快照" class="table-of-contents__link toc-highlight">创建快照</a></li><li><a href="#合并快照文件" class="table-of-contents__link toc-highlight">合并快照文件</a><ul><li><a href="#blockcommit" class="table-of-contents__link toc-highlight">blockcommit</a></li><li><a href="#blockpull" class="table-of-contents__link toc-highlight">blockpull</a></li></ul></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 老司机.</div></div></div></footer></div>
</body>
</html>