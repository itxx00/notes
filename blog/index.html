<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Blog | 老司机的文档集</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://itxx00.github.io/notes/blog"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 老司机的文档集"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://itxx00.github.io/notes/blog"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://itxx00.github.io/notes/blog","mainEntityOfPage":"https://itxx00.github.io/notes/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2025/08/07/k8s-basic","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2025/08/07/k8s-basic","url":"https://itxx00.github.io/notes/blog/2025/08/07/k8s-basic","headline":"k8s基础知识总结","name":"k8s基础知识总结","description":"k8s 基础知识总结","datePublished":"2025-08-07T00:00:00.000Z","author":{"@type":"Person","name":"老司机","description":"Maintainer of this proj","url":"https://github.com/itxx00","image":"https://github.com/itxx00.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2023/12/25/create-loop-lvm","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2023/12/25/create-loop-lvm","url":"https://itxx00.github.io/notes/blog/2023/12/25/create-loop-lvm","headline":"如何通过loop模拟一个lvm逻辑卷","name":"如何通过loop模拟一个lvm逻辑卷","description":"年纪大了记性不好","datePublished":"2023-12-25T00:00:00.000Z","author":{"@type":"Person","name":"老司机","description":"Maintainer of this proj","url":"https://github.com/itxx00","image":"https://github.com/itxx00.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2023/02/02/non-root-systemd","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2023/02/02/non-root-systemd","url":"https://itxx00.github.io/notes/blog/2023/02/02/non-root-systemd","headline":"普通用户执行systemctl启停服务禁用密码认证","name":"普通用户执行systemctl启停服务禁用密码认证","description":"年纪大了记性不好","datePublished":"2023-02-02T00:00:00.000Z","author":{"@type":"Person","name":"老司机","description":"Maintainer of this proj","url":"https://github.com/itxx00","image":"https://github.com/itxx00.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2022/12/28/influxdb-ql-use-case","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2022/12/28/influxdb-ql-use-case","url":"https://itxx00.github.io/notes/blog/2022/12/28/influxdb-ql-use-case","headline":"influxQL常用语句整理","name":"influxQL常用语句整理","description":"年纪大了记性不好","datePublished":"2022-12-28T00:00:00.000Z","author":{"@type":"Person","name":"老司机","description":"Maintainer of this proj","url":"https://github.com/itxx00","image":"https://github.com/itxx00.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2022/11/08/static-build-jq-fio","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2022/11/08/static-build-jq-fio","url":"https://itxx00.github.io/notes/blog/2022/11/08/static-build-jq-fio","headline":"mac上使用docker交叉静态编译jq和fio","name":"mac上使用docker交叉静态编译jq和fio","description":"描述","datePublished":"2022-11-08T00:00:00.000Z","author":{"@type":"Person","name":"老司机","description":"Maintainer of this proj","url":"https://github.com/itxx00","image":"https://github.com/itxx00.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2022/04/20/pre-commit-basic","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2022/04/20/pre-commit-basic","url":"https://itxx00.github.io/notes/blog/2022/04/20/pre-commit-basic","headline":"pre-commit basic usage","name":"pre-commit basic usage","description":"描述","datePublished":"2022-04-20T00:00:00.000Z","author":{"@type":"Person","name":"老司机","description":"Maintainer of this proj","url":"https://github.com/itxx00","image":"https://github.com/itxx00.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2022/04/20/pxe-cobbler-install","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2022/04/20/pxe-cobbler-install","url":"https://itxx00.github.io/notes/blog/2022/04/20/pxe-cobbler-install","headline":"使用cobbler批量安装centos系统","name":"使用cobbler批量安装centos系统","description":"描述","datePublished":"2022-04-20T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2021/12/16/cvm-kylin-v10-iso-install","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2021/12/16/cvm-kylin-v10-iso-install","url":"https://itxx00.github.io/notes/blog/2021/12/16/cvm-kylin-v10-iso-install","headline":"CVM使用ISO镜像安装银河麒麟v10 arm系统","name":"CVM使用ISO镜像安装银河麒麟v10 arm系统","description":"背景：云上没有kylin的arm镜像,需要自己做一个","datePublished":"2021-12-16T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm","url":"https://itxx00.github.io/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm","headline":"银河麒麟v10 aarch64机器构建percona-xtrabackup-80 rpm包","name":"银河麒麟v10 aarch64机器构建percona-xtrabackup-80 rpm包","description":"如何自己构建aarch64 xtrabackup rpm","datePublished":"2021-07-21T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80","url":"https://itxx00.github.io/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80","headline":"UOS arm64机器build percona-xtrabackup-80 deb包","name":"UOS arm64机器build percona-xtrabackup-80 deb包","description":"uos如何快速构建xtrabackup deb","datePublished":"2021-07-21T00:00:00.000Z","author":[],"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/notes/blog/rss.xml" title="老司机的文档集 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes/blog/atom.xml" title="老司机的文档集 Atom Feed"><link rel="stylesheet" href="/notes/assets/css/styles.885bf891.css">
<script src="/notes/assets/js/runtime~main.625c9e29.js" defer="defer"></script>
<script src="/notes/assets/js/main.8b1fdf72.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><div class="navbar__logo"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">老司机</b></a><a class="navbar__item navbar__link" href="/notes/docs/intro">教程</a><a class="navbar__item navbar__link" href="/notes/blog/archive/">历史博文</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/itxx00/notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/07/k8s-basic">k8s基础知识总结</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/12/25/create-loop-lvm">如何通过loop模拟一个lvm逻辑卷</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/02/02/non-root-systemd">普通用户执行systemctl启停服务禁用密码认证</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/12/28/influxdb-ql-use-case">influxQL常用语句整理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/11/08/static-build-jq-fio">mac上使用docker交叉静态编译jq和fio</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2025/08/07/k8s-basic">k8s基础知识总结</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-08-07T00:00:00.000Z">2025年8月7日</time> · <!-- -->阅读需 29 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/itxx00.png" alt="老司机"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">老司机</span></a></div><small class="authorTitle_nd0D" title="Maintainer of this proj">Maintainer of this proj</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>k8s 基础知识整理。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-模块架构">Kubernetes 模块架构<a href="#kubernetes-模块架构" class="hash-link" aria-label="Kubernetes 模块架构的直接链接" title="Kubernetes 模块架构的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                     Kubernetes Cluster              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +------------------+      +--------------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |   Master Node    |      |    Worker Node(s)   |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |                  |      |                     |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |      |  +---------------+  |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | API Server |&lt;---------&gt;| Kubelet         | |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |      |  +---------------+  |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |                  |      |                     |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |      |  +---------------+  |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | Controller |  |      |  |  Container     | |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | Manager    |  |      |  |  Runtime       | |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |      |  +---------------+  |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |                  |      |                     |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |      +--------------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | Scheduler  |  |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |                  |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | etcd       |  |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +------------+  |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +------------------+                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +------------------+                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | Add-ons          |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  - DNS           |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  - Dashboard     |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  - Network Plugin|                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +------------------+                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------------------------------+</span><br></span></code></pre></div></div>
<p>Master Node：负责集群的管理和控制，包含 API Server、Controller Manager、Scheduler 和 etcd（分布式键值存储）。
Worker Node：负责运行容器化应用，包含 Kubelet（节点代理）、容器运行时（如 containerd、Docker）等。
Add-ons：集群附加组件，如 DNS 服务、Dashboard、网络插件等。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-组件">Kubernetes 组件<a href="#kubernetes-组件" class="hash-link" aria-label="Kubernetes 组件的直接链接" title="Kubernetes 组件的直接链接">​</a></h2>
<ul>
<li>API Server：负责提供 Kubernetes API 服务，包括创建、更新、删除、查询等操作。</li>
<li>Controller Manager：负责管理控制器，包括节点控制器、副本控制器、服务控制器等。</li>
<li>Scheduler：负责调度 Pod 到合适的节点上。</li>
<li>Kubelet：负责管理节点上的容器化应用，包括启动、停止、重启等操作。</li>
<li>Container Runtime：负责管理容器，包括启动、停止、重启等操作。</li>
<li>etcd：分布式键值存储，用于存储 Kubernetes 集群的状态信息。</li>
<li>Add-ons：集群附加组件，如 DNS 服务、Dashboard、网络插件等。</li>
<li>Kube-proxy：负责实现 Kubernetes 服务发现和负载均衡，将服务请求路由到正确的 Pod。</li>
<li>CNI（Container Network Interface）：负责为容器提供网络功能，如创建网络命名空间、配置 IP 地址、路由表等。</li>
<li>Kube-dns：负责为 Kubernetes 集群中的服务提供 DNS 解析服务。</li>
<li>Ingress Controller：负责处理外部流量进入集群的流量路由和负载均衡。</li>
<li>Dashboard：提供 Web 界面，用于可视化管理和监控 Kubernetes 集群。</li>
<li>Logging and Monitoring：负责收集和分析容器的日志，提供监控和报警功能。</li>
<li>Helm：用于管理 Kubernetes 应用的包管理器，类似于 Linux 系统中的 apt 或 yum。</li>
<li>Prometheus：用于监控和报警，提供指标收集和查询功能。</li>
<li>Grafana：用于可视化监控数据，支持多种数据源，如 Prometheus、InfluxDB 等。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-常见资源类型">k8s 常见资源类型<a href="#k8s-常见资源类型" class="hash-link" aria-label="k8s 常见资源类型的直接链接" title="k8s 常见资源类型的直接链接">​</a></h2>
<ul>
<li>
<p>Pod
Pod也叫容器组，是Kubernetes中最小的可部署单元，它是一个或多个相关容器的组合。Pod中的容器共享网络和存储资源，并在同一主机上运行。Pod由Kubernetes调度器分配给节点，并使用Linux命名空间和cgroups来隔离容器。</p>
</li>
<li>
<p>Deployment
Deployment用于管理无状态Pod的创建和更新。它通过控制器模式（ReplicaSet）来确保指定数量的Pod副本在集群中运行。当需要进行扩展、回滚或更新时，Deployment会创建新的Pod，并逐步替换旧的Pod。</p>
</li>
<li>
<p>Service
Service提供了一种稳定的网络访问方式，用于暴露Pod或一组Pod的网络服务。Service通过标签选择器（Label Selector）将请求路由到后端Pod。它使用Kubernetes的服务发现机制，通过集群内部的DNS或负载均衡器将请求转发到正确的Pod。</p>
</li>
<li>
<p>Ingress
Ingress是一种规则集合，用于将外部请求路由到集群内部的Service。它充当了集群外部和集群内部之间的入口点。Ingress控制  器根据Ingress规则将请求转发到相应的Service，并处理负载均衡、SSL终止和路径匹配等功能。</p>
</li>
<li>
<p>ConfigMap
ConfigMap用于存储应用程序的配置数据，如环境变量、配置文件等。它将配置数据存储为键值对，并将其注入到Pod的容器中。容器可以通过环境变量或挂载文件的方式访问ConfigMap中的配置数据。</p>
</li>
<li>
<p>Secret
Secret用于存储敏感数据，如密码、令牌等。读取Secret时默认以Base64编码的形式从 etcd 中取出，并可以被Pod中的容器使用。Secret可以用于安全地传递敏感信息，如数据库密码或API密钥，需要注意的是 k8s 并不默认提供对 secrets 的加密，需要自己实现密钥管理服务（Key Management Service，KMS）。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod-创建过程">pod 创建过程<a href="#pod-创建过程" class="hash-link" aria-label="pod 创建过程的直接链接" title="pod 创建过程的直接链接">​</a></h2>
<p>创建 pod 的流程大致如下：</p>
<ol>
<li>当执行 kubectl create deploy 时，k8s 执行的流程如下：</li>
<li>kubectl 执行客户端校验，资源类型、镜像名称等</li>
<li>Kubectl 读取.kube/config获取认证信息，kube-apiserver 地址</li>
<li>kubectl 生成请求内容并往 apiserver 发送创建请求</li>
<li>kube-apiserver 通过认证和鉴权后将信息存储至 etcd</li>
<li>kube-controller-manager监听到 deploy create events，检查相关资源是否已经存在</li>
<li>Deployment controller 创建 ReplicaSets，replicaset controller 创建 pods，存入 etcd，pod 进入 pending 状态</li>
<li>kube-scheduler监听到 pod 未分配节点，开始选择合适的节点，发送 POST 请求给 apiserver</li>
<li>kube-apiserver 将 pod 状态标记为 scheduled</li>
<li>kubelet 轮询 kube-apiserver 获取 pod 信息，开始创建 cgroup，创建数据目录，调用 CRI （container runtime interface）创建 container</li>
<li>创建 pause 容器，kubelet 通过 CNI（container network interface）创建网络</li>
<li>kubelet 从镜像仓库拉取pod 的镜像，通过 CRI 插件创建 container
以上仅是对关键步骤的简要描述，实际情况要复杂得多。</li>
</ol>
<p>docker、containerd、runc 是什么关系？
containerd、runc 由 docker 拆分出来，runc 是一个标准的OCI runtime实现，containerd 支持多种OCI runtime 实现，对应 runc 的支持提供了 containerd-shim-runc-v2,一个容器的创建具体过程如下：</p>
<!-- -->
<p>k8s v1.19版本，kubelet 使用 docker-shim与 dockerd 通信，k8s自 v1.20版本开始建议使用 containerd-shim，1.24 版本彻底废弃 docker-shim。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="canal">Canal<a href="#canal" class="hash-link" aria-label="Canal的直接链接" title="Canal的直接链接">​</a></h2>
<p>Canal 是一个 CNI 网络插件，它很好地结合了 Flannel 和 Calico 的优点。它让你轻松地将 Calico 和 Flannel 网络部署为统一的网络解决方案，将 Calico 的网络策略执行与 Calico（未封装）和 Flannel（封装）丰富的网络连接选项结合起来。
Canal 是 Rancher 默认的 CNI 网络插件，并采用了 Flannel 和 VXLAN 封装。
CNI（容器网络接口）是一个云原生计算基金会项目，它包含了一些规范和库，用于编写在 Linux 容器中配置网络接口的一系列插件。CNI 只关注容器的网络连接，并在容器被删除时移除所分配的资源。
Kubernetes 使用 CNI 作为网络提供商和 Kubernetes Pod 网络之间的接口。
Canal 架构
Flannel 是为 Kubernetes 配置 L3 网络结构的简单方法。Flannel 在每台主机上运行一个名为 flanneld 的二进制 Agent，该 Agent 负责从更大的预配置地址空间中为每台主机分配子网租约。Flannel 通过 Kubernetes API 或直接使用 etcd 来存储网络配置、分配的子网、以及其他辅助数据（例如主机的公共 IP）。数据包使用某种后端机制来 转发，默认封装为 VXLAN。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                         Master Node                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +-----------+     +-----------+       +----------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | Kubelet   | --&gt; | Scheduler |       | Controller     |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +-----------+     +-----------+       | Manager        |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           \            |               +----------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            \           |                      |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             \          |                      |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|              \         |                      v             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               \        +-----------------&gt; API Server &lt;-----+ &lt;-- kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                \                       /     ^       ^      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                 \                     /      |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                  \                   /       |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   \                 /        |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    \               /         |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                     v             v          |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    etcd &lt;---------+          |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                      ^                       |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                      |                       |       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   Proxy &lt;--------------------+       |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                      |                               |      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                        Worker Nodes                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +-----------+     +-----------+       +----------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | Kubelet   | --&gt; | Proxy     |       | Flannel        |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +-----------+     +-----------+       +----------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |                |                     |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       v                |                     |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Docker             &lt;----------------------+              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |                          10.0.0.0/8 (Flannel 网络)  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       v                                                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    PODs --------------------------------------------&gt; PODs  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------+</span><br></span></code></pre></div></div>
<p>说明：</p>
<ul>
<li>Master Node 负责集群管理，包括 Kubelet、Scheduler、Controller Manager、API Server、etcd 和 Proxy。</li>
<li>Worker Nodes 运行应用容器，包含 Kubelet、Proxy、Docker 和 POD。</li>
<li>Flannel 负责跨节点网络通信，使用 10.0.0.0/8 网段。</li>
<li>kubectl 通过 API Server 与集群交互。</li>
<li>流量（traffic）在 Proxy 之间传递。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod网络通信">pod网络通信<a href="#pod网络通信" class="hash-link" aria-label="pod网络通信的直接链接" title="pod网络通信的直接链接">​</a></h2>
<p>pod 是如何与外部通信的？</p>
<p>CNI 插件为每个节点分配一个/24网段，例如10.42.0.0/24 10.42.1.0/24，每个 pod 分配一个该节点持有网段的 ip 地址；每个 pod 内有一个 eth0 虚拟网卡，同时宿主机中有与其配对的另外一个虚拟网卡，二者同属一个 network namespace，这种成对出现的网卡叫veth pair，两者可以相互通信，就好比有一根网线一头连接你的电脑网卡，另一头连接交换机。以下面 pod 举例说明：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s get pod -owide | grep 192.168.4.88</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-xxx-648c86cd45-qbhj9      1/1     Running   0          43d       10.42.4.15     192.168.4.88</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$</span><br></span></code></pre></div></div>
<p>节点上查看 pod 对应的 container 如下，与这个 pod 有关的 container 有两个，一个是业务进程本身，一个是/pause进程,查看 pod 内的网卡如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s exec k8s-xxx-648c86cd45-qbhj9 -- ip a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: eth0@if52: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue state UP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether be:67:6a:d4:65:98 brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 10.42.4.15/32 brd 10.42.4.15 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span></code></pre></div></div>
<p>宿主机上的peer veth 如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$ ip l | grep ^52:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">52: cali18e95c70453@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default</span><br></span></code></pre></div></div>
<p>可以看到 pod 中的网卡名，他有固定的命名规则，带了对端网卡的 index 编号 52，在宿主机上查看 index 编号为 52 的网卡名为cali18e95c70453， pod 的网络包收发都会经过宿主机上的cali18e95c70453网卡，可以抓包验证一下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$ kubectl -n k8s exec -it k8s-xxx-648c86cd45-qbhj9 -- curl xxx.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;hr&gt;&lt;center&gt;TLB&lt;/center&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-88 ~]$ sudo tcpdump -nnpA -i cali18e95c70453 tcp dst port 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listening on cali18e95c70453, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15:59:43.723438 IP 10.42.4.15.49848 &gt; 122.14.236.25.80: Flags [S], seq 2904204625, win 28200, options [mss 1410,sackOK,TS val 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E...&lt;.M@.@..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*..z.......P...Q.......n(t.........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..U........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15:59:43.750376 IP 10.42.4.15.49848 &gt; 122.14.236.25.80: Flags [.], ack 3650196656, win 221, options [nop,nop,TS val 3808777527</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E..4.N@.@...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*..z.......P...R.......t.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..U7{...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15:59:43.750434 IP 10.42.4.15.49848 &gt; 122.14.236.25.80: Flags [P.], seq 0:77, ack 1, win 221, options [nop,nop,TS val 380877752</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E....O@.@...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*..z.......P...R.......t.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..U7{...GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: xxx.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User-Agent: curl/8.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: */*</span><br></span></code></pre></div></div>
<p>pod 与 pod 之间是如何通信的呢？首先宿主机的路由表如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default via 192.168.4.1 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.0.0/24 via 10.42.0.0 dev flannel.1 onlink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.1.0/24 via 10.42.1.0 dev flannel.1 onlink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.2.0/24 via 10.42.2.0 dev flannel.1 onlink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.3.0/24 via 10.42.3.0 dev flannel.1 onlink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.5.0/24 via 10.42.5.0 dev flannel.1 onlink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.4.15 dev cali18e95c70453 scope link </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">169.254.0.0/16 dev eth0 scope link metric 1002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.0/24 dev eth0 proto kernel scope link src 192.168.4.88</span><br></span></code></pre></div></div>
<p>可以看到和其他宿主机的 pod  ip 段是通过flannel.1网卡发送，再看一下邻居表：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">10.42.2.0 dev flannel.1 lladdr 62:6d:e7:6f:f3:e9 PERMANENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.1.0 dev flannel.1 lladdr 9a:b6:27:23:b2:21 PERMANENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.0.0 dev flannel.1 lladdr a6:eb:6d:4e:48:3a PERMANENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.3.0 dev flannel.1 lladdr 16:8e:4f:5c:1e:63 PERMANENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.42.5.0 dev flannel.1 lladdr 0a:14:55:b6:2e:97 PERMANENT</span><br></span></code></pre></div></div>
<p>由此可知当发送往其他节点pod的数据包到达flannel.1网卡时，每个网段都对应有一条目标 mac 地址，而这些 mac 地址就是每个宿主机节点上 flannel.1网卡的 mac。
另外需要注意的是上面 pod 的 container 中有一个启动了/pause进程的 container，又叫 infra container 基础容器，他的镜像由 kubelet 指定：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubelet --infra-container-image=k8s.gcr.io/pause:3.2</span><br></span></code></pre></div></div>
<p>Infra container的作用是实现 pod 内多个容器之间的存储、网络等资源的共享，单独一个 pause 容器的好处是他里面没有任何业务逻辑不容易挂掉，使得 namespace 共享更加稳定。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kube-proxy">kube-proxy<a href="#kube-proxy" class="hash-link" aria-label="kube-proxy的直接链接" title="kube-proxy的直接链接">​</a></h2>
<p>简介
来自 k8s 官网对 kube-proxy 的定义：Kubernetes 网络代理在每个节点上运行。网络代理反映了每个节点上 Kubernetes API 中定义的服务，并且可以执行简单的 TCP、UDP 和 SCTP 流转发，或者在一组后端进行 循环 TCP、UDP 和 SCTP 转发。 当前可通过 Docker-links-compatible 环境变量找到服务集群 IP 和端口， 这些环境变量指定了服务代理打开的端口。 有一个可选的插件，可以为这些集群 IP 提供集群 DNS。 用户必须使用 apiserver API 创建服务才能配置代理。
简言之， kube-proxy 的作用是承载 k8s svc的流量转发，将请求往 svc ip<!-- -->:port<!-- -->的流量转发到 podip<!-- -->:port<!-- -->上，同时还提供负载均衡与健康检查机制。</p>
<p>部署架构:</p>
<!-- -->
<p>linux 系统中的kube-proxy 支持多种代理模式，userspace、iptables 和 ipvs，userspace 模式属于早期实现的方案，因为性能原因已经逐渐弃用，iptables 模式通过 iptables 实现数据包转发，但不具备负载均衡能力且规模上去之后 iptables   规则太多也会引发性能问题，目前 k8s 中使用的是 ipvs 模式，可以通过启动参数看到：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ ps aux|grep kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s  80898  0.0  0.0 112816   988 pts/1    S+   23:17   0:00 grep --color=auto kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root     196678  0.2  0.0 750776 31484 ?        Ssl  Jun18  191:02 kube-proxy --feature-gates=TTLAfterFinished=true --proxy-mode=ipvs --cluster-cidr=10.42.0.0/16 --xy.yaml --healthz-bind-address=127.0.0.1 --v=2</span><br></span></code></pre></div></div>
<p>ipvs 是 linux kernel 中的模块，具备负载均衡能力的同时还能获得不错的转发性能。ipvs 模块来自于 lvs 项目，lvs 项目诞生于 1998 年，ipvs 模块最新版本为 v1.2 发布于 2004 年，距今已经稳定运行20 年。值得一提的是 lvs 项目的创立者章文嵩博士，他的贡献使得  ipvs 成为了负载均衡领域的重要技术，对互联网基础设施的发展产生了积极深远的影响。</p>
<p>数据流向:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+---------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|             Node                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +----------+  +------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  Client  |  | kube-proxy |---+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +----------+  +------------+   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           \           /         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            \         /          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        +----------------+       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        |   clusterIP    |       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        | (Virtual Server)|      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        +----------------+       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------------+  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      -           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          +-----------------------+-----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |           -           |                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+  +----------------+  +-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Backend Pod 1  |  | Backend Pod 2  |  | Backend Pod 3   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| (Real Server)  |  | (Real Server)  |  | (Real Server)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+  +----------------+  +-----------------+</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="svc实现机制">svc实现机制<a href="#svc实现机制" class="hash-link" aria-label="svc实现机制的直接链接" title="svc实现机制的直接链接">​</a></h2>
<p>在 k8s 中，有以下几种类型的 Service：</p>
<ol>
<li>ClusterIP：ClusterIP 是默认的 Service 类型，它为 Service 分配一个 Cluster IP 地址，并在集群内部提供负载均衡。当请求发送到 ClusterIP 地址时，k8s 的内部负载均衡机制将流量转发到后端 Pod。</li>
<li>NodePort：NodePort 类型的 Service 具有 ClusterIP 的所有功能，并且还会在每个节点上打开一个静态端口，将流量转发到 Service。当请求发送到任何节点的 NodePort 端口时，k8s 会将流量转发到相应的 Service。</li>
<li>LoadBalancer：LoadBalancer 类型的 Service 通过云服务提供商的负载均衡器（如 AWS ELB、GCP GCLB）来公开 Service。负载均衡器会将流量转发到后端 Pod。</li>
<li>ExternalName：ExternalName 类型的 Service 允许将 Service 映射到集群外部的任意 DNS 名称。它不提供负载均衡功能，只是通过 CNAME 记录将 Service 名称解析为外部 DNS 名称。</li>
<li>Headless Service：无头服务，是 k8s 中的一种特殊类型的 Service，它与其他类型的 Service（如 ClusterIP、NodePort、LoadBalancer）有所不同。Headless Service 不会为 Service 分配 Cluster IP，而是通过 DNS 记录直接暴露后端 Pod 的网络地址。
ClusterIP svc的请求转发过程：
有 svc 如下:</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get svc backend-service -owide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)      AGE    SELECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend-service   ClusterIP  10.43.199.15   &lt;none&gt;        18888/TCP   44d    app=backend-service</span><br></span></code></pre></div></div>
<p>该 svc 的 clusterip 为 10.43.199.15，外部端口和内部端口一样为 18888，对应的后端 pod 的 app label 是 backend-service。10.43.199.15是一个虚拟机 IP（VIP），kube-proxy 会把这个 ip 绑定在每个节点上，</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ run &#x27;ip -o a |grep 10.43.199.15&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.87    43: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.91    33: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.90    15: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.88    23: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.89    33: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.4.86    15: kube-ipvs0    inet 10.43.199.15/32 scope global kube-ipvs0\       valid_lft forever preferred_lft forever</span><br></span></code></pre></div></div>
<p>接着 kube-proxy 会通过 apiserver 找到 label app=backend-service的后端服务 endpoints，是 pod 的内网 ip+端口，</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get pod -o wide -l app=backend-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend-service-555d6684b5-9kwc7    1/1     Running   0          31d   10.42.3.171  192.168.4.90   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend-service-555d6684b5-s7n9n    1/1     Running   0          31d   10.42.0.134  192.168.4.91   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ kubectl -n k8s get ep backend-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             ENDPOINTS                        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend-service   10.42.0.134:18888,10.42.3.171:18888   44d</span><br></span></code></pre></div></div>
<p>接着，kube-proxy 通过创建 ipvs 规则，将发往 VIP的流量转发到后端 realserver,</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ sudo ipvsadm -Ln|grep -A2 10.43.199.15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TCP  10.43.199.15:18888 rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt; 10.42.0.134:18888  Masq    1    0    0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt; 10.42.3.171:18888  Masq    1    0    0</span><br></span></code></pre></div></div>
<p>自此，整个链路就打通了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ingress">ingress<a href="#ingress" class="hash-link" aria-label="ingress的直接链接" title="ingress的直接链接">​</a></h2>
<p>ingress 正如其字面意思，是 k8s 对外的流量入口，除了支持 http 流量外也支持 tcp、udp 流量转发。
ingress-nginx 是其中一种controller实现，除了 nginx 的实现以外还有其他很多 ingress controller实现例如haproxy、apisix、kong等，k8s 中使用的是nginx-ingress-controller。</p>
<p>数据流向:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------+          +-----------------------+          +-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Kubernetes Cluster SVC |&lt;---------|  Ingress Controller   |&lt;---------|  Load Balancer          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------+          +-----------------------+          +-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ^                                ^     |                              ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |                                |     | leader                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |                                |     |                              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          | expose business service        |     |                              | access FQDN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |                                |     |                              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+          +------------------------+          +-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| business logic POD    |          | Kubernetes NodePort SVC|          | Client                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------+          +------------------------+          +-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       | access business svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           +------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           | control plane (green dashed lines) |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           +------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           | data plane (red solid lines)       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           +------------------------------------+</span><br></span></code></pre></div></div>
<p>Additional notes:</p>
<ul>
<li>The Ingress Controller gets endpoints &amp; generates config file from Kubernetes Cluster SVC.</li>
<li>The Ingress Controller exposes ingress service to Kubernetes NodePort SVC.</li>
<li>The Load Balancer accesses the Kubernetes NodePort SVC.</li>
<li>The Client accesses the Load Balancer via FQDN.</li>
<li>The Load Balancer accesses the business service via Kubernetes NodePort SVC.</li>
<li>The business logic POD is exposed by the Kubernetes Cluster SVC.</li>
</ul>
<p>数据平面：
客户端发送 http 请求至 LB，LB 转发流量至ingress-nginx NodePort svc，由nginx-ingress-controller pod 中的 nginx 进程接收这些流量，nginx 进程充当反向代理的角色，默认情况下nginx 是直接转发至各业务 svc 对应的 endpoints，而非svc 本身，这样做的好处是流量绕过 kube-proxy 流程，缩短链路。这一行为可通过nginx.ingress.kubernetes.io/service-upstream注解控制。
控制平面：
nginx-ingress-controller pod 中除了 nginx进程以外还有负责控制面的 nginx-ingress-controller 进程，</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> [k8s@k8s-192-168-4-86 ~]$ kubectl -n ingress-nginx exec -it nginx-ingress-controller-68c566495-hj457 -- ps aux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PID   USER      TIME  COMMAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1     www-data  0:00  /usr/bin/dumb-init -- /nginx-ingress-controller --default-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7     www-data  4h40  /nginx-ingress-controller --default-backend-service=ingres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">50    www-data  0:13  nginx: master process /usr/local/nginx/sbin/nginx -c /etc/ng</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">38549 www-data  0:41  nginx: worker process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">38550 www-data  0:39  nginx: worker process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">38583 www-data  0:38  nginx: worker process</span><br></span></code></pre></div></div>
<p>当 pod 拉起时通过注册并 lock ingress-controller-leader-nginx configmap 选主，只有一个 Pod 能够成功创建 ConfigMap，成为主节点。其他 Pod 会检测到 ConfigMap 已经存在，并成为从节点。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ kubectl -n ingress-nginx get cm ingress-controller-leader-nginx -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    control-plane.alpha.kubernetes.io/leader: &#x27;{&quot;holderIdentity&quot;:&quot;nginx-ingress-controller-7p6wd&quot;,&quot;leaseDurationSeconds&quot;:30,&quot;acquireTime&quot;:&quot;2024-07-31T12:31:56Z&quot;,&quot;renewTime&quot;:&quot;2024-07-31T13:44:30Z&quot;,&quot;leaderTransitions&quot;:4}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: &quot;2024-06-18T01:23:07Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">managedFields:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: v1</span><br></span></code></pre></div></div>
<p>主节点负责监听 k8s API Server 中的 Ingress 资源，并根据配置规则进行流量转发。从节点会复制主节点的配置，并等待主节点不可用时接管流量转发任务。如果主节点发生故障重启等，超过 30 秒从节点就会检测到主节点不可用，并开始竞选新的主节点。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例">使用示例<a href="#使用示例" class="hash-link" aria-label="使用示例的直接链接" title="使用示例的直接链接">​</a></h3>
<p>以下 demo 演示如何创建 ingress以及对应的 svc、endpoint 资源，并对外提供访问：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> laosiji</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6666</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Endpoints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> laosiji</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subsets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">addresses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ip</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.4.86</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6666</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> laosiji</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> siji.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> laosiji</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6666</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="coredns">Coredns<a href="#coredns" class="hash-link" aria-label="Coredns的直接链接" title="Coredns的直接链接">​</a></h2>
<p>coredns 是k8s 生态中原生服务发现的实现方案，插件化设计，一个功能对应一个插件，高度灵活可扩展，支持自定义插件开发。coredns 可以为 svc、sts、pod 等提供域名解析。</p>
<p>解析流程:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------+     +----------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                      Kubernetes node A                      |     |             Kubernetes node B          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                             |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +----------------------+                                   |     |  +----------------------+              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |       Pod foo        |                                   |     |  |      node&#x27;s          |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |                      |                                   |     |  |    resolv.conf       |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |  +----------------------+              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  |  Application   |  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |          |           |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | Initiates DNS lookup |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |          v           |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | DNS resolver   |  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |          |           |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | Uses the DNS server  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | specified in         |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |          v           |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |            Points to              |     |  +----------------+                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  |  resolv.conf   |  | ---------------------------------&gt;|----&gt;|  |   CoreDNS      |                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |  +----------------+                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |          |           |                                   |     |      |           |                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | If not in cache,     |                                   |     |      | Forwards  |                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | retrieves DNS servers|                                   |     |      v           v                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  | from                 |                                   |     |  +----------------+  +----------------+|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |          v           |                                   |     |  | node&#x27;s resolv.conf|  |K8s API  |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |  +----------------+  |(Svcs/Endpoints) |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  | nodelocaldns   |  |                                   |     |                     +----------------+ |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  |  +----------------+  |                                   |     |                                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  +----------------------+                                   |     +----------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------+</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="记录规则">记录规则<a href="#记录规则" class="hash-link" aria-label="记录规则的直接链接" title="记录规则的直接链接">​</a></h3>
<p>svc记录规则：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;svc-name&gt;.&lt;namespace-name&gt;.svc.&lt;cluster-domain&gt;</span><br></span></code></pre></div></div>
<p>statefulset记录规则：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace-name&gt;.svc.&lt;cluster-domain&gt;</span><br></span></code></pre></div></div>
<p>配置示例:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">53 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic"># 监听地址和端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors                        </span><span class="token comment" style="color:#999988;font-style:italic"># 启用错误日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    health </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">                      </span><span class="token comment" style="color:#999988;font-style:italic"># 健康检查配置,提供Liveness探针地址http://:8080/health</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lameduck 5s                 </span><span class="token comment" style="color:#999988;font-style:italic"># 在关闭前的等待时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ready                         </span><span class="token comment" style="color:#999988;font-style:italic"># 启用就绪检查</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hosts /etc/add_hosts </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 使用指定的hosts文件进行解析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#1.2.3.1   kubenode1        # hosts文件中的解析规则，将kubenode1解析为1.2.3.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fallthrough                 </span><span class="token comment" style="color:#999988;font-style:italic"># 如果没有匹配到hosts文件中的解析规则，继续向下解析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes cluster.local in</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">addr.arpa ip6.arpa </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Kubernetes相关配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods insecure               </span><span class="token comment" style="color:#999988;font-style:italic"># 允许通过域名解析Pods的IP地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fallthrough in</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">addr.arpa ip6.arpa                </span><span class="token comment" style="color:#999988;font-style:italic"># 如果没有匹配到Kubernetes相关的解析规则，继续向下解析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus </span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9153</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic"># 启用Prometheus指标收集，监听地址和端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bufsize 4096                  </span><span class="token comment" style="color:#999988;font-style:italic">#  limits a requester’s UDP payload size to within a maximum value,must be within 512 - 4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forward . &quot;/etc/resolv.conf&quot;  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用指定的resolv.conf文件进行转发解析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache 30                      </span><span class="token comment" style="color:#999988;font-style:italic"># DNS缓存时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loop                          </span><span class="token comment" style="color:#999988;font-style:italic"># 启用循环查询</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reload                        </span><span class="token comment" style="color:#999988;font-style:italic"># 监听配置文件的变化并自动重新加载</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadbalance                   </span><span class="token comment" style="color:#999988;font-style:italic"># 启用负载均衡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>pod 中的 dns 配置受dnsPolicy策略和 hostNetwork 策略控制，当hostNetwork=true 时，使用宿主机 dns，其中dnsPolicy有以下几种：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 策略名称                | 解析行为                                                                 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------------------|-------------------------------------------------------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Default                 | Pod 使用宿主机的 DNS 配置                                                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| ClusterFirst            | 默认设置，Pod 使用 coredns 作为 nameserver，其 nameserver 来自 kubelet 的--cluster-dns=10.43.0.10参数 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| ClusterFirstWithHostNet | 即使是hostNetwork=true，也会使用 coredns                                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| None                    | 使用 Pod 的 dnsConfig 配置项                                             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">解析示例:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@backend-service-555d6684b5-9kwc7:~# cat /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nameserver 10.43.0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search k8s.svc.cluster.local svc.cluster.local cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options ndots:5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@backend-service-555d6684b5-9kwc7:~# nslookup clickhouse-service.clickhouse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server:         10.43.0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address:        10.43.0.10#53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.91</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.86</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.87</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.89</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.88</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@backend-service-555d6684b5-9kwc7:~# nslookup clickhouse-1-1-0.clickhouse-service.clickhouse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server:         10.43.0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address:        10.43.0.10#53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:   clickhouse-1-1-0.clickhouse-service.clickhouse.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address: 192.168.4.86</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-监控">k8s 监控<a href="#k8s-监控" class="hash-link" aria-label="k8s 监控的直接链接" title="k8s 监控的直接链接">​</a></h2>
<p>metrics-server
用来采集 k8s 各种监控指标，提供给kubectl top、hpa（Horizontal Pod Autoscaler）、vpa（Vertical Pod Autoscaler）、k8s-dashboard 等使用。
数据链路：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+      +----------+      +---------------+      +---------+      +--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  kubectl  |      | apiserver|      | metrics-server|      | kubelet |      | cgroup |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+      +----------+      +---------------+      +---------+      +--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      \                 ^                   ^                   ^                ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       \                |                   |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+           |                   |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| dashboard |-----------+                   |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+                               |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      \                                     |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       \                                    |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+                               |                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| scheduler |-------------------------------+                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+                                                   |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                |                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                +----------------+</span><br></span></code></pre></div></div>
<p>metrics-sever 通过采集 kubelet 提供的 metrics 接口（<a href="https://nodeip:10250" target="_blank" rel="noopener noreferrer">https://nodeip:10250</a> 的 /metrics   /metrics/cadvisor,  /metrics/probes, /metrics/resource）的数据，采集指标示例:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[k8s@k8s-192-168-4-86 ~]$ curl -s -k -H &quot;Authorization: Bearer $(kubectl -n kube-system get secrets namespace-controller-token-qwvll -ojson|jq &#x27;.data.token&#x27; -r|base64 -d)&quot; https://192.168.4.86:10250/metrics/resource|head -10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## HELP container_cpu_usage_seconds_total [ALPHA] Cumulative cpu time consumed by the container in core-seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## TYPE container_cpu_usage_seconds_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;apiserver&quot;,namespace=&quot;hive2ch&quot;,pod=&quot;hive2ch-apiserver-6fdf5df7f5-lgvgp&quot;} 2270.429353976 1722443959650</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;backend&quot;,namespace=&quot;sub&quot;,pod=&quot;subscription-backend-7cd788b876-6z74p&quot;} 7573.822327467 1722443959713</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;calico-node&quot;,namespace=&quot;kube-system&quot;,pod=&quot;canal-xrmh4&quot;} 108549.571417276 1722443963395</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;clickd&quot;,namespace=&quot;clickhouse&quot;,pod=&quot;clickd-deployment-549944fcf9-2fzzf&quot;} 65865.995640873 1722443965340</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;clickhouse-server&quot;,namespace=&quot;clickhouse&quot;,pod=&quot;clickhouse-1-1-0&quot;} 473112.908558262 1722443956984</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;consul-client&quot;,namespace=&quot;consul&quot;,pod=&quot;consul-client-3-0&quot;} 103994.031234639 1722443955027</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;controller&quot;,namespace=&quot;ingress-nginx&quot;,pod=&quot;nginx-ingress-controller-z46n4&quot;} 103172.807361637 1722443959662</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">container_cpu_usage_seconds_total{container=&quot;coredns&quot;,namespace=&quot;kube-system&quot;,pod=&quot;coredns-68c65cb45-9hxdn&quot;} 43348.132995208 1722443948530</span><br></span></code></pre></div></div>
<p>再通过 apiserver 的 Metrics API 对内提供服务。其设计的主要目的是用于 autoscaling，不建议用作指标监控。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">prometheus<a href="#prometheus" class="hash-link" aria-label="prometheus的直接链接" title="prometheus的直接链接">​</a></h3>
<p>prometheus 是第二个 CNCF 托管的项目（第一个是 k8s），为 k8s 监控量身打造，提供了包含指标采集、存储、查询以及告警等一套完整的能力。</p>
<p>整体架构:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+          +---------------------------+          +--------------+          +----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Short-lived jobs |          |      Service discovery    |          | Alertmanager |          |    pagerduty   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------+          | +-----------+ +---------+ |          +--------------+          +----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                     | | kubernetes | | file_sd| |                | notify                 | Email   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | push metrics at exit| +-----------+ +---------+ |                |------------------------| etc     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v                    +----------------------------+                |                         +--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+                      | discover targets                push alerts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Pushgateway  |----------------------|------------------------------------&gt;|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+                      v                                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                     +-------------------------------+             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | pull metrics        |      Prometheus server        |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v                     | +-----------+ +-----+ +-----+ |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+            | | Retrieval | | TSDB| | HTTP| |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Jobs/ exporters|            | +-----------+ +-----+ +-----+ |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+            |                               |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              +-------------------------------+             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       |                                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       v                                    v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    +------------+                     +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    | Node       |                     | Prometheus UI    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    | +--------+ |                     +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    | |HDD/SSD | |                          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    | +-------+| |                          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    +------------+                     +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       |     Grafana      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       |    API clients   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                       +------------------+</span><br></span></code></pre></div></div>
<p>prometheus server自带时序数据库， 通过内置的采集器从 k8s 以及周边组件暴露的 metrics 接口拉取指标数据，同时也诞生了针对各种组件的exporter ，这些 exporter 通过各种协议采集对应组件的指标，再通过 metrics 接口提供给 prometheus 采集。prometheus 的另一个重要能力是创建了 promQL 查询语法，类似 influxQL，可以通过各种内置函数对指标进行计算、聚合，同时还能通过 promql 配置告警规则。
prometheus 的 tsdb 不依赖分布式存储，好处是简单好维护单节点可运行，不好的是本地存储挂了数据就丢了，为此 prometheus 提供了 remote_write/remote_read 的标准接口，可以把数据对接到外部分布式存储中。
promql 查询示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## 计算增长率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rate(demo_api_request_duration_seconds_count[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 根据 label 筛选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node_cpu_seconds_total{cpu!=&quot;0&quot;,mode=~&quot;user|system&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 根据数值筛选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node_filesystem_avail_bytes &gt; 10*1024*1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 90 分位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">histogram_quantile(0.9, rate(demo_api_request_duration_seconds_bucket[5m]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##  平均值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">avg_over_time(go_goroutines[5m])</span><br></span></code></pre></div></div>
<p>更多详细用法可参考官方手册：<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer">https://prometheus.io/docs/prometheus/latest/querying/basics/</a>
自动写 ql 的 gpt 工具：<a href="https://www.yeschat.ai/gpts-9t563RLGy4U-PromQL-Advisor" target="_blank" rel="noopener noreferrer">https://www.yeschat.ai/gpts-9t563RLGy4U-PromQL-Advisor</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="grafana">grafana<a href="#grafana" class="hash-link" aria-label="grafana的直接链接" title="grafana的直接链接">​</a></h2>
<p>grafana 是一个精于展示时序数据的可视化工具，具有灵活的图表展示，丰富的数据源支持等特性。早期的 grafana 是一个 kibana 的分支，其元数据存储依赖 es，后来重构成一个纯前端的项目，图标展示能力更强性能更好，再后来有了 golang 写的后端，可以把元数据存到 sqlite、mysql、pgsql 等db 中，同时支持插件化，例如新增一个数据源类型只需要写一个插件。同时构建了在线仪表盘分享社区，可以方便的导入别人设计好的仪表盘。随着云原生及 k8s 的发展，grafana 顺势成为 k8s 监控可视化的最佳搭档。不仅如此，grafana 背后公司继续朝可观测性领域发力，在 metrics、logs、trace 方向都有对应的产品推出，例如我们用到的 loki 也是出自 GrafanaLabs 。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="loki">Loki<a href="#loki" class="hash-link" aria-label="Loki的直接链接" title="Loki的直接链接">​</a></h2>
<p>Loki 是一个开源的日志收集系统，其功能是收集、存储和查询日志。 Loki 压缩日志并将日志存储在块中，并将它们存储在文件系统或 AWS S3 等后端存储中。
块（chunk）是一个压缩文件，其中包含基于日志卷的日志条目，因此当块大小达到其大小限制时，它会将日志存储在另一个块中。每当存储一个块时，它都会为每个块创建一个索引（index）。索引不包含日志的内容，它只包含时间戳、块的标签和块的位置。
loki 特性： 横向扩容、多租户、日志采集展示、日志告警</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------+-------------------------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      Timestamp          |    Prometheus-style Labels    |   Content   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| with nanosecond precision|        key-value pairs        |   logline   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        indexed          |            indexed            |  unindexed  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------+-------------------------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 2019-12-11T10:01:02.123456789Z | {app=&quot;nginx&quot;, cluster=&quot;us-west1&quot;} | GET /about |</span><br></span></code></pre></div></div>
<p>loki 数据流：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+       +-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    NODE 1       |       |    NODE 2       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| +-------------+ |       | +-------------+ |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| | Application | |       | | Application | |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| +-------------+ |       | +-------------+ |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      |          |       |      |          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Write Logs      |       | Write Logs      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|      v          |       |      v          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| +-------------+ |       | +-------------+ |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| |   Promtail  | |       | |   Promtail  | |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| +-------------+ |       | +-------------+ |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------|--------+       +--------|--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +-----------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +-------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |          Loki           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | +---------+  +---------+|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | |Distributor|          ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | +---------+  +---------+|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |      |          |       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   +---------+  +---------+  +--------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   | Ingester|  | Querier |  |Query Frontend|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   +---------+  +---------+  +--------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |      |          ^              ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |      v          |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   +---------+   |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |  Ruler  |&lt; -+              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   +---------+                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | +------------------+ +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | |  Index           | |  Chunks          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | | /var/lib/loki/   | | /var/lib/loki/   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | | /index           | | /chunks          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | +------------------+ +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +-------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v                         v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+         +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Email Notification|         | Visualize Logs   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------+         +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 +--------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 | Grafana|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 +--------+</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模块介绍">模块介绍<a href="#模块介绍" class="hash-link" aria-label="模块介绍的直接链接" title="模块介绍的直接链接">​</a></h3>
<p>promtail：负责采集pod日志的 agent，以 daemonset 部署在每个节点，k8s 中宿主机上也部署有独立的 promtail 组件，用来采集宿主机部署的组件日志；
distributor：以deploy方式部署，是一个无状态组件，负责处理、过滤由 promtail 发送过来的日志流数据，并分发到 ingester；
ingester：用statefulset部署，接收到来自distributor 的日志后负责日志数据的存储和索引，也能定期将日志发往对象存储如 s3 兼容的持久性存储系统；
querier：用statefulset部署，负责执行 logQL 查询，从 ingester 中查询日志数据，对查询结果做聚合、过滤等；
query-frontend：以deploy方式部署，无状态服务，负责接收来自客户端（命令行 cli、grafana 等）的查询请求，将大查询拆成多个小查询；</p>
<p>promtail.yaml配置示例：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">__path__</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /data00/mysql/log3406/slow_query.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MySQL&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MysqlServer&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SlowQuery&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">hostName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">192</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">168</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">4</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">86</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">hostIp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.4.86</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">logLevel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> INFO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">pipeline_stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{service=&quot;MysqlServer&quot;}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">multiline</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">firstline</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;^# Time:&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">max_lines</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="logql-查询">logQL 查询<a href="#logql-查询" class="hash-link" aria-label="logQL 查询的直接链接" title="logQL 查询的直接链接">​</a></h3>
<p>查询分两类，metrics 查询和日志查询
日志查询：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">logcli labels  #查所有 label</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli labels service  # 查指定 label</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 查指定label 的日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli query &#x27;{service=&quot;k8s/backend-service&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## limit控制查询行数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli query &#x27;{service=&quot;k8s/backend-service&quot;}&#x27; -q -o raw --limit 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 支持正则匹配关键字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli query &#x27;{service=&quot;k8s/backend-service&quot;} |~ &quot;.*WARNING.*|.*ERROR.*&quot;&#x27; -q -o raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## host label 筛选节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli query &#x27;{service=&quot;k8s/backend-service&quot;,host=&quot;172.16.0.126&quot;}&#x27; -q -o raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 指定查询时间范围</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli query &#x27;{service=&quot;k8s/backend-service&quot;}&#x27; -q  --from=&quot;2022-12-24T00:00:00Z&quot; --to=&quot;2022-12-24T02:00:00Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## -f 类似 tail -f 实时滚动最新日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logcli query &#x27;{service=&quot;k8s/backend-service&quot;} &#x27; -q -o raw -f</span><br></span></code></pre></div></div>
<p>日志 Metrics 查询：
loki 支持各种聚合函数和运算对日志进行聚合，从日志中得到指标数据，基于日志的告警等，例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## 10分钟内ERROR日志过多</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">count_over_time({host=~&quot;xxxx&quot;}|~&quot;error&quot;[10m]) &gt; 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 日志错误率超过 1%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sum(rate({service=&quot;xxx&quot;} |= &quot;error&quot; [1m])) by (job) / sum(rate({service=&quot;xxx&quot;}[1m])) by (service) &gt; 0.01</span><br></span></code></pre></div></div>
<p>metrics 查询函数可参考： <a href="https://grafana.com/docs/loki/latest/query/metric_queries/" target="_blank" rel="noopener noreferrer">https://grafana.com/docs/loki/latest/query/metric_queries/</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="k8s常用命令">k8s常用命令<a href="#k8s常用命令" class="hash-link" aria-label="k8s常用命令的直接链接" title="k8s常用命令的直接链接">​</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## json格式输出，jq 命令解析字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc prom-prometheus-server -n monitoring -o json | jq -r &#x27;.spec.clusterIP&#x27;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 通过-o 指定输出字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes --no-headers -o custom-columns=NAME:.metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 按节点统计运行中 pod 个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -A -o wide --no-headers |awk &#x27;{print $4,$8}&#x27; |grep -v Completed |awk &#x27;{print $2}&#x27; |sort |uniq -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 直接请求 apisever 接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get --raw /api/v1/nodes/&quot;$nodename&quot;/proxy/stats/summary </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 根据 pod label 查询日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n $ns logs -l $labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 查找所有包含某个关键字的 deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deploy -A --no-headers |awk &#x27;{print $1,$2}&#x27;|while read -r ns dp;do if kubectl -n $ns describe deploy $dp|grep -Eq &#x27;hadoop-conf|hive-conf|spark-conf&#x27;; then echo $ns $dp;fi;done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 查看一个 pod 最后一次挂掉的日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n monitoring logs k8s-fronted-monitor-f76fc4c88-n29xs -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 容器内无相关命令时，从容器网络内往外发送网络请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker inspect 51472f1ec767 | grep Pid  # 找到 pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo nsenter -t 208696 -n curl xxx.com  # 使用 nsenter 命令进入容器网络并执行本地命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 查看 events 事件消息，例如 pod 一直 pending，pod 拉起失败等场景</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n k8s get events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 查看 kubelet 日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker logs kubelet -f --tai 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 使用指定镜像运行临时容器，可进入容器查看文件内容等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run -it --rm --attach --image=registry.xxx.com:5000/xxx:vxxx  debugpod -- bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 查找pid所属的 container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/hlkit1000/bin/pid-container.sh 3626508</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="拓展阅读">拓展阅读<a href="#拓展阅读" class="hash-link" aria-label="拓展阅读的直接链接" title="拓展阅读的直接链接">​</a></h2>
<ol>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/kubectl/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/zh-cn/docs/reference/kubectl/</a></li>
<li><a href="https://grafana.com/docs/loki/latest/query/log_queries/" target="_blank" rel="noopener noreferrer">https://grafana.com/docs/loki/latest/query/log_queries/</a></li>
<li><a href="https://docs.nginx.com/nginx-ingress-controller/overview/design/" target="_blank" rel="noopener noreferrer">https://docs.nginx.com/nginx-ingress-controller/overview/design/</a></li>
</ol></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2023/12/25/create-loop-lvm">如何通过loop模拟一个lvm逻辑卷</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-12-25T00:00:00.000Z">2023年12月25日</time> · <!-- -->阅读需 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/itxx00.png" alt="老司机"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">老司机</span></a></div><small class="authorTitle_nd0D" title="Maintainer of this proj">Maintainer of this proj</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>某些时候我们需要一个lvm逻辑卷，但是又没有多余的磁盘设备可用，这时可以通过模拟的方式创建一个设备出来，步骤如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 首先创建一个虚拟block文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dd if=/dev/zero of=pv1 bs=1M count=5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 然后通过losetup将其挂载到loop0设备上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo losetup /dev/loop0 pv1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo losetup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 这时可以对loop0设备进行操作，当做一个block设备使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo pvcreate /dev/loop0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo vgcreate vg0 /dev/loop0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo lvcreate -n lv0 -l 100%FREE vg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建好lv之后就可以继续格式化文件系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mkfs.ext4 /dev/vg0/lv0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mkdir /data01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mount /dev/vg0/lv0 /data01</span><br></span></code></pre></div></div>
<p>这样我们就完成了通过dd出一个空文件，然后通过loop设备模拟了一个lvm逻辑卷出来。
使用完之后清理：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo umount /data01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo lvremove /dev/vg0/lv0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo vgremove vg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo pvremove /dev/loop0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo losetup -d /dev/loop0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm pv1</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2023/02/02/non-root-systemd">普通用户执行systemctl启停服务禁用密码认证</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-02-02T00:00:00.000Z">2023年2月2日</time> · <!-- -->阅读需 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/itxx00.png" alt="老司机"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">老司机</span></a></div><small class="authorTitle_nd0D" title="Maintainer of this proj">Maintainer of this proj</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>在CentOS系统中默认情况下，使用普通用户管理系统服务启停会要求认证，输出类似如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authentication is required to manage system services or units.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authenticating as: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>这里的认证是systemd引入polkit认证，可以通过polkit配置文件来改变默认行为，例如和配置某个普通用户免密执行sudo一样，这里也可以配置polkit认证免密：</p>
<p>配置文件路径:/etc/polkit-1/localauthority/50-local.d/xxx.pkla</p>
<p>例如 vi /etc/polkit-1/localauthority/50-local.d/xxx.pkla</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[disable auth for admin]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Identity=unix-user:yourusername</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Action=*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ResultActive=yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ResultAny=yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ResultInactive=yes</span><br></span></code></pre></div></div>
<p>保存配置立即生效，再执行systemctl restart就不会提示认证了。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2022/12/28/influxdb-ql-use-case">influxQL常用语句整理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-28T00:00:00.000Z">2022年12月28日</time> · <!-- -->阅读需 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/itxx00.png" alt="老司机"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">老司机</span></a></div><small class="authorTitle_nd0D" title="Maintainer of this proj">Maintainer of this proj</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="db">db<a href="#db" class="hash-link" aria-label="db的直接链接" title="db的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">show databases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use db1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show retention policies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">create database db2 with duration 30d replication 2</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="retention">retention<a href="#retention" class="hash-link" aria-label="retention的直接链接" title="retention的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">alter retention policy default on db1 duration 168h default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show retention policies</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="measurements">measurements<a href="#measurements" class="hash-link" aria-label="measurements的直接链接" title="measurements的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use db1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show measurements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show measurements with measurement =~ /cpu/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tag">tag<a href="#tag" class="hash-link" aria-label="tag的直接链接" title="tag的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">show tag keys from cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show tag values from cpu with key=cputype</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="field">field<a href="#field" class="hash-link" aria-label="field的直接链接" title="field的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">show field keys from cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2022/11/08/static-build-jq-fio">mac上使用docker交叉静态编译jq和fio</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-11-08T00:00:00.000Z">2022年11月8日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/itxx00.png" alt="老司机"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">老司机</span></a></div><small class="authorTitle_nd0D" title="Maintainer of this proj">Maintainer of this proj</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="思路">思路<a href="#思路" class="hash-link" aria-label="思路的直接链接" title="思路的直接链接">​</a></h2>
<p>为了得到静态编译的jq和fio程序二进制,同时又需要x86_64和aarch64的版本,可以利用docker的buildx实现交叉编译</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="步骤">步骤<a href="#步骤" class="hash-link" aria-label="步骤的直接链接" title="步骤的直接链接">​</a></h2>
<p>编译fio</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir fio &amp;&amp; cd fio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi Dockerfile</span><br></span></code></pre></div></div>
<p>Dockerfile 如下</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu as build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /opt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG VER=fio-3.33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN if [  -e /etc/apt/sources.list ];then sed -ri &#x27;s/[a-zA-Z0-9.]+(debian.org|ubuntu.com)/mirrors.volces.com/g&#x27; /etc/apt/sources.list; fi &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export DEBIAN_FRONTEND=noninteractive &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apt-get update &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apt-get install -y git gcc make cmake libaio1 libaio-dev zlib1g zlib1g-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN git clone https://github.com/axboe/fio.git &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd fio  &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git checkout ${VER}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN cd fio  &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ./configure --build-static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN cd fio &amp;&amp; make &amp;&amp; make install  &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strip `which fio` &amp;&amp; cp `which fio` /fio-$(dpkg --print-architecture)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM scratch AS bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=build /fio-* /</span><br></span></code></pre></div></div>
<p>执行编译</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker buildx build . --platform linux/amd64 --target bin --output .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker buildx build . --platform linux/arm64 --target bin --output .</span><br></span></code></pre></div></div>
<p>编译成功会在当前目录得到可执行程序fio-amd64和fio-arm64两个文件.</p>
<p>jq编译步骤类似,dockerfile如下:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu as build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /opt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG VER=jq-1.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN if [  -e /etc/apt/sources.list ];then sed -ri &#x27;s/[a-zA-Z0-9.]+(debian.org|ubuntu.com)/mirrors.volces.com/g&#x27; /etc/apt/sources.list; fi &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export DEBIAN_FRONTEND=noninteractive &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apt-get update &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apt-get install -y build-essential libtool git gcc make cmake autotools-dev autoconf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN git clone https://github.com/stedolan/jq.git &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd jq  &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git checkout ${VER} &amp;&amp; git submodule update --init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN cd jq  &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autoreconf -fi &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ./configure --disable-maintainer-mode --disable-valgrind --with-oniguruma=builtin --enable-all-static --prefix=/usr/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN cd jq &amp;&amp; LDFLAGS=-all-static make -j4 &amp;&amp; make install  &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strip /usr/local/bin/jq &amp;&amp; cp /usr/local/bin/jq /jq-$(dpkg --print-architecture)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM scratch AS bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=build /jq-* /</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2022/04/20/pre-commit-basic">pre-commit basic usage</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-20T00:00:00.000Z">2022年4月20日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/itxx00.png" alt="老司机"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">老司机</span></a></div><small class="authorTitle_nd0D" title="Maintainer of this proj">Maintainer of this proj</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install">install<a href="#install" class="hash-link" aria-label="install的直接链接" title="install的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install pre-commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="init">init<a href="#init" class="hash-link" aria-label="init的直接链接" title="init的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://xxx/xxx.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre-commit install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre-commit sample-config &gt;.pre-commit-config.yaml</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test">test<a href="#test" class="hash-link" aria-label="test的直接链接" title="test的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pre-commit run --all-files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre-commit run --files xxx.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sample-conf">sample conf<a href="#sample-conf" class="hash-link" aria-label="sample conf的直接链接" title="sample conf的直接链接">​</a></h2>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># See https://pre-commit.com for more information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># See https://pre-commit.com/hooks.html for more hooks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">repos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/pre</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">commit/pre</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hooks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rev</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v4.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trailing</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">whitespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> end</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">of</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">fixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> check</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">added</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">large</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/talos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">systems/conform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rev</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.1.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpha.27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> commit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/5xops/mirrors</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shellcheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rev</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shellcheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude=SC2148</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">SC2155</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">SC2009</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">SC2029</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">SC1091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/psf/black</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rev</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 23.11.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> black</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">length=1000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  - repo: https://github.com/pre-commit/mirrors-mypy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    rev: v0.770</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    hooks:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#      - id: mypy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#        language: python_venv</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#        exclude: ^(docs/|example-plugin/|tests/fixtures)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/PyCQA/flake8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rev</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 6.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flake8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">exclude</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $(.tox/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">.git/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">__pycache__/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">build/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">dist/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">.cache</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">.eggs/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ignore=E501</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">W503</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">E722</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">W605</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">E203</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/PyCQA/pylint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rev</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v3.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pylint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">language</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">disable=R0801</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">C0114</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">C0115</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">C0116</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">C0209</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">C0415</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">E0401</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">W1401</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">R0912</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">R0913</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">R0914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">R0915</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">W0212</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">C0103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">max</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">line</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">length=120</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2022/04/20/pxe-cobbler-install">使用cobbler批量安装centos系统</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-20T00:00:00.000Z">2022年4月20日</time> · <!-- -->阅读需 9 分钟</div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本介绍">基本介绍：<a href="#基本介绍" class="hash-link" aria-label="基本介绍：的直接链接" title="基本介绍：的直接链接">​</a></h3>
<p>PXE（preboot execute environment）由Intel发明的通过网络快速引导操作系统的技术，其原理是在机器引导时通过server端为网卡DHCP分配IP信息，并通知client端next_server中的tftp地址，client端继续通过tftp下载系统引导镜像，加载并完成启动。这里我们还会用到另外一项技术叫kickstart，由红帽开发，早先用于其系统安装工具中以完成自动化安装，已被众多发行版支持。系统引导时可以通过kickstart配置文件中指定的安装流程自动完成后续步骤，减少人工干预。而通常手工配置dhcp、tftp、kickstart等往往比较繁琐，这里我们会利用红帽开发的另外一款工具cobbler，通过cobbler来完成整个dhcp、tftp、kickstart等组成的server端环境的快速搭建和管理，以此提高效率。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cobbler安装配置">cobbler安装配置：<a href="#cobbler安装配置" class="hash-link" aria-label="cobbler安装配置：的直接链接" title="cobbler安装配置：的直接链接">​</a></h3>
<p>我们使用CentOS7作为server端系统，为了节约现场部署时间，我们将提前准备好环境并直接带到现场使用，以下所有操作将在一台ThinkPad上完成。</p>
<p>因私有化环境无需连外网，因此在实际使用时我们为了简化部署流程，可以将selinux和防火墙禁用掉，如需要启用防火墙的话则需要放开http/dhcp/tftp等服务的对应端口：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># disable selinux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &#x27;s/^SELINUX=.*$/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># disable iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reboot</span><br></span></code></pre></div></div>
<p> 安装cobbler及相关的依赖包：cobbler提供了命令行管理工具和一个web管理工具，分别由cobbler和cobbler-web两个包提供</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum install epel-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install cobbler cobbler-web httpd dhcp tftp xinetd rsync bind</span><br></span></code></pre></div></div>
<p>配置cobbler：cobbler配置文件放置在/etc/cobbler目录，在启动之前需要server端IP，dhcp等相关信息，首先修改 /etc/cobbler/settings主配置文件，需要修改的参数有以下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 通过以下命令生成系统安装后的默认root密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl passwd -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 并将生成的密码修改到配置中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_password_crypted: “$1$RUNYOYnz$QgzdhCD2T7qXWI1IPpAih0”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># server端ip，对外提供dhcp和http服务，必须为一个固定内网ip地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server: 192.168.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># next_server为tftp服务所在ip，通常是需要和server保持一致</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">next_server: 192.168.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 打开cobbler对相关服务的自动管理功能，如配置变更和启停等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">manage_dhcp: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">manage_tftpd：1</span><br></span></code></pre></div></div>
<p> 修改依赖组件的配置：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &#x27;/disable/c\\tdisable\t\t\t= no&#x27; /etc/xinetd.d/tftp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service xinetd restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">修改dhcp网段：vi /etc/cobbler/dhcp.template</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet 192.168.1.0 netmask 255.255.255.0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     option routers             192.168.1.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     option domain-name-servers 192.168.1.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     range dynamic-bootp        192.168.1.100 192.168.1.200;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     option subnet-mask         255.255.255.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     filename                   &quot;/pxelinux.0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     default-lease-time         21600;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     max-lease-time             43200;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     next-server                $next_server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>启动服务：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start httpd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start cobblerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable httpd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable cobblerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 服务检查：cobbler提供了check命令可用于检查各项配置是否满足需要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 通常第一次会提示下载loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler get-loaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如中途修改cobbler配置后需重启cobbler服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart cobblerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如变更了dhcp、tftp等相关信息需重新同步配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 顺便配置好web管理页面的访问密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">htdigest /etc/cobbler/users.digest &quot;Cobbler&quot; cobbler</span><br></span></code></pre></div></div>
<p> 可以反复通过check命令来检查环境是否部署OK，并根据实际需求调整各项配置文件，直至check结果复合要求即可。至此cobbler的安装及配置完成。web端工具访问地址：<a href="https://192.168.1.1/cobbler_web" target="_blank" rel="noopener noreferrer">https://192.168.1.1/cobbler_web</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="系统镜像准备">系统镜像准备：<a href="#系统镜像准备" class="hash-link" aria-label="系统镜像准备：的直接链接" title="系统镜像准备：的直接链接">​</a></h3>
<p>接下来我们需要将系统镜像导入cobbler中，并自定义安装引导的kickstart配置。我们要部署到节点上的系统是CentOS7。需要注意的是如果需要通过kickstart定制一些基础软件包的安装，那么需要使用软件包更全的DVD iso，因minimal iso中提供的软件包有限。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 将iso挂载到本地目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mount -o auto CentOS-7-x86_64-DVD-1611.iso /mnt/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导入到cobbler中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler import --name=centos7 --arch=x86_64 --path=/mnt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看导入的系统及profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler distro list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler distro report --name=centos7-x86_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cobbler profile list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 卸载iso mount point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">umount /mnt/</span><br></span></code></pre></div></div>
<p> 可以看到上面的步骤中我们将CentOS7镜像导入到cobbler中，有几个核心概念需要理解：</p>
<p>distro - 及系统发行版本，不同的镜像导入后对应不同的distro，如centos7-x86_64，不同的distro对应不同的引导镜像；</p>
<p>profile - distro的配置文件，一个distro可以有多个profile，默认导入时会自动生成一个profile，不同的profile可以定义不同的kernel选项，使用不同的kickstart配置；</p>
<p>system - 各个机器所使用的profile实例，与机器MAC地址绑定，可以细化到机器级别的自定义安装，如果所有机器安装都是统一的则无需使用system配置。</p>
<p> 接下来需要理解的是cobbler中对kickstart文件的管理方式，ks文件是我们需要重点关注的中间产物，决定了系统自动化部署的执行流程和最终效果。ks文件与profile绑定，默认生成的profile会指向一个默认的ks文件，通常我们需要对其进行自定义来满足不同的部署要求。当系统通过PXE引导至profile选择菜单后，一旦选定了需要部署的系统，接下来就会按照该profile所对应的ks文件来执行一系列的安装操作。</p>
<p>在cobbler中ks文件的实例是通过cgi动态生成的，而生成ks实例所依赖的则是ks templates和snippets， cobbler通过template来将ks文件主体流程部分模板化，通过snippets来管理可以在不同ks templates中公用的流程片段。</p>
<p>我们的需求如下：</p>
<p>安装一个精简的CentOS7系统；
同时默认安装一些必要的软件包；
首次安装时只对系统盘进行分区和格式化，其他磁盘不动；
为了便于管理我们将更改网卡名为ethX，且默认禁用IPv6,；
为了方便使用虚拟机测试整个安装流程，需要在磁盘分区时自动适配磁盘名如vda/sda；
安装完成后能对一些基础配置进行初始化。       </p>
<p>首先拷贝cobbler默认的template生成一个自定义的ks template，</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># kickstart template</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># (includes %end blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># do not use with earlier distros</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#platform=x86, AMD64, or Intel EM64T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># System authorization information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth --useshadow --enablemd5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># System bootloader configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#bootloader --location=mbr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Partition clearing information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clearpart --all --initlabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Use text mode install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Firewall configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall --disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Run the Setup Agent on first boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firstboot --disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># System keyboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyboard us</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># System language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lang en_US</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Use network installation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">url --url=$tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># If any cobbler repo definitions were referenced in the kickstart profile, include them here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$yum_repo_stanza</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Network information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;network_config&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Reboot after installation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reboot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Root password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rootpw --iscrypted $default_password_crypted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># SELinux configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">selinux --disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Do not configure the X Window System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skipx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># System timezone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">timezone Asia/Shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Install OS instead of upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Clear the Master Boot Record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zerombr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Allow anaconda to partition the system as needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#autopart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;main_partition_select&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%pre</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;log_ks_pre&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;kickstart_start&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;pre_install_network_config&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;pre_partition_select_custom&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Enable installation monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;pre_anamon&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@^minimal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chrony</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python-setuptools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rsync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrzsz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">expect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ntpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-selinux-policy*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-NetworkManager*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-kexec-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-snappy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-wpa_supplicant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-ppp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%addon com_redhat_kdump --disable --reserve-mb=&#x27;auto&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%post --nochroot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;log_ks_post_nochroot&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;log_ks_post&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start yum configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$yum_config_stanza</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># End yum configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;post_install_kernel_options&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;post_install_network_config&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;download_config_files&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;cobbler_register&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Enable post-install boot notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;post_anamon&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;post_install_custom_sys&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start final steps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$SNIPPET(&#x27;kickstart_done&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># End final steps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%end</span><br></span></code></pre></div></div>
<p> 注意ks template中的红色部分为我们增加的自定义snippets，第一个pre_partition_select_custom作用是自动根据磁盘类型来生成分区和格式化选项，同时兼容虚拟机和物理机，内容如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Determine architecture-specific partitioning needs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ -b /dev/vda ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cat &gt;/tmp/partinfo &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clearpart --initlabel --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ignoredisk --only-use=vda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bootloader --location=mbr --boot-drive=vda --driveorder=vda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clearpart --initlabel --drives=vda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">part /boot --fstype=ext3 --ondisk=vda --size=500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">part / --fstype=xfs --size=1024 --grow --ondisk=vda --asprimary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elif [ -b /dev/sda ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cat &gt;/tmp/partinfo &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clearpart --initlabel --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ignoredisk --only-use=sda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bootloader --location=mbr --boot-drive=sda --driveorder=sda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">part /boot --fstype=ext3 --ondisk=sda --size=500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">part / --fstype=xfs --size=100000 --ondisk=sda --asprimary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">part /data --fstype=xfs --grow --ondisk=sda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p> 第二个post_install_custom_sys作用是在系统安装最后阶段对一些必要的配置进行更改，其中运行的是shell脚本，内容如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat snippets/post_install_custom_sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ! grep -q &#x27;custom_sysctl&#x27; /etc/sysctl.conf; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## custom_sysctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fs.file-max = 262144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.somaxconn = 10240</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm.swappiness = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.ip_local_port_range = 1024 65000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.rmem_max = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.wmem_max = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.rmem_default = 1048576</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.wmem_default = 524288</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_rmem = 4096 87380 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_wmem = 4096 65536 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.core.netdev_max_backlog = 2500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_max_syn_backlog = 40960</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_syncookies = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_tw_reuse = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_tw_recycle = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.ipv4.tcp_fin_timeout = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x /etc/rc.d/rc.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if grep -q &#x27;^UseDNS&#x27; /etc/ssh/sshd_config; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sed -i &#x27;s/^UseDNS .*/UseDNS no/&#x27; /etc/ssh/sshd_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sed -i &#x27;s/^#UseDNS .*/UseDNS no/&#x27; /etc/ssh/sshd_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p>接下来还需要修改内核引导参数，完成网卡名字的变更及IPv6禁用：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sed -i -e &#x27;s|^GRUB_CMDLINE_LINUX=\&quot;|GRUB_CMDLINE_LINUX=\&quot;net.ifnames=0 biosdevname=0 |g&#x27; /etc/default/grub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i -e &#x27;s|^GRUB_CMDLINE_LINUX=\&quot;|GRUB_CMDLINE_LINUX=\&quot;ipv6.disable=1 |g&#x27; /etc/default/grub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></span></code></pre></div></div>
<p>通过这几部分的组合，即可生成一个完整可用的ks文件，下面我将介绍如何通过虚拟机来测试安装。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用虚拟机测试pxe">使用虚拟机测试PXE<a href="#使用虚拟机测试pxe" class="hash-link" aria-label="使用虚拟机测试PXE的直接链接" title="使用虚拟机测试PXE的直接链接">​</a></h3>
<p>安装虚拟化相关软件包，使用kvm虚拟机，同时安装图形界面虚拟机管理工具virt-manager方便安装操作。网络选择使用bridge模式,点击新建虚拟机，在安装选项中选择PXE,注意内存设置必须大于1G，否则PXE引导进入系统后很可能报错。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2021/12/16/cvm-kylin-v10-iso-install">CVM使用ISO镜像安装银河麒麟v10 arm系统</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-12-16T00:00:00.000Z">2021年12月16日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown"><p>背景：云上没有kylin的arm镜像,需要自己做一个</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-准备">1 准备<a href="#1-准备" class="hash-link" aria-label="1 准备的直接链接" title="1 准备的直接链接">​</a></h2>
<p>iso: Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso</p>
<p>一台arm的cvm, 一块数据盘</p>
<p>scp  Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso  x.x.x.x:/kylin.iso</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-配置grub">2 配置grub<a href="#2-配置grub" class="hash-link" aria-label="2 配置grub的直接链接" title="2 配置grub的直接链接">​</a></h2>
<p>修改grub配置增加从iso引导的入口，重启机器时从iso引导进入安装流程</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cat /etc/grub.d/40_custom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec tail -n +3 $0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This file provides an easy way to add custom menu entries.  Simply type the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># menu entries you want to add after this comment.  Be careful not to change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># the &#x27;exec tail&#x27; line above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">menuentry &#x27;Install Kylin Linux Advanced Server V10&#x27; --class red --class gnu-linux --class gnu --class os {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set isolabel=&quot;Kylin-Server-10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set isofile=&quot;/kylin.iso&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insmod iso9660</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loopback loop $isofile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    linux (loop)/images/pxeboot/vmlinuz inst.stage2=hd:LABEL=Kylin-Server-10 ro iso-scan/filename=$isofile console=tty0 video=efifb:off video=VGA-1:640x480-32@60me</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initrd (loop)/images/pxeboot/initrd.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>上面的参数从哪获取来？
1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mount /kylin.iso /mnt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">find /mnt -name grub.cfg</span><br></span></code></pre></div></div>
<p>找到的内容作为linux行的参考</p>
<p>2</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">blkid /kylin.iso</span><br></span></code></pre></div></div>
<p>可以获得isolabel信息</p>
<p>下一步</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vi /etc/default/grub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#修改GRUB_TIMEOUT=60 增加timeout方便web vnc登录操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grub2-mkconfig --ouput=/boot/grub2/grub.cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reboot</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-开始装系统">3 开始装系统<a href="#3-开始装系统" class="hash-link" aria-label="3 开始装系统的直接链接" title="3 开始装系统的直接链接">​</a></h2>
<p>系统会安装到数据盘，因为系统盘被iso占用，mount状态无法使用，必须有独立的数据盘用来装系统
注意安装cloud-init包。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-制作云镜像">4 制作云镜像<a href="#4-制作云镜像" class="hash-link" aria-label="4 制作云镜像的直接链接" title="4 制作云镜像的直接链接">​</a></h2>
<p>重启回到原先的系统</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install qemu-img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qemu-img convert -f raw -O qcow2 /dev/vdb /kylin.qcow2</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-镜像创建cvm后启动失败问题一例">5 镜像创建CVM后启动失败问题一例<a href="#5-镜像创建cvm后启动失败问题一例" class="hash-link" aria-label="5 镜像创建CVM后启动失败问题一例的直接链接" title="5 镜像创建CVM后启动失败问题一例的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="报错信息如下">报错信息如下：<a href="#报错信息如下" class="hash-link" aria-label="报错信息如下：的直接链接" title="报错信息如下：的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/dev/disk/by-uuid/bed44859-b637-4490-b7f9-f62f952f6hfa Warning:does not exist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Generating &quot;/run/initramfs/rdsosreport.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Entering emergency mode. Exit the shell to continue.&quot;journalctl&quot; to view system logs.TypeYou might want to save &quot;/run/initramfs/rdsosreport.txt&quot; to a USB stick or /bootaftermounting them and attach it to a bug report.</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="原因分析">原因分析：<a href="#原因分析" class="hash-link" aria-label="原因分析：的直接链接" title="原因分析：的直接链接">​</a></h3>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1virtio驱动安装的不准确或者异常">1.virtio驱动安装的不准确或者异常<a href="#1virtio驱动安装的不准确或者异常" class="hash-link" aria-label="1.virtio驱动安装的不准确或者异常的直接链接" title="1.virtio驱动安装的不准确或者异常的直接链接">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2内核缺陷本身导致">2.内核缺陷本身导致<a href="#2内核缺陷本身导致" class="hash-link" aria-label="2.内核缺陷本身导致的直接链接" title="2.内核缺陷本身导致的直接链接">​</a></h5>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方法">解决方法：<a href="#解决方法" class="hash-link" aria-label="解决方法：的直接链接" title="解决方法：的直接链接">​</a></h3>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1virtio驱动的修复">1.Virtio驱动的修复<a href="#1virtio驱动的修复" class="hash-link" aria-label="1.Virtio驱动的修复的直接链接" title="1.Virtio驱动的修复的直接链接">​</a></h5>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep -i virtio /boot/config-$(uname -r)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">是否包含在临时文件系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsinitrd /boot/initramfs-$(uname -r).img | grep virtio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">修复临时文件系统</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim /etc/dracut.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_drivers+=&quot;virtio_blk virtio_scsi virtio_net virtio_pci virtio_ring virtio&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dracut -f</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2内核缺陷规避">2.内核缺陷规避<a href="#2内核缺陷规避" class="hash-link" aria-label="2.内核缺陷规避的直接链接" title="2.内核缺陷规避的直接链接">​</a></h5>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;add_drivers+=&quot;xen-netfront xen-blkfront &quot;&#x27; &gt; /etc/dracut.conf.d/xen.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KERNEL_VERSION=$(rpm -q kernel --qf &#x27;%{V}-%{R}.%{arch}\n&#x27;|head -n1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dracut -f /boot/initramfs-$KERNEL_VERSION.img $KERNEL_VERSION</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/kylin">kylin</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/cvm">cvm</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm">银河麒麟v10 aarch64机器构建percona-xtrabackup-80 rpm包</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-21T00:00:00.000Z">2021年7月21日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-环境准备">1 环境准备<a href="#1-环境准备" class="hash-link" aria-label="1 环境准备的直接链接" title="1 环境准备的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install cmake3 openssl-devel libaio libaio-devel automake autoconf bison libtool ncurses-devel \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    libgcrypt-devel libev-devel libcurl-devel zlib-devel vim-common readline-devel python-sphinx rpm-build</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-获取最新srpm包">2 获取最新SRPM包<a href="#2-获取最新srpm包" class="hash-link" aria-label="2 获取最新SRPM包的直接链接" title="2 获取最新SRPM包的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看需要下载的版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://repo.percona.com/yum/release/8/SRPMS/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#如：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://repo.percona.com/yum/release/8/SRPMS/percona-xtrabackup-80-8.0.25-17.1.generic.src.rpm</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-build-rpm">3 BUILD RPM<a href="#3-build-rpm" class="hash-link" aria-label="3 BUILD RPM的直接链接" title="3 BUILD RPM的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rpm -ivh percona-xtrabackup-80-8.0.25-17.1.generic.src.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ~/rpmbuild</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpmbuild -bb --nodebuginfo SPECS/percona-xtrabackup.spec</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="over">OVER<a href="#over" class="hash-link" aria-label="OVER的直接链接" title="OVER的直接链接">​</a></h2></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80">UOS arm64机器build percona-xtrabackup-80 deb包</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-21T00:00:00.000Z">2021年7月21日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-系统环境">1 系统环境<a href="#1-系统环境" class="hash-link" aria-label="1 系统环境的直接链接" title="1 系统环境的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@VM-0-14-linux:~# cat /etc/os-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PRETTY_NAME=&quot;uos 20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME=&quot;uos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION_ID=&quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VERSION=&quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ID=uos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HOME_URL=&quot;https://www.chinauos.com/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUG_REPORT_URL=&quot;http://bbs.chinauos.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@VM-0-14-linux:~# uname -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linux VM-0-14-linux 4.19.0-arm64-server #1635 SMP Mon Jan 13 16:07:12 CST 2020 aarch64 GNU/Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@VM-0-14-linux:~# cat /etc/debian_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@VM-0-14-linux:~#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-配置perconca官方apt源">2 配置perconca官方apt源<a href="#2-配置perconca官方apt源" class="hash-link" aria-label="2 配置perconca官方apt源的直接链接" title="2 配置perconca官方apt源的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://repo.percona.com/apt/percona-release_latest.buster_all.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i percona-release_latest.buster_all.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改脚本中两个变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi /usr/bin/percona-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CODENAME=buster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS_VER=buster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 开启perconca源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">percona-release enable-only tools release</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-build">3 BUILD<a href="#3-build" class="hash-link" aria-label="3 BUILD的直接链接" title="3 BUILD的直接链接">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apt-get build-dep percona-xtrabackup-80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 构建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apt-get source --compile percona-xtrabackup-80</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="over">OVER<a href="#over" class="hash-link" aria-label="OVER的直接链接" title="OVER的直接链接">​</a></h2></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/notes/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 老司机.</div></div></div></footer></div>
</body>
</html>