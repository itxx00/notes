<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Blog | 老司机的文档集</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://itxx00.github.io/notes/blog/page/3"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 老司机的文档集"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://itxx00.github.io/notes/blog/page/3"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/3" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/3" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://itxx00.github.io/notes/blog/page/3","mainEntityOfPage":"https://itxx00.github.io/notes/blog/page/3","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2020/03/12/centos8-bootmenu-add-windows","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2020/03/12/centos8-bootmenu-add-windows","url":"https://itxx00.github.io/notes/blog/2020/03/12/centos8-bootmenu-add-windows","headline":"CentOS8安装后grub菜单增加windows入口","name":"CentOS8安装后grub菜单增加windows入口","description":"默认安装完不会自动识别其他系统，需要手工添加","datePublished":"2020-03-12T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2020/01/03/shell-standards","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2020/01/03/shell-standards","url":"https://itxx00.github.io/notes/blog/2020/01/03/shell-standards","headline":"shell style guide","name":"shell style guide","description":"","datePublished":"2020-01-03T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2019/09/02/hive-small-file","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2019/09/02/hive-small-file","url":"https://itxx00.github.io/notes/blog/2019/09/02/hive-small-file","headline":"HIVE中常见的小文件合并方法","name":"HIVE中常见的小文件合并方法","description":"hive使用过程中应尽量避免产生小文件","datePublished":"2019-09-02T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2019/05/12/random-and-entropy-in-centos7","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2019/05/12/random-and-entropy-in-centos7","url":"https://itxx00.github.io/notes/blog/2019/05/12/random-and-entropy-in-centos7","headline":"系统中的随机数和熵值","name":"系统中的随机数和熵值","description":"简单总结一下系统中的随机数以及相关问题","datePublished":"2019-05-12T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2017/12/20/centos7-install-ansible-awx","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2017/12/20/centos7-install-ansible-awx","url":"https://itxx00.github.io/notes/blog/2017/12/20/centos7-install-ansible-awx","headline":"CentOS7系统安装ansible awx记录","name":"CentOS7系统安装ansible awx记录","description":"记录awx的安装测试过程以及需要注意的点","datePublished":"2017-12-20T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2017/10/19/bash-nohup-log-truncate","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2017/10/19/bash-nohup-log-truncate","url":"https://itxx00.github.io/notes/blog/2017/10/19/bash-nohup-log-truncate","headline":"很诡异的服务日志无法切割问题分析","name":"很诡异的服务日志无法切割问题分析","description":"遇到某服务进程产生的日志始终无法切割，原来原因在这里","datePublished":"2017-10-19T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2017/08/20/hadoop3-ec-test","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2017/08/20/hadoop3-ec-test","url":"https://itxx00.github.io/notes/blog/2017/08/20/hadoop3-ec-test","headline":"HADOOP3.0.0纠删码测试","name":"HADOOP3.0.0纠删码测试","description":"描述","datePublished":"2017-08-20T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2017/08/18/deploy-k8s-from-local-repo","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2017/08/18/deploy-k8s-from-local-repo","url":"https://itxx00.github.io/notes/blog/2017/08/18/deploy-k8s-from-local-repo","headline":"k8s测试环境部署记录","name":"k8s测试环境部署记录","description":"记录k8s在本地测试环境的部署过程","datePublished":"2017-08-18T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2017/06/13/nftables-man-page","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2017/06/13/nftables-man-page","url":"https://itxx00.github.io/notes/blog/2017/06/13/nftables-man-page","headline":"nftables：nft man文档阅读笔记","name":"nftables：nft man文档阅读笔记","description":"这里是一份nft man文档笔记","datePublished":"2017-06-13T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2017/05/31/first-post","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2017/05/31/first-post","url":"https://itxx00.github.io/notes/blog/2017/05/31/first-post","headline":"开篇","name":"开篇","description":"重新写博客","datePublished":"2017-05-31T00:00:00.000Z","author":[],"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/notes/blog/rss.xml" title="老司机的文档集 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes/blog/atom.xml" title="老司机的文档集 Atom Feed"><link rel="stylesheet" href="/notes/assets/css/styles.885bf891.css">
<script src="/notes/assets/js/runtime~main.bcca17d1.js" defer="defer"></script>
<script src="/notes/assets/js/main.873c70e9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><div class="navbar__logo"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">老司机</b></a><a class="navbar__item navbar__link" href="/notes/docs/intro">教程</a><a class="navbar__item navbar__link" href="/notes/blog/archive/">历史博文</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/itxx00/notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/15/minio-node-migration">minio节点迁移</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/14/k8s-pod-affinity">k8s pod亲和性与反亲和性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/10/k8s-probe">k8s探针参数说明</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/07/k8s-basic">k8s基础知识总结</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/12/25/create-loop-lvm">如何通过loop模拟一个lvm逻辑卷</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2020/03/12/centos8-bootmenu-add-windows">CentOS8安装后grub菜单增加windows入口</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-03-12T00:00:00.000Z">2020年3月12日</time> · <!-- -->阅读需 2 分钟</div></header><div class="markdown"><blockquote>
<p>电脑双系统centos+windows，安装完centos8之后默认没有引导windows的入口，按照下面方法手搓即可。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-启动进入centos">1 启动进入centos<a href="#1-启动进入centos" class="hash-link" aria-label="1 启动进入centos的直接链接" title="1 启动进入centos的直接链接">​</a></h2>
<p>查看磁盘分区信息，如下：
<code>fdisk -l</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># fdisk -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk /dev/sda: 238.5 GiB, 256060514304 bytes, 500118192 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Units: sectors of 1 * 512 = 512 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sector size (logical/physical): 512 bytes / 512 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disklabel type: dos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk identifier: 0x297f5cef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device     Boot     Start       End   Sectors   Size Id Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/sda1  *         2048 250058751 250056704 119.2G  7 HPFS/NTFS/exFAT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/sda2       250058752 393418751 143360000  68.4G  7 HPFS/NTFS/exFAT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/sda3       393418752 394442751   1024000   500M 83 Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/sda4       394442752 500117503 105674752  50.4G  5 Extended</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/sda5       394444800 500117503 105672704  50.4G 83 Linux</span><br></span></code></pre></div></div>
<p>通过fdisk结果看到windows第一个partion在sda1，对应grub的磁盘索引编号是hd0,1,接下来编辑grub配置文件，自定义配置路径：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> vi  /etc/grub.d/40_custom</span><br></span></code></pre></div></div>
<p>配置示例如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> #!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> exec tail -n +3 $0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # This file provides an easy way to add custom menu entries.  Simply type the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # menu entries you want to add after this comment.  Be careful not to change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # the &#x27;exec tail&#x27; line above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> menuentry &quot;Windows&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         set root=(hd0,1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         chainloader +1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span></code></pre></div></div>
<p>保存并执行以下命令使自定义配置生效：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">grub2-mkconfig --output=/boot/grub2/grub.cfg</span><br></span></code></pre></div></div>
<p>OVER.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/os">os</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/centos">centos</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/grub">grub</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/centos-8">centos8</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2020/01/03/shell-standards">shell style guide</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-01-03T00:00:00.000Z">2020年1月3日</time> · <!-- -->阅读需 21 分钟</div></header><div class="markdown"><blockquote>
<p>这里是一句长长的引言</p>
</blockquote>
<ul>
<li>Shell 编码规范</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2>
<p>与其它的编程规范一样，这里所讨论的不仅仅是编码格式美不美观的问题， 同时也讨论一些约定及编码标准。这份文档主要侧重于我们所普遍遵循的规则， 对于那些不是明确强制要求的，我们尽量避免提供意见。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么要有编码规范">为什么要有编码规范<a href="#为什么要有编码规范" class="hash-link" aria-label="为什么要有编码规范的直接链接" title="为什么要有编码规范的直接链接">​</a></h3>
<p>编码规范对于程序员而言尤为重要，有以下几个原因：</p>
<ul>
<li>一个软件的生命周期中，80%的花费在于维护</li>
<li>几乎没有任何一个软件，在其整个生命周期中，均由最初的开发人员来维护</li>
<li>编码规范可以改善软件的可读性，可以让程序员尽快而彻底地理解新的代码</li>
<li>如果你将源码作为产品发布，就需要确任它是否被很好的打包并且清晰无误，一如你已构建的其它任何产品</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="编码规范原则">编码规范原则<a href="#编码规范原则" class="hash-link" aria-label="编码规范原则的直接链接" title="编码规范原则的直接链接">​</a></h3>
<p>本文档中的准则致力于最大限度达到以下原则：</p>
<ul>
<li>正确性</li>
<li>可读性</li>
<li>可维护性</li>
<li>可调试性</li>
<li>一致性</li>
<li>美观</li>
</ul>
<p>尽管本文档涵盖了许多基础知识，但应注意的是，没有编码规范可以为我们回答所有问题，开发人员始终需要再编写完代码后，对上述原则做出正确的判断。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码规范等级定义">代码规范等级定义<a href="#代码规范等级定义" class="hash-link" aria-label="代码规范等级定义的直接链接" title="代码规范等级定义的直接链接">​</a></h3>
<ul>
<li><strong>可选（Optional）</strong>：用户可参考，自行决定是否采用；</li>
<li><strong>推荐（Preferable）</strong>：用户理应采用，但如有特殊情况，可以不采用；</li>
<li><strong>必须（Mandatory）</strong>：用户必须采用（除非是少数非常特殊的情况，才能不采用）；</li>
</ul>
<p><strong>注：</strong> 未明确指明的则默认为 <strong>必须（Mandatory）</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="本文档参考">本文档参考<a href="#本文档参考" class="hash-link" aria-label="本文档参考的直接链接" title="本文档参考的直接链接">​</a></h3>
<p>主要参考如下文档:</p>
<ul>
<li><a href="https://google.github.io/styleguide/shell.xml" target="_blank" rel="noopener noreferrer" title="Google Shell Style Guide">Google Shell Style Guide</a></li>
<li><a href="https://wiki.bash-hackers.org/scripting/style" target="_blank" rel="noopener noreferrer" title="Scripting with style">Bash Hackers Wiki</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="源文件">源文件<a href="#源文件" class="hash-link" aria-label="源文件的直接链接" title="源文件的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础">基础<a href="#基础" class="hash-link" aria-label="基础的直接链接" title="基础的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用场景">使用场景<a href="#使用场景" class="hash-link" aria-label="使用场景的直接链接" title="使用场景的直接链接">​</a></h4>
<p>仅建议Shell用作相对简单的实用工具或者包装脚本。因此单个shell脚本内容不宜太过复杂。</p>
<p>在选择何时使用shell脚本时时应遵循以下原则：</p>
<ul>
<li>如主要用于调用其他工具且需处理的数据量较少，则shell是一个选择</li>
<li>如对性能十分敏感，则更推荐选择其他语言，而非shell</li>
<li>如需处理相对复杂的数据结构，则更推荐选择其他语言，而非shell</li>
<li>如脚本内容逐渐增长且有可能出现继续增长的趋势，请尽早使用其他语言重写</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="文件名">文件名<a href="#文件名" class="hash-link" aria-label="文件名的直接链接" title="文件名的直接链接">​</a></h4>
<p>可执行文件不建议有扩展名，库文件必须使用 <strong>.sh</strong> 作为扩展名，且应是不可执行的。</p>
<p>执行一个程序时，无需知道其编写语言，且shell脚本并不要求具有扩展名，所以更倾向可执行文件没有扩展名。</p>
<p>而库文件知道其编写语言十分重要，使用 <strong>.sh</strong> 作为特  定语言后缀的扩展名，可以和其他语言编写的库文件加以区分。</p>
<p>文件名要求全部小写, 可以包含下划线 <code>_</code> 或连字符 <code>-</code>, 建议可执行文件使用连字符，库文件使用下划线。</p>
<p>正例:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my-useful-bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_useful_libraries.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myusefullibraries.sh</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">My_Useful_Bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myUsefulLibraries.sh</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="文件编码">文件编码<a href="#文件编码" class="hash-link" aria-label="文件编码的直接链接" title="文件编码的直接链接">​</a></h4>
<p>源文件编码格式为<strong>UTF-8</strong>。
避免不同操作系统对文件换行处理的方式不同，一律使用<code>LF</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="单行长度">单行长度<a href="#单行长度" class="hash-link" aria-label="单行长  度的直接链接" title="单行长度的直接链接">​</a></h4>
<p>每行最多不超过120个字符。每行代码最大长度限制的根本原因是过长的行会导致阅读障碍，使得缩进失效。</p>
<p>除了以下两种情况例外：</p>
<ul>
<li>导入模块语句</li>
<li>注释中包含的URL</li>
</ul>
<p>如出现长度必须超过120个字符的字符串，应尽量使用here document或者嵌入的换行符等合适的方法使其变短。</p>
<p>示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># DO use &#x27;here document&#x27;s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;END;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I am an exceptionally long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">END</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Embedded newlines are ok too</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long_string=&quot;I am an exceptionally</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  long string.&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="空白字符">空白字符<a href="#空白字符" class="hash-link" aria-label="空白字符的直接链接" title=" 空白字符的直接链接">​</a></h4>
<p>除了在行结束使用换行符，空格是源文件中唯一允许出现的空白字符。</p>
<ul>
<li>字符串中的非空格空白字符，使用转义字符</li>
<li>不允许行前使用tab缩进，如果使用tab缩进，必须设置1个tab为4个空格</li>
<li>不应在行尾出现没有意义的空白字符</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="垃圾清理--推荐--">垃圾清理<sup>  <em>推荐</em>  </sup><a href="#垃圾清理--推荐--" class="hash-link" aria-label="垃圾清理--推荐--的直接链接" title="垃圾清理--推荐--的直接链接">​</a></h4>
<p>对从来没有用到的或者被注释的方法、变量等要坚决从代码中清理出去，避免过多垃圾造成干扰。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="结构">结构<a href="#结构" class="hash-link" aria-label="结构的直接链接" title="结构的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用bash">使用bash<a href="#使用bash" class="hash-link" aria-label="使用bash的直接链接" title="使用bash的直接链接">​</a></h4>
<p>Bash 是唯一被允许使用的可执行脚本shell。</p>
<p>可执行文件必须以 <code>#!/bin/bash</code> 开始。请使用 <code>set</code> 来设置shell的选项，使得用 <code>bash &lt;script_name&gt;</code> 调用你的脚本时不会破坏其功能。</p>
<p>限制所有的可执行shell脚本为bash使得我们安装在所有计算机中的shell语言保持一致性。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -e</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh -e</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="许可证或版权信息--推荐--">许可证或版权信息<sup>  <em>推荐</em>  </sup><a href="#许可证或版权信息--推荐--" class="hash-link" aria-label="许可证或版权信息--推荐--的直接链接" title="许可证或版权信息--推荐--的直接链接">​</a></h4>
<p>许可证与版权信息需放在源文件的起始位置。例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Licensed under the BSD 3-Clause License (the &quot;License&quot;); you may not use this file except</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># in compliance with the License. You may obtain a copy of the License at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://opensource.org/licenses/BSD-3-Clause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Unless required by applicable law or agreed to in writing, software distributed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CONDITIONS OF ANY KIND, either express or implied. See the License for the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># specific language governing permissions and limitations under the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="缩进">缩进<a href="#缩进" class="hash-link" aria-label="缩进的直接链接" title="缩进的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="块缩进">块缩进<a href="#块缩进" class="hash-link" aria-label="块缩进的直接链接" title="块缩进的直接链接">​</a></h5>
<p>每当开始一个新的块，缩进增加4个空格（不能使用\t字符来缩进）。当块结束时，缩进返回先前的缩进级别。缩进级别适用于代码和注释。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 缩进4个空格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    say=&quot;hello&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flag=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [[ $flag = 0 ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 缩进4个空格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;$say&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="管道">管道<a href="#管道" class="hash-link" aria-label="管道的直接链接" title="管道的直接链接">​</a></h5>
<p>如果一行容不下整个管道操作，那么请将整个管道操作分割成每行一个管段。</p>
<p>如果一行容得下整个管道操作，那么请将整个管道操作写在同一行，管道左右应有空格。</p>
<p>否则，应该将整个管道操作分割成每行一段，管道操作的下一部分应该将管道符放在新行并且缩进4个空格。这适用于管道符 <code>|</code> 以及逻辑运算 <code>||</code> 和 <code>&amp;&amp;</code> 。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 单行管道连接，管道左右空格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command1 | command2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 长命令管道换行连接，管道放置于下一个命令开头，缩进4个空格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | command2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | command3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | command4</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 管道左右无空格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command1|command2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 换行连接管道放置于行末</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command1 | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command2 | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command3 | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command4</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="循环">循环<a href="#循环" class="hash-link" aria-label="循环的直接链接" title="循环的直接链接">​</a></h5>
<p>请将 <code>; do</code> , <code>; then</code> 和 <code>while</code> , <code>for</code> , <code>if</code> 放在同一行。</p>
<p>shell中的循环略有不同，但是我们遵循跟声明函数时的大括号相同的原则。即：
<code>; do</code> , <code>; then</code> 应该和 while/for/if 放在同一行。
else 应该单独一行。
结束语句应该单独一行且跟开始语句缩进对齐。</p>
<p>正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for dir in ${dirs_to_cleanup}; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [[ -d &quot;${dir}/${BACKUP_SID}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log_date &quot;Cleaning up old files in ${dir}/${BACKUP_SID}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rm &quot;${dir}/${BACKUP_SID}/&quot;*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if [[ &quot;$?&quot; -ne 0 ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            error_message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mkdir -p &quot;${dir}/${BACKUP_SID}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if [[ &quot;$?&quot; -ne 0 ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            error_message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function getBatchName()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch_name=&quot;batch&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [[ &quot;$input5&quot;x == *$batch_name* ]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_name=$input5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if [[ &quot;$input6&quot;x == *$batch_name* ]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_name=$input6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if [[ &quot;$input7&quot;x == *$batch_name* ]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_name=$input7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="case语句">case语句<a href="#case语句" class="hash-link" aria-label="case语句的直接链接" title="case语句的直接链接">​</a></h5>
<p>通过4个空格缩进可选项。
可选项中的多个命令应该被拆分成多行，模式表达式、操作和结束符 <code>;;</code> 在不同的行。
匹配表达式比 case 和 esac 缩进一级。多行操作要再缩进一级。
模式表达式前面不应该出现左括号。避免使用 <code>;&amp;</code> 和 <code>;;&amp;</code> 符号。
示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">case &quot;${expression}&quot; in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        variable=&quot;...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        some_command &quot;${variable}&quot; &quot;${other_expr}&quot; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    absolute)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actions=&quot;relative&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        another_command &quot;${actions}&quot; &quot;${other_expr}&quot; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        error &quot;Unexpected expression &#x27;${expression}&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">esac</span><br></span></code></pre></div></div>
<p>只要整个表达式可读，简单的单行命令可以跟模式和 ;; 写在同一行。当单行容不下操作时，请使用多行的写法。
单行示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">verbose=&#x27;false&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aflag=&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bflag=&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files=&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while getopts &#x27;abf:v&#x27; flag; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &quot;${flag}&quot; in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a) aflag=&#x27;true&#x27; ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b) bflag=&#x27;true&#x27; ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f) files=&quot;${OPTARG}&quot; ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v) verbose=&#x27;true&#x27; ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *) error &quot;Unexpected option ${flag}&quot; ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    esac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="函数位置">函数位置<a href="#函数位置" class="hash-link" aria-label="函数位置的直接链接" title="函数位置的直接链接">​</a></h4>
<p>将文件中所有的函数统一放在常量下面。不要在函数之间隐藏可执行代码。</p>
<p>如果你有函数，请将他们统一放在文件头部。只有includes， set 声明和常量设置可能在函数声明之前完成。不要在函数之间隐藏可执行代码。如果那样做，会使得代码在调试时难以跟踪并出现意想不到的结果。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主函数main">主函数main<a href="#主函数main" class="hash-link" aria-label="主函数main的直接链接" title="主函数main的直接链接">​</a></h4>
<p>对于包含至少了一个其他函数的足够长的脚本  ，建议定义一个名为 main 的函数。对于功能简单的短脚本， main函数是没有必要的。</p>
<p>为了方便查找程序的入口位置，将主程序放入一个名为 main 的函数中，作为最底部的函数。这使其和代码库的其余部分保持一致性，同时允许你定义更多变量为局部变量（如果主代码不是一个函数就不支持这种做法）。
文件中最后的非注释行应该是对 main 函数的调用：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">main &quot;$@&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="注释">注释<a href="#注释" class="hash-link" aria-label="注释的直接链接" title="注释的直接链接">​</a></h4>
<p>代码注释的基本原则：</p>
<ul>
<li>注释应能使代码更加明确</li>
<li>避免注释部分的过度修饰</li>
<li>保持注释部分简单、明确</li>
<li>在编码以前就应开始写注释</li>
<li>注释应说明设计思路而不是描述代码的行为</li>
</ul>
<p>注释与其周围的代码在同一缩进级别，#号与注释文本间需保持一个空格以和注释代码进行区分。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="文件头">文件头<a href="#文件头" class="hash-link" aria-label="文件头的直接链接" title="文件头的直接链接">​</a></h5>
<p>每个文件的开头是其文件内容的描述。除版权声明外，每个文件必须包含一个顶层注释，对其功能进行简要概述。</p>
<p>例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Perform hot backups of databases.</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="功能注释">功能注释<a href="#功能注释" class="hash-link" aria-label="功能注释的直接链接" title="功能注释的直接链接">​</a></h5>
<p>主体脚本中除简洁明了的函数外都必须带有注释。库文件中所有函数无论其长短和复杂性都必须带有注释。</p>
<p>这使得其他人通过阅读注释即可学会如何使用你的程序或库函数，而不需要阅读代码。</p>
<p>所有的函数注释应该包含：</p>
<ul>
<li>函数的描述</li>
<li>全局变量的使用和修改</li>
<li>使用的参数说明</li>
<li>返回值，而不是上一条命令运行后默认的退出状态</li>
</ul>
<p>例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Perform hot backups of databases.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=&#x27;/usr/sbin/bin:/usr/bin:/usr/local/bin&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#######################################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cleanup files from the backup dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Globals:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   BACKUP_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   BACKUP_SID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Arguments:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#######################################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现部分的注释">实现部分的注释<a href="#实现部分的注释" class="hash-link" aria-label="实现部分的注释的直接链接" title="实现部分的注释的直接链接">​</a></h5>
<p>注释你代码中含有技巧、不明显、有趣的或者重要的部分。</p>
<p>这部 分遵循代码注释的基本原则即可。不要注释所有代码。如果有一个复杂的不易理解的逻辑，请进行简单的注释。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="todo注释">TODO注释<a href="#todo注释" class="hash-link" aria-label="TODO注释的直接链接" title="TODO注释的直接链接">​</a></h5>
<p>对那些临时的, 短期的解决方案, 或已经够好但仍不完美的代码使用 TODO 注释.</p>
<p>TODO 注释要使用全大写的字符串 TODO, 在随后的圆括号里写上你的名字,邮件地址, bug ID, 或其它身份标识和与这一 TODO 相关的 issue。
主要目的是让添加注释的人 (也是可以请求提供更多细节的人) 可根据规范的TODO 格式进行查找。
添加 TODO 注释并不意味着你要自己来修正,因此当你加上带有姓名的 TODO 时, 一般都是写上自己的名字。</p>
<p>这与<strong>C++ Style Guide</strong>中的约定相一致。</p>
<p>例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># TODO(mrmonkey): Handle the unlikely edge cases (bug ####)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TODO(--bug=123456): remove the &quot;Last visitors&quot; feature</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="命名">命名<a href="#命名" class="hash-link" aria-label="命名的直接链接" title="命名的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="函数名">函数名<a href="#函数名" class="hash-link" aria-label="函数名的直接链接" title="函数名的直接链接">​</a></h3>
<p>使用小写字母，并用下划线分隔单词。使用双冒号 <code>::</code> 分隔包名。函数名之后必须有圆括号。</p>
<p>如果你正在写单个函数，请用小写字母来命名，并用下划线分隔单词。如果你正在写一个包，使用双冒号 <code>::</code> 来分隔包名。
函数名和圆括号之间没有空格，大括号必须和函数名位于同一行。
当函数名后存在 <code>()</code> 时，关键词 function 是多余的，建议不带 function 的写法，但至少做到同一项目内风格保持一致。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Single function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Part of a package</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mypackage::my_func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function my_func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="变量名">变量名<a href="#变量名" class="hash-link" aria-label="变量名的直接链接" title="变量名的直接链接">​</a></h3>
<p>规则同函数名一致。</p>
<p>循环中的变量名应该和正在被循环的变量名保持相似的名称。
示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for zone in ${zones}; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    something_with &quot;${zone}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="常量和环境变量名">常量和环境变量名<a href="#常量和环境变量名" class="hash-link" aria-label="常量和环境变量名的直接链接" title="常量和环境变量名的直接链接">​</a></h3>
<p>全部大写，用下划线分隔，声明在文件的顶部。</p>
<p>常量和任何导出到环境中的变量都应该大写。
示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Constant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly PATH_TO_FILES=&#x27;/some/path&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Both constant and environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">declare -xr BACKUP_SID=&#x27;PROD&#x27;</span><br></span></code></pre></div></div>
<p>有些情况下首次初始化及常量（例如，通过getopts），因此，在getopts中或基于条件来设定常量是可以的，但之后应该立即设置其为只读。
值得注意的是，在函数中使用 declare 对全局变量无效，所以推荐使用 readonly 和 export 来代替。
示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">VERBOSE=&#x27;false&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while getopts &#x27;v&#x27; flag; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case &quot;${flag}&quot; in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v) VERBOSE=&#x27;true&#x27; ;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  esac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly VERBOSE</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="只读变量">只读变量<a href="#只读变量" class="hash-link" aria-label="只读变量的直接链接" title="只读变量的直接链接">​</a></h3>
<p>使用 readonly 或者 declare -r 来确保变量只读。</p>
<p>因为全局变量在shell中广泛使用，所以在使用它们的过程中捕获错误是很重要的。当你声明了一个变量，希望其只读，那么请明确指出。
示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">zip_version=&quot;$(dpkg --status zip | grep Version: | cut -d &#x27; &#x27; -f 2)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ -z &quot;${zip_version}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  error_message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  readonly zip_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="局部变量">局部变量<a href="#局部变量" class="hash-link" aria-label="局部变量的直接链接" title="局部变量的直接链接">​</a></h3>
<p>每次只声明一个变量,不要使用组合声明，比如<code>a=1 b=2</code>;</p>
<p>使用 local 声明特定功能的变量。声明和赋值应该在不同行。</p>
<p>必须使用 local 来声明局部变量，以确保其只在函数内部和子函数中可见。这样可以避免污染全局名称空间以及避免无意中设置可能在函数外部具有重要意义的变量。</p>
<p>当使用命令替换进行赋值时，变量声明和赋值必须分开。因为内建的 local 不会从命令替换中传递退出码。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_func2() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local name=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 命令替换赋值，变量声明和赋值需放到不同行:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local my_var</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_var=&quot;$(my_func)&quot; || return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_func2() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 禁止以下写法: $? 将获取到&#x27;local&#x27;指令的返回值, 而非 my_func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local my_var=&quot;$(my_func)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [[ $? -eq 0 ]] || return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="异常与日志">异常与日志<a href="#异常与日志" class="hash-link" aria-label="异常与日志的直接链接" title="异常与日志的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="异常">异常<a href="#异常" class="hash-link" aria-label="异常的直接链接" title="异常的直接链接">​</a></h3>
<p>使用shell返回值来返回异常，并根据不同的异常情况返回不同的值。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="日志">日志<a href="#日志" class="hash-link" aria-label="日志的直接链接" title="日志的直接链接">​</a></h3>
<p>所有的错误信息都应被导向到STDERR，这样将有利于出现问题时快速区分正常输出和异常输出。</p>
<p>建议使用与以下函数类似的方式来打印正常和异常输出：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">err() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;[$(date +&#x27;%FT%T%z&#x27;)]: $@&quot; &gt;&amp;2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ! do_something; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err &quot;Unable to do_something&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit &quot;${E_DID_NOTHING}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="编程实践--持续分类并完善--">编程实践<sup>  <em>持续分类并完善</em>  </sup><a href="#编程实践--持续分类并完善--" class="hash-link" aria-label="编程实践--持续分类并完善--的直接链接" title="编程实践--持续分类并完善--的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="变量扩展---推荐--">变量扩展 <sup>  <em>推荐</em>  </sup><a href="#变量扩展---推荐--" class="hash-link" aria-label="变量扩展---推荐--的直接链接" title="变量扩展---推荐--的直接链接">​</a></h3>
<p>通常情况下推荐为变量加上大括号如 <code>&quot;${var}&quot;</code> 而不是 <code>&quot;$var&quot;</code> ，但具体也要视情况而定。</p>
<p>以下按照优先顺序列出建议：</p>
<ul>
<li>与现有代码保持一致</li>
<li>单字符变量在特定情况下才 需要被括起来</li>
<li>使用引号引用变量，参考下一节：变量引用</li>
</ul>
<p>详细示例如下：
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 位置变量和特殊变量，可以不用大括号:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Positional: $1&quot; &quot;$5&quot; &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Specials: !=$!, -=$-, _=$_. ?=$?, #=$# *=$* @=$@ \$=$$ ...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当位置变量大于等于10，则必须有大括号:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;many parameters: ${10}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当出现歧义时，必须有大括号:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Output is &quot;a0b0c0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -- a b c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;${1}0${2}0${3}0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用变量扩展赋值时，必须有大括号：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEFAULT_MEM=${DEFUALT_MEM:-&quot;-Xms2g -Xmx2g -XX:MaxDirectMemorySize=4g&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 其他常规变量的推荐处理方式:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;PATH=${PATH}, PWD=${PWD}, mine=${some_var}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while read f; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;file=${f}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done &lt; &lt;(ls -l /tmp)</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 无引号, 无大括号, 特殊变量，单字符变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo a=$avar &quot;b=$bvar&quot; &quot;PID=${$}&quot; &quot;${1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 无大括号产生歧义场景：以下会被解析为 &quot;${1}0${2}0${3}0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 而非 &quot;${10}${20}${30}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -- a b c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;$10$20$30&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="变量引用---推荐--">变量引用 <sup>  <em>推荐</em>  </sup><a href="#变量引用---推荐--" class="hash-link" aria-label="变量引用---推荐--的直接链接" title="变量引用---推荐--的直接链接">​</a></h4>
<p>变量引用通常情况下应遵循以下原则：</p>
<ul>
<li>默认情况下推荐使用引号引用包含变量、命令替换符、空格或shell元字符的字符串</li>
<li>在有明确要求必须使用无引号扩展的情况下，可不用引号</li>
<li>字符串为单词类型时才推荐用引号，而非命令选项或者路径名</li>
<li>不要对整数使用引号</li>
<li>特别注意 <code>[[</code> 中模式匹配的引号规则</li>
<li>在无特殊情况下，推荐使用 <code>$@</code> 而非 <code>$*</code></li>
</ul>
<p>以下通过示例说明：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># &#x27;单引号&#x27; 表示禁用变量替换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;双引号&quot; 表示需要变量替换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例1： 命令替换需使用双引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag=&quot;$(some_command and its args &quot;$@&quot; &#x27;quoted separately&#x27;)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例2：常规变量需使用双引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;${flag}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例3：整数不使用引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value=32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例4：即便命令替换输出为整数，也需要使用引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">number=&quot;$(generate_number)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例5：单词可以使用引号，但不作强制要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly USE_INTEGER=&#x27;true&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例6：输出特殊符号使用单引号或转义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;Hello stranger, and well met. Earn lots of $$$&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Process $$: Done making \$\$\$.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例7：命令参数及路径不需要引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep -li Hugo /dev/null &quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例8：常规变量用双引号，ccs可能为空的特殊情况可不用引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git send-email --to &quot;${reviewers}&quot; ${ccs:+&quot;--cc&quot; &quot;${ccs}&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例9：正则用单引号，$1可能为空的特殊情况可不用引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep -cP &#x27;([Ss]pecial|\|?characters*)$&#x27; ${1:+&quot;$1&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例10：位置参数传递推荐带引号的&quot;$@&quot;，所有参数作为单字符串传递用带引号的&quot;$*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># content of t.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func_t() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo num: $#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo args: 1:$1 2:$2 3:$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func_t &quot;$@&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func_t &quot;$*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当执行 ./t.sh a b c 时输出如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args: 1:a 2:b 3:c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">args: 1:a b c 2: 3:</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="命令替换">命令替换<a href="#命令替换" class="hash-link" aria-label="命令替换的直接链接" title="命令替换的直接链接">​</a></h4>
<p>使用 <code>$(command)</code> 而不是反引号。</p>
<p>因反引号如果要嵌套则要求用反斜杠转义内部的反引号。而 <code>$(command)</code> 形式的嵌套无需转义，且可读性更高。</p>
<p>正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var=&quot;$(command &quot;$(command1)&quot;)&quot;</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var=&quot;`command \`command1\``&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="条件测试">条件测试<a href="#条件测试" class="hash-link" aria-label="条件测试的直接链接" title="条件测试的直接链接">​</a></h4>
<p>使用 <code>[[ ... ]]</code> ，而不是 <code>[</code> , <code>test</code> , 和 <code>/usr/bin/[</code> 。</p>
<p>因为在 <code>[[</code> 和 <code>]]</code> 之间不会出现路径扩展或单词切分，所以使用 <code>[[ ... ]]</code> 能够减少犯错。且 <code>[[ ... ]]</code> 支持正则表达式匹配，而 <code>[ ... ]</code> 不支持。
参考以下示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 示例1：正则匹配，注意右侧没有引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 详尽细节参考：http://tiswww.case.edu/php/chet/bash/FAQ 中E14部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;filename&quot; =~ ^[[:alnum:]]+name ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Match&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例2：严格匹配字符串&quot;f*&quot;(本例为不匹配)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;filename&quot; == &quot;f*&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Match&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例3：[]中右侧不加引号将出现路径扩展，如果当前目录下有f开头的多个文件将报错[: too many arguments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ &quot;filename&quot; == f* ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Match&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="字符串测试">字符串测试<a href="#字符串测试" class="hash-link" aria-label="字符串测试的直接链接" title="字符串测试的直接链接">​</a></h4>
<p>尽可能使用变量引用，而非字符串过滤。</p>
<p>Bash可以很好的处理空字符串测试，请使用空/非空字符串测试方法，而不是过滤字符，让代码具有更高的可读性。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;${my_var}&quot; = &quot;some_string&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;${my_var}X&quot; = &quot;some_stringX&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p>正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用-z测试字符串为空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ -z &quot;${my_var}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用空引号测试空字符串，能用但不推荐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;${my_var}&quot; = &quot;&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p>正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用-n测试非空字符串</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ -n &quot;${my_var}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 测试字符串非空，能用但不推荐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;${my_var}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do_something</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="文件名扩展">文件名扩展<a href="#文件名扩展" class="hash-link" aria-label="文件名扩展的直接链接" title="文件名扩展的直接链接">​</a></h4>
<p>当进行文件名的通配符扩展时，请指定明确的路径。</p>
<p>当目录中有特殊文件名如以 <code>-</code> 开头的文件时，使用带路径的扩展通配符 <code>./*</code> 比不带路径的 <code>*</code> 要安全很多。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 例如目录下有以下4个文件和子目录：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -f  -r  somedir  somefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 未指定路径的通配符扩展会把-r和-f当作rm的参数，强制删除文件：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psa@bilby$ rm -v *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">removed directory: `somedir&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">removed `somefile&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 而指定了路径的则不会:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psa@bilby$ rm -v ./*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">removed `./-f&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">removed `./-r&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm: cannot remove `./somedir&#x27;: Is a directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">removed `./somefile&#x27;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="慎用eval">慎用eval<a href="#慎用eval" class="hash-link" aria-label="慎用eval的直接链接" title="慎用eval的直接链接">​</a></h4>
<p>应该避免使用eval。</p>
<p>Eval在用于分配变量时会修改输入内容，但设置变量的同时并不能检查这些变量是什么。
反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 以下设置的内容及成功与否并不明确</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eval $(set_my_variables)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="慎用管道连接while循环">慎用管道连接while循环<a href="#慎用管道连接while循环" class="hash-link" aria-label="慎用管道连接while循环的直接链接" title="慎用管道连接while循环的直接链接">​</a></h4>
<p>请使用进程替换或者for循环，而不是通过管道连接while循环。</p>
<p>这是因为在管道之后的while循环中，命令是在一个子shell中运行的，因此对变量的修改是不能传递给父shell的。</p>
<p>这种管道连接while循环中的隐式子shell使得bug定位非常困难。
反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">last_line=&#x27;NULL&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">your_command | while read line; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_line=&quot;${line}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 以下会输出&#x27;NULL&#x27;：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;${last_line}&quot;</span><br></span></code></pre></div></div>
<p>如果你确定输入中不包含空格或者其他特殊符号（通常不是来自用户输入），则可以用for循环代替。
例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">total=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 仅当返回结果中无空格等特殊符号时以下可正常执行：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for value in $(command); do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total+=&quot;${value}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<p>使用进程替换可实现重定向输出，但是请将命令放入显式子shell，而非while循环创建的隐式子shell。
例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">total=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_file=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 注意两个&lt;之间有空格，第一个为重定向，第二个&lt;()为进程替换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while read count filename; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total+=&quot;${count}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_file=&quot;${filename}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done &lt; &lt;(your_command | uniq -c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Total = ${total}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Last one = ${last_file}&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="检查返回值">检查返回值<a href="#检查返回值" class="hash-link" aria-label="检查返回值的直接链接" title="检查返回值的直接链接">​</a></h4>
<p>总是检查返回值，且提供有用的返回值。</p>
<p>对于非管道命令，使用 <code>$?</code> 或直接通过 <code>if</code> 语句来检查以保持其简洁。</p>
<p>例如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用if语句判断执行结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ! mv &quot;${file_list}&quot; &quot;${dest_dir}/&quot; ; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Unable to move ${file_list} to ${dest_dir}&quot; &gt;&amp;2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit &quot;${E_BAD_MOVE}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 或者使用$?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv &quot;${file_list}&quot; &quot;${dest_dir}/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ $? -ne 0 ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Unable to move ${file_list} to ${dest_dir}&quot; &gt;&amp;2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit &quot;${E_BAD_MOVE}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="内建命令和外部命令">内建命令和外部命令<a href="#内建命令和外部命令" class="hash-link" aria-label="内建命令和外部命令的直接链接" title="内建命令和外部命令的直接链接">​</a></h4>
<p>当内建命令可以完成相同的任务时，在shell内建命令和调用外部命令之间，应尽量选择内建命令。</p>
<p>因内建命令相比外部命令而言会产生更少的依赖，且多数情况调用内建命令比调用外部命令可以获得更好的性能（通常外部命令会产生额外的进程开销）。</p>
<p>正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用内建的算术扩展</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addition=$((${X} + ${Y}))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用内建的字符串替换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">substitution=&quot;${string/#foo/bar}&quot;</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 调用外部命令进行简单的计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addition=&quot;$(expr ${X} + ${Y})&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 调用外部命令进行简单的字符串替换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">substitution=&quot;$(echo &quot;${string}&quot; | sed -e &#x27;s/^foo/bar/&#x27;)&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="文件加载">文件加载<a href="#文件加载" class="hash-link" aria-label="文件加载的直接链接" title="文件加载的直接链接">​</a></h4>
<p>加载外部库文件不建议用使用<code>.</code>，建议使用<code>source</code>，已提升可阅读性。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source my_libs.sh</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">. my_libs.sh</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="内容过滤与统计">内容过滤与统计<a href="#内容过滤与统计" class="hash-link" aria-label="内容过滤与统计的直接链接" title="内容过滤与统计的直接链接">​</a></h4>
<p>除非必要情况，尽量使用单个命令及其参数组合来完成一项任务，而非多个命令加上管道的不必要组合。
常见的不建议的用法例如：cat和grep连用过滤字符串; cat和wc连用统计行数; grep和wc连用统计行数等。</p>
<p>正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">grep net.ipv4 /etc/sysctl.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep -c net.ipv4 /etc/sysctl.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wc -l /etc/sysctl.conf</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/sysctl.conf | grep net.ipv4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep net.ipv4 /etc/sysctl.conf | wc -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /etc/sysctl.conf | wc -l</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="正确使用返回与退出">正确使用返回与退出<a href="#正确使用返回与退出" class="hash-link" aria-label="正确使用返回与退出的直接链接" title="正确使用返回与退出的直接链接">​</a></h4>
<p>除特殊情况外，几乎所有函数都不应该使用<code>exit</code>直接退出脚本，而应该使用<code>return</code>进行返回，以便后续逻辑中可以对错误进行处理。
正例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 当函数返回后可以继续执行cleanup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [[ -e /dummy ]] || return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup</span><br></span></code></pre></div></div>
<p>反例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 当函数退出时，cleanup将不会被执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [[ -e /dummy ]] || exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="附常用工具">附：常用工具<a href="#附常用工具" class="hash-link" aria-label="附：常用工具的直接链接" title="附：常用工具的直接链接">​</a></h2>
<p>推荐以下工具帮助我们进行代码的规范：</p>
<ul>
<li><a href="https://shellcheck.storage.googleapis.com/index.html" target="_blank" rel="noopener noreferrer" title="shell script analysis tool">ShellCheck</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2019/09/02/hive-small-file">HIVE中常见的小文件合并方法</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-09-02T00:00:00.000Z">2019年9月2日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown"><blockquote>
<p>介绍hive小文件常见处理方法</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hive的文件产生过程">hive的文件产生过程<a href="#hive的文件产生过程" class="hash-link" aria-label="hive的文件产生过程的直接链接" title="hive的文件产生过程的直接链接">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="小文件太多的影响">小文件太多的影响<a href="#小文件太多的影响" class="hash-link" aria-label="小文件太多的影响的直接链接" title="小文件太多的影响的直接链接">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么会产生小文件">为什么会产生小文件<a href="#为什么会产生小文件" class="hash-link" aria-label="为什么会产生小文件的直接链接" title="为什么会产生小 文件的直接链接">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何处理小文件">如何处理小文件<a href="#如何处理小文件" class="hash-link" aria-label="如何处理小文件的直接链接" title="如何处理小文件的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-1">case 1<a href="#case-1" class="hash-link" aria-label="case 1的直接链接" title="case 1的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT OVERWRITE TABLE tb1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECT * FROM tb2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ALTER TABLE tb2 RENAME TO b_tb2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ALTER TABLE tb1 RENAME TO tb2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-2">case 2<a href="#case-2" class="hash-link" aria-label="case 2的直接链接" title="case 2的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT TABLE tb1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT c1, c2 FROM (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECT c1, c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FROM tb2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WHERE xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AND xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY c1, c2;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-3">case 3<a href="#case-3" class="hash-link" aria-label="case 3的直接链接" title="case 3的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM  (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY x;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-4">case 4<a href="#case-4" class="hash-link" aria-label="case 4的直接链接" title="case 4的直接链  接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT OVERWRITE TABLE tb1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxx) t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distribute by rand();</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-5">case 5<a href="#case-5" class="hash-link" aria-label="case 5的直接链接" title="case 5的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT TABLE tb1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT c1,c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM tb2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sort by c1;</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/hive">hive</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2019/05/12/random-and-entropy-in-centos7">系统中的随机数和熵值</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-05-12T00:00:00.000Z">2019年5月12日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown"><blockquote>
<p>本文试着总结系统中的随机数前前后后以及管理中需要注意的问题 [先欠着]</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-什么是随机数">1 什么是随机数？<a href="#1-什么是随机数" class="hash-link" aria-label="1 什么是随机数？的直接链接" title="1 什么是随机数？的直接链接">​</a></h2>
<p>随机数就是无法预测的数</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-随机数有什么用">2 随机数有什么用？<a href="#2-随机数有什么用" class="hash-link" aria-label="2 随机数有什么用？的直接链接" title="2 随机数有什么用？的直接链接">​</a></h2>
<p>随机是为了安全</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-如何获得随机数">3 如何获得随机数？<a href="#3-如何获得随机数" class="hash-link" aria-label="3 如何获得随机数？的直接链接" title="3 如何获得随机数？的直接链接">​</a></h2>
<p>/dev/random
/dev/urandom
/proc/sys/kernel/random/entropy_avail</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-会有哪些问题">4 会有哪些问题？<a href="#4-会有哪些问题" class="hash-link" aria-label="4 会有哪些问题？的直接链接" title="4 会有哪些问题？的直接链接">​</a></h2>
<p>1 随机数数产生速度慢
2 影响上层应用</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="haveged-和-rng-tools">haveged 和 rng-tools<a href="#haveged-和-rng-tools" class="hash-link" aria-label="haveged 和 rng-tools的直接链接" title="haveged 和 rng-tools的直接链接">​</a></h2></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/centos-7">centos7</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/random">random</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/entropy">entropy</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2017/12/20/centos7-install-ansible-awx">CentOS7系统安装ansible awx记录</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-12-20T00:00:00.000Z">2017年12月20日</time> · <!-- -->阅读需 2 分钟</div></header><div class="markdown"><blockquote>
<p>记录awx的安装测试过程以及需要注意的点</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于awx">关于awx<a href="#关于awx" class="hash-link" aria-label="关于awx的直接链接" title="关于awx的直接链接">​</a></h2>
<p>awx(<a href="https://github.com/ansible/awx)%E6%98%AFansible" target="_blank" rel="noopener noreferrer">https://github.com/ansible/awx)是ansible</a> tower的开源版本，作为tower的upstream对外开源，
项目从2013年开始维护，2017年由redhat对外开源，目前维护得比较活跃。由于官方的install guide写得有点杂不是很直观，
导致想要安装个简单的测试环境体验一下功能都要折腾半天，这里提供一个简单版本的安装流程方便  快速体验。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装过程">安装过程<a href="#安装过程" class="hash-link" aria-label="安装过程的直接链接" title="安装过程的直接链接">​</a></h2>
<p>安装软件包</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install epel-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setenforce 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install git gettext ansible docker nodejs npm gcc-c++ bzip2 python-docker-py</span><br></span></code></pre></div></div>
<p>启动服务</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl enable docker</span><br></span></code></pre></div></div>
<p>clone awx代码</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/ansible/awx.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd awx/installer/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 注意修改一下postgres_data_dir到其他目录比如/data/pgdocker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi inventory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ansible-playbook -i inventory install.yml</span><br></span></code></pre></div></div>
<p>检查日志</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker logs -f awx_task</span><br></span></code></pre></div></div>
<p>以上是安装过程，因为本地环境访问外网要经过代理，这里记录一下配置docker通过代理访问外网的方式，否则pull image会有问题。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir /etc/systemd/system/docker.service.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /etc/systemd/system/docker.service.d/http-proxy.conf &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;HTTP_PROXY=proxy.test.dev:8080&quot; &quot;HTTPS_PROXY=proxy.test.dev:8080&quot; &quot;NO_PROXY=localhost,127.0.0.1,172.1.0.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl show --property=Environment docker</span><br></span></code></pre></div></div>
<p>参考文档：</p>
<p>[1] <a href="http://khmel.org/?p=1245" target="_blank" rel="noopener noreferrer">http://khmel.org/?p=1245</a></p>
<p>[2] <a href="https://docs.docker.com/engine/admin/systemd/#httphttps-proxy" target="_blank" rel="noopener noreferrer">https://docs.docker.com/engine/admin/systemd/#httphttps-proxy</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/system">system</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/shell">shell</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2017/10/19/bash-nohup-log-truncate">很诡异的服务日志无法切割问题分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-10-19T00:00:00.000Z">2017年10月19日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown"><blockquote>
<p>遇到某服务进程产生的日志始终无法切割，原来原因在这里</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题现象">问题现象<a href="#问题现象" class="hash-link" aria-label="问题现象的直接链接" title="问题现象的直接链接">​</a></h2>
<p>某业务机器因磁盘容量超过阈值收到告警，分析发现是由于该机器上某个服务进程产生的日志文件量太大，且日志文件未按周期切割，进而导致历史日志信息积累到单个日志文件中。
未避免故障发生采取临时措施手工切割该日志文件，由于该服务进程并未提供内置的日志切割，因此手工模拟类似logrotate的<code>copytruncate</code>模式对日志进行切割。
但在将日志truncate之后，奇怪的一幕发生了，通过ls查看文件大小发现并未减少，直觉判断这可能是文件句柄一直处于打开状态且偏移量未发生改变导致。
在进一步检查了该进程的启动方式之后，发现该进程通过nohup启动，并将标准输出重定向到持续增大的日志文件中。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="模拟">模拟<a href="#模拟" class="hash-link" aria-label="模拟的直接链接" title="模拟的直接链接">​</a></h2>
<p>我们通过下面几行脚本来模拟此现象：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while true; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sleep 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head -5000 /dev/urandom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<p>脚本启动后会有一个常驻进程每个1秒钟输出一堆字符串以此来模拟日志文件增涨，我们按照以下方式启动：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nohup ./daemon.sh &gt;out.log 2&gt;&amp;1 &lt; /dev/null &amp;</span><br></span></code></pre></div></div>
<p>等待一会之后我们观察到日志已经写入了</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# ll -h out.log ;du -h out.log </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 64M Oct 19 17:41 out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64M   out.log</span><br></span></code></pre></div></div>
<p>接着将日志文件清空，再观察文件大小变化</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# truncate -s0 out.log              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# ll -h out.log ;du -h out.log </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 93M Oct 19 17:41 out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4.0M  out.log</span><br></span></code></pre></div></div>
<p>这时可以看到，虽然文件被清空了，但是ls看到的大小依然没有发生变化，也就是说文件中产生了大量空洞。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方法">解决方法<a href="#解决方法" class="hash-link" aria-label="解决方法的直接链接" title="解决方法的直接链接">​</a></h2>
<p>将nohup启动进程后的输出重定向 <code>&gt;</code> 替换为 <code>&gt;&gt;</code>， 即改为append模式来写入日志，这时再truncate就不会出现上面的问题了。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> nohup ./daemon.sh &gt;&gt;out.log 2&gt;&amp;1  &lt;/dev/null &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# ll -h out.log ;du -h out.log </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 48M Oct 19 19:43 out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64M   out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# ll -h out.log ;du -h out.log </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 77M Oct 19 19:43 out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">128M  out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# truncate -s0 out.log              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@localhost t]# ll -h out.log ;du -h out.log </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 1.3M Oct 19 19:43 out.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.0M  out.log</span><br></span></code></pre></div></div>
<p>这里留一个问题： 为什么使用<code>append</code>模式就不会出现这个问题？</p>
<p>参考文档：</p>
<p>[1] <a href="https://www.gnu.org/software/bash/manual/bash.html#Redirections" target="_blank" rel="noopener noreferrer">https://www.gnu.org/software/bash/manual/bash.html#Redirections</a></p>
<p>[2] <a href="https://www.gnu.org/software/coreutils/manual/html_node/nohup-invocation.html" target="_blank" rel="noopener noreferrer">https://www.gnu.org/software/coreutils/manual/html_node/nohup-invocation.html</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/system">system</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/shell">shell</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2017/08/20/hadoop3-ec-test">HADOOP3.0.0纠删码测试</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-08-20T00:00:00.000Z">2017年8月20日</time> · <!-- -->阅读需 5 分钟</div></header><div class="markdown"><blockquote>
<p>记录hadoop3.0.0版本测试安装过程，对hadoop3.0.0中纠删码进行了简单测试。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础环境">基础环境<a href="#基础环境" class="hash-link" aria-label="基础环境的直接链接" title="基础环境的直接链接">​</a></h2>
<p>HADOOP3.0.0版本中增加了纠删码技术，在提高可用性的同时还能减低存储成本，目前处于实验阶段，以下将测试环境中的搭建步骤及简单测试过程进行记录。本次仅对hdfs进行测试，因此不会部署其他服务。</p>
<p>系统环境如下：</p>
<p>kvm虚拟机，1个namenode节点，6个datanode节点，4core ，8G mem ， 50G disk</p>
<p>hadoop版本：3.0.0-alpha4</p>
<p>java版本： 1.8.0_144</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试集群安装">测试集群安装<a href="#测试集群安装" class="hash-link" aria-label="测试集群安装的直接链接" title="测试集群安装的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础包安装">基础包安装<a href="#基础包安装" class="hash-link" aria-label="基础包安装的直接链接" title="基础包安装的直接链接">​</a></h3>
<p>从apache镜像下载hadoop-3.0.0-alpha4，当前最新版本，hadoop home目录/opt/hadoop，在namenode节点将配置等修改好之后拷贝到所有datanode节点。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xf hadoop-3.0.0-alpha4.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv hadoop-3.0.0-alpha4 /opt/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install jdk --disablerepo=* --enablerepo=local-custom</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件修改">配置文件修改<a href="#配置文件修改" class="hash-link" aria-label="配置文件修改的直接链接" title="配置文件修改的直接链接">​</a></h3>
<p>需要修改的配置文件有hadoop-env.sh 、core-site.xml、hdfs-site.xml</p>
<p>修改<code>/opt/hadoop/etc/hadoop/hadoop-env.sh</code>中以下参数：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export JAVA_HOME=/usr/java/jdk1.8.0_144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_HOME=/opt/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 注意这里配置heapsize和2.7版本的差别，2.7为HADOOP_HEAPSIZE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_HEAPSIZE_MAX=1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_OPTS=&quot;$HADOOP_OPTS -Djava.net.preferIPv4Stack=true”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_CLIENT_OPTS=&quot;-Xmx512m $HADOOP_CLIENT_OPTS”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_LOG_DIR=${HADOOP_HOME}/logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_PID_DIR=/tmp</span><br></span></code></pre></div></div>
<p>修改<code>/opt/hadoop/etc/hadoop/hdfs-site.xml</code>内容如下：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.blocksize</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">134217728</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.datanode.data.dir</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">/data/hdfs/data</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.name.dir</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">/data/hdfs/namenode</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.rpc-address</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">192.168.199.26:8020</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>将环境变量增加到当前用户bashrc：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ~/.bashrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HADOOP_HOME=/opt/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/opt/hadoop/bin</span><br></span></code></pre></div></div>
<p>配置修改完成后将/opt/hadoop整个目录同步到所有datanode节点。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动hdfs">启动HDFS<a href="#启动hdfs" class="hash-link" aria-label="启动HDFS的直接链接" title="启动HDFS的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="格式化namenode">格式化namenode<a href="#格式化namenode" class="hash-link" aria-label="格式化namenode的直接链接" title="格式化namenode的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdfs namenode -format ns1</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动namenode和datanode">启动namenode和datanode<a href="#启动namenode和datanode" class="hash-link" aria-label="启动namenode和datanode的直接链接" title="启动namenode和datanode的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 注意3.0.0版本的差别，在2.7中启动脚本如下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hadoop-daemon.sh --config $HADOOP_HOME/etc/hadoop --script hdfs start namenode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hadoop-daemon.sh --config $HADOOP_HOME/etc/hadoop --script hdfs start datanode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 新版本中已经重写了管理脚本，统一到hdfs命令中，启动方式如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs --daemon start namenode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs --daemon start datanode</span><br></span></code></pre></div></div>
<p>启动成功之后即可通过<a href="http://192.168.199.26:9870/dfshealth.html#tab-datanode" target="_blank" rel="noopener noreferrer">namenode web ui</a>观察到集群基本情况，2.7中默认web ui端口为50070，而3.0.0中修改为9870，</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试hdfs">测试hdfs<a href="#测试hdfs" class="hash-link" aria-label="测试hdfs的直接链接" title="测试hdfs的直接链接">​</a></h2>
<p>启动完成之后可以通过hdfs命令测试服务是否可用：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdfs dfs -mkdir hdfs://192.168.199.26:8020/t1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dd if=/dev/urandom of=f1 bs=1M count=5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs dfs -put f1 hdfs://192.168.199.26:8020/t1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs dfs -rm -skipTrash hdfs://192.168.199.26:8020/t1/f1</span><br></span></code></pre></div></div>
<p>这里使用的时候需要写完整的hdfs协议和namenode<!-- -->:port<!-- -->，我们可以修改一下配置文件，将defaultfs修改为hdfs协议，方便测试。同时此版本中默认并未启用纠删码，需要手工配置。
默认内置支持的policy有 RS-3-2-64k, RS-6-3-64k, RS-10-4-64k, RS-LEGACY-6-3-64k, XOR-2-1-64k，我这里只准备了少量节点，因此只对其中两种进行简单测试。</p>
<p>修改<code>hdfs-site.xml</code> 增加以下配置：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.ec.policies.enabled</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">XOR-2-1-64k,RS-3-2-64k</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.nameservices</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.ha.namenodes.ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">nn1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.namenode.rpc-address.ns1.nn1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">192.168.199.26:8020</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dfs.client.failover.proxy.provider.ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>修改<code>core-site.xml</code>增加以下配置：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">fs.defaultFS</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">hdfs://ns1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">final</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>重启namenode节点后，就可以使用纠删码了，纠删码可以针对目录进行设置，不同的目录设置不同的策略。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hdfs ec -setPolicy -policy XOR-2-1-64k -path /t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hdfs ec -setPolicy -policy RS-3-2-64k -path /t2</span><br></span></code></pre></div></div>
<p>我们准备了3个目录，t1和t2分别设置了不同的policy，t3不设置，往3个目录上传相同的5G大小的文件，每次上传前均清空hdfs中数据，并清空虚拟机和物理机缓存，统计的耗时和空间占用情况大致如下：</p>
<table><thead><tr><th>HDFS目录</th><th>纠删码策略</th><th>put耗时</th><th>磁盘占用kb</th></tr></thead><tbody><tr><td>t1</td><td>XOR-2-1-64k</td><td>1m15.559s</td><td>7740364</td></tr><tr><td>t2</td><td>RS-3-2-64k</td><td>1m13.920s</td><td>8600436</td></tr><tr><td>t3</td><td>无(三副本)</td><td>2m7.705s</td><td>15480600</td></tr></tbody></table>
<p>通过简单的测试对比，我们可以大致了解到在理想状态下纠删码技术比传统的三副本在写入速度上有提升，因其降低了对磁盘IO和带宽的消耗，同时占用的磁盘空间小于三副本方式。其中磁盘占用和不同的纠删码策略理论值基本吻合， 磁盘空间消耗倍数为 <code>(校验块+数据块)/数据块</code>。</p>
<p>注意这里的测试仅限于对HADOOP3.0.0中纠删码有一个感性认识，测试方法有很多不严谨的地方，比如put数据的耗时并未考虑各种环境因素，仅仅是在一个相对理想的环境下进行简单测试。实际生产环境中情况非常复杂，需要权衡CPU带宽磁盘，甚至机架供电等各方面因素，如果需要获得一份可靠的性能对比数据则必须保障稳定运行足够长的时间，通过长期观察才能得出对生产有实际指导意义的信息。</p>
<p>参考文档：</p>
<p>[1] <a href="http://hadoop.apache.org/docs/r3.0.0-alpha4/hadoop-project-dist/hadoop-common/ClusterSetup.html" target="_blank" rel="noopener noreferrer">http://hadoop.apache.org/docs/r3.0.0-alpha4/hadoop-project-dist/hadoop-common/ClusterSetup.html</a></p>
<p>[2] <a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html" target="_blank" rel="noopener noreferrer">http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/hadoop">hadoop</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bigdata">bigdata</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2017/08/18/deploy-k8s-from-local-repo">k8s测试环境部署记录</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-08-18T00:00:00.000Z">2017年8月18日</time> · <!-- -->阅读需 4 分钟</div></header><div class="markdown"><blockquote>
<p>本文记录了在本地部署k8s测试环境的过程，部署脚本参考github上其他同学分享的脚本，在其基础上做了些小改动。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-中的节点类型">k8s 中的节点类型<a href="#k8s-中的节点类型" class="hash-link" aria-label="k8s 中的节点类型的直接链接" title="k8s 中的节点类型的直接链接">​</a></h2>
<p>master 负责管理其他节点的调度中心，master可以有备机replica做冗余</p>
<p>minion 由master管理，运行容器服务，1个集群中有N个minion节点</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署前准备">部署前准备<a href="#部署前准备" class="hash-link" aria-label="部署前准备的直接链接" title="部署前准备的直接链接">​</a></h2>
<p>部署此测试环境参考了github上其他同学的分享，我fork的repo地址：<a href="https://github.com/5xops/k8s-deploy" target="_blank" rel="noopener noreferrer">https://github.com/5xops/k8s-deploy</a></p>
<p>首先按照github repo中的readme部分将k8s rpm包下载到本地，以准备离线部署。其次我在本地测试环境准备了6以上的虚拟机节点，其中3个节点用于部署etcd集群，2个节点用于部署k8s master，其余节点用于部署k8s minion。
所有虚拟机均运行在一台物理服务器上，管理虚拟机用了这个脚本（<a href="https://github.com/itxx00/vmm%EF%BC%89%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/itxx00/vmm）。</a></p>
<p>首先创建好需要使用到的虚拟机节点：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vmm create etcd1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create etcd2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create kubem1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create kubem2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmm create node2</span><br></span></code></pre></div></div>
<p>因部署k8s集群时要求所有节点都配置好主机名，因为默认创建出来的虚拟机没有修改hostname，需要使用另外一个脚本来配置hostname并配置好/etc/hosts，首先准备好初始化执行的脚本：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># content of ~/.vmm/init.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnm=$(cat hostname)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[[ -n $hostnm ]] || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;err&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $hostnm &gt;/etc/hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostname $hostnm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /tmp/hosts.tmp &gt;/etc/hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>接着执行初始化操作：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vminit etcd1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit etcd2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit kubem1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit kubem2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vminit node2</span><br></span></code></pre></div></div>
<p>每个节点的hostname将被设置成虚拟机的名字，同时vminit脚本会把本地的ssh公钥和私钥都拷贝到虚拟机节点，这样初始化之后的节点可以通过相同的密钥互相免密登录，注意这样的操作仅适用于快速搭建测试环境，生产环境千万不要这么处理。打通免密ssh是因为后面部署k8s时会用到。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="搭建etcd集群">搭建etcd集群<a href="#搭建etcd集群" class="hash-link" aria-label="搭建etcd集群的直接链接" title="搭建etcd集群的直接链接">​</a></h2>
<p>在部署k8s集群之前，我们需要先部署一个独立的etcd集群，k8s会用到这个集群。这里我采用ansible playbook来部署，playbook已经分享到github上面，（<a href="https://github.com/itxx00/ansible-etcd%EF%BC%89%EF%BC%8C%E6%8C%89%E7%85%A7repo%E4%B8%AD%E7%9A%84readme%E6%9D%A5%E5%87%86%E5%A4%87%E5%A5%BD%E9%9B%86%E7%BE%A4%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/itxx00/ansible-etcd），按照repo中的readme来准备好集群。</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备镜像仓库">准备镜像仓库<a href="#准备镜像仓库" class="hash-link" aria-label="准备镜像仓库的直接链接" title="准备镜像仓库的直接链接">​</a></h2>
<p>将下载下来的k8s rpm包和docker镜像放到/data/k8s-deploy目录，其中rpms目录存放了需要用到的rpm包，images目录存放需要用到的docker镜像，因原脚本中不包含k8s dashboard（一套web ui管理界面），为了能够部署dashboard，对原脚本作了修改增加了部署dashboard的选项，部署dashboard需要一些额外的docker镜像和配置文件，这里先补充好docker镜像：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/kubernetes-dashboard-amd64:v1.6.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/heapster-influxdb-amd64:v1.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/heapster-grafana-amd64:v4.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull googlecontainer/heapster-amd64:v1.3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /data/k8s-deploly/images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/kubernetes-dashboard-amd64 -o kubernetes-dashboard-amd64_v1.6.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/heapster-influxdb-amd64 -o heapster-influxdb-amd64_v1.1.1.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/heapster-grafana-amd64 -o heapster-grafana-amd64_v4.0.2.tar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker save googlecontainer/heapster-amd64 -o heapster-amd64_v1.3.0.tar</span><br></span></code></pre></div></div>
<p>原脚本中安装rpm包是在各节点下载好后本地安装的，我改进了一下采用yum方式安装，准备yum仓库：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">createrepo /data/k8s-deploy/rpms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y install nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt;/etc/nginx/conf.d/k8srepo.conf &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       8000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name  _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root         /data/k8s-deploy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autoindex on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart nginx</span><br></span></code></pre></div></div>
<p>至此yum repo和docker镜像准备完成。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署k8s集群">部署k8s集群<a href="#部署k8s集群" class="hash-link" aria-label="部署k8s集群的直接链接" title="部署k8s集群的直接链接">​</a></h2>
<p>部署过程参考<a href="https://github.com/5xops/k8s-deploy/blob/master/README.md" target="_blank" rel="noopener noreferrer">https://github.com/5xops/k8s-deploy/blob/master/README.md</a> ，需要修改repo中的k8slocal.repo文件中ip地址为yum仓库对应的ip地址，部署master、minion和replica可参考master.sh，minon.sh, replica.sh的内容。
需要注意的是为了部署dashboard服务我们额外增加了dashboard相关的配置文件，具体增加的内容请参考这个commit： <a href="https://github.com/5xops/k8s-deploy/commit/1766a675d76edb32f310acd98d5c6ed50a356e5b" target="_blank" rel="noopener noreferrer">https://github.com/5xops/k8s-deploy/commit/1766a675d76edb32f310acd98d5c6ed50a356e5b</a></p>
<p>至此，k8s测试环境及搭建完成，后续我将使用这个k8s测试环境来部署其他服务，后面会慢慢分享。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/k-8-s">k8s</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/kubernetes">kubernetes</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2017/06/13/nftables-man-page">nftables：nft man文档阅读笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-06-13T00:00:00.000Z">2017年6月13日</time> · <!-- -->阅读需 37 分钟</div></header><div class="markdown"><blockquote>
<p>利用空闲时间学习了nftables的基础知识，其中官方的man page中包含了大量信息，在阅读过程中整理了一份带中文注释的笔记，以辅助加深记忆。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具名称">工具名称<a href="#工具名称" class="hash-link" aria-label="工具名称的直接链接" title="工具名称的直接链接">​</a></h2>
<p>nft --  包过滤规则管理工具</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基本用法">基本用法<a href="#基本用法" class="hash-link" aria-label="基本用法的直接链接" title="基本用法的直接链接">​</a></h2>
<p><code>nft [ -n | --numeric ] [ -s | --stateless ] [ [-I | --includepath] directory ] [ [-f | --file] filename | [-i | --interactive] | cmd ]</code></p>
<p><code>nft [ -h | --help ] [ -v | --version ]</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="工具描述">工具描述<a href="#工具描述" class="hash-link" aria-label="工具描述的直接链接" title="工具描述的直接链接">​</a></h2>
<p>nftables 作为新一代的防火墙策略框架，旨在替代之前的各种防火墙工具诸如iptables/ebtables等，而且提供了类似tc的带宽限速能力。而nft则提供了nftables的命令行入口，是用户空间的管理工具。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="选项说明">选项说明<a href="#选项说明" class="hash-link" aria-label="选项说明的直接链接" title="选项说明的直接链接">​</a></h2>
<p>执行<code>nft --help</code>查看完整帮助信息</p>
<p><code>-h, --help</code></p>
<dd><p>查看帮助信息.</p></dd>
<p><code>-v, --version</code></p>
<dd><p>查看版本号.</p></dd>
<p><code>-n, --numeric</code></p>
<dd><p>以数值方式展示数据，可重复使用，一个-n表示不解析域名，第二次不解析端  口号，第三次不解析协议和uid/gid。</p></dd>
<p><code>-s, --stateless</code></p>
<dd><p>省略规则和有状态对象的状态信息</p></dd>
<p><code>-N</code></p>
<dd><p>将ip地址解析成域名，依赖dns解析。</p></dd>
<p><code>-a, --handle</code></p>
<dd><p>输出内容中展示规则handle信息</p></dd>
<p><code>-I, --includepath directory</code></p>
<dd><p>添加include文件搜索目录</p></dd>
<p><code>-f, --file filename</code></p>
<dd><p>从文件获取输入</p></dd>
<p><code>-i, --interactive</code></p>
<dd><p>从交互式cli获取输入</p></dd>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="文件格式">文件格式<a href="#文件格式" class="hash-link" aria-label="文件格式的直接链接" title="文件格式的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="语法规定">语法规定<a href="#语法规定" class="hash-link" aria-label="语法规定的直接链接" title="语法规定的直接链接">​</a></h3>
<p>单行过长可用<code>\</code>换行连接；
多个命令写到同一行可用分号<code>;</code> 分隔；
注释使用井号<code>#</code>打头；
标识符用大小写字母打头，后面跟数字字母下划线正斜杠反斜杠以及点号;
用双引号引起来表示纯字符串。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件引用">文件引用<a href="#文件引用" class="hash-link" aria-label="文件引用的直接链接" title="文件引用的直接链接">​</a></h3>
<p><code>include &quot;filename&quot;</code></p>
<p>可由外部文件通过<code>include</code>导入到当前文件，用<code>-I/--includepath</code>指定导入文件所在目录，如果include后面接的是目录而非文件，则整个目录的文件将以字母顺序依次导入。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="符号变量">符号变量<a href="#符号变量" class="hash-link" aria-label="符号变量的直接链接" title="符号变量的直接链接">​</a></h3>
<p><code>define variable = expr</code></p>
<p><code>$variable</code></p>
<p>Symbolic variables can be defined using the <em><strong>define</strong></em> statement. Variable references are expressions and can be used initialize other variables. The scope of a definition is the current block and all blocks contained within.
变量使用<code>define</code>定义，变量引用属于表达式，可以用于初始化其他变量，变量的生效范围在当前block以及被包含的所有block内。</p>
<p><em><strong>示例 1. 使用符号变量</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">define int_if1 = eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">define int_if2 = eth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">define int_ifs = { $int_if1, $int_if2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iif $int_ifs accept</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="地址族">地址族<a href="#地址族" class="hash-link" aria-label="地址族的直接链接" title="地址族的直接链接">​</a></h2>
<p>根据处理的包的种类不同可以将其分为不同的地址族。不同的地址族在内核中包含有特定阶段的处理路径和hook点，当对应hook的规则存在时则会被nftables处理。具体类型如下：</p>
<p><code>ip</code></p>
<dd><p>IPv4 地址族</p></dd>
<p><code>ip6</code></p>
<dd><p>IPv6 地址族</p></dd>
<p><code>inet</code></p>
<dd><p>Internet (IPv4/IPv6) 地址族</p></dd>
<p><code>arp</code></p>
<dd><p>ARP 地址族</p></dd>
<p><code>bridge</code></p>
<dd><p>Bridge 地址族</p></dd>
<p><code>netdev</code></p>
<dd><p>Netdev 地址族</p></dd>
<p>所有nftables对象存在于特定的地址族namespace中，换言之所有identifier都含有一个特定的地址族，如果未指定则默认使用<code>ip</code>地址族</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4ipv6inet-address-families">IPv4/IPv6/Inet address families<a href="#ipv4ipv6inet-address-families" class="hash-link" aria-label="IPv4/IPv6/Inet address families的直接链接" title="IPv4/IPv6/Inet address families的直接链接">​</a></h3>
<p>IPv4/IPv6/Inet 地址族用于处理 IPv4和IPv6包，其在network stack中在不同的包处理阶段一共包含了5个hook.</p>
<p><em><strong>Table 1. IPv4/IPv6/Inet 地址类hook列表</strong></em></p>
<table><thead><tr><th>Hook名称</th><th>描述</th></tr></thead><tbody><tr><td>prerouting</td><td>所有进入到系统的包都会被prerouting hook进行处理. 它在routing流程之前就被发起，用于靠前阶段的包过滤或者更改影响routing的包属性.</td></tr><tr><td>input</td><td>发往本地系统的包将被input hook处理.</td></tr><tr><td>forward</td><td>被转发到其他主机的包会经由forward hook处理.</td></tr><tr><td>output</td><td>由本地进程发送出去的包将被output hook处理.</td></tr><tr><td>postrouting</td><td>所有离开系统的包都将被postrouting hook处理.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arp-address-family">ARP address family<a href="#arp-address-family" class="hash-link" aria-label="ARP address family的直接链接" title="ARP address family的直接链接">​</a></h3>
<p>ARP地址族用于处理经由系统接收和发送的ARP包。一般在集群环境中对ARP包进行mangle处理以支持clustering。</p>
<p><em><strong>Table 2. ARP address family hooks</strong></em></p>
<table><thead><tr><th>Hook</th><th>描述</th></tr></thead><tbody><tr><td>input</td><td>分发到本机的包会经过input hook.</td></tr><tr><td>output</td><td>由本机发出的包会经过output hook.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bridge-address-family">Bridge address family<a href="#bridge-address-family" class="hash-link" aria-label="Bridge address family的直接链接" title="Bridge address family的直接链接">​</a></h3>
<p>bridge地址族处理通过桥接设备的ethernet包。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="netdev-address-family">Netdev address family<a href="#netdev-address-family" class="hash-link" aria-label="Netdev address family的直接链接" title="Netdev address family的直接链接">​</a></h3>
<p>Netdev地址族处理从ingress过来的包。</p>
<p><em><strong>Table 3. Netdev address family hooks</strong></em></p>
<table><thead><tr><th>Hook</th><th>Description</th></tr></thead><tbody><tr><td>ingress</td><td>所有进入系统的包都将被ingress hook处理。它在进入layer 3之前的阶段就开始处理。</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tables">Tables<a href="#tables" class="hash-link" aria-label="Tables的直接链接" title="Tables的直接链接">​</a></h2>
<p><code>{add | delete | list | flush} table [family] {table}</code></p>
<p>table是chain/set/stateful object的容器，table由其地址族和名字做标识。地址族必须属于ip, ip6, arp, bridge, netdev中的一种，inet地址族是一个虚拟地址族，同来创建同时包含IPv4和IPv6的table，如果没有指定地址族则默认使用<code>ip</code>地址族。</p>
<p><code>add</code></p>
<dd><p>添加指定地址族，指定名称的table</p></dd>
<p><code>delete</code></p>
<dd><p>删除指定的table</p></dd>
<p><code>list</code></p>
<dd><p>列出指定table中的所有chain和rule</p></dd>
<p><code>flush</code></p>
<dd><p>清除指定table中的所有chain和rule</p></dd>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chains">Chains<a href="#chains" class="hash-link" aria-label="Chains的直接链接" title="Chains的直接链接">​</a></h2>
<p><code>{add} chain [family] {table} {chain} {hook} {priority} {policy} {device}</code></p>
<p><code>{add | create | delete | list | flush} chain [family] {table} {chain}</code></p>
<p><code>{rename} chain [family] {table} {chain} {newname}</code></p>
<p>chain是rule的容器，他们存在于两种类型，基础链（base chain）和常规链（regular chain）。base chain是网络栈中数据包的入口点，regular chain则可用于jump的目标并对规则进行更好地组织。</p>
<p><code>add</code></p>
<dd><p>在指定table中添加新的链，当hook和权重值被指定时，添加的chain为base chain，将在网络栈中hook相关联。</p></dd>
<p><code>create</code></p>
<dd><p>与<code>add</code>命令类似，不同之处在于当创建的chain存在时会返回错误。</p></dd>
<p><code>delete</code></p>
<dd><p>删除指定的chain，被删除的chain不能有规则且不能是跳转目标chain。</p></dd>
<p><code>rename</code></p>
<dd><p>重命名chain</p></dd>
<p><code>list</code></p>
<dd><p>列出指定chain中的所有rule</p></dd>
<p><code>flush</code></p>
<dd><p>清除指定chain中所有rule</p></dd>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rules">Rules<a href="#rules" class="hash-link" aria-label="Rules的直接链接" title="Rules的直接链接">​</a></h2>
<p><code>[add | insert] rule [family] {table} {chain} [position position] {statement...}</code></p>
<p><code>{delete} rule [family] {table} {chain} {handle handle}</code></p>
<p>Rules are constructed from two kinds of components according to a set of grammatical rules: expressions and statements.</p>
<p><code>add</code></p>
<dd><p>Add a new rule described by the list of statements. The rule is appended to the given chain unless a position is specified, in which case the rule is appended to the rule given by the position.</p></dd>
<p><code>insert</code></p>
<dd><p>Similar to the <em><strong>add</strong></em> command, but the rule is prepended to the beginning of the chain or before the rule at the given position.</p></dd>
<p><code>delete</code></p>
<dd><p>Delete the specified rule.</p></dd>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sets">Sets<a href="#sets" class="hash-link" aria-label="Sets的直接链接" title="Sets的直接链接">​</a></h2>
<p><code>{add} set family] {table} {set}{ {type} [flags] [timeout] [gc-interval] [elements] [size] [policy]}</code></p>
<p><code>{delete | list | flush} set [family] {table} {set}</code></p>
<p><code>{add | delete} element [family] {table} {set}{ {elements}}</code></p>
<p>Sets are elements containers of an user-defined data type, they are uniquely identified by an user-defined name and attached to tables.
sets 是用户定义的数据类型的容器，具有用户定义的唯一标识，被应用到table上。</p>
<p><code>add</code></p>
<dd><p>在指定的table中添加一个新的set</p></dd>
<p><code>delete</code></p>
<dd><p>删除指定set</p></dd>
<p><code>list</code></p>
<dd><p>查看set内的元素</p></dd>
<p><code>flush</code></p>
<dd><p>清空整个set</p></dd>
<p><code>add element</code></p>
<dd><p>往set中添加元素，多个使用逗号分隔</p></dd>
<p><code>delete element</code></p>
<dd><p>从set中删除元素，多个使用逗号分隔</p></dd>
<p><em><strong>Table 4. Set 参数</strong></em></p>
<table><thead><tr><th>关键字</th><th>描述</th><th>类型</th></tr></thead><tbody><tr><td>type</td><td>元素的数据类型</td><td>string: ipv4_addr, ipv6_addr, ether_addr, inet_proto, inet_service, mark</td></tr><tr><td>flags</td><td>set flags</td><td>string: constant, interval, timeout</td></tr><tr><td>timeout</td><td>元素在set中的存活时间</td><td>string, 带单位的小数. 单位: d, h, m, s</td></tr><tr><td>gc-interval</td><td>垃圾回收间隔, 仅当timeout或flag timeout设置时生效</td><td>string, decimal followed by unit. Units are: d, h, m, s</td></tr><tr><td>elements</td><td>set中包含的元素</td><td>set data type</td></tr><tr><td>size</td><td>set可存放的最大元素个数</td><td>unsigned integer (64 bit)</td></tr><tr><td>policy</td><td>set policy</td><td>string: performance [default], memory</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maps">Maps<a href="#maps" class="hash-link" aria-label="Maps的直接链接" title="Maps的直接链接">​</a></h2>
<p><code>{add} map [family] {table} {map}{ {type} [flags] [elements] [size] [policy]}</code></p>
<p><code>{delete | list | flush} map [family] {table} {map}</code></p>
<p><code>{add | delete} element [family] {table} {map}{ {elements}}</code></p>
<p>Maps store data based on some specific key used as input, they are uniquely identified by an user-defined name and attached to tables.</p>
<p><code>add</code></p>
<dd><p>Add a new map in the specified table.</p></dd>
<p><code>delete</code></p>
<dd><p>Delete the specified map.</p></dd>
<p><code>list</code></p>
<dd><p>Display the elements in the specified map.</p></dd>
<p><code>flush</code></p>
<dd><p>Remove all elements from the specified map.</p></dd>
<p><code>add element</code></p>
<dd><p>Comma-separated list of elements to add into the specified map.</p></dd>
<p><code>delete element</code></p>
<dd><p>Comma-separated list of element keys to delete from the specified map.</p></dd>
<p><em><strong>Table 5. Map specifications</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>data type of map elements</td><td>string &#x27;:&#x27; string: ipv4_addr, ipv6_addr, ether_addr, inet_proto, inet_service, mark, counter, quota. Counter and quota can&#x27;t be used as keys</td></tr><tr><td>flags</td><td>map flags</td><td>string: constant, interval</td></tr><tr><td>elements</td><td>elements contained by the map</td><td>map data type</td></tr><tr><td>size</td><td>maximun number of elements in the map</td><td>unsigned integer (64 bit)</td></tr><tr><td>policy</td><td>map policy</td><td>string: performance [default], memory</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="stateful-objects">Stateful objects<a href="#stateful-objects" class="hash-link" aria-label="Stateful objects的直接链接" title="Stateful objects的直接链接">​</a></h2>
<p><code>{add | delete | list | reset} type [family] {table} {object}</code></p>
<p>Stateful objects are attached to tables and are identified by an unique name. They group stateful information from rules, to reference them in rules the keywords &quot;type name&quot; are used e.g. &quot;counter name&quot;.</p>
<p><code>add</code></p>
<dd><p>Add a new stateful object in the specified table.</p></dd>
<p><code>delete</code></p>
<dd><p>Delete the specified object.</p></dd>
<p><code>list</code></p>
<dd><p>Display stateful information the object holds.</p></dd>
<p><code>reset</code></p>
<dd><p>List-and-reset stateful object.</p></dd>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ct">Ct<a href="#ct" class="hash-link" aria-label="Ct的直接链接" title="Ct的直接链接">​</a></h3>
<p><em><strong>ct</strong></em> <code>{helper} {type} {type} {protocol} {protocol} [l3proto] [family]</code></p>
<p>Ct helper is used to define connection tracking helpers that can then be used in combination with the &quot;ct helper set&quot; statement. type and protocol are mandatory, l3proto is derived from the table family by default, i.e. in the inet table the kernel will try to load both the ipv4 and ipv6 helper backends, if they are supported by the kernel.</p>
<p><em><strong>Table 6. conntrack helper specifications</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>name of helper type</td><td>quoted string (e.g. &quot;ftp&quot;)</td></tr><tr><td>protocol</td><td>layer 4 protocol of the helper</td><td>string (e.g. tcp)</td></tr><tr><td>l3proto</td><td>layer 3 protocol of the helper</td><td>address family (e.g. ip)</td></tr></tbody></table>
<p><em><strong>示例 2. defining and assigning ftp helper</strong></em></p>
<p>Unlike iptables, helper assignment needs to be performed after the conntrack lookup has completed, for example with the default 0 hook priority.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table inet myhelpers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ct helper ftp-standard {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     type &quot;ftp&quot; protocol tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chain prerouting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type filter hook prerouting priority 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tcp dport 21 ct helper set &quot;ftp-standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="counter">Counter<a href="#counter" class="hash-link" aria-label="Counter的直接链接" title="Counter的直接链接">​</a></h3>
<p><em><strong>counter</strong></em> [packets bytes]</p>
<p><em><strong>Table 7. Counter specifications</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>packets</td><td>initial count of packets</td><td>unsigned integer (64 bit)</td></tr><tr><td>bytes</td><td>initial count of bytes</td><td>unsigned integer (64 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="quota">Quota<a href="#quota" class="hash-link" aria-label="Quota的直接链接" title="Quota的直接链接">​</a></h3>
<p><em><strong>quota</strong></em> [over | until] [used]</p>
<p><em><strong>Table 8. Quota specifications</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>quota</td><td>quota limit, used as the quota name</td><td>Two arguments, unsigned interger (64 bit) and string: bytes, kbytes, mbytes. &quot;over&quot; and &quot;until&quot; go before these arguments</td></tr><tr><td>used</td><td>initial value of used quota</td><td>Two arguments, unsigned interger (64 bit) and string: bytes, kbytes, mbytes</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="expressions">Expressions<a href="#expressions" class="hash-link" aria-label="Expressions的直接链接" title="Expressions的直接链接">​</a></h2>
<p>Expressions represent values, either constants like network addresses, port numbers etc. or data gathered from the packet during ruleset evaluation. Expressions can be combined using binary, logical, relational and other types of expressions to form complex or relational (match) expressions. They are also used as arguments to certain types of operations, like NAT, packet marking etc.</p>
<p>Each expression has a data type, which determines the size, parsing and representation of symbolic values and type compatibility with other expressions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="describe-command">describe command<a href="#describe-command" class="hash-link" aria-label="describe command的直接链接" title="describe command的直接链接">​</a></h3>
<p><code>describe {expression}</code></p>
<p>The <em><strong>describe</strong></em> command shows information about the type of an expression and its data type.</p>
<p><em><strong>示例 3. The <code>describe</code> command</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ nft describe tcp flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload expression, datatype tcp_flag (TCP flag) (basetype bitmask, integer), 8 bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre-defined symbolic constants:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fin                               0x01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syn                               0x02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rst                               0x04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psh                               0x08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ack                               0x10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">urg                               0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ecn                               0x40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cwr                               0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-types">Data types<a href="#data-types" class="hash-link" aria-label="Data types的直接链接" title="Data types的直接链接">​</a></h2>
<p>Data types determine the size, parsing and representation of symbolic values and type compatibility of expressions. A number of global data types exist, in addition some expression types define further data types specific to the expression type. Most data types have a fixed size, some however may have a dynamic size, f.i. the string type.</p>
<p>Types may be derived from lower order types, f.i. the IPv4 address type is derived from the integer type, meaning an IPv4 address can also be specified as an integer value.</p>
<p>In certain contexts (set and map definitions) it is necessary to explicitly specify a data type. Each type has a name which is used for this.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integer-type">Integer type<a href="#integer-type" class="hash-link" aria-label="Integer type的直接链接" title="Integer type的直接链接">​</a></h3>
<p><em><strong>Table 9.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Integer</td><td>integer</td><td>variable</td><td>-</td></tr></tbody></table>
<p>The integer type is used for numeric values. It may be specified as decimal, hexadecimal or octal number. The integer type doesn&#x27;t have a fixed size, its size is determined by the expression for which it is used.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bitmask-type">Bitmask type<a href="#bitmask-type" class="hash-link" aria-label="Bitmask type的直接链接" title="Bitmask type的直接链接">​</a></h3>
<p><em><strong>Table 10.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Bitmask</td><td>bitmask</td><td>variable</td><td>integer</td></tr></tbody></table>
<p>The bitmask type (<em><strong>bitmask</strong></em>) is used for bitmasks.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="string-type">String type<a href="#string-type" class="hash-link" aria-label="String type的直接链接" title="String type的直接链接">​</a></h3>
<p><em><strong>Table 11.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>String</td><td>string</td><td>variable</td><td>-</td></tr></tbody></table>
<p>The string type is used to for character strings. A string begins with an alphabetic character (a-zA-Z) followed by zero or more alphanumeric characters or the characters /, -, _ and .. In addition anything enclosed in double quotes (&quot;) is recognized as a string.</p>
<p><em><strong>示例 4. String specification</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Interface name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iifname eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Weird interface name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iifname &quot;(eth0)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="link-layer-address-type">Link layer address type<a href="#link-layer-address-type" class="hash-link" aria-label="Link layer address type的直接链接" title="Link layer address type的直接链接">​</a></h3>
<p><em><strong>Table 12.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Link layer address</td><td>lladdr</td><td>variable</td><td>integer</td></tr></tbody></table>
<p>The link layer address type is used for link layer addresses. Link layer addresses are specified as a variable amount of groups of two hexadecimal digits separated using colons (:).</p>
<p><em><strong>示例 5. Link layer address specification</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Ethernet destination MAC address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input ether daddr 20:c9:d0:43:12:d9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4-address-type">IPv4 address type<a href="#ipv4-address-type" class="hash-link" aria-label="IPv4 address type的直接链接" title="IPv4 address type的直接链接">​</a></h3>
<p><em><strong>Table 13.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>IPv4 address</td><td>ipv4_addr</td><td>32 bit</td><td>integer</td></tr></tbody></table>
<p>The IPv4 address type is used for IPv4 addresses. Addresses are specified in either dotted decimal, dotted hexadecimal, dotted octal, decimal, hexadecimal, octal notation or as a host name. A host name will be resolved using the standard system resolver.</p>
<p><em><strong>示例 6. IPv4 address specification</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># dotted decimal notation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output ip daddr 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># host name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output ip daddr localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv6-address-type">IPv6 address type<a href="#ipv6-address-type" class="hash-link" aria-label="IPv6 address type的直接链接" title="IPv6 address type的直接链接">​</a></h3>
<p><em><strong>Table 14.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>IPv6 address</td><td>ipv6_addr</td><td>128 bit</td><td>integer</td></tr></tbody></table>
<p>The IPv6 address type is used for IPv6 addresses. FIXME</p>
<p><em><strong>示例 7. IPv6 address specification</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># abbreviated loopback address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output ip6 daddr ::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="boolean-type">Boolean type<a href="#boolean-type" class="hash-link" aria-label="Boolean type的直接链接" title="Boolean type的直接链接">​</a></h3>
<p><em><strong>Table 15.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>Boolean</td><td>boolean</td><td>1 bit</td><td>integer</td></tr></tbody></table>
<p>The boolean type is a syntactical helper type in user space. It&#x27;s use is in the right-hand side of a (typically implicit) relational expression to change the expression on the left-hand side into a boolean check (usually for existence).</p>
<p>The following keywords will automatically resolve into a boolean type with given value:</p>
<p><em><strong>Table 16.</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Value</th></tr></thead><tbody><tr><td>exists</td><td>1</td></tr><tr><td>missing</td><td>0</td></tr></tbody></table>
<p><em><strong>示例 8. Boolean specification</strong></em></p>
<p>The following expressions support a boolean comparison:</p>
<p><em><strong>Table 17.</strong></em></p>
<table><thead><tr><th>Expression</th><th>Behaviour</th></tr></thead><tbody><tr><td>fib</td><td>Check route existence.</td></tr><tr><td>exthdr</td><td>Check IPv6 extension header existence.</td></tr><tr><td>tcp option</td><td>Check TCP option header existence.</td></tr></tbody></table>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># match if route exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input fib daddr . iif oif exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match only non-fragmented packets in IPv6 traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input exthdr frag missing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match if TCP timestamp option is present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input tcp option timestamp exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmp-type-type">ICMP Type type<a href="#icmp-type-type" class="hash-link" aria-label="ICMP Type type的直接链接" title="ICMP Type type的直接链接">​</a></h3>
<p><em><strong>Table 18.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>ICMP Type</td><td>icmp_type</td><td>8 bit</td><td>integer</td></tr></tbody></table>
<p>The ICMP Type type is used to conveniently specify the ICMP header&#x27;s type field.</p>
<p>The following keywords may be used when specifying the ICMP type:</p>
<p><em><strong>Table 19.</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Value</th></tr></thead><tbody><tr><td>echo-reply</td><td>0</td></tr><tr><td>destination-unreachable</td><td>3</td></tr><tr><td>source-quench</td><td>4</td></tr><tr><td>redirect</td><td>5</td></tr><tr><td>echo-request</td><td>8</td></tr><tr><td>router-advertisement</td><td>9</td></tr><tr><td>router-solicitation</td><td>10</td></tr><tr><td>time-exceeded</td><td>11</td></tr><tr><td>parameter-problem</td><td>12</td></tr><tr><td>timestamp-request</td><td>13</td></tr><tr><td>timestamp-reply</td><td>14</td></tr><tr><td>info-request</td><td>15</td></tr><tr><td>info-reply</td><td>16</td></tr><tr><td>address-mask-request</td><td>17</td></tr><tr><td>address-mask-reply</td><td>18</td></tr></tbody></table>
<p><em><strong>示例 9. ICMP Type specification</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match ping packets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output icmp type { echo-request, echo-reply }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmpv6-type-type">ICMPv6 Type type<a href="#icmpv6-type-type" class="hash-link" aria-label="ICMPv6 Type type的直接链接" title="ICMPv6 Type type的直接链接">​</a></h3>
<p><em><strong>Table 20.</strong></em></p>
<table><thead><tr><th>Name</th><th>Keyword</th><th>Size</th><th>Base type</th></tr></thead><tbody><tr><td>ICMPv6 Type</td><td>icmpv6_type</td><td>8 bit</td><td>integer</td></tr></tbody></table>
<p>The ICMPv6 Type type is used to conveniently specify the ICMPv6 header&#x27;s type field.</p>
<p>The following keywords may be used when specifying the ICMPv6 type:</p>
<p><em><strong>Table 21.</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Value</th></tr></thead><tbody><tr><td>destination-unreachable</td><td>1</td></tr><tr><td>packet-too-big</td><td>2</td></tr><tr><td>time-exceeded</td><td>3</td></tr><tr><td>parameter-problem</td><td>4</td></tr><tr><td>echo-request</td><td>128</td></tr><tr><td>echo-reply</td><td>129</td></tr><tr><td>mld-listener-query</td><td>130</td></tr><tr><td>mld-listener-report</td><td>131</td></tr><tr><td>mld-listener-done</td><td>132</td></tr><tr><td>mld-listener-reduction</td><td>132</td></tr><tr><td>nd-router-solicit</td><td>133</td></tr><tr><td>nd-router-advert</td><td>134</td></tr><tr><td>nd-neighbor-solicit</td><td>135</td></tr><tr><td>nd-neighbor-advert</td><td>136</td></tr><tr><td>nd-redirect</td><td>137</td></tr><tr><td>router-renumbering</td><td>138</td></tr><tr><td>ind-neighbor-solicit</td><td>141</td></tr><tr><td>ind-neighbor-advert</td><td>142</td></tr><tr><td>mld2-listener-report</td><td>143</td></tr></tbody></table>
<p><em><strong>示例 10. ICMPv6 Type specification</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># match ICMPv6 ping packets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output icmpv6 type { echo-request, echo-reply }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="primary-expressions">Primary expressions<a href="#primary-expressions" class="hash-link" aria-label="Primary expressions的直接链接" title="Primary expressions的直接链接">​</a></h2>
<p>The lowest order expression is a primary expression, representing either a constant or a single datum from a packet&#x27;s payload, meta data or a stateful module.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="meta-expressions">Meta expressions<a href="#meta-expressions" class="hash-link" aria-label="Meta expressions的直接链接" title="Meta expressions的直接链接">​</a></h3>
<p><code>meta {length | nfproto | l4proto | protocol | priority}</code></p>
<p><code>[meta] {mark | iif | iifname | iiftype | oif | oifname | oiftype}</code>
<code>[meta] {skuid | skgid | nftrace | rtclassid | ibriport | obriport | pkttype | cpu | iifgroup | oifgroup | cgroup | random}</code></p>
<p>A meta expression refers to meta data associated with a packet.</p>
<p>There are two types of meta expressions: unqualified and qualified meta expressions. Qualified meta expressions require the <em><strong>meta</strong></em> keyword before the meta key, unqualified meta expressions can be specified by using the meta key directly or as qualified meta expressions.</p>
<p><em><strong>Table 22. Meta expression types</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>length</td><td>Length of the packet in bytes</td><td>integer (32 bit)</td></tr><tr><td>protocol</td><td>Ethertype protocol value</td><td>ether_type</td></tr><tr><td>priority</td><td>TC packet priority</td><td>tc_handle</td></tr><tr><td>mark</td><td>Packet mark</td><td>mark</td></tr><tr><td>iif</td><td>Input interface index</td><td>iface_index</td></tr><tr><td>iifname</td><td>Input interface name</td><td>string</td></tr><tr><td>iiftype</td><td>Input interface type</td><td>iface_type</td></tr><tr><td>oif</td><td>Output interface index</td><td>iface_index</td></tr><tr><td>oifname</td><td>Output interface name</td><td>string</td></tr><tr><td>oiftype</td><td>Output interface hardware type</td><td>iface_type</td></tr><tr><td>skuid</td><td>UID associated with originating socket</td><td>uid</td></tr><tr><td>skgid</td><td>GID associated with originating socket</td><td>gid</td></tr><tr><td>rtclassid</td><td>Routing realm</td><td>realm</td></tr><tr><td>ibriport</td><td>Input bridge interface name</td><td>string</td></tr><tr><td>obriport</td><td>Output bridge interface name</td><td>string</td></tr><tr><td>pkttype</td><td>packet type</td><td>pkt_type</td></tr><tr><td>cpu</td><td>cpu number processing the packet</td><td>integer (32 bits)</td></tr><tr><td>iifgroup</td><td>incoming device group</td><td>devgroup</td></tr><tr><td>oifgroup</td><td>outgoing device group</td><td>devgroup</td></tr><tr><td>cgroup</td><td>control group id</td><td>integer (32 bits)</td></tr><tr><td>random</td><td>pseudo-random number</td><td>integer (32 bits)</td></tr></tbody></table>
<p><em><strong>Table 23. Meta expression specific types</strong></em></p>
<table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>iface_index</td><td>Interface index (32 bit number). Can be specified numerically or as name of an existing interface.</td></tr><tr><td>ifname</td><td>Interface name (16 byte string). Does not have to exist.</td></tr><tr><td>iface_type</td><td>Interface type (16 bit number).</td></tr><tr><td>uid</td><td>User ID (32 bit number). Can be specified numerically or as user name.</td></tr><tr><td>gid</td><td>Group ID (32 bit number). Can be specified numerically or as group name.</td></tr><tr><td>realm</td><td>Routing Realm (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/rt_realms.</td></tr><tr><td>devgroup_type</td><td>Device group (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/group.</td></tr><tr><td>pkt_type</td><td>Packet type: Unicast (addressed to local host), Broadcast (to all), Multicast (to group).</td></tr></tbody></table>
<p><em><strong>示例 11. Using meta expressions</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qualified meta expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output meta oif eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># unqualified meta expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output oif eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fib-expressions">fib expressions<a href="#fib-expressions" class="hash-link" aria-label="fib expressions的直接链接" title="fib expressions的直接链接">​</a></h3>
<p><em><strong>fib</strong></em> {saddr | daddr [mark | iif | oif]]} {oif | oifname | type}</p>
<p>A fib expression queries the fib (forwarding information base) to obtain information such as the output interface index a particular address would use. The input is a tuple of elements that is used as input to the fib lookup functions.</p>
<p><em><strong>Table 24. fib expression specific types</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>oif</td><td>Output interface index</td><td>integer (32 bit)</td></tr><tr><td>oifname</td><td>Output interface name</td><td>string</td></tr><tr><td>type</td><td>Address type</td><td>fib_addrtype</td></tr></tbody></table>
<p><em><strong>示例 12. Using fib expressions</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># drop packets without a reverse path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter prerouting fib saddr . iif oif missing drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># drop packets to address not configured on ininterface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter prerouting fib daddr . iif type != { local, broadcast, multicast } drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># perform lookup in a specific &#x27;blackhole&#x27; table (0xdead, needs ip appropriate ip rule)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter prerouting meta mark set 0xdead fib daddr . mark type vmap { blackhole : drop, prohibit : jump prohibited, unreachable : drop }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="routing-expressions">Routing expressions<a href="#routing-expressions" class="hash-link" aria-label="Routing expressions的直接链接" title="Routing expressions的直接链接">​</a></h3>
<p><em><strong>rt</strong></em> {classid | nexthop}</p>
<p>A routing expression refers to routing data associated with a packet.</p>
<p><em><strong>Table 25. Routing expression types</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>classid</td><td>Routing realm</td><td>realm</td></tr><tr><td>nexthop</td><td>Routing nexthop</td><td>ipv4_addr/ipv6_addr</td></tr></tbody></table>
<p><em><strong>Table 26. Routing expression specific types</strong></em></p>
<table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>realm</td><td>Routing Realm (32 bit number). Can be specified numerically or as symbolic name defined in /etc/iproute2/rt_realms.</td></tr></tbody></table>
<p><em><strong>示例 13. Using routing expressions</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IP family independent rt expression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output rt classid 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IP family dependent rt expressions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip filter output rt nexthop 192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip6 filter output rt nexthop fd00::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inet filter meta nfproto ipv4 output rt nexthop 192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inet filter meta nfproto ipv6 output rt nexthop fd00::1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="payload-expressions">Payload expressions<a href="#payload-expressions" class="hash-link" aria-label="Payload expressions的直接链接" title="Payload expressions的直接链接">​</a></h2>
<p>Payload expressions refer to data from the packet&#x27;s payload.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ethernet-header-expression">Ethernet header expression<a href="#ethernet-header-expression" class="hash-link" aria-label="Ethernet header expression的直接链接" title="Ethernet header expression的直接链接">​</a></h3>
<p><em><strong>ether</strong></em> [<em>ethernet header field</em>]</p>
<p><em><strong>Table 27. Ethernet header expression types</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>daddr</td><td>Destination MAC address</td><td>ether_addr</td></tr><tr><td>saddr</td><td>Source MAC address</td><td>ether_addr</td></tr><tr><td>type</td><td>EtherType</td><td>ether_type</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vlan-header-expression">VLAN header expression<a href="#vlan-header-expression" class="hash-link" aria-label="VLAN header expression的直接链接" title="VLAN header expression的直接链接">​</a></h3>
<p><em><strong>vlan</strong></em> [<em>VLAN header field</em>]</p>
<p><em><strong>Table 28. VLAN header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>id</td><td>VLAN ID (VID)</td><td>integer (12 bit)</td></tr><tr><td>cfi</td><td>Canonical Format Indicator</td><td>integer (1 bit)</td></tr><tr><td>pcp</td><td>Priority code point</td><td>integer (3 bit)</td></tr><tr><td>type</td><td>EtherType</td><td>ether_type</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arp-header-expression">ARP header expression<a href="#arp-header-expression" class="hash-link" aria-label="ARP header expression的直接链接" title="ARP header expression的直接链接">​</a></h3>
<p><em><strong>arp</strong></em> [<em>ARP header field</em>]</p>
<p><em><strong>Table 29. ARP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>htype</td><td>ARP hardware type</td><td>integer (16 bit)</td></tr><tr><td>ptype</td><td>EtherType</td><td>ether_type</td></tr><tr><td>hlen</td><td>Hardware address len</td><td>integer (8 bit)</td></tr><tr><td>plen</td><td>Protocol address len</td><td>integer (8 bit)</td></tr><tr><td>operation</td><td>Operation</td><td>arp_op</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv4-header-expression">IPv4 header expression<a href="#ipv4-header-expression" class="hash-link" aria-label="IPv4 header expression的直接链接" title="IPv4 header expression的直接链接">​</a></h3>
<p><em><strong>ip</strong></em> [<em>IPv4 header field</em>]</p>
<p><em><strong>Table 30. IPv4 header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>version</td><td>IP header version (4)</td><td>integer (4 bit)</td></tr><tr><td>hdrlength</td><td>IP header length including options</td><td>integer (4 bit) FIXME scaling</td></tr><tr><td>dscp</td><td>Differentiated Services Code Point</td><td>dscp</td></tr><tr><td>ecn</td><td>Explicit Congestion Notification</td><td>ecn</td></tr><tr><td>length</td><td>Total packet length</td><td>integer (16 bit)</td></tr><tr><td>id</td><td>IP ID</td><td>integer (16 bit)</td></tr><tr><td>frag-off</td><td>Fragment offset</td><td>integer (16 bit)</td></tr><tr><td>ttl</td><td>Time to live</td><td>integer (8 bit)</td></tr><tr><td>protocol</td><td>Upper layer protocol</td><td>inet_proto</td></tr><tr><td>checksum</td><td>IP header checksum</td><td>integer (16 bit)</td></tr><tr><td>saddr</td><td>Source address</td><td>ipv4_addr</td></tr><tr><td>daddr</td><td>Destination address</td><td>ipv4_addr</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmp-header-expression">ICMP header expression<a href="#icmp-header-expression" class="hash-link" aria-label="ICMP header expression的直接链接" title="ICMP header expression的直接链接">​</a></h3>
<p><em><strong>icmp</strong></em> [<em>ICMP header field</em>]</p>
<p><em><strong>Table 31. ICMP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>ICMP type field</td><td>icmp_type</td></tr><tr><td>code</td><td>ICMP code field</td><td>integer (8 bit)</td></tr><tr><td>checksum</td><td>ICMP checksum field</td><td>integer (16 bit)</td></tr><tr><td>id</td><td>ID of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>sequence</td><td>sequence number of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>gateway</td><td>gateway of redirects</td><td>integer (32 bit)</td></tr><tr><td>mtu</td><td>MTU of path MTU discovery</td><td>integer (16 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipv6-header-expression">IPv6 header expression<a href="#ipv6-header-expression" class="hash-link" aria-label="IPv6 header expression的直接链接" title="IPv6 header expression的直接链接">​</a></h3>
<p><em><strong>ip6</strong></em> [<em>IPv6 header field</em>]</p>
<p><em><strong>Table 32. IPv6 header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>version</td><td>IP header version (6)</td><td>integer (4 bit)</td></tr><tr><td>dscp</td><td>Differentiated Services Code Point</td><td>dscp</td></tr><tr><td>ecn</td><td>Explicit Congestion Notification</td><td>ecn</td></tr><tr><td>flowlabel</td><td>Flow label</td><td>integer (20 bit)</td></tr><tr><td>length</td><td>Payload length</td><td>integer (16 bit)</td></tr><tr><td>nexthdr</td><td>Nexthdr protocol</td><td>inet_proto</td></tr><tr><td>hoplimit</td><td>Hop limit</td><td>integer (8 bit)</td></tr><tr><td>saddr</td><td>Source address</td><td>ipv6_addr</td></tr><tr><td>daddr</td><td>Destination address</td><td>ipv6_addr</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="icmpv6-header-expression">ICMPv6 header expression<a href="#icmpv6-header-expression" class="hash-link" aria-label="ICMPv6 header expression的直接链接" title="ICMPv6 header expression的直接链接">​</a></h3>
<p><em><strong>icmpv6</strong></em> [<em>ICMPv6 header field</em>]</p>
<p><em><strong>Table 33. ICMPv6 header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>type</td><td>ICMPv6 type field</td><td>icmpv6_type</td></tr><tr><td>code</td><td>ICMPv6 code field</td><td>integer (8 bit)</td></tr><tr><td>checksum</td><td>ICMPv6 checksum field</td><td>integer (16 bit)</td></tr><tr><td>parameter-problem</td><td>pointer to problem</td><td>integer (32 bit)</td></tr><tr><td>packet-too-big</td><td>oversized MTU</td><td>integer (32 bit)</td></tr><tr><td>id</td><td>ID of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>sequence</td><td>sequence number of echo request/response</td><td>integer (16 bit)</td></tr><tr><td>max-delay</td><td>maximum response delay of MLD queries</td><td>integer (16 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcp-header-expression">TCP header expression<a href="#tcp-header-expression" class="hash-link" aria-label="TCP header expression的直接链接" title="TCP header expression的直接链接">​</a></h3>
<p><em><strong>tcp</strong></em> [<em>TCP header field</em>]</p>
<p><em><strong>Table 34. TCP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>sequence</td><td>Sequence number</td><td>integer (32 bit)</td></tr><tr><td>ackseq</td><td>Acknowledgement number</td><td>integer (32 bit)</td></tr><tr><td>doff</td><td>Data offset</td><td>integer (4 bit) FIXME scaling</td></tr><tr><td>reserved</td><td>Reserved area</td><td>integer (4 bit)</td></tr><tr><td>flags</td><td>TCP flags</td><td>tcp_flag</td></tr><tr><td>window</td><td>Window</td><td>integer (16 bit)</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (16 bit)</td></tr><tr><td>urgptr</td><td>Urgent pointer</td><td>integer (16 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="udp-header-expression">UDP header expression<a href="#udp-header-expression" class="hash-link" aria-label="UDP header expression的直接链接" title="UDP header expression的直接链接">​</a></h3>
<p><em><strong>udp</strong></em> [<em>UDP header field</em>]</p>
<p><em><strong>Table 35. UDP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>length</td><td>Total packet length</td><td>integer (16 bit)</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (16 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="udp-lite-header-expression">UDP-Lite header expression<a href="#udp-lite-header-expression" class="hash-link" aria-label="UDP-Lite header expression的直接链接" title="UDP-Lite header expression的直接链接">​</a></h3>
<p><em><strong>udplite</strong></em> [<em>UDP-Lite header field</em>]</p>
<p><em><strong>Table 36. UDP-Lite header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (16 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sctp-header-expression">SCTP header expression<a href="#sctp-header-expression" class="hash-link" aria-label="SCTP header expression的直接链接" title="SCTP header expression的直接链接">​</a></h3>
<p><em><strong>sctp</strong></em> [<em>SCTP header field</em>]</p>
<p><em><strong>Table 37. SCTP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr><tr><td>vtag</td><td>Verfication Tag</td><td>integer (32 bit)</td></tr><tr><td>checksum</td><td>Checksum</td><td>integer (32 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dccp-header-expression">DCCP header expression<a href="#dccp-header-expression" class="hash-link" aria-label="DCCP header expression的直接链接" title="DCCP header expression的直接链接">​</a></h3>
<p><em><strong>dccp</strong></em> [<em>DCCP header field</em>]</p>
<p><em><strong>Table 38. DCCP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>sport</td><td>Source port</td><td>inet_service</td></tr><tr><td>dport</td><td>Destination port</td><td>inet_service</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentication-header-expression">Authentication header expression<a href="#authentication-header-expression" class="hash-link" aria-label="Authentication header expression的直接链接" title="Authentication header expression的直接链接">​</a></h3>
<p><em><strong>ah</strong></em> [<em>AH header field</em>]</p>
<p><em><strong>Table 39. AH header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>nexthdr</td><td>Next header protocol</td><td>inet_proto</td></tr><tr><td>hdrlength</td><td>AH Header length</td><td>integer (8 bit)</td></tr><tr><td>reserved</td><td>Reserved area</td><td>integer (16 bit)</td></tr><tr><td>spi</td><td>Security Parameter Index</td><td>integer (32 bit)</td></tr><tr><td>sequence</td><td>Sequence number</td><td>integer (32 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="encrypted-security-payload-header-expression">Encrypted security payload header expression<a href="#encrypted-security-payload-header-expression" class="hash-link" aria-label="Encrypted security payload header expression的直接链接" title="Encrypted security payload header expression的直接链接">​</a></h3>
<p><em><strong>esp</strong></em> [<em>ESP header field</em>]</p>
<p><em><strong>Table 40. ESP header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>spi</td><td>Security Parameter Index</td><td>integer (32 bit)</td></tr><tr><td>sequence</td><td>Sequence number</td><td>integer (32 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipcomp-header-expression">IPcomp header expression<a href="#ipcomp-header-expression" class="hash-link" aria-label="IPcomp header expression的直接链接" title="IPcomp header expression的直接链接">​</a></h3>
<p><em><strong>comp</strong></em> [<em>IPComp header field</em>]</p>
<p><em><strong>Table 41. IPComp header expression</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>nexthdr</td><td>Next header protocol</td><td>inet_proto</td></tr><tr><td>flags</td><td>Flags</td><td>bitmask</td></tr><tr><td>cpi</td><td>Compression Parameter Index</td><td>integer (16 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="extension-header-expressions">Extension header expressions<a href="#extension-header-expressions" class="hash-link" aria-label="Extension header expressions的直接链接" title="Extension header expressions的直接链接">​</a></h3>
<p>Extension header expressions refer to data from variable-sized protocol headers, such as IPv6 extension headers and TCPs options.</p>
<p>nftables currently supports matching (finding) a given ipv6 extension header or TCP option.</p>
<p><code>hbh {nexthdr | hdrlength}</code></p>
<p><code>frag {nexthdr | frag-off | more-fragments | id}</code></p>
<p><code>rt {nexthdr | hdrlength | type | seg-left}</code></p>
<p><code>dst {nexthdr | hdrlength}</code></p>
<p><code>mh {nexthdr | hdrlength | checksum | type}</code></p>
<p><code>tcp option {eol | noop | maxseg | window | sack-permitted | sack | sack0 | sack1 | sack2 | sack3 | timestamp} [_tcp_option_field_]</code></p>
<p>The following syntaxes are valid only in a relational expression with boolean type on right-hand side for checking header existence only:</p>
<p><code>exthdr {hbh | frag | rt | dst | mh}</code></p>
<p><code>tcp option {eol | noop | maxseg | window | sack-permitted | sack | sack0 | sack1 | sack2 | sack3 | timestamp}</code></p>
<p><em><strong>Table 42. IPv6 extension headers</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th></tr></thead><tbody><tr><td>hbh</td><td>Hop by Hop</td></tr><tr><td>rt</td><td>Routing Header</td></tr><tr><td>frag</td><td>Fragmentation header</td></tr><tr><td>dst</td><td>dst options</td></tr><tr><td>mh</td><td>Mobility Header</td></tr></tbody></table>
<p><em><strong>Table 43. TCP Options</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>TCP option fields</th></tr></thead><tbody><tr><td>eol</td><td>End of option list</td><td>kind</td></tr><tr><td>noop</td><td>1 Byte TCP No-op options</td><td>kind</td></tr><tr><td>maxseg</td><td>TCP Maximum Segment Size</td><td>kind, length, size</td></tr><tr><td>window</td><td>TCP Window Scaling</td><td>kind, length, count</td></tr><tr><td>sack-permitted</td><td>TCP SACK permitted</td><td>kind, length</td></tr><tr><td>sack</td><td>TCP Selective Acknowledgement (alias of block 0)</td><td>kind, length, left, right</td></tr><tr><td>sack0</td><td>TCP Selective Acknowledgement (block 0)</td><td>kind, length, left, right</td></tr><tr><td>sack1</td><td>TCP Selective Acknowledgement (block 1)</td><td>kind, length, left, right</td></tr><tr><td>sack2</td><td>TCP Selective Acknowledgement (block 2)</td><td>kind, length, left, right</td></tr><tr><td>sack3</td><td>TCP Selective Acknowledgement (block 3)</td><td>kind, length, left, right</td></tr><tr><td>timestamp</td><td>TCP Timestamps</td><td>kind, length, tsval, tsecr</td></tr></tbody></table>
<p><em><strong>示例 14. finding TCP options</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">filter input tcp option sack-permitted kind 1 counter</span><br></span></code></pre></div></div>
<p><em><strong>示例 15. matching IPv6 exthdr</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ip6 filter input frag more-fragments 1 counter</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conntrack-expressions">Conntrack expressions<a href="#conntrack-expressions" class="hash-link" aria-label="Conntrack expressions的直接链接" title="Conntrack expressions的直接链接">​</a></h3>
<p>Conntrack expressions refer to meta data of the connection tracking entry associated with a packet.</p>
<p>There are three types of conntrack expressions. Some conntrack expressions require the flow direction before the conntrack key, others must be used directly because they are direction agnostic. The <em><strong>packets</strong></em>, <em><strong>bytes</strong></em> and <em><strong>avgpkt</strong></em> keywords can be used with or without a direction. If the direction is omitted, the sum of the original and the reply direction is returned. The same is true for the <em><strong>zone</strong></em>, if a direction is given, the zone is only matched if the zone id is tied to the given direction.</p>
<p><code>ct {state | direction | status | mark | expiration | helper | label | l3proto | protocol | bytes | packets | avgpkt | zone}</code></p>
<p><code>ct {original | reply} {l3proto | protocol | saddr | daddr | proto-src | proto-dst | bytes | packets | avgpkt | zone}</code></p>
<p><em><strong>Table 44. Conntrack expressions</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>state</td><td>State of the connection</td><td>ct_state</td></tr><tr><td>direction</td><td>Direction of the packet relative to the connection</td><td>ct_dir</td></tr><tr><td>status</td><td>Status of the connection</td><td>ct_status</td></tr><tr><td>mark</td><td>Connection mark</td><td>mark</td></tr><tr><td>expiration</td><td>Connection expiration time</td><td>time</td></tr><tr><td>helper</td><td>Helper associated with the connection</td><td>string</td></tr><tr><td>label</td><td>Connection tracking label bit or symbolic name defined in connlabel.conf in the nftables include path</td><td>ct_label</td></tr><tr><td>l3proto</td><td>Layer 3 protocol of the connection</td><td>nf_proto</td></tr><tr><td>saddr</td><td>Source address of the connection for the given direction</td><td>ipv4_addr/ipv6_addr</td></tr><tr><td>daddr</td><td>Destination address of the connection for the given direction</td><td>ipv4_addr/ipv6_addr</td></tr><tr><td>protocol</td><td>Layer 4 protocol of the connection for the given direction</td><td>inet_proto</td></tr><tr><td>proto-src</td><td>Layer 4 protocol source for the given direction</td><td>integer (16 bit)</td></tr><tr><td>proto-dst</td><td>Layer 4 protocol destination for the given direction</td><td>integer (16 bit)</td></tr><tr><td>packets</td><td>packet count seen in the given direction or sum of original and reply</td><td>integer (64 bit)</td></tr><tr><td>bytes</td><td>bytecount seen, see description for <em><strong>packets</strong></em> keyword</td><td>integer (64 bit)</td></tr><tr><td>avgpkt</td><td>average bytes per packet, see description for <em><strong>packets</strong></em> keyword</td><td>integer (64 bit)</td></tr><tr><td>zone</td><td>conntrack zone</td><td>integer (16 bit)</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="statements">Statements<a href="#statements" class="hash-link" aria-label="Statements的直接链接" title="Statements的直接链接">​</a></h2>
<p>Statements represent actions to be performed. They can alter control flow (return, jump to a different chain, accept or drop the packet) or can perform actions, such as logging, rejecting a packet, etc.</p>
<p>Statements exist in two kinds. Terminal statements unconditionally terminate evaluation of the current rule, non-terminal statements either only conditionally or never terminate evaluation of the current rule, in other words, they are passive from the ruleset evaluation perspective. There can be an arbitrary amount of non-terminal statements in a rule, but only a single terminal statement as the final statement.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verdict-statement">Verdict statement<a href="#verdict-statement" class="hash-link" aria-label="Verdict statement的直接链接" title="Verdict statement的直接链接">​</a></h3>
<p>The verdict statement alters control flow in the ruleset and issues policy decisions for packets.</p>
<p><code>{accept | drop | queue | continue | return}</code></p>
<p><code>{jump | goto} {chain}</code></p>
<p><code>accept</code></p>
<dd><p>Terminate ruleset evaluation and accept the packet.</p></dd>
<p><code>drop</code></p>
<dd><p>Terminate ruleset evaluation and drop the packet.</p></dd>
<p><code>queue</code></p>
<dd><p>Terminate ruleset evaluation and queue the packet to userspace.</p></dd>
<p><code>continue</code></p>
<dd><p>Continue ruleset evaluation with the next rule. FIXME</p></dd>
<p><code>return</code></p>
<dd><p>Return from the current chain and continue evaluation at the next rule in the last chain. If issued in a base chain, it is equivalent to <em><strong>accept</strong></em>.</p></dd>
<p><code>jump chain</code></p>
<dd><p>Continue evaluation at the first rule in chain. The current position in the ruleset is pushed to a call stack and evaluation will continue there when the new chain is entirely evaluated of a <em><strong>return</strong></em> verdict is issued.</p></dd>
<p><code>goto chain</code></p>
<dd><p>Similar to <em><strong>jump</strong></em>, but the current position is not pushed to the call stack, meaning that after the new chain evaluation will continue at the last chain instead of the one containing the goto statement.</p></dd>
<p><em><strong>示例 16. Verdict statements</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># process packets from eth0 and the internal network in from_lan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># chain, drop all packets from eth0 with different source addresses.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iif eth0 ip saddr 192.168.0.0/24 jump from_lan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter input iif eth0 drop</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="payload-statement">Payload statement<a href="#payload-statement" class="hash-link" aria-label="Payload statement的直接链接" title="Payload statement的直接链接">​</a></h3>
<p>The payload statement alters packet content. It can be used for example to set ip DSCP (differv) header field or ipv6 flow labels.</p>
<p><em><strong>示例 17. route some packets instead of bridging</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># redirect tcp:http from 192.160.0.0/16 to local machine for routing instead of bridging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># assumes 00:11:22:33:44:55 is local MAC address.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bridge input meta iif eth0 ip saddr 192.168.0.0/16 tcp dport 80 meta pkttype set unicast ether daddr set 00:11:22:33:44:55</span><br></span></code></pre></div></div>
<p><em><strong>示例 18. Set IPv4 DSCP header field</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ip forward ip dscp set 42</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="log-statement">Log statement<a href="#log-statement" class="hash-link" aria-label="Log statement的直接链接" title="Log statement的直接链接">​</a></h3>
<p><code>log [prefix _quoted_string_] [level _syslog-level_] [flags log-flags]</code></p>
<p><code>log [group _nflog_group_] [prefix _quoted_string_] [queue-threshold value] [snaplen size]</code></p>
<p>The log statement enables logging of matching packets. When this statement is used from a rule, the Linux kernel will print some information on all matching packets, such as header fields, via the kernel log (where it can be read with dmesg(1) or read in the syslog). If the group number is specified, the Linux kernel will pass the packet to nfnetlink_log which will multicast the packet through a netlink socket to the specified multicast group. One or more userspace processes may subscribe to the group to receive the packets, see libnetfilter_queue documentation for details. This is a non-terminating statement, so the rule evaluation continues after the packet is logged.</p>
<p><em><strong>Table 45. log statement options</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>prefix</td><td>Log message prefix</td><td>quoted string</td></tr><tr><td>syslog-level</td><td>Syslog level of logging</td><td>string: emerg, alert, crit, err, warn [default], notice, info, debug</td></tr><tr><td>group</td><td>NFLOG group to send messages to</td><td>unsigned integer (16 bit)</td></tr><tr><td>snaplen</td><td>Length of packet payload to include in netlink message</td><td>unsigned integer (32 bit)</td></tr><tr><td>queue-threshold</td><td>Number of packets to queue inside the kernel before sending them to userspace</td><td>unsigned integer (32 bit)</td></tr></tbody></table>
<p><em><strong>Table 46. log-flags</strong></em></p>
<table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td>tcp sequence</td><td>Log TCP sequence numbers.</td></tr><tr><td>tcp options</td><td>Log options from the TCP packet header.</td></tr><tr><td>ip options</td><td>Log options from the IP/IPv6 packet header.</td></tr><tr><td>skuid</td><td>Log the userid of the process which generated the packet.</td></tr><tr><td>ether</td><td>Decode MAC addresses and protocol.</td></tr><tr><td>all</td><td>Enable all log flags listed above.</td></tr></tbody></table>
<p><em><strong>示例 19. Using log statement</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># log the UID which generated the packet and ip options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip filter output log flags skuid flags ip options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># log the tcp sequence numbers and tcp options from the TCP packet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip filter output log flags tcp sequence,options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># enable all supported log flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip6 filter output log flags all</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reject-statement">Reject statement<a href="#reject-statement" class="hash-link" aria-label="Reject statement的直接链接" title="Reject statement的直接链接">​</a></h3>
<p><code>reject [with] {icmp | icmp6 | icmpx} [type] {icmp_type | icmp6_type | icmpx_type}</code></p>
<p><code>reject [with] {tcp} {reset}</code></p>
<p>A reject statement is used to send back an error packet in response to the matched packet otherwise it is equivalent to drop so it is a terminating statement, ending rule traversal. This statement is only valid in the input, forward and output chains, and user-defined chains which are only called from those chains.</p>
<p><em><strong>Table 47. reject statement type (ip)</strong></em></p>
<table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>icmp_type</td><td>ICMP type response to be sent to the host</td><td>net-unreachable, host-unreachable, prot-unreachable, port-unreachable [default], net-prohibited, host-prohibited, admin-prohibited</td></tr></tbody></table>
<p><em><strong>Table 48. reject statement type (ip6)</strong></em></p>
<table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>icmp6_type</td><td>ICMPv6 type response to be sent to the host</td><td>no-route, admin-prohibited, addr-unreachable, port-unreachable [default], policy-fail, reject-route</td></tr></tbody></table>
<p><em><strong>Table 49. reject statement type (inet)</strong></em></p>
<table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>icmpx_type</td><td>ICMPvXtype abstraction response to be sent to the host, this is a set of types that overlap in IPv4 and IPv6 to be used from the inet family.</td><td>port-unreachable [default], admin-prohibited, no-route, host-unreachable</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="counter-statement">Counter statement<a href="#counter-statement" class="hash-link" aria-label="Counter statement的直接链接" title="Counter statement的直接链接">​</a></h3>
<p>A counter statement sets the hit count of packets along with the number of bytes.</p>
<p><code>counter {packets _number_ } {bytes _number_ }</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conntrack-statement">Conntrack statement<a href="#conntrack-statement" class="hash-link" aria-label="Conntrack statement的直接链接" title="Conntrack statement的直接链接">​</a></h3>
<p>The conntrack statement can be used to set the conntrack mark and conntrack labels.</p>
<p><code>ct {mark | eventmask | label | zone} [set] value</code></p>
<p>The ct statement sets meta data associated with a connection. The zone id has to be assigned before a conntrack lookup takes place, i.e. this has to be done in prerouting and possibly output (if locally generated packets need to be placed in a distinct zone), with a hook priority of -300.</p>
<p><em><strong>Table 50. Conntrack statement types</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Value</th></tr></thead><tbody><tr><td>eventmask</td><td>conntrack event bits</td><td>bitmask, integer (32 bit)</td></tr><tr><td>helper</td><td>name of ct helper object to assign to the connection</td><td>quoted string</td></tr><tr><td>mark</td><td>Connection tracking mark</td><td>mark</td></tr><tr><td>label</td><td>Connection tracking label</td><td>label</td></tr><tr><td>zone</td><td>conntrack zone</td><td>integer (16 bit)</td></tr></tbody></table>
<p><em><strong>示例 20. save packet nfmark in conntrack</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ct mark set meta mark</span><br></span></code></pre></div></div>
<p><em><strong>示例 21. set zone mapped via interface</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">table inet raw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chain prerouting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type filter hook prerouting priority -300;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ct zone set iif map { &quot;eth1&quot; : 1, &quot;veth1&quot; : 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chain output {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type filter hook output priority -300;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ct zone set oif map { &quot;eth1&quot; : 1, &quot;veth1&quot; : 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><em><strong>示例 22. restrict events reported by ctnetlink</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ct eventmask set new or related or destroy</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="meta-statement">Meta statement<a href="#meta-statement" class="hash-link" aria-label="Meta statement的直接链接" title="Meta statement的直接链接">​</a></h3>
<p>A meta statement sets the value of a meta expression. The existing meta fields are: priority, mark, pkttype, nftrace.</p>
<p><code>meta {mark | priority | pkttype | nftrace} [set] value</code></p>
<p>A meta statement sets meta data associated with a packet.</p>
<p><em><strong>Table 51. Meta statement types</strong></em></p>
<table><thead><tr><th>Keyword</th><th>Description</th><th>Value</th></tr></thead><tbody><tr><td>priority</td><td>TC packet priority</td><td>tc_handle</td></tr><tr><td>mark</td><td>Packet mark</td><td>mark</td></tr><tr><td>pkttype</td><td>packet type</td><td>pkt_type</td></tr><tr><td>nftrace</td><td>ruleset packet tracing on/off. Use <em><strong>monitor trace</strong></em> command to watch traces</td><td>0, 1</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="limit-statement">Limit statement<a href="#limit-statement" class="hash-link" aria-label="Limit statement的直接链接" title="Limit statement的直接链接">​</a></h3>
<p><code>limit [rate] [over]_packet_number_ [/] {second | minute | hour | day} [burst _packet_number_ packets]</code></p>
<p><code>limit [rate] [over]_byte_number_ {bytes | kbytes | mbytes} [/] {second | minute | hour | day | week} [burst _byte_number_ bytes]</code></p>
<p>A limit statement matches at a limited rate using a token bucket filter. A rule using this statement will match until this limit is reached. It can be used in combination with the log statement to give limited logging. The <em><strong>over</strong></em> keyword, that is optional, makes it match over the specified rate.</p>
<p><em><strong>Table 52. limit statement values</strong></em></p>
<table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>packet_number</td><td>Number of packets</td><td>unsigned integer (32 bit)</td></tr><tr><td>byte_number</td><td>Number of bytes</td><td>unsigned integer (32 bit)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nat-statements">NAT statements<a href="#nat-statements" class="hash-link" aria-label="NAT statements的直接链接" title="NAT statements的直接链接">​</a></h3>
<p><code>snat [to _address_ [:port]] [persistent, random, fully-random]</code></p>
<p><code>snat [to _address_ - _address_ [:_port_ - _port_]] [persistent, random, fully-random]</code></p>
<p><code>dnat [to _address_ [:_port_]] [persistent, random, fully-random]</code></p>
<p><code>dnat [to _address_ [:_port_ - _port_]] [persistent, random, fully-random]</code></p>
<p><code>masquerade [to [:_port_]] [persistent, random, fully-random]</code></p>
<p><code>masquerade [to [:_port_ - _port_]] [persistent, random, fully-random]</code></p>
<p><code>redirect [to [:_port_]] [persistent, random, fully-random]</code></p>
<p><code>redirect [to [:_port_ - _port_]] [persistent, random, fully-random]</code></p>
<p>The nat statements are only valid from nat chain types.</p>
<p>The <em><strong>snat</strong></em> and <em><strong>masquerade</strong></em> statements specify that the source address of the packet should be modified. While <em><strong>snat</strong></em> is only valid in the postrouting and input chains, <em><strong>masquerade</strong></em> makes sense only in postrouting. The <em><strong>dnat</strong></em> and <em><strong>redirect</strong></em> statements are only valid in the prerouting and output chains, they specify that the destination address of the packet should be modified. You can use non-base chains which are called from base chains of nat chain type too. All future packets in this connection will also be mangled, and rules should cease being examined.</p>
<p>The <em><strong>masquerade</strong></em> statement is a special form of <em><strong>snat</strong></em> which always uses the outgoing interface&#x27;s IP address to translate to. It is particularly useful on gateways with dynamic (public) IP addresses.</p>
<p>The <em><strong>redirect</strong></em> statement is a special form of <em><strong>dnat</strong></em> which always translates the destination address to the local host&#x27;s one. It comes in handy if one only wants to alter the destination port of incoming traffic on different interfaces.</p>
<p>Note that all nat statements require both prerouting and postrouting base chains to be present since otherwise packets on the return path won&#x27;t be seen by netfilter and therefore no reverse translation will take place.</p>
<p><em><strong>Table 53. NAT statement values</strong></em></p>
<table><thead><tr><th>Expression</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>address</td><td>Specifies that the source/destination address of the packet should be modified. You may specify a mapping to relate a list of tuples composed of arbitrary expression key with address value.</td><td>ipv4_addr, ipv6_addr, eg. abcd::1234, or you can use a mapping, eg. meta mark map { 10 : 192.168.1.2, 20 : 192.168.1.3 }</td></tr><tr><td>port</td><td>Specifies that the source/destination address of the packet should be modified.</td><td>port number (16 bits)</td></tr></tbody></table>
<p><em><strong>Table 54. NAT statement flags</strong></em></p>
<table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td>persistent</td><td>Gives a client the same source-/destination-address for each connection.</td></tr><tr><td>random</td><td>If used then port mapping will be randomized using a random seeded MD5 hash mix using source and destination address and destination port.</td></tr><tr><td>fully-random</td><td>If used then port mapping is generated based on a 32-bit pseudo-random algorithm.</td></tr></tbody></table>
<p><em><strong>示例 23. Using NAT statements</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create a suitable table/chain setup for all further examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add table nat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add chain nat prerouting { type nat hook prerouting priority 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add chain nat postrouting { type nat hook postrouting priority 100; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># translate source addresses of all packets leaving via eth0 to address 1.2.3.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat postrouting oif eth0 snat to 1.2.3.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># redirect all traffic entering via eth0 to destination address 192.168.1.120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat prerouting iif eth0 dnat to 192.168.1.120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># translate source addresses of all packets leaving via eth0 to whatever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># locally generated packets would use as source to reach the same destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat postrouting oif eth0 masquerade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># redirect incoming TCP traffic for port 22 to port 2222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add rule nat prerouting tcp dport 22 redirect to :2222</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="queue-statement">Queue statement<a href="#queue-statement" class="hash-link" aria-label="Queue statement的直接链接" title="Queue statement的直接链接">​</a></h3>
<p>This statement passes the packet to userspace using the nfnetlink_queue handler. The packet is put into the queue identified by its 16-bit queue number. Userspace can inspect and modify the packet if desired. Userspace must then drop or reinject the packet into the kernel. See libnetfilter_queue documentation for details.</p>
<p><code>queue [num _queue_number_] [bypass]</code></p>
<p><code>queue [num _queue_number_from_ - _queue_number_to_] [bypass,fanout]</code></p>
<p><em><strong>Table 55. queue statement values</strong></em></p>
<table><thead><tr><th>Value</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>queue_number</td><td>Sets queue number, default is 0.</td><td>unsigned integer (16 bit)</td></tr><tr><td>queue_number_from</td><td>Sets initial queue in the range, if fanout is used.</td><td>unsigned integer (16 bit)</td></tr><tr><td>queue_number_to</td><td>Sets closing queue in the range, if fanout is used.</td><td>unsigned integer (16 bit)</td></tr></tbody></table>
<p><em><strong>Table 56. queue statement flags</strong></em></p>
<table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td>bypass</td><td>Let packets go through if userspace application cannot back off. Before using this flag, read libnetfilter_queue documentation for performance tuning recomendations.</td></tr><tr><td>fanout</td><td>Distribute packets between several queues.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-commands">Additional commands<a href="#additional-commands" class="hash-link" aria-label="Additional commands的直接链接" title="Additional commands的直接链接">​</a></h2>
<p>These are some additional commands included in nft.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="export">export<a href="#export" class="hash-link" aria-label="export的直接链接" title="export的直接链接">​</a></h3>
<p>Export your current ruleset in XML or JSON format to stdout.</p>
<p>Examples:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% nft export json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitor">monitor<a href="#monitor" class="hash-link" aria-label="monitor的直接链接" title="monitor的直接链接">​</a></h3>
<p>The monitor command allows you to listen to Netlink events produced by the nf_tables subsystem, related to creation and deletion of objects. When they ocurr, nft will print to stdout the monitored events in either XML, JSON or native nft format.</p>
<p>To filter events related to a concrete object, use one of the keywords &#x27;tables&#x27;, &#x27;chains&#x27;, &#x27;sets&#x27;, &#x27;rules&#x27;, &#x27;elements&#x27;.</p>
<p>To filter events related to a concrete action, use keyword &#x27;new&#x27; or &#x27;destroy&#x27;.</p>
<p>Hit ^C to finish the monitor operation.</p>
<p><em><strong>示例 24. Listen to all events, report in native nft format</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor</span><br></span></code></pre></div></div>
<p><em><strong>示例 25. Listen to added tables, report in XML format</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor new tables xml</span><br></span></code></pre></div></div>
<p><em><strong>示例 26. Listen to deleted rules, report in JSON format</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor destroy rules json</span><br></span></code></pre></div></div>
<p><em><strong>示例 27. Listen to both new and destroyed chains, in native nft format</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">% nft monitor chains</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="error-reporting">Error reporting<a href="#error-reporting" class="hash-link" aria-label="Error reporting的直接链接" title="Error reporting的直接链接">​</a></h2>
<p>When an error is detected, nft shows the line(s) containing the error, the position of the erroneous parts in the input stream and marks up the erroneous parts using carrets (^). If the error results from the combination of two expressions or statements, the part imposing the constraints which are violated is marked using tildes (~).</p>
<p>For errors returned by the kernel, nft can&#x27;t detect which parts of the input caused the error and the entire command is marked.</p>
<p><em><strong>示  例 28. Error caused by single incorrect expression</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cmdline&gt;:1:19-22: Error: Interface does not exist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output oif eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ^^^^</span><br></span></code></pre></div></div>
<p><em><strong>示例 29. Error caused by invalid combination of two expressions</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cmdline&gt;:1:28-36: Error: Right hand side of relational expression (==) must be constant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output tcp dport == tcp dport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ~~ ^^^^^^^^^</span><br></span></code></pre></div></div>
<p><em><strong>示例 30. Error returned by the kernel</strong></em></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cmdline&gt;:0:0-23: Error: Could not process rule: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter output oif wlan0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^^^^^^^^^^^^^^^^^^^^^^^</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="退出状态码">退出状态码<a href="#退出状态码" class="hash-link" aria-label="退出状态码的直接链接" title="退出状态码的直接链接">​</a></h2>
<p>On success, nft exits with a status of 0. Unspecified errors cause it to exit with a status of 1, memory allocation errors with a status of 2, unable to open Netlink socket with 3.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="see-also">See Also<a href="#see-also" class="hash-link" aria-label="See Also的直接链接" title="See Also的直接链接">​</a></h2>
<p>iptables(8), ip6tables(8), arptables(8), ebtables(8), ip(8), tc(8)</p>
<p>There is an official wiki at: <a href="http://wiki.nftables.org" target="_blank" rel="noopener noreferrer">wiki.nftables.org</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors">Authors<a href="#authors" class="hash-link" aria-label="Authors的直接链接" title="Authors的直接链接">​</a></h2>
<p>nftables was written by Patrick McHardy and Pablo Neira Ayuso, among many other contributors from the Netfilter community.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="copyright">Copyright<a href="#copyright" class="hash-link" aria-label="Copyright的直接链接" title="Copyright的直接链接">​</a></h2>
<ul>
<li>Copyright © 2008-2014 Patrick McHardy &lt;<a href="mailto:kaber@trash.net" target="_blank" rel="noopener noreferrer">kaber@trash.net</a>&gt;</li>
<li>Copyright © 2013-2016 Pablo Neira Ayuso &lt;<a href="mailto:pablo@netfilter.org" target="_blank" rel="noopener noreferrer">pablo@netfilter.org</a>&gt;</li>
</ul>
<p>nftables is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License version 2 as published by the Free Software Foundation.</p>
<p><em><strong>This documentation is licenced under the terms of the Creative Commons Attribution-ShareAlike 4.0 license, <a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">CC BY-SA 4.0</a>.</strong></em></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/nft">nft</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/nftables">nftables</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2017/05/31/first-post">开篇</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2017-05-31T00:00:00.000Z">2017年5月31日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown"><p>重新开始写博客，这篇作为开篇，继忙碌地工作了快两年之后，发现抽时间将一些想法和经验沉淀下来也是如此重要。而整理文章的过程本身也是对思绪的整理，可以帮助我们更好的理解所做的事情。
接下来会把旧博客的备份文章重新放上来。</p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/blog/page/2"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/blog/page/4"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 老司机.</div></div></div></footer></div>
</body>
</html>